AC_INIT(bin/build-ooo)

AC_PREREQ(2.12)

AC_WITH(tag,
[
	--with-tag:	define the tag to use, defaults to the latest
			release; eg. --with-tag=OOO_1_0_3
],,)

AC_WITH(srcdir,
[
	--with-srcdir:	define the directory containing the rest of the
			source code we need to build.
],,)

AM_INIT_AUTOMAKE(ooo-build, 1.1.30)

AM_MAINTAINER_MODE

AC_PATH_PROG(PKG_CONFIG, pkg-config)
if test "!" -x "$PKG_CONFIG" ; then
   AC_MSG_ERROR([
*** You need the latest pkg-config.
*** Get the latest version of pkg-config from
*** <http://www.freedesktop.org/software/pkgconfig/>.])
fi
AC_SUBST(PKG_CONFIG)

PKG_CHECK_MODULES( FOO, 
		   gtk+-2.0 libxml-2.0 gnome-vfs-2.0 \
		   libgnomecups-1.0 >= 0.1.0 fontconfig >= 1.0.1 )

AC_MSG_CHECKING( for tag )
if test "z$with_tag" = "z"; then
   with_tag=`bin/latest-patchset patches 2>/dev/null`;	
   if test "z$with_tag" = "z"; then
      AC_MSG_ERROR( Can't locate latest patchset )
   fi
fi

if test -f patches/$with_tag/apply; then
   AC_MSG_RESULT( found $with_tag )
else
   AC_MSG_ERROR( Can't locate patch set for: $with_tag )
fi
TAG=$with_tag
AC_SUBST(TAG)

AC_MSG_CHECKING( for tag's source )
if test "z$with_src" = "z"; then
   ext_srcdir='src'
elif test "${with_src:0:1}" != "/"; then
   AC_MSG_ERROR( --with-src= must be an absolute path );
else
   ext_srcdir=$with_src;
fi

if test -f "$ext_srcdir/$TAG.tar.bz2"; then
   AC_MSG_RESULT( found '$ext_srcdir' )
else
   AC_MSG_ERROR([

     Missing source $ext_srcdir/$TAG.tar.bz2,
     please use the 'download' script to ensure
     the required source is up to date and in-place.

	download [[optional-tag]]

])
fi
WITH_SRC=$with_src
AC_SUBST(WITH_SRC)

if test ${TAG:0:3} != 'OOO'; then
   PKG_CHECK_MODULES( FOO, mozilla-xpcom mozilla-nspr \
		      libstartup-notification-1.0 \
		      libart-2.0 >= 2.3.13 )
fi

dnl
dnl Setup the misc. tweaks we need.
dnl
BASEDIR=`pwd`
TOOLSDIR=$BASEDIR
IN_PKG=yes
AC_SUBST(IN_PKG)
AC_SUBST(BASEDIR)
AC_SUBST(TOOLSDIR)
AC_SUBST(DESTDIR)


AC_OUTPUT([
Makefile
bin/setup
bin/Makefile
desktop/Makefile
etc/Makefile
patches/Makefile
patches/OOO_1_0_3/Makefile
patches/RC3/Makefile
patches/RC3_030721/Makefile
www/Makefile
www/tinder-scripts/Makefile
])
