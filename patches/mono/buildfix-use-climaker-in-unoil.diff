From 9cb294e7f56cce1fdababf5508e73a51f2d3918f Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:59:41 +0200
Subject: [PATCH 385/878] buildfix-use-climaker-in-unoil.diff

---
 cli_ure/prj/d.lst                   |    1 +
 cli_ure/source/climaker/makefile.mk |    2 +-
 unoil/climaker/makefile.mk          |   39 ++++++++++++++++++++++++++++++----
 3 files changed, 36 insertions(+), 6 deletions(-)

diff --git a/cli_ure/prj/d.lst b/cli_ure/prj/d.lst
index f08e25e..53cc64a 100644
--- a/cli_ure/prj/d.lst
+++ b/cli_ure/prj/d.lst
@@ -1,4 +1,5 @@
 ..\%__SRC%\bin\climaker.exe %_DEST%\bin%_EXT%\climaker.exe
+..\%__SRC%\bin\climaker %_DEST%\bin%_EXT%\climaker
 ..\%__SRC%\bin\climaker.pdb %_DEST%\bin%_EXT%\climaker.pdb
 ..\%__SRC%\bin\climaker.exe.config %_DEST%\bin%_EXT%\climaker.exe.config
 
diff --git a/cli_ure/source/climaker/makefile.mk b/cli_ure/source/climaker/makefile.mk
index 6617a9e..75c53ea 100644
--- a/cli_ure/source/climaker/makefile.mk
+++ b/cli_ure/source/climaker/makefile.mk
@@ -58,7 +58,7 @@ ALLTAR : $(BIN)$/climaker
 
 $(BIN)$/climaker : climaker_csharp.cs
     gmcs -debug -unsafe climaker_csharp.cs -reference:$(BIN)/cli_basetypes.dll -out:$(BIN)$/climaker.exe
-    mkbundle2 --static -o $(BIN)$/climaker $(BIN)$/climaker.exe -L $(OUT)/lib
+    mkbundle2 -L $(OUT)/lib --deps -o $(BIN)$/climaker $(BIN)$/climaker.exe $(BIN)/cli_basetypes.dll
 
 .INCLUDE :  target.mk
 .ENDIF # "$(ENABLE_MONO_CLIMAKER)" != "YES"
diff --git a/unoil/climaker/makefile.mk b/unoil/climaker/makefile.mk
index 7d2fab7..cfb85ba 100644
--- a/unoil/climaker/makefile.mk
+++ b/unoil/climaker/makefile.mk
@@ -41,7 +41,7 @@ TARGET = unotypes
 
 POLICY_ASSEMBLY_FILE=$(BIN)/$(CLI_OOOTYPES_POLICY_ASSEMBLY).dll
 
-.IF "$(BUILD_FOR_CLI)" != ""
+.IF "$(BUILD_FOR_CLI)" != "" || "$(ENABLE_MONO)" == "YES"
 
 ALLTAR : \
     $(BIN)$/clioootypesversion.mk \
@@ -55,6 +55,17 @@ ALLTAR : \
 
 .ENDIF
 
+.IF "$(ENABLE_MONO_CLIMAKER)" == "YES"
+
+WRAPCMD=LD_LIBRARY_PATH=$(SOLARLIBDIR)
+CLIMAKER=$(WRAPCMD) $(SOLARBINDIR)$/climaker
+
+.ELSE
+
+CLIMAKER=$(WRAPCMD) $(SOLARBINDIR)$/climaker.exe
+
+.ENDIF
+
     
 CLIMAKERFLAGS =
 .IF "$(debug)" != ""
@@ -64,6 +75,18 @@ CLIMAKERFLAGS += --verbose
 RDB = $(SOLARBINDIR)$/offapi.rdb
 EXTRA_RDB = $(SOLARBINDIR)$/udkapi.rdb
 
+EXTERNAL_DIR=$(PRJ)$/..$/external/cli
+
+.IF "$(ENABLE_MONO)" == "YES" && "$(ENABLE_MONO_CLIMAKER)" != "YES"
+
+$(BIN)$/cli_oootypes.dll : $(EXTERNAL_DIR)$/cli_oootypes.dll $(EXTERNAL_DIR)$/cli_oootypes.config
+    +$(COPY) $? $(BIN)$/
+
+$(POLICY_ASSEMBLY_FILE) : $(EXTERNAL_DIR)$/$(CLI_OOOTYPES_POLICY_ASSEMBLY).dll
+    +$(COPY) $< $@
+
+.ELSE # .IF "$(ENABLE_MONO)" == "YES" && "$(ENABLE_MONO_CLIMAKER)" != "YES"
+
 $(BIN)/cli_oootypes.dll : $(RDB) $(EXTRA_RDB) version.txt
         $(CLIMAKER) $(CLIMAKERFLAGS) \
         --out $@ \
@@ -82,10 +105,16 @@ $(BIN)$/cli_oootypes.config: cli_oootypes_config version.txt
     $< $@
 
 $(POLICY_ASSEMBLY_FILE) : $(BIN)$/cli_oootypes.config $(BIN)$/cli_oootypes.dll
-    $(WRAPCMD) AL.exe -out:$@ \
-            -version:$(CLI_OOOTYPES_POLICY_VERSION) \
-            -keyfile:$(SOLARBINDIR)$/cliuno.snk \
-            -link:$(BIN)$/cli_oootypes.config
+    # al in mono seems broken and doesn't allow -link with filenames containing path
+    $(GNUCOPY) $(BIN)$/cli_oootypes.config .
+    $(WRAPCMD) $(AL) -out:$@ \
+             -version:$(CLI_OOOTYPES_POLICY_VERSION) \
+             -keyfile:$(SOLARBINDIR)$/cliuno.snk \
+             -link:cli_oootypes.config
+    $(RM) cli_oootypes.config
+
+.ENDIF # .IF "$(ENABLE_MONO)" == "YES" && "$(ENABLE_MONO_CLIMAKER)" != "YES"
+
 
 #always deliver a clioootypesversion.mk. It is needed for the packing process even for all other
 #platforms. Therefore BUILD_FOR_CLI is not used here 
-- 
1.7.0.1

