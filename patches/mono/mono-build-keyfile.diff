From 45415efb9a3d34ca2c03d314a9efa8ee9ae037ac Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:59:32 +0200
Subject: [PATCH 377/878] mono-build-keyfile.diff

---
 cli_ure/prj/d.lst                    |    4 +++-
 cli_ure/source/basetypes/makefile.mk |    6 +++---
 cli_ure/source/bootstrap/makefile.mk |    2 +-
 cli_ure/source/ure/makefile.mk       |    4 ++--
 4 files changed, 9 insertions(+), 7 deletions(-)

diff --git a/cli_ure/prj/d.lst b/cli_ure/prj/d.lst
index 56eab2d..f08e25e 100644
--- a/cli_ure/prj/d.lst
+++ b/cli_ure/prj/d.lst
@@ -11,4 +11,6 @@
 
 ..\%__SRC%\bin\cliuno.snk %_DEST%\bin%_EXT%\cliuno.snk
 
-..\%__SRC%\bin\cliureversion.mk %_DEST%\bin%_EXT%\cliureversion.mk
\ No newline at end of file
+..\%__SRC%\bin\cliureversion.mk %_DEST%\bin%_EXT%\cliureversion.mk
+
+..\%__SRC%\bin\cliuno.snk %_DEST%\bin%_EXT%\cliuno.snk
diff --git a/cli_ure/source/basetypes/makefile.mk b/cli_ure/source/basetypes/makefile.mk
index 55c9d28..629fc63 100644
--- a/cli_ure/source/basetypes/makefile.mk
+++ b/cli_ure/source/basetypes/makefile.mk
@@ -54,8 +54,8 @@ POLICY_ASSEMBLY_FILE=$(BIN)$/$(CLI_BASETYPES_POLICY_ASSEMBLY).dll
 ALLTAR : \
     $(BIN)$/cli_basetypes.dll \
     $(POLICY_ASSEMBLY_FILE)
-    
-.IF "$(CCNUMVER)" >= "001399999999"
+
+.IF "$(COM)" != "MSC" || "$(CCNUMVER)" >= "001399999999"
 CSCFLAGS+=-keyfile:"$(BIN)$/cliuno.snk"
 .ENDIF
 
@@ -70,7 +70,7 @@ CSFILES = \
     uno$/PolymorphicType.cs \
     $(ASSEMBLY_ATTRIBUTES)
 
-.IF "$(CCNUMVER)" <= "001399999999"
+.IF "$(COM)" == "MSC" && "$(CCNUMVER)" <= "001399999999"
 $(ASSEMBLY_ATTRIBUTES) : assembly.cs makefile.mk $(BIN)$/cliuno.snk $(BIN)$/cliureversion.mk 
     $(GNUCOPY) -p assembly.cs $@
     echo $(ECHOQUOTE) \
diff --git a/cli_ure/source/bootstrap/makefile.mk b/cli_ure/source/bootstrap/makefile.mk
index a00f7a0..9c6eea2 100644
--- a/cli_ure/source/bootstrap/makefile.mk
+++ b/cli_ure/source/bootstrap/makefile.mk
@@ -71,7 +71,6 @@ $(ASSEMBLY_ATTRIBUTES) .PHONY: assembly.cs $(BIN)$/cliuno.snk $(BIN)$/cliurevers
     $(GNUCOPY) -p assembly.cs $@
     +echo $(ECHOQUOTE) \
     [assembly:System.Reflection.AssemblyVersion( "$(CLI_CPPUHELPER_NEW_VERSION)" )] $(ECHOQUOTE) \
-    $(ECHOQUOTE) [assembly:System.Reflection.AssemblyKeyFile($(ASSEMBLY_KEY))] $(ECHOQUOTE) \
     >> $@
 
 EXTERNAL_DIR=$(PRJ)$/..$/external/cli
@@ -83,6 +82,7 @@ $(BIN)$/cli_cppuhelper.dll : $(CSFILES) $(OUT)$/bin$/cli_uretypes.dll
     +$(CSC) $(CSCFLAGS) \
         -target:library \
         -out:$@ \
+        -keyfile:$(BIN)$/cliuno.snk \
         -reference:$(OUT)$/bin$/cli_uretypes.dll \
         -reference:System.dll \
         $(CSFILES)
diff --git a/cli_ure/source/ure/makefile.mk b/cli_ure/source/ure/makefile.mk
index 96b81ad..4ef6a67 100644
--- a/cli_ure/source/ure/makefile.mk
+++ b/cli_ure/source/ure/makefile.mk
@@ -56,7 +56,7 @@ ALLTAR : \
     $(BIN)$/cli_ure.dll \
     $(POLICY_ASSEMBLY_FILE)
 
-.IF "$(CCNUMVER)" >= "001399999999"
+.IF "$(COM)" != "MSC" || "$(CCNUMVER)" >= "001399999999"
 CSCFLAGS+=-keyfile:"$(BIN)$/cliuno.snk"
 .ENDIF
 
@@ -67,7 +67,7 @@ CSFILES = \
     uno$/util$/WeakComponentBase.cs	\
     $(ASSEMBLY_ATTRIBUTES)
 
-.IF "$(CCNUMVER)" <= "001399999999"
+.IF "$(COM)" == "MSC" && "$(CCNUMVER)" <= "001399999999"
 $(ASSEMBLY_ATTRIBUTES) : assembly.cs makefile.mk $(BIN)$/cliuno.snk $(BIN)$/cliureversion.mk 
     $(GNUCOPY) -p assembly.cs $@
     echo $(ECHOQUOTE) \
-- 
1.7.0.1

