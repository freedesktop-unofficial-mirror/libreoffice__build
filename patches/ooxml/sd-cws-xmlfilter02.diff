--- sd/source/ui/unoidl/unopage.cxx	28 Aug 2007 13:39:06 -0000	1.89
+++ sd/source/ui/unoidl/unopage.cxx	4 Oct 2007 09:35:40 -0000	1.78.28.8
@@ -176,6 +176,7 @@ using ::com::sun::star::animations::XAni
 using ::com::sun::star::animations::XAnimationNodeSupplier;
 using ::rtl::OUString;
 using ::rtl::OUStringBuffer;
+
 using namespace ::vos;
 using namespace ::osl;
 using namespace ::com::sun::star;
@@ -543,6 +544,7 @@ Any SAL_CALL SdGenericDrawPage::queryInt
 	else QUERYINT( document::XLinkTargetSupplier );
 	else QUERYINT( drawing::XShapeCombiner );
 	else QUERYINT( drawing::XShapeBinder );
+	else QUERYINT( beans::XMultiPropertySet );
 	else if( rType == ITYPE( XAnimationNodeSupplier ) )
 	{
 		if( mbIsImpressDocument )
@@ -1065,7 +1067,7 @@ Any SAL_CALL SdGenericDrawPage::getPrope
 
 						SvMemoryStream aDestStrm( 65535, 65535 );
 						ConvertGDIMetaFileToWMF( *pMetaFile, aDestStrm, NULL, sal_False );
-						uno::Sequence<sal_Int8> aSeq( (sal_Int8*)aDestStrm.GetData(), aDestStrm.Tell() );
+						Sequence<sal_Int8> aSeq( (sal_Int8*)aDestStrm.GetData(), aDestStrm.Tell() );
 						aAny <<= aSeq;
 						delete pMetaFile;
 					}
@@ -1260,6 +1262,64 @@ void SAL_CALL SdGenericDrawPage::removeP
 void SAL_CALL SdGenericDrawPage::addVetoableChangeListener( const OUString& , const Reference< beans::XVetoableChangeListener >&  ) throw(beans::UnknownPropertyException, lang::WrappedTargetException, uno::RuntimeException) {}
 void SAL_CALL SdGenericDrawPage::removeVetoableChangeListener( const OUString& , const Reference< beans::XVetoableChangeListener >&  ) throw(beans::UnknownPropertyException, lang::WrappedTargetException, uno::RuntimeException) {}
 
+// XMultiPropertySet
+void SAL_CALL SdGenericDrawPage::setPropertyValues( const Sequence< OUString >& aPropertyNames, const Sequence< Any >& aValues ) throw (beans::PropertyVetoException, ::com::sun::star::lang::IllegalArgumentException, ::com::sun::star::lang::WrappedTargetException, RuntimeException )
+{
+	if( aPropertyNames.getLength() != aValues.getLength() )
+		throw lang::IllegalArgumentException();
+
+	const OUString* pNames = aPropertyNames.getConstArray();
+	const Any* pValues = aValues.getConstArray();
+	sal_uInt32 nCount = aValues.getLength();
+	while( nCount-- )
+	{
+		try
+		{
+			setPropertyValue( *pNames++, *pValues++ );
+		}
+		catch( beans::UnknownPropertyException& )
+		{
+			// ignore for multi property set
+			// todo: optimize this!
+		}
+	}
+}
+
+Sequence< Any > SAL_CALL SdGenericDrawPage::getPropertyValues( const Sequence< OUString >& aPropertyNames ) throw (RuntimeException)
+{
+	const OUString* pNames = aPropertyNames.getConstArray();
+	sal_uInt32 nCount = aPropertyNames.getLength();
+	Sequence< Any > aValues( nCount );
+	Any* pValues = aValues.getArray();
+	while( nCount-- )
+	{
+		Any aValue;
+		try
+		{
+			aValue = getPropertyValue( *pNames++ );
+		}
+		catch( beans::UnknownPropertyException& )
+		{
+			// ignore for multi property set
+			// todo: optimize this!
+		}
+		*pValues++ = aValue;
+	}
+	return aValues;
+}
+
+void SAL_CALL SdGenericDrawPage::addPropertiesChangeListener( const Sequence< OUString >& , const Reference< beans::XPropertiesChangeListener >&  ) throw (RuntimeException)
+{
+}
+
+void SAL_CALL SdGenericDrawPage::removePropertiesChangeListener( const Reference< beans::XPropertiesChangeListener >&  ) throw (RuntimeException)
+{
+}
+
+void SAL_CALL SdGenericDrawPage::firePropertiesChangeEvent( const Sequence< OUString >& , const Reference< beans::XPropertiesChangeListener >&  ) throw (RuntimeException)
+{
+}
+
 Reference< drawing::XShape >  SdGenericDrawPage::_CreateShape( SdrObject *pObj ) const throw()
 {
 	DBG_ASSERT( GetPage(), "SdGenericDrawPage::_CreateShape(), can't create shape for disposed page!" );
@@ -1384,10 +1444,10 @@ Reference< drawing::XShape >  SdGenericD
 //----------------------------------------------------------------------
 
 // XServiceInfo
-uno::Sequence< OUString > SAL_CALL SdGenericDrawPage::getSupportedServiceNames()
+Sequence< OUString > SAL_CALL SdGenericDrawPage::getSupportedServiceNames()
 	throw(uno::RuntimeException)
 {
-	uno::Sequence< OUString > aSeq( SvxFmDrawPage::getSupportedServiceNames() );
+	Sequence< OUString > aSeq( SvxFmDrawPage::getSupportedServiceNames() );
 	SvxServiceInfoHelper::addToSequence( aSeq, 3, "com.sun.star.drawing.GenericDrawPage",
 												  "com.sun.star.document.LinkTarget",
 												  "com.sun.star.document.LinkTargetSupplier");
@@ -1844,7 +1904,7 @@ Any SAL_CALL SdPageLinkTargets::getByNam
 	throw container::NoSuchElementException();
 }
 
-uno::Sequence< OUString > SAL_CALL SdPageLinkTargets::getElementNames()
+Sequence< OUString > SAL_CALL SdPageLinkTargets::getElementNames()
 	throw(uno::RuntimeException)
 {
 	OGuard aGuard( Application::GetSolarMutex() );
@@ -1866,7 +1926,7 @@ uno::Sequence< OUString > SAL_CALL SdPag
 		}
 	}
 
-	uno::Sequence< OUString > aSeq( nObjCount );
+	Sequence< OUString > aSeq( nObjCount );
 	if( nObjCount > 0 )
 	{
 		OUString* pStr = aSeq.getArray();
@@ -1931,11 +1991,11 @@ sal_Bool SAL_CALL SdPageLinkTargets::sup
 	return SvxServiceInfoHelper::supportsService( ServiceName, getSupportedServiceNames() );
 }
 
-uno::Sequence< OUString > SAL_CALL SdPageLinkTargets::getSupportedServiceNames()
+Sequence< OUString > SAL_CALL SdPageLinkTargets::getSupportedServiceNames()
 	throw(uno::RuntimeException)
 {
 	const OUString aSN( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.document.LinkTargets") );
-	uno::Sequence< OUString > aSeq( &aSN, 1);
+	Sequence< OUString > aSeq( &aSN, 1);
 	return aSeq;
 }
 
@@ -1989,7 +2049,7 @@ void SAL_CALL SdDrawPage::release() thro
 UNO3_GETIMPLEMENTATION2_IMPL( SdDrawPage, SdGenericDrawPage );
 
 // XTypeProvider
-uno::Sequence< uno::Type > SAL_CALL SdDrawPage::getTypes() throw(uno::RuntimeException)
+Sequence< uno::Type > SAL_CALL SdDrawPage::getTypes() throw(uno::RuntimeException)
 {
 	OGuard aGuard( Application::GetSolarMutex() );
 
@@ -2012,13 +2072,14 @@ uno::Sequence< uno::Type > SAL_CALL SdDr
         aTypes.push_back(ITYPE(document::XLinkTargetSupplier));
         aTypes.push_back(ITYPE( drawing::XShapeCombiner ));
         aTypes.push_back(ITYPE( drawing::XShapeBinder ));
+		aTypes.push_back(ITYPE( beans::XMultiPropertySet ));
         if( bPresPage )
             aTypes.push_back(ITYPE(presentation::XPresentationPage));
         if( bPresPage && ePageKind == PK_STANDARD )
             aTypes.push_back(ITYPE(XAnimationNodeSupplier));
 
         // Get types of base class.
-        const uno::Sequence< uno::Type > aBaseTypes( SdGenericDrawPage::getTypes() );
+        const Sequence< uno::Type > aBaseTypes( SdGenericDrawPage::getTypes() );
         const sal_Int32 nBaseTypes = aBaseTypes.getLength();
         const uno::Type* pBaseTypes = aBaseTypes.getConstArray();
 
@@ -2035,13 +2096,13 @@ uno::Sequence< uno::Type > SAL_CALL SdDr
 	return maTypeSequence;
 }
 
-uno::Sequence< sal_Int8 > SAL_CALL SdDrawPage::getImplementationId() throw(uno::RuntimeException)
+Sequence< sal_Int8 > SAL_CALL SdDrawPage::getImplementationId() throw(uno::RuntimeException)
 {
 	OGuard aGuard( Application::GetSolarMutex() );
 
 	throwIfDisposed();
 
-	static uno::Sequence< sal_Int8 > aId;
+	static Sequence< sal_Int8 > aId;
 	if( aId.getLength() == 0 )
 	{
 		aId.realloc( 16 );
@@ -2096,7 +2157,7 @@ OUString SdDrawPage::getPageApiNameFromU
 	return getPageApiNameFromUiNameImpl( rUIName );
 }
 
-String getUiNameFromPageApiNameImpl( const ::rtl::OUString& rApiName )
+String getUiNameFromPageApiNameImpl( const OUString& rApiName )
 {
 	const String aDefPageName(RTL_CONSTASCII_USTRINGPARAM( sEmptyPageName ));
 	if( rApiName.compareTo( aDefPageName, aDefPageName.Len() ) == 0 )
@@ -2134,7 +2195,7 @@ String getUiNameFromPageApiNameImpl( con
 	return rApiName;
 }
 
-String SdDrawPage::getUiNameFromPageApiName( const ::rtl::OUString& rApiName )
+String SdDrawPage::getUiNameFromPageApiName( const OUString& rApiName )
 {
 	return getUiNameFromPageApiNameImpl( rApiName );
 }
@@ -2145,13 +2206,13 @@ OUString SAL_CALL SdDrawPage::getImpleme
 	return OUString( RTL_CONSTASCII_USTRINGPARAM("SdDrawPage") );
 }
 
-uno::Sequence< OUString > SAL_CALL SdDrawPage::getSupportedServiceNames() throw(uno::RuntimeException)
+Sequence< OUString > SAL_CALL SdDrawPage::getSupportedServiceNames() throw(uno::RuntimeException)
 {
 	OGuard aGuard( Application::GetSolarMutex() );
 
 	throwIfDisposed();
 
-	uno::Sequence< OUString > aSeq( SdGenericDrawPage::getSupportedServiceNames() );
+	Sequence< OUString > aSeq( SdGenericDrawPage::getSupportedServiceNames() );
 	SvxServiceInfoHelper::addToSequence( aSeq, 1, "com.sun.star.drawing.DrawPage" );
 
 	if( mbIsImpressDocument )
@@ -2453,7 +2514,7 @@ void SdDrawPage::setBackground( const An
 		Reference< beans::XPropertySet >  xDestSet( (beans::XPropertySet*)pBackground );
 		Reference< beans::XPropertySetInfo >  xDestSetInfo( xDestSet->getPropertySetInfo() );
 
-		uno::Sequence< beans::Property > aProperties( xDestSetInfo->getProperties() );
+		Sequence< beans::Property > aProperties( xDestSetInfo->getProperties() );
 		sal_Int32 nCount = aProperties.getLength();
 		beans::Property* pProp = aProperties.getArray();
 
@@ -2653,7 +2714,7 @@ void SAL_CALL SdMasterPage::release() th
 UNO3_GETIMPLEMENTATION2_IMPL( SdMasterPage, SdGenericDrawPage );
 
 // XTypeProvider
-uno::Sequence< uno::Type > SAL_CALL SdMasterPage::getTypes() throw(uno::RuntimeException)
+Sequence< uno::Type > SAL_CALL SdMasterPage::getTypes() throw(uno::RuntimeException)
 {
 	OGuard aGuard( Application::GetSolarMutex() );
 
@@ -2675,13 +2736,14 @@ uno::Sequence< uno::Type > SAL_CALL SdMa
         aTypes.push_back(ITYPE(document::XLinkTargetSupplier));
         aTypes.push_back(ITYPE( drawing::XShapeCombiner ));
         aTypes.push_back(ITYPE( drawing::XShapeBinder ));
+		aTypes.push_back(ITYPE( beans::XMultiPropertySet ));
         if( bPresPage )
             aTypes.push_back(ITYPE(presentation::XPresentationPage));
         if( bPresPage && ePageKind == PK_STANDARD )
             aTypes.push_back(ITYPE(XAnimationNodeSupplier));
 
         // Get types of base class.
-        const uno::Sequence< uno::Type > aBaseTypes( SdGenericDrawPage::getTypes() );
+        const Sequence< uno::Type > aBaseTypes( SdGenericDrawPage::getTypes() );
         const sal_Int32 nBaseTypes = aBaseTypes.getLength();
         const uno::Type* pBaseTypes = aBaseTypes.getConstArray();
 
@@ -2698,13 +2760,13 @@ uno::Sequence< uno::Type > SAL_CALL SdMa
 	return maTypeSequence;
 }
 
-uno::Sequence< sal_Int8 > SAL_CALL SdMasterPage::getImplementationId() throw(uno::RuntimeException)
+Sequence< sal_Int8 > SAL_CALL SdMasterPage::getImplementationId() throw(uno::RuntimeException)
 {
 	OGuard aGuard( Application::GetSolarMutex() );
 
 	throwIfDisposed();
 
-	static uno::Sequence< sal_Int8 > aId;
+	static Sequence< sal_Int8 > aId;
 	if( aId.getLength() == 0 )
 	{
 		aId.realloc( 16 );
@@ -2719,13 +2781,13 @@ OUString SAL_CALL SdMasterPage::getImple
 	return OUString( RTL_CONSTASCII_USTRINGPARAM("SdMasterPage") );
 }
 
-uno::Sequence< OUString > SAL_CALL SdMasterPage::getSupportedServiceNames() throw(uno::RuntimeException)
+Sequence< OUString > SAL_CALL SdMasterPage::getSupportedServiceNames() throw(uno::RuntimeException)
 {
 	OGuard aGuard( Application::GetSolarMutex() );
 
 	throwIfDisposed();
 
-	uno::Sequence< OUString > aSeq( SdGenericDrawPage::getSupportedServiceNames() );
+	Sequence< OUString > aSeq( SdGenericDrawPage::getSupportedServiceNames() );
 	SvxServiceInfoHelper::addToSequence( aSeq, 1, "com.sun.star.drawing.MasterPage" );
 
 	if( SvxFmDrawPage::mpPage && ((SdPage*)SvxFmDrawPage::mpPage)->GetPageKind() == PK_HANDOUT )
@@ -2811,7 +2873,7 @@ void SdMasterPage::setBackground( const 
 				Reference< beans::XPropertySet >  xStyleSet( xFamily->getByName( aStyleName ), UNO_QUERY_THROW );
 
 				Reference< beans::XPropertySetInfo >  xSetInfo( xInputSet->getPropertySetInfo(), UNO_QUERY_THROW );
-				Reference< beans::XPropertyState > xSetStates( xInputSet, UNO_QUERY_THROW );
+				Reference< beans::XPropertyState > xSetStates( xInputSet, UNO_QUERY );
 
 				const SfxItemPropertyMap* pMap = ImplGetPageBackgroundPropertyMap();
 				while( pMap->pName )
--- sd/source/ui/unoidl/unopage.hxx	28 Aug 2007 13:39:19 -0000	1.17
+++ sd/source/ui/unoidl/unopage.hxx	4 Oct 2007 09:35:47 -0000	1.14.100.3
@@ -53,8 +53,9 @@
 #ifndef _COM_SUN_STAR_ANIMATIONS_XANIMATIONNODESUPPLIER_HPP_
 #include <com/sun/star/animations/XAnimationNodeSupplier.hpp>
 #endif
-
-
+#ifndef _COM_SUN_STAR_BEANS_XMULTIPROPERTYSET_HPP_
+#include <com/sun/star/beans/XMultiPropertySet.hpp>
+#endif
 
 #ifndef _SFX_ITEMPROP_HXX
 #include <svtools/itemprop.hxx>
@@ -92,6 +93,7 @@ class SdGenericDrawPage : public SvxFmDr
 						  public ::com::sun::star::drawing::XShapeBinder,			
 						  public ::com::sun::star::container::XNamed,
 						  public ::com::sun::star::beans::XPropertySet,
+						  public ::com::sun::star::beans::XMultiPropertySet,
 						  public ::com::sun::star::animations::XAnimationNodeSupplier,
 						  public ::com::sun::star::document::XLinkTargetSupplier
 {
@@ -168,6 +170,13 @@ public:
     virtual void SAL_CALL addVetoableChangeListener( const ::rtl::OUString& PropertyName, const ::com::sun::star::uno::Reference< ::com::sun::star::beans::XVetoableChangeListener >& aListener ) throw(::com::sun::star::beans::UnknownPropertyException, ::com::sun::star::lang::WrappedTargetException, ::com::sun::star::uno::RuntimeException);
     virtual void SAL_CALL removeVetoableChangeListener( const ::rtl::OUString& PropertyName, const ::com::sun::star::uno::Reference< ::com::sun::star::beans::XVetoableChangeListener >& aListener ) throw(::com::sun::star::beans::UnknownPropertyException, ::com::sun::star::lang::WrappedTargetException, ::com::sun::star::uno::RuntimeException);
 
+	// XMultiPropertySet
+    virtual void SAL_CALL setPropertyValues( const ::com::sun::star::uno::Sequence< ::rtl::OUString >& aPropertyNames, const ::com::sun::star::uno::Sequence< ::com::sun::star::uno::Any >& aValues ) throw (::com::sun::star::beans::PropertyVetoException, ::com::sun::star::lang::IllegalArgumentException, ::com::sun::star::lang::WrappedTargetException, ::com::sun::star::uno::RuntimeException);
+    virtual ::com::sun::star::uno::Sequence< ::com::sun::star::uno::Any > SAL_CALL getPropertyValues( const ::com::sun::star::uno::Sequence< ::rtl::OUString >& aPropertyNames ) throw (::com::sun::star::uno::RuntimeException);
+    virtual void SAL_CALL addPropertiesChangeListener( const ::com::sun::star::uno::Sequence< ::rtl::OUString >& aPropertyNames, const ::com::sun::star::uno::Reference< ::com::sun::star::beans::XPropertiesChangeListener >& xListener ) throw (::com::sun::star::uno::RuntimeException);
+    virtual void SAL_CALL removePropertiesChangeListener( const ::com::sun::star::uno::Reference< ::com::sun::star::beans::XPropertiesChangeListener >& xListener ) throw (::com::sun::star::uno::RuntimeException);
+    virtual void SAL_CALL firePropertiesChangeEvent( const ::com::sun::star::uno::Sequence< ::rtl::OUString >& aPropertyNames, const ::com::sun::star::uno::Reference< ::com::sun::star::beans::XPropertiesChangeListener >& xListener ) throw (::com::sun::star::uno::RuntimeException);
+
 	// XLinkTargetSupplier
     virtual ::com::sun::star::uno::Reference< ::com::sun::star::container::XNameAccess > SAL_CALL getLinks(  ) throw(::com::sun::star::uno::RuntimeException);
 
--- sd/source/ui/unoidl/unopback.cxx	12 Dec 2006 19:02:01 -0000	1.15
+++ sd/source/ui/unoidl/unopback.cxx	27 Jun 2007 14:55:12 -0000	1.15.32.1
@@ -166,7 +166,22 @@ void SdUnoPageBackground::fillItemSet( S
 				if( pAny )
 				{
 					OUString aPropertyName( OUString::createFromAscii(pMap->pName));
-					setPropertyValue( aPropertyName, *pAny );
+					if ( pMap->nWID == XATTR_FILLBITMAP )
+					{
+						if ( ( ( pAny->getValueType() == ::getCppuType((const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XBitmap >*)0) ) ||
+								( pAny->getValueType() == ::getCppuType((const ::com::sun::star::uno::Reference< ::com::sun::star::graphic::XGraphic >*)0) ) ) &&
+								( pMap->nMemberId == MID_BITMAP ) )
+						{
+							setPropertyValue( aPropertyName, *pAny );
+						}
+						else if ( ( pAny->getValueType() == ::getCppuType((const ::rtl::OUString*)0) ) &&
+									( ( pMap->nMemberId == MID_NAME ) || ( pMap->nMemberId == MID_GRAFURL ) ) )
+						{
+							setPropertyValue( aPropertyName, *pAny );
+						}
+					}
+					else
+						setPropertyValue( aPropertyName, *pAny );
 				}
 				pMap++;
 			}
