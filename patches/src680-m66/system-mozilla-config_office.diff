Index: configure.in
===================================================================
RCS file: /cvs/tools/config_office/configure.in,v
retrieving revision 1.69
diff -u -p -r1.69 configure.in
--- config_office/configure.in	9 Sep 2004 11:22:06 -0000	1.69
+++ config_office/configure.in	29 Sep 2004 12:05:33 -0000
@@ -53,15 +53,6 @@ AC_ARG_WITH(fonts,
                           for specific distributions where the fonts are known 
                           to be already available
 ],,)
-
-AC_ARG_ENABLE(mozilla,
-[  --disable-mozilla       OO.o usually includes a strangely hacked up mozilla
-                          binary for your platform, to build without this
-                          version, use this option.
- 
-                          Usage: --disable-mozilla
-],,enable_mozilla="yes")
-
 AC_ARG_ENABLE(cups,
 [  --enable-cups           enable cups support in the psprint project
 ],,)
@@ -180,11 +171,14 @@ AC_ARG_WITH(system-curl,
 [  --with-system-curl      Use curl already on system
 ],,)
 AC_ARG_WITH(system-nas,
-[  --with-system-nas      Use nas already on system
+[  --with-system-nas       Use nas already on system
 ],,)
 AC_ARG_WITH(system-neon,
 [  --with-system-neon      Use neon 0.23.x already on system
 ],,)
+AC_ARG_WITH(system-mozilla,
+[  --with-system-mozilla   Use mozilla already on system. Note that some components cannot be built against a contemporary mozilla
+],,)
 AC_ARG_WITH(stlport4,
 [  --with-stlport4         The location that STLport4 is installed in. The STL
                           header files are assumed to be in stlport4-home/stlport
@@ -2015,23 +2009,26 @@ AC_MSG_CHECKING([which mozilla to use])
 if test -n "$with_system_mozilla"; then
     AC_MSG_RESULT([external])
     SYSTEM_MOZILLA=YES
-    PKG_CHECK_MODULES( MOZILLA, mozilla-xpcom )
-    PKG_CHECK_MODULES( MOZILLABASE, mozilla-nspr )
-    MOZILLA_ADDRBOOK_CFLAGS=`echo $MOZILLABASE_CFLAGS | $SED -e "s/nspr/addrbook/g"`
-    MOZILLA_RDF_CFLAGS=`echo $MOZILLABASE_CFLAGS | $SED -e "s/nspr/rdf/g"`
-    MOZILLA_MSGBASE_CFLAGS=`echo $MOZILLABASE_CFLAGS | $SED -e "s/nspr/msgbase/g"`
-    MOZILLA_XPCOM_OBSOLETE_CFLAGS=`echo $MOZILLABASE_CFLAGS | $SED -e "s/nspr/xpcom_obsolete/g"`
-    MOZILLA_PREF_CFLAGS=`echo $MOZILLABASE_CFLAGS | $SED -e "s/nspr/pref/g"`
-    MOZILLA_MIME_CFLAGS=`echo $MOZILLABASE_CFLAGS | $SED -e "s/nspr/mime/g"`
-    MOZILLA_CFLAGS="$MOZILLA_CFLAGS $MOZILLA_ADDRBOOK_CFLAGS $MOZILLA_RDF_CFLAGS $MOZILLA_MSGBASE_CFLAGS $MOZILLA_XPCOM_OBSOLETE_CFLAGS $MOZILLA_PREF_CFLAGS $MOZILLA_MIME_CFLAGS"
+    PKG_CHECK_MODULES( MOZILLAXPCOM, mozilla-xpcom )
+    PKG_CHECK_MODULES( MOZ_NSS, mozilla-nss )
+    MOZ_INC=`$PKG_CONFIG --variable=includedir mozilla-xpcom`
+    MOZ_LIB=`$PKG_CONFIG --variable=libdir mozilla-xpcom`
+    MOZ_LIB_XPCOM=$MOZILLAXPCOM_LIBS
+    MOZ_NSS_HACK=YES
+    if [ nm $MOZ_LIB/libnss3.so | grep 'T PK11_GetCertFromPrivateKey' > /dev/null ] ; then
+        MOZ_NSS_HACK=NO
+    fi
 else
     AC_MSG_RESULT([internal])
     SYSTEM_MOZILLA=NO
     BUILD_TYPE="$BUILD_TYPE MOZ"
 fi
 AC_SUBST(SYSTEM_MOZILLA)
-AC_SUBST(MOZILLA_CFLAGS)
-AC_SUBST(MOZILLA_LIBS)
+AC_SUBST(MOZ_INC)
+AC_SUBST(MOZ_LIB)
+AC_SUBST(MOZ_LIB_XPCOM)
+AC_SUBST(MOZ_NSS_CFLAGS)
+AC_SUBST(MOZ_NSS_HACK)
 
 
 dnl ===================================================================
@@ -2707,27 +2713,6 @@ AC_SUBST(LIBSN_CFLAGS)
 AC_SUBST(LIBSN_LIBS)
 
 dnl ===================================================================
-dnl Disable mozilla if we can
-dnl ===================================================================
-
-AC_MSG_CHECKING([whether to build mozilla connectivity])
-if test -n "$enable_mozilla"; then
-  if test "$enable_mozilla" = "no"; then
-   AC_MSG_RESULT([no])
-   WITH_MOZILLA=NO
-   SCPDEFS="$SCPDEFS -DWITHOUT_MOZILLA"
-  else
-   AC_MSG_RESULT([yes])
-   WITH_MOZILLA=YES
-  fi
-else
-   AC_MSG_RESULT([no])
-   WITH_MOZILLA=NO
-   SCPDEFS="$SCPDEFS -DWITHOUT_MOZILLA"
-fi
-AC_SUBST(WITH_MOZILLA)
-
-dnl ===================================================================
 dnl Test whether we want to use the Mozilla or the OpenLDAP LDAP SDK
 dnl ===================================================================
 AC_MSG_CHECKING([which LDAP SDK to use])
Index: set_soenv.in
===================================================================
RCS file: /cvs/tools/config_office/set_soenv.in,v
retrieving revision 1.22
diff -u -p -r1.22 set_soenv.in
--- config_office/set_soenv.in	9 Sep 2004 11:22:23 -0000	1.22
+++ config_office/set_soenv.in	29 Sep 2004 12:06:45 -0000
@@ -87,7 +87,7 @@ my ( $oldPATH, $SRC_ROOT, $SO_HOME, $JAV
      $ATL_LIB, $ATL_INCLUDE, $NO_HIDS, $TEMP, $COMMON_BUILD_TOOLS, $WIN_GREP, $WIN_FIND, $WIN_LS,
      $WIN_GNUCOPY, $WIN_TOUCH, $STLPORT4, $ENABLE_DEBUG,
 	 $PROEXT,
-     $SYSTEM_PYTHON, $PYTHONPATH, $PYTHONHOME );
+     $SYSTEM_PYTHON, $PYTHONPATH, $PYTHONHOME, $SYSTEM_MOZILLA );
 #
 #-------------------------------------------
 # IId. Declaring the aliases.
@@ -128,6 +128,7 @@ $warnfile       = "warn";           # lo
 $Warning        = "";               # container for warning messages
 $STLPORT4       = '@STLPORT4@';     # Location of STLport4
 $SYSTEM_PYTHON	= '@SYSTEM_PYTHON@';
+$SYSTEM_MOZILLA = '@SYSTEM_MOZILLA@';
 $MINGW          = '@WITH_MINGWIN@'; # use MinGW for Windows build
 $CC             = '@CC@';           # C compiler
 $CXX            = '@CXX@';          # C++ compiler
@@ -1182,6 +1183,12 @@ elsif ($platform eq "$Macosx") 
     }
 
 }
+
+if ($SYSTEM_MOZILLA eq "YES")
+{
+	$SOLARLIB .= $L."@MOZ_LIB@"
+}
+
 # Location of the compiler include search directory paths.
 $SOLARINC             = $I.$cur_dir.
                         $I.'$SOLARVER'.$ds.'$UPD'.$ds.'$INPATH'.$INC.$ds."stl".
@@ -1689,7 +1696,6 @@ ToFile( "LIBART_LIBS",       "@LIBART_LI
 ToFile( "WITH_LIBSN",        "@WITH_LIBSN@",       "e" );
 ToFile( "LIBSN_CFLAGS",      "@LIBSN_CFLAGS@",     "e" );
 ToFile( "LIBSN_LIBS",        "@LIBSN_LIBS@",       "e" );
-ToFile( "WITH_MOZILLA",      "@WITH_MOZILLA@",     "e" );
 ToFile( "WITH_OPENLDAP",     "@WITH_OPENLDAP@",    "e" );
 ToFile( "WITH_FONTS",        "@WITH_FONTS@",       "e" );
 ToFile( "WITH_BINFILTER",    "@WITH_BINFILTER@",   "e" );
@@ -1750,8 +1756,11 @@ ToFile( "SYSTEM_NEON",       "@SYSTEM_NE
 ToFile( "NEON_LIBS",         "@NEON_LIBS@",        "e" );
 ToFile( "NEON_CFLAGS",       "@NEON_CFLAGS@",      "e" );
 ToFile( "SYSTEM_MOZILLA",    "@SYSTEM_MOZILLA@",   "e" );
-ToFile( "MOZILLA_CFLAGS",    "@MOZILLA_CFLAGS@",   "e" );
-ToFile( "MOZILLA_LIBS",      "@MOZILLA_LIBS@",     "e" );
+ToFile( "MOZ_INC",           "@MOZ_INC@",          "e" );
+ToFile( "MOZ_LIB",           "@MOZ_LIB@",          "e" );
+ToFile( "MOZ_LIB_XPCOM",     "@MOZ_LIB_XPCOM@",    "e" );
+ToFile( "MOZ_NSS_CFLAGS",    "@MOZ_NSS_CFLAGS@",   "e" );
+ToFile( "MOZ_NSS_HACK",      "@MOZ_NSS_HACK@",     "e" );
 ToFile( "BUILD_DMAKE",       "@BUILD_DMAKE@",      "e" );
 ToFile( "USE_XINERAMA",      "@USE_XINERAMA@",     "e" );
 ToFile( "XINERAMA_LINK",     "@XINERAMA_LINK@",    "e" );
