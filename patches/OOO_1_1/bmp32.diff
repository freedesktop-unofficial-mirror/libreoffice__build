Index: vcl/inc/salbtype.hxx
===================================================================
RCS file: /cvs/oo/gsl/vcl/inc/salbtype.hxx,v
retrieving revision 1.3
diff -u -r1.3 salbtype.hxx
--- vcl/inc/salbtype.hxx	2001/06/28 13:08:49	1.3
+++ vcl/inc/salbtype.hxx	2002/11/05 20:13:00
@@ -201,6 +201,7 @@
 	BYTE				mcBlueOrIndex;
 	BYTE				mcGreen;
 	BYTE				mcRed;
+	BYTE				mcAlpha;
 	BYTE				mbIndex;
 
 public:
@@ -208,6 +209,7 @@
 	inline				BitmapColor();
 	inline				BitmapColor( const BitmapColor& rBitmapColor );
 	inline				BitmapColor( BYTE cRed, BYTE cGreen, BYTE cBlue );
+	inline				BitmapColor( BYTE cRed, BYTE cGreen, BYTE cBlue, BYTE cAlpha );
 	inline				BitmapColor( const Color& rColor );
 	inline				BitmapColor( BYTE cIndex );
 	inline				~BitmapColor() {};
@@ -227,6 +229,9 @@
 	inline BYTE 		GetBlue() const;
 	inline void 		SetBlue( BYTE cBlue );
 
+	inline BYTE 		GetAlpha() const;
+	inline void 		SetAlpha( BYTE cAlpha );
+
 	inline BYTE 		GetIndex() const;
 	inline void 		SetIndex( BYTE cIndex );
 
@@ -390,6 +395,7 @@
 			mcBlueOrIndex	( 0 ),
 			mcGreen 		( 0 ),
 			mcRed			( 0 ),
+			mcAlpha			( 255 ),
 			mbIndex 		( FALSE )
 {
 }
@@ -400,6 +406,18 @@
 			mcBlueOrIndex	( cBlue ),
 			mcGreen 		( cGreen ),
 			mcRed			( cRed ),
+			mcAlpha			( 255 ),
+			mbIndex 		( FALSE )
+{
+}
+
+// ------------------------------------------------------------------
+
+inline BitmapColor::BitmapColor( BYTE cRed, BYTE cGreen, BYTE cBlue, BYTE cAlpha ) :
+			mcBlueOrIndex	( cBlue ),
+			mcGreen 		( cGreen ),
+			mcRed			( cRed ),
+			mcAlpha			( cAlpha ),
 			mbIndex 		( FALSE )
 {
 }
@@ -410,6 +428,7 @@
 			mcBlueOrIndex	( rBitmapColor.mcBlueOrIndex ),
 			mcGreen 		( rBitmapColor.mcGreen ),
 			mcRed			( rBitmapColor.mcRed ),
+			mcAlpha			( rBitmapColor.mcAlpha ),
 			mbIndex 		( rBitmapColor.mbIndex )
 {
 }
@@ -420,6 +439,7 @@
 			mcBlueOrIndex	( rColor.GetBlue() ),
 			mcGreen 		( rColor.GetGreen() ),
 			mcRed			( rColor.GetRed() ),
+			mcAlpha			( 255 ),
 			mbIndex 		( 0 )
 {
 }
@@ -430,6 +450,7 @@
 			mcBlueOrIndex	( cIndex ),
 			mcGreen 		( 0 ),
 			mcRed			( 0 ),
+			mcAlpha			( 255 ),
 			mbIndex 		( TRUE )
 {
 }
@@ -440,7 +461,8 @@
 {
 	return( ( mcBlueOrIndex == rBitmapColor.mcBlueOrIndex ) &&
 			( mbIndex ? rBitmapColor.mbIndex :
-			( mcGreen == rBitmapColor.mcGreen && mcRed == rBitmapColor.mcRed ) ) );
+			( mcGreen == rBitmapColor.mcGreen && mcRed == rBitmapColor.mcRed &&
+				mcAlpha == rBitmapColor.mcAlpha ) ) );
 }
 
 // ------------------------------------------------------------------
@@ -457,6 +479,7 @@
 	mcBlueOrIndex = rBitmapColor.mcBlueOrIndex;
 	mcGreen = rBitmapColor.mcGreen;
 	mcRed = rBitmapColor.mcRed;
+	mcAlpha = rBitmapColor.mcAlpha;
 	mbIndex = rBitmapColor.mbIndex;
 
 	return *this;
@@ -519,6 +542,22 @@
 
 // ------------------------------------------------------------------
 
+inline BYTE BitmapColor::GetAlpha() const
+{
+	BMP_ASSERT( !mbIndex, "Pixel represents index into colortable!" );
+	return mcAlpha;
+}
+
+// ------------------------------------------------------------------
+
+inline void BitmapColor::SetAlpha( BYTE cAlpha )
+{
+	BMP_ASSERT( !mbIndex, "Pixel represents index into colortable!" );
+	mcAlpha = cAlpha;
+}
+
+// ------------------------------------------------------------------
+
 inline BYTE BitmapColor::GetIndex() const
 {
 	BMP_ASSERT( mbIndex, "Pixel represents color values!" );
@@ -964,11 +1003,14 @@
 #ifdef __BIGENDIAN
 	const UINT32 nVal = (UINT32) pPixel[ 0 ] | ( (UINT32) pPixel[ 1 ] << 8UL ) |
 						( (UINT32) pPixel[ 2 ] << 16UL ) | ( (UINT32) pPixel[ 3 ] << 24UL );
+	BYTE alpha = pPixel[3];
 #else
 	const UINT32 nVal = *(UINT32*) pPixel;
+	BYTE alpha = pPixel[3];
 #endif
 
 	MASK_TO_COLOR( nVal, mnRMask, mnGMask, mnBMask, mnRShift, mnGShift, mnBShift, rColor );
+	rColor.SetAlpha (alpha);
 }
 
 // ------------------------------------------------------------------
@@ -977,10 +1019,13 @@
 {
 #ifdef __BIGENDIAN
 	const UINT32 nVal = COLOR_TO_MASK( rColor, mnRMask, mnGMask, mnBMask, mnRShift, mnGShift, mnBShift );
-	pPixel[ 0 ] = (BYTE) nVal; pPixel[ 1 ] = (BYTE) ( nVal >> 8UL );
-	pPixel[ 2 ] = (BYTE) ( nVal >> 16UL ); pPixel[ 3 ] = (BYTE) ( nVal >> 24UL );
+	pPixel[ 0 ] = (BYTE) nVal;
+	pPixel[ 1 ] = (BYTE) ( nVal >> 8UL );
+	pPixel[ 2 ] = (BYTE) ( nVal >> 16UL ); 
+	pPixel[ 3 ] = (BYTE) (rColor.GetAlpha ());
 #else
 	*(UINT32*) pPixel = COLOR_TO_MASK( rColor, mnRMask, mnGMask, mnBMask, mnRShift, mnGShift, mnBShift );
+	pPixel[3] = rColor.GetAlpha ();
 #endif
 }
 
Index: vcl/source/gdi/bmpacc2.cxx
===================================================================
RCS file: /cvs/oo/gsl/vcl/source/gdi/bmpacc2.cxx,v
retrieving revision 1.2
diff -u -r1.2 bmpacc2.cxx
--- vcl/source/gdi/bmpacc2.cxx	2001/06/28 13:10:36	1.2
+++ vcl/source/gdi/bmpacc2.cxx	2002/11/05 20:13:01
@@ -266,7 +266,8 @@
 {
 	BitmapColor aBitmapColor;
 
-	aBitmapColor.SetBlue( *( pScanline = pScanline + ( nX << 2 ) + 1 )++ );
+	aBitmapColor.SetAlpha ( *( pScanline = pScanline + ( nX << 2 ))++ );
+	aBitmapColor.SetBlue( *pScanline++ );
 	aBitmapColor.SetGreen( *pScanline++ );
 	aBitmapColor.SetRed( *pScanline );
 
@@ -277,7 +278,7 @@
 
 IMPL_FORMAT_SETPIXEL( _32BIT_TC_ABGR )
 {
-	*( pScanline = pScanline + ( nX << 2 ) )++ = 0;
+	*( pScanline = pScanline + ( nX << 2 ) )++ = rBitmapColor.GetAlpha ();
 	*pScanline++ = rBitmapColor.GetBlue();
 	*pScanline++ = rBitmapColor.GetGreen();
 	*pScanline = rBitmapColor.GetRed();
@@ -289,7 +290,8 @@
 {
 	BitmapColor aBitmapColor;
 
-	aBitmapColor.SetRed( *( pScanline = pScanline + ( nX << 2 ) + 1 )++ );
+	aBitmapColor.SetAlpha ( *( pScanline = pScanline + ( nX << 2 ))++ );
+	aBitmapColor.SetRed( *pScanline++ );
 	aBitmapColor.SetGreen( *pScanline++ );
 	aBitmapColor.SetBlue( *pScanline );
 
@@ -300,7 +302,7 @@
 
 IMPL_FORMAT_SETPIXEL( _32BIT_TC_ARGB )
 {
-	*( pScanline = pScanline + ( nX << 2 ) )++ = 0;
+	*( pScanline = pScanline + ( nX << 2 ) )++ = rBitmapColor.GetAlpha ();
 	*pScanline++ = rBitmapColor.GetRed();
 	*pScanline++ = rBitmapColor.GetGreen();
 	*pScanline = rBitmapColor.GetBlue();
@@ -314,7 +316,8 @@
 
 	aBitmapColor.SetBlue( *( pScanline = pScanline + ( nX << 2 ) )++ );
 	aBitmapColor.SetGreen( *pScanline++ );
-	aBitmapColor.SetRed( *pScanline );
+	aBitmapColor.SetRed( *pScanline++ );
+	aBitmapColor.SetAlpha( *pScanline );
 
 	return aBitmapColor;
 }
@@ -326,7 +329,7 @@
 	*( pScanline = pScanline + ( nX << 2 ) )++ = rBitmapColor.GetBlue();
 	*pScanline++ = rBitmapColor.GetGreen();
 	*pScanline++ = rBitmapColor.GetRed();
-	*pScanline = 0;
+	*pScanline = rBitmapColor.GetAlpha();
 }
 
 // ------------------------------------------------------------------
@@ -337,7 +340,8 @@
 
 	aBitmapColor.SetRed( *( pScanline = pScanline + ( nX << 2 ) )++ );
 	aBitmapColor.SetGreen( *pScanline++ );
-	aBitmapColor.SetBlue( *pScanline );
+	aBitmapColor.SetBlue( *pScanline++ );
+	aBitmapColor.SetAlpha ( *pScanline );
 
 	return aBitmapColor;
 }
@@ -349,7 +353,7 @@
 	*( pScanline = pScanline + ( nX << 2 ) )++ = rBitmapColor.GetRed();
 	*pScanline++ = rBitmapColor.GetGreen();
 	*pScanline++ = rBitmapColor.GetBlue();
-	*pScanline = 0;
+	*pScanline = rBitmapColor.GetAlpha();
 }
 
 // ------------------------------------------------------------------
Index: vcl/source/gdi/impbmp.cxx
===================================================================
RCS file: /cvs/oo/gsl/vcl/source/gdi/impbmp.cxx,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 impbmp.cxx
--- vcl/source/gdi/impbmp.cxx	2000/09/18 17:05:37	1.1.1.1
+++ vcl/source/gdi/impbmp.cxx	2002/11/05 20:13:01
@@ -177,7 +177,7 @@
 #endif
 		nBitCount = mpSalBitmap->GetBitCount();
 
-	return( ( nBitCount <= 1 ) ? 1 : ( nBitCount <= 4 ) ? 4 : ( nBitCount <= 8 ) ? 8 : 24 );
+	return( ( nBitCount <= 1 ) ? 1 : ( nBitCount <= 4 ) ? 4 : ( nBitCount <= 8 ) ? 8 : ( nBitCount <= 24 ) ? 24 : 32 );
 }
 
 // -----------------------------------------------------------------------
Index: vcl/unx/source/gdi/salbmp.cxx
===================================================================
RCS file: /cvs/oo/gsl/vcl/unx/source/gdi/salbmp.cxx,v
retrieving revision 1.8
diff -u -r1.8 salbmp.cxx
--- vcl/unx/source/gdi/salbmp.cxx	2001/09/11 15:52:22	1.8
+++ vcl/unx/source/gdi/salbmp.cxx	2002/11/05 20:13:05
@@ -150,7 +150,7 @@
 
 BitmapBuffer* SalBitmap::ImplCreateDIB( const Size& rSize, USHORT nBitCount, const BitmapPalette& rPal )
 {
-	DBG_ASSERT( nBitCount == 1 || nBitCount == 4 || nBitCount == 8 || nBitCount == 24, "Unsupported BitCount!" );
+	DBG_ASSERT( nBitCount == 1 || nBitCount == 4 || nBitCount == 8 || nBitCount == 24 || nBitCount == 32, "Unsupported BitCount!" );
 
 	BitmapBuffer* pDIB;
 
@@ -169,9 +169,10 @@
 				case( 1 ): pDIB->mnFormat |= BMP_FORMAT_1BIT_MSB_PAL; break;
 				case( 4 ): pDIB->mnFormat |= BMP_FORMAT_4BIT_MSN_PAL; break;
 				case( 8 ): pDIB->mnFormat |= BMP_FORMAT_8BIT_PAL; break;
+				case( 24 ): pDIB->mnFormat |= BMP_FORMAT_24BIT_TC_BGR; break;
 			
 				default:
-					pDIB->mnFormat |= BMP_FORMAT_24BIT_TC_BGR;
+					pDIB->mnFormat |= BMP_FORMAT_32BIT_TC_BGRA;
 				break;
 			}
 
@@ -802,8 +803,10 @@
 				nBitCount = 4;
 			else if( nBitCount <= 8 )
 				nBitCount = 8;
-			else
+			else if ( nBitCount <= 24)
 				nBitCount = 24;
+			else
+				nBitCount = 32;
 		}
 	}
 	else
Index: vcl/source/gdi/bitmap3.cxx
===================================================================
RCS file: /cvs/oo/gsl/vcl/source/gdi/bitmap3.cxx,v
retrieving revision 1.3
diff -u -p -u -r1.3 bitmap3.cxx
--- vcl/source/gdi/bitmap3.cxx	27 Aug 2001 12:57:08 -0000	1.3
+++ vcl/source/gdi/bitmap3.cxx	1 May 2003 13:05:34 -0000
@@ -401,6 +401,13 @@ BOOL Bitmap::Convert( BmpConversion eCon
 			bRet = ImplConvertGhosted();
 		break;
 
+		case BMP_CONVERSION_32BIT:
+			if (nBitCount < 32)
+				bRet = ImplConvertUp (32, FALSE);
+			else
+				bRet = TRUE;
+			break;
+
 		default:
 			DBG_ERROR( "Bitmap::Convert(): Unsupported conversion" );
 		break;
@@ -1074,12 +1081,13 @@ BOOL Bitmap::ImplScaleInterpolate( const
 		BitmapReadAccess*	pReadAcc = AcquireReadAccess();
 		long				nWidth = pReadAcc->Width();
 		long				nHeight = pReadAcc->Height();
-		Bitmap				aNewBmp( Size( nNewWidth, nHeight ), 24 );
+		Bitmap				aNewBmp( Size( nNewWidth, nHeight ),
+							 GetBitCount() == 32 ? 32 : 24 );
 		BitmapWriteAccess*	pWriteAcc = aNewBmp.AcquireWriteAccess();
 		long*				pLutInt;
 		long*				pLutFrac;
 		long				nX, nY;
-		long				lXB0, lXB1, lXG0, lXG1, lXR0, lXR1;
+		long				lXB0, lXB1, lXG0, lXA0, lXG1, lXR0, lXR1, lXA1;
 		double				fTemp;
 		long				nTemp;
 
@@ -1160,10 +1168,12 @@ BOOL Bitmap::ImplScaleInterpolate( const
 							lXR1 = aCol1.GetRed() - ( lXR0 = aCol0.GetRed() );
 							lXG1 = aCol1.GetGreen() - ( lXG0 = aCol0.GetGreen() );
 							lXB1 = aCol1.GetBlue() - ( lXB0 = aCol0.GetBlue() );
+							lXA1 = aCol1.GetAlpha() - ( lXA0 = aCol0.GetAlpha() );
 
 							aCol0.SetRed( (BYTE) ( ( lXR1 * nTemp + ( lXR0 << 10 ) ) >> 10 ) );
 							aCol0.SetGreen( (BYTE) ( ( lXG1 * nTemp + ( lXG0 << 10 ) ) >> 10 ) );
 							aCol0.SetBlue( (BYTE) ( ( lXB1 * nTemp + ( lXB0 << 10 ) ) >> 10 ) );
+							aCol0.SetAlpha( (BYTE) ( ( lXA1 * nTemp + ( lXA0 << 10 ) ) >> 10 ) );
 
 							pWriteAcc->SetPixel( nY, nX, aCol0 );
 						}
@@ -1184,7 +1194,8 @@ BOOL Bitmap::ImplScaleInterpolate( const
 			bRet = FALSE;
 			ImplAssignWithSize( aNewBmp );
 			pReadAcc = AcquireReadAccess();
-			aNewBmp = Bitmap( Size( nNewWidth, nNewHeight ), 24 );
+			aNewBmp = Bitmap( Size( nNewWidth, nNewHeight ),
+					  GetBitCount() == 32 ? 32 : 24 );
 			pWriteAcc = aNewBmp.AcquireWriteAccess();
 
 			if( pReadAcc && pWriteAcc )
@@ -1264,10 +1275,12 @@ BOOL Bitmap::ImplScaleInterpolate( const
 								lXR1 = aCol1.GetRed() - ( lXR0 = aCol0.GetRed() );
 								lXG1 = aCol1.GetGreen() - ( lXG0 = aCol0.GetGreen() );
 								lXB1 = aCol1.GetBlue() - ( lXB0 = aCol0.GetBlue() );
+								lXA1 = aCol1.GetAlpha() - ( lXA0 = aCol0.GetAlpha() );
 
 								aCol0.SetRed( (BYTE) ( ( lXR1 * nTemp + ( lXR0 << 10 ) ) >> 10 ) );
 								aCol0.SetGreen( (BYTE) ( ( lXG1 * nTemp + ( lXG0 << 10 ) ) >> 10 ) );
 								aCol0.SetBlue( (BYTE) ( ( lXB1 * nTemp + ( lXB0 << 10 ) ) >> 10 ) );
+								aCol0.SetAlpha( (BYTE) ( ( lXA1 * nTemp + ( lXA0 << 10 ) ) >> 10 ) );
 
 								pWriteAcc->SetPixel( nY, nX, aCol0 );
 							}
Index: svtools/bmpmaker/bmpcore.cxx
===================================================================
RCS file: /cvs/util/svtools/bmpmaker/bmpcore.cxx,v
retrieving revision 1.12
diff -u -p -u -r1.12 bmpcore.cxx
--- svtools/bmpmaker/bmpcore.cxx	24 Apr 2003 13:01:46 -0000	1.12
+++ svtools/bmpmaker/bmpcore.cxx	11 Sep 2003 11:59:39 -0000
@@ -107,7 +107,8 @@ void BmpCreator::ImplCreate( SvStream& r
                              const ::std::vector< DirEntry >& rInDirs, 
                              const DirEntry& rOut, 
                              const String& rName, 
-                             const LangInfo& rLang )
+                             const LangInfo& rLang,
+							 const Color& rMaskColor)
 {
     const sal_uInt32    nOldPos = pSRS->Tell();
    	const char*         pCollectFile = getenv( "BMP_COLLECT_FILE" );
@@ -237,6 +238,26 @@ void BmpCreator::ImplCreate( SvStream& r
 				}
                 else
                 {
+				    if (aBmp.GetBitCount () != 32)
+					{
+						aBmp.Convert (BMP_CONVERSION_32BIT);
+
+						BitmapWriteAccess *pUpd = aBmp.AcquireWriteAccess();
+						
+						for( long nY = 0; nY < aSize.Height(); nY++ ) {
+								for( long nX = 0; nX < aSize.Width(); nX++ ) {
+										BitmapColor aCol;
+										aCol = pUpd->GetPixel( nY, nX );
+										if( aCol == rMaskColor ) {
+												aCol.SetAlpha( 0 );
+												pUpd->SetPixel( nY, nX, aCol );
+										}
+								}
+						}
+
+						aBmp.ReleaseAccess( pUpd );
+					}
+						
 		            if( aTotalBmp.IsEmpty() )
 		            {
                         // first bitmap determines metrics of total bitmap
@@ -335,6 +356,13 @@ void BmpCreator::ImplCreate( SvStream& r
 
 // -----------------------------------------------------------------------------
 
+static sal_Int32 GetColorVal( const ByteString &rLine )
+{
+    ByteString aVal( rLine.GetToken( 1, '=' ) );
+	aVal.EraseLeadingChars();
+	return aVal.ToInt32() / 256;
+}
+
 void BmpCreator::Create( const String& rSRSName, 
                          const ::std::vector< String >& rInDirs,
 			             const String& rOutName, 
@@ -395,6 +423,8 @@ void BmpCreator::Create( const String& r
 
 			const String aName( aText.GetToken( 1, '"' ) );
 
+			Color aMaskColor;
+
 			do
 			{
 				if( !bLangDep &&
@@ -405,6 +435,13 @@ void BmpCreator::Create( const String& r
 					bLangDep = TRUE;
 				}
 
+				if( aByteText.Search( "Red" ) != STRING_NOTFOUND )
+					aMaskColor.SetRed( GetColorVal( aByteText ) );
+				if( aByteText.Search( "Green" ) != STRING_NOTFOUND )
+					aMaskColor.SetGreen( GetColorVal( aByteText ) );
+				if( aByteText.Search( "Blue" ) != STRING_NOTFOUND )
+					aMaskColor.SetBlue( GetColorVal( aByteText ) );
+
 				if (!pSRS->ReadLine(aByteText))
 					 break;
 			}
@@ -415,7 +452,7 @@ void BmpCreator::Create( const String& r
 			if( aText.Len() )
 			{
 				bDone = TRUE;
- 				ImplCreate( *pSRS, aInDirs, aOutDir, aName, rLang );
+ 				ImplCreate( *pSRS, aInDirs, aOutDir, aName, rLang, aMaskColor );
 			}
 			else if( ( rLang.mnLangNum != 49 ) && !bLangDep )
 			{
Index: vcl/source/gdi/bitmap2.cxx
===================================================================
RCS file: /cvs/gsl/vcl/source/gdi/bitmap2.cxx,v
retrieving revision 1.4
diff -u -p -u -r1.4 bitmap2.cxx
--- vcl/source/gdi/bitmap2.cxx	24 Apr 2003 13:17:58 -0000	1.4
+++ vcl/source/gdi/bitmap2.cxx	12 Sep 2003 14:11:50 -0000
@@ -204,7 +204,8 @@ BOOL Bitmap::ImplReadDIB( SvStream& rISt
 	{
 		USHORT nBitCount = ( aHeader.nBitCount <= 1 ) ? 1 :
 						   ( aHeader.nBitCount <= 4 ) ? 4 :
-						   ( aHeader.nBitCount <= 8 ) ? 8 : 24;
+						   ( aHeader.nBitCount <= 8 ) ? 8 : 
+						   ( aHeader.nBitCount <= 24 ) ? 24 : 32;
 
 		const Size			aSizePixel( aHeader.nWidth, aHeader.nHeight );
 		BitmapPalette		aDummyPal;
@@ -1009,6 +1010,27 @@ BOOL Bitmap::ImplWriteDIBBits( SvStream&
 				}
 				break;
 
+				case 24:
+				{
+					BitmapColor aPixelColor;
+
+					for( long nY = nHeight - 1; nY >= 0L; nY-- )
+					{
+						pTmp = pBuf;
+
+						for( long nX = 0L; nX < nWidth; nX++ )
+						{
+							aPixelColor = rAcc.GetPixel( nY, nX );
+							*pTmp++ = aPixelColor.GetBlue();
+							*pTmp++ = aPixelColor.GetGreen();
+							*pTmp++ = aPixelColor.GetRed();
+						}
+
+						rOStm.Write( pBuf, nAlignedWidth );
+					}
+				}
+				break;
+
 				default:
 				{
 					BitmapColor aPixelColor;
@@ -1023,6 +1045,7 @@ BOOL Bitmap::ImplWriteDIBBits( SvStream&
 							*pTmp++ = aPixelColor.GetBlue();
 							*pTmp++ = aPixelColor.GetGreen();
 							*pTmp++ = aPixelColor.GetRed();
+							*pTmp++ = aPixelColor.GetAlpha();
 						}
 
 						rOStm.Write( pBuf, nAlignedWidth );
@@ -1038,6 +1061,38 @@ BOOL Bitmap::ImplWriteDIBBits( SvStream&
 	rImageSize = rOStm.Tell() - rImageSize;
 
 	return( rOStm.GetError() == 0UL );
+}
+
+// ------------------------------------------------------------------
+
+Bitmap
+Bitmap::GetAlphaMask()
+{
+	if( GetBitCount() < 32 )
+        return Bitmap();
+
+    Size aSize = GetSizePixel();
+    Bitmap aAlpha( aSize, 8, &GetGreyPalette( 256 ) );
+
+	aAlpha.Erase( COL_WHITE );
+
+	BitmapReadAccess *pSrc = AcquireReadAccess();
+	BitmapWriteAccess *pDst = aAlpha.AcquireWriteAccess();
+
+	for( long nY = 0; nY < aSize.Height(); nY++ )
+	{
+		for( long nX = 0; nX < aSize.Width(); nX++ )
+		{
+            BitmapColor aCol;
+			aCol = pSrc->GetPixel( nY, nX );
+			pDst->SetPixel( nY, nX, BitmapColor( 255 - aCol.GetAlpha() ) );
+		}
+	}
+	
+	ReleaseAccess( pSrc );
+	ReleaseAccess( pDst );
+		
+	return aAlpha;
 }
 
 // ------------------------------------------------------------------
Index: vcl/source/gdi/bitmap.cxx
===================================================================
RCS file: /cvs/gsl/vcl/source/gdi/bitmap.cxx,v
retrieving revision 1.7
diff -u -p -u -r1.7 bitmap.cxx
--- vcl/source/gdi/bitmap.cxx	24 Apr 2003 14:56:22 -0000	1.7
+++ vcl/source/gdi/bitmap.cxx	12 Sep 2003 14:18:51 -0000
@@ -980,7 +984,9 @@ BOOL Bitmap::CopyPixel( const Rectangle&
 			{
 				long nNextIndex = 0L;
 
-				if( ( nSrcBitCount == 24 ) && ( nDstBitCount < 24 ) )
+				if (nSrcBitCount == 32 && nDstBitCount < 32)
+					Convert (BMP_CONVERSION_32BIT);
+				else if( ( nSrcBitCount == 24 ) && ( nDstBitCount < 24 ) )
 					Convert( BMP_CONVERSION_24BIT );
 				else if( ( nSrcBitCount == 8 ) && ( nDstBitCount < 8 ) )
 				{
@@ -1772,20 +1778,58 @@ Bitmap Bitmap::CreateDisplayBitmap( Outp
 
 // ------------------------------------------------------------------
 
+static BYTE doSaturate( BYTE c, BYTE i)
+{
+    int v = 1.2 * c - 0.2 * i;
+	if( v < 0 )
+        return 0;
+	else if( v > 255 )
+        return 255;
+	else
+        return v;
+}
+
 Bitmap Bitmap::GetColorTransformedBitmap( BmpColorMode eColorMode ) const
 {
     Bitmap  aRet( *this );
-    Color*  pSrcColors = NULL;
-    Color*  pDstColors = NULL;
-    ULONG   nColorCount = 0;
-
-    Image::GetColorTransformArrays( (ImageColorTransform) eColorMode, pSrcColors, pDstColors, nColorCount );
 
-    if( nColorCount && pSrcColors && pDstColors )
-        aRet.Replace( pSrcColors, pDstColors, nColorCount ); 
+    if (eColorMode == BMP_COLOR_HIGHCONTRAST && GetBitCount() >= 24) {
 
-    delete[] pSrcColors;
-    delete[] pDstColors;
+	    // Yet another special case for icons
+	    BitmapReadAccess* pAcc = AcquireReadAccess();
+	    BitmapWriteAccess* pDis = aRet.AcquireWriteAccess();
+
+	    Size aSize = GetSizePixel();
+
+	    for( long nY = 0; nY < aSize.Height(); nY++ ) {
+		    for( long nX = 0; nX < aSize.Width(); nX++ ) {
+			    BitmapColor col = pAcc->GetPixel( nY, nX );
+			    BYTE i = ( col.GetRed() * 0.3 + // magic numbers from gdk-pixbuf
+						   col.GetGreen() * 0.59 +
+						   col.GetBlue () * 0.11 );
+			    col.SetRed   (doSaturate ( col.GetRed(), i ) );
+			    col.SetGreen (doSaturate ( col.GetGreen(), i ) );
+			    col.SetBlue  (doSaturate ( col.GetBlue(), i ) );
+			    pDis->SetPixel( nY, nX, col );
+		    }
+	    }
+
+	    aRet.ReleaseAccess( pDis );
+	    ReleaseAccess( pAcc );
+    } else {
+	
+		Color*  pSrcColors = NULL;
+	    Color*  pDstColors = NULL;
+	    ULONG   nColorCount = 0;
+	    
+	    Image::GetColorTransformArrays( (ImageColorTransform) eColorMode, pSrcColors, pDstColors, nColorCount );
+	    
+	    if( nColorCount && pSrcColors && pDstColors )
+		    aRet.Replace( pSrcColors, pDstColors, nColorCount ); 
+	    
+	    delete[] pSrcColors;
+	    delete[] pDstColors;
+    }
 
     return aRet;
 }
Index: vcl/inc/bitmap.hxx
===================================================================
RCS file: /cvs/gsl/vcl/inc/bitmap.hxx,v
retrieving revision 1.8
diff -u -p -u -r1.8 bitmap.hxx
--- vcl/inc/bitmap.hxx	24 Apr 2003 14:56:11 -0000	1.8
+++ vcl/inc/bitmap.hxx	13 Sep 2003 10:30:56 -0000
@@ -125,7 +125,8 @@ enum BmpConversion
     BMP_CONVERSION_24BIT = 7,
     BMP_CONVERSION_4BIT_TRANS = 8,
     BMP_CONVERSION_8BIT_TRANS = 9,
-    BMP_CONVERSION_GHOSTED = 10
+    BMP_CONVERSION_GHOSTED = 10,
+    BMP_CONVERSION_32BIT = 11
 };
 
 // ------------------------------------------------------------------------
@@ -389,6 +390,7 @@ public:
 	ULONG					GetChecksum() const;
 
     Bitmap                  CreateDisplayBitmap( OutputDevice* pDisplay );
+    Bitmap                  GetAlphaMask();
     Bitmap                  GetColorTransformedBitmap( BmpColorMode eColorMode ) const;
 
 	static const BitmapPalette& GetGreyPalette( USHORT nEntries );
Index: svtools/bmpmaker/bmpcore.hxx
===================================================================
RCS file: /cvs/util/svtools/bmpmaker/bmpcore.hxx,v
retrieving revision 1.3
diff -u -p -u -r1.3 bmpcore.hxx
--- svtools/bmpmaker/bmpcore.hxx	30 Oct 2002 16:27:55 -0000	1.3
+++ svtools/bmpmaker/bmpcore.hxx	13 Sep 2003 11:10:27 -0000
@@ -112,7 +112,8 @@ private:
                                 const ::std::vector< DirEntry >& rInDirs, 
                                 const DirEntry& rOut, 
                                 const String& rName, 
-                                const LangInfo& rLang );
+                                const LangInfo& rLang,
+								const Color& rMaskColor );
 
 protected:
 
