--- misc/build/icu/source/data/Makefile.in	2002-08-15 18:08:02.000000000 +0100
+++ misc/build/icu/source/data/Makefile.in	2004-04-05 20:04:55.000000000 +0100
@@ -1,5 +1,5 @@
 ## Makefile.in for ICU data
-## Copyright (c) 1999-2002, International Business Machines Corporation and
+## Copyright (c) 1999-2004, International Business Machines Corporation and
 ## others. All Rights Reserved.
 
 ## Source directory information
@@ -18,14 +18,22 @@
 
 #lib icu data for link
 LIB_ICUDATA_NAME=lib$(ICUDATA_NAME)
+LIB_STATIC_ICUDATA_NAME=lib$(STATIC_PREFIX)$(ICUDATA_NAME)
 
 # sanity!
 ICUDT=$(ICUDATA_PLATFORM_NAME)_
 
-top_builddir_from_tmp = $(patsubst ..%,../..%,$(top_builddir))
-CURDIR=$(shell pwd)
-PKGDATA = $(top_builddir)/tools/pkgdata/pkgdata -O $(top_builddir)/data/icupkg.inc -d $(CURDIR)/out
+# Allow Windows to override these options
+ifeq ($(PKGDATA_OPTS),)
+PKGDATA_OPTS = -O $(top_builddir)/data/icupkg.inc
+endif
+ifeq ($(PKGDATA_VERSIONING),)
 PKGDATA_VERSIONING = -r $(SO_TARGET_VERSION)
+endif
+
+top_builddir_from_tmp = $(patsubst ..%,../..%,$(top_builddir))
+CURDIR:=$(CURR_FULL_DIR)
+PKGDATA = $(BINDIR)/pkgdata $(PKGDATA_OPTS) -c -d $(CURDIR)/out
 
 # OBJDATADIR must be a short path (with ..'s) to the data.
 
@@ -35,7 +43,8 @@
 BRKSRCDIR=$(SRCDATADIR)/brkitr
 MISCSRCDIR=$(SRCDATADIR)/misc
 UCMSRCDIR=$(SRCDATADIR)/mappings
-SRCLISTDEPS=Makefile $(srcdir)/Makefile.in $(LOCSRCDIR)/resfiles.mk $(TRNSSRCDIR)/trnsfiles.mk
+COMINCDIR=$(top_srcdir)/common/unicode
+SRCLISTDEPS=Makefile $(srcdir)/Makefile.in
 
 # relative lib links from pkgdata are the same as for tmp
 TOOLDIR=$(top_builddir)/tools
@@ -47,7 +57,7 @@
 .PHONY : all all-local all-recursive install install-local install-files install-dlls build-cmnfile build-dll		\
 install-recursive clean clean-local clean-recursive distclean		\
 distclean-local distclean-recursive dist dist-local dist-recursive	\
-check check-local check-recursive build-testdlls build-basetestdata build-local
+check check-local check-recursive build-testdlls build-basetestdata build-local clean-resindex
 
 ## Clear suffix list
 .SUFFIXES :
@@ -92,18 +102,42 @@
 
 check-local:
 
-packagedata: icupkg.inc $(BUILDDIR)/icudata.lst 
-	$(INVOKE) $(PKGDATA) -e $(ICUDATA_ENTRY_POINT) -T $(BUILDDIR) -p $(ICUDATA_NAME) -m $(PKGDATA_MODE) $(PKGDATA_VERSIONING) $(BUILDDIR)/icudata.lst
+# During this INVOKE we only want to use stubdata.
+# We don't want to try to write over files that we are using.
+PKGDATA_INVOKE:=$(subst :$(top_builddir)/data/out,,$(INVOKE)) $(PKGDATA_INVOKE_OPTS)
+
+packagedata: icupkg.inc $(BUILDDIR)/icudata.lst build-local
+ifneq ($(ENABLE_STATIC),)
+# Move the shared library out of the way while creating the static library
+# to prevent name collisions.
+ifeq ($(wildcard $(OUTDIR)/$(LIB_ICUDATA_NAME).$(SO)),$(OUTDIR)/$(LIB_ICUDATA_NAME).$(SO))
+	mv -f $(OUTDIR)/$(LIB_ICUDATA_NAME).$(SO) $(OUTDIR)/$(LIB_ICUDATA_NAME)-temp.$(SO)
+endif
+ifeq ($(wildcard $(OUTDIR)/$(LIB_STATIC_ICUDATA_NAME).$(A)),$(OUTDIR)/$(LIB_STATIC_ICUDATA_NAME).$(A))
+	mv -f $(OUTDIR)/$(LIB_STATIC_ICUDATA_NAME).$(A) $(OUTDIR)/$(LIB_ICUDATA_NAME).$(A)
+endif
+	$(PKGDATA_INVOKE) $(PKGDATA) -e $(ICUDATA_ENTRY_POINT) -T $(BUILDDIR) -p $(ICUDATA_NAME) -m static $(BUILDDIR)/icudata.lst
+	mv -f $(OUTDIR)/$(LIB_ICUDATA_NAME).$(A) $(OUTDIR)/$(LIB_STATIC_ICUDATA_NAME).$(A)
+ifeq ($(wildcard $(OUTDIR)/$(LIB_ICUDATA_NAME)-temp.$(SO)),$(OUTDIR)/$(LIB_ICUDATA_NAME)-temp.$(SO))
+	mv -f $(OUTDIR)/$(LIB_ICUDATA_NAME)-temp.$(SO) $(OUTDIR)/$(LIB_ICUDATA_NAME).$(SO)
+endif
+endif
+	$(PKGDATA_INVOKE) $(PKGDATA) -e $(ICUDATA_ENTRY_POINT) -T $(BUILDDIR) -p $(ICUDATA_NAME) -m $(PKGDATA_MODE) $(PKGDATA_VERSIONING) $(BUILDDIR)/icudata.lst
 
 ## Install ICU data.
-install-local:  $(BUILDDIR)/icudata.lst ./icupkg.inc install-convrtrstxt $(OS390INSTALL)
+install-local: $(BUILDDIR)/icudata.lst ./icupkg.inc packagedata $(OS390INSTALL)
 	$(MKINSTALLDIRS) $(TMPDATADIR) $(DESTDIR)$(ICUPKGDATA_DIR)
-	$(INVOKE) $(PKGDATA) -m $(PKGDATA_MODE) $(PKGDATA_VERSIONING) -e $(ICUDATA_ENTRY_POINT) -T $(BUILDDIR) -s $(BUILDDIR) -p $(ICUDATA_NAME) $(BUILDDIR)/icudata.lst -I $(DESTDIR)$(ICUPKGDATA_DIR)
+ifneq ($(ENABLE_STATIC),)
+# It is done this way just in case the $(SO) == $(A)
+	mv -f $(OUTDIR)/$(LIB_ICUDATA_NAME).$(SO) $(OUTDIR)/$(LIB_ICUDATA_NAME)-temp.$(SO)
+	mv -f $(OUTDIR)/$(LIB_STATIC_ICUDATA_NAME).$(A) $(OUTDIR)/$(LIB_ICUDATA_NAME).$(A)
+	$(PKGDATA_INVOKE) $(PKGDATA) -m static -e $(ICUDATA_ENTRY_POINT) -T $(BUILDDIR) -p $(ICUDATA_NAME) $(BUILDDIR)/icudata.lst
+	mv -f $(OUTDIR)/$(LIB_ICUDATA_NAME).$(A) $(OUTDIR)/$(LIB_STATIC_ICUDATA_NAME).$(A)
+	mv -f $(OUTDIR)/$(LIB_ICUDATA_NAME)-temp.$(SO) $(OUTDIR)/$(LIB_ICUDATA_NAME).$(SO)
+	$(INSTALL-L) $(OUTDIR)/$(LIB_STATIC_ICUDATA_NAME).$(A) $(DESTDIR)$(ICUPKGDATA_DIR)/$(LIB_STATIC_ICUDATA_NAME).$(A)
+endif
+	$(PKGDATA_INVOKE) $(PKGDATA) -m $(PKGDATA_MODE) $(PKGDATA_VERSIONING) -e $(ICUDATA_ENTRY_POINT) -T $(BUILDDIR) -s $(BUILDDIR) -p $(ICUDATA_NAME) $(BUILDDIR)/icudata.lst -I $(DESTDIR)$(ICUPKGDATA_DIR)
 
-install-convrtrstxt: $(DESTDIR)$(pkgsysconfdir)/convrtrs.txt
-$(DESTDIR)$(pkgsysconfdir)/convrtrs.txt: $(UCMSRCDIR)/convrtrs.txt
-	$(MKINSTALLDIRS) $(DESTDIR)$(pkgsysconfdir)
-	$(INSTALL_DATA) $< $@
 
 ####
 ####
@@ -111,6 +145,9 @@
 install390: $(BUILDDIR)/icudata390.lst ./icupkg.inc
 	$(MKINSTALLDIRS) $(TMPDATADIR) $(DESTDIR)$(libdir)
 	$(INVOKE) $(PKGDATA) -s $(BUILDDIR) -T $(BUILDDIR)/tmp3901 -p $(ICUDATA_NAME)$(STUB_SUFFIX) -e $(ICUDATA_ENTRY_POINT) $(BUILDDIR)/icudata390.lst -m dll $(PKGDATA_VERSIONING) -I $(DESTDIR)$(ICUPKGDATA_DIR)
+ifeq ($(PKGDATA_MODE),dll)
+	$(INSTALL-L) $(OUTDIR)/$(LIB_ICUDATA_NAME)$(STUB_SUFFIX)$(SO_TARGET_VERSION)$(IMPORT_LIB_EXT) $(DESTDIR)$(ICUPKGDATA_DIR)/$(LIB_ICUDATA_NAME)$(STUB_SUFFIX)$(SO_TARGET_VERSION)$(IMPORT_LIB_EXT)
+endif
 
 #### $(LIB_ICUDATA_NAME)$(BATCH_SUFFIX) is the subset data for batch mode
 package390: $(BUILDDIR)/icudata390.lst $(BUILDDIR)/icudata.lst ./icupkg.inc
@@ -122,7 +159,7 @@
 ##### Define all the data files. the build rule that depends on them is below.
 
 ## DAT files - Misc. data files.
-DAT_FILES_SHORT=uprops.icu unames.icu unorm.icu cnvalias.icu tz.icu ucadata.icu invuca.icu 
+DAT_FILES_SHORT=uprops.icu pnames.icu unames.icu unorm.icu cnvalias.icu ucadata.icu invuca.icu uidna.spp 
 DAT_FILES=$(DAT_FILES_SHORT:%=$(BUILDDIR)/$(ICUDT)%)
 
 ## BRK files
@@ -136,25 +173,31 @@
 -include $(UCMSRCDIR)/ucmfiles.mk
 -include $(UCMSRCDIR)/ucmebcdic.mk
 -include $(UCMSRCDIR)/ucmlocal.mk
-ALL_UCM_SOURCE=ibm-37.ucm ibm-1047-s390.ucm $(UCM_SOURCE_CORE) $(UCM_SOURCE_FILES) $(UCM_SOURCE_EBCDIC) $(UCM_SOURCE_LOCAL)
+ALL_UCM_SOURCE=ibm-37_P100-1995.ucm ibm-1047_P100-1995.ucm $(UCM_SOURCE_CORE) $(UCM_SOURCE_FILES) $(UCM_SOURCE_EBCDIC) $(UCM_SOURCE_LOCAL)
 UCM_FILES = $(ALL_UCM_SOURCE:%=$(SRCDATADIR)/%)
 CNV_FILES = $(ALL_UCM_SOURCE:%.ucm=$(BUILDDIR)/$(ICUDT)%.cnv)
 
 ## RES files
-include $(LOCSRCDIR)/resfiles.mk
+-include $(LOCSRCDIR)/resfiles.mk
 -include $(LOCSRCDIR)/reslocal.mk
 RES_SOURCE= root.txt $(GENRB_SOURCE) $(GENRB_ALIAS_SOURCE) $(GENRB_SOURCE_LOCAL)
 RES_SRC_FILES = $(RES_SOURCE:%=$(LOCSRCDIR)/%)
-INSTALLED_RB_FILES = $(GENRB_SOURCE:%.txt=%,) $(GENRB_SOURCE_LOCAL:%.txt=%,)
-GENRBOPTS=-v
+INSTALLED_RB_FILES = $(GENRB_SOURCE:%.txt=%) $(GENRB_SOURCE_LOCAL:%.txt=%)
+GENRBOPTS=-k -q
 
 ## TRNS files
-include $(TRNSSRCDIR)/trnsfiles.mk
+-include $(TRNSSRCDIR)/trnsfiles.mk
 -include $(TRNSSRCDIR)/trnslocal.mk
 TRNS_SOURCE= $(TRANSLIT_SOURCE) $(TRANSLIT_SOURCE_LOCAL) 
 TRNS_SRC_FILES=$(TRNS_SOURCE:%=$(TRNSSRCDIR)/%)
 
-ALL_RES_SOURCE= $(RES_SOURCE) $(TRNS_SOURCE)
+## MISC files
+-include $(MISCSRCDIR)/miscfiles.mk
+-include $(MISCSRCDIR)/misclocal.mk
+MSC_SOURCE= $(MISC_SOURCE) $(MISC_SOURCE_LOCAL) 
+MSC_SRC_FILES=$(MSC_SOURCE:%=$(MISCSRCDIR)/%)
+
+ALL_RES_SOURCE= $(RES_SOURCE) $(TRNS_SOURCE) $(MSC_SOURCE)
 RES_FILES = $(ALL_RES_SOURCE:%.txt=$(BUILDDIR)/$(ICUDT)%.res)
 
 INDEX_FILES=$(BUILDDIR)/res_index.txt
@@ -176,7 +219,7 @@
 	  echo $$file >> $@; \
 	done;
 
-build-local: build-data build-testdata
+build-local: build-dir build-data build-testdata
 
 build-data: build-dir $(ALL_FILES) $(BUILDDIR)/icudata.lst $(OS390LIST)
 
@@ -190,28 +233,32 @@
 # DAT FILES
 
 # uprops.icu
-$(BUILDDIR)/$(ICUDT)uprops.icu: $(UNICODEDATADIR)/UnicodeData.txt $(UNICODEDATADIR)/BidiMirroring.txt $(TOOLDIR)/genprops/genprops$(EXEEXT)
-	ICU_DATA=$(BUILDDIR) $(INVOKE) $(TOOLDIR)/genprops/genprops -s $(UNICODEDATADIR) -d $(BUILDDIR) -u $(UNICODE_VERSION)
+$(BUILDDIR)/$(ICUDT)uprops.icu: $(UNICODEDATADIR)/UnicodeData.txt $(UNICODEDATADIR)/BidiMirroring.txt $(BINDIR)/genprops$(EXEEXT) $(BUILDDIR)/$(ICUDT)pnames.icu
+	$(INVOKE) $(BINDIR)/genprops -s $(UNICODEDATADIR) -i $(BUILDDIR) -d $(BUILDDIR) -u $(UNICODE_VERSION)
+
+# pnames.icu
+$(BUILDDIR)/$(ICUDT)pnames.icu: $(UNICODEDATADIR)/PropertyAliases.txt $(UNICODEDATADIR)/PropertyValueAliases.txt $(UNICODEDATADIR)/Blocks.txt $(COMINCDIR)/uscript.h $(COMINCDIR)/uchar.h $(BINDIR)/genpname$(EXEEXT)
+	$(INVOKE) $(BINDIR)/genpname -d $(BUILDDIR)
 
 # unorm.icu
-$(BUILDDIR)/$(ICUDT)unorm.icu: $(UNICODEDATADIR)/UnicodeData.txt $(UNICODEDATADIR)/DerivedNormalizationProps.txt $(UNICODEDATADIR)/BidiMirroring.txt $(TOOLDIR)/gennorm/gennorm$(EXEEXT)
-	ICU_DATA=$(BUILDDIR) $(INVOKE) $(TOOLDIR)/gennorm/gennorm -s $(UNICODEDATADIR) -d $(BUILDDIR) -u $(UNICODE_VERSION)
+$(BUILDDIR)/$(ICUDT)unorm.icu: $(UNICODEDATADIR)/UnicodeData.txt $(UNICODEDATADIR)/DerivedNormalizationProps.txt $(UNICODEDATADIR)/BidiMirroring.txt $(BINDIR)/gennorm$(EXEEXT) $(BUILDDIR)/$(ICUDT)uprops.icu
+	$(INVOKE) $(BINDIR)/gennorm -s $(UNICODEDATADIR) -d $(BUILDDIR) -u $(UNICODE_VERSION)
 
 # ucadata.icu
-$(BUILDDIR)/$(ICUDT)ucadata.icu: $(UNICODEDATADIR)/FractionalUCA.txt $(TOOLDIR)/genuca/genuca$(EXEEXT) $(BUILDDIR)/$(ICUDT)unorm.icu
-	$(INVOKE) $(TOOLDIR)/genuca/genuca -s $(UNICODEDATADIR) -d $(BUILDDIR) -i $(BUILDDIR) 
+$(BUILDDIR)/$(ICUDT)ucadata.icu $(BUILDDIR)/$(ICUDT)invuca.icu: $(UNICODEDATADIR)/FractionalUCA.txt $(BINDIR)/genuca$(EXEEXT) $(BUILDDIR)/$(ICUDT)unorm.icu
+	$(INVOKE) $(BINDIR)/genuca -s $(UNICODEDATADIR) -d $(BUILDDIR) -i $(BUILDDIR) 
 
 # unames.icu
-$(BUILDDIR)/$(ICUDT)unames.icu: $(UNICODEDATADIR)/UnicodeData.txt $(TOOLDIR)/gennames/gennames$(EXEEXT)
-	ICU_DATA=$(BUILDDIR) $(INVOKE) $(TOOLDIR)/gennames/gennames -1 -d $(BUILDDIR) $(UNICODEDATADIR)/UnicodeData.txt -u $(UNICODE_VERSION)
+$(BUILDDIR)/$(ICUDT)unames.icu: $(UNICODEDATADIR)/UnicodeData.txt $(BINDIR)/gennames$(EXEEXT)
+	$(INVOKE) $(BINDIR)/gennames -1 -d $(BUILDDIR) $(UNICODEDATADIR)/UnicodeData.txt -u $(UNICODE_VERSION)
 
 # cnvalias.icu
-$(BUILDDIR)/$(ICUDT)cnvalias.icu: $(UCMSRCDIR)/convrtrs.txt $(TOOLDIR)/gencnval/gencnval$(EXEEXT)
-	ICU_DATA=$(BUILDDIR) $(INVOKE) $(TOOLDIR)/gencnval/gencnval -d $(BUILDDIR) $(UCMSRCDIR)/convrtrs.txt
+$(BUILDDIR)/$(ICUDT)cnvalias.icu: $(UCMSRCDIR)/convrtrs.txt $(BINDIR)/gencnval$(EXEEXT)
+	$(INVOKE) $(BINDIR)/gencnval -d $(BUILDDIR) $(UCMSRCDIR)/convrtrs.txt
 
-# tz.icu
-$(BUILDDIR)/$(ICUDT)tz.icu: $(MISCSRCDIR)/timezone.txt $(TOOLDIR)/gentz/gentz$(EXEEXT)
-	ICU_DATA=$(BUILDDIR) $(INVOKE) $(TOOLDIR)/gentz/gentz -d $(BUILDDIR) $(MISCSRCDIR)/timezone.txt
+# uidna.spp
+$(BUILDDIR)/$(ICUDT)uidna.spp: $(MISCSRCDIR)/NamePrepProfile.txt $(BINDIR)/gensprep$(EXEEXT) $(BUILDDIR)/$(ICUDT)uprops.icu $(BUILDDIR)/$(ICUDT)unames.icu $(BUILDDIR)/$(ICUDT)pnames.icu
+	$(INVOKE) $(BINDIR)/gensprep -d $(BUILDDIR) -i $(BUILDDIR) -s $(MISCSRCDIR) -b uidna -n $(UNICODEDATADIR) -u 3.2.0 -k NamePrepProfile.txt
 
 ####################################################    BRK
 # BRK FILES
@@ -219,39 +266,45 @@
 thaidict.brk: $(SRCDATADIR)/thaidict.brk
 	$(RMV) $@ && ln -s $(BUILDDIR) $@
 
-$(BUILDDIR)/$(ICUDT)%.brk: $(BRKSRCDIR)/%.txt $(TOOLDIR)/genbrk/genbrk$(EXEEXT)
-	ICU_DATA=$(BUILDDIR) $(INVOKE) $(TOOLDIR)/genbrk/genbrk -r $< -o $@
+$(BUILDDIR)/$(ICUDT)%.brk: $(BRKSRCDIR)/%.txt $(BINDIR)/genbrk$(EXEEXT) $(DAT_FILES)
+	$(INVOKE) $(BINDIR)/genbrk -c -i $(BUILDDIR) -r $< -o $@
 
 ####################################################    CNV
 # CNV FILES
-$(BUILDDIR)/$(ICUDT)%.cnv: $(UCMSRCDIR)/%.ucm $(TOOLDIR)/makeconv/makeconv$(EXEEXT)
-	ICU_DATA=$(BUILDDIR) $(INVOKE) $(TOOLDIR)/makeconv/makeconv -p $(ICUDATA_PLATFORM_NAME) -c -d $(BUILDDIR) $(UCMSRCDIR)/$(<F)
+$(BUILDDIR)/$(ICUDT)%.cnv: $(UCMSRCDIR)/%.ucm $(BINDIR)/makeconv$(EXEEXT)
+	$(INVOKE) $(BINDIR)/makeconv -p $(ICUDATA_PLATFORM_NAME) -c -d $(BUILDDIR) $(UCMSRCDIR)/$(<F)
 
 ####################################################    RES
 # RES FILES
 
 all-RES:  $(RES_FILES)
 
-$(BUILDDIR)/$(ICUDT)%.res: $(LOCSRCDIR)/%.txt $(TOOLDIR)/genrb/genrb$(EXEEXT) $(BUILDDIR)/$(ICUDT)ucadata.icu $(BUILDDIR)/$(ICUDT)uprops.icu $(BUILDDIR)/$(ICUDT)unorm.icu
-	ICU_DATA=$(BUILDDIR) $(INVOKE) $(TOOLDIR)/genrb/genrb $(GENRBOPTS) -p $(ICUDATA_PLATFORM_NAME) -q -s $(LOCSRCDIR) -d $(BUILDDIR) $(<F)
+$(BUILDDIR)/$(ICUDT)%.res: $(LOCSRCDIR)/%.txt $(BINDIR)/genrb$(EXEEXT) $(DAT_FILES)
+	$(INVOKE) $(BINDIR)/genrb $(GENRBOPTS) -p $(ICUDATA_PLATFORM_NAME) -i $(BUILDDIR) -s $(LOCSRCDIR) -d $(BUILDDIR) $(<F)
+
+$(BUILDDIR)/$(ICUDT)%.res: $(TRNSSRCDIR)/%.txt $(BINDIR)/genrb$(EXEEXT) $(DAT_FILES)
+	$(INVOKE) $(BINDIR)/genrb $(GENRBOPTS) -p $(ICUDATA_PLATFORM_NAME) -i $(BUILDDIR) -s $(TRNSSRCDIR) -d $(BUILDDIR) $(<F)
 
-$(BUILDDIR)/$(ICUDT)%.res: $(TRNSSRCDIR)/%.txt $(TOOLDIR)/genrb/genrb$(EXEEXT) 
-	ICU_DATA=$(BUILDDIR) $(INVOKE) $(TOOLDIR)/genrb/genrb $(GENRBOPTS) -p $(ICUDATA_PLATFORM_NAME) -q -s $(TRNSSRCDIR) -d $(BUILDDIR) $(<F)
+$(BUILDDIR)/$(ICUDT)%.res: $(MISCSRCDIR)/%.txt $(BINDIR)/genrb$(EXEEXT)
+	$(INVOKE) $(BINDIR)/genrb $(GENRBOPTS) -p $(ICUDATA_PLATFORM_NAME) -i $(BUILDDIR) -s $(MISCSRCDIR) -d $(BUILDDIR) $(<F)
 
 $(BUILDDIR)/res_index.txt: $(SRCLISTDEPS)
 	@echo "generating $@ (list of installed locales)"; \
 	$(RMV) $@; \
 	echo "// Warning this file is automatically generated" > $@; \
 	echo "res_index {" >> $@; \
-	echo "    InstalledLocales:array {" >> $@; \
+	echo "    InstalledLocales {" >> $@; \
 	for file in $(INSTALLED_RB_FILES); do \
-	  echo "        $$file" >> $@; \
+	  echo "        $$file {\"\"}" >> $@; \
 	done; \
 	echo "    }" >> $@; \
 	echo "}" >> $@;
 
-$(BUILDDIR)/$(ICUDT)%.res: $(INDEX_FILES) $(TOOLDIR)/genrb/genrb$(EXEEXT)
-	ICU_DATA=$(BUILDDIR) $(INVOKE) $(TOOLDIR)/genrb/genrb $(GENRBOPTS) -p $(ICUDATA_PLATFORM_NAME) -d $(BUILDDIR) $(INDEX_FILES)
+clean-resindex:
+	-$(RMV) $(BUILDDIR)/res_index.txt $(BUILDDIR)/icudata.lst
+
+$(BUILDDIR)/$(ICUDT)%.res: $(INDEX_FILES) $(BINDIR)/genrb$(EXEEXT)
+	$(INVOKE) $(BINDIR)/genrb $(GENRBOPTS) -p $(ICUDATA_PLATFORM_NAME) -i $(BUILDDIR) -d $(BUILDDIR) $(INDEX_FILES)
 
 ###################################################################
 Makefile: $(srcdir)/Makefile.in  $(top_builddir)/config.status
@@ -264,8 +317,8 @@
 
 ###########
 ########### 390 (z/OS) support
-UCMFILES390=ebcdic-xml-us.ucm ibm-37-s390.ucm ibm-1047-s390.ucm ibm-4909.ucm
-ALLFILES390=uprops.icu unorm.icu cnvalias.icu $(UCMFILES390:.ucm=.cnv)
+UCMFILES390=ebcdic-xml-us.ucm ibm-37_P100-1995.ucm ibm-1047_P100-1995.ucm ibm-4909_P100-1999.ucm
+ALLFILES390=uprops.icu pnames.icu unorm.icu cnvalias.icu $(UCMFILES390:.ucm=.cnv)
 
 $(BUILDDIR)/icudata390.lst:  $(SRCLISTDEPS)
 	@echo "generating $@ (list of 390 data files)"
@@ -292,14 +345,14 @@
 TESTDT=$(TESTDATA)_
 
 # File definitions 
-TEST_DAT_FILES=$(TESTBUILDDIR)/$(TESTDT)test.icu
+TEST_DAT_FILES=$(TESTBUILDDIR)/$(TESTDT)test.icu $(TESTBUILDDIR)/$(TESTDT)nfscsi.spp $(TESTBUILDDIR)/$(TESTDT)nfscss.spp $(TESTBUILDDIR)/$(TESTDT)nfscis.spp $(TESTBUILDDIR)/$(TESTDT)nfsmxs.spp $(TESTBUILDDIR)/$(TESTDT)nfsmxp.spp
 
-TEST_UCM_SOURCE= test1.ucm test3.ucm test4.ucm
+TEST_UCM_SOURCE= test1.ucm test3.ucm test4.ucm test4x.ucm ibm9027.ucm
 TEST_UCM_FILES=$(TEST_UCM_SOURCE:%=$(TESTSRCDATADIR)/data/%)
 TEST_CNV_FILES=$(TEST_UCM_SOURCE:%.ucm=$(TESTBUILDDIR)/$(TESTDT)%.cnv)
 
-TEST_RES = casing.txt root.txt te.txt te_IN.txt testtypes.txt testaliases.txt testempty.txt DataDrivenCollationTest.txt
-TEST_RES_FILES=$(TEST_RES:%.txt=$(TESTBUILDDIR)/$(TESTDT)%.res)
+TEST_RES = casing.txt mc.txt root.txt te.txt te_IN.txt testtypes.txt testaliases.txt testempty.txt DataDrivenCollationTest.txt idna_rules.txt conversion.txt testtable32.txt
+TEST_RES_FILES=$(TEST_RES:%.txt=$(TESTBUILDDIR)/$(TESTDT)%.res) $(TESTBUILDDIR)/$(TESTDT)iscii.res $(TESTSRCDATADIR)/$(TESTDT)icu26_testtypes.res $(TESTSRCDATADIR)/$(TESTDT)icu26e_testtypes.res
 
 ALL_TEST_FILES = $(TEST_DAT_FILES) $(TEST_BRK_FILES) $(TEST_CNV_FILES) $(TEST_RES_FILES) $(TESTOUTDIR)/$(TESTDT)nam.typ
 
@@ -313,21 +366,53 @@
 	done;
 
 
-build-testdata:  $(ALL_TEST_FILES) $(TESTBUILDDIR)/testdata.lst $(TESTBUILDDIR)/$(TESTDT)ja_data.res
+build-testdata:  $(ALL_TEST_FILES) $(TESTBUILDDIR)/testdata.lst $(TESTBUILDDIR)/$(TESTDT)iscii.res
 
 # test.icu
 $(TESTBUILDDIR)/$(TESTDT)test.icu: $(TOOLDIR)/gentest/gentest$(EXEEXT)
-	ICU_DATA=$(BUILDDIR) $(INVOKE) $(TOOLDIR)/gentest/gentest -d $(TESTBUILDDIR) 
-
-$(TESTBUILDDIR)/$(TESTDT)%.cnv: $(TESTSRCDATADIR)/%.ucm $(TOOLDIR)/makeconv/makeconv$(EXEEXT)
-	ICU_DATA=$(BUILDDIR) $(INVOKE) $(TOOLDIR)/makeconv/makeconv -p $(TESTDATA) -c -d $(TESTBUILDDIR) $(TESTSRCDATADIR)/$(<F)
+	$(INVOKE) $(TOOLDIR)/gentest/gentest -d $(TESTBUILDDIR) 
 
-$(TESTBUILDDIR)/$(TESTDT)%.res: $(TESTSRCDATADIR)/%.txt $(TOOLDIR)/genrb/genrb$(EXEEXT)
-	ICU_DATA=$(BUILDDIR) $(INVOKE) $(TOOLDIR)/genrb/genrb $(GENRBOPTS) -p $(TESTDATA) -q -s $(TESTSRCDATADIR) -d $(TESTBUILDDIR) $(<F)
+$(TESTBUILDDIR)/testtable32.txt:  $(TOOLDIR)/gentest/gentest$(EXEEXT)
+	$(INVOKE) $(TOOLDIR)/gentest/gentest -r -d $(TESTBUILDDIR) 
 
+$(TESTBUILDDIR)/$(TESTDT)testtable32.res: $(TESTBUILDDIR)/testtable32.txt $(BINDIR)/genrb$(EXEEXT)
+	$(INVOKE) $(BINDIR)/genrb $(GENRBOPTS) -p $(TESTDATA) -q -s $(TESTBUILDDIR) -i $(BUILDDIR) -d $(TESTBUILDDIR) $(<F)
 
-$(TESTBUILDDIR)/$(TESTDT)ja_data.res:  $(TESTSRCDATADIR)/ja_data.bin $(TOOLDIR)/genrb/genrb$(EXEEXT)
-	ICU_DATA=$(BUILDDIR) $(INVOKE) $(TOOLDIR)/genrb/genrb $(GENRBOPTS) -q -s $(TESTSRCDATADIR) -p $(TESTDATA) -eISO_2022_JP -d $(TESTBUILDDIR) $(<F) >/dev/null  
+# Targets for nfscsi.spp
+$(TESTBUILDDIR)/$(TESTDT)nfscsi.spp: $(BINDIR)/gensprep$(EXEEXT) $(TESTSRCDATADIR)/nfs4_cs_prep_ci.txt
+	@echo Building nfscsi.icu
+	$(INVOKE) $(BINDIR)/gensprep -s $(TESTSRCDATADIR) -i $(BUILDDIR) -d $(TESTBUILDDIR) -b nfscsi -p $(TESTDATA) -u 3.2.0 nfs4_cs_prep_ci.txt
+
+# Targets for nfscss.spp
+$(TESTBUILDDIR)/$(TESTDT)nfscss.spp: $(BINDIR)/gensprep$(EXEEXT) $(TESTSRCDATADIR)/nfs4_cs_prep_cs.txt
+	@echo Building nfscss.icu
+	$(INVOKE) $(BINDIR)/gensprep -s $(TESTSRCDATADIR) -i $(BUILDDIR) -d $(TESTBUILDDIR) -b nfscss -p $(TESTDATA) -u 3.2.0 nfs4_cs_prep_cs.txt
+
+# Targets for nfscis.spp
+$(TESTBUILDDIR)/$(TESTDT)nfscis.spp: $(BINDIR)/gensprep$(EXEEXT) $(TESTSRCDATADIR)/nfs4_cis_prep.txt
+	@echo Building nfscis.spp
+	$(INVOKE) $(BINDIR)/gensprep -s $(TESTSRCDATADIR) -i $(BUILDDIR) -d $(TESTBUILDDIR) -b nfscis -p $(TESTDATA) -k -n $(UNICODEDATADIR) -u 3.2.0 nfs4_cis_prep.txt
+
+# Targets for nfsmxs.spp
+$(TESTBUILDDIR)/$(TESTDT)nfsmxs.spp: $(BINDIR)/gensprep$(EXEEXT) $(TESTSRCDATADIR)/nfs4_mixed_prep_s.txt
+	@echo Building nfsmxs.spp
+	$(INVOKE) $(BINDIR)/gensprep -s $(TESTSRCDATADIR) -i $(BUILDDIR) -d $(TESTBUILDDIR) -b nfsmxs -p $(TESTDATA) -k -n $(UNICODEDATADIR) -u 3.2.0 nfs4_mixed_prep_s.txt
+
+# Targets for nfsmxp.spp
+$(TESTBUILDDIR)/$(TESTDT)nfsmxp.spp: $(BINDIR)/gensprep$(EXEEXT) $(TESTSRCDATADIR)/nfs4_mixed_prep_p.txt
+	@echo Building nfsmxp.spp
+	$(INVOKE) $(BINDIR)/gensprep -s $(TESTSRCDATADIR) -i $(BUILDDIR) -d $(TESTBUILDDIR) -b nfsmxp -p $(TESTDATA) -k -n $(UNICODEDATADIR) -u 3.2.0 nfs4_mixed_prep_p.txt
+
+$(TESTBUILDDIR)/$(TESTDT)%.cnv: $(TESTSRCDATADIR)/%.ucm $(BINDIR)/makeconv$(EXEEXT)
+	$(INVOKE) $(BINDIR)/makeconv -p $(TESTDATA) -c -d $(TESTBUILDDIR) $(TESTSRCDATADIR)/$(<F)
+
+$(TESTBUILDDIR)/$(TESTDT)%.res: $(TESTSRCDATADIR)/%.txt $(BINDIR)/genrb$(EXEEXT) $(DAT_FILES)
+	$(INVOKE) $(BINDIR)/genrb $(GENRBOPTS) -p $(TESTDATA) -q -s $(TESTSRCDATADIR) -i $(BUILDDIR) -d $(TESTBUILDDIR) $(<F)
+
+$(TESTBUILDDIR)/$(TESTDT)iscii.res:  $(TESTSRCDATADIR)/iscii.bin $(BINDIR)/genrb$(EXEEXT)
+	@echo Testing genrb -e option
+	@ICU_DATA=$(BUILDDIR) $(INVOKE) $(BINDIR)/genrb $(GENRBOPTS) -s $(TESTSRCDATADIR) -p $(TESTDATA) -eISCII,version=0 -d $(TESTBUILDDIR) $(<F) >/dev/null  || ( echo "WARNING: could not open ISCII - it may have been disabled." | tee $@ )
+	@echo Finished testing genrb -e option
 
 ################################################################### TYP
 # TYP FILES
@@ -336,9 +421,9 @@
 	cp $< $@
 
 
-testdata: $(ALL_TEST_FILES) $(UNPACKAGEDTESTDATA)
+testdata: packagedata $(ALL_TEST_FILES) $(UNPACKAGEDTESTDATA)
 
 packagetest: testdata icupkg.inc $(TESTBUILDDIR)/testdata.lst 
-	$(INVOKE) $(PKGDATA) -T $(TESTBUILDDIR) -d $(TESTOUTDIR) -s $(TESTBUILDDIR) -p $(TESTDATA) -m common $(TESTBUILDDIR)/testdata.lst
+	$(PKGDATA_INVOKE) $(PKGDATA) -T $(TESTBUILDDIR) -d $(TESTOUTDIR) -s $(TESTBUILDDIR) -p $(TESTDATA) -m common $(TESTBUILDDIR)/testdata.lst
 
 








--- misc/build/icu/source/i18n/Makefile.in	2002-08-14 01:38:40.000000000 +0100
+++ misc/build/icu/source/i18n/Makefile.in	2004-04-05 20:05:12.000000000 +0100
@@ -1,6 +1,6 @@
 #******************************************************************************
 #
-#   Copyright (C) 1998-2001, International Business Machines
+#   Copyright (C) 1998-2004, International Business Machines
 #   Corporation and others.  All Rights Reserved.
 #
 #******************************************************************************
@@ -15,6 +15,7 @@
 
 ## All the flags and other definitions are included here.
 include $(top_builddir)/icudefs.mk
+-include Makefile.local
 
 ## Build directory information
 subdir = i18n
@@ -24,14 +25,20 @@
 
 ## Target information
 
+TARGET_STUBNAME=i18n
+
 ifneq ($(ENABLE_STATIC),)
-TARGET = $(LIBICU)i18n$(ICULIBSUFFIX).a
+TARGET = $(LIBDIR)/$(LIBSICU)$(TARGET_STUBNAME)$(ICULIBSUFFIX).$(A)
 endif
 
 ifneq ($(ENABLE_SHARED),)
-SO_TARGET = $(LIBICU)i18n$(ICULIBSUFFIX).$(SO)
+SO_TARGET = $(LIBDIR)/$(LIBICU)$(TARGET_STUBNAME)$(ICULIBSUFFIX).$(SO)
 ALL_SO_TARGETS = $(SO_TARGET) $(MIDDLE_SO_TARGET) $(FINAL_SO_TARGET)
 
+ifeq ($(ENABLE_SO_VERSION_DATA),1)
+SO_VERSION_DATA = i18n.res
+endif
+
 ifeq ($(OS390BATCH),1)
 BATCH_TARGET = $(BATCH_I18N_TARGET)
 BATCH_LIBS = $(BATCH_LIBICUUC) -lm
@@ -95,13 +104,22 @@
 install-library: all-local
 	$(MKINSTALLDIRS) $(DESTDIR)$(libdir)
 ifneq ($(ENABLE_STATIC),)
-	$(INSTALL-L) $(TARGET) $(DESTDIR)$(libdir)/$(TARGET)
+	$(INSTALL-L) $(TARGET) $(DESTDIR)$(libdir)
 endif
 ifneq ($(ENABLE_SHARED),)
-	$(INSTALL-L) $(FINAL_SO_TARGET) $(DESTDIR)$(libdir)/$(FINAL_SO_TARGET)
+	$(INSTALL-L) $(FINAL_SO_TARGET) $(DESTDIR)$(libdir)
 ifneq ($(FINAL_SO_TARGET),$(SO_TARGET))
-	cd $(DESTDIR)$(libdir) && $(RM) $(MIDDLE_SO_TARGET) && ln -s $(FINAL_SO_TARGET) $(MIDDLE_SO_TARGET)
-	cd $(DESTDIR)$(libdir) && $(RM) $(SO_TARGET) && ln -s $(FINAL_SO_TARGET) $(SO_TARGET)
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(SO_TARGET)) && ln -s $(notdir $(FINAL_SO_TARGET)) $(notdir $(SO_TARGET))
+ifneq ($(FINAL_SO_TARGET),$(MIDDLE_SO_TARGET))
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(MIDDLE_SO_TARGET)) && ln -s $(notdir $(FINAL_SO_TARGET)) $(notdir $(MIDDLE_SO_TARGET))
+endif
+endif
+endif
+ifneq ($(IMPORT_LIB_EXT),)
+	$(INSTALL-L) $(FINAL_IMPORT_LIB) $(DESTDIR)$(libdir)
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(IMPORT_LIB)) && ln -s $(notdir $(FINAL_IMPORT_LIB)) $(notdir $(IMPORT_LIB))
+ifneq ($(MIDDLE_IMPORT_LIB),$(FINAL_IMPORT_LIB))
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(MIDDLE_IMPORT_LIB)) && ln -s $(notdir $(FINAL_IMPORT_LIB)) $(notdir $(MIDDLE_IMPORT_LIB))
 endif
 endif
 
@@ -116,7 +134,7 @@
 
 clean-local:
 	test -z "$(CLEANFILES)" || $(RMV) $(CLEANFILES)
-	$(RMV) $(OBJECTS) $(STATIC_OBJECTS) $(ALL_TARGETS)
+	$(RMV) $(OBJECTS) $(STATIC_OBJECTS) $(ALL_TARGETS) $(SO_VERSION_DATA)
 
 distclean-local: clean-local
 	$(RMV) Makefile
@@ -133,12 +151,12 @@
 endif
 
 ifneq ($(ENABLE_SHARED),)
-$(FINAL_SO_TARGET): $(OBJECTS)
-	$(SHLIB.cc) $(LD_SONAME) -o $@ $^ $(LIBS)
+$(FINAL_SO_TARGET): $(OBJECTS) $(SO_VERSION_DATA)
+	$(SHLIB.cc) $(LD_SONAME) $(OUTOPT)$@ $^ $(LIBS)
 
 ifeq ($(OS390BATCH),1)
 $(BATCH_TARGET):$(OBJECTS)
-	$(SHLIB.cc) $(LD_SONAME) -o $@ $^ $(BATCH_LIBS)
+	$(SHLIB.cc) $(LD_SONAME) $(OUTOPT)$@ $^ $(BATCH_LIBS)
 endif # OS390BATCH
 endif
 



--- misc/build/icu/source/extra/uconv/Makefile.in	2002-07-31 21:28:30.000000000 +0100
+++ misc/build/icu/source/extra/uconv/Makefile.in	2004-04-05 20:05:09.000000000 +0100
@@ -1,6 +1,6 @@
 ## ******************************************************************************
 ## *
-## *   Copyright (C) 1999-2000, International Business Machines
+## *   Copyright (C) 1999-2004, International Business Machines
 ## *   Corporation and others.  All Rights Reserved.
 ## *
 ## *******************************************************************************
@@ -30,19 +30,25 @@
 
 ##
 
+TARGET_STUB_NAME = uconv
+
 SECTION = 1
 
-ALL_MAN_FILES = $(TARGET).$(SECTION)
+ALL_MAN_FILES = $(TARGET_STUB_NAME).$(SECTION)
 
 ## Extra files to remove for 'make clean'
 CLEANFILES = *~ $(DEPS) $(ALL_MAN_FILES)
 
 ## Target information
-TARGET = uconv
+TARGET = $(BINDIR)/$(TARGET_STUB_NAME)$(EXEEXT)
 
 CPPFLAGS += -I$(top_builddir)/common -I$(top_srcdir)/common -I$(top_srcdir)/i18n -I$(srcdir)/../toolutil
 LIBS = $(LIBICUI18N) $(LIBICUUC) $(DEFAULT_LIBS) $(LIB_M)
 
+ifeq ($(PKGDATA_OPTS),)
+PKGDATA_OPTS = -O pkgdata.inc
+endif
+
 ## generic settings for data - common.
 PKGMODE=common
 INSTALLTO=$(DESTDIR)$(ICUDATA_DIR)
@@ -51,7 +57,7 @@
 ## Static mode
 ifeq ($(UCONVMSG_MODE),static)
 DEFS += -DUCONVMSG_LINK=$(MSGNAME)
-UCONVMSG_LIB = $(RESDIR)/lib$(MSGNAME).a
+UCONVMSG_LIB = $(RESDIR)/lib$(MSGNAME).$(A)
 LIBS += $(UCONVMSG_LIB)
 PKGMODE=static
 INSTALLTO=$(libdir)
@@ -91,7 +97,7 @@
 
 install-target: all-local
 	$(MKINSTALLDIRS) $(DESTDIR)$(bindir)
-	$(INSTALL) $(TARGET) $(DESTDIR)$(bindir)/$(TARGET)
+	$(INSTALL) $(TARGET) $(DESTDIR)$(bindir)
 
 dist-local:
 
@@ -100,7 +106,7 @@
 	$(RMV) $(OBJECTS) $(TARGET)
 
 resclean:
-	-$(INVOKE) $(top_builddir)/tools/pkgdata/pkgdata --clean -p $(RESDIR) -O pkgdata.inc -m $(PKGMODE) -d $(RESDIR) -T $(RESDIR) $(RESDIR)/$(RESDIR).lst
+	#-$(INVOKE) $(BINDIR)/pkgdata --clean -p $(RESDIR) -O pkgdata.inc -m $(PKGMODE) -d $(RESDIR) -T $(RESDIR) $(RESDIR)/$(RESDIR).lst
 	$(RMV) pkgdata.inc $(RESDIR)
 
 distclean-local: clean-local
@@ -116,8 +122,12 @@
 	cd $(top_builddir) \
 	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
+%.$(SECTION): $(srcdir)/%.$(SECTION).in $(srcdir)/pkgdata.inc.in
+	cd $(top_builddir) \
+	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
+
 $(TARGET) : $(OBJECTS)  $(UCONVMSG_LIB)
-	$(LINK.cc) -o $@ $(OBJECTS) $(LIBS) $(LDFLAGS)
+	$(LINK.cc) $(OUTOPT)$@ $(OBJECTS) $(LIBS)
 
 resfiles: $(RESFILES) package-resfiles
 
@@ -127,20 +137,20 @@
 
 
 package-resfiles: $(RESDIR)/$(RESDIR).lst pkgdata.inc
-	$(INVOKE) $(top_builddir)/tools/pkgdata/pkgdata -p $(RESDIR) -O pkgdata.inc -m $(PKGMODE) -d $(RESDIR) -T $(RESDIR) $(RESDIR)/$(RESDIR).lst
+	$(INVOKE) $(PKGDATA_INVOKE_OPTS) $(BINDIR)/pkgdata -p $(RESDIR) $(PKGDATA_OPTS) -m $(PKGMODE) -d $(RESDIR) -T $(RESDIR) $(RESDIR)/$(RESDIR).lst
 
 $(RESDIR)/$(RESDIR).lst: Makefile pkgdata.inc $(srcdir)/resfiles.mk
 	@$(MKINSTALLDIRS) $(RESDIR)
 	@-$(RMV) $@
 	@for file in $(RESFILES); do \
-	  echo `pwd`/$$file >> $@; \
+	  echo $(CURR_FULL_DIR)/$$file >> $@; \
 	done;
 
 # no install for static mode
 ifneq ($(UCONVMSG_MODE),static)
 install-resfiles: $(RESFILES)
 	$(MKINSTALLDIRS) $(DESTDIR)$(ICUDATA_DIR)
-	$(INVOKE) $(top_builddir)/tools/pkgdata/pkgdata -p $(RESDIR) -O pkgdata.inc -m $(PKGMODE) -d $(RESDIR) -I $(INSTALLTO) -T $(RESDIR) $(RESDIR)/$(RESDIR).lst
+	$(INVOKE) $(BINDIR)/pkgdata -p $(RESDIR) -O pkgdata.inc -m $(PKGMODE) -d $(RESDIR) -I $(INSTALLTO) -T $(RESDIR) $(RESDIR)/$(RESDIR).lst
 endif
 
 ##
@@ -148,19 +158,12 @@
 
 $(RESDIR)/$(RESOURCESDIR)/$(MSGNAME)_%.res: $(srcdir)/$(RESOURCESDIR)/%.txt
 	$(MKINSTALLDIRS) $(@D)
-	$(INVOKE) $(top_builddir)/tools/genrb/genrb -p $(MSGNAME) -e UTF-8 -s $(^D) -d $(@D) $(^F)
+	$(INVOKE) $(BINDIR)/genrb -p $(MSGNAME) -e UTF-8 -s $(^D) -d $(@D) $(^F)
 
 install-man: $(ALL_MAN_FILES)
 	$(MKINSTALLDIRS) $(DESTDIR)$(mandir)/man$(SECTION)
 	$(INSTALL_DATA) $? $(DESTDIR)$(mandir)/man$(SECTION)
 
-%.$(SECTION): $(srcdir)/%.$(SECTION).in
-	cd $(top_builddir) \
-	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
-# Don't do this.  This is a problem when changing platforms.
-#ifneq ($(MAKECMDGOALS),distclean)
-#-include $(DEPS)
-#endif
 
--- misc/build/icu/source/extra/Makefile.in	2002-04-19 03:19:16.000000000 +0100
+++ misc/build/icu/source/extra/Makefile.in	2004-04-05 20:05:09.000000000 +0100
@@ -1,6 +1,6 @@
 #******************************************************************************
 #
-#   Copyright (C) 1999, International Business Machines
+#   Copyright (C) 1999-2004, International Business Machines
 #   Corporation and others.  All Rights Reserved.
 #
 #******************************************************************************
@@ -15,8 +15,7 @@
 
 include $(top_builddir)/icudefs.mk
 
-@USTDIO_TRUE@USTDIO = ustdio
-@USTDIO_FALSE@USTDIO =
+@ICUIO_TRUE@ICUIO = ustdio
 
 ## Build directory information
 subdir = extra
@@ -24,8 +23,8 @@
 ## Files to remove for 'make clean'
 CLEANFILES = *~
 
-SUBDIRS = $(USTDIO) uconv
+SUBDIRS = $(ICUIO) uconv
 
 ## List of phony targets
 .PHONY : all all-local all-recursive install install-local		\
--- misc/build/icu/source/extra/ustdio/Makefile.in	2002-08-14 01:38:40.000000000 +0100
+++ misc/build/icu/source/extra/ustdio/Makefile.in	2004-04-05 20:05:10.000000000 +0100
@@ -1,6 +1,6 @@
 #******************************************************************************
 #
-#   Copyright (C) 1999-2001, International Business Machines
+#   Copyright (C) 1999-2004, International Business Machines
 #   Corporation and others.  All Rights Reserved.
 #
 #******************************************************************************
@@ -24,16 +24,22 @@
 
 ## Target information
 
+TARGET_STUBNAME=io
+
 ifneq ($(ENABLE_STATIC),)
-TARGET = libustdio$(ICULIBSUFFIX).a
+TARGET = $(LIBDIR)/$(LIBSICU)$(TARGET_STUBNAME)$(ICULIBSUFFIX).$(A)
 endif
 
 ifneq ($(ENABLE_SHARED),)
-SO_TARGET = libustdio$(ICULIBSUFFIX).$(SO)
+SO_TARGET = $(LIBDIR)/$(LIBICU)$(TARGET_STUBNAME)$(ICULIBSUFFIX).$(SO)
 ALL_SO_TARGETS = $(SO_TARGET) $(MIDDLE_SO_TARGET) $(FINAL_SO_TARGET)
 
+ifeq ($(ENABLE_SO_VERSION_DATA),1)
+SO_VERSION_DATA = ustdio.res
+endif
+
 ifeq ($(OS390BATCH),1)
-BATCH_TARGET = $(BATCH_USTDIO_TARGET)
+BATCH_TARGET = $(BATCH_ICUIO_TARGET)
 BATCH_LIBS = $(BATCH_LIBICUUC) $(BATCH_LIBICUI18N) -lm
 endif   # OS390BATCH
 
@@ -81,13 +87,22 @@
 install-library: all-local
 	$(MKINSTALLDIRS) $(DESTDIR)$(libdir)
 ifneq ($(ENABLE_STATIC),)
-	$(INSTALL-L) $(TARGET) $(DESTDIR)$(libdir)/$(TARGET)
+	$(INSTALL-L) $(TARGET) $(DESTDIR)$(libdir)
 endif
 ifneq ($(ENABLE_SHARED),)
-	$(INSTALL-L) $(FINAL_SO_TARGET) $(DESTDIR)$(libdir)/$(FINAL_SO_TARGET)
+	$(INSTALL-L) $(FINAL_SO_TARGET) $(DESTDIR)$(libdir)
 ifneq ($(FINAL_SO_TARGET),$(SO_TARGET))
-	cd $(DESTDIR)$(libdir) && $(RM) $(MIDDLE_SO_TARGET) && ln -s $(FINAL_SO_TARGET) $(MIDDLE_SO_TARGET)
-	cd $(DESTDIR)$(libdir) && $(RM) $(SO_TARGET) && ln -s $(FINAL_SO_TARGET) $(SO_TARGET)
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(SO_TARGET)) && ln -s $(notdir $(FINAL_SO_TARGET)) $(notdir $(SO_TARGET))
+ifneq ($(FINAL_SO_TARGET),$(MIDDLE_SO_TARGET))
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(MIDDLE_SO_TARGET)) && ln -s $(notdir $(FINAL_SO_TARGET)) $(notdir $(MIDDLE_SO_TARGET))
+endif
+endif
+endif
+ifneq ($(IMPORT_LIB_EXT),)
+	$(INSTALL-L) $(FINAL_IMPORT_LIB) $(DESTDIR)$(libdir)
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(IMPORT_LIB)) && ln -s $(notdir $(FINAL_IMPORT_LIB)) $(notdir $(IMPORT_LIB))
+ifneq ($(MIDDLE_IMPORT_LIB),$(FINAL_IMPORT_LIB))
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(MIDDLE_IMPORT_LIB)) && ln -s $(notdir $(FINAL_IMPORT_LIB)) $(notdir $(MIDDLE_IMPORT_LIB))
 endif
 endif
 
@@ -103,7 +118,7 @@
 
 clean-local:
 	test -z "$(CLEANFILES)" || $(RMV) $(CLEANFILES)
-	$(RMV) $(OBJECTS) $(STATIC_OBJECTS) $(ALL_TARGETS)
+	$(RMV) $(OBJECTS) $(STATIC_OBJECTS) $(ALL_TARGETS) $(SO_VERSION_DATA)
 
 distclean-local: clean-local
 	$(RMV) Makefile
@@ -120,13 +135,13 @@
 endif
 
 ifneq ($(ENABLE_SHARED),)
-$(FINAL_SO_TARGET): $(OBJECTS)
-	$(SHLIB.cc) $(LD_SONAME) -o $@ $^ $(LIBS)
+$(FINAL_SO_TARGET): $(OBJECTS) $(SO_VERSION_DATA)
+	$(SHLIB.cc) $(LD_SONAME) $(OUTOPT)$@ $^ $(LIBS)
 
 ifeq ($(OS390BATCH),1)
 $(BATCH_TARGET): $(OBJECTS)
-	$(SHLIB.cc) $(LD_SONAME) -o $@ $^ $(BATCH_LIBS)
+	$(SHLIB.cc) $(LD_SONAME) $(OUTOPT)$@ $^ $(BATCH_LIBS)
 endif # OS390BATCH
 
 endif
--- misc/build/icu/source/tools/ctestfw/Makefile.in	2002-07-19 22:45:32.000000000 +0100
+++ misc/build/icu/source/tools/ctestfw/Makefile.in	2004-04-05 20:05:40.000000000 +0100
@@ -1,5 +1,5 @@
 ## Makefile.in for ICU - tools/ctestfw
-## Copyright (c) 1999-2000, International Business Machines Corporation and
+## Copyright (c) 1999-2004, International Business Machines Corporation and
 ## others. All Rights Reserved.
 ## Stephen F. Booth
 
@@ -20,10 +20,10 @@
 ## Target information
 
 ifneq ($(ENABLE_STATIC),)
-TARGET = $(LIBICU)ctestfw$(ICULIBSUFFIX).a
+TARGET = $(LIBSICU)ctestfw$(ICULIBSUFFIX).a
 endif
 
-CPPFLAGS += -I$(top_builddir)/common -I$(top_srcdir)/common -I$(top_srcdir)/i18n -I$(srcdir)/../toolutil
+CPPFLAGS += -I$(top_builddir)/common -I$(top_srcdir)/common -I$(top_srcdir)/i18n -I$(srcdir)
 DEFS += -DT_CTEST_IMPLEMENTATION
 
 
@@ -38,9 +38,9 @@
 DYNAMICCFLAGS = $(SHAREDLIBCFLAGS)
 DYNAMICCXXFLAGS = $(SHAREDLIBCXXFLAGS)
 
-LIBS = $(DEFAULT_LIBS)
+LIBS = $(LIBICUUC) $(DEFAULT_LIBS)
 
 OBJECTS = ctest.o
 
 STATIC_OBJECTS = $(OBJECTS:.o=.$(STATIC_O))
 
@@ -66,17 +66,18 @@
 install-local: install-library
 
 install-library: all-local
-	$(MKINSTALLDIRS) $(DESTDIR)$(libdir)
-ifneq ($(ENABLE_STATIC),)
-	$(INSTALL-L) $(TARGET) $(DESTDIR)$(libdir)/$(TARGET)
-endif
-ifneq ($(ENABLE_SHARED),)
-	$(INSTALL-L) $(FINAL_SO_TARGET) $(DESTDIR)$(libdir)/$(FINAL_SO_TARGET)
-ifneq ($(FINAL_SO_TARGET),$(SO_TARGET))
-	cd $(DESTDIR)$(libdir) && $(RM) $(MIDDLE_SO_TARGET) && ln -s $(FINAL_SO_TARGET) $(MIDDLE_SO_TARGET)
-	cd $(DESTDIR)$(libdir) && $(RM) $(SO_TARGET) && ln -s $(FINAL_SO_TARGET) $(SO_TARGET)
-endif
-endif
+#echo This doesn't need to be installed normally
+#	$(MKINSTALLDIRS) $(DESTDIR)$(libdir)
+#ifneq ($(ENABLE_STATIC),)
+#	$(INSTALL-L) $(TARGET) $(DESTDIR)$(libdir)/$(TARGET)
+#endif
+#ifneq ($(ENABLE_SHARED),)
+#	$(INSTALL-L) $(FINAL_SO_TARGET) $(DESTDIR)$(libdir)/$(FINAL_SO_TARGET)
+#ifneq ($(FINAL_SO_TARGET),$(SO_TARGET))
+#	cd $(DESTDIR)$(libdir) && $(RM) $(MIDDLE_SO_TARGET) && ln -s $(FINAL_SO_TARGET) $(MIDDLE_SO_TARGET)
+#	cd $(DESTDIR)$(libdir) && $(RM) $(SO_TARGET) && ln -s $(FINAL_SO_TARGET) $(SO_TARGET)
+#endif
+#endif
 
 dist-local:
 
@@ -100,8 +101,8 @@
 
 ifneq ($(ENABLE_SHARED),)
 $(FINAL_SO_TARGET): $(OBJECTS)
-	$(SHLIB.cc) $(LD_SONAME) -o $@ $^ $(LIBS)
+	$(SHLIB.cc) $(LD_SONAME) $(OUTOPT)$@ $^ $(LIBS)
 endif
 
 ifeq (,$(MAKECMDGOALS))
--- misc/build/icu/source/tools/genrb/Makefile.in	2002-05-14 00:50:08.000000000 +0100
+++ misc/build/icu/source/tools/genrb/Makefile.in	2004-04-05 20:05:43.000000000 +0100
@@ -1,5 +1,5 @@
 ## Makefile.in for ICU - tools/genrb
-## Copyright (c) 1999, 2000, International Business Machines Corporation and
+## Copyright (c) 1999-2004, International Business Machines Corporation and
 ## others. All Rights Reserved.
 
 ## Source directory information
@@ -12,9 +12,12 @@
 
 ##
 
+TARGET_STUB_NAME = genrb
+DERB_STUB_NAME = derb
+
 SECTION = 1
 
-MAN_FILES = $(TARGET).$(SECTION) $(DERB).$(SECTION)
+MAN_FILES = $(TARGET_STUB_NAME).$(SECTION) $(DERB_STUB_NAME).$(SECTION)
 
 ## Build directory information
 subdir = tools/genrb
@@ -23,9 +26,9 @@
 CLEANFILES = *~ $(MAN_FILES) $(DEPS) 
 
 ## Target information
-TARGET = genrb
-DERB = derb
+TARGET = $(BINDIR)/$(TARGET_STUB_NAME)$(EXEEXT)
+DERB = $(BINDIR)/$(DERB_STUB_NAME)$(EXEEXT)
 
 CPPFLAGS += -I$(top_builddir)/common -I$(top_srcdir)/common -I$(top_srcdir)/i18n -I$(srcdir)/../toolutil
 LIBS = $(LIBICUI18N) $(LIBICUTOOLUTIL) $(LIBICUUC) $(DEFAULT_LIBS) $(LIB_M)
 
@@ -59,7 +62,7 @@
 	$(INSTALL) $(TARGET) $(DESTDIR)$(bindir)
 	$(INSTALL) $(DERB) $(DESTDIR)$(bindir)
 
-<dist-local:
+dist-local:
 
 clean-local: 
 	test -z "$(CLEANFILES)" || $(RMV) $(CLEANFILES)
@@ -75,10 +78,10 @@
 	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
 $(TARGET) : $(OBJECTS)
-	$(LINK.c) -o $@ $^ $(LIBS) 
+	$(LINK.cc) $(OUTOPT)$@ $^ $(LIBS) 
 
 $(DERB) : $(DERB_OBJ)
-	$(LINK.c) -o $@ $^ $(LIBS) 
+	$(LINK.c) $(OUTOPT)$@ $^ $(LIBS) 
 
 
 # the 'mv' will always fail if you are building in the source dir
@@ -86,8 +89,11 @@
 # man page
 install-man: $(MAN_FILES)
 	$(MKINSTALLDIRS) $(DESTDIR)$(mandir)/man$(SECTION)
-	$(INSTALL_DATA) $< $(DESTDIR)$(mandir)/man$(SECTION)
+	$(INSTALL_DATA) $? $(DESTDIR)$(mandir)/man$(SECTION)
+
+# This line is needed to serialize builds when the gmake -j option is used.
+$(DERB:$(EXEEXT)=).$(SECTION): $(TARGET:$(EXEEXT)=).$(SECTION)
 
 %.$(SECTION): $(srcdir)/%.$(SECTION).in
 	cd $(top_builddir) \
--- misc/build/icu/source/tools/makeconv/Makefile.in	2002-05-14 00:50:12.000000000 +0100
+++ misc/build/icu/source/tools/makeconv/Makefile.in	2004-04-05 20:05:44.000000000 +0100
@@ -1,5 +1,5 @@
 ## Makefile.in for ICU - tools/makeconv
-## Copyright (c) 2001, International Business Machines Corporation and
+## Copyright (c) 1999-2004, International Business Machines Corporation and
 ## others. All Rights Reserved.
 ## Stephen F. Booth
 
@@ -13,11 +13,11 @@
 
 ##
 
-SECTION = 1
+TARGET_STUB_NAME = makeconv
 
-MANX_FILES = $(TARGET).$(SECTION)
+SECTION = 1
 
-GENERATED_MAN_FILES = $(TARGET).$(SECTION)
+MANX_FILES = $(TARGET_STUB_NAME).$(SECTION)
 
 ALL_MAN_FILES = $(MANX_FILES)
 
@@ -26,10 +26,10 @@
 subdir = tools/makeconv
 
 ## Extra files to remove for 'make clean'
-CLEANFILES = *~ $(GENERATED_MAN_FILES) $(DEPS) $(CNV_FILES) $(TEST_CNV_FILES)
+CLEANFILES = *~ $(ALL_MAN_FILES) $(DEPS)
 
 ## Target information
-TARGET = makeconv
+TARGET = $(BINDIR)/$(TARGET_STUB_NAME)$(EXEEXT)
 
 CPPFLAGS += -I$(top_builddir)/common -I$(top_srcdir)/common -I$(srcdir)/../toolutil
 LIBS = $(LIBICUTOOLUTIL) $(LIBICUUC) $(DEFAULT_LIBS) $(LIB_M)
@@ -59,12 +59,7 @@
 
 install-local: all-local install-man
 	$(MKINSTALLDIRS) $(DESTDIR)$(bindir)
-	$(INSTALL) $(TARGET) $(DESTDIR)$(bindir)/$(TARGET)
-#	$(MKINSTALLDIRS) $(DESTDIR)$(pkglibdir)
-#	@list='$(notdir $(CNV_FILES)) convrtrs.txt'; for file in $$list; do \
-#		echo $(INSTALL_DATA) $(top_builddir)/data/$$file $(DESTDIR)$(pkglibdir)/$$file; \
-#		$(INSTALL_DATA) $(top_builddir)/data/$$file $(DESTDIR)$(pkglibdir)/$$file; \
-#	done
+	$(INSTALL) $(TARGET) $(DESTDIR)$(bindir)
 
 dist-local:
 
@@ -87,8 +82,8 @@
 	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
 $(TARGET): $(OBJECTS)
-	$(LINK.cc) -o $@ $^ $(LIBS)
+	$(LINK.cc) $(OUTOPT)$@ $^ $(LIBS)
 
 install-man: install-manx
 install-manx: $(MANX_FILES)
--- misc/build/icu/source/tools/genccode/Makefile.in	2002-05-14 00:50:08.000000000 +0100
+++ misc/build/icu/source/tools/genccode/Makefile.in	2004-04-05 20:05:41.000000000 +0100
@@ -1,5 +1,5 @@
 ## Makefile.in for ICU - tools/genccode
-## Copyright (c) 1999-2000, International Business Machines Corporation and
+## Copyright (c) 1999-2004, International Business Machines Corporation and
 ## others. All Rights Reserved.
 ## Steven R. Loomis
 
@@ -16,17 +16,19 @@
 
 ##
 
+TARGET_STUB_NAME = genccode
+
 SECTION = 8
 
-MANX_FILES = $(TARGET).$(SECTION)
+MANX_FILES = $(TARGET_STUB_NAME).$(SECTION)
 
 ALL_MAN_FILES = $(MANX_FILES)
 
 ## Extra files to remove for 'make clean'
-CLEANFILES = *~ $(DEPS) $(RES_FILES) $(TEST_FILES) $(ALL_MAN_FILES)
+CLEANFILES = *~ $(DEPS) $(ALL_MAN_FILES)
 
 ## Target information
-TARGET = genccode
+TARGET = $(BINDIR)/$(TARGET_STUB_NAME)$(EXEEXT)
 
 CPPFLAGS += -I$(top_builddir)/common -I$(top_srcdir)/common -I$(srcdir)/../toolutil $(BIR_CPPFLAGS)
 LIBS = $(LIBICUUC) $(DEFAULT_LIBS) $(LIB_M) $(LIBICUTOOLUTIL)
@@ -51,11 +53,11 @@
 dist: dist-local
 check: all check-local
 
-all-local: $(TARGET) $(RES_FILES) $(TRANSLIT_RES) $(TEST_FILES) $(ALL_MAN_FILES)
+all-local: $(TARGET) $(ALL_MAN_FILES)
 
 install-local: all-local install-man
 	$(MKINSTALLDIRS) $(DESTDIR)$(sbindir)
-	$(INSTALL) $(TARGET) $(DESTDIR)$(sbindir)/$(TARGET)
+	$(INSTALL) $(TARGET) $(DESTDIR)$(sbindir)
 
 # man page
 install-man: install-manx
@@ -83,8 +85,8 @@
 	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
 $(TARGET) : $(OBJECTS)
-	$(LINK.c) -o $@ $^ $(LIBS) 
+	$(LINK.c) $(OUTOPT)$@ $^ $(LIBS) 
 
 ifeq (,$(MAKECMDGOALS))
 -include $(DEPS)
--- misc/build/icu/source/tools/gencnval/Makefile.in	2002-05-14 00:50:08.000000000 +0100
+++ misc/build/icu/source/tools/gencnval/Makefile.in	2004-04-05 20:05:41.000000000 +0100
@@ -1,5 +1,5 @@
 ## Makefile.in for ICU - tools/gencnval
-## Copyright (c) 1999-2000, International Business Machines Corporation and
+## Copyright (c) 1999-2004, International Business Machines Corporation and
 ## others. All Rights Reserved.
 ## Steven R. Loomi
 
@@ -16,23 +16,19 @@
 
 ##
 
-SECTION = 1
-
-MANX_FILES = $(TARGET).$(SECTION)
-MAN5_FILES = convrtrs.txt.5 $(srcdir)/cnvalias.dat.5
+TARGET_STUB_NAME = gencnval
 
-GENERATED_MAN_FILES = $(TARGET).$(SECTION) convrtrs.txt.5
+SECTION = 1
 
-ALL_MAN_FILES = $(MANX_FILES) $(MAN5_FILES)
+MANX_FILES = $(TARGET_STUB_NAME).$(SECTION)
 
-ICUDATADIR=$(top_builddir)/data/
-CONVRTRSFILE=$(top_srcdir)/../data/convrtrs.txt
+ALL_MAN_FILES = $(MANX_FILES)
 
 ## Extra files to remove for 'make clean'
-CLEANFILES = *~ $(GENERATED_MAN_FILES) $(DEPS) $(RES_FILES) $(TEST_FILES)
+CLEANFILES = *~ $(ALL_MAN_FILES) $(DEPS)
 
 ## Target information
-TARGET = gencnval
+TARGET = $(BINDIR)/$(TARGET_STUB_NAME)$(EXEEXT)
 
 CPPFLAGS += -I$(top_builddir)/common -I$(top_srcdir)/common -I$(srcdir)/../toolutil
 LIBS = $(LIBICUTOOLUTIL) $(LIBICUUC) $(DEFAULT_LIBS) $(LIB_M)
@@ -43,9 +39,9 @@
 
 
 ## List of phony targets
-.PHONY : all all-local install install-local clean clean-local		\
+.PHONY : all all-local install install-local clean clean-local	\
 distclean distclean-local dist dist-local check	\
-check-local build-data install-man install-man5 install-manx
+check-local install-man install-manx
 
 ## Clear suffix list
 .SUFFIXES :
@@ -58,11 +54,11 @@
 dist: dist-local
 check: all check-local
 
-all-local: $(TARGET) $(ALL_MAN_FILES) build-data
+all-local: $(TARGET) $(ALL_MAN_FILES)
 
-install-local: all-local build-data install-man
+install-local: all-local install-man
 	$(MKINSTALLDIRS) $(DESTDIR)$(bindir)
-	$(INSTALL) $(TARGET) $(DESTDIR)$(bindir)/$(TARGET)
+	$(INSTALL) $(TARGET) $(DESTDIR)$(bindir)
 
 
 dist-local:
@@ -81,13 +77,10 @@
 	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
 $(TARGET) : $(OBJECTS)
-	$(LINK.cc) -o $@ $^ $(LIBS) 
+	$(LINK.cc) $(OUTOPT)$@ $^ $(LIBS) 
 
 # man page
-install-man: install-man5 install-manx
-install-man5: $(MAN5_FILES)
-	$(MKINSTALLDIRS) $(DESTDIR)$(mandir)/man5
-	$(INSTALL_DATA) $? $(DESTDIR)$(mandir)/man5
+install-man: install-manx
 install-manx: $(MANX_FILES)
 	$(MKINSTALLDIRS) $(DESTDIR)$(mandir)/man$(SECTION)
 	$(INSTALL_DATA) $? $(DESTDIR)$(mandir)/man$(SECTION)
@@ -95,17 +88,14 @@
 %.$(SECTION): $(srcdir)/%.$(SECTION).in
 	cd $(top_builddir) \
 	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
-%.5: $(srcdir)/%.5.in
-	cd $(top_builddir) \
-	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
 # only on linux probably ?
-$(TARGET).ps: $(TARGET).$(SECTION)
-	groff -man < $< > $@
+#$(TARGET).ps: $(TARGET).$(SECTION)
+#	groff -man < $< > $@
 
-$(TARGET).pdf: $(TARGET).ps
-	ps2pdf $< $@
+#$(TARGET).pdf: $(TARGET).ps
+#	ps2pdf $< $@
 
 ifeq (,$(MAKECMDGOALS))
 -include $(DEPS)
--- misc/build/icu/source/tools/gennames/Makefile.in	2002-05-14 00:50:08.000000000 +0100
+++ misc/build/icu/source/tools/gennames/Makefile.in	2004-04-05 20:05:41.000000000 +0100
@@ -1,5 +1,5 @@
 ## Makefile.in for ICU - tools/gennames
-## Copyright (c) 1999-2000, International Business Machines Corporation and
+## Copyright (c) 1999-2004, International Business Machines Corporation and
 ## others. All Rights Reserved.
 ## Steven R. Loomi
 
@@ -16,23 +16,19 @@
 
 ##
 
+TARGET_STUB_NAME = gennames
+
 SECTION = 8
 
-MANX_FILES = $(TARGET).$(SECTION)
+MANX_FILES = $(TARGET_STUB_NAME).$(SECTION)
 
 ALL_MAN_FILES = $(MANX_FILES)
 
-##
-
-ICUDATADIR=$(top_builddir)/data/
-UNICODEDATADIR=$(top_srcdir)/../data/unidata
-UNICODEFILE=$(UNICODEDATADIR)/UnicodeData.txt
-
 ## Extra files to remove for 'make clean'
-CLEANFILES = *~ $(DEPS) $(RES_FILES) $(TEST_FILES) $(ALL_MAN_FILES)
+CLEANFILES = *~ $(DEPS) $(ALL_MAN_FILES)
 
 ## Target information
-TARGET = gennames
+TARGET = $(BINDIR)/$(TARGET_STUB_NAME)$(EXEEXT)
 
 CPPFLAGS += -I$(top_builddir)/common -I$(top_srcdir)/common -I$(srcdir)/../toolutil
 LIBS = $(LIBICUTOOLUTIL) $(LIBICUUC) $(DEFAULT_LIBS) $(LIB_M)
@@ -44,7 +40,7 @@
 ## List of phony targets
 .PHONY : all all-local install install-local clean clean-local\
 distclean distclean-local dist dist-local check	\
-check-local build-data install-man install-manx
+check-local install-man install-manx
 
 ## Clear suffix list
 .SUFFIXES :
@@ -59,9 +55,9 @@
 
 all-local: $(TARGET) $(ALL_MAN_FILES)
 
-install-local: all-local build-data install-man
+install-local: all-local install-man
 	$(MKINSTALLDIRS) $(DESTDIR)$(sbindir)
-	$(INSTALL) $(TARGET) $(DESTDIR)$(sbindir)/$(TARGET)
+	$(INSTALL) $(TARGET) $(DESTDIR)$(sbindir)
 
 # man page
 install-man: install-manx
@@ -89,8 +85,8 @@
 	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
 $(TARGET) : $(OBJECTS)
-	$(LINK.cc) -o $@ $^ $(LIBS) 
+	$(LINK.cc) $(OUTOPT)$@ $^ $(LIBS) 
 
 ifeq (,$(MAKECMDGOALS))
 -include $(DEPS)
--- misc/build/icu/source/tools/genprops/Makefile.in	2002-05-14 00:50:08.000000000 +0100
+++ misc/build/icu/source/tools/genprops/Makefile.in	2004-04-05 20:05:42.000000000 +0100
@@ -1,5 +1,5 @@
 ## Makefile.in for ICU - tools/genprops
-## Copyright (c) 1999-2002, International Business Machines Corporation and
+## Copyright (c) 1999-2004, International Business Machines Corporation and
 ## others. All Rights Reserved.
 ## Steven R. Loomis
 
@@ -13,21 +13,20 @@
 
 ##
 
+TARGET_STUB_NAME = genprops
+
 SECTION = 8
 
-MAN_FILES = $(TARGET).$(SECTION)
+MAN_FILES = $(TARGET_STUB_NAME).$(SECTION)
 
 ## Build directory information
 subdir = tools/genprops
 
-ICUDATADIR=$(top_builddir)/data
-UNICODEDATADIR=$(top_srcdir)/../data/unidata
-
 ## Extra files to remove for 'make clean'
-CLEANFILES = *~ $(DEPS) $(RES_FILES) $(TEST_FILES) $(MAN_FILES)
+CLEANFILES = *~ $(DEPS) $(MAN_FILES)
 
 ## Target information
-TARGET = genprops
+TARGET = $(BINDIR)/$(TARGET_STUB_NAME)$(EXEEXT)
 
 CPPFLAGS += -I$(top_builddir)/common -I$(top_srcdir)/common -I$(srcdir)/../toolutil
 LIBS = $(LIBICUTOOLUTIL) $(LIBICUUC) $(DEFAULT_LIBS) $(LIB_M)
@@ -39,7 +38,7 @@
 ## List of phony targets
 .PHONY : all all-local install install-local clean clean-local		\
 distclean distclean-local dist dist-local check	\
-check-local build-data install-man
+check-local install-man
 
 ## Clear suffix list
 .SUFFIXES :
@@ -52,27 +51,27 @@
 dist: dist-local
 check: all check-local
 
-all-local: $(TARGET) build-data $(MAN_FILES)
+all-local: $(TARGET) $(MAN_FILES)
 
 install-local: all-local install-man
 	$(MKINSTALLDIRS) $(DESTDIR)$(sbindir)
-	$(INSTALL) $(TARGET) $(DESTDIR)$(sbindir)/$(TARGET)
+	$(INSTALL) $(TARGET) $(DESTDIR)$(sbindir)
 
 # man page
 install-man: $(MAN_FILES)
 	$(MKINSTALLDIRS) $(DESTDIR)$(mandir)/man$(SECTION)
 	$(INSTALL_DATA) $< $(DESTDIR)$(mandir)/man$(SECTION)
 
-$(TARGET).$(SECTION): $(srcdir)/$(TARGET).$(SECTION).in
+%.$(SECTION): $(srcdir)/%.$(SECTION).in
 	cd $(top_builddir) \
 	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
 # build postscript and pdf formats
-$(TARGET).ps: $(TARGET).$(SECTION)
-	groff -man < $< > $@
+#$(TARGET).ps: $(TARGET).$(SECTION)
+#	groff -man < $< > $@
 
-$(TARGET).pdf: $(TARGET).ps
-	ps2pdf $< $@
+#$(TARGET).pdf: $(TARGET).ps
+#	ps2pdf $< $@
 
 dist-local:
 
@@ -90,8 +89,8 @@
 	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
 $(TARGET) : $(OBJECTS)
-	$(LINK.cc) -o $@ $^ $(LIBS) 
+	$(LINK.cc) $(OUTOPT)$@ $^ $(LIBS) 
 
 ifeq (,$(MAKECMDGOALS))
 -include $(DEPS)
--- misc/build/icu/source/tools/gennorm/Makefile.in	2002-05-14 00:50:08.000000000 +0100
+++ misc/build/icu/source/tools/gennorm/Makefile.in	2004-04-05 20:05:42.000000000 +0100
@@ -1,5 +1,5 @@
 ## Makefile.in for ICU - tools/gennorm
-## Copyright (c) 2001, International Business Machines Corporation and
+## Copyright (c) 2001-2004, International Business Machines Corporation and
 ## others. All Rights Reserved.
 ## Steven R. Loomis/Markus W. Scherer
 
@@ -13,21 +13,20 @@
 
 ##
 
+TARGET_STUB_NAME = gennorm
+
 SECTION = 8
 
-MAN_FILES = $(TARGET).$(SECTION)
+MAN_FILES = $(TARGET_STUB_NAME).$(SECTION)
 
 ## Build directory information
 subdir = tools/gennorm
 
-ICUDATADIR=$(top_builddir)/data
-UNICODEDATADIR=$(top_srcdir)/../data/unidata
-
 ## Extra files to remove for 'make clean'
-CLEANFILES = *~ $(DEPS) $(RES_FILES) $(TEST_FILES) $(MAN_FILES)
+CLEANFILES = *~ $(DEPS) $(MAN_FILES)
 
 ## Target information
-TARGET = gennorm
+TARGET = $(BINDIR)/$(TARGET_STUB_NAME)$(EXEEXT)
 
 CPPFLAGS += -I$(top_builddir)/common -I$(top_srcdir)/common -I$(srcdir)/../toolutil
 LIBS = $(LIBICUTOOLUTIL) $(LIBICUUC) $(DEFAULT_LIBS) $(LIB_M)
@@ -39,7 +38,7 @@
 ## List of phony targets
 .PHONY : all all-local install install-local clean clean-local		\
 distclean distclean-local dist dist-local check	\
-check-local build-data install-man
+check-local install-man
 
 ## Clear suffix list
 .SUFFIXES :
@@ -52,27 +51,27 @@
 dist: dist-local
 check: all check-local
 
-all-local: $(TARGET) build-data $(MAN_FILES)
+all-local: $(TARGET) $(MAN_FILES)
 
 install-local: all-local install-man
 	$(MKINSTALLDIRS) $(DESTDIR)$(sbindir)
-	$(INSTALL) $(TARGET) $(DESTDIR)$(sbindir)/$(TARGET)
+	$(INSTALL) $(TARGET) $(DESTDIR)$(sbindir)
 
 # man page
 install-man: $(MAN_FILES)
 	$(MKINSTALLDIRS) $(DESTDIR)$(mandir)/man$(SECTION)
 	$(INSTALL_DATA) $< $(DESTDIR)$(mandir)/man$(SECTION)
 
-$(TARGET).$(SECTION): $(srcdir)/$(TARGET).$(SECTION).in
+%.$(SECTION): $(srcdir)/%.$(SECTION).in
 	cd $(top_builddir) \
 	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
 # build postscript and pdf formats
-$(TARGET).ps: $(TARGET).$(SECTION)
-	groff -man < $< > $@
+#$(TARGET).ps: $(TARGET).$(SECTION)
+#	groff -man < $< > $@
 
-$(TARGET).pdf: $(TARGET).ps
-	ps2pdf $< $@
+#$(TARGET).pdf: $(TARGET).ps
+#	ps2pdf $< $@
 
 dist-local:
 
@@ -90,8 +89,8 @@
 	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
 $(TARGET) : $(OBJECTS)
-	$(LINK.cc) -o $@ $^ $(LIBS) 
+	$(LINK.cc) $(OUTOPT)$@ $^ $(LIBS) 
 
 ifeq (,$(MAKECMDGOALS))
 -include $(DEPS)
--- misc/build/icu/source/tools/gentest/Makefile.in	2002-05-14 00:50:10.000000000 +0100
+++ misc/build/icu/source/tools/gentest/Makefile.in	2004-04-05 20:05:44.000000000 +0100
@@ -1,6 +1,6 @@
 ## Makefile.in for ICU - tools/gentest
 
-## Copyright (c) 1999-2000, International Business Machines Corporation and
+## Copyright (c) 1999-2003, International Business Machines Corporation and
 ## others. All Rights Reserved.
 ## Madhu Katragadda
 
@@ -17,27 +17,23 @@
 
 ##
 
-ICUDATADIR=$(top_builddir)/data
-
 ## Extra files to remove for 'make clean'
-CLEANFILES = *~ $(DEPS) $(RES_FILES) $(TEST_FILES)
+CLEANFILES = *~ $(DEPS)
 
 ## Target information
-TARGET = gentest
+TARGET = gentest$(EXEEXT)
 
 CPPFLAGS += -I$(top_builddir)/common -I$(top_srcdir)/common -I$(srcdir)/../toolutil
 LIBS = $(LIBICUTOOLUTIL) $(LIBICUUC) $(DEFAULT_LIBS) $(LIB_M)
 
 OBJECTS = gentest.o
 
 DEPS = $(OBJECTS:.o=.d)
 
-TEST_FILES = $(ICUDATADIR)/test.dat
-
 ## List of phony targets
 .PHONY : all all-local install install-local clean clean-local		\
 distclean distclean-local dist dist-local check	\
-check-local build-data
+check-local
 
 ## Clear suffix list
 .SUFFIXES :
@@ -70,8 +66,8 @@
 	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
 $(TARGET) : $(OBJECTS)
-	$(LINK.cc) -o $@ $^ $(LIBS) 
+	$(LINK.cc) $(OUTOPT)$@ $^ $(LIBS) 
 
 ifeq (,$(MAKECMDGOALS))
 -include $(DEPS)
--- misc/build/icu/source/tools/genbrk/Makefile.in	2002-07-11 16:33:52.000000000 +0100
+++ misc/build/icu/source/tools/genbrk/Makefile.in	2004-04-05 20:05:40.000000000 +0100
@@ -1,5 +1,5 @@
 ## Makefile.in for ICU - tools/genbrk
-## Copyright (c) 2002 International Business Machines Corporation and
+## Copyright (c) 2002-2004 International Business Machines Corporation and
 ## others. All Rights Reserved.
 
 ## Source directory information
@@ -12,9 +12,11 @@
 
 ##
 
+TARGET_STUB_NAME = genbrk
+
 SECTION = 1
 
-MAN_FILES = $(TARGET).$(SECTION)
+MAN_FILES = $(TARGET_STUB_NAME).$(SECTION)
 
 ## Build directory information
 subdir = tools/genbrk
@@ -23,7 +25,7 @@
 CLEANFILES = *~ $(MAN_FILES) $(DEPS) 
 
 ## Target information
-TARGET = genbrk
+TARGET = $(BINDIR)/$(TARGET_STUB_NAME)$(EXEEXT)
 
 CPPFLAGS += -I$(top_builddir)/common -I$(top_srcdir)/common -I$(srcdir)/../toolutil
 LIBS = $(LIBICUTOOLUTIL) $(LIBICUUC) $(DEFAULT_LIBS) $(LIB_M)
@@ -54,7 +56,7 @@
 	$(MKINSTALLDIRS) $(DESTDIR)$(bindir)
 	$(INSTALL) $(TARGET) $(DESTDIR)$(bindir)
 
-<dist-local:
+dist-local:
 
 clean-local: 
 	test -z "$(CLEANFILES)" || $(RMV) $(CLEANFILES)
@@ -70,8 +72,8 @@
 	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
 $(TARGET) : $(OBJECTS)
-	$(LINK.cc) -o $@ $^ $(LIBS) 
+	$(LINK.cc) $(OUTOPT)$@ $^ $(LIBS) 
 
 
 # the 'mv' will always fail if you are building in the source dir
--- misc/build/icu/source/tools/gencmn/Makefile.in	2002-05-14 00:50:08.000000000 +0100
+++ misc/build/icu/source/tools/gencmn/Makefile.in	2004-04-05 20:05:41.000000000 +0100
@@ -1,5 +1,5 @@
 ## Makefile.in for ICU - tools/gencmn
-## Copyright (c) 1999-2001, International Business Machines Corporation and
+## Copyright (c) 1999-2004, International Business Machines Corporation and
 ## others. All Rights Reserved.
 ## Steven R. Loomis
 
@@ -16,18 +16,21 @@
 
 ##
 
+TARGET_STUB_NAME = gencmn
+DECMN_STUB_NAME = decmn
+
 SECTION = 8
 
-MANX_FILES = $(TARGET).$(SECTION) $(DECMN).$(SECTION)
+MANX_FILES = $(TARGET_STUB_NAME).$(SECTION) $(DECMN_STUB_NAME).$(SECTION)
 
 ALL_MAN_FILES = $(MANX_FILES)
 
 ## Extra files to remove for 'make clean'
-CLEANFILES = *~ mkmap.tmp $(DEPS) $(RES_FILES) $(TEST_FILES) $(DECMN_DEP) $(ALL_MAN_FILES)
+CLEANFILES = *~ $(DEPS) $(DECMN_DEP) $(ALL_MAN_FILES)
 
 ## Target information
-TARGET = gencmn
-DECMN = decmn
+TARGET = $(BINDIR)/$(TARGET_STUB_NAME)$(EXEEXT)
+DECMN = $(BINDIR)/$(DECMN_STUB_NAME)$(EXEEXT)
 
 CPPFLAGS += -I$(top_builddir)/common -I$(top_srcdir)/common -I$(srcdir)/../toolutil $(BIR_CPPFLAGS)
 LIBS = $(LIBICUTOOLUTIL) $(LIBICUUC) $(DEFAULT_LIBS) $(LIB_M)
@@ -54,12 +57,12 @@
 dist: dist-local
 check: all check-local
 
-all-local: $(TARGET) $(RES_FILES) $(TRANSLIT_RES) $(TEST_FILES) $(DECMN) $(ALL_MAN_FILES)
+all-local: $(TARGET) $(DECMN) $(ALL_MAN_FILES)
 
 install-local: all-local install-man
 	$(MKINSTALLDIRS) $(DESTDIR)$(sbindir)
-	$(INSTALL) $(TARGET) $(DESTDIR)$(sbindir)/$(TARGET)
-	$(INSTALL) $(DECMN) $(DESTDIR)$(sbindir)/$(DECMN)
+	$(INSTALL) $(TARGET) $(DESTDIR)$(sbindir)
+	$(INSTALL) $(DECMN) $(DESTDIR)$(sbindir)
 
 dist-local:
 
@@ -77,10 +80,10 @@
 	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
 $(TARGET) : $(OBJECTS)
-	$(LINK.cc) -o $@ $^ $(LIBS) 
+	$(LINK.cc) $(OUTOPT)$@ $^ $(LIBS) 
 
 $(DECMN) : $(DECMN_OBJ)
-	$(LINK.cc) -o $@ $^ $(LIBS) 
+	$(LINK.cc) $(OUTOPT)$@ $^ $(LIBS) 
 
 # man page
 install-man: install-manx
@@ -88,6 +91,9 @@
 	$(MKINSTALLDIRS) $(DESTDIR)$(mandir)/man$(SECTION)
 	$(INSTALL_DATA) $? $(DESTDIR)$(mandir)/man$(SECTION)
 
+# This line is needed to serialize builds when the gmake -j option is used.
+$(DECMN:$(EXEEXT)=).$(SECTION): $(TARGET:$(EXEEXT)=).$(SECTION)
+
 %.$(SECTION): $(srcdir)/%.$(SECTION).in
 	cd $(top_builddir) \
 	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
@@ -101,4 +107,5 @@
 -include $(DECMN_DEP)
 endif
 endif
+
--- misc/build/icu/source/tools/genuca/Makefile.in	2002-05-14 00:50:12.000000000 +0100
+++ misc/build/icu/source/tools/genuca/Makefile.in	2004-04-05 20:05:44.000000000 +0100
@@ -1,5 +1,5 @@
 ## Makefile.in for ICU - tools/genuca
-## Copyright (c) 1999-2001, International Business Machines Corporation and
+## Copyright (c) 1999-2004, International Business Machines Corporation and
 ## others. All Rights Reserved.
 
 ## Source directory information
@@ -12,18 +12,20 @@
 
 ##
 
+TARGET_STUB_NAME = genuca
+
 SECTION = 8
 
-MAN_FILES = $(TARGET).$(SECTION)
+MAN_FILES = $(TARGET_STUB_NAME).$(SECTION)
 
 ## Build directory information
 subdir = tools/genuca
 
 ## Extra files to remove for 'make clean'
-CLEANFILES = *~ $(TARGET).$(SECTION) $(DEPS) 
+CLEANFILES = *~ $(MAN_FILES) $(DEPS)
 
 ## Target information
-TARGET = genuca
+TARGET = $(BINDIR)/$(TARGET_STUB_NAME)$(EXEEXT)
 
 CPPFLAGS += -I$(top_builddir)/common -I$(top_srcdir)/common -I$(top_srcdir)/i18n -I$(srcdir)/../toolutil
 LIBS = $(LIBICUI18N) $(LIBICUTOOLUTIL) $(LIBICUUC) $(DEFAULT_LIBS) $(LIB_M)
@@ -53,9 +55,9 @@
 
 install-local: all-local install-man
 	$(MKINSTALLDIRS) $(DESTDIR)$(sbindir)
-	$(INSTALL) $(TARGET) $(DESTDIR)$(sbindir)/$(TARGET)
+	$(INSTALL) $(TARGET) $(DESTDIR)$(sbindir)
 
-<dist-local:
+dist-local:
 
 clean-local: 
 	test -z "$(CLEANFILES)" || $(RMV) $(CLEANFILES)
@@ -71,7 +73,7 @@
 	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
 $(TARGET) : $(OBJECTS)
-	$(LINK.cc) -o $@ $^ $(LIBS) 
+	$(LINK.cc) $(OUTOPT)$@ $^ $(LIBS) 
 
 
 # the 'mv' will always fail if you are building in the source dir
@@ -81,17 +83,17 @@
 	$(MKINSTALLDIRS) $(DESTDIR)$(mandir)/man$(SECTION)
 	$(INSTALL_DATA) $< $(DESTDIR)$(mandir)/man$(SECTION)
 
-$(TARGET).$(SECTION): $(srcdir)/$(TARGET).$(SECTION).in
+%.$(SECTION): $(srcdir)/%.$(SECTION).in
 	cd $(top_builddir) \
 	 && CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
 # build postscript and pdf formats
-$(TARGET).ps: $(TARGET).$(SECTION)
-	groff -man < $< > $@
+#$(TARGET).ps: $(TARGET).$(SECTION)
+#	groff -man < $< > $@
 
-$(TARGET).pdf: $(TARGET).ps
-	ps2pdf $< $@
+#$(TARGET).pdf: $(TARGET).ps
+#	ps2pdf $< $@
 
 ifeq (,$(MAKECMDGOALS))
 -include $(DEPS)
--- misc/build/icu/source/tools/Makefile.in	2002-06-25 18:23:06.000000000 +0100
+++ misc/build/icu/source/tools/Makefile.in	2004-04-05 20:05:40.000000000 +0100
@@ -1,5 +1,5 @@
 ## Makefile.in for ICU tools
-## Copyright (c) 1999-2000, International Business Machines Corporation and
+## Copyright (c) 1999-2004, International Business Machines Corporation and
 ## others. All Rights Reserved.
 
 ## Source directory information
@@ -10,55 +10,12 @@
 
 include $(top_builddir)/icudefs.mk
 
-include @platform_make_fragment@
-
-##
-
-CPPFLAGS = @CPPFLAGS@ -I$(top_srcdir)/common -I$(top_builddir)/common
-CFLAGS = @CFLAGS@
-CXXFLAGS = @CXXFLAGS@
-
 ## Build directory information
 subdir = tools
 
-# OBJDATADIR must be a short path (with ..'s) to the data.
-
-SRCDATADIR=$(top_srcdir)/../data
-
-OBJDATADIR=$(top_builddir)/data
-# tmpdir is INSIDE pkgdata dir. if you change TMPDATADIR then the invokation
-# of pkgdata will break...
-TMPDATADIR=tmp
-
-# DATABUILDDIR must be an absolute path because of the way pkgdata is invoked
-# from the temporary directory.
-
-DATABUILDDIR=$(OBJDATADIR)
-
-# relative lib links from pkgdata are the same as for tmp
-top_builddir_from_tmp = $(patsubst ..%,../..%,$(top_builddir))
-INVOKE = $(LDLIBRARYPATH_ENVVAR)=$(top_builddir_from_tmp)/common:$(top_builddir_from_tmp)/tools/toolutil:$$$(LDLIBRARYPATH_ENVVAR)
-PKGDATA = ../pkgdata/pkgdata -T . -s $(DATABUILDDIR) -O ./icupkg.inc -d $(DATABUILDDIR) 
-PKGDATA_VERSIONING = -r $(SO_TARGET_VERSION)
-
-## Install program information
-MKINSTALLDIRS = $(SHELL) $(top_srcdir)/mkinstalldirs
-
-INSTALL = @INSTALL@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-
-## for cleaning up libraries
-STRIP = @STRIP@
-
-## Package information
-PACKAGE = @PACKAGE@
-VERSION = @VERSION@
-
-
 SUBDIRS = ctestfw toolutil makeconv genrb genuca genbrk \
-genccode genprops gennames gennorm gencmn gencnval gentz gentest pkgdata
+genprops gennames genpname gennorm gencmn gencnval gensprep genccode pkgdata \
+gentest  icuswap
 
 ## List of phony targets
 .PHONY : all all-local all-recursive install install-local install-files install-dlls build-cmnfile build-dll		\
@@ -97,108 +54,24 @@
 
 all-local: build-local
 
-DAT_FILES=uprops.dat unames.dat cnvalias.dat tz.dat
-# ALL of these files can be deleted (the following BRK files) - they are copied
-BRK_FILES=char.brk line.brk line_th.brk sent.brk word.brk title.brk word_th.brk
-# don't include thaidict.brk - it goes into a resource bundle - plus it isn't deleted
-
-DATAFILESD=$(DAT_FILES:%=$(OBJDATADIR)/%)
-DATAFILESB=$(BRK_FILES:%=$(OBJDATADIR)/%)
-
-# copy the right endianness
-
-ifeq (@U_IS_BIG_ENDIAN@,1)
-$(OBJDATADIR)/%.brk: $(SRCDATADIR)/%BE.brk
-	cp $< $@
-else
-$(OBJDATADIR)/%.brk: $(SRCDATADIR)/%LE.brk
-	cp $< $@
-endif
-
-#include $(srcdir)/makeconv/ucmfiles.mk
-#-include $(srcdir)/makeconv/ucmebcdic.mk
-#-include $(srcdir)/makeconv/ucmlocal.mk
-ALL_UCM_SOURCE= $(UCM_SOURCE) $(UCM_EBCDIC_SOURCE) $(UCM_SOURCE_LOCAL)
-
-#include $(srcdir)/genrb/genrbfiles.mk
-#-include $(srcdir)/genrb/reslocal.mk
-ALL_RES_SOURCE= $(GENRB_SOURCE) $(TRANSLIT_SOURCE) $(RESOURCE_SRC) $(GENRB_SOURCE_LOCAL)
-
-UCM_FILES = $(ALL_UCM_SOURCE:%=$(SRCDATADIR)/%)
-CNV_FILES = $(ALL_UCM_SOURCE:%.ucm=$(OBJDATADIR)/%.cnv)
-CNV_FILESL = $(ALL_UCM_SOURCE:%.ucm=%.cnv)
-
-RES_SRC_FILES = $(ALL_RES_SOURCE:%=$(SRCDATADIR)/%)
-RES_FILES = $(ALL_RES_SOURCE:%.txt=$(OBJDATADIR)/%.res)
-RES_FILESL = $(ALL_RES_SOURCE:%.txt=%.res)
-
-DATAFILESC=$(CNV_FILES)
-DATAFILESR=$(RES_FILES)
-
-DATAFILES=$(DATAFILESD) $(CNV_FILES) $(DATAFILESB) $(RES_FILES)
-DATAFILESL=$(DAT_FILES) $(CNV_FILESL) $(BRK_FILES) $(RES_FILESL)
-
 
 ## Files to remove for 'make clean'
-CLEANFILES = *~ $(BRK_FILES)
+CLEANFILES = *~
 
 install-local:
 
 dist-local:
 
-clean-local: clean-pkgdata
+clean-local: 
 	test -z "$(CLEANFILES)" || $(RMV) $(CLEANFILES)
-	test -z "$(SRCDATAFILES)" || $(RMV) $(SRCDATAFILES)
-	$(RMV) $(DATAFILES)
-	$(RMV) icupkg.inc
-	-@if [ -f $(TMPDATADIR)/$(ICUDATA_NAME)_dll.mak ]; then \
-		(cd pkgdata ; $(INVOKE) ./pkgdata -T $(TMPDATADIR) -m dll $(PKGDATA_VERSIONING) -p $(ICUDATA_NAME) -O $(DATABUILDDIR)/icupkg.inc $(TMPDATADIR)/$(ICUDATA_NAME).lst -d $(DATABUILDDIR) --clean ) \
-	fi
-	-@if [ -f $(TMPDATADIR)/$(ICUDATA_NAME)_common.mak ]; then \
-		(cd pkgdata; $(INVOKE) ./pkgdata -T $(TMPDATADIR) -m common -p $(ICUDATA_NAME) -O $(DATABUILDDIR)/icupkg.inc $(TMPDATADIR)/$(ICUDATA_NAME).lst -d $(DATABUILDDIR) --clean ) \
-	fi
-	-@$(RMV) $(TMPDATADIR) $(TMPDATADIR)2
 
 # Clean up any old variations.. 
 distclean-local: clean-local
 	$(RMV) Makefile
 
-$(TMPDATADIR)/$(ICUDATA_NAME).lst: Makefile $(srcdir)/Makefile.in $(srcdir)/genrb/genrbfiles.mk $(srcdir)/makeconv/ucmfiles.mk
-	@echo "generating $@ (list of data files)"
-	@$(MKINSTALLDIRS) $(TMPDATADIR)
-	@-$(RMV) $(TMPDATADIR)/$(ICUDATA_NAME).lst
-	@for file in $(DATAFILESL); do \
-	  echo $(OBJDATADIR)/$$file >> $(TMPDATADIR)/$(ICUDATA_NAME).lst; \
-	done;
-
-$(TMPDATADIR)/testdata.lst: Makefile
-	$(MKINSTALLDIRS) $(TMPDATADIR)
-	echo $(DATABUILDDIR)/test.dat > $@
-
-$(TMPDATADIR)2/testdata.lst: Makefile $(top_builddir)/test/testdata/root.res
-	$(MKINSTALLDIRS) $(TMPDATADIR)2
-	echo $(DATABUILDDIR)/test.dat > $@
-	echo $(DATABUILDDIR)/../test/testdata/root.res >> $@
-
-$(TMPDATADIR)/icupkg.inc: pkgdata/icupkg.inc
-	$(MKINSTALLDIRS) $(TMPDATADIR)
-	cp pkgdata/icupkg.inc $(TMPDATADIR)/icupkg.inc
-
-$(TMPDATADIR)2/icupkg.inc: pkgdata/icupkg.inc
-	$(MKINSTALLDIRS) $(TMPDATADIR)2
-	cp pkgdata/icupkg.inc $(TMPDATADIR)2/icupkg.inc
-
-# build the ICU and test data
-
 build-local:
 
-clean-pkgdata:
-	-(cd $(TMPDATADIR); $(INVOKE) $(PKGDATA) -m dll -p $(ICUDATA_NAME) ./$(ICUDATA_NAME).lst --clean || echo '### Warning, cannot clean up icu/data if pkgdata is already gone.' )
-	-(cd $(TMPDATADIR); $(INVOKE) $(PKGDATA) -m common -p testdat1  ./testdata.lst --clean || echo '### Warning, cannot clean up icu/data if pkgdata is already gone.' )
-	-(cd $(TMPDATADIR)2; $(INVOKE) $(PKGDATA) -m common -p testdat2  ./testdata.lst --clean || echo '### Warning, cannot clean up icu/data if pkgdata is already gone.' )
-	-$(RMV) $(TMPDATADIR)/$(ICUDATA_NAME).lst $(TMPDATADIR)/testdata.lst $(TMPDATADIR)/icupkg.inc $(TMPDATADIR)2/testdata.lst
-
 check-local:
 
 Makefile: $(srcdir)/Makefile.in  $(top_builddir)/config.status
--- misc/build/icu/source/tools/toolutil/Makefile.in	2002-05-14 00:50:12.000000000 +0100
+++ misc/build/icu/source/tools/toolutil/Makefile.in	2004-04-05 20:05:46.000000000 +0100
@@ -1,4 +1,4 @@
-## Copyright (C) 2000, International Business Machines Corporation 
+## Copyright (C) 1999-2004, International Business Machines Corporation 
 ## and others.  All Rights Reserved.
 
 ## Makefile.in for ICU - tools/toolutil
@@ -20,12 +20,14 @@
 
 ## Target information
 
+TARGET_STUBNAME=tu
+
 ifneq ($(ENABLE_STATIC),)
-TARGET = $(LIBICU)toolutil$(ICULIBSUFFIX).a
+TARGET = $(LIBDIR)/$(LIBSICU)$(TARGET_STUBNAME)$(ICULIBSUFFIX).$(A)
 endif
 
 ifneq ($(ENABLE_SHARED),)
-SO_TARGET = $(LIBICU)toolutil$(ICULIBSUFFIX).$(SO)
+SO_TARGET = $(LIBDIR)/$(LIBICU)$(TARGET_STUBNAME)$(ICULIBSUFFIX).$(SO)
 ALL_SO_TARGETS = $(SO_TARGET) $(MIDDLE_SO_TARGET) $(FINAL_SO_TARGET)
 endif
 
@@ -66,13 +68,13 @@
 install-library: all-local
 	$(MKINSTALLDIRS) $(DESTDIR)$(libdir)
 ifneq ($(ENABLE_STATIC),)
-	$(INSTALL-L) $(TARGET) $(DESTDIR)$(libdir)/$(TARGET)
+	$(INSTALL-L) $(TARGET) $(DESTDIR)$(libdir)
 endif
 ifneq ($(ENABLE_SHARED),)
-	$(INSTALL-L) $(FINAL_SO_TARGET) $(DESTDIR)$(libdir)/$(FINAL_SO_TARGET)
+	$(INSTALL-L) $(FINAL_SO_TARGET) $(DESTDIR)$(libdir)
 ifneq ($(FINAL_SO_TARGET),$(SO_TARGET))
-	cd $(DESTDIR)$(libdir) && $(RM) $(MIDDLE_SO_TARGET) && ln -s $(FINAL_SO_TARGET) $(MIDDLE_SO_TARGET)
-	cd $(DESTDIR)$(libdir) && $(RM) $(SO_TARGET) && ln -s $(FINAL_SO_TARGET) $(SO_TARGET)
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(MIDDLE_SO_TARGET)) && ln -s $(notdir $(FINAL_SO_TARGET)) $(notdir $(MIDDLE_SO_TARGET))
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(SO_TARGET)) && ln -s $(notdir $(FINAL_SO_TARGET)) $(notdir $(SO_TARGET))
 endif
 endif
 
@@ -98,8 +100,8 @@
 
 ifneq ($(ENABLE_SHARED),)
 $(FINAL_SO_TARGET): $(OBJECTS)
-	$(SHLIB.cc) $(LD_SONAME) -o $@ $^ $(LIBS)
+	$(SHLIB.cc) $(LD_SONAME) $(OUTOPT)$@ $^ $(LIBS)
 endif
 
 ifeq (,$(MAKECMDGOALS))
--- misc/build/icu/source/tools/pkgdata/Makefile.in	2002-07-27 08:58:30.000000000 +0100
+++ misc/build/icu/source/tools/pkgdata/Makefile.in	2004-04-05 20:05:45.000000000 +0100
@@ -1,5 +1,5 @@
 ## Makefile.in for ICU - tools/pkgdata
-## Copyright (c) 1999-2000, International Business Machines Corporation and
+## Copyright (c) 1999-2004, International Business Machines Corporation and
 ## others. All Rights Reserved.
 ## Steven R. Loomis
 
@@ -16,28 +16,30 @@
 
 ##
 
+TARGET_STUB_NAME = pkgdata
+
 SECTION = 1
 
-MANX_FILES = $(TARGET).$(SECTION)
+MANX_FILES = $(TARGET_STUB_NAME).$(SECTION)
 
 ALL_MAN_FILES = $(MANX_FILES)
 
 ## Extra files to remove for 'make clean'
-CLEANFILES = *~ $(DEPS) $(RES_FILES) $(TEST_FILES) mkmap.tmp $(ALL_MAN_FILES)
+CLEANFILES = *~ $(DEPS) $(ALL_MAN_FILES)
 
 ## Target information
-TARGET = pkgdata
+TARGET = $(BINDIR)/$(TARGET_STUB_NAME)$(EXEEXT)
 
 CPPFLAGS += -I$(top_builddir)/common -I$(top_srcdir)/common -I$(srcdir)/../toolutil
 DEFS += -DUDATA_SO_SUFFIX=\".$(SO)\" -DSTATIC_O=\"$(STATIC_O)\"
 LIBS = $(LIBICUTOOLUTIL) $(LIBICUUC) $(DEFAULT_LIBS) $(LIB_M)
 
 OBJECTS = pkgdata.o pkgtypes.o gmake.o dllmode.o cmnmode.o filemode.o sttcmode.o
 
 DEPS = $(OBJECTS:.o=.d)
 
 ## List of phony targets
-.PHONY : all all-local install install-local clean clean-local		\
+.PHONY : all all-local install install-local clean clean-local	\
 distclean distclean-local dist dist-local check	\
 check-local install-man install-manx
 
@@ -52,11 +54,11 @@
 dist: dist-local
 check: all check-local
 
-all-local: $(TARGET) $(RES_FILES) $(TRANSLIT_RES) $(TEST_FILES) $(ALL_MAN_FILES)
+all-local: $(TARGET) $(ALL_MAN_FILES)
 
 install-local: all-local install-man
 	$(MKINSTALLDIRS) $(DESTDIR)$(bindir)
-	$(INSTALL) $(TARGET) $(DESTDIR)$(bindir)/$(TARGET)
+	$(INSTALL) $(TARGET) $(DESTDIR)$(bindir)
 
 # man page
 install-man: install-manx
@@ -88,7 +90,7 @@
 	&& CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
 $(TARGET) : $(OBJECTS)
-	$(LINK.c) -o $@ $^ $(LIBS) 
+	$(LINK.c) $(OUTOPT)$@ $^ $(LIBS) 
 
 ifeq (,$(MAKECMDGOALS))
 -include $(DEPS)



--- misc/build/icu/source/common/Makefile.in	2002-08-12 21:30:14.000000000 +0100
+++ misc/build/icu/source/common/Makefile.in	2004-04-05 20:04:50.000000000 +0100
@@ -1,10 +1,10 @@
 #******************************************************************************
 #
-#   Copyright (C) 1999, International Business Machines
+#   Copyright (C) 1999-2004, International Business Machines
 #   Corporation and others.  All Rights Reserved.
 #
 #******************************************************************************
-## Makefile.in for ICU - icu.so
+## Makefile.in for ICU - icuuc.so
 ## Stephen F. Booth
 
 ## Source directory information
@@ -24,14 +24,20 @@
 
 ## Target information
 
+TARGET_STUBNAME=uc
+
 ifneq ($(ENABLE_STATIC),)
-TARGET = $(LIBICU)uc$(ICULIBSUFFIX).a
+TARGET = $(LIBDIR)/$(LIBSICU)$(TARGET_STUBNAME)$(ICULIBSUFFIX).$(A)
 endif
 
 ifneq ($(ENABLE_SHARED),)
-SO_TARGET = $(LIBICU)uc$(ICULIBSUFFIX).$(SO)
+SO_TARGET = $(LIBDIR)/$(LIBICU)$(TARGET_STUBNAME)$(ICULIBSUFFIX).$(SO)
 ALL_SO_TARGETS = $(SO_TARGET) $(MIDDLE_SO_TARGET) $(FINAL_SO_TARGET)
 
+ifeq ($(ENABLE_SO_VERSION_DATA),1)
+SO_VERSION_DATA = common.res
+endif
+
 ifeq ($(OS390BATCH),1)
 BATCH_TARGET = $(BATCH_COMMON_TARGET)
 BATCH_LIBS = $(BATCH_LIBICUDT) -lm
@@ -45,9 +51,9 @@
 DYNAMICCFLAGS = $(SHAREDLIBCFLAGS)
 DYNAMICCXXFLAGS = $(SHAREDLIBCXXFLAGS)
 
-CPPFLAGS += -I. -I$(srcdir) $(LIBCPPFLAGS)
+CPPFLAGS += -I. -I$(srcdir) -I$(srcdir)/../i18n $(LIBCPPFLAGS)
 DEFS += -DU_COMMON_IMPLEMENTATION
 
 # $(LIBICUDT) is either stub data or the real DLL common data.
 LIBS = $(LIBICUDT) $(DEFAULT_LIBS)
 
@@ -99,13 +107,22 @@
 install-library: all-local
 	$(MKINSTALLDIRS) $(DESTDIR)$(libdir)
 ifneq ($(ENABLE_STATIC),)
-	$(INSTALL-L) $(TARGET) $(DESTDIR)$(libdir)/$(TARGET)
+	$(INSTALL-L) $(TARGET) $(DESTDIR)$(libdir)
 endif
 ifneq ($(ENABLE_SHARED),)
-	$(INSTALL-L) $(FINAL_SO_TARGET) $(DESTDIR)$(libdir)/$(FINAL_SO_TARGET)
+	$(INSTALL-L) $(FINAL_SO_TARGET) $(DESTDIR)$(libdir)
 ifneq ($(FINAL_SO_TARGET),$(SO_TARGET))
-	cd $(DESTDIR)$(libdir) && $(RM) $(MIDDLE_SO_TARGET) && ln -s $(FINAL_SO_TARGET) $(MIDDLE_SO_TARGET)
-	cd $(DESTDIR)$(libdir) && $(RM) $(SO_TARGET) && ln -s $(FINAL_SO_TARGET) $(SO_TARGET)
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(SO_TARGET)) && ln -s $(notdir $(FINAL_SO_TARGET)) $(notdir $(SO_TARGET))
+ifneq ($(FINAL_SO_TARGET),$(MIDDLE_SO_TARGET))
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(MIDDLE_SO_TARGET)) && ln -s $(notdir $(FINAL_SO_TARGET)) $(notdir $(MIDDLE_SO_TARGET))
+endif
+endif
+endif
+ifneq ($(IMPORT_LIB_EXT),)
+	$(INSTALL-L) $(FINAL_IMPORT_LIB) $(DESTDIR)$(libdir)
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(IMPORT_LIB)) && ln -s $(notdir $(FINAL_IMPORT_LIB)) $(notdir $(IMPORT_LIB))
+ifneq ($(MIDDLE_IMPORT_LIB),$(FINAL_IMPORT_LIB))
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(MIDDLE_IMPORT_LIB)) && ln -s $(notdir $(FINAL_IMPORT_LIB)) $(notdir $(MIDDLE_IMPORT_LIB))
 endif
 endif
 
@@ -120,7 +137,7 @@
 
 clean-local:
 	test -z "$(CLEANFILES)" || $(RMV) $(CLEANFILES)
-	$(RMV) $(OBJECTS) $(STATIC_OBJECTS) $(ALL_TARGETS)
+	$(RMV) $(OBJECTS) $(STATIC_OBJECTS) $(ALL_TARGETS) $(SO_VERSION_DATA)
 
 distclean-local: clean-local
 	$(RMV) Makefile icucfg.h unicode/platform.h
@@ -141,13 +158,13 @@
 endif
 
 ifneq ($(ENABLE_SHARED),)
-$(FINAL_SO_TARGET): $(OBJECTS)
-	$(SHLIB.cc) $(LD_SONAME) -o $@ $^ $(LIBS)
+$(FINAL_SO_TARGET): $(OBJECTS) $(SO_VERSION_DATA)
+	$(SHLIB.cc) $(LD_SONAME) $(OUTOPT)$@ $^ $(LIBS)
 
 ifeq ($(OS390BATCH),1)
 $(BATCH_TARGET): $(OBJECTS)
-	$(SHLIB.cc) $(LD_SONAME) -o $@ $^ $(BATCH_LIBS)
+	$(SHLIB.cc) $(LD_SONAME) $(OUTOPT)$@ $^ $(BATCH_LIBS)
 endif   # OS390BATCH
 
 endif   # ENABLE_SHARED
--- misc/build/icu/source/Makefile.in	2002-07-24 23:44:02.000000000 +0100
+++ misc/build/icu/source/Makefile.in	2004-04-05 20:04:48.000000000 +0100
@@ -1,6 +1,6 @@
 #******************************************************************************
 #
-#   Copyright (C) 1998-2000, International Business Machines
+#   Copyright (C) 1998-2004, International Business Machines
 #   Corporation and others.  All Rights Reserved.
 #
 #******************************************************************************
@@ -22,34 +22,27 @@
 ## Build directory information
 subdir = .
 
-AUTOCONF = @AUTOCONF@
-
-## Platform-specific setup
-include @platform_make_fragment@
+#AUTOCONF = @AUTOCONF@
 
 ## Optional directory setup
 @EXTRAS_TRUE@EXTRA = extra
-@EXTRAS_FALSE@EXTRA = 
-@LAYOUT_TRUE@LAYOUT = layout
-@LAYOUT_FALSE@LAYOUT = 
+@LAYOUT_TRUE@LAYOUT = layout layoutex
 @TESTS_TRUE@TEST = test
-@TESTS_FALSE@TEST = 
 @SAMPLES_TRUE@SAMPLE = samples
-@SAMPLES_FALSE@SAMPLE = 
 
 DOXYGEN = @DOXYGEN@
 
 ## Files to remove for 'make clean'
-CLEANFILES = *~ README
+CLEANFILES = *~ 
 
 ## Files built (autoconfed) and installed
-INSTALLED_BUILT_FILES = $(top_builddir)/config/Makefile.inc $(top_builddir)/config/icu-config @platform_make_fragment@ README $(EXTRA_DATA:%=$(DESTDIR)$(pkglibdir)/%)
+INSTALLED_BUILT_FILES = $(top_builddir)/config/Makefile.inc $(top_builddir)/config/icu-config @platform_make_fragment@ $(EXTRA_DATA:%=$(DESTDIR)$(pkglibdir)/%)
 
 ## Files built (autoconfed) but not installed
 LOCAL_BUILT_FILES = icudefs.mk
 
 DOCDIRS = common i18n
-SUBDIRS =  stubdata common i18n $(LAYOUT) tools data $(EXTRA) $(TEST) $(SAMPLE)
+SUBDIRS =  stubdata common i18n $(LAYOUT) tools data $(EXTRA) $(SAMPLE) $(TEST)
 
 SECTION = 1
 
@@ -77,6 +70,7 @@
 distclean : distclean-recursive distclean-local
 dist: dist-recursive dist-local
 check: all check-recursive check-local
+check-recursive: all
 
 ifeq ($(DOXYGEN),)
 doc:
@@ -95,8 +89,11 @@
 LOCAL_SUBDIRS = $(SUBDIRS)
 CLEAN_FIRST_SUBDIRS = tools
 
+$(LIBDIR) $(BINDIR):
+	-$(MKINSTALLDIRS) $@
+
 ## Recursive targets
-all-recursive install-recursive clean-recursive distclean-recursive dist-recursive check-recursive:
+all-recursive install-recursive clean-recursive distclean-recursive dist-recursive check-recursive: $(LIBDIR) $(BINDIR)
 	@dot_seen=no; \
 	target=`echo $@ | sed s/-recursive//`; \
 	list='$(LOCAL_SUBDIRS)'; for subdir in $$list; do \
@@ -118,7 +115,7 @@
 
 all-local: $(srcdir)/configure $(LOCAL_BUILT_FILES) $(INSTALLED_BUILT_FILES)
 
-install-local: install-icu install-doc install-manx
+install-local: install-icu install-manx
 
 install-icu: $(INSTALLED_BUILT_FILES)
 	@$(MKINSTALLDIRS) $(DESTDIR)$(pkgdatadir)/config
@@ -131,8 +128,8 @@
 	    $(RM) Makefile.inc && ln -s current/Makefile.inc .
 	$(INSTALL_DATA) @platform_make_fragment@ $(DESTDIR)$(pkgdatadir)/config/@platform_make_fragment_name@
 	$(INSTALL_SCRIPT) $(top_srcdir)/mkinstalldirs $(DESTDIR)$(pkgdatadir)/mkinstalldirs
-	$(INSTALL_DATA) README $(DESTDIR)$(pkgdatadir)/README
-	$(INSTALL_PROGRAM) $(top_builddir)/config/icu-config $(DESTDIR)$(bindir)/icu-config
+	$(INSTALL_DATA) $(top_srcdir)/../license.html $(DESTDIR)$(pkgdatadir)/license.html
+	$(INSTALL_SCRIPT) $(top_builddir)/config/icu-config $(DESTDIR)$(bindir)/icu-config
 
 ifeq ($(DOXYGEN),)
 install-doc:
@@ -154,7 +151,7 @@
 
 distclean-local: clean-local
 	$(RMV) Makefile config/Makefile icudefs.mk
-	$(RMV) $(top_builddir)/config/Makefile.inc
+	$(RMV) $(top_builddir)/config/Makefile.inc $(top_builddir)/config/icu-config
 	$(RMV) config.cache config.log config.status
 
 check-local:
@@ -166,10 +163,6 @@
 	cd $(top_builddir) \
 		&& CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
 
-README: $(srcdir)/README.in  $(top_builddir)/config.status
-	cd $(top_builddir) \
-		&& CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
-
 Makefile: $(srcdir)/Makefile.in icudefs.mk $(top_builddir)/config.status
 	cd $(top_builddir) \
 		&& CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
@@ -187,9 +180,18 @@
 	cat $(top_srcdir)/config/icu-config-bottom >> $@
 	echo "# Rebuilt on "`date` >> $@
 
-config.status: $(srcdir)/configure
-	$(SHELL) ./config.status --recheck
+config.status: $(srcdir)/configure $(srcdir)/common/unicode/uversion.h
+	@echo
+	@echo
+	@echo "*** config.status has become stale ***"
+	@echo "   'configure' and/or 'uversion.h' have changed, please"
+	@echo "  do 'runConfigureICU' (or 'configure') again, as per"
+	@echo "  the readme.html."
+	@echo
+	@echo
+	exit 1
+
 
 install-manx: $(MANX_FILES)
 	$(MKINSTALLDIRS) $(DESTDIR)$(mandir)/man$(SECTION)
--- misc/build/icu/source/layout/Makefile.in	2002-07-20 00:24:32.000000000 +0100
+++ misc/build/icu/source/layout/Makefile.in	2004-04-05 20:05:18.000000000 +0100
@@ -1,8 +1,7 @@
+## Copyright (c) 1999-2004, International Business Machines Corporation and
+## others. All Rights Reserved.
 ## Makefile.in for ICU - layout
 
-SO_TARGET_VERSION = @LIB_VERSION@
-SO_TARGET_VERSION_MAJOR = @LIB_VERSION_MAJOR@
-
 ## Install directory information
 srcdir = @srcdir@
 top_srcdir = @top_srcdir@
@@ -22,22 +21,31 @@
 TARGET_STUBNAME=le
 
 ifneq ($(ENABLE_STATIC),)
-TARGET = $(LIBICU)$(TARGET_STUBNAME)$(ICULIBSUFFIX).a
+TARGET = $(LIBDIR)/$(LIBSICU)$(TARGET_STUBNAME)$(ICULIBSUFFIX).$(A)
 endif
 
 ifneq ($(ENABLE_SHARED),)
-SO_TARGET = $(LIBICU)$(TARGET_STUBNAME)$(ICULIBSUFFIX).$(SO)
+SO_TARGET = $(LIBDIR)/$(LIBICU)$(TARGET_STUBNAME)$(ICULIBSUFFIX).$(SO)
 ALL_SO_TARGETS = $(SO_TARGET) $(MIDDLE_SO_TARGET) $(FINAL_SO_TARGET)
+
+ifeq ($(ENABLE_SO_VERSION_DATA),1)
+SO_VERSION_DATA = layout.res
 endif
 
-ALL_TARGETS = $(TARGET) $(ALL_SO_TARGETS)
+ifeq ($(OS390BATCH),1)
+BATCH_TARGET = $(BATCH_LAYOUT_TARGET)
+BATCH_LIBS = $(BATCH_LIBICUUC) -lm
+endif   # OS390BATCH
+
+endif   # ENABLE_SHARED
+
+ALL_TARGETS = $(TARGET) $(ALL_SO_TARGETS) $(BATCH_TARGET)
 
 DYNAMICCPPFLAGS = $(SHAREDLIBCPPFLAGS)
 DYNAMICCFLAGS = $(SHAREDLIBCFLAGS)
 DYNAMICCXXFLAGS = $(SHAREDLIBCXXFLAGS)
 
-CPPFLAGS += -I$(srcdir) -I$(top_builddir)/common -I$(srcdir)/unicode -I$(srcdir)/.. -I$(top_builddir)/common -I$(top_srcdir)/common $(LIBCPPFLAGS)
+CPPFLAGS += -I$(srcdir) -I$(top_builddir)/common -I$(top_srcdir)/common -I$(srcdir)/unicode -I$(srcdir)/.. $(LIBCPPFLAGS)
 DEFS += -DU_LAYOUT_IMPLEMENTATION
-LIBS = $(DEFAULT_LIBS)
-
+LIBS = $(LIBICUUC) $(DEFAULT_LIBS)
 
@@ -106,7 +119,7 @@
 DEPS = $(OBJECTS:.o=.d)
 
 ## Header files to install
-HEADERS= $(srcdir)/*LayoutEngine.h $(srcdir)/LE*.h
+HEADERS= $(srcdir)/LayoutEngine.h $(srcdir)/LE*.h
 LOHEADERS= $(srcdir)/unicode/loengine.h
 
 ## List of phony targets
@@ -132,15 +145,25 @@
 install-library: all-local
 	$(MKINSTALLDIRS) $(DESTDIR)$(libdir)
 ifneq ($(ENABLE_STATIC),)
-	$(INSTALL-L) $(TARGET) $(DESTDIR)$(libdir)/$(TARGET)
+	$(INSTALL-L) $(TARGET) $(DESTDIR)$(libdir)
 endif
 ifneq ($(ENABLE_SHARED),)
-	$(INSTALL-L) $(FINAL_SO_TARGET) $(DESTDIR)$(libdir)/$(FINAL_SO_TARGET)
+	$(INSTALL-L) $(FINAL_SO_TARGET) $(DESTDIR)$(libdir)
 ifneq ($(FINAL_SO_TARGET),$(SO_TARGET))
-	cd $(DESTDIR)$(libdir) && $(RM) $(MIDDLE_SO_TARGET) && ln -s $(FINAL_SO_TARGET) $(MIDDLE_SO_TARGET)
-	cd $(DESTDIR)$(libdir) && $(RM) $(SO_TARGET) && ln -s $(FINAL_SO_TARGET) $(SO_TARGET)
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(SO_TARGET)) && ln -s $(notdir $(FINAL_SO_TARGET)) $(notdir $(SO_TARGET))
+ifneq ($(FINAL_SO_TARGET),$(MIDDLE_SO_TARGET))
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(MIDDLE_SO_TARGET)) && ln -s $(notdir $(FINAL_SO_TARGET)) $(notdir $(MIDDLE_SO_TARGET))
+endif
 endif
 endif
+ifneq ($(IMPORT_LIB_EXT),)
+	$(INSTALL-L) $(FINAL_IMPORT_LIB) $(DESTDIR)$(libdir)
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(IMPORT_LIB)) && ln -s $(notdir $(FINAL_IMPORT_LIB)) $(notdir $(IMPORT_LIB))
+ifneq ($(MIDDLE_IMPORT_LIB),$(FINAL_IMPORT_LIB))
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(MIDDLE_IMPORT_LIB)) && ln -s $(notdir $(FINAL_IMPORT_LIB)) $(notdir $(MIDDLE_IMPORT_LIB))
+endif
+endif
+
 
 install-headers:
 	$(MKINSTALLDIRS) $(DESTDIR)$(includedir)/layout
@@ -157,8 +180,7 @@
 
 clean-local:
 	test -z "$(CLEANFILES)" || $(RMV) $(CLEANFILES)
-	$(RMV) $(OBJECTS) $(ALL_TARGETS)
-#	$(RMV) $(OBJECTS) $(STATIC_OBJECTS) $(ALL_TARGETS)
+	$(RMV) $(OBJECTS) $(ALL_TARGETS) $(SO_VERSION_DATA)
 
 distclean-local: clean-local
 	$(RMV) Makefile
@@ -175,9 +197,15 @@
 endif
 
 ifneq ($(ENABLE_SHARED),)
-$(FINAL_SO_TARGET): $(OBJECTS)
-	$(SHLIB.cc) $(LD_SONAME) -o $@ $^ $(LIBS)
+$(FINAL_SO_TARGET): $(OBJECTS) $(SO_VERSION_DATA)
+	$(SHLIB.cc) $(LD_SONAME) $(OUTOPT)$@ $^ $(LIBS)
+
+ifeq ($(OS390BATCH),1)
+$(BATCH_TARGET): $(OBJECTS)
+	$(SHLIB.cc) $(LD_SONAME) $(OUTOPT)$@ $^ $(BATCH_LIBS)
+endif   # OS390BATCH
+
 endif
 
 ifeq (,$(MAKECMDGOALS))
--- misc/build/icu/source/stubdata/Makefile.in	2002-05-21 23:41:42.000000000 +0100
+++ misc/build/icu/source/stubdata/Makefile.in	2004-04-05 20:05:27.000000000 +0100
@@ -1,6 +1,6 @@
 #******************************************************************************
 #
-#   Copyright (C) 1999, International Business Machines
+#   Copyright (C) 1999-2004, International Business Machines
 #   Corporation and others.  All Rights Reserved.
 #
 #******************************************************************************
@@ -24,12 +24,14 @@
 
 ## Target information
 
+TARGET_STUBNAME=data
+
 ifneq ($(ENABLE_STATIC),)
-TARGET = lib$(ICUPREFIX)data$(ICULIBSUFFIX).a
+TARGET = $(LIBDIR)/$(LIBSICU)$(TARGET_STUBNAME)$(ICULIBSUFFIX).$(A)
 endif
 
 ifneq ($(ENABLE_SHARED),)
-SO_TARGET = lib$(ICUPREFIX)data$(ICULIBSUFFIX)$(STUB_SUFFIX).$(SO)
+SO_TARGET = $(LIBDIR)/$(LIBICU)$(TARGET_STUBNAME)$(ICULIBSUFFIX)$(STUB_SUFFIX).$(SO)
 ALL_SO_TARGETS = $(SO_TARGET) $(MIDDLE_SO_TARGET) $(FINAL_SO_TARGET) $(BATCH_STUB_TARGET)
 endif
 
@@ -73,13 +75,22 @@
 install-library: all-local
 	$(MKINSTALLDIRS) $(DESTDIR)$(libdir)
 ifneq ($(ENABLE_STATIC),)
-	$(INSTALL-L) $(TARGET) $(DESTDIR)$(libdir)/$(TARGET)
+	$(INSTALL-L) $(TARGET) $(DESTDIR)$(libdir)
 endif
 ifneq ($(ENABLE_SHARED),)
-	$(INSTALL-L) $(FINAL_SO_TARGET) $(DESTDIR)$(libdir)/$(FINAL_SO_TARGET)
+	$(INSTALL-L) $(FINAL_SO_TARGET) $(DESTDIR)$(libdir)
 ifneq ($(FINAL_SO_TARGET),$(SO_TARGET))
-	cd $(DESTDIR)$(libdir) && $(RM) $(MIDDLE_SO_TARGET) && ln -s $(FINAL_SO_TARGET) $(MIDDLE_SO_TARGET)
-	cd $(DESTDIR)$(libdir) && $(RM) $(SO_TARGET) && ln -s $(FINAL_SO_TARGET) $(SO_TARGET)
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(SO_TARGET)) && ln -s $(notdir $(FINAL_SO_TARGET)) $(notdir $(SO_TARGET))
+ifneq ($(FINAL_SO_TARGET),$(MIDDLE_SO_TARGET))
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(MIDDLE_SO_TARGET)) && ln -s $(notdir $(FINAL_SO_TARGET)) $(notdir $(MIDDLE_SO_TARGET))
+endif
+endif
+endif
+ifneq ($(IMPORT_LIB_EXT),)
+	$(INSTALL-L) $(FINAL_IMPORT_LIB) $(DESTDIR)$(libdir)
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(IMPORT_LIB)) && ln -s $(notdir $(FINAL_IMPORT_LIB)) $(notdir $(IMPORT_LIB))
+ifneq ($(MIDDLE_IMPORT_LIB),$(FINAL_IMPORT_LIB))
+	cd $(DESTDIR)$(libdir) && $(RM) $(notdir $(MIDDLE_IMPORT_LIB)) && ln -s $(notdir $(FINAL_IMPORT_LIB)) $(notdir $(MIDDLE_IMPORT_LIB))
 endif
 endif
 
@@ -110,11 +121,11 @@
 
 ifneq ($(ENABLE_SHARED),)
 $(FINAL_SO_TARGET): $(OBJECTS)
-	$(SHLIB.c) $(LD_SONAME) -o $@ $^ $(LIBS)
+	$(SHLIB.c) $(LD_SONAME) $(OUTOPT)$@ $^ $(LIBS)
 
 ifeq ($(OS390BATCH),1)
 $(BATCH_STUB_TARGET): $(OBJECTS)
-	$(SHLIB.c) $(LD_SONAME) -o $@ $^ $(LIBS)
+	$(SHLIB.c) $(LD_SONAME) $(OUTOPT)$@ $^ $(LIBS)
 endif   # OS390BATCH
 endif
 
