Index: vcl/util/makefile.mk
===================================================================
RCS file: /cvs/gsl/vcl/util/makefile.mk,v
retrieving revision 1.46.2.1
diff -u -p -u -r1.46.2.1 makefile.mk
--- vcl/util/makefile.mk	21 Jul 2003 14:48:45 -0000	1.46.2.1
+++ vcl/util/makefile.mk	13 Aug 2003 15:36:19 -0000
@@ -313,6 +317,10 @@ SHL1STDLIBS += -laudio
 SHL1STDLIBS += -ldl -lnsl -lsocket
 .ENDIF # SOLARIS
 .ENDIF          # "$(OS)"=="LINUX" || "$(OS)"=="SOLARIS" || "$(OS)"=="FREEBSD"
+
+.IF "$(GUIBASE)"=="unx"
+SHL1STDLIBS += `pkg-config --libs gtk+-2.0`
+.ENDIF
 
 .ENDIF          # "$(GUI)"=="UNX"
 
Index: vcl/unx/source/app/saldisp.cxx
===================================================================
RCS file: /cvs/gsl/vcl/unx/source/app/saldisp.cxx,v
retrieving revision 1.43.26.2
diff -u -p -u -r1.43.26.2 saldisp.cxx
--- vcl/unx/source/app/saldisp.cxx	29 Jul 2003 12:45:39 -0000	1.43.26.2
+++ vcl/unx/source/app/saldisp.cxx	13 Aug 2003 15:36:55 -0000
@@ -241,6 +241,11 @@ extern "C" {
 #  include <libsn/sn.h>
 #endif
 
+#ifndef DISABLE_GTK_INTEGRATION
+#  include <gdk/gdkx.h>
+#  include <gtk/gtk.h>
+#endif
+
 #include <postx.h>
 
 #include <salunx.h>
@@ -739,6 +744,54 @@ extern "C" {
 }
 #endif /* HAVE_LIBSN */
 
+#ifndef DISABLE_GTK_INTEGRATION
+
+extern "C" {
+    static GdkFilterReturn
+    sal_gdk_filter_func (GdkXEvent *sys_event,
+			 GdkEvent  *event,
+			 gpointer   data)
+    {
+	XEvent *xevent = (XEvent *)sys_event;
+	SalDisplay *pDisplay = (SalDisplay *) data;
+	GdkDisplay *pGdkDisplay = (GdkDisplay *) pDisplay->GetGdkDisplay();
+
+//	fprintf (stderr, "event type 0x%2x: ", xevent->type);
+//	if (pDisplay->GetDisplay() != xevent->xany.display)
+//            fprintf( stderr, "another display (%p): ", xevent->xany.display);
+
+	if (pDisplay->GetDisplay() != xevent->xany.display &&
+	    gdk_window_lookup_for_display (pGdkDisplay, xevent->xany.window)) {
+//	    fprintf( stderr, "GDK: Event on '%ld'\n", xevent->xany.window );
+	    return GDK_FILTER_CONTINUE;
+
+	} else {
+	    SalXEvent aEvent;
+	    aEvent.event_ = *xevent;
+
+//            fprintf( stderr, "VCL: Event on '%ld'\n", xevent->xany.window );
+
+	    SalYieldMutex* pSalInstYieldMutex	=
+		    GetSalData()->pFirstInstance_->maInstData.mpSalYieldMutex;
+	    ::vos::OGuard aGuard( *pSalInstYieldMutex );
+
+	    pDisplay->DispatchXEvent( aEvent );
+
+	    if (pDisplay->GetDisplay() != xevent->xany.display)
+		    return GDK_FILTER_CONTINUE;
+	    else
+		    return GDK_FILTER_REMOVE;
+	}
+    }
+}
+
+struct _GdkDisplay *
+SalDisplay::GetGdkDisplay()
+{
+	return gdk_x11_lookup_xdisplay( pDisp_ );
+}
+#endif /* DISABLE_GTK_INTEGRATION */
+
 SalDisplay::SalDisplay( Display *display, Visual *pVisual, Colormap aColMap ) : 
 		pDisp_( display ),
 		mpFallbackFactory ( NULL ),
@@ -760,6 +813,10 @@ SalDisplay::SalDisplay( Display *display
 #endif
     nScreen_  = DefaultScreen( pDisp_ );
 
+#ifndef DISABLE_GTK_INTEGRATION
+	gdk_window_add_filter( NULL, sal_gdk_filter_func, this );
+#endif
+
 	if (!aColMap)
 		aColMap = DefaultColormap( display, nScreen_ );
     if( !IsDisplay() && !aColMap)
@@ -834,6 +891,12 @@ SalDisplay::~SalDisplay( )
 
 		delete mpInputMethod;
 		delete mpKbdExtension;
+
+#ifndef DISABLE_GTK_INTEGRATION
+	gdk_window_remove_filter( NULL, sal_gdk_filter_func, this );
+	g_object_unref( GetGdkDisplay() );
+#endif
+
         XCloseDisplay( pDisp_ );
     }
 
@@ -2554,13 +2628,41 @@ BOOL SalDisplay::IsEvent()
     if( pEventQueue_ )
         return TRUE;
 
+#ifdef DISABLE_GTK_INTEGRATION
     if( XEventsQueued( pDisp_, QueuedAlready ) )
         return TRUE;
 
     XFlush( pDisp_ );
+#endif
     return FALSE;
 }
 
+
+#ifndef DISABLE_GTK_INTEGRATION
+void SalDisplay::DispatchXEvent( SalXEvent &rEvent )
+{
+    nStateOfYield_ = 0;
+    BOOL bIgnoreXErrors = pXLib_->GetIgnoreXErrors();
+ 
+    rEvent.pNext_   = pDispatchStack_;
+    pDispatchStack_ = &rEvent;
+ 
+    Dispatch( &rEvent.event_ );
+ 
+    pDispatchStack_ = rEvent.pNext_;
+ 
+#ifdef DBG_UTIL
+    if( pXLib_->WasXError() )
+    {
+	XFlush( pDisp_ );
+	PrintEvent( "SalDisplay::Yield (WasXError)", &rEvent.event_ );
+    }
+#endif
+ 
+    pXLib_->SetIgnoreXErrors( bIgnoreXErrors );
+}
+#endif
+
 // -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
 
 void SalDisplay::Yield( BOOL bWait )
@@ -2601,6 +2703,15 @@ void SalDisplay::Yield( BOOL bWait )
 				   NAMESPACE_VOS(OThread)::getCurrentIdentifier(),
 					"will crash soon since solar mutex not locked in SalDisplay::Yield" );
 		
+#ifndef DISABLE_GTK_INTEGRATION
+		nStateOfYield_ = 0;
+		return; // Handled later by gdk.
+    } // while
+    DispatchXEvent( aEvent );
+#else
+       // note: alternate input is dispatched by XtAppNextEvent
+       XNextEvent( pDisp_, &aEvent.event_ );
+
 		// note: alternate input is dispatched by XtAppNextEvent
 		XNextEvent( pDisp_, &aEvent.event_ );		
 
@@ -2615,6 +2726,7 @@ void SalDisplay::Yield( BOOL bWait )
 		if( sn_display_process_event( m_pSnDisplay, &aEvent.event_ ) )
 			return;
 #endif /* HAVE_LIBSN */
+
 	}
 
     nStateOfYield_ = 0;
@@ -2637,6 +2749,7 @@ void SalDisplay::Yield( BOOL bWait )
 #endif
 
     pXLib_->SetIgnoreXErrors( bIgnoreXErrors );
+#endif /* DISABLE_GTK_INTEGRATION */
 }
 
 long SalDisplay::Dispatch( XEvent *pEvent )
Index: vcl/unx/source/app/saldata.cxx
===================================================================
RCS file: /cvs/gsl/vcl/unx/source/app/saldata.cxx,v
retrieving revision 1.25.50.1
diff -u -p -u -r1.25.50.1 saldata.cxx
--- vcl/unx/source/app/saldata.cxx	21 Jul 2003 14:48:43 -0000	1.25.50.1
+++ vcl/unx/source/app/saldata.cxx	13 Aug 2003 15:37:29 -0000
@@ -98,6 +98,11 @@
 
 #include <prex.h>
 
+#ifndef DISABLE_GTK_INTEGRATION
+#  include <gtk/gtk.h>
+#  include <gdk/gdkx.h>
+#endif
+
 // [ed] 6/15/02 There's a conflicting definition of INT8 within the Xmd.h header
 // and the solar.h OOo header.  So, wrap the X11 header with a bogus #define
 // to use the OOo definition of the symbol for INT8.
@@ -533,6 +544,11 @@ void SalXLib::Init( int *pArgc, char *pp
 	 */
 	
 	Display *pDisp = NULL;
+	struct _GdkDisplay *pGdkDisp = NULL;
+	
+#ifndef DISABLE_GTK_INTEGRATION
+	gtk_init_check( NULL, NULL );
+#endif
 
 	// is there a -display command line parameter?
 	vos::OExtCommandLine aCommandLine;
@@ -547,7 +563,11 @@ void SalXLib::Init( int *pArgc, char *pp
 			aCommandLine.getCommandArg(i+1, aParam);
 			aDisplay = rtl::OUStringToOString(
 				   aParam, osl_getThreadTextEncoding());
+#ifndef DISABLE_GTK_INTEGRATION
+			if ((pGdkDisp = gdk_display_open( aDisplay.getStr() )) != NULL)
+#else
 			if ((pDisp = XOpenDisplay(aDisplay.getStr()))!=NULL)
+#endif
 			{
 				/*
 			 	* if a -display switch was used, we need
@@ -564,15 +584,30 @@ void SalXLib::Init( int *pArgc, char *pp
 		}
 	}
 
-	if (!pDisp && !aDisplay.getLength()) 
+	if (!pDisp && !pGdkDisp && !aDisplay.getLength()) 
 	{
 		// Open $DISPLAY or default...
 		char *pDisplay = getenv("DISPLAY");
 		if (pDisplay != NULL)
 			aDisplay = rtl::OString(pDisplay);
-		pDisp  = XOpenDisplay(pDisplay);
+#ifndef DISABLE_GTK_INTEGRATION
+		pGdkDisp = gdk_display_open(pDisplay);
+#else
+		pDisp = XOpenDisplay(pDisplay);
+#endif
 	}
 
+#ifndef DISABLE_GTK_INTEGRATION
+	pDisp = gdk_x11_display_get_xdisplay(pGdkDisp);
+
+	fprintf( stderr, "Open display %p (%p): '%s'\n", this, pGdkDisp,
+		 DisplayString( pDisp ) );
+
+	GtkWidget *a = gtk_window_new (GTK_WINDOW_TOPLEVEL);
+	gtk_container_add (GTK_CONTAINER (a), gtk_button_new_with_label ("Foo"));
+	gtk_widget_show_all (a);
+#endif
+
 	if ( !pDisp )
 	{
 	    rtl::OUString aProgramFileURL = pSalData->GetCommandLineParam(0);
Index: vcl/unx/source/app/makefile.mk
===================================================================
RCS file: /cvs/gsl/vcl/unx/source/app/makefile.mk,v
retrieving revision 1.9.232.1
diff -u -p -u -r1.9.232.1 makefile.mk
--- vcl/unx/source/app/makefile.mk	21 Jul 2003 14:48:43 -0000	1.9.232.1
+++ vcl/unx/source/app/makefile.mk	14 Aug 2003 16:07:07 -0000
@@ -95,6 +95,7 @@ SLOFILES=\
 			$(SLO)$/i18n_keysym.obj		\
 			$(SLO)$/salmain.obj			\
 			$(SLO)$/saldata.obj			\
+			$(SLO)$/salgxlib.obj			\
 			$(SLO)$/saltimer.obj		\
 			$(SLO)$/saldisp.obj			\
 			$(SLO)$/salinst.obj			\
@@ -128,6 +131,8 @@ SLOFILES+=$(SLO)$/getfpsoli.obj
 SLOFILES=\
 			$(SLO)$/salmain.obj
 .ENDIF
+
+CFLAGS+=`pkg-config --cflags gtk+-2.0`
 
 .IF "$(remote)"!=""
 EXCEPTIONSFILES=$(SLO)$/salmain.obj	\
Index: vcl/unx/inc/saldisp.hxx
===================================================================
RCS file: /cvs/gsl/vcl/unx/inc/saldisp.hxx,v
retrieving revision 1.16.104.1
diff -u -p -u -r1.16.104.1 saldisp.hxx
--- vcl/unx/inc/saldisp.hxx	21 Jul 2003 14:48:42 -0000	1.16.104.1
+++ vcl/unx/inc/saldisp.hxx	14 Aug 2003 16:10:10 -0000
@@ -428,6 +432,11 @@ public:
 										Colormap aColMap = None);
     
     ~SalDisplay();
+
+#ifndef DISABLE_GTK_INTEGRATION
+    void                        DispatchXEvent( SalXEvent &rEvent );
+    struct _GdkDisplay         *GetGdkDisplay();
+#endif
     
     void			Init( Colormap hXColmap, const XVisualInfo* pXVI );
     
