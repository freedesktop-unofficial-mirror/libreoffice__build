--- /dev/null	2003-08-27 00:50:28.000000000 +0200
+++ berkeleydb/prj/d.lst.in	2003-10-28 12:54:31.000000000 +0100
@@ -0,0 +1,24 @@
+mkdir: %_DEST%\inc%_EXT%\berkeleydb
+
+..\%__SRC%\inc\cxx_common.h %_DEST%\inc%_EXT%\berkeleydb\cxx_common.h
+..\%__SRC%\inc\cxx_except.h %_DEST%\inc%_EXT%\berkeleydb\cxx_exc
+..\%__SRC%\inc\db_cxx.h %_DEST%\inc%_EXT%\berkeleydb\db_cxx.h
+..\%__SRC%\inc\db_185.h %_DEST%\inc%_EXT%\berkeleydb\db_185.h
+..\%__SRC%\inc\db.h %_DEST%\inc%_EXT%\berkeleydb\db.h
+
+..\%__SRC%\lib\libdb32.lib %_DEST%\lib%_EXT%\libdb32.lib
+..\%__SRC%\lib\libdb_java32.lib %_DEST%\lib%_EXT%\libdb_java32.lib
+
+..\%__SRC%\lib\libdb-@DB_VERSION@.so %_DEST%\lib%_EXT%\libdb-@DB_VERSION@.so
+..\%__SRC%\lib\libdb_java-@DB_VERSION@.so %_DEST%\lib%_EXT%\libdb_java-@DB_VERSION@.so
+..\%__SRC%\lib\libdb_cxx-@DB_VERSION@.so %_DEST%\lib%_EXT%\libdb_cxx-@DB_VERSION@.so
+
+..\%__SRC%\lib\libdb-3.2.dylib %_DEST%\lib%_EXT%\libdb-3.2.dylib
+..\%__SRC%\lib\libdb_java-3.2.dylib %_DEST%\lib%_EXT%\libdb_java-3.2.dylib
+..\%__SRC%\lib\libdb_cxx-3.2.dylib %_DEST%\lib%_EXT%\libdb_cxx-3.2.dylib
+
+..\%__SRC%\bin\libdb32.dll %_DEST%\bin%_EXT%\libdb32.dll
+..\%__SRC%\bin\libdb_java32.dll %_DEST%\bin%_EXT%\libdb_java32.dll
+
+..\%__SRC%\bin\db.jar %_DEST%\bin%_EXT%\db.jar
+
Index: makefile.mk
===================================================================
RCS file: /cvs/external/berkeleydb/makefile.mk,v
retrieving revision 1.13
diff -u -r1.13 makefile.mk
--- berkeleydb/makefile.mk	12 Jun 2003 09:50:38 -0000	1.13
+++ berkeleydb/makefile.mk	29 Oct 2003 01:09:05 -0000
@@ -77,6 +77,7 @@
 PATCH_FILE_NAME=db-3.2.9.patch
 
 .IF "$(GUI)"=="UNX"
+.IF "$(SYSTEM_DB)" != "YES"
 CONFIGURE_DIR=out
 #relative to CONFIGURE_DIR
 CONFIGURE_ACTION=..$/dist$/configure
@@ -93,12 +94,34 @@ BUILD_ACTION=gmake
 BUILD_ACTION=make
 .ENDIF
 
+.ENDIF
+
+.IF "$(SYSTEM_DB)" != "YES"
 OUT2LIB=$(BUILD_DIR)$/.libs$/libdb*$(DLLPOST)
 
 .IF "$(SOLAR_JAVA)"!=""
 OUT2BIN=java$/classes$/db.jar
 .ENDIF
+.ELSE
+.IF "$(SOLAR_JAVA)" != ""
+DB_JAR = \
+       $/usr$/share$/java$/db-$(DB_VERSION).jar
+.ENDIF
 
+DB_LIB = \
+       $/usr$/lib$/libdb-$(DB_VERSION).so \
+       $/usr$/lib$/libdb_cxx-$(DB_VERSION).so
+.IF "$(SOLAR_JAVA)" != ""
+       DB_LIB += $/usr$/lib$/libdb_java-$(DB_VERSION).so
+.ENDIF
+
+all: $(DB_JAR) $(DB_INC) $(DB_LIB)
+.IF "$(SOLAR_JAVA)" != ""
+      +$(COPY) $(DB_JAR) $(BIN)/db.jar
+      +$(COPY) $(DB_JAR) $(CLASSDIR)/db.jar
+.ENDIF
+
+.ENDIF
 .ENDIF			# "$(GUI)"=="UNX"
 
 .IF "$(GUI)"=="WNT"
Index: xmlhelp/source/com/sun/star/help/HelpDatabases.java
===================================================================
--- xmlhelp/source/com/sun/star/help/HelpDatabases.java.orig	2003-03-27 19:07:28.000000000 +0100
+++ xmlhelp/source/com/sun/star/help/HelpDatabases.java	2004-01-08 00:36:53.000000000 +0100
@@ -239,7 +239,7 @@ public final class HelpDatabases
 				table = new Db( null,0 );
 
 				String tablePath = _installDirectory + key + ".db";
-				table.open( tablePath,null,Db.DB_BTREE,Db.DB_RDONLY,0644 );
+				table.open( DB_TXNID tablePath,null,Db.DB_BTREE,Db.DB_RDONLY,0644 );
 				_dbHash.put( key,table );
             }
             catch( DbException e )
@@ -274,7 +274,7 @@ public final class HelpDatabases
 				table = new Db( null,0 );
 
 				String tablePath = _installDirectory + key + ".ht";
-				table.open( tablePath,null,Db.DB_BTREE,Db.DB_RDONLY,0644 );
+				table.open( DB_TXNID tablePath,null,Db.DB_BTREE,Db.DB_RDONLY,0644 );
 				_dbHash.put( key,table );
             }
             catch( DbException e )
@@ -517,8 +517,8 @@ public final class HelpDatabases
 				String fileName = HelpDatabases.getInstallDirectory() + keyStr + ".key";
         		Db table = new Db( null,0 );
 				System.err.println( fileName );
-				table.open( fileName,null,Db.DB_BTREE,Db.DB_RDONLY,0644 );
+				table.open( DB_TXNID fileName,null,Db.DB_BTREE,Db.DB_RDONLY,0644 );
 				Dbc cursor = table.cursor( null,0 );
 				StringDbt key = new StringDbt();
 				StringDbt data = new StringDbt();

--- xmlhelp/source/com/sun/star/help/HelpIndexer.java.system-db	2003-03-27 13:07:28.000000000 -0500
+++ xmlhelp/source/com/sun/star/help/HelpIndexer.java	2003-08-26 02:27:58.000000000 -0400
@@ -150,7 +150,7 @@ public class HelpIndexer {
                     		+ _module
                        		+ ".db";
 
-			table.open( fileName,null,Db.DB_BTREE,Db.DB_RDONLY,0644 );
+			table.open( DB_TXNID fileName,null,Db.DB_BTREE,Db.DB_RDONLY,0644 );
 			Dbc cursor = table.cursor( null,0 );
 			StringDbt key = new StringDbt();
 			StringDbt data = new StringDbt();
@@ -440,7 +440,7 @@ public class HelpIndexer {
                     		      + _module
                        		      + ".key";
 
-				table.open( fileName,null,Db.DB_BTREE,Db.DB_CREATE,0644 );
+				table.open( DB_TXNID fileName,null,Db.DB_BTREE,Db.DB_CREATE,0644 );
 
             	for( int i = 0; i < list.length; ++i )
             	{
@@ -481,8 +481,8 @@ public class HelpIndexer {
                     		+ _module
                        		+ ".ht";
 
-			table.open( fileName,null,Db.DB_BTREE,Db.DB_CREATE,0644 );
+			table.open( DB_TXNID fileName,null,Db.DB_BTREE,Db.DB_CREATE,0644 );
 
             for( int i = 0; i < list.length; ++i )
             {

--- xmlhelp/source/com/sun/star/help/CreateDb.java.system-db	2000-11-20 07:08:42.000000000 -0500
+++ xmlhelp/source/com/sun/star/help/CreateDb.java	2003-08-26 02:28:15.000000000 -0400
@@ -37,7 +37,7 @@ public class CreateDb {
 		table.set_errpfx( "HelpAccess" );
 		try
 		{
-			table.open( dbName,null,Db.DB_BTREE,Db.DB_RDONLY,0644 );
+			table.open( DB_TXNID dbName,null,Db.DB_BTREE,Db.DB_RDONLY,0644 );
 			Dbc cursor = table.cursor( null,0 );
 
 			StringDbt key = new StringDbt();
@@ -131,7 +131,7 @@ public class CreateDb {
       		Db table = new Db(null, 0);
       		table.set_error_stream(System.err);
       		table.set_errpfx("AccessExample");
-      		table.open("e:/rvp603b/help/helpaccess.db", null, Db.DB_HASH, Db.DB_CREATE, 0644);
+      		table.open( DB_TXNID "e:/rvp603b/help/helpaccess.db", null, Db.DB_HASH, Db.DB_CREATE, 0644);
       		StringDbt key = new StringDbt(key1);
       		StringDbt data = new StringDbt(data1);
       		try
Index: xmlhelp/source/cxxhelp/provider/makefile.mk
===================================================================
--- xmlhelp/source/cxxhelp/provider/makefile.mk.orig	2003-04-28 18:19:35.000000000 +0200
+++ xmlhelp/source/cxxhelp/provider/makefile.mk	2004-01-08 00:36:53.000000000 +0100
@@ -74,6 +74,9 @@ NO_BSYMBOLIC=TRUE
 .INCLUDE: settings.mk
 
 CFLAGS +=  -DHAVE_EXPAT_H
+.IF "$(SYSTEM_DB)" == "YES"
+CFLAGS += -DSYSTEM_DB -I$(DB_INCLUDES)
+.ENDIF
 
 .IF "$(GUI)"=="WNT"
 CFLAGS+=-GR
Index: xmlhelp/source/cxxhelp/provider/databases.cxx
===================================================================
--- xmlhelp/source/cxxhelp/provider/databases.cxx.orig	2003-04-04 19:09:36.000000000 +0200
+++ xmlhelp/source/cxxhelp/provider/databases.cxx	2004-01-08 00:36:53.000000000 +0100
@@ -60,7 +60,11 @@
  ************************************************************************/
 
 
+#ifdef SYSTEM_DB
+#include <db_cxx.h>
+#else
 #include <berkeleydb/db_cxx.h>
+#endif
 #ifndef _VOS_DIAGNOSE_HXX_
 #include <vos/diagnose.hxx>
 #endif
@@ -497,7 +501,12 @@ Db* Databases::getBerkeley( const rtl::O
 		
 		rtl::OString fileName( fileNameOU.getStr(),fileNameOU.getLength(),osl_getThreadTextEncoding() );
 		
-		if( table->open( fileName.getStr(),0,DB_BTREE,DB_RDONLY,0644 ) )
+#if DB_VERSION_MAJOR < 4 || (DB_VERSION_MAJOR == 4 && DB_VERSION_MINOR < 1)
+		int db_open_failure = table->open( fileName.getStr(),0,DB_BTREE,DB_RDONLY,0644 );
+#else
+		int db_open_failure = table->open( NULL, fileName.getStr(),0,DB_BTREE,DB_RDONLY,0644 );
+#endif
+		if( db_open_failure )
 		{
 			table->close( 0 );
 			delete table;
@@ -711,7 +720,12 @@ KeywordInfo* Databases::getKeyword( cons
                                osl_getThreadTextEncoding() );
 		
 		Db table(0,DB_CXX_NO_EXCEPTIONS);
-		if( 0 == table.open( fileName.getStr(),0,DB_BTREE,DB_RDONLY,0644 ) )
+#if DB_VERSION_MAJOR < 4 || (DB_VERSION_MAJOR == 4 && DB_VERSION_MINOR < 1)
+		int db_open_failure = table.open( fileName.getStr(),0,DB_BTREE,DB_RDONLY,0644 );
+#else
+		int db_open_failure = table.open( NULL, fileName.getStr(),0,DB_BTREE,DB_RDONLY,0644 );
+#endif
+		if( 0 == db_open_failure )
 		{   
 			std::vector<KeywordInfo::KeywordElement> aVector;
 			Db* idmap = getBerkeley( Database,Language );
Index: xmlhelp/source/cxxhelp/provider/urlparameter.cxx
===================================================================
--- xmlhelp/source/cxxhelp/provider/urlparameter.cxx.orig	2004-01-07 23:21:33.000000000 +0100
+++ xmlhelp/source/cxxhelp/provider/urlparameter.cxx	2004-01-08 00:36:53.000000000 +0100
@@ -94,8 +94,12 @@
 #include <sablot/shandler.h>
 #endif
 #ifndef _DB_CXX_H_
+#ifdef SYSTEM_DB
+#include <db_cxx.h>
+#else
 #include <berkeleydb/db_cxx.h>
 #endif
+#endif
 #ifndef _URLPARAMETER_HXX_
 #include <provider/urlparameter.hxx>
 #endif
Index: solenv/inc/libs.mk
===================================================================
--- solenv/inc/libs.mk.orig	2003-12-12 18:23:04.000000000 +0100
+++ solenv/inc/libs.mk	2004-01-08 00:36:53.000000000 +0100
@@ -180,8 +180,8 @@ ZLIB3RDLIB=-lzlib
 .ENDIF
 JPEG3RDLIB=-ljpeglib
 NEON3RDLIB=-lneon
-BERKELEYLIB=-ldb-3.2
-BERKELEYCPPLIB=-ldb_cxx-3.2
+BERKELEYLIB=-ldb-$(DB_VERSION)
+BERKELEYCPPLIB=-ldb_cxx-$(DB_VERSION)
 CURLLIB=-lcurl
 SFX2LIB=-lsfx$(OFFICEUPD)$(DLLPOSTFIX)
 SFXLIB=-lsfx$(OFFICEUPD)$(DLLPOSTFIX)
Index: files.scp
===================================================================
RCS file: /cvs/installation/scp/source/office/files.scp,v
retrieving revision 1.369.16.2.8.2
diff -u -r1.369.16.2.8.2 files.scp
--- scp/source/office/files.scp	14 Oct 2003 15:44:57 -0000	1.369.16.2.8.2
+++ scp/source/office/files.scp	2 Nov 2003 01:21:27 -0000
@@ -960,41 +960,49 @@
 
 #endif
 
+#ifndef SYSTEM_DB
+
 File GID_FILE_LIB_DB31
         TXT_FILE_BODY;
         Styles          = (PACKED);
         Dir             = GID_DIR_PROGRAM;
         #ifdef UNX
-        Name            = STRING(CONCAT2(libdb-3.2,UNXSUFFIX));
+        Name            = STRING(CONCAT3(libdb-,DB_VERSION,UNXSUFFIX));
         #else
         Name            = "libdb32.dll";
         #endif
 End
 
+#endif
+
 #ifdef SOLAR_JAVA
+#ifndef SYSTEM_DB
 
 File GID_FILE_LIB_DBJAVA31
         TXT_FILE_BODY;
         Styles          = (PACKED);
         Dir             = GID_DIR_PROGRAM;
         #ifdef UNX
-        Name            = STRING(CONCAT2(libdb_java-3.2,UNXSUFFIX));
+        Name            = STRING(CONCAT3(libdb_java-,DB_VERSION,UNXSUFFIX));
         #else
         Name            = "libdb_java32.dll";
         #endif
 End
 
 #endif
+#endif
 
 #ifdef UNX
+#ifndef SYSTEM_DB
 
 File GID_FILE_LIB_DB_CXX
         TXT_FILE_BODY;
         Styles          = (PACKED);
         Dir             = GID_DIR_PROGRAM;
-        Name            = STRING(CONCAT2(libdb_cxx-3.2,UNXSUFFIX));
+        Name            = STRING(CONCAT3(libdb_cxx-,DB_VERSION,UNXSUFFIX));
 End
 
 #endif
+#endif
 
 #ifdef UNX
 
