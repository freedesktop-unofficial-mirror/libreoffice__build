Index: vcl/source/window/window.cxx
===================================================================
RCS file: /cvs/gsl/vcl/source/window/window.cxx,v
retrieving revision 1.176
diff -u -p -u -r1.176 window.cxx
--- vcl/source/window/window.cxx	1 Jul 2003 14:48:37 -0000	1.176
+++ vcl/source/window/window.cxx	26 Aug 2003 16:51:59 -0000
@@ -206,6 +206,7 @@
 #include <dndlcon.hxx>
 #include <dndevdis.hxx>
 #include <impbmpconv.hxx>
+#include <layout.hxx>
 
 #ifndef _UNOTOOLS_CONFIGNODE_HXX_
 #include <unotools/confignode.hxx>
@@ -392,7 +393,7 @@ void Window::ImplUpdateGlobalSettings( A
         rSettings.SetStyleSettings( aStyleSettings );
     }
 
-    if( 1 )
+    if( 0 ) // This is/was an incredibly broken thing to do
     {
         // #97047: Force all fonts except Mneu and Help to a fixed height
         // to avoid UI scaling due to large fonts
@@ -1209,6 +1210,17 @@ WinBits Window::ImplInitRes( const ResId
     pRes += 4;
     ULONG nStyle = GetLongRes( (void*)pRes );
     ((ResId&)rResId).aWinBits = nStyle;
+
+    Window *pWindow = this;
+    LayoutConnector* pCnx = NULL;
+
+    while( pWindow &&
+	   !( pCnx = pWindow->ImplGetWinData()->mpLayoutCnx ) )
+	    pWindow = pWindow->mpRealParent;
+
+    if( pCnx )
+	    pCnx->reconcileMap( rResId.GetId(), this );
+
     return nStyle;
 }
 
@@ -1296,6 +1308,12 @@ void Window::ImplLoadRes( const ResId& r
         SetData( (void*)ReadLongRes() );
     if ( nObjMask & WINDOW_UNIQUEID )
         SetUniqueId( (ULONG)ReadLongRes() );
+    if ( nObjMask & WINDOW_LAYOUT )
+    {
+	ImplWinData* pWinData = ImplGetWinData();
+	pWinData->mpLayoutCnx = new LayoutConnector
+		( this, GetResManager(), (USHORT)ReadShortRes() );
+    }
 }
 
 // -----------------------------------------------------------------------
@@ -1312,6 +1330,7 @@ ImplWinData* Window::ImplGetWinData() co
         mpWinData->mpFocusRect      = NULL;
         mpWinData->mpTrackRect      = NULL;
         mpWinData->mnTrackFlags     = 0;
+        mpWinData->mpLayoutCnx      = NULL;
     }
 
     return mpWinData;
@@ -1659,6 +1678,7 @@ void Window::ImplInitResolutionSettings(
 }
 
 // -----------------------------------------------------------------------
+#include <stdio.h>
 
 void Window::ImplPointToLogic( Font& rFont ) const
 {
@@ -1667,17 +1687,21 @@ void Window::ImplPointToLogic( Font& rFo
 
     if ( aSize.Width() )
     {
-        aSize.Width() *= mpFrameData->mnFontDPIX;
-        aSize.Width() += 72/2;
-        aSize.Width() /= 72;
-        aSize.Width() *= nScreenFontZoom;
-        aSize.Width() /= 100;
-    }
-    aSize.Height() *= mpFrameData->mnFontDPIY;
-    aSize.Height() += 72/2;
-    aSize.Height() /= 72;
-    aSize.Height() *= nScreenFontZoom;
-    aSize.Height() /= 100;
+	double t = aSize.Width();
+	t *= nScreenFontZoom;
+	t /= 100.0;
+	t *= mpFrameData->mnFontDPIX;
+	t /= 72.0;
+	t += 0.5;
+	aSize.Width() = t;
+    }
+    double t = aSize.Height();
+    t *= nScreenFontZoom;
+    t /= 100.0;
+    t *= mpFrameData->mnFontDPIY;
+    t /= 72.0;
+    t += 0.5;
+    aSize.Height() = t;
 
     if ( IsMapModeEnabled() )
         aSize = PixelToLogic( aSize );
@@ -8787,3 +8811,11 @@ LanguageType Window::GetInputLanguage() 
     return mpFrame->GetInputLanguage();
 }
 
+
+void Window::VtkAllocateSize( const Size &aSize )
+{
+}
+
+void Window::VtkRequestSize( Size &rSize )
+{
+}
Index: vcl/inc/window.h
===================================================================
RCS file: /cvs/gsl/vcl/inc/window.h,v
retrieving revision 1.11
diff -u -p -u -r1.11 window.h
--- vcl/inc/window.h	27 Mar 2003 17:57:36 -0000	1.11
+++ vcl/inc/window.h	26 Aug 2003 16:52:10 -0000
@@ -103,7 +103,7 @@ namespace dnd {
 // ---------------
 // - ImplWinData -
 // ---------------
-
+class LayoutConnector;
 struct ImplWinData
 {
     UniString*          mpExtOldText;
@@ -113,6 +113,7 @@ struct ImplWinData
     Rectangle*          mpFocusRect;
     Rectangle*          mpTrackRect;
     USHORT              mnTrackFlags;
+    LayoutConnector*    mpLayoutCnx;
 };
 
 // -------------------
