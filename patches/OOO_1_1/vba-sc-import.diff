Index: sc/source/filter/excel/excform8.cxx
===================================================================
RCS file: /cvs/sc/sc/source/filter/excel/excform8.cxx,v
retrieving revision 1.23.120.1
diff -u -p -u -r1.23.120.1 excform8.cxx
--- sc/source/filter/excel/excform8.cxx	19 Jan 2004 16:41:36 -0000	1.23.120.1
+++ sc/source/filter/excel/excform8.cxx	12 Mar 2004 14:11:43 -0000
@@ -477,11 +477,20 @@ ConvErr ExcelToSc8::Convert( const ScTok
 			case 0x43:
 			case 0x63:
 			case 0x23: // Name									[318 269]
+			{
 				aIn >> nUINT16;
 				aIn.Ignore( 2 );
 
-				aStack << aPool.Store( ( *pExcRoot->pRNameBuff )[ nUINT16 ] );
+				const String *pStr = pExcRoot->pRNameBuff->GetMacro ( nUINT16 );
+				if (pStr) {
+						fprintf (stderr, "Store a function instead: '%s'\n",
+								 (const sal_Char *) rtl::OUStringToOString(
+										 *pStr, RTL_TEXTENCODING_UTF8));
+						aStack << aPool.Store( ocMacro, *pStr );
+				} else
+						aStack << aPool.Store( ( *pExcRoot->pRNameBuff )[ nUINT16 ] );
 				break;
+			}
 			case 0x44:
 			case 0x64:
 			case 0x24: // Cell Reference						[319 270]
Index: sc/source/filter/excel/excimp8.cxx
===================================================================
RCS file: /cvs/sc/sc/source/filter/excel/excimp8.cxx,v
retrieving revision 1.84.18.2
diff -u -p -u -r1.84.18.2 excimp8.cxx
--- sc/source/filter/excel/excimp8.cxx	19 Jan 2004 16:41:53 -0000	1.84.18.2
+++ sc/source/filter/excel/excimp8.cxx	12 Mar 2004 14:11:44 -0000
@@ -1001,7 +1001,6 @@ void ImportExcel8::Name( void )
     if( bHidden || bSkip )
         pExcRoot->pRNameBuff->Store( aName, NULL, nSheet );
     else
-        // ohne hidden
         pExcRoot->pRNameBuff->Store( aName, pErgebnis, nSheet, eNameType );
 }
 
@@ -1019,6 +1018,32 @@ void ImportExcel8::EndSheet( void )
 	ImportExcel::EndSheet();
 }
 
+void ImportExcel8::ReadBasic( void )
+{
+    if( bHasBasic ) return; bHasBasic = TRUE;
+
+    SfxObjectShell* pShell = GetDocShell();
+
+    if( pShell )
+	{
+		OfaFilterOptions*   pFiltOpt = OFF_APP()->GetFilterOptions();
+
+		if( pFiltOpt )
+		{
+			if( pFiltOpt->IsLoadExcelBasicCode() || pFiltOpt->IsLoadExcelBasicStorage() )
+			{
+				DBG_ASSERT( pExcRoot->pRootStorage, "-ImportExcel8::PostDocLoad(): no storage, no cookies!" );
+
+                SvxImportMSVBasic   aBasicImport( *pShell, *pExcRoot->pRootStorage,
+													pFiltOpt->IsLoadExcelBasicCode(),
+													pFiltOpt->IsLoadExcelBasicStorage() );
+
+				aBasicImport.Import( String::CreateFromAscii( pVBAStorageName ),
+									 String::CreateFromAscii( pVBASubStorageName ) );
+			}
+		}
+	}
+}
 
 void ImportExcel8::PostDocLoad( void )
 {
Index: sc/source/filter/excel/read.cxx
===================================================================
RCS file: /cvs/sc/sc/source/filter/excel/read.cxx,v
retrieving revision 1.39.80.1
diff -u -p -u -r1.39.80.1 read.cxx
--- sc/source/filter/excel/read.cxx	19 Jan 2004 16:43:05 -0000	1.39.80.1
+++ sc/source/filter/excel/read.cxx	12 Mar 2004 14:11:46 -0000
@@ -1143,7 +1143,7 @@ FltError ImportExcel8::Read( void )
 					case 0x56:	Builtinfmtcnt(); break;	// BUILTINFMTCNT[  34    ]
 					case 0x8D:	Hideobj(); break;		// HIDEOBJ		[  345   ]
 					case 0x99:	Standardwidth(); break;	// STANDARDWIDTH[   45   ]
-					case 0xD3:	bHasBasic = TRUE; break;
+					case 0xD3:	ReadBasic(); break;
 					case 0xD5:	SXIdStm(); break;		// SXIDSTM                ##++##
                     case 0xDE:  Olesize(); break;
                     case 0xE0:  GetXFBuffer().ReadXF( maStrm );                 break;
Index: sc/source/filter/excel/tokstack.cxx
===================================================================
RCS file: /cvs/sc/sc/source/filter/excel/tokstack.cxx,v
retrieving revision 1.3
diff -u -p -u -r1.3 tokstack.cxx
--- sc/source/filter/excel/tokstack.cxx	23 Oct 2001 09:37:15 -0000	1.3
+++ sc/source/filter/excel/tokstack.cxx	12 Mar 2004 14:11:46 -0000
@@ -350,10 +350,12 @@ void TokenPool::GetElement( const UINT16
 				UINT16			n = pElement[ nId ];
 				EXTCONT*		p = ( n < nP_Ext )? ppP_Ext[ n ] : NULL;
 
-				if( p )
-					/*ScToken*	pTok = */pScToken->AddExternal( p->aText.GetBuffer() );
+				if( p ) {
+						ScToken *pTok = pScToken->AddExternal( p->aText );
+						pTok->NewOpCode (p->eId);
 				}
 				break;
+				}
 			case T_Nlf:
 				{
 				UINT16			n = pElement[ nId ];
@@ -417,9 +419,11 @@ void TokenPool::GetElementRek( const UIN
 					{
 					UINT16		n = pElement[ ( TokenId ) *pAkt ];
 					EXTCONT*	p = ( n < nP_Ext )? ppP_Ext[ n ] : NULL;
-
-					if( p )
-						/*ScToken*	pTok = */pScToken->AddExternal( p->aText.GetBuffer() );
+					
+					if( p ) {
+						ScToken *pTok = pScToken->AddExternal( p->aText );
+						pTok->NewOpCode (p->eId);
+					}
 					}
 					break;
 				case T_Nlf:
Index: sc/source/filter/inc/excimp8.hxx
===================================================================
RCS file: /cvs/sc/sc/source/filter/inc/excimp8.hxx,v
retrieving revision 1.48.80.1
diff -u -p -u -r1.48.80.1 excimp8.hxx
--- sc/source/filter/inc/excimp8.hxx	19 Jan 2004 16:45:37 -0000	1.48.80.1
+++ sc/source/filter/inc/excimp8.hxx	12 Mar 2004 14:11:46 -0000
@@ -193,6 +193,7 @@ class ImportExcel8 : public ImportExcel
 		void					SXLi( void );					// 0xB5
 		void					SXPi( void );					// 0xB6
 		void					SXDi( void );					// 0xC5
+		void					ReadBasic( void );				// 0xD3
 		void					SXIdStm( void );				// 0xD5
 		void					SXVs( void );					// 0xE3
 		void					Cellmerging( void );			// 0xE5		geraten...
Index: sc/source/filter/excel/namebuff.cxx
===================================================================
RCS file: /cvs/sc/sc/source/filter/excel/namebuff.cxx,v
retrieving revision 1.15
diff -u -p -u -r1.15 namebuff.cxx
--- sc/source/filter/excel/namebuff.cxx	23 Apr 2003 17:29:11 -0000	1.15
+++ sc/source/filter/excel/namebuff.cxx	12 Mar 2004 14:37:07 -0000
@@ -167,7 +167,11 @@ BOOL NameBuffer::Find( const sal_Char* p
 }
 
 
-
+RangeNameBuffer::~RangeNameBuffer()
+{
+	for( ULONG i = 0; i < Count(); i++ )
+		delete (String *) GetObject( i );
+}
 
 void RangeNameBuffer::Store( ByteString& r, const ScTokenArray* p, UINT16 n, const RangeType t)
 {
@@ -191,6 +195,11 @@ void RangeNameBuffer::Store( String& rNa
 			rName += String::CreateFromInt32( nAltSheet );
 		}
 
+		if (pDef->GetLen() == 0) { /* Dummy method / function call */
+				Insert( new String (rName), LIST_APPEND );
+				return;
+		}
+
 		ScRangeData*	pData = new ScRangeData( pExcRoot->pDoc, rName, *pDef );
 
 		pData->GuessPosition();
@@ -205,10 +214,10 @@ void RangeNameBuffer::Store( String& rNa
 
 		pExcRoot->pScRangeName->Insert( pData );
 
-		Insert( ( void* ) TRUE, LIST_APPEND );
+		Insert( NULL, LIST_APPEND );
 	}
 	else
-		Insert( ( void* ) FALSE, LIST_APPEND );
+		Insert( NULL, LIST_APPEND );
 }
 
 
Index: sc/source/filter/inc/namebuff.hxx
===================================================================
RCS file: /cvs/sc/sc/source/filter/inc/namebuff.hxx,v
retrieving revision 1.6
diff -u -p -u -r1.6 namebuff.hxx
--- sc/source/filter/inc/namebuff.hxx	26 Mar 2003 18:05:05 -0000	1.6
+++ sc/source/filter/inc/namebuff.hxx	12 Mar 2004 14:37:07 -0000
@@ -219,12 +219,14 @@ protected:
 public:
 	inline					RangeNameBuffer( RootData* p );
 											// Name, Definition
+	virtual                 ~RangeNameBuffer();
 	void					Store( ByteString&, const ScTokenArray*,
 								UINT16 nAltSheet = 0, const RangeType eNameType = RT_ABSAREA );
 	void					Store( String&, const ScTokenArray*,
 								UINT16 nAltSheet = 0, const RangeType eNameType = RT_ABSAREA );
 	inline UINT16			operator[]( UINT16 nExcInd ) const;
 	inline UINT16			GetPos( void ) const;
+	const String           *GetMacro( UINT16 nIdx ) const { return (const String *) GetObject( nIdx ); }
 };
 
 
