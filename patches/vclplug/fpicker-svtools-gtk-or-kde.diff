--- svtools/source/filepicker/filepicker.cxx	2004-08-11 16:53:39.638485984 +0200
+++ svtools/source/filepicker/filepicker.cxx	2004-08-11 19:32:12.427322264 +0200
@@ -151,6 +151,10 @@
 #include "pickerhistoryaccess.hxx"
 #endif
 
+#ifndef _UNO_CURRENT_CONTEXT_HXX_
+#include <uno/current_context.hxx>
+#endif
+
 // define ----------------------------------------------------------------
 
 #define MAKE_ANY    ::com::sun::star::uno::makeAny
@@ -1148,7 +1152,35 @@ sal_Bool SvtFilePicker::implHandleInitia
 // ------------------------------------------------------------------------
 // misc. helpers
 //-------------------------------------------------------------------------
-#define SYSTEM_FILE_OPEN_SERVICE_NAME "com.sun.star.ui.dialogs.SystemFilePicker"
+::rtl::OUString impl_SystemFileOpenServiceName()
+{
+    try
+    {
+        Reference< XCurrentContext > xCurrentContext( getCurrentContext() );
+
+        if ( xCurrentContext.is() )
+        {
+            Any aValue = xCurrentContext->getValueByName(
+                    ::rtl::OUString::createFromAscii( "system.desktop-environment" ) );
+
+            ::rtl::OUString aDesktopEnvironment;
+            if ( aValue >>= aDesktopEnvironment )
+            {
+                if ( aDesktopEnvironment.equalsIgnoreAsciiCaseAscii( "gnome" ) )
+                {
+                    return ::rtl::OUString::createFromAscii( "com.sun.star.ui.dialogs.GtkFilePicker" );
+                }
+                else if ( aDesktopEnvironment.equalsIgnoreAsciiCaseAscii( "kde" ) )
+                {
+                    return ::rtl::OUString::createFromAscii( "com.sun.star.ui.dialogs.KDEFilePicker" );
+                }
+            }
+        }
+    }
+    catch( RuntimeException ) {}
+
+    return ::rtl::OUString::createFromAscii( "com.sun.star.ui.dialogs.SystemFilePicker" );
+}
 
 sal_Bool SvtFilePicker::HasSystemFilePicker( const Reference< XMultiServiceFactory > xFactory )
 {
@@ -1162,7 +1194,7 @@ sal_Bool SvtFilePicker::HasSystemFilePic
 
     try
     {
-		::rtl::OUString aFileService( RTL_CONSTASCII_USTRINGPARAM( SYSTEM_FILE_OPEN_SERVICE_NAME ) );
+		::rtl::OUString aFileService = impl_SystemFileOpenServiceName();
 
         Reference< XEnumeration > xEnum = xEnumAccess->createContentEnumeration( aFileService );
         if ( xEnum.is() && xEnum->hasMoreElements() )
@@ -1248,7 +1280,7 @@ Reference< XInterface > SAL_CALL SvtFile
 
         if ( bHasSystemFilePicker && UseSystemFilePicker() )
         {
-            ::rtl::OUString aFileService( RTL_CONSTASCII_USTRINGPARAM( SYSTEM_FILE_OPEN_SERVICE_NAME ) );
+            ::rtl::OUString aFileService = impl_SystemFileOpenServiceName();
             xRet = xServiceManager->createInstance( aFileService );
         }
     }
