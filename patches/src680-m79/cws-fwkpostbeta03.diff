Index: helpcontent2/source/auxiliary/embed.xsl
===================================================================
RCS file: /cvs/documentation/helpcontent2/source/auxiliary/embed.xsl,v
retrieving revision 1.5
retrieving revision 1.5.12.1
diff -u -p -r1.5 -r1.5.12.1
--- helpcontent2/source/auxiliary/embed.xsl	28 Jan 2005 09:27:18 -0000	1.5
+++ helpcontent2/source/auxiliary/embed.xsl	17 Feb 2005 16:42:48 -0000	1.5.12.1
@@ -31,6 +31,11 @@ All others
 	<xsl:apply-templates mode="embedded"/>
 </xsl:template>
 
+<xsl:template match="paragraph[@role='heading']">
+    <title>
+        <xsl:apply-templates/>
+    </title>
+</xsl:template>
 <!-- 
 ###################################################### 
 EMBED
Index: helpcontent2/source/auxiliary/main_transform.xsl
===================================================================
RCS file: /cvs/documentation/helpcontent2/source/auxiliary/main_transform.xsl,v
retrieving revision 1.10
retrieving revision 1.10.12.1
diff -u -p -r1.10 -r1.10.12.1
--- helpcontent2/source/auxiliary/main_transform.xsl	28 Jan 2005 09:29:09 -0000	1.10
+++ helpcontent2/source/auxiliary/main_transform.xsl	4 Feb 2005 12:21:04 -0000	1.10.12.1
@@ -156,7 +156,7 @@
  
 <xsl:variable name="help_url_prefix" select="'vnd.sun.star.help://'"/>
 <xsl:variable name="img_url_prefix" select="concat('vnd.sun.star.pkg://',$imgrepos,'/')"/>
-<xsl:variable name="urlpost" select="concat('?Language=',$lang,$am,'System=',$System,$am,'UseDB=no')"/>
+<xsl:variable name="urlpost" select="concat('?Language=',$lang,$am,'System=',$System,$am,'UseDB=no',$am,'DbPAR=',$Database)"/>
 <xsl:variable name="urlpre" select="$help_url_prefix" /> 
 <xsl:variable name="linkprefix" select="$urlpre"/>
 <xsl:variable name="linkpostfix" select="$urlpost"/>
Index: officecfg/registry/data/org/openoffice/Office/UI/GenericCommands.xcu
===================================================================
RCS file: /cvs/util/officecfg/registry/data/org/openoffice/Office/UI/GenericCommands.xcu,v
retrieving revision 1.38
retrieving revision 1.38.30.1
diff -u -p -r1.38 -r1.38.30.1
--- officecfg/registry/data/org/openoffice/Office/UI/GenericCommands.xcu	27 Jan 2005 16:11:53 -0000	1.38
+++ officecfg/registry/data/org/openoffice/Office/UI/GenericCommands.xcu	11 Feb 2005 16:22:54 -0000	1.38.30.1
@@ -2549,7 +2549,7 @@
 			</node>
 			<node oor:name=".uno:DesignerDialog" oor:op="replace">
 				<prop oor:name="Label" oor:type="xs:string">
-					<value xml:lang="de">Formatvorlagen und Formatierung</value>
+					<value xml:lang="de">Formatvorlagen</value>
 					<value xml:lang="en-US">St~yles and Formatting</value>
 				</prop>
 				<prop oor:name="Properties" oor:type="xs:int">
Index: scripting/source/inc/util/MiscUtils.hxx
===================================================================
RCS file: /cvs/framework/scripting/source/inc/util/MiscUtils.hxx,v
retrieving revision 1.3
retrieving revision 1.3.4.1
diff -u -p -r1.3 -r1.3.4.1
--- scripting/source/inc/util/MiscUtils.hxx	27 Jan 2005 15:30:33 -0000	1.3
+++ scripting/source/inc/util/MiscUtils.hxx	16 Feb 2005 10:33:53 -0000	1.3.4.1
@@ -67,6 +67,7 @@
 #include <ucbhelper/content.hxx>
 #include <com/sun/star/uno/XComponentContext.hpp>
 #include <com/sun/star/frame/XModel.hpp>
+#include <com/sun/star/frame/XTransientDocumentsDocumentContentFactory.hpp>
 #include <com/sun/star/document/XDocumentInfoSupplier.hpp>
 #include <com/sun/star/beans/XPropertySet.hpp>
 #include <com/sun/star/container/XContentEnumerationAccess.hpp>
@@ -85,7 +86,7 @@ namespace sf_misc
 // for simplification
 #define css ::com::sun::star
 
-class MiscUtils 
+class MiscUtils
 {
 public:
     static css::uno::Sequence< ::rtl::OUString > allOpenTDocUrls( const  css::uno::Reference< css::uno::XComponentContext >& xCtx)
@@ -107,16 +108,17 @@ public:
             }
         }
     }
-    catch ( css::uno::Exception& e )
+    catch ( css::uno::Exception& )
     {
-    }      
+    }
     return result;
-} 
+}
+
     static ::rtl::OUString xModelToDocTitle( const css::uno::Reference< css::frame::XModel >& xModel )
 {
     // Set a default name, this should never be seen.
-    ::rtl::OUString docNameOrURL = 
-        ::rtl::OUString::createFromAscii("Unknown"); 
+    ::rtl::OUString docNameOrURL =
+        ::rtl::OUString::createFromAscii("Unknown");
     if ( xModel.is() )
     {
         ::rtl::OUString tempName;
@@ -128,21 +130,21 @@ public:
                 if ( sal_True == ( propSet->getPropertyValue(::rtl::OUString::createFromAscii( "Title" ) ) >>= tempName ) )
                 {
                     docNameOrURL = tempName;
-                    if ( xModel->getURL().getLength() == 0 ) 
+                    if ( xModel->getURL().getLength() == 0 )
                     {
-                    	// process "UntitledX - YYYYYYYY"
-	                    // to get UntitledX
-	                    sal_Int32 pos = 0;
-	                    docNameOrURL = tempName.getToken(0,' ',pos);
+                        // process "UntitledX - YYYYYYYY"
+                        // to get UntitledX
+                        sal_Int32 pos = 0;
+                        docNameOrURL = tempName.getToken(0,' ',pos);
                     }
                     else
-                    { 
+                    {
                         css::uno::Reference< css::document::XDocumentInfoSupplier >  xDIS( xModel, css::uno::UNO_QUERY_THROW );
                         css::uno::Reference< css::beans::XPropertySet > xProp (xDIS->getDocumentInfo(),  css::uno::UNO_QUERY_THROW );
                         css::uno::Any aTitle = xProp->getPropertyValue(::rtl::OUString::createFromAscii( "Title" ) );
-                        
+
                         aTitle >>= docNameOrURL;
-                        if ( docNameOrURL.getLength() == 0 ) 
+                        if ( docNameOrURL.getLength() == 0 )
                         {
                             docNameOrURL =  parseLocationName( xModel->getURL() );
                         }
@@ -159,7 +161,6 @@ public:
     }
     return docNameOrURL;
 }
-
     static ::rtl::OUString tDocUrlToTitle( const ::rtl::OUString& url )
 {
     ::rtl::OUString title;
@@ -170,51 +171,58 @@ public:
         ::rtl::OUString propName =  OUSTR("Title");
         getUCBProperty( root, propName ) >>= title;
     }
-    catch ( css::ucb::ContentCreationException& cce )
+    catch ( css::ucb::ContentCreationException& )
     {
         // carry on, empty value will be returned
     }
-    catch ( css::uno::RuntimeException& re )
+    catch ( css::uno::RuntimeException& )
     {
         // carry on, empty value will be returned
     }
 
+    OSL_ENSURE( title.getLength() > 0, "Unable to obtain title!" );
     return title;
 }
-    static ::rtl::OUString xModelToTdocUrl( const css::uno::Reference< css::frame::XModel >& xModel )
+    static ::rtl::OUString xModelToTdocUrl( const css::uno::Reference< css::frame::XModel >& xModel,
+                                            const css::uno::Reference< css::uno::XComponentContext >& xContext )
 {
-    css::uno::Reference < com::sun::star::ucb::XCommandEnvironment > dummy;
-    ::rtl::OUString sDocRoot = OUSTR( "vnd.sun.star.tdoc:/" );
-    ::ucb::Content root( sDocRoot, dummy );
-
-    css::uno::Sequence < ::rtl::OUString > aPropertyNames( 0 );
-    ::rtl::OUString propName = OUSTR( "DocumentModel" );
-
-    css::uno::Reference < com::sun::star::sdbc::XResultSet > xResultSet =
-        root.createCursor( aPropertyNames );
+    css::uno::Reference< css::lang::XMultiComponentFactory > xMCF(
+        xContext->getServiceManager() );
+    css::uno::Reference<
+            css::frame::XTransientDocumentsDocumentContentFactory > xDocFac;
+    try
+    {
+        xDocFac =
+            css::uno::Reference<
+                css::frame::XTransientDocumentsDocumentContentFactory >(
+                    xMCF->createInstanceWithContext(
+                        rtl::OUString(
+                            RTL_CONSTASCII_USTRINGPARAM(
+                                "com.sun.star.frame.TransientDocumentsDocumentContentFactory" ) ),
+                        xContext ),
+                css::uno::UNO_QUERY );
+    }
+    catch ( css::uno::Exception const & )
+    {
+        // handled below
+    }
 
-    css::uno::Reference< com::sun::star::ucb::XContentAccess > xContentAccess(
-        xResultSet, css::uno::UNO_QUERY );
-    ::rtl::OUString docUrl;
-    if ( xResultSet.is() && xContentAccess.is() )
+    if ( xDocFac.is() )
     {
-        css::uno::Reference< css::sdbc::XRow > values( xResultSet, css::uno::UNO_QUERY );
-        if ( values.is() )
+        try
         {
-            while ( xResultSet->next() )
-            {
-                ::rtl::OUString url = xContentAccess->queryContentIdentifierString();
-                css::uno::Reference < css::frame::XModel > xMod( tDocUrlToModel( url ), css::uno::UNO_QUERY );
-
-                if ( xMod.is() && xMod == xModel )
-                {
-                    docUrl = url;
-                    break;
-                }
-            }
+            css::uno::Reference< css::ucb::XContent > xContent(
+                xDocFac->createDocumentContent( xModel ) );
+            return xContent->getIdentifier()->getContentIdentifier();
+        }
+        catch ( css::lang::IllegalArgumentException const & )
+        {
+            OSL_ENSURE( false, "Invalid document model!" );
         }
     }
-    return docUrl;
+
+    OSL_ENSURE( false, "Unable to obtain URL for document model!" );
+    return rtl::OUString();
 }
     static css::uno::Reference< css::frame::XModel > tDocUrlToModel( const ::rtl::OUString& url )
 {
@@ -226,11 +234,11 @@ public:
         ::rtl::OUString propName =  OUSTR("DocumentModel");
         result = getUCBProperty( root, propName );
     }
-    catch ( css::ucb::ContentCreationException& cce )
+    catch ( css::ucb::ContentCreationException& )
     {
         // carry on, empty value will be returned
     }
-    catch ( css::uno::RuntimeException& re )
+    catch ( css::uno::RuntimeException& )
     {
         // carry on, empty value will be returned
     }
@@ -244,22 +252,12 @@ public:
 
     static css::uno::Any getUCBProperty( ::ucb::Content& content, ::rtl::OUString& prop )
 {
-    css::uno::Sequence < ::rtl::OUString > aPropertyNames( 1 );
-    ::rtl::OUString* pNames = aPropertyNames.getArray();
-    pNames[ 0 ] = prop;
     css::uno::Any result;
     try
     {
-        css::uno::Sequence< css::uno::Any > props = content.getPropertyValues( aPropertyNames );
-        if ( props.getLength() )
-        {
-            result = props[ 0 ];
-        }
+        result = content.getPropertyValue( prop );
     }
-/*    catch ( ucb::CommandAbortedException& e )
-    {
-    }*/
-    catch ( css::uno::Exception& e )
+    catch ( css::uno::Exception& )
     {
     }
     return result;
@@ -272,11 +270,11 @@ static ::rtl::OUString parseLocationName
     // e.g. file://dir1/dir2/Blah.sxw - > Blah.sxw
     ::rtl::OUString temp = location;
     sal_Int32 lastSlashIndex = temp.lastIndexOf( ::rtl::OUString::createFromAscii( "/" ) );
-   
+
     if ( ( lastSlashIndex + 1 ) <  temp.getLength()  )
     {
         temp = temp.copy( lastSlashIndex + 1 );
-    } 
+    }
     return temp;
 }
 
Index: scripting/source/provider/ActiveMSPList.cxx
===================================================================
RCS file: /cvs/framework/scripting/source/provider/ActiveMSPList.cxx,v
retrieving revision 1.10
retrieving revision 1.10.4.1
diff -u -p -r1.10 -r1.10.4.1
--- scripting/source/provider/ActiveMSPList.cxx	27 Jan 2005 15:31:24 -0000	1.10
+++ scripting/source/provider/ActiveMSPList.cxx	16 Feb 2005 10:35:42 -0000	1.10.4.1
@@ -69,7 +69,6 @@
 #include <com/sun/star/util/XMacroExpander.hpp>
 
 #include <com/sun/star/script/browse/BrowseNodeTypes.hpp>
-#include <com/sun/star/document/XDocumentInfoSupplier.hpp>
 
 #include "MasterScriptProvider.hxx"
 #include "ActiveMSPList.hxx"
@@ -123,7 +122,7 @@ ActiveMSPList::getActiveProviders()
 
     // get providers for active documents
     Model_map::iterator m_itEnd =  m_mModels.end();
-    
+
     for ( Model_map::iterator m_it = m_mModels.begin(); m_it != m_itEnd; ++m_it )
     {
         children[ count++ ] = m_it->second;
@@ -142,15 +141,15 @@ ActiveMSPList::createMSP( const Any& aCo
         Reference< frame::XModel> xModel( aContext, UNO_QUERY );
         if ( xModel.is() )
         {
-            ::rtl::OUString sContext = MiscUtils::xModelToTdocUrl( xModel );
-            msp = createMSP( sContext ); 
-        }            
+            ::rtl::OUString sContext = MiscUtils::xModelToTdocUrl( xModel, m_xContext );
+            msp = createMSP( sContext );
+        }
         else
         {
             createNonDocMSPs();
             return m_hMsps[ shareDirString ];
         }
-     
+
     }
     else
     {
@@ -170,7 +169,7 @@ ActiveMSPList::createMSP( const ::rtl::O
     {
         Reference< frame::XModel > xModel( MiscUtils::tDocUrlToModel( context ), UNO_QUERY );
         if ( !xModel.is() )
-        {        
+        {
             ::rtl::OUStringBuffer buf( 80 );
             buf.append( OUSTR("Failed to create MasterScriptProvider for " ) );
             buf.append( context);
@@ -183,7 +182,7 @@ ActiveMSPList::createMSP( const ::rtl::O
         {
             msp = createNewMSP( context );
             addActiveMSP( xModel, msp );
-        } 
+        }
         else
         {
             msp = itr->second;
@@ -200,7 +199,7 @@ ActiveMSPList::createMSP( const ::rtl::O
             {
                 msp = createNewMSP( context );
             }
-            catch ( RuntimeException& e )
+            catch ( RuntimeException& )
             {
                 ::rtl::OUStringBuffer buf( 80 );
                 buf.append( OUSTR("Failed to create MasterScriptProvider for " ) );
@@ -208,7 +207,7 @@ ActiveMSPList::createMSP( const ::rtl::O
                 ::rtl::OUString message = buf.makeStringAndClear();
                 throw RuntimeException( message, Reference< XInterface >() );
             }
-            m_hMsps[ context ] = msp;     
+            m_hMsps[ context ] = msp;
         }
         else
         {
@@ -223,7 +222,7 @@ ActiveMSPList::addActiveMSP( const Refer
 	       	const Reference< provider::XScriptProvider >& msp )
 {
     ::osl::MutexGuard guard( m_mutex );
-    Model_map::const_iterator itr = m_mModels.find( xModel );    
+    Model_map::const_iterator itr = m_mModels.find( xModel );
     if ( itr == m_mModels.end() )
     {
         m_mModels[ xModel ] = msp;
@@ -236,9 +235,9 @@ ActiveMSPList::addActiveMSP( const Refer
                 Reference< lang::XComponent >( xModel, UNO_QUERY_THROW );
             validateXRef( xComponent, "ActiveMSPList::addActiveMSP: model not XComponent\n" );
             xComponent->addEventListener( this );
-    
+
         }
-        catch ( RuntimeException& e )
+        catch ( RuntimeException& )
         {
         }
     }
@@ -258,7 +257,7 @@ throw ( ::com::sun::star::uno::RuntimeEx
         if ( xModel.is() )
         {
             ::osl::MutexGuard guard( m_mutex );
-            Model_map::const_iterator itr = m_mModels.find( xModel );    
+            Model_map::const_iterator itr = m_mModels.find( xModel );
             if ( itr != m_mModels.end() )
             {
                 m_mModels.erase( xModel );
@@ -298,7 +297,7 @@ ActiveMSPList::createNonDocMSPs()
         Sequence< Any > args(1);
 
         args[ 0 ] <<= userDirString;
-        Reference< provider::XScriptProvider > userMsp( m_xContext->getServiceManager()->createInstanceWithArgumentsAndContext( serviceName, args, m_xContext ), UNO_QUERY );        
+        Reference< provider::XScriptProvider > userMsp( m_xContext->getServiceManager()->createInstanceWithArgumentsAndContext( serviceName, args, m_xContext ), UNO_QUERY );
         // should check if provider reference is valid
         m_hMsps[ userDirString ] = userMsp;
 
@@ -308,7 +307,7 @@ ActiveMSPList::createNonDocMSPs()
         m_hMsps[ shareDirString ] = shareMsp;
         created = true;
     }
-    
+
 }
 
 
Index: scripting/source/provider/BrowseNodeFactoryImpl.cxx
===================================================================
RCS file: /cvs/framework/scripting/source/provider/BrowseNodeFactoryImpl.cxx,v
retrieving revision 1.6
retrieving revision 1.6.4.1
diff -u -p -r1.6 -r1.6.4.1
--- scripting/source/provider/BrowseNodeFactoryImpl.cxx	27 Jan 2005 15:31:36 -0000	1.6
+++ scripting/source/provider/BrowseNodeFactoryImpl.cxx	16 Feb 2005 10:38:02 -0000	1.6.4.1
@@ -65,10 +65,7 @@
 #include <cppuhelper/exc_hlp.hxx>
 #include <cppuhelper/implbase1.hxx>
 
-#include <com/sun/star/container/XEnumerationAccess.hpp>
-#include <com/sun/star/container/XEnumeration.hpp>
 #include <com/sun/star/lang/XMultiComponentFactory.hpp>
-#include <com/sun/star/frame/XDesktop.hpp>
 #include <com/sun/star/frame/XModel.hpp>
 #include <com/sun/star/reflection/XProxyFactory.hpp>
 
@@ -118,14 +115,14 @@ public:
         m_Nodes[ index ] = node;
     }
 
-    virtual ::rtl::OUString 
+    virtual ::rtl::OUString
     SAL_CALL getName()
             throw ( RuntimeException )
     {
         return m_Name;
     }
 
-    virtual Sequence< Reference< browse::XBrowseNode > > SAL_CALL 
+    virtual Sequence< Reference< browse::XBrowseNode > > SAL_CALL
     getChildNodes()
         throw ( RuntimeException )
     {
@@ -143,7 +140,7 @@ public:
                 seqs.push_back( childs );
                 numChildren += childs.getLength();
             }
-            catch ( Exception& e )
+            catch ( Exception& )
             {
                 // some form of exception getting child nodes so they
                 // won't be displayed
@@ -165,7 +162,7 @@ public:
         return result;
     }
 
-    virtual sal_Bool SAL_CALL 
+    virtual sal_Bool SAL_CALL
     hasChildNodes()
         throw ( RuntimeException )
     {
@@ -180,7 +177,7 @@ public:
                         return sal_True;
                     }
                 }
-                catch ( Exception& e )
+                catch ( Exception& )
                 {
                     // some form of exception getting child nodes so move
                     // on to the next one
@@ -249,7 +246,7 @@ public:
         return m_sNodeName;
     }
 
-    virtual Sequence< Reference< browse::XBrowseNode > > SAL_CALL 
+    virtual Sequence< Reference< browse::XBrowseNode > > SAL_CALL
     getChildNodes()
         throw ( RuntimeException )
     {
@@ -321,7 +318,7 @@ private:
                 }
                 else
                 {
-                    Reference< browse::XBrowseNode > bna( 
+                    Reference< browse::XBrowseNode > bna(
                         new BrowseNodeAggregator( grandchild ) );
                     (*m_hBNA)[ grandchild->getName() ].set( bna );
                     m_vStr.push_back( grandchild->getName() );
@@ -333,50 +330,17 @@ private:
     }
 };
 
-Sequence < ::rtl::OUString >
-tdocBugWorkAround( const Reference< XComponentContext >& xCtx )
+namespace
 {
-    Sequence < ::rtl::OUString > result;
-    Reference< lang::XMultiComponentFactory > mcf =
-            xCtx->getServiceManager();
-    Reference< frame::XDesktop > desktop (
-        mcf->createInstanceWithContext(
-            ::rtl::OUString::createFromAscii("com.sun.star.frame.Desktop"),                 xCtx ),
-            UNO_QUERY );
-
-    Reference< container::XEnumerationAccess > componentsAccess =
-        desktop->getComponents();
-    Reference< container::XEnumeration > components =
-        componentsAccess->createEnumeration();
-    sal_Int32 docIndex = 0; 
-    while (components->hasMoreElements())
-    {
-        Sequence< Any > args( 1 );
-
-        Reference< frame::XModel > model(
-            components->nextElement(), UNO_QUERY );
-        if ( model.is() )
-        {
-            ::rtl::OUString sTdocUrl = MiscUtils::xModelToTdocUrl( model );
-            if ( sTdocUrl.getLength() > 0 )
-            {
-                result.realloc( result.getLength() + 1 );
-                result[ docIndex++ ] = sTdocUrl;             
-            }
-        }
-    }
-    return result;
-}
 
 Sequence< Reference< browse::XBrowseNode > > getAllBrowseNodes( const Reference< XComponentContext >& xCtx )
 {
         Reference< lang::XMultiComponentFactory > mcf =
             xCtx->getServiceManager();
 
-        Sequence< ::rtl::OUString > openDocs = 
+        Sequence< ::rtl::OUString > openDocs =
+            MiscUtils::allOpenTDocUrls( xCtx );
 
-        //    MiscUtils::allOpenTDocUrls( xCtx );
-            tdocBugWorkAround( xCtx );
 	Reference< provider::XScriptProviderFactory > xFac;
         sal_Int32 initialSize = openDocs.getLength() + 2;
         sal_Int32 mspIndex = 0;
@@ -387,17 +351,18 @@ Sequence< Reference< browse::XBrowseNode
 	    xFac.set(
                 xCtx->getValueByName(
                     OUSTR("/singletons/com.sun.star.script.provider.theMasterScriptProviderFactory") ), UNO_QUERY_THROW );
-	    
+
             locnBNs[ mspIndex++ ] = Reference< browse::XBrowseNode >( xFac->createScriptProvider( makeAny( ::rtl::OUString::createFromAscii("user") ) ), UNO_QUERY_THROW );
             locnBNs[ mspIndex++ ] = Reference< browse::XBrowseNode >( xFac->createScriptProvider( makeAny( ::rtl::OUString::createFromAscii("share") ) ), UNO_QUERY_THROW );
         }
         // TODO proper exception handling, should throw
         catch( Exception& e )
         {
+            e;
             OSL_TRACE("Caught Exception %s",
                 ::rtl::OUStringToOString( e.Message , RTL_TEXTENCODING_ASCII_US ).pData->buffer );
 	    locnBNs.realloc( mspIndex );
-            return locnBNs;	     
+            return locnBNs;
         }
 
 	for ( sal_Int32 i = 0; i < openDocs.getLength(); i++ )
@@ -406,20 +371,22 @@ Sequence< Reference< browse::XBrowseNode
             try
             {
                 Reference< frame::XModel > model( MiscUtils::tDocUrlToModel( openDocs[ i ] ), UNO_QUERY_THROW );
-	        locnBNs[ mspIndex++ ] = Reference< browse::XBrowseNode >( xFac->createScriptProvider( makeAny( model ) ), UNO_QUERY_THROW ); 
+	        locnBNs[ mspIndex++ ] = Reference< browse::XBrowseNode >( xFac->createScriptProvider( makeAny( model ) ), UNO_QUERY_THROW );
             }
             catch( Exception& e )
             {
-                
+                e;
                 OSL_TRACE("Caught Exception creating MSP for %s exception msg: %s",
                     ::rtl::OUStringToOString( openDocs[ i ] , RTL_TEXTENCODING_ASCII_US ).pData->buffer,
                     ::rtl::OUStringToOString( e.Message , RTL_TEXTENCODING_ASCII_US ).pData->buffer );
-            }		    
+            }
 
         }
     return locnBNs;
 }
 
+} // namespace
+
 typedef ::std::vector< Reference< browse::XBrowseNode > > vXBrowseNodes;
 
 struct alphaSortForBNodes
@@ -459,7 +426,7 @@ public:
                         m_xCtx  ), UNO_QUERY_THROW );
             m_xAggProxy = xProxyFac->createProxy( m_xWrappedBrowseNode );
         }
-        catch(  uno::Exception const & )
+        catch(  uno::Exception& )
         {
             OSL_ENSURE( false, "DefaultBrowseNode::DefaultBrowseNode: Caught exception!" );
         }
@@ -622,7 +589,7 @@ public:
     throw ( RuntimeException )
     {
         // no need to sort user, share, doc1...docN
-        //::std::sort( m_vNodes.begin(), m_vNodes.end(), alphaSortForBNodes() );        
+        //::std::sort( m_vNodes.begin(), m_vNodes.end(), alphaSortForBNodes() );
         Sequence < Reference< browse::XBrowseNode > > children( m_vNodes.size() );
         vXBrowseNodes::const_iterator it = m_vNodes.begin();
         for ( sal_Int32 i=0; it != m_vNodes.end() && i<children.getLength(); i++, ++it )
@@ -661,7 +628,7 @@ public:
 
 class SelectorBrowseNode :
     public ::cppu::WeakImplHelper1< browse::XBrowseNode >
-{ 
+{
 private:
     Reference< XComponentContext > m_xComponentContext;
 
@@ -681,7 +648,7 @@ public:
 	    return ::rtl::OUString::createFromAscii( "Root" );
     }
 
-    virtual Sequence< Reference< browse::XBrowseNode > > SAL_CALL 
+    virtual Sequence< Reference< browse::XBrowseNode > > SAL_CALL
     getChildNodes()
         throw ( RuntimeException )
     {
@@ -746,7 +713,7 @@ BrowseNodeFactoryImpl::createView( sal_I
     }
 }
 
-Reference< browse::XBrowseNode > 
+Reference< browse::XBrowseNode >
 BrowseNodeFactoryImpl::getSelectorHierarchy()
     throw (RuntimeException)
 {
Index: scripting/source/provider/MasterScriptProvider.cxx
===================================================================
RCS file: /cvs/framework/scripting/source/provider/MasterScriptProvider.cxx,v
retrieving revision 1.14
retrieving revision 1.14.4.1
diff -u -p -r1.14 -r1.14.4.1
--- scripting/source/provider/MasterScriptProvider.cxx	27 Jan 2005 15:31:52 -0000	1.14
+++ scripting/source/provider/MasterScriptProvider.cxx	16 Feb 2005 10:40:04 -0000	1.14.4.1
@@ -98,11 +98,11 @@ Reference< XInterface > SAL_CALL mspf_cr
 Sequence< ::rtl::OUString > SAL_CALL mspf_getSupportedServiceNames();
 
 
-bool endsWith( const ::rtl::OUString& target, 
+bool endsWith( const ::rtl::OUString& target,
     const ::rtl::OUString& item )
 {
     sal_Int32 index = 0;
-    if (  ( index = target.indexOf( item ) ) != -1  && 
+    if (  ( index = target.indexOf( item ) ) != -1  &&
        ( index == ( target.getLength() - item.getLength() ) ) )
     {
         return true;
@@ -133,7 +133,7 @@ MasterScriptProvider::~MasterScriptProvi
     //s_moduleCount.modCnt.release( &s_moduleCount.modCnt );
     if ( m_pPCache )
     {
-        delete m_pPCache; 
+        delete m_pPCache;
     }
     m_pPCache = 0;
 }
@@ -146,7 +146,7 @@ throw ( Exception, RuntimeException )
     {
         return ;
     }
-    
+
     m_bIsValid = false;
 
 
@@ -161,7 +161,7 @@ throw ( Exception, RuntimeException )
     Sequence< Any > invokeArgs( len );
 
     if ( len != 0 )
-    {    
+    {
         Any stringAny = makeAny( ::rtl::OUString() );
 
         // check if first parameter is a string
@@ -169,7 +169,7 @@ throw ( Exception, RuntimeException )
         // with a user or share ctx ( used for browse functionality )
 
         //
-        if ( args[ 0 ].getValueType() ==  ::getCppuType((const ::rtl::OUString* ) NULL ) ) 
+        if ( args[ 0 ].getValueType() ==  ::getCppuType((const ::rtl::OUString* ) NULL ) )
         {
              args[ 0 ] >>= m_sCtxString;
             invokeArgs[ 0  ] = args[ 0 ];
@@ -177,7 +177,7 @@ throw ( Exception, RuntimeException )
             {
                 m_xModel =  MiscUtils::tDocUrlToModel( m_sCtxString );
             }
-    
+
         }
         else if (  args[ 0 ].getValueType() == ::getCppuType((const Reference< frame::XModel >* ) NULL ) )
 
@@ -185,11 +185,11 @@ throw ( Exception, RuntimeException )
             try
             {
                 m_xModel.set( args[ 0 ], UNO_QUERY_THROW );
-                m_sCtxString =  MiscUtils::xModelToTdocUrl( m_xModel );
+                m_sCtxString =  MiscUtils::xModelToTdocUrl( m_xModel, m_xContext );
                 Any propValURL = makeAny( m_sCtxString );
-                invokeArgs[ 0 ] <<= propValURL; 
+                invokeArgs[ 0 ] <<= propValURL;
             }
-   
+
             catch ( beans::UnknownPropertyException & e )
             {
                 ::rtl::OUString temp = OUSTR(
@@ -219,7 +219,7 @@ throw ( Exception, RuntimeException )
     {
         // use either scriping context or maybe zero args?
         invokeArgs = Sequence< Any >( 0 ); // no arguments
-    }    
+    }
     m_sAargs = invokeArgs;
     // don't create pkg mgr MSP for documents, not supported
     if ( m_bIsPkgMSP == sal_False && !m_xModel.is() )
@@ -230,7 +230,7 @@ throw ( Exception, RuntimeException )
     m_bInitialised = true;
     m_bIsValid = true;
 }
-   
+
 
 //*************************************************************************
 void MasterScriptProvider::createPkgProvider()
@@ -246,29 +246,30 @@ void MasterScriptProvider::createPkgProv
             m_xContext->getValueByName(
                 OUSTR( "/singletons/com.sun.star.script.provider.theMasterScriptProviderFactory") ), UNO_QUERY_THROW );
 
-        m_xMSPPkg.set(  
+        m_xMSPPkg.set(
             xFac->createScriptProvider( location ), UNO_QUERY_THROW );
 
     }
     catch ( Exception& e )
     {
+        e;
         OSL_TRACE("Exception creating MasterScriptProvider for uno_packages in context %s: %s",
                 ::rtl::OUStringToOString( m_sCtxString,
                     RTL_TEXTENCODING_ASCII_US ).pData->buffer,
                 ::rtl::OUStringToOString( e.Message,
                     RTL_TEXTENCODING_ASCII_US ).pData->buffer );
     }
-} 
+}
 
 //*************************************************************************
 Reference< provider::XScript >
 MasterScriptProvider::getScript( const ::rtl::OUString& scriptURI )
-throw ( provider::ScriptFrameworkErrorException, 
+throw ( provider::ScriptFrameworkErrorException,
         RuntimeException )
 {
     if ( !isValid() )
     {
-        throw provider::ScriptFrameworkErrorException( 
+        throw provider::ScriptFrameworkErrorException(
             OUSTR( "MasterScriptProvider not initialised" ), Reference< XInterface >(),
             scriptURI, OUSTR(""),
             provider::ScriptFrameworkErrorType::UNKNOWN );
@@ -290,8 +291,8 @@ throw ( provider::ScriptFrameworkErrorEx
             scriptURI, ::rtl::OUString(),
             provider::ScriptFrameworkErrorType::UNKNOWN );
     }
-   
-    Reference<  uri::XUriReference > uriRef( 
+
+    Reference<  uri::XUriReference > uriRef(
         xFac->parse( scriptURI ), UNO_QUERY );
 
     Reference < uri::XVndSunStarScriptUrl > sfUri( uriRef, UNO_QUERY );
@@ -299,12 +300,12 @@ throw ( provider::ScriptFrameworkErrorEx
     if ( !uriRef.is() || !sfUri.is() )
     {
         ::rtl::OUString errorMsg = OUSTR( "Incorrect format for Script URI: " );
-        errorMsg = errorMsg.concat( scriptURI ); 
-        throw provider::ScriptFrameworkErrorException( 
+        errorMsg = errorMsg.concat( scriptURI );
+        throw provider::ScriptFrameworkErrorException(
             errorMsg, Reference< XInterface >(),
             scriptURI, OUSTR(""),
             provider::ScriptFrameworkErrorType::UNKNOWN );
-    } 
+    }
 
     ::rtl::OUString langKey = ::rtl::OUString::createFromAscii( "language" );
     ::rtl::OUString locKey = ::rtl::OUString::createFromAscii( "location" );
@@ -314,8 +315,8 @@ throw ( provider::ScriptFrameworkErrorEx
          ( sfUri->getName().getLength() == 0  ) )
     {
         ::rtl::OUString errorMsg = OUSTR( "Incorrect format for Script URI: " );
-        errorMsg = errorMsg.concat( scriptURI ); 
-        throw provider::ScriptFrameworkErrorException( 
+        errorMsg = errorMsg.concat( scriptURI );
+        throw provider::ScriptFrameworkErrorException(
             errorMsg, Reference< XInterface >(),
             scriptURI, OUSTR(""),
             provider::ScriptFrameworkErrorType::UNKNOWN );
@@ -324,22 +325,22 @@ throw ( provider::ScriptFrameworkErrorEx
     ::rtl::OUString language = sfUri->getParameter( langKey );
     ::rtl::OUString location = sfUri->getParameter( locKey );
 
-    // if script us located in uno pkg 
+    // if script us located in uno pkg
     sal_Int32 index = -1;
-    ::rtl::OUString pkgTag = 
+    ::rtl::OUString pkgTag =
         ::rtl::OUString::createFromAscii( ":uno_packages" );
     // for languages other than basic,  scripts located in uno packages
     // are merged into the user/share location context.
-    // For other languages the location attribute in script url has the form 
+    // For other languages the location attribute in script url has the form
     // location = [user|share]:uno_packages or location :uno_pacakges/xxxx.uno.pkg
-    // we need to extract the value of location part from the 
-    // location attribute of the script, if the script is located in an 
-    // uno package then that is the location part up to and including 
-    // ":uno_packages", if the script is not in an uno package then the 
+    // we need to extract the value of location part from the
+    // location attribute of the script, if the script is located in an
+    // uno package then that is the location part up to and including
+    // ":uno_packages", if the script is not in an uno package then the
     // normal value is used e.g. user or share.
-    // The value extracted will be used to determine if the script is 
+    // The value extracted will be used to determine if the script is
     // located in the same location context as this MSP.
-    // For Basic, the language script provider can handle the execution of a 
+    // For Basic, the language script provider can handle the execution of a
     // script in any location context
     if ( ( index = location.indexOf( pkgTag ) ) > -1 )
     {
@@ -347,8 +348,8 @@ throw ( provider::ScriptFrameworkErrorEx
     }
 
     Reference< provider::XScript > xScript;
- 
-    // If the script location is in the same location context as this 
+
+    // If the script location is in the same location context as this
     // MSP then delate to the lanaguage provider controlled by this MSP
     // ** Special case is BASIC, all calls to getScript will be handled
     // by the language script provider in the current location context
@@ -367,13 +368,13 @@ throw ( provider::ScriptFrameworkErrorEx
         {
             try
             {
-                xScriptProvider.set( 
-                    providerCache()->getProvider( serviceName ), 
+                xScriptProvider.set(
+                    providerCache()->getProvider( serviceName ),
                     UNO_QUERY_THROW );
             }
             catch( Exception& e )
             {
-                throw provider::ScriptFrameworkErrorException( 
+                throw provider::ScriptFrameworkErrorException(
                     e.Message, Reference< XInterface >(),
                     sfUri->getName(), language,
                     provider::ScriptFrameworkErrorType::NOTSUPPORTED );
@@ -381,8 +382,8 @@ throw ( provider::ScriptFrameworkErrorEx
         }
         else
         {
-            throw provider::ScriptFrameworkErrorException( 
-                OUSTR( "No LanguageProviders detected" ), 
+            throw provider::ScriptFrameworkErrorException(
+                OUSTR( "No LanguageProviders detected" ),
                 Reference< XInterface >(),
                 sfUri->getName(), language,
                 provider::ScriptFrameworkErrorType::NOTSUPPORTED );
@@ -395,7 +396,7 @@ throw ( provider::ScriptFrameworkErrorEx
             m_xContext->getValueByName(
                 OUSTR( "/singletons/com.sun.star.script.provider.theMasterScriptProviderFactory") ), UNO_QUERY_THROW );
 
-        Reference< provider::XScriptProvider > xSP( 
+        Reference< provider::XScriptProvider > xSP(
             xFac->createScriptProvider( makeAny( location ) ), UNO_QUERY_THROW );
         xScript = xSP->getScript( scriptURI );
     }
@@ -410,7 +411,7 @@ MasterScriptProvider::isValid()
 }
 
 //*************************************************************************
-ProviderCache* 
+ProviderCache*
 MasterScriptProvider::providerCache()
 {
     if ( !m_pPCache )
@@ -431,7 +432,7 @@ MasterScriptProvider::providerCache()
             else
             {
                 m_pPCache = new ProviderCache( m_xContext, m_sAargs, blacklist );
-            }                            
+            }
         }
     }
     return m_pPCache;
@@ -439,7 +440,7 @@ MasterScriptProvider::providerCache()
 
 
 //*************************************************************************
-::rtl::OUString SAL_CALL 
+::rtl::OUString SAL_CALL
 MasterScriptProvider::getName()
         throw ( css::uno::RuntimeException )
 {
@@ -448,9 +449,9 @@ MasterScriptProvider::getName()
         ::rtl::OUString sCtx = getContextString();
         if ( sCtx.indexOf( OUSTR( "vnd.sun.star.tdoc" ) ) == 0 )
         {
-            // seems to be a bug with tdoc, Title is 
-            // incorrect after a save-as, also
-            // Title property is not returned if it is set
+            // @@@ cannot be used because title returned is not the same
+            //     as returned by MiscUtils::xModelToDocTitle(). And this
+            //     would break code in SVX (source/dialog/selector.cxx).
             //m_sNodeName = MiscUtils::tDocUrlToTitle( sCtx );
 
             Reference< frame::XModel > xModel = m_xModel;
@@ -474,8 +475,8 @@ MasterScriptProvider::getName()
 }
 
 //*************************************************************************
-Sequence< Reference< browse::XBrowseNode > > SAL_CALL 
-MasterScriptProvider::getChildNodes() 
+Sequence< Reference< browse::XBrowseNode > > SAL_CALL
+MasterScriptProvider::getChildNodes()
         throw ( css::uno::RuntimeException )
 {
     Sequence< Reference< provider::XScriptProvider > > providers = getAllProviders();
@@ -504,16 +505,16 @@ MasterScriptProvider::getChildNodes() 
 }
 
 //*************************************************************************
-sal_Bool SAL_CALL 
-MasterScriptProvider::hasChildNodes() 
+sal_Bool SAL_CALL
+MasterScriptProvider::hasChildNodes()
         throw ( css::uno::RuntimeException )
 {
     return sal_True;
 }
 
 //*************************************************************************
-sal_Int16 SAL_CALL 
-MasterScriptProvider::getType() 
+sal_Int16 SAL_CALL
+MasterScriptProvider::getType()
         throw ( css::uno::RuntimeException )
 {
     return browse::BrowseNodeTypes::CONTAINER;
@@ -602,7 +603,7 @@ MasterScriptProvider::insertByName( cons
                 xCont->insertByName( aName, aElement );
                 break;
             }
-            catch ( Exception& ignore )
+            catch ( Exception& )
             {
             }
 
@@ -676,7 +677,7 @@ MasterScriptProvider::removeByName( cons
                 xCont->removeByName( Name );
                 break;
             }
-            catch ( Exception& ignore )
+            catch ( Exception& )
             {
             }
 
@@ -779,7 +780,7 @@ MasterScriptProvider::hasByName( const :
                     break;
                 }
             }
-            catch ( Exception& ignore )
+            catch ( Exception& )
             {
             }
 
@@ -838,7 +839,7 @@ MasterScriptProvider::getAllProviders() 
     }
 }
 
- 
+
 //*************************************************************************
 ::rtl::OUString SAL_CALL MasterScriptProvider::getImplementationName( )
 throw( RuntimeException )
@@ -952,7 +953,7 @@ static struct cppu::ImplementationEntry 
  */
 extern "C"
 {
-    void SAL_CALL component_getImplementationEnvironment( 
+    void SAL_CALL component_getImplementationEnvironment(
             const sal_Char ** ppEnvTypeName, uno_Environment ** ppEnv )
     {
         *ppEnvTypeName = CPPU_CURRENT_LANGUAGE_BINDING_NAME;
@@ -965,7 +966,7 @@ extern "C"
      * @param pServiceManager   the service manager
      * @param pRegistryKey      the registry key
      */
-    sal_Bool SAL_CALL component_writeInfo( 
+    sal_Bool SAL_CALL component_writeInfo(
             lang::XMultiServiceFactory * pServiceManager,
             registry::XRegistryKey * pRegistryKey )
     {
@@ -987,7 +988,7 @@ extern "C"
                 xKey->setStringValue( OUSTR("com.sun.star.script.browse.BrowseNodeFactory") );
                 return sal_True;
             }
-            catch (Exception & exc)
+            catch (Exception &)
             {
             }
         }
@@ -1001,7 +1002,7 @@ extern "C"
      * @param pServiceManager a service manager, need for component creation
      * @param pRegistryKey    the registry key for this component, need for persistent
      *                        data
-     * @return a component factory 
+     * @return a component factory
      */
     void * SAL_CALL component_getFactory( const sal_Char * pImplName,
         lang::XMultiServiceFactory * pServiceManager,
Index: scripting/source/provider/MasterScriptProviderFactory.cxx
===================================================================
RCS file: /cvs/framework/scripting/source/provider/MasterScriptProviderFactory.cxx,v
retrieving revision 1.5
retrieving revision 1.5.4.1
diff -u -p -r1.5 -r1.5.4.1
--- scripting/source/provider/MasterScriptProviderFactory.cxx	27 Jan 2005 15:32:17 -0000	1.5
+++ scripting/source/provider/MasterScriptProviderFactory.cxx	16 Feb 2005 10:39:05 -0000	1.5.4.1
@@ -83,13 +83,12 @@ namespace func_provider
 
 MasterScriptProviderFactory::MasterScriptProviderFactory(
     Reference< XComponentContext > const & xComponentContext )
-    : m_xComponentContext( xComponentContext ), m_MSPList(0)
+    : m_xComponentContext( xComponentContext )
 {
 }
 
 MasterScriptProviderFactory::~MasterScriptProviderFactory()
 {
-    if (m_MSPList) delete m_MSPList;
 }
 
 
@@ -98,30 +97,27 @@ MasterScriptProviderFactory::~MasterScri
 //############################################################################
 
 
-Reference< provider::XScriptProvider > SAL_CALL 
+Reference< provider::XScriptProvider > SAL_CALL
 MasterScriptProviderFactory::createScriptProvider( const Any& context ) throw ( lang::IllegalArgumentException, RuntimeException)
 {
-    Reference< provider::XScriptProvider > xMsp( getActiveMSPList().createMSP( context ), UNO_QUERY_THROW );
-    return xMsp;    
+    Reference< provider::XScriptProvider > xMsp( getActiveMSPList()->createMSP( context ), UNO_QUERY_THROW );
+    return xMsp;
 }
 
 //############################################################################
 // Helper methods
 //############################################################################
 
-ActiveMSPList&
-MasterScriptProviderFactory::getActiveMSPList()
+const rtl::Reference< ActiveMSPList > &
+MasterScriptProviderFactory::getActiveMSPList() const
 {
-    if ( !m_MSPList )
+    if ( !m_MSPList.is() )
     {
         ::osl::MutexGuard guard( ::osl::Mutex::getGlobalMutex() );
-        if ( !m_MSPList )
-        {
-           m_MSPList = new ActiveMSPList( m_xComponentContext ); 
-           m_MSPListHolder = m_MSPList;
-        }
-    } 
-    return *m_MSPList;
+        if ( !m_MSPList.is() )
+           m_MSPList = new ActiveMSPList( m_xComponentContext );
+    }
+    return m_MSPList;
 }
 
 //############################################################################
Index: scripting/source/provider/MasterScriptProviderFactory.hxx
===================================================================
RCS file: /cvs/framework/scripting/source/provider/MasterScriptProviderFactory.hxx,v
retrieving revision 1.4
retrieving revision 1.4.16.1
diff -u -p -r1.4 -r1.4.16.1
--- scripting/source/provider/MasterScriptProviderFactory.hxx	23 Dec 2004 11:50:41 -0000	1.4
+++ scripting/source/provider/MasterScriptProviderFactory.hxx	16 Feb 2005 10:39:05 -0000	1.4.16.1
@@ -58,7 +58,8 @@
  *
  *
  ************************************************************************/
-#include <rtl/ustring>
+#include "rtl/ustring.hxx"
+#include "rtl/ref.hxx"
 #include <cppuhelper/implbase2.hxx>
 
 #include <com/sun/star/uno/XComponentContext.hpp>
@@ -83,15 +84,11 @@ class MasterScriptProviderFactory :
 {
 private:
 
-    ActiveMSPList* m_MSPList;
+    mutable rtl::Reference< ActiveMSPList > m_MSPList;
 
-    // need to not only hold a pointer to this object but also
-    // keep it aqcuired
-    css::uno::Reference< css::lang::XEventListener > m_MSPListHolder;
-    
-    css::uno::Reference< css::uno::XComponentContext > m_xComponentContext;
+    const css::uno::Reference< css::uno::XComponentContext > m_xComponentContext;
 
-    ActiveMSPList& getActiveMSPList();
+    const rtl::Reference< ActiveMSPList > & getActiveMSPList() const;
 
 protected:
     virtual ~MasterScriptProviderFactory();
@@ -113,8 +110,8 @@ public:
             throw ( css::uno::RuntimeException );
 
     // XScriptProviderFactory
-    virtual css::uno::Reference< css::script::provider::XScriptProvider > 
-	    SAL_CALL createScriptProvider( const css::uno::Any& context ) 
+    virtual css::uno::Reference< css::script::provider::XScriptProvider >
+	    SAL_CALL createScriptProvider( const css::uno::Any& context )
 	        throw ( css::lang::IllegalArgumentException, css::uno::RuntimeException);
 };
 
Index: svx/source/init/init.cxx
===================================================================
RCS file: /cvs/graphics/svx/source/init/init.cxx,v
retrieving revision 1.3
retrieving revision 1.3.136.1
diff -u -p -r1.3 -r1.3.136.1
--- svx/source/init/init.cxx	13 Jan 2005 18:52:21 -0000	1.3
+++ svx/source/init/init.cxx	17 Feb 2005 14:43:26 -0000	1.3.136.1
@@ -71,7 +71,7 @@
 // ------------------------------------------------------------------------
 //Sonderzeichen einfuegen fuer Edits
 
-extern "C" String GetSpecialCharsForEdit(Window* pParent, const Font& rFont)
+extern "C" SVX_DLLPUBLIC String GetSpecialCharsForEdit(Window* pParent, const Font& rFont)
 {
     String sRet;
 	SvxAbstractDialogFactory* pFact = SvxAbstractDialogFactory::Create();
Index: dbaccess/source/core/dataaccess/databasedocument.cxx
===================================================================
RCS file: /cvs/dba/dbaccess/source/core/dataaccess/databasedocument.cxx,v
retrieving revision 1.9
retrieving revision 1.9.12.1
diff -u -p -r1.9 -r1.9.12.1
--- dbaccess/source/core/dataaccess/databasedocument.cxx	2 Feb 2005 14:01:30 -0000	1.9
+++ dbaccess/source/core/dataaccess/databasedocument.cxx	15 Feb 2005 09:10:03 -0000	1.9.12.1
@@ -134,7 +134,7 @@ using namespace ::com::sun::star;
 using namespace ::com::sun::star::xml::sax;
 using namespace ::cppu;
 using namespace ::osl;
-
+namespace css = ::com::sun::star;
 //........................................................................
 namespace dbaccess
 {
@@ -145,12 +145,12 @@ void SAL_CALL ODatabaseSource::dispose( 
 	OSubComponent::dispose();
 }
 // -----------------------------------------------------------------------------
-void SAL_CALL ODatabaseSource::addEventListener( const Reference< XEventListener >& _xListener ) throw (RuntimeException)
+void SAL_CALL ODatabaseSource::addEventListener( const Reference< css::lang::XEventListener >& _xListener ) throw (RuntimeException)
 {
 	OSubComponent::addEventListener(_xListener);
 }
 // -----------------------------------------------------------------------------
-void SAL_CALL ODatabaseSource::removeEventListener( const Reference< XEventListener >& _xListener ) throw (RuntimeException)
+void SAL_CALL ODatabaseSource::removeEventListener( const Reference< css::lang::XEventListener >& _xListener ) throw (RuntimeException)
 {
 	OSubComponent::removeEventListener(_xListener);
 }
@@ -565,6 +565,25 @@ void SAL_CALL ODatabaseSource::setModifi
 	}
 }
 // -----------------------------------------------------------------------------
+// ::com::sun::star::document::XEventBroadcaster
+void SAL_CALL ODatabaseSource::addEventListener(const css::uno::Reference< css::document::XEventListener >& _xListener ) throw (css::uno::RuntimeException)
+{
+    m_aDocEventListeners.addInterface(_xListener);
+}
+// -----------------------------------------------------------------------------
+void SAL_CALL ODatabaseSource::removeEventListener( const css::uno::Reference< css::document::XEventListener >& _xListener ) throw (css::uno::RuntimeException)
+{
+    m_aDocEventListeners.removeInterface(_xListener);
+}
+// -----------------------------------------------------------------------------
+// ::com::sun::star::document::XEventListener
+void SAL_CALL ODatabaseSource::notifyEvent( const css::document::EventObject& aEvent ) throw (css::uno::RuntimeException)
+{
+    // used only to forward external events (e.g. for doc creation) from the frame loader
+    // to the global event broadcaster and all other interested doc event listener.
+    notifyEvent(aEvent.EventName);
+}
+// -----------------------------------------------------------------------------
 // ::com::sun::star::view::XPrintable
 Sequence< PropertyValue > SAL_CALL ODatabaseSource::getPrinter(  ) throw (RuntimeException) 
 {
@@ -718,7 +737,7 @@ Reference<XStorage> ODatabaseSource::get
 				xStorage = xMyStorage->openStorageElement(_sStorageName, m_bDocumentReadOnly ? ElementModes::READ : nMode);
 				Reference<XComponent> xComp(xStorage,UNO_QUERY);
 				if ( xComp.is() )
-					xComp->addEventListener(this);
+					xComp->addEventListener(static_cast< css::document::XEventListener* >(this));
 				aFind = m_aStorages.insert(TStorages::value_type(_sStorageName,xStorage)).first;
 			}
 			catch(Exception&)
@@ -1090,11 +1109,18 @@ void SAL_CALL ODatabaseSource::removeFlu
 // -----------------------------------------------------------------------------
 void ODatabaseSource::notifyEvent(const ::rtl::OUString& _sEventName)
 {
-    if ( m_xDocEventBroadcaster.is() )
-    {
-        ::com::sun::star::document::EventObject aEvent(*this, _sEventName);
-        m_xDocEventBroadcaster->notifyEvent(aEvent);
-    }
+	try
+	{
+		ResettableMutexGuard _rGuard(m_aMutex);
+		if (OComponentHelper::rBHelper.bDisposed)
+			throw DisposedException();
+		
+		css::document::EventObject aEvt(*this, _sEventName);
+		NOTIFY_LISTERNERS(m_aDocEventListeners,css::document::XEventListener,notifyEvent)
+	}
+	catch(Exception&)
+	{
+	}
 }
 // -----------------------------------------------------------------------------
 sal_Bool ODatabaseSource::commitEmbeddedStorage()
Index: dbaccess/source/core/dataaccess/datasource.cxx
===================================================================
RCS file: /cvs/dba/dbaccess/source/core/dataaccess/datasource.cxx,v
retrieving revision 1.54
retrieving revision 1.54.12.1
diff -u -p -r1.54 -r1.54.12.1
--- dbaccess/source/core/dataaccess/datasource.cxx	2 Feb 2005 13:59:34 -0000	1.54
+++ dbaccess/source/core/dataaccess/datasource.cxx	15 Feb 2005 09:10:03 -0000	1.54.12.1
@@ -164,6 +164,7 @@ using namespace ::osl;
 using namespace ::vos;
 using namespace ::dbtools;
 using namespace ::comphelper;
+namespace css = ::com::sun::star;
 
 //........................................................................
 namespace dbaccess
@@ -531,6 +532,7 @@ ODatabaseSource::ODatabaseSource(const R
 			,m_aModifyListeners(m_aMutex)
 			,m_aCloseListener(m_aMutex)
 			,m_aFlushListeners(m_aMutex)
+			,m_aDocEventListeners(m_aMutex)
 			,m_pDBContext(_pDBContext)
 			,m_nControllerLockCount(0)
 {
@@ -565,6 +567,7 @@ ODatabaseSource::ODatabaseSource(
 			,m_aModifyListeners(m_aMutex)
 			,m_aCloseListener(m_aMutex)
 			,m_aFlushListeners(m_aMutex)
+			,m_aDocEventListeners(m_aMutex)
 			,m_pDBContext(_pDBContext)
 			,m_nControllerLockCount(0)
 {
@@ -590,15 +593,6 @@ void ODatabaseSource::lateInit()
 	m_bReadOnly = sal_False;
 	m_aContainer.resize(4);
 	m_pChildCommitListen = NULL;
-    try
-    {
-        m_xDocEventBroadcaster.set(m_xServiceFactory->createInstance(::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("com.sun.star.frame.GlobalEventBroadcaster"))),
-            UNO_QUERY);
-    }
-    catch(Exception)
-    {
-        OSL_ENSURE(0,"Could not create GlobalEventBroadcaster!");
-    }
 }
 // -----------------------------------------------------------------------------
 void ODatabaseSource::setMeAsParent(const Reference< XNameAccess >& _xName)
@@ -805,6 +799,7 @@ void ODatabaseSource::disposing()
 	m_aModifyListeners.disposeAndClear( aDisposeEvent );
 	m_aCloseListener.disposeAndClear( aDisposeEvent );
 	m_aFlushListeners.disposeAndClear( aDisposeEvent );
+	m_aDocEventListeners.disposeAndClear( aDisposeEvent );
 
 	::std::vector<TContentPtr>::iterator aIter = m_aContainer.begin();
 	::std::vector<TContentPtr>::iterator aEnd = m_aContainer.end();
@@ -1314,7 +1309,7 @@ Reference< XConnection > ODatabaseSource
 	{
 		Reference< XComponent> xComp(xConn,UNO_QUERY);
 		if ( xComp.is() )
-			xComp->addEventListener(this);
+			xComp->addEventListener(static_cast< css::document::XEventListener* >(this));
 		m_aConnections.push_back(OWeakConnection(xConn));
 	}
 
Index: dbaccess/source/core/dataaccess/datasource.hxx
===================================================================
RCS file: /cvs/dba/dbaccess/source/core/dataaccess/datasource.hxx,v
retrieving revision 1.25
retrieving revision 1.25.14.1
diff -u -p -r1.25 -r1.25.14.1
--- dbaccess/source/core/dataaccess/datasource.hxx	2 Feb 2005 13:59:48 -0000	1.25
+++ dbaccess/source/core/dataaccess/datasource.hxx	15 Feb 2005 09:10:04 -0000	1.25.14.1
@@ -110,6 +110,9 @@
 #ifndef _CPPUHELPER_IMPLBASE9_HXX_
 #include <cppuhelper/implbase9.hxx>
 #endif
+#ifndef _CPPUHELPER_IMPLBASE11_HXX_
+#include <cppuhelper/implbase11.hxx>
+#endif
 #ifndef _DBASHARED_APITOOLS_HXX_
 #include "apitools.hxx"
 #endif
@@ -211,7 +214,7 @@ typedef	::cppu::ImplHelper9	<	::com::sun
 							>	ODatabaseSource_Base;
 
 
-typedef ::cppu::ImplHelper9	<	::com::sun::star::frame::XModel
+typedef ::cppu::ImplHelper11<	::com::sun::star::frame::XModel
 							,	::com::sun::star::util::XModifiable
 							,	::com::sun::star::frame::XStorable
 							,	::com::sun::star::view::XPrintable
@@ -220,6 +223,8 @@ typedef ::cppu::ImplHelper9	<	::com::sun
 							,	::com::sun::star::util::XCloseable
 							,	::drafts::com::sun::star::ui::XUIConfigurationManagerSupplier
 							,	::com::sun::star::document::XDocumentSubStorageSupplier
+							,	::com::sun::star::document::XEventBroadcaster
+							,	::com::sun::star::document::XEventListener
 							>	ODatabaseSource_OfficeDocument; 
 
 
@@ -288,12 +293,12 @@ protected:
 	::cppu::OInterfaceContainerHelper					m_aModifyListeners;
 	::cppu::OInterfaceContainerHelper					m_aCloseListener;
 	::cppu::OInterfaceContainerHelper					m_aFlushListeners;
+	::cppu::OInterfaceContainerHelper					m_aDocEventListeners;
 
 	::com::sun::star::uno::Reference< ::com::sun::star::lang::XEventListener>					m_xSharedConnectionManager;
 	::com::sun::star::uno::Reference< ::com::sun::star::frame::XController>						m_xCurrentController;
 	::com::sun::star::uno::Reference< ::com::sun::star::embed::XStorage >						m_xStorage;
 	::com::sun::star::uno::Reference< ::drafts::com::sun::star::ui::XUIConfigurationManager>	m_xUIConfigurationManager;
-    ::com::sun::star::uno::Reference< ::com::sun::star::document::XEventListener >              m_xDocEventBroadcaster;
 
 
 	ODatabaseContext*									m_pDBContext;
@@ -477,6 +482,13 @@ public:
 	virtual sal_Bool SAL_CALL isModified(  ) throw (::com::sun::star::uno::RuntimeException) ;
     virtual void SAL_CALL setModified( sal_Bool bModified ) throw (::com::sun::star::beans::PropertyVetoException, ::com::sun::star::uno::RuntimeException) ;
 
+// ::com::sun::star::document::XEventBroadcaster
+    virtual void SAL_CALL addEventListener( const ::com::sun::star::uno::Reference< ::com::sun::star::document::XEventListener >& aListener ) throw (::com::sun::star::uno::RuntimeException);
+    virtual void SAL_CALL removeEventListener( const ::com::sun::star::uno::Reference< ::com::sun::star::document::XEventListener >& aListener ) throw (::com::sun::star::uno::RuntimeException);
+    
+// ::com::sun::star::document::XEventListener
+    virtual void SAL_CALL notifyEvent( const ::com::sun::star::document::EventObject& aEvent ) throw (::com::sun::star::uno::RuntimeException);
+    
 // ::com::sun::star::view::XPrintable
 	virtual ::com::sun::star::uno::Sequence< ::com::sun::star::beans::PropertyValue > SAL_CALL getPrinter(  ) throw (::com::sun::star::uno::RuntimeException) ;
     virtual void SAL_CALL setPrinter( const ::com::sun::star::uno::Sequence< ::com::sun::star::beans::PropertyValue >& aPrinter ) throw (::com::sun::star::lang::IllegalArgumentException, ::com::sun::star::uno::RuntimeException) ;
Index: dbaccess/source/filter/xml/dbloader2.cxx
===================================================================
RCS file: /cvs/dba/dbaccess/source/filter/xml/dbloader2.cxx,v
retrieving revision 1.6
retrieving revision 1.6.12.1
diff -u -p -r1.6 -r1.6.12.1
--- dbaccess/source/filter/xml/dbloader2.cxx	2 Feb 2005 14:00:07 -0000	1.6
+++ dbaccess/source/filter/xml/dbloader2.cxx	15 Feb 2005 09:10:04 -0000	1.6.12.1
@@ -177,6 +177,7 @@ using namespace ::com::sun::star::contai
 using namespace ::com::sun::star::lang;
 using namespace ::com::sun::star::document;
 using namespace ::com::sun::star::registry;
+namespace css = ::com::sun::star;
 
 // -------------------------------------------------------------------------
 namespace dbaxml
@@ -466,17 +467,16 @@ void SAL_CALL DBContentLoader::load(cons
 
         try
         {
-            Reference< ::com::sun::star::document::XEventListener > xDocEventBroadcaster(m_xServiceFactory->createInstance(::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("com.sun.star.frame.GlobalEventBroadcaster"))),
-                UNO_QUERY);
-            if ( xDocEventBroadcaster.is() )
-            {
-                ::com::sun::star::document::EventObject aEvent(xModel, bCreateNew ? ::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("OnNew")) : ::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("OnLoad")));
-                xDocEventBroadcaster->notifyEvent(aEvent);
-            }
+            Reference< css::container::XSet > xModelCollection(m_xServiceFactory->createInstance(::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("com.sun.star.frame.GlobalEventBroadcaster"))),UNO_QUERY_THROW);
+            xModelCollection->insert(css::uno::makeAny(xModel));
+
+            Reference< css::document::XEventListener > xDocEventBroadcaster(xModel,UNO_QUERY_THROW);
+            css::document::EventObject aEvent(xModel, bCreateNew ? ::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("OnNew")) : ::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("OnLoad")));
+            xDocEventBroadcaster->notifyEvent(aEvent);
         }
         catch(Exception)
         {
-            OSL_ENSURE(0,"Could not create GlobalEventBroadcaster!");
+            OSL_ENSURE(0,"Could not add database model to global model collection and broadcast the events OnNew/OnLoad!");
         }
 		rListener->loadFinished(this);        
 	}
Index: dbaccess/source/ui/uno/DBTypeWizDlgSetup.cxx
===================================================================
RCS file: /cvs/dba/dbaccess/source/ui/uno/DBTypeWizDlgSetup.cxx,v
retrieving revision 1.3
retrieving revision 1.3.12.1
diff -u -p -r1.3 -r1.3.12.1
--- dbaccess/source/ui/uno/DBTypeWizDlgSetup.cxx	2 Feb 2005 14:00:23 -0000	1.3
+++ dbaccess/source/ui/uno/DBTypeWizDlgSetup.cxx	15 Feb 2005 09:10:04 -0000	1.3.12.1
@@ -65,6 +65,9 @@
 #ifndef _COM_SUN_STAR_DOCUMENT_XEVENTLISTENER_HPP_
 #include <com/sun/star/document/XEventListener.hpp>
 #endif
+#ifndef _COM_SUN_STAR_CONTAINER_XSET_HPP_
+#include <com/sun/star/container/XSet.hpp>
+#endif
 #ifndef DBAUI_DBTYPEWIZDLGSETUP_HXX
 #include "DBTypeWizDlgSetup.hxx"
 #endif
@@ -73,6 +76,7 @@
 #endif
 
 using namespace dbaui;
+namespace css = ::com::sun::star;
                          
 extern "C" void SAL_CALL createRegistryInfo_ODBTypeWizDialogSetup()
 {
@@ -119,17 +123,16 @@ Reference< XInterface > SAL_CALL ODBType
 
     try
     {
-        Reference< ::com::sun::star::document::XEventListener > xDocEventBroadcaster(_rxFactory->createInstance(::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("com.sun.star.frame.GlobalEventBroadcaster"))),
-            UNO_QUERY);
-        if ( xDocEventBroadcaster.is() )
-        {
-            ::com::sun::star::document::EventObject aEvent(xDBContext, ::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("OnNew")) );
-            xDocEventBroadcaster->notifyEvent(aEvent);
-        }
+        Reference< css::container::XSet > xModelCollection(_rxFactory->createInstance(::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("com.sun.star.frame.GlobalEventBroadcaster"))),UNO_QUERY_THROW);
+        xModelCollection->insert(css::uno::makeAny(xDBContext));
+
+        Reference< css::document::XEventListener > xDocEventBroadcaster(xDBContext,UNO_QUERY_THROW);
+        ::com::sun::star::document::EventObject aEvent(xDBContext, ::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("OnNew")));
+        xDocEventBroadcaster->notifyEvent(aEvent);
     }
     catch(Exception)
     {
-        OSL_ENSURE(0,"Could not create GlobalEventBroadcaster!");
+        OSL_ENSURE(0,"Could not create append model to global model collectiona and broadcaste document events for it!");
     }
     Reference <com::sun::star::ui::dialogs::XExecutableDialog> xDBWizardExecute( xDBWizard, UNO_QUERY );
     xDBWizardExecute->execute();
Index: vcl/source/app/svdata.cxx
===================================================================
RCS file: /cvs/gsl/vcl/source/app/svdata.cxx,v
retrieving revision 1.36
retrieving revision 1.36.54.1
diff -u -p -r1.36 -r1.36.54.1
--- vcl/source/app/svdata.cxx	13 Jan 2005 17:58:11 -0000	1.36
+++ vcl/source/app/svdata.cxx	23 Feb 2005 11:33:20 -0000	1.36.54.1
@@ -196,6 +196,7 @@ void ImplInitSVData()
 
     // init global instance data
     memset( pSVData, 0, sizeof( ImplSVData ) );
+    pSVData->maHelpData.mbAutoHelpId = sal_True;
 }
 
 // -----------------------------------------------------------------------
Index: ucb/source/ucp/tdoc/tdoc_docmgr.cxx
===================================================================
RCS file: /cvs/ucb/ucb/source/ucp/tdoc/tdoc_docmgr.cxx,v
retrieving revision 1.6
retrieving revision 1.6.22.1
diff -u -p -r1.6 -r1.6.22.1
--- ucb/source/ucp/tdoc/tdoc_docmgr.cxx	23 Dec 2004 09:41:33 -0000	1.6
+++ ucb/source/ucp/tdoc/tdoc_docmgr.cxx	16 Feb 2005 10:32:30 -0000	1.6.22.1
@@ -73,7 +73,7 @@
 #include "cppuhelper/weak.hxx"
 
 #include "com/sun/star/beans/XPropertySet.hpp"
-#include "com/sun/star/frame/XFramesSupplier.hpp"
+#include "com/sun/star/container/XEnumerationAccess.hpp"
 #include "com/sun/star/frame/XStorable.hpp"
 #include "com/sun/star/lang/DisposedException.hpp"
 #include "com/sun/star/document/XStorageBasedDocument.hpp"
@@ -492,116 +492,69 @@ OfficeDocumentsManager::createDocumentEv
 //=========================================================================
 void OfficeDocumentsManager::buildDocumentsList()
 {
-    uno::Reference< uno::XInterface > xIfc;
-    try
-    {
-        xIfc = m_xSMgr->createInstance(
-            rtl::OUString(
-                RTL_CONSTASCII_USTRINGPARAM( "com.sun.star.frame.Desktop" ) ) );
-    }
-    catch ( uno::Exception const & )
-    {
-        // handled below.
-    }
-
-    OSL_ENSURE( xIfc.is(), "Could not instanciate com.sun.star.frame.Desktop" );
-
-    if ( !xIfc.is() )
-        return;
-
-    uno::Reference< frame::XFramesSupplier > xFS( xIfc, uno::UNO_QUERY );
+    OSL_ENSURE( m_xDocEvtNotifier.is(),
+                "OfficeDocumentsManager::buildDocumentsList - "
+                "No document event notifier!" );
 
-    OSL_ENSURE( xFS.is(), "com.sun.star.frame.Desktop does not implement "
-                          "interface com.sun.star.frame.XFramesSupplier!" );
+    uno::Reference< container::XEnumerationAccess > xEnumAccess(
+        m_xDocEvtNotifier, uno::UNO_QUERY_THROW );
 
-    if ( !xFS.is() )
-        return;
+    uno::Reference< container::XEnumeration > xEnum
+        = xEnumAccess->createEnumeration();
 
-    uno::Reference< container::XIndexAccess > xFrames
-        = uno::Reference< container::XIndexAccess >(
-            xFS->getFrames(), uno::UNO_QUERY );
+    osl::MutexGuard aGuard( m_aMtx );
 
-    if ( xFrames.is() )
+    while ( xEnum->hasMoreElements() )
     {
-        osl::MutexGuard aGuard( m_aMtx );
+        uno::Any aValue = xEnum->nextElement();
+        // container::NoSuchElementException
+        // lang::WrappedTargetException
 
-        sal_Int32 nCount = xFrames->getCount();
-        for ( sal_Int32 n = 0; n < nCount; ++n )
+        try
         {
-            try
-            {
-                uno::Reference< frame::XFrame > xFrame(
-                    xFrames->getByIndex( n ), uno::UNO_QUERY );
+            uno::Reference< frame::XModel > xModel;
+            aValue >>= xModel;
 
-                if ( xFrame.is() )
+            if ( xModel.is() )
+            {
+                if ( isOfficeDocument( xModel ) )
                 {
-                    uno::Reference< frame::XController > xController
-                        = xFrame->getController();
-
-                    if ( xController.is() )
+                    DocumentList::const_iterator it = m_aDocs.begin();
+                    while ( it != m_aDocs.end() )
                     {
-                        uno::Reference< frame::XModel > xModel
-                            = xController->getModel();
-                        if ( xModel.is() )
+                        if ( (*it).second.xModel == xModel )
                         {
-                            if ( isOfficeDocument( xModel ) )
-                            {
-                                DocumentList::const_iterator it
-                                    = m_aDocs.begin();
-                                while ( it != m_aDocs.end() )
-                                {
-                                    if ( (*it).second.xModel == xModel )
-                                    {
-                                        // already known.
-                                        break;
-                                    }
-                                    ++it;
-                                }
-
-                                if ( it == m_aDocs.end() )
-                                {
-                                    // new document
-                                    rtl::OUString aDocId
-                                        = getDocumentId( xModel );
-                                    rtl::OUString aTitle
-                                        = getDocumentTitle( xModel );
-
-                                    uno::Reference<
-                                        document::XStorageBasedDocument >
-                                            xDoc( xModel, uno::UNO_QUERY );
-                                    OSL_ENSURE( xDoc.is(),
-                                        "Got no "
-                                        "document::XStorageBasedDocument!" );
-
-                                    uno::Reference< embed::XStorage > xStorage
-                                        = xDoc->getDocumentStorage();
-                                    OSL_ENSURE( xDoc.is(),
-                                        "Got no document storage!" );
-
-                                    m_aDocs[ aDocId ]
-                                        = StorageInfo(
-                                            aTitle, xStorage, xModel );
-                                }
-                            }
+                            // already known.
+                            break;
                         }
+                        ++it;
+                    }
+
+                    if ( it == m_aDocs.end() )
+                    {
+                        // new document
+                        rtl::OUString aDocId = getDocumentId( xModel );
+                        rtl::OUString aTitle = getDocumentTitle( xModel );
+
+                        uno::Reference< document::XStorageBasedDocument >
+                                xDoc( xModel, uno::UNO_QUERY );
+                        OSL_ENSURE( xDoc.is(),
+                            "Got no document::XStorageBasedDocument!" );
+
+                        uno::Reference< embed::XStorage > xStorage
+                            = xDoc->getDocumentStorage();
+                        OSL_ENSURE( xDoc.is(), "Got no document storage!" );
+
+                        m_aDocs[ aDocId ]
+                            = StorageInfo( aTitle, xStorage, xModel );
                     }
                 }
             }
-            catch ( lang::IndexOutOfBoundsException const & )
-            {
-                // getByIndex
-            }
-            catch ( lang::WrappedTargetException const & )
-            {
-                // getByIndex
-            }
-            catch ( lang::DisposedException const & )
-            {
-                // Note: Due to race conditions the XIndexAccess can
-                //       return docs that already have been closed
-                //       => take care about DisposedExceptions when
-                //          accessing xFrame!
-            }
+        }
+        catch ( lang::DisposedException const & )
+        {
+            // Note: Due to race conditions the XEnumeration can
+            //       contains docs that already have been closed
         }
     }
 }
Index: ucb/source/ucp/tdoc/ucptdoc.xml
===================================================================
RCS file: /cvs/ucb/ucb/source/ucp/tdoc/ucptdoc.xml,v
retrieving revision 1.4
retrieving revision 1.4.30.1
diff -u -p -r1.4 -r1.4.30.1
--- ucb/source/ucp/tdoc/ucptdoc.xml	9 Nov 2004 15:35:05 -0000	1.4
+++ ucb/source/ucp/tdoc/ucptdoc.xml	16 Feb 2005 10:32:31 -0000	1.4.30.1
@@ -33,9 +33,6 @@
             com.sun.star.frame.GlobalEventBroadcaster
         </service-dependency>
         <service-dependency>
-            com.sun.star.frame.Desktop
-        </service-dependency>
-        <service-dependency>
             com.sun.star.reflection.ProxyFactory
         </service-dependency>
         <service-dependency>
@@ -87,6 +84,7 @@
     <type> com.sun.star.beans.PropertyAttribute                         </type>
     <type> com.sun.star.beans.PropertyValue                             </type>
     <type> com.sun.star.beans.XPropertySet                              </type>
+    <type> com.sun.star.container.XEnumerationAccess                    </type>
     <type> com.sun.star.container.XNameAccess                           </type>
     <type> com.sun.star.document.XStorageBasedDocument                  </type>
     <type> com.sun.star.document.XEventBroadcaster                      </type>
@@ -94,7 +92,6 @@
     <type> com.sun.star.embed.ElementModes                              </type>
     <type> com.sun.star.embed.XStorage                                  </type>
     <type> com.sun.star.embed.XTransactedObject                         </type>
-    <type> com.sun.star.frame.XFramesSupplier                           </type>
     <type> com.sun.star.frame.XTransientDocumentsDocumentContentFactory </type>
     <type> com.sun.star.io.XActiveDataSink                              </type>
     <type> com.sun.star.io.XActiveDataStreamer                          </type>
Index: ucb/unotypes/makefile.mk
===================================================================
RCS file: /cvs/ucb/ucb/unotypes/makefile.mk,v
retrieving revision 1.26
retrieving revision 1.26.30.1
diff -u -p -r1.26 -r1.26.30.1
--- ucb/unotypes/makefile.mk	9 Nov 2004 15:35:17 -0000	1.26
+++ ucb/unotypes/makefile.mk	16 Feb 2005 10:32:32 -0000	1.26.30.1
@@ -82,6 +82,7 @@ UNOTYPES=\
 	com.sun.star.beans.XPropertySetInfoChangeNotifier \
 	com.sun.star.bridge.XUnoUrlResolver \
 	com.sun.star.container.XChild \
+	com.sun.star.container.XEnumerationAccess \
 	com.sun.star.container.XHierarchicalNameAccess \
     com.sun.star.container.XIndexAccess \
 	com.sun.star.container.XNameContainer \
@@ -94,7 +95,6 @@ UNOTYPES=\
     com.sun.star.embed.XTransactedObject \
     com.sun.star.frame.XController \
 	com.sun.star.frame.XConfigManager \
-    com.sun.star.frame.XFramesSupplier \
     com.sun.star.frame.XModel \
     com.sun.star.frame.XTransientDocumentsDocumentContentFactory \
 	com.sun.star.io.XActiveDataSink \
Index: framework/inc/helper/statusindicatorfactory.hxx
===================================================================
RCS file: /cvs/framework/framework/inc/helper/statusindicatorfactory.hxx,v
retrieving revision 1.9
retrieving revision 1.8.50.3
diff -u -p -r1.9 -r1.8.50.3
--- framework/inc/helper/statusindicatorfactory.hxx	2 Feb 2005 13:49:46 -0000	1.9
+++ framework/inc/helper/statusindicatorfactory.hxx	16 Feb 2005 13:33:58 -0000	1.8.50.3
@@ -328,6 +328,9 @@ class StatusIndicatorFactory : public  c
         /** prevent recursive calling of Application::Reschedule(). */
         static sal_Int32 m_nInReschedule;
         
+        /** time where there last start call was made. */
+        sal_Int32 m_nStartTime;
+
     //-------------------------------------------
     // interface
     
Index: framework/inc/services/layoutmanager.hxx
===================================================================
RCS file: /cvs/framework/framework/inc/services/layoutmanager.hxx,v
retrieving revision 1.12
retrieving revision 1.11.10.2
diff -u -p -r1.12 -r1.11.10.2
--- framework/inc/services/layoutmanager.hxx	2 Feb 2005 13:50:40 -0000	1.12
+++ framework/inc/services/layoutmanager.hxx	4 Feb 2005 14:40:54 -0000	1.11.10.2
@@ -578,6 +578,7 @@ namespace framework
             rtl::OUString                                                               m_aModuleIdentifier;
             rtl::OUString                                                               m_aCustomTbxPrefix;
             rtl::OUString                                                               m_aStatusBarAlias;
+            rtl::OUString                                                               m_aProgressBarAlias;
             AddonsOptions*                                                              m_pAddonOptions;
             SvtMiscOptions*                                                             m_pMiscOptions;
             sal_Int16                                                                   m_eSymbolSet;
Index: framework/source/accelerators/presethandler.cxx
===================================================================
RCS file: /cvs/framework/framework/source/accelerators/presethandler.cxx,v
retrieving revision 1.8
retrieving revision 1.8.2.1
diff -u -p -r1.8 -r1.8.2.1
--- framework/source/accelerators/presethandler.cxx	2 Feb 2005 13:52:44 -0000	1.8
+++ framework/source/accelerators/presethandler.cxx	15 Feb 2005 12:17:15 -0000	1.8.2.1
@@ -467,12 +467,22 @@ void PresetHandler::connectToResource(  
         (eConfigType != E_DOCUMENT                           )    // no localization in document mode!
        )
     {
-        // use different start pathes ... because called method uses it as an in/out parameter!
-        ::rtl::OUString sLocalizedSharePath(sRelPath);
-        ::rtl::OUString sLocalizedUserPath (sRelPath);
-
-        xShare   = impl_openLocalizedPathIgnoringErrors(sLocalizedSharePath, eShareMode, sal_True , aLocale);
-        xUser    = impl_openLocalizedPathIgnoringErrors(sLocalizedUserPath , eUserMode , sal_False, aLocale);
+        // First try to find the right localized set inside share layer.
+        // Fallbacks are allowed there.
+        ::comphelper::Locale aShareLocale       = aLocale ;
+        ::rtl::OUString      sLocalizedSharePath(sRelPath);
+        sal_Bool             bAllowFallbacks    = sal_True; 
+        xShare = impl_openLocalizedPathIgnoringErrors(sLocalizedSharePath, eShareMode, sal_True , aShareLocale, bAllowFallbacks);
+
+        // The try to locate the right sub dir inside user layer ... without using fallbacks!
+        // Normaly the corresponding sub dir should be created matching the specified locale.
+        // Because we allow creation of storages inside user layer by default.
+        ::comphelper::Locale aUserLocale        = aLocale  ;
+        ::rtl::OUString      sLocalizedUserPath(sRelPath)  ;
+                             bAllowFallbacks    = sal_False; 
+        xUser = impl_openLocalizedPathIgnoringErrors(sLocalizedUserPath, eUserMode , sal_False, aUserLocale, bAllowFallbacks);
+        
+        // TODO ... may be we need one relpath value for every supported config layer .-)
         sRelPath = sLocalizedUserPath;
     }
         
@@ -812,14 +822,48 @@ css::uno::Reference< css::embed::XStorag
 }
 
 //-----------------------------------------------
-css::uno::Reference< css::embed::XStorage > PresetHandler::impl_openLocalizedPathIgnoringErrors(      ::rtl::OUString&      sPath  ,
-                                                                                                      sal_Int32             eMode  ,
-                                                                                                      sal_Bool              bShare ,
-                                                                                                const ::comphelper::Locale& aLocale)
+::std::vector< ::rtl::OUString >::const_iterator PresetHandler::impl_findMatchingLocalizedValue(const ::std::vector< ::rtl::OUString >& lLocalizedValues,
+                                                                                                      ::comphelper::Locale&             aLocale         ,
+                                                                                                      sal_Bool                          bAllowFallbacks )
+{
+    ::std::vector< ::rtl::OUString >::const_iterator pFound = lLocalizedValues.end();
+    if (bAllowFallbacks)
+    {
+        pFound = ::comphelper::Locale::getFallback(lLocalizedValues, aLocale.toISO());    
+    }
+    else
+    {
+        for (  pFound  = lLocalizedValues.begin();
+               pFound != lLocalizedValues.end()  ;
+             ++pFound                            )
+        {
+            const ::rtl::OUString&     sCheckISO   = *pFound;
+                  ::comphelper::Locale aCheckLocale(sCheckISO);
+            if (aCheckLocale.equals(aLocale))
+                break;
+        }
+    }
+
+    // if we found a valid locale ... take it over to our in/out parameter aLocale
+    if (pFound != lLocalizedValues.end())
+    {
+        const ::rtl::OUString& sISOLocale = *pFound;
+        aLocale.fromISO(sISOLocale);
+    }
+    
+    return pFound;
+}
+
+//-----------------------------------------------
+css::uno::Reference< css::embed::XStorage > PresetHandler::impl_openLocalizedPathIgnoringErrors(::rtl::OUString&      sPath         ,
+                                                                                                sal_Int32             eMode         ,
+                                                                                                sal_Bool              bShare        ,
+                                                                                                ::comphelper::Locale& aLocale       ,
+                                                                                                sal_Bool              bAllowFallback)
 {
     css::uno::Reference< css::embed::XStorage >      xPath         = impl_openPathIgnoringErrors(sPath, eMode, bShare);
     ::std::vector< ::rtl::OUString >                 lSubFolders   = impl_getSubFolderNames(xPath);
-    ::std::vector< ::rtl::OUString >::const_iterator pLocaleFolder = ::comphelper::Locale::getFallback(lSubFolders, aLocale.toISO());
+    ::std::vector< ::rtl::OUString >::const_iterator pLocaleFolder = impl_findMatchingLocalizedValue(lSubFolders, aLocale, bAllowFallback);
 
     // no fallback ... creation not allowed => no storage
     if (
Index: framework/source/helper/statusindicatorfactory.cxx
===================================================================
RCS file: /cvs/framework/framework/source/helper/statusindicatorfactory.cxx,v
retrieving revision 1.13
retrieving revision 1.12.50.6
diff -u -p -r1.13 -r1.12.50.6
--- framework/source/helper/statusindicatorfactory.cxx	2 Feb 2005 13:53:27 -0000	1.13
+++ framework/source/helper/statusindicatorfactory.cxx	1 Mar 2005 11:50:02 -0000	1.12.50.6
@@ -119,6 +119,14 @@
 #include <com/sun/star/awt/WindowAttribute.hpp>
 #endif
 
+#ifndef _COM_SUN_STAR_AWT_XTOPWINDOW_HPP_
+#include <com/sun/star/awt/XTopWindow.hpp>
+#endif
+
+#ifndef _COM_SUN_STAR_AWT_XWINDOW2_HPP_
+#include <com/sun/star/awt/XWindow2.hpp>
+#endif
+
 #ifndef _COM_SUN_STAR_BEANS_XPROPERTYSET_HPP_
 #include <com/sun/star/beans/XPropertySet.hpp>
 #endif
@@ -155,6 +163,7 @@ namespace framework{
 // definitions
 
 sal_Int32 StatusIndicatorFactory::m_nInReschedule = 0;	///	static counter for rescheduling
+static ::rtl::OUString PROGRESS_RESOURCE = ::rtl::OUString::createFromAscii("private:resource/progressbar/progressbar");
 
 //-----------------------------------------------
 DEFINE_XINTERFACE_5(StatusIndicatorFactory                              ,
@@ -435,23 +444,46 @@ void StatusIndicatorFactory::implts_make
     aReadLock.unlock();
     // <- SAFE ----------------------------------
 
-    css::uno::Reference< css::awt::XWindow > xParent;
+    css::uno::Reference< css::awt::XWindow > xParentWindow;
+    if (xFrame.is())
+        xParentWindow = xFrame->getContainerWindow();
+    else
+        xParentWindow = xPluggWindow;
+    
+    // dont disturb user in case he put the loading document into the background!
+    // Supress any setVisible() or toFront() call in case the initial show was
+    // already made.
+    css::uno::Reference< css::awt::XWindow2 > xVisibleCheck(xParentWindow, css::uno::UNO_QUERY);
+    sal_Bool bIsVisible = sal_False;
+    if (xVisibleCheck.is())
+        bIsVisible = xVisibleCheck->isVisible();
+    
+    if (!bIsVisible)
+    {
+        if (xParentWindow.is())
+            xParentWindow->setVisible(sal_True);
+        css::uno::Reference< css::awt::XTopWindow > xParentWindowTop(xParentWindow, css::uno::UNO_QUERY); 
+        if (xParentWindowTop.is())
+            xParentWindowTop->toFront();
+    }
+    
+    if (xFrame.is())
     {
-        if (xFrame.is())
-            xParent = xFrame->getContainerWindow();
-        else
-            xParent = xPluggWindow;
+        // use frame layouted progress implementation
+        css::uno::Reference< css::beans::XPropertySet > xPropSet(xFrame, css::uno::UNO_QUERY);
+        if (xPropSet.is())
+        {
+            css::uno::Reference< dcss::frame::XLayoutManager > xLayoutManager;
+            xPropSet->getPropertyValue(FRAME_PROPNAME_LAYOUTMANAGER) >>= xLayoutManager;
+            if (xLayoutManager.is())
+                xLayoutManager->showElement(PROGRESS_RESOURCE);
+        }
     }
-
-    if (xParent.is())
-        xParent->setVisible(sal_True);
 }
 
 //-----------------------------------------------
 void StatusIndicatorFactory::impl_createProgress()
 {
-    ::rtl::OUString PROGRESSBAR_RES_STR = ::rtl::OUString::createFromAscii("private:resource/progressbar/progressbar");
-                
     // SAFE -> ----------------------------------
     ReadGuard aReadLock(m_aLock);
     
@@ -481,12 +513,14 @@ void StatusIndicatorFactory::impl_create
             xPropSet->getPropertyValue(FRAME_PROPNAME_LAYOUTMANAGER) >>= xLayoutManager;
             if (xLayoutManager.is())
             {
-                xLayoutManager->createElement(PROGRESSBAR_RES_STR);
-                xLayoutManager->showElement  (PROGRESSBAR_RES_STR);
+                xLayoutManager->lock();
+                xLayoutManager->createElement( PROGRESS_RESOURCE );
+                xLayoutManager->hideElement( PROGRESS_RESOURCE ); 
                 
-                css::uno::Reference< dcss::ui::XUIElement > xProgressBar = xLayoutManager->getElement(PROGRESSBAR_RES_STR);
+                css::uno::Reference< dcss::ui::XUIElement > xProgressBar = xLayoutManager->getElement(PROGRESS_RESOURCE);
                 if (xProgressBar.is())
                     xProgress = css::uno::Reference< css::task::XStatusIndicator >(xProgressBar->getRealInterface(), css::uno::UNO_QUERY);
+                xLayoutManager->unlock();
             }
         }
     }
@@ -501,6 +535,8 @@ void StatusIndicatorFactory::impl_create
 //-----------------------------------------------
 void StatusIndicatorFactory::impl_reschedule(sal_Bool bForce)
 {
+    const sal_Int32 MAX_RESCHEDULE = 50;
+    
     sal_Bool bReschedule = bForce;
     if (!bReschedule)
     {
@@ -515,14 +551,26 @@ void StatusIndicatorFactory::impl_resche
     if (!bReschedule)
         return;
     
-    // SAFE -> ----------------------------------
+    // SAFE ->
     WriteGuard aGlobalLock(LockHelper::getGlobalLock());
     
 	if (m_nInReschedule == 0)
 	{
 		++m_nInReschedule;
         aGlobalLock.unlock();
-		Application::Reschedule();
+        // <- SAFE
+        
+        sal_Int32 nRescheduleCount = MAX_RESCHEDULE;
+        while (
+                (Application::AnyInput()) &&
+                (nRescheduleCount > 0   )
+              )
+        {              
+            Application::Reschedule();
+            nRescheduleCount--;
+        }
+        
+        // SAFE ->
         aGlobalLock.lock();
 		--m_nInReschedule;
 	}
@@ -534,8 +582,10 @@ void StatusIndicatorFactory::impl_startW
     // SAFE ->
     WriteGuard aWriteLock(m_aLock);
     if (!m_pWakeUp)
+    {
         m_pWakeUp = new WakeUpThread(this);
-    m_pWakeUp->create();
+        m_pWakeUp->create();
+    }
     aWriteLock.unlock();
     // <- SAFE
 }
@@ -555,12 +605,4 @@ void StatusIndicatorFactory::impl_stopWa
     // <- SAFE
 }
 
-/*
-//-----------------------------------------------
-sal_uInt32 StatusIndicatorFactory::impl_get10ThSec()
-{
-	sal_uInt32 n10Ticks = 10 * (sal_uInt32)clock();
-	return n10Ticks / CLOCKS_PER_SEC;
-}
-*/
 } // namespace framework
Index: framework/source/helper/wakeupthread.cxx
===================================================================
RCS file: /cvs/framework/framework/source/helper/wakeupthread.cxx,v
retrieving revision 1.2
retrieving revision 1.2.2.2
diff -u -p -r1.2 -r1.2.2.2
--- framework/source/helper/wakeupthread.cxx	2 Feb 2005 13:53:40 -0000	1.2
+++ framework/source/helper/wakeupthread.cxx	11 Feb 2005 10:38:02 -0000	1.2.2.2
@@ -95,8 +95,8 @@ void SAL_CALL WakeUpThread::run()
     ::osl::Condition aSleeper;
     
     TimeValue aTime;
-    aTime.Seconds =     0;
-    aTime.Nanosec = 25000;
+    aTime.Seconds = 0;
+    aTime.Nanosec = 25000000; // 25 msec
 
     while(schedule())
     {
Index: framework/source/inc/accelerators/presethandler.hxx
===================================================================
RCS file: /cvs/framework/framework/source/inc/accelerators/presethandler.hxx,v
retrieving revision 1.4
retrieving revision 1.4.48.1
diff -u -p -r1.4 -r1.4.48.1
--- framework/source/inc/accelerators/presethandler.hxx	7 Dec 2004 13:18:16 -0000	1.4
+++ framework/source/inc/accelerators/presethandler.hxx	15 Feb 2005 12:17:16 -0000	1.4.48.1
@@ -547,6 +547,33 @@ class PresetHandler : private ThreadHelp
                                                                                       sal_Bool         bShare);
                                                                                       
         //---------------------------------------
+        /** @short  try to find the specified locale inside list of possible ones.
+        
+            @descr  The lits of possible locale values was e.g. retrieved from the system
+                    (configuration, directory listing etcpp). The locale normaly represent
+                    the current office locale. This method search for a suitable item by using
+                    different algorithm.
+                    a) exact search
+                    b) search with using fallbacks
+                    
+            @param  lLocalizedValues
+                    list of ISO locale codes
+                    
+            @param  aLocale
+                    [IN ] the current office locale, which should be searched inside lLocalizedValues.
+                    [OUT] in case fallbacks was allowed, it contains afterwards the fallback locale. 
+                    
+            @param  bAllowFallbacks
+                    enable/disable using of fallbacks
+                    
+            @return An iterator, which points directly into lLocalizedValue list.
+                    As a negative result the special iterator lLocalizedValues.end() will be returned.
+         */
+        ::std::vector< ::rtl::OUString >::const_iterator impl_findMatchingLocalizedValue(const ::std::vector< ::rtl::OUString >& lLocalizedValues,
+                                                                                               ::comphelper::Locale&             aLocale         ,
+                                                                                               sal_Bool                          bAllowFallbacks );
+                                                                                               
+        //---------------------------------------
         /** @short  open a config path ignoring errors (catching exceptions).
         
             @descr  We catch only normal exceptions here - no runtime exceptions.
@@ -566,14 +593,19 @@ class PresetHandler : private ThreadHelp
                     force using of the share layer instead of the user layer.
                     
             @param  aLocale
-                    the start locale ...
+                    [IN ] contains the start locale for searching localized sub dirs.
+                    [OUT] contains the locale of a found localized sub dir
+                    
+            @param  bAllowFallback
+                    enable/disable fallback handling for locales
                     
             @return An opened storage in case method was successfully - null otherwise.                    
          */
-        css::uno::Reference< css::embed::XStorage > impl_openLocalizedPathIgnoringErrors(      ::rtl::OUString&      sPath  ,
-                                                                                               sal_Int32             eMode  ,
-                                                                                               sal_Bool              bShare ,
-                                                                                         const ::comphelper::Locale& aLocale);
+        css::uno::Reference< css::embed::XStorage > impl_openLocalizedPathIgnoringErrors(::rtl::OUString&      sPath         ,
+                                                                                         sal_Int32             eMode         ,
+                                                                                         sal_Bool              bShare        ,
+                                                                                         ::comphelper::Locale& aLocale       ,
+                                                                                         sal_Bool              bAllowFallback);
                                                                                          
         //---------------------------------------
         /** @short  returns the names of all sub storages of specified storage.
Index: framework/source/inc/loadenv/loadenv.hxx
===================================================================
RCS file: /cvs/framework/framework/source/inc/loadenv/loadenv.hxx,v
retrieving revision 1.5
retrieving revision 1.5.2.1
diff -u -p -r1.5 -r1.5.2.1
--- framework/source/inc/loadenv/loadenv.hxx	2 Feb 2005 13:53:53 -0000	1.5
+++ framework/source/inc/loadenv/loadenv.hxx	16 Feb 2005 13:34:13 -0000	1.5.2.1
@@ -530,6 +530,23 @@ class LoadEnv : private ThreadHelpBase
         /** TODO document me ... */
         css::uno::Reference< css::uno::XInterface > impl_searchLoader();
         
+        //_______________________________________
+
+        /** @short  it means; show the frame, bring it to front,
+                    might set the right icon etcpp. in case loading was
+                    successfully or reactivate a might existing old document or
+                    close the frame if it was created before in case loading failed.
+
+            @throw  A LoadEnvException only in cases, where an internal error indicates,
+                    that the complete load environment seems to be not useable in general.
+                    In such cases a RuntimeException would be to hard for the outside code :-)
+
+            @throw  A RuntimeException in case any internal process indicates, that
+                    the whole runtime cant be used any longer.
+         */
+        void impl_reactForLoadingState()
+            throw(LoadEnvException, css::uno::RuntimeException);
+            
     //___________________________________________
     // private helper
 
@@ -675,23 +692,36 @@ class LoadEnv : private ThreadHelpBase
          */
         css::uno::Reference< css::frame::XFrame > impl_searchRecycleTarget()
             throw(LoadEnvException, css::uno::RuntimeException);
-
+            
         //_______________________________________
 
-        /** @short  it means; show the frame, bring it to front,
-                    might set the right icon etcpp. in case loading was
-                    successfully or reactivate a might existing old document or
-                    close the frame if it was created before in case loading failed.
-
-            @throw  A LoadEnvException only in cases, where an internal error indicates,
-                    that the complete load environment seems to be not useable in general.
-                    In such cases a RuntimeException would be to hard for the outside code :-)
-
-            @throw  A RuntimeException in case any internal process indicates, that
-                    the whole runtime cant be used any longer.
+        /** @short  because showing of a frame is needed more then once ...
+                    it's implemented as an seperate method .-)
+                    
+            @descr  Note: Showing of a frame is bound to a special feature ...
+                    a) If we recycle any existing frame, we must bring it to front.
+                       Showing of such frame isnt needed realy .. because we recycle
+                       visible frames only!
+                    b) If the document was already shown (e.g. by our progress implementation)
+                       we do nothing here. The reason  behind: The document was already shown ..
+                       and it was already make a top window ...
+                       If the user activated another frame inbetween (because loading needed some time)
+                       it's not allowed to disturb the user again. Then the frame must resists in the background.
+                    c) If the frame was not shown before ... but loading of a visible document into this frame
+                       was finished ... we need both actions: setVisible() and toFront().
+                       
+            @param  xWindow
+                    points to the container window of a frame.
+                    
+            @param  bForceToFront
+                    if it's set to FALSE ... showing of the window is done more intelligent.
+                    setVisible() is called only if the window was not shown before.
+                    This mode is needed by b) and c)
+                    If it's set to TRUE ... both actions has to be done: setVisible(), toFront()!
+                    This mode is needed by a)
          */
-        void impl_reactForLoadingState()
-            throw(LoadEnvException, css::uno::RuntimeException);
+        void impl_makeFrameWindowVisible(const css::uno::Reference< css::awt::XWindow >& xWindow      ,
+                                               sal_Bool                                  bForceToFront);            
 };
 
 } // namespace framework
Index: framework/source/layoutmanager/layoutmanager.cxx
===================================================================
RCS file: /cvs/framework/framework/source/layoutmanager/layoutmanager.cxx,v
retrieving revision 1.22
retrieving revision 1.17.10.5
diff -u -p -r1.22 -r1.17.10.5
--- framework/source/layoutmanager/layoutmanager.cxx	9 Feb 2005 10:50:36 -0000	1.22
+++ framework/source/layoutmanager/layoutmanager.cxx	14 Feb 2005 07:42:54 -0000	1.17.10.5
@@ -432,6 +432,7 @@ LayoutManager::LayoutManager( const Refe
         ,   m_pAddonOptions( 0 )
         ,   m_aCustomTbxPrefix( RTL_CONSTASCII_USTRINGPARAM( "custom_" ))
         ,   m_aStatusBarAlias( RTL_CONSTASCII_USTRINGPARAM( "private:resource/statusbar/statusbar" ))
+        ,   m_aProgressBarAlias( RTL_CONSTASCII_USTRINGPARAM( "private:resource/progressbar/progressbar" ))
         ,   m_eDockOperation( DOCKOP_ON_COLROW )
 {
     // Initialize statusbar member
@@ -2913,21 +2914,6 @@ void LayoutManager::implts_createStatusB
     {
         m_aStatusBarElement.m_aName      = aStatusBarName;
         m_aStatusBarElement.m_xUIElement = implts_createElement( aStatusBarName );
-
-/*
-        if ( m_aProgressBarElement.m_xUIElement.is() )
-        {
-            ProgressBarWrapper* pWrapper = (ProgressBarWrapper*)m_aProgressBarElement.m_xUIElement.get();
-            if ( pWrapper )
-            {
-                Reference< css::awt::XWindow > xWindow(
-                    m_aStatusBarElement.m_xUIElement->getRealInterface(), UNO_QUERY );
-
-                // Set new status bar on our progress bar wrapper
-                pWrapper->setStatusBar( xWindow, sal_False );
-            }
-        }
-*/
     }
 
     implts_createProgressBar();
@@ -2950,16 +2936,15 @@ void LayoutManager::implts_createProgres
     aWriteLock.unlock();
     /* SAFE AREA ----------------------------------------------------------------------------------------------- */
 
-    if ( xProgressBar.is() )
-        return;
-    
     sal_Bool            bRecycled = xProgressBarBackup.is();
     ProgressBarWrapper* pWrapper  = 0;
     if ( bRecycled )
         pWrapper = (ProgressBarWrapper*)xProgressBarBackup.get();
+    else if ( xProgressBar.is() )
+        pWrapper = (ProgressBarWrapper*)xProgressBar.get();
     else
         pWrapper = new ProgressBarWrapper();
-    
+
     if ( xStatusBar.is() )
     {
         Reference< css::awt::XWindow > xWindow( xStatusBar->getRealInterface(), UNO_QUERY );
@@ -3064,11 +3049,12 @@ sal_Bool LayoutManager::implts_showProgr
     Reference< css::awt::XWindow > xWindow;
 
     /* SAFE AREA ----------------------------------------------------------------------------------------------- */
-    ReadGuard aReadLock( m_aLock );
+    WriteGuard aWriteLock( m_aLock );
     xStatusBar = Reference< XUIElement >( m_aStatusBarElement.m_xUIElement, UNO_QUERY );
     xProgressBar = Reference< XUIElement >( m_aProgressBarElement.m_xUIElement, UNO_QUERY );
     sal_Bool bVisible( m_bVisible );
 
+    m_aProgressBarElement.m_bVisible = sal_True;
     if ( bVisible )
     {
         if ( xStatusBar.is() && !m_aStatusBarElement.m_bMasterHide )
@@ -3081,15 +3067,18 @@ sal_Bool LayoutManager::implts_showProgr
             if ( pWrapper )
                 xWindow = pWrapper->getStatusBar();
         }
-        aReadLock.unlock();
     }
+    aWriteLock.unlock();
 
     vos::OGuard	aGuard( Application::GetSolarMutex() );
     Window* pWindow = VCLUnoHelper::GetWindow( xWindow );
-    if ( pWindow && !pWindow->IsVisible() )
+    if ( pWindow )
     {
-        pWindow->Show();
-        doLayout();
+        if ( !pWindow->IsVisible() )
+        {
+            pWindow->Show();
+            doLayout();
+        }
         return sal_True;
     }
 
@@ -3102,7 +3091,7 @@ sal_Bool LayoutManager::implts_hideProgr
     Reference< css::awt::XWindow > xWindow;
 
     /* SAFE AREA ----------------------------------------------------------------------------------------------- */
-    ReadGuard aReadLock( m_aLock );
+    WriteGuard aWriteLock( m_aLock );
     xProgressBar = Reference< XUIElement >( m_aProgressBarElement.m_xUIElement, UNO_QUERY );
 
     if ( xProgressBar.is() )
@@ -3111,14 +3100,18 @@ sal_Bool LayoutManager::implts_hideProgr
         if ( pWrapper )
             xWindow = pWrapper->getStatusBar();
     }
-    aReadLock.unlock();
+    m_aProgressBarElement.m_bVisible = sal_False;
+    aWriteLock.unlock();
 
     vos::OGuard	aGuard( Application::GetSolarMutex() );
     Window* pWindow = VCLUnoHelper::GetWindow( xWindow );
-    if ( pWindow && pWindow->IsVisible() )
+    if ( pWindow )
     {
-        pWindow->Hide();
-        doLayout();
+        if ( pWindow->IsVisible() )
+        {
+            pWindow->Hide();
+            doLayout();
+        }
         return sal_True;
     }
 
@@ -4548,6 +4541,12 @@ throw (RuntimeException)
                 }
             }
         }
+        else if (( aElementType.equalsIgnoreAsciiCaseAscii( "progressbar" ) &&
+                   aElementName.equalsIgnoreAsciiCaseAscii( "progressbar" )))
+        {
+            if ( m_aProgressBarElement.m_xUIElement.is() )
+                return m_aProgressBarElement.m_bVisible;
+        }
         else
         {
             UIElementVector::const_iterator pIter;
@@ -5062,7 +5061,8 @@ void LayoutManager::implts_calcWindowPos
 ::Size LayoutManager::implts_getStatusBarSize()
 {
     ReadGuard aReadLock( m_aLock );
-    sal_Bool bStatusBarVisible = isElementVisible( m_aStatusBarAlias );
+    sal_Bool bStatusBarVisible( isElementVisible( m_aStatusBarAlias ));
+    sal_Bool bProgressBarVisible( isElementVisible( m_aProgressBarAlias ));
     sal_Bool bVisible = m_bVisible;
     Reference< XUIElement > xStatusBar = m_aStatusBarElement.m_xUIElement;
     Reference< XUIElement > xProgressBar = m_aProgressBarElement.m_xUIElement;
@@ -5070,7 +5070,7 @@ void LayoutManager::implts_calcWindowPos
     Reference< css::awt::XWindow > xWindow;
     if ( bStatusBarVisible && bVisible && xStatusBar.is() )
         xWindow = Reference< css::awt::XWindow >( xStatusBar->getRealInterface(), UNO_QUERY );
-    else if ( xProgressBar.is() && !xStatusBar.is() )
+    else if ( xProgressBar.is() && !xStatusBar.is() && bProgressBarVisible )
     {
         ProgressBarWrapper* pWrapper = (ProgressBarWrapper*)xProgressBar.get();
         if ( pWrapper )
Index: framework/source/loadenv/loadenv.cxx
===================================================================
RCS file: /cvs/framework/framework/source/loadenv/loadenv.cxx,v
retrieving revision 1.12
retrieving revision 1.12.2.2
diff -u -p -r1.12 -r1.12.2.2
--- framework/source/loadenv/loadenv.cxx	2 Feb 2005 13:54:18 -0000	1.12
+++ framework/source/loadenv/loadenv.cxx	1 Mar 2005 13:57:14 -0000	1.12.2.2
@@ -153,6 +153,10 @@
 #include <com/sun/star/awt/XWindow.hpp>
 #endif
 
+#ifndef _COM_SUN_STAR_AWT_XWINDOW2_HPP_
+#include <com/sun/star/awt/XWindow2.hpp>
+#endif
+
 #ifndef _COM_SUN_STAR_AWT_XTOPWINDOW_HPP_
 #include <com/sun/star/awt/XTopWindow.hpp>
 #endif
@@ -1338,15 +1342,7 @@ css::uno::Reference< css::frame::XFrame 
             }
 
             // bring it to front ...
-            css::uno::Reference< css::awt::XWindow >    xTaskWindow = xTask->getContainerWindow();
-            css::uno::Reference< css::awt::XTopWindow > xTopWindow  (xTaskWindow, css::uno::UNO_QUERY);
-            // Check it! May we are plugged into a browser/java canvas etcpp ...
-            // Then such "bring to front" operation isnt supported yet nor neccessary .-)
-            if (xTopWindow.is())
-            {
-                xTaskWindow->setVisible(sal_True);
-                xTopWindow->toFront();
-            }
+            impl_makeFrameWindowVisible(xTask->getContainerWindow(), sal_True);
 
             // It doesn't matter if we was able to bring it to front.
             // But we have found such task and can return it as our result.
@@ -1509,10 +1505,9 @@ void LoadEnv::impl_reactForLoadingState(
         else
         if (!bHidden && !bRecovered)
         {
-            xWindow->setVisible(sal_True);
-            css::uno::Reference< css::awt::XTopWindow > xTopWindow(xWindow, css::uno::UNO_QUERY);
-            if(xTopWindow.is())
-                xTopWindow->toFront();
+            // show frame ... if it's not still visible ...
+            // But do nothing if it's already visible!
+            impl_makeFrameWindowVisible(xWindow, sal_False);
         }
         
         // Note: Only if an existing property "FrameName" is given by this media descriptor,
@@ -1585,5 +1580,47 @@ void LoadEnv::impl_reactForLoadingState(
     // <- SAFE ----------------------------------
 }
 
+/*-----------------------------------------------
+    16.01.2005 13:04
+-----------------------------------------------*/
+void LoadEnv::impl_makeFrameWindowVisible(const css::uno::Reference< css::awt::XWindow >& xWindow      ,
+                                                sal_Bool                                  bForceToFront)            
+{
+    css::uno::Reference< css::awt::XTopWindow > xTopWindow(xWindow, css::uno::UNO_QUERY);
+
+    if (xWindow.is())
+        xWindow->setVisible(sal_True);
+    
+    if (xTopWindow.is())
+        xTopWindow->toFront();
+    
+/* #i19976#
+    We tried to prevent a toFront() call in case the user putted the
+    loading document into the background ..
+    But we had several errors trying that. So we decided to
+    rollback these changes and bring the new loaded document to front hardly !
+    
+    css::uno::Reference< css::awt::XWindow2 > xWindow2(xWindow, css::uno::UNO_QUERY);
+    
+    sal_Bool bIsVisible = sal_False;
+    if (xWindow2.is())
+        bIsVisible = xWindow2->isVisible(); // TODO is parent visible too ? .-)
+    
+    if (!bIsVisible)
+    {
+        xWindow->setVisible(sal_True);
+        bForceToFront = sal_True;
+    }
+    
+    if (
+        (bForceToFront  ) &&
+        (xTopWindow.is())
+       )
+    {
+        xTopWindow->toFront();
+    }
+*/
+}
+    
 } // namespace framework
 
Index: framework/source/services/frame.cxx
===================================================================
RCS file: /cvs/framework/framework/source/services/frame.cxx,v
retrieving revision 1.80
retrieving revision 1.79.50.2
diff -u -p -r1.80 -r1.79.50.2
--- framework/source/services/frame.cxx	2 Feb 2005 13:55:12 -0000	1.80
+++ framework/source/services/frame.cxx	4 Feb 2005 14:44:11 -0000	1.79.50.2
@@ -715,11 +715,12 @@ void SAL_CALL Frame::initialize( const c
         DockingAreaDefaultAcceptor* pAcceptor = new DockingAreaDefaultAcceptor(this);
         css::uno::Reference< dcss::ui::XDockingAreaAcceptor > xDockingAreaAcceptor( static_cast< ::cppu::OWeakObject* >(pAcceptor), css::uno::UNO_QUERY );
         xLayoutManager->setDockingAreaAcceptor(xDockingAreaAcceptor);
-        
+/*        
         // create the status bar ... but dont show it here!
         xLayoutManager->lock();
         xLayoutManager->createElement( DECLARE_ASCII( "private:resource/statusbar/statusbar" ));
         xLayoutManager->unlock();
+*/
     }
 
     // create progress helper
Index: framework/source/uiconfiguration/moduleimagemanager.cxx
===================================================================
RCS file: /cvs/framework/framework/source/uiconfiguration/moduleimagemanager.cxx,v
retrieving revision 1.7
retrieving revision 1.7.42.2
diff -u -p -r1.7 -r1.7.42.2
Index: framework/source/uielement/progressbarwrapper.cxx
===================================================================
RCS file: /cvs/framework/framework/source/uielement/progressbarwrapper.cxx,v
retrieving revision 1.2
retrieving revision 1.2.104.2
diff -u -p -r1.2 -r1.2.104.2
--- framework/source/uielement/progressbarwrapper.cxx	9 Sep 2004 17:11:14 -0000	1.2
+++ framework/source/uielement/progressbarwrapper.cxx	10 Feb 2005 10:18:03 -0000	1.2.104.2
@@ -169,6 +169,7 @@ void ProgressBarWrapper::start( const ::
 throw (uno::RuntimeException)
 {
     uno::Reference< awt::XWindow > xWindow;
+    sal_Int32                      nValue( 0 );
 
     {
         ResetableGuard aGuard( m_aLock );
@@ -179,6 +180,7 @@ throw (uno::RuntimeException)
         xWindow  = m_xStatusBar;
         m_nValue = 0;
         m_nRange = Range;
+        nValue   = m_nValue;
     }
 
     if ( xWindow.is() )
@@ -191,7 +193,14 @@ throw (uno::RuntimeException)
             if ( !pStatusBar->IsProgressMode() )
                 pStatusBar->StartProgressMode( Text );
             else
-                pStatusBar->SetText( Text );
+            {
+			    pStatusBar->SetUpdateMode( FALSE );
+			    pStatusBar->EndProgressMode();
+                pStatusBar->StartProgressMode( Text );
+			    pStatusBar->SetProgressValue( USHORT( nValue )); 
+                pStatusBar->SetUpdateMode( TRUE );
+            }
+            pStatusBar->Show( TRUE, SHOW_NOFOCUSCHANGE | SHOW_NOACTIVATE );
         }
     }
 }
Index: framework/source/uielement/uicommanddescription.cxx
===================================================================
RCS file: /cvs/framework/framework/source/uielement/uicommanddescription.cxx,v
retrieving revision 1.6
retrieving revision 1.6.50.2
diff -u -p -r1.6 -r1.6.50.2
Index: xmlhelp/inc/provider/urlparameter.hxx
===================================================================
RCS file: /cvs/util/xmlhelp/inc/provider/urlparameter.hxx,v
retrieving revision 1.11
retrieving revision 1.11.18.1
diff -u -p -r1.11 -r1.11.18.1
--- xmlhelp/inc/provider/urlparameter.hxx	30 Aug 2004 17:23:17 -0000	1.11
+++ xmlhelp/inc/provider/urlparameter.hxx	4 Feb 2005 11:05:16 -0000	1.11.18.1
@@ -207,6 +207,11 @@ namespace chelp {
 		rtl::OUString get_jar()      { return get_the_jar(); }      // BerkeleyDb
 		
 		rtl::OUString get_module()   { return m_aModule; }
+
+        rtl::OUString get_dbpar()    { 
+            if( m_aDbPar.getLength() ) return m_aDbPar;
+            else return m_aModule;
+        }
 		
 		rtl::OUString get_prefix()   { return m_aPrefix; }
 		
@@ -255,7 +260,8 @@ namespace chelp {
 		rtl::OUString  m_aTitle;
 		rtl::OUString  m_aJar;
 		rtl::OUString  m_aEid;
-		
+		rtl::OUString  m_aDbPar;
+        
 		rtl::OUString  m_aDefaultLanguage;
 		rtl::OUString  m_aLanguage;
 		
Index: xmlhelp/source/com/sun/star/help/FileURLStreamHandlerWithNotify.java
===================================================================
RCS file: /cvs/util/xmlhelp/source/com/sun/star/help/FileURLStreamHandlerWithNotify.java,v
retrieving revision 1.4
retrieving revision 1.4.2.1
diff -u -p -r1.4 -r1.4.2.1
--- xmlhelp/source/com/sun/star/help/FileURLStreamHandlerWithNotify.java	27 Jan 2005 10:06:35 -0000	1.4
+++ xmlhelp/source/com/sun/star/help/FileURLStreamHandlerWithNotify.java	4 Feb 2005 13:14:08 -0000	1.4.2.1
@@ -8,15 +8,17 @@ package com.sun.star.help;
 
 import java.io.File;
 import java.io.FileInputStream;
-import java.io.FileNotFoundException;
 import java.io.FileOutputStream;
 import java.io.IOException;
-import java.net.URI;
-import java.net.URISyntaxException;
+import java.lang.reflect.Constructor;
+import java.lang.reflect.InvocationTargetException;
 import java.net.URL;
 import java.net.URLConnection;
+import java.net.URLDecoder;
 import java.util.HashMap;
 
+import com.sun.star.lib.util.StringHelper;
+
 /**
  * @author ab106281
  *
@@ -52,8 +54,7 @@ public class FileURLStreamHandlerWithNot
 			} else {
 				FileInputStream fileInputStream = null;
 				try {
-					fileInputStream =
-						new FileInputStream(new File(new URI(externalForm)));
+					fileInputStream = new FileInputStream(mapUrlToFile(arg0));
 				} catch (Exception e) {
 					System.err.println(e.getMessage());
 					System.exit(1);
@@ -65,7 +66,7 @@ public class FileURLStreamHandlerWithNot
 				FileOutputStream fileOutputStream =
 					new FileOutputStream(tmpFile);
 				int n = 0;
-				byte[] b = new byte[256*1024];
+				byte[] b = new byte[256 * 1024];
 				while ((n = fileInputStream.read(b)) != -1)
 					fileOutputStream.write(b, 0, n);
 				fileOutputStream.close();
@@ -79,4 +80,78 @@ public class FileURLStreamHandlerWithNot
 		arg0 = new URL(useFileName);
 		return super.openConnection(arg0);
 	}
+
+	private static Class uriClass;
+	private static Constructor uriConstructor;
+	private static Constructor fileConstructor;
+
+	static {
+		try {
+			uriClass = Class.forName("java.net.URI");
+			uriConstructor =
+				uriClass.getConstructor(new Class[] { String.class });
+			fileConstructor =
+				File.class.getConstructor(new Class[] { uriClass });
+		} catch (ClassNotFoundException e) {
+		} catch (NoSuchMethodException e) {
+		}
+	}
+
+	private static File mapUrlToFile(URL url) {
+		if (url == null) {
+			return null;
+		} else if (fileConstructor == null) {
+			// If java.net.URI is not available, hope that the following works
+			// well:  First, check that the given URL has a certain form.
+			// Second, use the URLDecoder to decode the URL path (taking care
+			// not to change any plus signs to spaces), hoping that the used
+			// default encoding is the proper one for file URLs.  Third, create
+			// a File from the decoded path.
+			return url.getProtocol().equalsIgnoreCase("file")
+				&& url.getAuthority() == null
+				&& url.getQuery() == null
+				&& url.getRef() == null
+					? new File(
+						URLDecoder.decode(
+							StringHelper.replace(url.getPath(), '+', "%2B")))
+					: null;
+		} else {
+			// If java.net.URI is avaliable, do
+			//   URI uri = new URI(url.toString());
+			//   try {
+			//       return new File(uri);
+			//   } catch (IllegalArgumentException e) {
+			//       return null;
+			//   }
+			try {
+				Object uri =
+					uriConstructor.newInstance(new Object[] { url.toString()});
+				try {
+					return (File) fileConstructor.newInstance(
+						new Object[] { uri });
+				} catch (InvocationTargetException e) {
+					if (e.getTargetException()
+						instanceof IllegalArgumentException) {
+						return null;
+					} else {
+						throw e;
+					}
+				}
+			} catch (InstantiationException e) {
+				throw new RuntimeException("This cannot happen: " + e);
+			} catch (IllegalAccessException e) {
+				throw new RuntimeException("This cannot happen: " + e);
+			} catch (InvocationTargetException e) {
+				if (e.getTargetException() instanceof Error) {
+					throw (Error) e.getTargetException();
+				} else if (
+					e.getTargetException() instanceof RuntimeException) {
+					throw (RuntimeException) e.getTargetException();
+				} else {
+					throw new RuntimeException("This cannot happen: " + e);
+				}
+			}
+		}
+	}
+
 }
Index: xmlhelp/source/com/sun/star/help/HelpCompiler.java
===================================================================
RCS file: /cvs/util/xmlhelp/source/com/sun/star/help/HelpCompiler.java,v
retrieving revision 1.6
retrieving revision 1.6.2.3
diff -u -p -r1.6 -r1.6.2.3
--- xmlhelp/source/com/sun/star/help/HelpCompiler.java	27 Jan 2005 10:13:59 -0000	1.6
+++ xmlhelp/source/com/sun/star/help/HelpCompiler.java	17 Feb 2005 15:25:47 -0000	1.6.2.3
@@ -68,12 +68,9 @@
 package com.sun.star.help;
 
 import java.io.ByteArrayInputStream;
-import java.io.ByteArrayOutputStream;
 import java.io.File;
-import java.io.FileInputStream;
 import java.io.IOException;
 import java.io.InputStreamReader;
-import java.io.ObjectOutputStream;
 import java.io.UnsupportedEncodingException;
 import java.net.MalformedURLException;
 import java.net.URL;
@@ -278,9 +275,10 @@ public class HelpCompiler implements Hel
 		String title = null;
 		// returns all applications for which one has to compile
 		Object[] applications = switchFind(docResolvedOrg);
-		for (int i = 0; i < applications.length; ++i) {
+        
+        for (int i = 0; i < applications.length; ++i) {
 			String appl = (String) applications[i];
-			// returns a clone of the document with swich-cases resolved
+            // returns a clone of the document with swich-cases resolved
 			Element docResolved =
 				(Element) clone(docResolvedOrg.getDocumentElement(), appl);
 			// now determine the id of the document, which is part of the
@@ -292,7 +290,7 @@ public class HelpCompiler implements Hel
 			HashSet extendedHelpText = new HashSet();
 			Hashtable keywords = new Hashtable();
 			Hashtable helptexts = new Hashtable();
-
+            
 			while ((test = treewalker.getNext()) != null) {
 				if (fileName == null
 					&& test.getNodeName().equals("filename")) {
@@ -332,8 +330,8 @@ public class HelpCompiler implements Hel
 						LinkedList ll = new LinkedList();
 
 						NodeList list = el.getChildNodes();
-						for (int j = 0; i < list.getLength(); ++i) {
-							Node nd = list.item(i);
+						for (int j = 0; j < list.getLength(); ++j) {
+							Node nd = list.item(j);
 							if (!nd.getNodeName().equals("bookmark_value"))
 								continue;
 							String embedded =
@@ -346,17 +344,26 @@ public class HelpCompiler implements Hel
 
 							String keyword =
 								((Text) nd.getFirstChild()).getData();
+                            int keywordSem = keyword.indexOf(';');
+                            if(keywordSem != -1) {
+                                String tmppre =
+                                    keyword.substring(0,keywordSem).trim();
+                                String tmppos =
+                                    keyword.substring(1+keywordSem).trim();
+                                keyword = tmppre + ";" + tmppos;
+                            }
 							ll.add(keyword);
 						}
-						if (!ll.isEmpty())
-							keywords.put(anchor, ll);
+						if (!ll.isEmpty()) {
+                            keywords.put(anchor, ll);
+                        }
 					} else if (branch.equals("contents")) {
 						// currently not used
 					}
 				} else if (test.getNodeName().equals("ahelp")) {
-					String text = dump(test);
-					String name = ((Element) test).getAttribute("hid");
-					helptexts.put(name, text);
+					String text = dump(test).trim();
+                    String name = null; //((Element) test).getAttribute("hid");
+					// helptexts.put(name, text);
 					Iterator iter = extendedHelpText.iterator();
 					while (iter.hasNext()) {
 						name = (String) iter.next();
@@ -447,11 +454,14 @@ public class HelpCompiler implements Hel
 		String app = new String();
 		if (node.hasChildNodes()) {
 			NodeList list = node.getChildNodes();
-			for (int i = 0; i < list.getLength(); ++i)
-				app += dump(list.item(i));
+			for (int i = 0; i < list.getLength(); ++i) {
+                app += dump(list.item(i));
+                // System.out.println(list.item(i).toString());
+            }
 		}
 		if (node.getNodeType() == Node.TEXT_NODE) {
-			return ((Text) node).getData();
+			app += ((Text) node).getData();
+            // System.out.println(app);
 		}
 		return app;
 	}
Index: xmlhelp/source/com/sun/star/help/HelpLinker.java
===================================================================
RCS file: /cvs/util/xmlhelp/source/com/sun/star/help/HelpLinker.java,v
retrieving revision 1.6
retrieving revision 1.6.2.1
diff -u -p -r1.6 -r1.6.2.1
--- xmlhelp/source/com/sun/star/help/HelpLinker.java	27 Jan 2005 10:07:27 -0000	1.6
+++ xmlhelp/source/com/sun/star/help/HelpLinker.java	4 Feb 2005 09:58:49 -0000	1.6.2.1
@@ -98,7 +98,7 @@ import com.sun.xmlsearch.xml.indexer.Xml
 class HelpLinker {
 
 	public static void main(String[] args) {
-		HelpCompiler.initURLHandler();
+        HelpCompiler.initURLHandler();
 
 		Hashtable additionalFiles = new Hashtable();
 		HashSet helpFiles = new HashSet();
@@ -110,6 +110,12 @@ class HelpLinker {
 		String lang = null;
 		String hid = null;
 		if (args.length > 0 && args[0].startsWith("@")) {
+//			try {
+//				Thread.sleep(100000);
+//			} catch (InterruptedException e1) {
+//				// TODO Auto-generated catch block
+//				e1.printStackTrace();
+//			}
 			try {
 				String fName = args[0].substring(1);
 				FileReader fileReader = new FileReader(fName);
Index: xmlhelp/source/cxxhelp/provider/urlparameter.cxx
===================================================================
RCS file: /cvs/util/xmlhelp/source/cxxhelp/provider/urlparameter.cxx,v
retrieving revision 1.34
retrieving revision 1.34.18.1
diff -u -p -r1.34 -r1.34.18.1
--- xmlhelp/source/cxxhelp/provider/urlparameter.cxx	8 Sep 2004 16:17:44 -0000	1.34
+++ xmlhelp/source/cxxhelp/provider/urlparameter.cxx	4 Feb 2005 11:05:17 -0000	1.34.18.1
@@ -224,6 +224,8 @@ rtl::OString URLParameter::getByName( co
 		val = get_program();
 	else if( strcmp( par,"Database" ) == 0 )
 		val = get_module();
+	else if( strcmp( par,"DatabasePar" ) == 0 )
+		val = get_dbpar();
 	else if( strcmp( par,"Id" ) == 0 )
 		val = get_id();
 	else if( strcmp( par,"Path" ) == 0 )
@@ -721,6 +723,8 @@ bool URLParameter::query()
 			m_aEid = value;
 		else if( parameter.compareToAscii( "UseDB" ) == 0 )
             m_bUseDB = ! ( value.compareToAscii("no") == 0 );
+        else if( parameter.compareToAscii( "DbPAR" ) == 0 )
+            m_aDbPar = value;
 		else if( parameter.compareToAscii( "Query" ) == 0 )
 		{	
 			if( ! m_aQuery.getLength() )
@@ -846,7 +850,7 @@ InputStreamTransformer::InputStreamTrans
 		parString[last++] = "Program";
 		parString[last++] = urlParam->getByName( "Program" );
 		parString[last++] = "Database";
-		parString[last++] = urlParam->getByName( "Database" );
+		parString[last++] = urlParam->getByName( "DatabasePar" );
 		parString[last++] = "Id";
 		parString[last++] = urlParam->getByName( "Id" );
 		parString[last++] = "Path";
Index: curl/makefile.mk
===================================================================
RCS file: /cvs/external/curl/makefile.mk,v
retrieving revision 1.11
retrieving revision 1.11.2.1
diff -u -p -r1.11 -r1.11.2.1
--- curl/makefile.mk	28 Jan 2005 16:06:09 -0000	1.11
+++ curl/makefile.mk	11 Feb 2005 16:18:36 -0000	1.11.2.1
@@ -85,7 +85,7 @@ CONVERTFILES= \
 CONFIGURE_DIR=.$/
 #relative to CONFIGURE_DIR
 CONFIGURE_ACTION=.$/configure
-CONFIGURE_FLAGS= --without-ssl --enable-ftp --enable-ipv6 --disable-http --disable-gopher --disable-file --disable-ldap --disable-telnet --disable-dict
+CONFIGURE_FLAGS= --without-ssl --without-libidn --enable-ftp --enable-ipv6 --disable-http --disable-gopher --disable-file --disable-ldap --disable-telnet --disable-dict
 
 BUILD_DIR=$(CONFIGURE_DIR)$/lib
 .IF "$(OS)"=="IRIX"
Index: sfx2/source/appl/appinit.cxx
===================================================================
RCS file: /cvs/framework/sfx2/source/appl/appinit.cxx,v
retrieving revision 1.45
retrieving revision 1.45.36.1
diff -u -p -r1.45 -r1.45.36.1
--- sfx2/source/appl/appinit.cxx	18 Jan 2005 16:00:35 -0000	1.45
+++ sfx2/source/appl/appinit.cxx	17 Feb 2005 14:44:34 -0000	1.45.36.1
@@ -242,10 +242,13 @@ String GetSpecialCharsForEdit(Window* pP
         // get symbol
         ::rtl::OUString aSymbol( RTL_CONSTASCII_USTRINGPARAM( "GetSpecialCharsForEdit" ) );
         pfunc_getSpecialCharsForEdit = (PFunc_getSpecialCharsForEdit)osl_getSymbol( handleMod, aSymbol.pData );
+	    DBG_ASSERT( pfunc_getSpecialCharsForEdit, "GetSpecialCharsForEdit() not found!" );
     }
 
     if ( pfunc_getSpecialCharsForEdit )
         return (*pfunc_getSpecialCharsForEdit)( pParent, rFont );
+    else
+        return String();
 }
 
 //====================================================================
Index: sfx2/source/appl/appmain.cxx
===================================================================
RCS file: /cvs/framework/sfx2/source/appl/appmain.cxx,v
retrieving revision 1.24
retrieving revision 1.24.36.1
diff -u -p -r1.24 -r1.24.36.1
--- sfx2/source/appl/appmain.cxx	18 Jan 2005 16:00:52 -0000	1.24
+++ sfx2/source/appl/appmain.cxx	21 Feb 2005 17:02:31 -0000	1.24.36.1
@@ -66,6 +66,7 @@
 #ifndef GCC
 #pragma hdrstop
 #endif
+#include <stdio.h>
 
 #ifndef _PVER_HXX //autogen
 #include <svtools/pver.hxx>
@@ -377,7 +378,7 @@ void SfxApplication::Main( )
 void SfxApplication::InsertLateInitHdl(const Link& rLink)
 {
 	if ( Application::IsInExecute() )
-		Application::PostUserEvent( rLink );
+           Application::PostUserEvent( rLink );
 	else
 	{
 		if ( !pAppData_Impl->pInitLinkList )
@@ -400,6 +401,8 @@ IMPL_LINK( SfxApplication, LateInitTimer
         return 0;
     }
 
+    if ( pAppData_Impl->pInitLinkList && pAppData_Impl->pInitLinkList->Count() )
+    {
 	// Ersten Link aus der Liste holen und ausf"uhren
 	Link *pLink = (*pAppData_Impl->pInitLinkList)[0];
 	pLink->Call(0);
@@ -419,7 +422,8 @@ IMPL_LINK( SfxApplication, LateInitTimer
 		pAppIniMgr->ResetLock();
 #endif
 	}
-	return 0;
+    }
+    return 0;
 }
 
 //-------------------------------------------------------------------------
Index: sfx2/source/bastyp/fltfnc.cxx
===================================================================
RCS file: /cvs/framework/sfx2/source/bastyp/fltfnc.cxx,v
retrieving revision 1.64
retrieving revision 1.64.36.1
diff -u -p -r1.64 -r1.64.36.1
--- sfx2/source/bastyp/fltfnc.cxx	18 Jan 2005 16:04:36 -0000	1.64
+++ sfx2/source/bastyp/fltfnc.cxx	24 Feb 2005 13:37:39 -0000	1.64.36.1
@@ -891,10 +891,15 @@ const SfxFilter* SfxFilterMatcher::GetFi
 		return 0;
 	}
 
-	com::sun::star::uno::Sequence < com::sun::star::beans::NamedValue > aSeq(1);
+    // Use extension without dot!
+    String sExt( rExt );
+    if ( sExt.Len() && ( sExt.GetChar(0) == (sal_Unicode)'.' ))
+        sExt.Erase(0,1);
+    
+    com::sun::star::uno::Sequence < com::sun::star::beans::NamedValue > aSeq(1);
 	aSeq[0].Name = ::rtl::OUString::createFromAscii("Extensions");
 	::com::sun::star::uno::Sequence < ::rtl::OUString > aExts(1);
-	aExts[0] = rExt;
+	aExts[0] = sExt;
 	aSeq[0].Value <<= aExts;
 	return GetFilterForProps( aSeq, nMust, nDont );
 }
Index: sfx2/source/dialog/cfg.cxx
===================================================================
RCS file: /cvs/framework/sfx2/source/dialog/cfg.cxx,v
retrieving revision 1.49
retrieving revision 1.49.2.1
diff -u -p -r1.49 -r1.49.2.1
--- sfx2/source/dialog/cfg.cxx	2 Feb 2005 14:02:34 -0000	1.49
+++ sfx2/source/dialog/cfg.cxx	15 Feb 2005 12:15:56 -0000	1.49.2.1
@@ -240,7 +240,7 @@ sal_Bool SfxStylesInfo_Impl::parseStyleC
     if (sArg.indexOf(CMDURL_FPART_ONLY) == 0)
         aStyle.sFamily = sArg.copy(LEN_FPART, sArg.getLength()-LEN_FPART);
     
-    sArg = sCmdArgs.copy(i+1, sCmdArgs.getLength()-i);
+    sArg = sCmdArgs.copy(i+1, sCmdArgs.getLength()-i-1);
     if (sArg.indexOf(CMDURL_SPART_ONLY) == 0)
         aStyle.sStyle = sArg.copy(LEN_SPART, sArg.getLength()-LEN_SPART);
     else
Index: sfx2/source/dialog/mailmodel.cxx
===================================================================
RCS file: /cvs/framework/sfx2/source/dialog/mailmodel.cxx,v
retrieving revision 1.29
retrieving revision 1.29.14.3
diff -u -p -r1.29 -r1.29.14.3
--- sfx2/source/dialog/mailmodel.cxx	21 Jan 2005 17:33:16 -0000	1.29
+++ sfx2/source/dialog/mailmodel.cxx	24 Feb 2005 13:37:40 -0000	1.29.14.3
@@ -371,9 +371,9 @@ SfxMailModel_Impl::SaveResult SfxMailMod
 
 		// Get PDF Filter from document
 		SfxFilterMatcher aMatcher( String::CreateFromAscii(xDocShell->GetFactory().GetShortName()) );
-		String aPDFExtension = String::CreateFromAscii( "pdf" );
+		String aPDFExtension = String::CreateFromAscii( "pdf" ); // Extension without dot!
 
-		const SfxFilter*	pFilter		= aMatcher.GetFilter4Extension( aPDFExtension, SFX_FILTER_EXPORT );
+        const SfxFilter*	pFilter		= aMatcher.GetFilter4Extension( aPDFExtension, SFX_FILTER_EXPORT );
 		sal_Bool			bHasFilter	= pFilter ? sal_True : sal_False;
 
 		// create temp file name with leading chars and extension
@@ -389,8 +389,8 @@ SfxMailModel_Impl::SaveResult SfxMailMod
 			String aName;
 			if ( aFileObj.hasExtension() )
 			{
-				pExt = new String( aPDFExtension );
-				aFileObj.removeExtension();
+				pExt = new String( String::CreateFromAscii( "." ) + (OUString)aPDFExtension );
+                aFileObj.removeExtension();
 				aLeadingStr = aFileObj.getName( INetURLObject::LAST_SEGMENT, true, INetURLObject::DECODE_WITH_CHARSET );
 				aLeadingStr += String::CreateFromAscii( "_" );
 			}
Index: sfx2/source/dialog/templdlg.src
===================================================================
RCS file: /cvs/framework/sfx2/source/dialog/templdlg.src,v
retrieving revision 1.32
retrieving revision 1.32.132.1
diff -u -p -r1.32 -r1.32.132.1
--- sfx2/source/dialog/templdlg.src	2 Nov 2004 12:49:08 -0000	1.32
+++ sfx2/source/dialog/templdlg.src	11 Feb 2005 16:30:14 -0000	1.32.132.1
@@ -189,7 +189,7 @@ String STR_STYLE_FILTER_HIERARCHICAL
  // DLG_STYLE_DESIGNER ----------------------------------------------------
 DockingWindow DLG_STYLE_DESIGNER
 {
-    Text [ de ] = "Formatvorlagen und Formatierung" ;
+    Text [ de ] = "Formatvorlagen" ;
 	Text [ en-US ] = "Styles and Formatting" ;
 	
 	HelpId = SID_STYLE_DESIGNER ;
Index: sfx2/source/doc/objstor.cxx
===================================================================
RCS file: /cvs/framework/sfx2/source/doc/objstor.cxx,v
retrieving revision 1.153
retrieving revision 1.153.12.1
diff -u -p -r1.153 -r1.153.12.1
--- sfx2/source/doc/objstor.cxx	7 Feb 2005 14:55:08 -0000	1.153
+++ sfx2/source/doc/objstor.cxx	15 Feb 2005 09:17:02 -0000	1.153.12.1
@@ -141,6 +141,9 @@
 #ifndef _COM_SUN_STAR_CONTAINER_XNAMEACCESS_HPP_
 #include <com/sun/star/container/XNameAccess.hpp>
 #endif
+#ifndef _COM_SUN_STAR_CONTAINER_XSET_HPP_
+#include <com/sun/star/container/XSet.hpp>
+#endif
 
 #ifndef _COM_SUN_STAR_EMBED_ELEMENTMODES_HPP_
 #include <com/sun/star/embed/ElementModes.hpp>
@@ -259,6 +262,22 @@ using namespace ::com::sun::star::docume
 using namespace ::rtl;
 using namespace ::cppu;
 
+namespace css = ::com::sun::star;
+
+//=========================================================================
+void impl_addToModelCollection(const css::uno::Reference< css::frame::XModel >& xModel)
+{
+    if (!xModel.is())
+        return;
+    
+    css::uno::Reference< css::lang::XMultiServiceFactory > xSMGR = ::comphelper::getProcessServiceFactory();
+    css::uno::Reference< css::container::XSet > xModelCollection(
+        xSMGR->createInstance(::rtl::OUString::createFromAscii("com.sun.star.frame.GlobalEventBroadcaster")),
+        css::uno::UNO_QUERY);
+    if (xModelCollection.is())
+        xModelCollection->insert(css::uno::makeAny(xModel));    
+}
+
 //=========================================================================
 
 sal_Bool SfxObjectShell::Save()
@@ -619,6 +638,7 @@ sal_Bool SfxObjectShell::DoInitNew( SfxM
             aArgs[nLength].Name = DEFINE_CONST_UNICODE("Title");
             aArgs[nLength].Value <<= ::rtl::OUString( GetTitle( SFX_TITLE_DETECT ) );
             xModel->attachResource( ::rtl::OUString(), aArgs );
+            impl_addToModelCollection(xModel);
 		}
 
         SetActivateEvent_Impl( SFX_EVENT_CREATEDOC );
@@ -975,6 +995,7 @@ sal_Bool SfxObjectShell::DoLoad( SfxMedi
 			uno::Sequence< beans::PropertyValue > aArgs;
 			TransformItems( SID_OPENDOC, *pSet, aArgs );
 			xModel->attachResource( aURL, aArgs );
+            impl_addToModelCollection(xModel);
 		}
 
         if( IsOwnStorageFormat_Impl(*pMed) && pMed->GetFilter() )
Index: sfx2/source/inc/applet.hxx
===================================================================
RCS file: /cvs/framework/sfx2/source/inc/applet.hxx,v
retrieving revision 1.2
retrieving revision 1.2.208.1
diff -u -p -r1.2 -r1.2.208.1
--- sfx2/source/inc/applet.hxx	4 Oct 2004 20:58:14 -0000	1.2
+++ sfx2/source/inc/applet.hxx	15 Feb 2005 10:19:33 -0000	1.2.208.1
@@ -93,7 +93,7 @@
 #include <com/sun/star/embed/XEmbeddedObject.hpp>
 #endif
 
-#ifndef _CPPUHELPER_IMPLBASE5_HXX_
+#ifndef _CPPUHELPER_IMPLBASE6_HXX_
 #include <cppuhelper/implbase6.hxx>
 #endif
 
Index: sfx2/source/inc/eventsupplier.hxx
===================================================================
RCS file: /cvs/framework/sfx2/source/inc/eventsupplier.hxx,v
retrieving revision 1.10
retrieving revision 1.10.2.1
diff -u -p -r1.10 -r1.10.2.1
--- sfx2/source/inc/eventsupplier.hxx	2 Feb 2005 14:02:55 -0000	1.10
+++ sfx2/source/inc/eventsupplier.hxx	15 Feb 2005 09:16:20 -0000	1.10.2.1
@@ -68,6 +68,9 @@
 #ifndef  _COM_SUN_STAR_CONTAINER_XNAMEREPLACE_HPP_
 #include <com/sun/star/container/XNameReplace.hpp>
 #endif
+#ifndef  _COM_SUN_STAR_CONTAINER_XSET_HPP_
+#include <com/sun/star/container/XSet.hpp>
+#endif
 #ifndef  _COM_SUN_STAR_DOCUMENT_XEVENTLISTENER_HPP_
 #include <com/sun/star/document/XEventListener.hpp>
 #endif
@@ -100,6 +103,9 @@
 #ifndef  _CPPUHELPER_WEAK_HXX_
 #include <cppuhelper/weak.hxx>
 #endif
+#ifndef _CPPUHELPER_IMPLBASE1_HXX_
+#include <cppuhelper/implbase1.hxx>
+#endif
 #ifndef _CPPUHELPER_IMPLBASE2_HXX_
 #include <cppuhelper/implbase2.hxx>
 #endif
@@ -109,6 +115,15 @@
 #ifndef _CPPUHELPER_IMPLBASE4_HXX_
 #include <cppuhelper/implbase4.hxx>
 #endif
+#ifndef _CPPUHELPER_IMPLBASE5_HXX_
+#include <cppuhelper/implbase5.hxx>
+#endif
+#ifndef _COMPHELPER_SEQUENCEASHASHMAP_HXX_
+#include <comphelper/sequenceashashmap.hxx>
+#endif
+#ifndef _COMPHELPER_SEQUENCEASVECTOR_HXX_
+#include <comphelper/sequenceasvector.hxx>
+#endif
 
 #ifndef  _SFX_SFXUNO_HXX
 #include <sfxuno.hxx>
@@ -191,27 +206,128 @@ public:
 	static void					BlowUpMacro( const ANY& rIn, ANY& rOut, SfxObjectShell* pDoc );
 };
 
-class SfxGlobalEvents_Impl : public ::cppu::WeakImplHelper4< ::com::sun::star::document::XEventsSupplier,
-						::com::sun::star::document::XEventBroadcaster, ::com::sun::star::lang::XServiceInfo,
-                        ::com::sun::star::document::XEventListener >,
-						public SfxListener
+//=============================================================================
+struct ModelCollectionMutexBase
+{
+    public:
+        ::osl::Mutex m_aLock;
+};
+
+//=============================================================================
+typedef ::std::vector< ::com::sun::star::uno::Reference< ::com::sun::star::frame::XModel > > TModelList;
+
+//=============================================================================
+class ModelCollectionEnumeration : public ModelCollectionMutexBase 
+                                 , public ::cppu::WeakImplHelper1< ::com::sun::star::container::XEnumeration >
+{
+    
+    //-------------------------------------------------------------------------
+    // member
+    //-------------------------------------------------------------------------
+    private:
+        ::com::sun::star::uno::Reference< ::com::sun::star::lang::XMultiServiceFactory > m_xSMGR;
+        TModelList m_lModels;
+        TModelList::iterator m_pEnumerationIt;
+        
+    //-------------------------------------------------------------------------
+    // native interface
+    //-------------------------------------------------------------------------
+    public:
+        ModelCollectionEnumeration(const ::com::sun::star::uno::Reference< ::com::sun::star::lang::XMultiServiceFactory >& xSMGR);
+        virtual ~ModelCollectionEnumeration();
+        void setModelList(const TModelList& rList);
+    
+    //-------------------------------------------------------------------------
+    // uno interface        
+    //-------------------------------------------------------------------------
+    public:
+    
+        // css.container.XEnumeration
+        virtual sal_Bool SAL_CALL hasMoreElements()
+            throw(::com::sun::star::uno::RuntimeException);
+            
+        virtual ::com::sun::star::uno::Any SAL_CALL nextElement()
+            throw(::com::sun::star::container::NoSuchElementException,
+                  ::com::sun::star::lang::WrappedTargetException     ,
+                  ::com::sun::star::uno::RuntimeException            );
+};
+
+//=============================================================================
+class SfxGlobalEvents_Impl : public ModelCollectionMutexBase 
+                           , public ::cppu::WeakImplHelper5< ::com::sun::star::lang::XServiceInfo
+                                                           , ::com::sun::star::document::XEventsSupplier
+                                                           , ::com::sun::star::document::XEventBroadcaster
+                                                           , ::com::sun::star::document::XEventListener
+                                                           , ::com::sun::star::container::XSet >
+                           , public SfxListener
 {
-	GlobalEventConfig*             pImp;
-	REFERENCE < XNAMEREPLACE >  m_xEvents;
-    WEAKREFERENCE < XJOBEXECUTOR > m_xJobsBinding;
-	OINTERFACECONTAINERHELPER	m_aInterfaceContainer;
-	::osl::Mutex				m_aMutex;
+	::com::sun::star::uno::Reference< ::com::sun::star::lang::XMultiServiceFactory > m_xSMGR;
+	::com::sun::star::uno::Reference< ::com::sun::star::container::XNameReplace > m_xEvents;
+    ::com::sun::star::uno::WeakReference< ::com::sun::star::task::XJobExecutor > m_xJobsBinding;
+	OINTERFACECONTAINERHELPER m_aInterfaceContainer;
+    TModelList m_lModels;    
+	GlobalEventConfig* pImp;
 
-								void Notify( SfxBroadcaster& aBC, const	SfxHint& aHint );
+    void Notify( SfxBroadcaster& aBC, const	SfxHint& aHint );
+    
 public:
-                                SfxGlobalEvents_Impl( const com::sun::star::uno::Reference < ::com::sun::star::lang::XMultiServiceFactory >& xSmgr );
-								~SfxGlobalEvents_Impl();
+    SfxGlobalEvents_Impl(const com::sun::star::uno::Reference < ::com::sun::star::lang::XMultiServiceFactory >& xSMGR);
+    virtual ~SfxGlobalEvents_Impl();
+    
     SFX_DECL_XSERVICEINFO
-    virtual REFERENCE< XNAMEREPLACE > SAL_CALL getEvents() throw( RUNTIMEEXCEPTION );
-    virtual void SAL_CALL addEventListener( const REFERENCE< XDOCEVENTLISTENER >& xListener ) throw( RUNTIMEEXCEPTION );
-    virtual void SAL_CALL removeEventListener( const REFERENCE< XDOCEVENTLISTENER >& xListener ) throw( RUNTIMEEXCEPTION );
-    virtual void SAL_CALL notifyEvent( const ::com::sun::star::document::EventObject& Event ) throw ( RUNTIMEEXCEPTION );
-    virtual void SAL_CALL disposing( const ::com::sun::star::lang::EventObject& Event ) throw ( RUNTIMEEXCEPTION );
+    
+    // css.document.XEventBroadcaster
+    virtual ::com::sun::star::uno::Reference< ::com::sun::star::container::XNameReplace > SAL_CALL getEvents()
+        throw(::com::sun::star::uno::RuntimeException);
+        
+    virtual void SAL_CALL addEventListener(const ::com::sun::star::uno::Reference< ::com::sun::star::document::XEventListener >& xListener)
+        throw(::com::sun::star::uno::RuntimeException);
+        
+    virtual void SAL_CALL removeEventListener( const ::com::sun::star::uno::Reference< ::com::sun::star::document::XEventListener >& xListener)
+        throw(::com::sun::star::uno::RuntimeException);
+    
+    // css.document.XEventListener
+    virtual void SAL_CALL notifyEvent(const ::com::sun::star::document::EventObject& aEvent)
+        throw(::com::sun::star::uno::RuntimeException);
+    
+    // css.container.XSet
+    virtual sal_Bool SAL_CALL has(const ::com::sun::star::uno::Any& aElement)
+        throw(::com::sun::star::uno::RuntimeException);
+        
+    virtual void SAL_CALL insert(const ::com::sun::star::uno::Any& aElement)
+        throw(::com::sun::star::lang::IllegalArgumentException  ,
+              ::com::sun::star::container::ElementExistException,
+              ::com::sun::star::uno::RuntimeException           );
+              
+    virtual void SAL_CALL remove(const ::com::sun::star::uno::Any& aElement)
+        throw(::com::sun::star::lang::IllegalArgumentException   ,
+              ::com::sun::star::container::NoSuchElementException,
+              ::com::sun::star::uno::RuntimeException            );
+
+    // css.container.XEnumerationAccess
+    virtual ::com::sun::star::uno::Reference< ::com::sun::star::container::XEnumeration > SAL_CALL createEnumeration()
+        throw(::com::sun::star::uno::RuntimeException);
+    
+    // css.container.XElementAccess
+    virtual ::com::sun::star::uno::Type SAL_CALL getElementType()
+        throw(::com::sun::star::uno::RuntimeException);
+        
+    virtual sal_Bool SAL_CALL hasElements()
+        throw(::com::sun::star::uno::RuntimeException);
+    
+    // css.lang.XEventListener
+    virtual void SAL_CALL disposing(const ::com::sun::star::lang::EventObject& aEvent)
+        throw(::com::sun::star::uno::RuntimeException);
+    
+private:
+
+    // threadsafe
+    void implts_notifyJobExecution(const ::com::sun::star::document::EventObject& aEvent);
+    void implts_checkAndExecuteEventBindings(const ::com::sun::star::document::EventObject& aEvent);
+    void implts_notifyListener(const ::com::sun::star::document::EventObject& aEvent);
+    
+    // not threadsafe
+    TModelList::iterator impl_searchDoc(const ::com::sun::star::uno::Reference< ::com::sun::star::frame::XModel >& xModel);
 };
 
 #endif
Index: sfx2/source/inc/iframe.hxx
===================================================================
RCS file: /cvs/framework/sfx2/source/inc/iframe.hxx,v
retrieving revision 1.2
retrieving revision 1.2.208.1
diff -u -p -r1.2 -r1.2.208.1
--- sfx2/source/inc/iframe.hxx	4 Oct 2004 20:58:47 -0000	1.2
+++ sfx2/source/inc/iframe.hxx	15 Feb 2005 10:19:35 -0000	1.2.208.1
@@ -96,7 +96,7 @@
 #include <com/sun/star/embed/XEmbeddedObject.hpp>
 #endif
 
-#ifndef _CPPUHELPER_IMPLBASE5_HXX_
+#ifndef _CPPUHELPER_IMPLBASE6_HXX_
 #include <cppuhelper/implbase6.hxx>
 #endif
 
Index: sfx2/source/notify/eventsupplier.cxx
===================================================================
RCS file: /cvs/framework/sfx2/source/notify/eventsupplier.cxx,v
retrieving revision 1.27
retrieving revision 1.27.2.2
diff -u -p -r1.27 -r1.27.2.2
--- sfx2/source/notify/eventsupplier.cxx	2 Feb 2005 14:03:08 -0000	1.27
+++ sfx2/source/notify/eventsupplier.cxx	23 Feb 2005 11:33:58 -0000	1.27.2.2
@@ -121,6 +121,8 @@
 #define PROPERTYVALUE		::com::sun::star::beans::PropertyValue
 #define	UNO_QUERY			::com::sun::star::uno::UNO_QUERY
 
+namespace css = ::com::sun::star;
+
 //--------------------------------------------------------------------------------------------------------
 	//  --- XNameReplace ---
 //--------------------------------------------------------------------------------------------------------
@@ -595,94 +597,336 @@ void SfxEvents_Impl::BlowUpMacro( const 
 	}
 }
 
+ModelCollectionEnumeration::ModelCollectionEnumeration(const css::uno::Reference< css::lang::XMultiServiceFactory >& xSMGR)
+    : ModelCollectionMutexBase(                 )
+    , m_xSMGR                 (xSMGR            )
+    , m_pEnumerationIt        (m_lModels.begin())
+{
+}
+
+ModelCollectionEnumeration::~ModelCollectionEnumeration()
+{
+}
+
+void ModelCollectionEnumeration::setModelList(const TModelList& rList)
+{
+    // SAFE ->
+    ::osl::ResettableMutexGuard aLock(m_aLock);
+    m_lModels        = rList;
+    m_pEnumerationIt = m_lModels.begin();
+    aLock.clear();
+    // <- SAFE
+}
+
+sal_Bool SAL_CALL ModelCollectionEnumeration::hasMoreElements()
+    throw(css::uno::RuntimeException)
+{
+    // SAFE ->
+    ::osl::ResettableMutexGuard aLock(m_aLock);
+    return (m_pEnumerationIt != m_lModels.end());
+    // <- SAFE
+}
+    
+css::uno::Any SAL_CALL ModelCollectionEnumeration::nextElement()
+    throw(css::container::NoSuchElementException,
+          css::lang::WrappedTargetException     ,
+          css::uno::RuntimeException            )
+{
+    // SAFE ->
+    ::osl::ResettableMutexGuard aLock(m_aLock);
+    if (m_pEnumerationIt == m_lModels.end())
+        throw css::container::NoSuchElementException(
+                    ::rtl::OUString::createFromAscii("End of model enumeration reached."),
+                    static_cast< css::container::XEnumeration* >(this));
+    css::uno::Reference< css::frame::XModel > xModel(*m_pEnumerationIt, UNO_QUERY);
+    ++m_pEnumerationIt;
+    aLock.clear();
+    // <- SAFE
+    
+    return css::uno::makeAny(xModel);
+}
+                  
 SFX_IMPL_XSERVICEINFO( SfxGlobalEvents_Impl, "com.sun.star.frame.GlobalEventBroadcaster", "com.sun.star.comp.sfx2.GlobalEventBroadcaster" )
 SFX_IMPL_ONEINSTANCEFACTORY( SfxGlobalEvents_Impl );
 
-SfxGlobalEvents_Impl::SfxGlobalEvents_Impl( const com::sun::star::uno::Reference < ::com::sun::star::lang::XMultiServiceFactory >& xSmgr )
-	: m_aInterfaceContainer( m_aMutex )
+//-----------------------------------------------------------------------------
+SfxGlobalEvents_Impl::SfxGlobalEvents_Impl( const com::sun::star::uno::Reference < ::com::sun::star::lang::XMultiServiceFactory >& xSMGR)
+    : ModelCollectionMutexBase(       )
+    , m_xSMGR                 (xSMGR  )
+	, m_aInterfaceContainer   (m_aLock)
+    , pImp                    (0      )
 {
 	m_refCount++;
-//	pImp = new SfxEvents_Impl( NULL, this );
-    pImp = new GlobalEventConfig();
-	m_xEvents = pImp;
-    m_xJobsBinding = REFERENCE< XJOBEXECUTOR >(xSmgr->createInstance(OUSTRING::createFromAscii("com.sun.star.task.JobExecutor")), UNO_QUERY);
-	StartListening(*SFX_APP());
+    SFX_APP();
+    pImp           = new GlobalEventConfig();
+	m_xEvents      = pImp;
+    m_xJobsBinding = css::uno::Reference< css::task::XJobExecutor >(
+                        xSMGR->createInstance(::rtl::OUString::createFromAscii("com.sun.star.task.JobExecutor")),
+                        UNO_QUERY);
 	m_refCount--;
 }
 
+//-----------------------------------------------------------------------------
 SfxGlobalEvents_Impl::~SfxGlobalEvents_Impl()
 {
 }
 
-REFERENCE< XNAMEREPLACE > SAL_CALL SfxGlobalEvents_Impl::getEvents() throw( RUNTIMEEXCEPTION )
+//-----------------------------------------------------------------------------
+void SfxGlobalEvents_Impl::Notify( SfxBroadcaster& aBC, const SfxHint& aHint )
+{
+	SfxEventHint* pNamedHint = PTR_CAST(SfxEventHint, &aHint);
+	if (!pNamedHint)
+        return;
+    
+    css::uno::Reference< css::document::XEventsSupplier > xSup;
+    
+    ::rtl::OUString sName  = SfxEventConfiguration::GetEventName_Impl(pNamedHint->GetEventId());
+    SfxObjectShell* pShell = pNamedHint->GetObjShell();
+    if (pShell)
+        xSup = css::uno::Reference< css::document::XEventsSupplier >(pShell->GetModel(), UNO_QUERY);
+
+    css::document::EventObject aEvent(xSup, sName);
+    notifyEvent(aEvent);
+}
+
+//-----------------------------------------------------------------------------
+css::uno::Reference< css::container::XNameReplace > SAL_CALL SfxGlobalEvents_Impl::getEvents()
+    throw(css::uno::RuntimeException)
 {
+    // SAFE ->
+    ::osl::ResettableMutexGuard aLock(m_aLock);
 	return m_xEvents;
+    // <- SAFE
 }
 
-void SAL_CALL SfxGlobalEvents_Impl::addEventListener( const REFERENCE< XDOCEVENTLISTENER >& xListener ) throw( RUNTIMEEXCEPTION )
+//-----------------------------------------------------------------------------
+void SAL_CALL SfxGlobalEvents_Impl::addEventListener(const css::uno::Reference< css::document::XEventListener >& xListener)  
+    throw(css::uno::RuntimeException)
 {
-	m_aInterfaceContainer.addInterface( xListener );
+    // container is threadsafe
+	m_aInterfaceContainer.addInterface(xListener);
 }
 
-void SAL_CALL SfxGlobalEvents_Impl::removeEventListener( const REFERENCE< XDOCEVENTLISTENER >& xListener ) throw( RUNTIMEEXCEPTION )
+//-----------------------------------------------------------------------------
+void SAL_CALL SfxGlobalEvents_Impl::removeEventListener(const css::uno::Reference< css::document::XEventListener >& xListener)
+    throw(css::uno::RuntimeException)
 {
-	m_aInterfaceContainer.removeInterface( xListener );
+    // container is threadsafe
+	m_aInterfaceContainer.removeInterface(xListener);
 }
 
-void SfxGlobalEvents_Impl::Notify( SfxBroadcaster& aBC, const SfxHint& aHint )
+//-----------------------------------------------------------------------------
+void SAL_CALL SfxGlobalEvents_Impl::notifyEvent(const css::document::EventObject& aEvent)
+    throw(css::uno::RuntimeException)
 {
-	SfxEventHint* pNamedHint = PTR_CAST( SfxEventHint, &aHint );
-	if ( pNamedHint )
-	{
-		OUSTRING aName = SfxEventConfiguration::GetEventName_Impl( pNamedHint->GetEventId() );
-		REFERENCE < XEVENTSSUPPLIER > xSup;
-		if ( pNamedHint->GetObjShell() )
-			xSup = REFERENCE < XEVENTSSUPPLIER >( pNamedHint->GetObjShell()->GetModel(), UNO_QUERY );
-//		else
-//			xSup = (XEVENTSSUPPLIER*) this;
+    implts_notifyJobExecution(aEvent);
+    implts_checkAndExecuteEventBindings(aEvent);    
+    implts_notifyListener(aEvent);
+}
 
-        DOCEVENTOBJECT aEvent( xSup, aName );
-        notifyEvent(aEvent);
-    }
+//-----------------------------------------------------------------------------
+void SAL_CALL SfxGlobalEvents_Impl::disposing(const css::lang::EventObject& aEvent)
+    throw(css::uno::RuntimeException)
+{
+    css::uno::Reference< css::frame::XModel > xDoc(aEvent.Source, UNO_QUERY);
+    
+    // SAFE ->
+    ::osl::ResettableMutexGuard aLock(m_aLock);
+    TModelList::iterator pIt = impl_searchDoc(xDoc);
+    if (pIt != m_lModels.end())
+        m_lModels.erase(pIt);
+    aLock.clear();
+    // <- SAFE
 }
 
-void SAL_CALL SfxGlobalEvents_Impl::notifyEvent( const ::com::sun::star::document::EventObject& aEvent ) throw ( RUNTIMEEXCEPTION )
+//-----------------------------------------------------------------------------
+sal_Bool SAL_CALL SfxGlobalEvents_Impl::has(const css::uno::Any& aElement)
+    throw (css::uno::RuntimeException)
 {
-    // Attention: This listener is a special one. It binds the global document events
-    // to the generic job execution framework. It's a loose binding (using weak references).
-    // So we hold this listener outside our normal listener container.
-    // The implementation behind this job executor can be replaced ...
-    // but we check for this undocumented interface!
-    REFERENCE< XDOCEVENTLISTENER > xJobExecutor(m_xJobsBinding.get(), UNO_QUERY);
-    if (xJobExecutor.is())
-        xJobExecutor->notifyEvent(aEvent);
+    css::uno::Reference< css::frame::XModel > xDoc;
+    aElement >>= xDoc;
+    
+    sal_Bool bHas = sal_False;
+    
+    // SAFE ->
+    ::osl::ResettableMutexGuard aLock(m_aLock);
+    TModelList::iterator pIt = impl_searchDoc(xDoc);
+    if (pIt != m_lModels.end())
+        bHas = sal_True;
+    aLock.clear();
+    // <- SAFE
+    
+    return bHas;    
+}
+
+//-----------------------------------------------------------------------------
+void SAL_CALL SfxGlobalEvents_Impl::insert( const css::uno::Any& aElement )
+    throw (css::lang::IllegalArgumentException  ,
+           css::container::ElementExistException,
+           css::uno::RuntimeException           )
+{
+    css::uno::Reference< css::frame::XModel > xDoc;
+    aElement >>= xDoc;
+    if (!xDoc.is())
+        throw css::lang::IllegalArgumentException(
+                ::rtl::OUString::createFromAscii("Cant locate at least the model parameter."),
+                static_cast< css::container::XSet* >(this),
+                0);
+    
+    // SAFE ->
+    ::osl::ResettableMutexGuard aLock(m_aLock);
+    TModelList::iterator pIt = impl_searchDoc(xDoc);
+    if (pIt != m_lModels.end())
+        throw css::container::ElementExistException(
+                ::rtl::OUString(),
+                static_cast< css::container::XSet* >(this));
+    m_lModels.push_back(xDoc);
+    aLock.clear();
+    // <- SAFE
+
+    css::uno::Reference< css::document::XEventBroadcaster > xDocBroadcast(xDoc, UNO_QUERY);
+    if (xDocBroadcast.is())
+        xDocBroadcast->addEventListener(static_cast< css::document::XEventListener* >(this));
+}
+
+//-----------------------------------------------------------------------------
+void SAL_CALL SfxGlobalEvents_Impl::remove( const css::uno::Any& aElement )
+    throw (css::lang::IllegalArgumentException   ,
+           css::container::NoSuchElementException,
+           css::uno::RuntimeException            )
+{
+    css::uno::Reference< css::frame::XModel > xDoc;
+    aElement >>= xDoc;
+    if (!xDoc.is())
+        throw css::lang::IllegalArgumentException(
+                ::rtl::OUString::createFromAscii("Cant locate at least the model parameter."),
+                static_cast< css::container::XSet* >(this),
+                0);
+    
+    // SAFE ->
+    ::osl::ResettableMutexGuard aLock(m_aLock);
+    TModelList::iterator pIt = impl_searchDoc(xDoc);
+    if (pIt == m_lModels.end())
+        throw css::container::NoSuchElementException(
+                ::rtl::OUString(),
+                static_cast< css::container::XSet* >(this));
+    m_lModels.erase(pIt);                
+    aLock.clear();
+    // <- SAFE
+                
+    css::uno::Reference< css::document::XEventBroadcaster > xDocBroadcast(xDoc, UNO_QUERY);
+    if (xDocBroadcast.is())
+        xDocBroadcast->removeEventListener(static_cast< css::document::XEventListener* >(this));
+}
+
+//-----------------------------------------------------------------------------
+css::uno::Reference< css::container::XEnumeration > SAL_CALL SfxGlobalEvents_Impl::createEnumeration()
+    throw (css::uno::RuntimeException)
+{
+    // SAFE ->
+    ::osl::ResettableMutexGuard aLock(m_aLock);
+    ModelCollectionEnumeration* pEnum = new ModelCollectionEnumeration(m_xSMGR);
+    pEnum->setModelList(m_lModels);
+    css::uno::Reference< css::container::XEnumeration > xEnum(
+        static_cast< css::container::XEnumeration* >(pEnum),
+        UNO_QUERY);
+    aLock.clear();
+    // <- SAFE
+    
+    return xEnum;
+}
+
+//-----------------------------------------------------------------------------
+css::uno::Type SAL_CALL SfxGlobalEvents_Impl::getElementType()
+    throw (css::uno::RuntimeException)
+{
+    return ::getCppuType(static_cast< css::uno::Reference< css::frame::XModel >* >(NULL));
+}
+
+//-----------------------------------------------------------------------------
+sal_Bool SAL_CALL SfxGlobalEvents_Impl::hasElements()
+    throw (css::uno::RuntimeException)
+{
+    // SAFE ->
+    ::osl::ResettableMutexGuard aLock(m_aLock);
+    return (m_lModels.size()>0);
+    // <- SAFE
+}
 
+//-----------------------------------------------------------------------------
+void SfxGlobalEvents_Impl::implts_notifyJobExecution(const css::document::EventObject& aEvent)
+{
     try
     {
-        ANY aAny = m_xEvents->getByName( aEvent.EventName );
-        Execute( aAny, 0 );
+        // SAFE ->
+        ::osl::ResettableMutexGuard aLock(m_aLock);
+        css::uno::Reference< css::document::XEventListener > xJobExecutor(m_xJobsBinding.get(), UNO_QUERY);
+        aLock.clear();
+        // <- SAFE
+        if (xJobExecutor.is())
+            xJobExecutor->notifyEvent(aEvent);
     }
-    catch ( EXCEPTION& )
+    catch(const css::uno::RuntimeException& exRun)
+        { throw exRun; }
+    catch(const css::uno::Exception&)
+        {}
+}
+
+//-----------------------------------------------------------------------------
+void SfxGlobalEvents_Impl::implts_checkAndExecuteEventBindings(const css::document::EventObject& aEvent)
+{
+    try
     {
+        // SAFE ->
+        ::osl::ResettableMutexGuard aLock(m_aLock);
+        css::uno::Reference< css::container::XNameReplace > xEvents = m_xEvents;
+        aLock.clear();
+        // <- SAFE
+        
+        css::uno::Any aAny;
+        if (xEvents.is())
+            aAny = xEvents->getByName(aEvent.EventName);
+        Execute(aAny, 0);
     }
-    
-    ::cppu::OInterfaceIteratorHelper aIt( m_aInterfaceContainer );
-    while( aIt.hasMoreElements() )
+    catch(const css::uno::RuntimeException& exRun)
+        { throw exRun; }
+    catch(const css::uno::Exception&)
+        {}
+}
+
+//-----------------------------------------------------------------------------
+void SfxGlobalEvents_Impl::implts_notifyListener(const css::document::EventObject& aEvent)
+{
+    // container is threadsafe
+    ::cppu::OInterfaceIteratorHelper aIt(m_aInterfaceContainer);
+    while (aIt.hasMoreElements())
     {
         try
         {
-            ((XDOCEVENTLISTENER *)aIt.next())->notifyEvent( aEvent );
-        }
-        catch( RUNTIMEEXCEPTION& )
-        {
-            aIt.remove();
+            ((css::document::XEventListener*)aIt.next())->notifyEvent(aEvent);
         }
+        catch(const css::uno::Exception&)
+            { aIt.remove(); }
     }
 }
 
-void SAL_CALL SfxGlobalEvents_Impl::disposing( const ::com::sun::star::lang::EventObject& aEvent ) throw ( RUNTIMEEXCEPTION )
+//-----------------------------------------------------------------------------
+// not threadsafe ... must be locked from outside!
+TModelList::iterator SfxGlobalEvents_Impl::impl_searchDoc(const css::uno::Reference< css::frame::XModel >& xModel)
 {
-    // not interesting for us.
-    // It's an OneInstance-Service, which will be disposed be the global uno service manager only ...
+    if (!xModel.is())
+        return m_lModels.end();
+    
+    TModelList::iterator pIt;
+    for (  pIt  = m_lModels.begin();
+           pIt != m_lModels.end()  ;
+         ++pIt                     )
+    {
+        css::uno::Reference< css::frame::XModel > xContainerDoc(*pIt, UNO_QUERY);
+        if (xContainerDoc == xModel)
+            break;
+    }
+    
+    return pIt;
 }
 
Index: sfx2/source/view/viewfrm.cxx
===================================================================
RCS file: /cvs/framework/sfx2/source/view/viewfrm.cxx,v
retrieving revision 1.104
retrieving revision 1.104.2.1
diff -u -p -r1.104 -r1.104.2.1
--- sfx2/source/view/viewfrm.cxx	2 Feb 2005 14:03:36 -0000	1.104
+++ sfx2/source/view/viewfrm.cxx	16 Feb 2005 13:46:56 -0000	1.104.2.1
@@ -73,6 +73,9 @@
 #include <drafts/com/sun/star/frame/XLayoutManager.hpp>
 #endif
 
+#ifndef _TOOLKIT_HELPER_VCLUNOHELPER_HXX_
+#include <toolkit/unohlp.hxx>
+#endif
 #ifndef _SPLITWIN_HXX //autogen
 #include <vcl/splitwin.hxx>
 #endif
@@ -171,6 +174,7 @@ using namespace ::com::sun::star::uno;
 using namespace ::com::sun::star::ucb;
 using namespace ::com::sun::star::frame;
 using namespace ::com::sun::star::lang;
+namespace css = ::com::sun::star;
 
 #ifndef GCC
 #pragma hdrstop
@@ -2273,11 +2277,14 @@ void SfxViewFrame::MakeActive_Impl( BOOL
                 }
 
                 SfxViewFrame* pCurrent = SfxViewFrame::Current();
-                if ( GetFrame()->GetFrameInterface()->isActive() || !bPreview && ( !pCurrent || bGrabFocus ) )
+                css::uno::Reference< css::frame::XFrame > xFrame = GetFrame()->GetFrameInterface();
+                if ( xFrame->isActive() || !bPreview && ( !pCurrent || bGrabFocus ) )
                 {
                     pSfxApp->SetViewFrame( this );
-                    GetBindings().SetActiveFrame( ::com::sun::star::uno::Reference< ::com::sun::star::frame::XFrame > () );
-                    if ( bGrabFocus )
+                    GetBindings().SetActiveFrame( css::uno::Reference< css::frame::XFrame >() );
+                    css::uno::Reference< css::awt::XWindow > xContainerWindow = xFrame->getContainerWindow();
+                    Window* pWindow = VCLUnoHelper::GetWindow(xContainerWindow);
+                    if (pWindow && pWindow->HasChildPathFocus() && bGrabFocus)
                     {
                         SfxInPlaceClient *pCli = GetViewShell()->GetUIActiveClient();
                         if ( ( !pCli || !pCli->IsObjectUIActive() ) &&
Index: jvmfwk/plugins/sunmajor/pluginlib/util.cxx
===================================================================
RCS file: /cvs/udk/jvmfwk/plugins/sunmajor/pluginlib/util.cxx,v
retrieving revision 1.6
retrieving revision 1.6.2.1
diff -u -p -r1.6 -r1.6.2.1
--- jvmfwk/plugins/sunmajor/pluginlib/util.cxx	31 Jan 2005 09:50:56 -0000	1.6
+++ jvmfwk/plugins/sunmajor/pluginlib/util.cxx	16 Feb 2005 11:17:47 -0000	1.6.2.1
@@ -912,7 +912,7 @@ rtl::Reference<VendorBase> getJREInfoByP
         char const* const* arExePaths = (*pFunc)(&size);
         vecPaths = getVectorFromCharArray(arExePaths, size);
 
-        bool bOk = false;
+        bool bBreak = false;
         typedef vector<OUString>::const_iterator c_it;
         for (c_it i = vecPaths.begin(); i != vecPaths.end(); i++)
         {
@@ -960,25 +960,45 @@ rtl::Reference<VendorBase> getJREInfoByP
             bool bProcessRun= false;
             if (getJavaProps(sFilePath, props, & bProcessRun) == false)
             {
+                //The java executable could not be run or the system properties
+                //could not be retrieved. We can assume that this java is corrupt.
                 vecBadPaths.push_back(sFilePath);
-                //if there was a java executable, that is the process was started
-                //then we can assume that it is not necessary to search for another
-                //executable under the same root folder.
+                //If there was a java executable, that could be run but we did not get
+                //the system properties, then we also assume that the whole Java installation
+                //does not work. In a jdk there are two executables. One in jdk/bin and the other
+                //in jdk/jre/bin. We do not search any further, because we assume that if one java
+                //does not work then the other does not work as well. This saves us to run java
+                //again which is quite costly.
                 if (bProcessRun == true)
                 {
-                    bOk = true;
+                    // 1.3.1 special treatment: jdk/bin/java and /jdk/jre/bin/java are links to
+                    //a script, named .java_wrapper. The script starts jdk/bin/sparc/native_threads/java
+                    //or jdk/jre/bin/sparc/native_threads/java. The script uses the name with which it was
+                    //invoked to build the path to the executable. It we start the script directy as .java_wrapper
+                    //then it tries to start a jdk/.../native_threads/.java_wrapper. Therefore the link, which
+                    //is named java, must be used to start the script.
+                    getJavaProps(sFullPath, props, & bProcessRun);
+                    // Either we found a working 1.3.1                    
+                    //Or the java is broken. In both cases we stop searchin under this "root" directory
+                    bBreak = true;
                     break;
                 }
+                //sFilePath is no working java executable. We continue with another possible
+                //path.
                 else
+                {
                     continue;
+                }
             }
+            //sFilePath is a java and we could get the system properties. We proceed with this
+            //java.
             else
             {
-                bOk = true;
+                bBreak = true;
                 break;
             }
         }
-        if (bOk)
+        if (bBreak)
             break;
     }
 
@@ -1207,7 +1227,7 @@ void createJavaInfoDirScan(vector<rtl::R
                         }
                         JFW_TRACE2(OUSTR("[Java framework] sunjavaplugin: "
                                          "Checking if directory: ") + aStatus.getFileURL() +
-                                   OUSTR(" is a Java."));
+                                   OUSTR(" is a Java. \n"));
 
                         getJREInfoByPath(aStatus.getFileURL(),vecInfos);
                     }
