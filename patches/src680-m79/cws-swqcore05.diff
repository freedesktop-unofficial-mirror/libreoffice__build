Index: xmloff/source/transform/NotesTContext.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/transform/NotesTContext.cxx,v
retrieving revision 1.3
retrieving revision 1.3.64.1
diff -u -p -u -p -r1.3 -r1.3.64.1
--- xmloff/source/transform/NotesTContext.cxx	9 Nov 2004 12:22:38 -0000	1.3
+++ xmloff/source/transform/NotesTContext.cxx	12 Jan 2005 16:40:10 -0000	1.3.64.1
@@ -196,6 +196,7 @@ void XMLNotesTransformerContext::StartEl
 	case XML_NOTES_CONFIGURATION:
 		eToken = (m_bEndNote ? XML_ENDNOTES_CONFIGURATION 
 							 : XML_FOOTNOTES_CONFIGURATION);
+        break;
 	case XML_NOTE_REF:
 		eToken = (m_bEndNote ? XML_ENDNOTE_REF : XML_FOOTNOTE_REF);
 		break;
Index: sw/inc/dbgoutsw.hxx
===================================================================
RCS file: /cvs/sw/sw/inc/dbgoutsw.hxx,v
retrieving revision 1.9
retrieving revision 1.9.14.1
diff -u -p -u -p -r1.9 -r1.9.14.1
--- sw/inc/dbgoutsw.hxx	5 Jan 2005 11:45:44 -0000	1.9
+++ sw/inc/dbgoutsw.hxx	14 Jan 2005 16:26:05 -0000	1.9.14.1
@@ -104,6 +104,7 @@ const char * dbg_out(const SfxPoolItem &
 const char * dbg_out(const SfxPoolItem * pItem);
 const char * dbg_out(const SfxItemSet & rSet);
 const char * dbg_out(SwNodes & rNodes);
+const char * dbg_out(SwOutlineNodes & rNodes);
 const char * dbg_out(const SwPosition & rPos);
 const char * dbg_out(const SwPaM & rPam);
 const char * dbg_out(const SwNodeNum & rNum);
Index: sw/inc/doc.hxx
===================================================================
RCS file: /cvs/sw/sw/inc/doc.hxx,v
retrieving revision 1.98
retrieving revision 1.97.12.3
diff -u -p -u -p -r1.98 -r1.97.12.3
--- sw/inc/doc.hxx	21 Jan 2005 10:27:28 -0000	1.98
+++ sw/inc/doc.hxx	26 Jan 2005 15:21:01 -0000	1.97.12.3
@@ -1602,15 +1602,9 @@ public:
 
 		// setzt, wenn noch keine Numerierung, sonst wird geaendert
 		// arbeitet mit alten und neuen Regeln, nur Differenzen aktualisieren
-    /** #109308# new parameter
-        @param bCalledFromShell
-        - sal_True called from shel
-        - sal_False else
-    */
-	void SetNumRule( const SwPaM&, const SwNumRule&,
-                     sal_Bool bSetAbsLSpace = sal_True,
-                     sal_Bool bCalledFromShell = sal_False );
-		// ab hier neu starten lassen oder den Start wieder aufheben
+    void SetNumRule( const SwPaM&, const SwNumRule&,
+                     sal_Bool bSetAbsLSpace = sal_True );
+        // ab hier neu starten lassen oder den Start wieder aufheben
 
     /**
        Replace numbering rules in a PaM by another numbering rule.
@@ -1620,6 +1614,8 @@ public:
      */
     void ReplaceNumRule(const SwPaM & rPaM, const SwNumRule & rNumRule);
 
+    void MakeUniqueNumRules(const SwPaM & rPaM);
+
 	void SetNumRuleStart( const SwPosition& rPos, sal_Bool bFlag = sal_True );
 	void SetNodeNumStart( const SwPosition& rPos, sal_uInt16 nStt = USHRT_MAX );
 
Index: sw/inc/ndarr.hxx
===================================================================
RCS file: /cvs/sw/sw/inc/ndarr.hxx,v
retrieving revision 1.8
retrieving revision 1.8.214.1
diff -u -p -u -p -r1.8 -r1.8.214.1
--- sw/inc/ndarr.hxx	4 Oct 2004 18:58:57 -0000	1.8
+++ sw/inc/ndarr.hxx	14 Jan 2005 16:27:53 -0000	1.8.214.1
@@ -146,7 +146,7 @@ class SwNodes: private BigPtrArray
 		   *pEndOfAutotext, *pEndOfRedlines,
 		   *pEndOfContent;
 
-	SwOutlineNodes* pOutlineNds;		// Array aller GliederiungsNodes
+	mutable SwOutlineNodes* pOutlineNds;		// Array aller GliederiungsNodes
 
 	BOOL bInNodesDel : 1;				// falls rekursiv aufgerufen wird
 										// Num/Outline nicht aktualisierem
@@ -286,8 +286,9 @@ public:
 							SwGrfFmtColl *pColl,
 							SwAttrSet* pAutoAttr = 0 );	// in ndole.cxx
 
+    void UpdateOutlineNodeList() const;
 		// Array aller GliederiungsNodes;
-	const SwOutlineNodes& GetOutLineNds() const { return *pOutlineNds; }
+	const SwOutlineNodes& GetOutLineNds() const;
 		// ab einem bestimmten TextNode alle Updaten
 	void UpdateOutlineNode( const SwNode&, BYTE nOldLevel, BYTE nNewLevel );
 		// alle Nodes Updaten - Rule/Format-Aenderung
Index: sw/inc/node.hxx
===================================================================
RCS file: /cvs/sw/sw/inc/node.hxx,v
retrieving revision 1.10
retrieving revision 1.10.234.2
diff -u -p -u -p -r1.10 -r1.10.234.2
--- sw/inc/node.hxx	23 Aug 2004 08:37:03 -0000	1.10
+++ sw/inc/node.hxx	9 Feb 2005 17:27:43 -0000	1.10.234.2
@@ -124,6 +124,11 @@ class SW_DLLPUBLIC SwNode : private /* p
 {
 	friend class SwNodes;
 
+#ifndef PRODUCT
+    static long nSerial;
+    long nMySerial;
+#endif
+
 	BYTE nNodeType;
 	BOOL bWrongDirty : 1; 		// Ist das Wrong-Feld auf invalid? (nur TxtNodes)
 	BOOL bACmplWrdDirty : 1;	// die ACompl-Liste muss angepasst werden (erstmal nur TxtNodes)
Index: sw/inc/numrule.hxx
===================================================================
RCS file: /cvs/sw/sw/inc/numrule.hxx,v
retrieving revision 1.21
retrieving revision 1.21.82.2
diff -u -p -u -p -r1.21 -r1.21.82.2
--- sw/inc/numrule.hxx	27 Nov 2004 11:39:41 -0000	1.21
+++ sw/inc/numrule.hxx	9 Feb 2005 17:27:43 -0000	1.21.82.2
@@ -347,6 +347,11 @@ public:
 
 class SW_DLLPUBLIC SwNodeNum
 {
+#ifndef PRODUCT
+    static long nSerial;
+    long nMySerial;
+#endif
+
 	USHORT nLevelVal[ MAXLEVEL ];		// Nummern aller Levels
 	USHORT nSetValue;					// vorgegeben Nummer
 	BYTE nMyLevel;						// akt. Level
Index: sw/inc/swundo.hxx
===================================================================
RCS file: /cvs/sw/sw/inc/swundo.hxx,v
retrieving revision 1.7
retrieving revision 1.7.220.1
diff -u -p -u -p -r1.7 -r1.7.220.1
--- sw/inc/swundo.hxx	8 Sep 2004 14:51:49 -0000	1.7
+++ sw/inc/swundo.hxx	17 Jan 2005 14:20:00 -0000	1.7.220.1
@@ -109,8 +109,10 @@ enum SwUndoStdId
 	UNDO_MERGE_TABLE,                    	// 38
 	UNDO_TRANSLITERATE,                     // 39
 
-	UNDO_REPEAT_DUMMY_4,                    // 40
-	UNDO_REPEAT_DUMMY_5,                    // 41
+    // -> #111827#
+	UNDO_PASTE_CLIPBOARD,                           // 40
+	UNDO_TYPING,                           // 41
+    // <- #111827#
 	UNDO_REPEAT_DUMMY_6,                    // 42
 	UNDO_REPEAT_DUMMY_7,                    // 43
 	UNDO_REPEAT_DUMMY_8,                    // 44
@@ -160,34 +162,30 @@ enum SwUndoStdId
 
 	UNDO_TMPAUTOCORR,                       // 86 #102505#
 	UNDO_TOXCHANGE,                         // 87
-    // -> #111827#
-	UNDO_PASTE_CLIPBOARD,                           // 88
-	UNDO_TYPING,                           // 89
-    // <- #111827#
-	UNDO_CREATE_PAGEDESC,                           // 90
-	UNDO_CHANGE_PAGEDESC,                           // 91
-	UNDO_DELETE_PAGEDESC,                           // 92
-	UNDO_HEADER_FOOTER,                           // 93 #i7983#
-    UNDO_FIELD,                             // 94 #111840#
-    UNDO_TXTFMTCOL_CREATE,                   // 95
-    UNDO_TXTFMTCOL_DELETE,                   // 96
-    UNDO_TXTFMTCOL_RENAME, // 97
-    UNDO_CHARFMT_CREATE, // 98
-    UNDO_CHARFMT_DELETE, // 99
-    UNDO_CHARFMT_RENAME, // 100
-    UNDO_FRMFMT_CREATE, // 101
-    UNDO_FRMFMT_DELETE, // 102
-    UNDO_FRMFMT_RENAME, // 103
-    UNDO_NUMRULE_CREATE,// 104
-    UNDO_NUMRULE_DELETE,// 105
-    UNDO_NUMRULE_RENAME,// 106
-    UNDO_BOOKMARK_RENAME, // 107
-    UNDO_INDEX_ENTRY_INSERT, // 108
-    UNDO_INDEX_ENTRY_DELETE, // 109
-    UNDO_COL_DELETE, // 110
-    UNDO_ROW_DELETE, // 111
-    UNDO_RENAME_PAGEDESC, // 112
-    UNDO_NUMDOWN, // 113
+	UNDO_CREATE_PAGEDESC,                           // 88
+	UNDO_CHANGE_PAGEDESC,                           // 89
+	UNDO_DELETE_PAGEDESC,                           // 90
+	UNDO_HEADER_FOOTER,                           // 91 #i7983#
+    UNDO_FIELD,                             // 92 #111840#
+    UNDO_TXTFMTCOL_CREATE,                   // 93
+    UNDO_TXTFMTCOL_DELETE,                   // 94
+    UNDO_TXTFMTCOL_RENAME, // 95
+    UNDO_CHARFMT_CREATE, // 96
+    UNDO_CHARFMT_DELETE, // 97
+    UNDO_CHARFMT_RENAME, // 98
+    UNDO_FRMFMT_CREATE, // 99
+    UNDO_FRMFMT_DELETE, // 100
+    UNDO_FRMFMT_RENAME, // 101
+    UNDO_NUMRULE_CREATE,// 102
+    UNDO_NUMRULE_DELETE,// 103
+    UNDO_NUMRULE_RENAME,// 104
+    UNDO_BOOKMARK_RENAME, // 105
+    UNDO_INDEX_ENTRY_INSERT, // 106
+    UNDO_INDEX_ENTRY_DELETE, // 107
+    UNDO_COL_DELETE, // 108
+    UNDO_ROW_DELETE, // 109
+    UNDO_RENAME_PAGEDESC, // 110
+    UNDO_NUMDOWN, // 111
 	UNDO_STD_END= UNDO_NUMDOWN
 };
 
Index: sw/source/core/doc/dbgoutsw.cxx
===================================================================
RCS file: /cvs/sw/sw/source/core/doc/dbgoutsw.cxx,v
retrieving revision 1.11
retrieving revision 1.11.14.1
diff -u -p -u -p -r1.11 -r1.11.14.1
--- sw/source/core/doc/dbgoutsw.cxx	5 Jan 2005 11:46:48 -0000	1.11
+++ sw/source/core/doc/dbgoutsw.cxx	14 Jan 2005 16:28:14 -0000	1.11.14.1
@@ -78,6 +78,7 @@
 #include <frmfmt.hxx>
 #include <fmtanchr.hxx>
 #include <swrect.hxx>
+#include <ndarr.hxx>
 #include <dbgoutsw.hxx>
 
 using namespace std;
@@ -714,6 +715,26 @@ const char * dbg_out(SwNodes & rNodes)
     return dbg_out(lcl_dbg_out(rNodes));
 }
 
+static String lcl_dbg_out(SwOutlineNodes & rNodes)
+{
+    String aStr("[\n", RTL_TEXTENCODING_ASCII_US);
+
+    for (ULONG i = 0; i < rNodes.Count(); i++)
+    {
+        aStr += lcl_dbg_out(*rNodes[i]);
+        aStr += String("\n", RTL_TEXTENCODING_ASCII_US);
+    }
+
+    aStr += String("]\n", RTL_TEXTENCODING_ASCII_US);
+
+    return aStr;
+}
+
+const char * dbg_out(SwOutlineNodes & rNodes)
+{
+    return dbg_out(lcl_dbg_out(rNodes));
+}
+
 static String lcl_dbg_out(const SwUndos & rUndos)
 {
     String aStr("[\n", RTL_TEXTENCODING_ASCII_US);
Index: sw/source/core/doc/docdesc.cxx
===================================================================
RCS file: /cvs/sw/sw/source/core/doc/docdesc.cxx,v
retrieving revision 1.24
retrieving revision 1.23.80.2
diff -u -p -u -p -r1.24 -r1.23.80.2
--- sw/source/core/doc/docdesc.cxx	11 Jan 2005 12:18:01 -0000	1.24
+++ sw/source/core/doc/docdesc.cxx	26 Jan 2005 15:23:59 -0000	1.23.80.2
@@ -679,9 +679,9 @@ void SwDoc::BroadcastStyleOperation(Stri
         {
             pPool->SetSearchMask(eFamily, SFXSTYLEBIT_ALL );
             SfxStyleSheetBase * pBase = pPool->Find(rName);
-
-            pPool->Broadcast
-                (SfxStyleSheetHint( nOp, *pBase ));
+            
+            if (pBase != NULL)
+                pPool->Broadcast(SfxStyleSheetHint( nOp, *pBase ));
         }
     }
 }
Index: sw/source/core/doc/docnum.cxx
===================================================================
RCS file: /cvs/sw/sw/source/core/doc/docnum.cxx,v
retrieving revision 1.42
retrieving revision 1.42.68.3
diff -u -p -u -p -r1.42 -r1.42.68.3
--- sw/source/core/doc/docnum.cxx	8 Dec 2004 17:41:03 -0000	1.42
+++ sw/source/core/doc/docnum.cxx	21 Jan 2005 11:46:00 -0000	1.42.68.3
@@ -152,6 +152,10 @@
 #include <frmatr.hxx>
 #endif
 
+#include <map>
+
+using std::map;
+
 inline BYTE GetUpperLvlChg( BYTE nCurLvl, BYTE nLevel, USHORT nMask )
 {
 	if( 1 < nLevel )
@@ -170,7 +174,7 @@ SwNumRule * SwDoc::GetOutlineNumRule() c
     if (pNumRuleTbl)
     {
         for (ULONG nI = 0; nI < pNumRuleTbl->Count(); nI++)
-            if ((*pNumRuleTbl)[nI]->GetName() == 
+            if ((*pNumRuleTbl)[nI]->GetName() ==
                 String(SwNumRule::GetOutlineRuleName(),
                        RTL_TEXTENCODING_ASCII_US))
             {
@@ -184,30 +188,11 @@ SwNumRule * SwDoc::GetOutlineNumRule() c
 void SwDoc::SetOutlineNumRule( const SwNumRule& rRule )
 {
 	USHORT nChkLevel = 0, nChgFmtLevel = 0;
+
 	if( pOutlineRule )
-	{
-		USHORT nMask = 1;
-		for( BYTE n = 0; n < MAXLEVEL; ++n, nMask <<= 1 )
-		{
-			const SwNumFmt& rOld = pOutlineRule->Get( n ),
-						  & rNew = rRule.Get( n );
-			if( rOld != rNew )
-			{
-				nChgFmtLevel |= nMask;
-				if( rOld.GetAbsLSpace() != rNew.GetAbsLSpace() ||
-					rOld.GetFirstLineOffset() != rNew.GetFirstLineOffset() )
-					nChkLevel |= nMask;
-			}
-			else if( SVX_NUM_NUMBER_NONE > rNew.GetNumberingType() && 1 < rNew.GetIncludeUpperLevels() &&
-					0 != (nChgFmtLevel & GetUpperLvlChg( n,
-											rNew.GetIncludeUpperLevels(), nMask )) )
-				nChgFmtLevel |= nMask;
-		}
 		(*pOutlineRule) = rRule;
-	}
 	else
 	{
-		nChgFmtLevel = nChkLevel = 0xffff;
 		pOutlineRule = new SwNumRule( rRule );
 
         AddNumRule(pOutlineRule); // #i36749#
@@ -221,91 +206,8 @@ void SwDoc::SetOutlineNumRule( const SwN
 	// definiert sind
 	pOutlineRule->CheckCharFmts( this );
 
-	// losche aus dem Array alle Nodes, die ohne Outline Nummerierung sind
-	SwOutlineNodes& rArr = (SwOutlineNodes&)GetNodes().GetOutLineNds();
-	{
-		SwNodeNum aNoNum( NO_NUMBERING );
-		for( USHORT n = 0; n < rArr.Count(); ++n )
-		{
-			SwTxtNode* pTxtNd = rArr[n]->GetTxtNode();
-            if (pTxtNd)
-            {
-                if( NO_NUMBERING == pTxtNd->GetTxtColl()->GetOutlineLevel() )
-                {
-                    pTxtNd->UpdateNum( aNoNum );
-                    rArr.Remove( n-- );
-                }
-                else
-                {
-                    SwPaM aPam(*pTxtNd);
-                    SwNumRuleItem aItem(pOutlineRule->GetName());
-
-                    Insert(aPam, aItem);
-                }
-            }
-		}
-	}
-
-	// suche alle Nodes, die neu aufgenommen werden muessen !!
-	// (eigentlich koennte das auch per Modify am die Nodes propagiert
-	// werden !! )
-	ULONG nStt = GetNodes().GetEndOfContent().StartOfSectionIndex();
-	USHORT n;
-
-	for( n = 0; n < pTxtFmtCollTbl->Count(); ++n )
-	{
-		SwTxtFmtColl* pColl = (*pTxtFmtCollTbl)[ n ];
-		BYTE nLevel = pColl->GetOutlineLevel();
-		if( NO_NUMBERING != nLevel )
-		{
-#ifndef NUM_RELSPACE
-			// JP 08.07.98: Einzuege aus der Outline uebernehmen.
-			// 				??Aber nur wenn sie veraendert wurden??
-			if( ( nLevel = GetRealLevel( nLevel )) < MAXLEVEL
-				/*&& 0 != (nChkLevel & (1 << nLevel ))*/ )
-			{
-				SvxLRSpaceItem aLR( (SvxLRSpaceItem&)pColl->GetAttr( RES_LR_SPACE ) );
-				const SwNumFmt& rNFmt = pOutlineRule->Get( nLevel );
-
-				// ohne Nummer immer ohne FirstLineOffset!!!!
-				short nFOfst;
-				if( ! IsNum(pColl->GetOutlineLevel()) )
-					nFOfst = 0;
-				else
-					nFOfst = rNFmt.GetFirstLineOffset();
-
-				if( aLR.GetTxtLeft() != rNFmt.GetAbsLSpace() ||
-					aLR.GetTxtFirstLineOfst() != nFOfst )
-				{
-					aLR.SetTxtFirstLineOfstValue( nFOfst );
-					aLR.SetTxtLeft( rNFmt.GetAbsLSpace() );
-
-					pColl->SetAttr( aLR );
-				}
-			}
-#endif
-			SwClientIter aIter( *pColl );
-			for( SwTxtNode* pNd = (SwTxtNode*)aIter.First( TYPE( SwTxtNode ));
-					pNd; pNd = (SwTxtNode*)aIter.Next() )
-				if( pNd->GetNodes().IsDocNodes() && nStt < pNd->GetIndex() )
-					rArr.Insert( pNd );
-		}
-	}
-
-	for( n = 0; n < rArr.Count(); ++n )
-	{
-		SwTxtNode* pNd = rArr[ n ]->GetTxtNode();
-		ASSERT( pNd, "was ist das fuer ein Node?" );
-		if( ( 1 << (GetRealLevel(pNd->GetTxtColl()->GetOutlineLevel()))
-			& nChgFmtLevel ))
-			pNd->NumRuleChgd();
-	}
-	GetNodes().UpdateOutlineNodes();        // update der Nummern
-
-	// gibt es Fussnoten && gilt Kapitelweises Nummerieren, dann updaten
-	if( GetFtnIdxs().Count() && FTNNUM_CHAPTER == GetFtnInfo().eNum )
-		GetFtnIdxs().UpdateAllFtn();
-
+    PropagateOutlineRule();
+    UpdateNumRule();
 	UpdateExpFlds();
 
 	SetModified();
@@ -325,14 +227,14 @@ void SwDoc::PropagateOutlineRule()
             while (pClient)
             {
                 SwTxtNode * pTxtNode = ((SwTxtNode *) pClient);
-                
+
                 const SwPaM aPam(*pTxtNode);
                 SetNumRule(aPam, *GetOutlineNumRule());
 
                 pTxtNode->SetLevel(pColl->GetOutlineLevel());
 
                 pClient = aIter.Next();
-            }            
+            }
         }
     }
 }
@@ -1001,7 +903,7 @@ void lcl_ChgNumRule( SwDoc& rDoc, const 
 }
 
 void SwDoc::SetNumRule( const SwPaM& rPam, const SwNumRule& rRule,
-						sal_Bool bSetAbsLSpace, sal_Bool bCalledFromShell )
+                        sal_Bool bSetAbsLSpace )
 {
 	SwUndoInsNum* pUndo;
 	if( DoesUndo() )
@@ -1020,63 +922,6 @@ void SwDoc::SetNumRule( const SwPaM& rPa
 	if( !pNew )
     {
 		pNew = (*pNumRuleTbl)[ MakeNumRule( rRule.GetName(), &rRule ) ];
-
-        /* #109308# ATTENTION THIS IS NOW PARTLY WRONG! SEE #111078#.
-
-            If called from a shell propagate an existing
-            adjust item at the beginning am rPam into the new
-            numbering rule. */
-        if (bCalledFromShell)
-        {
-            SwCntntNode * pCntntNode = rPam.GetCntntNode();
-
-            if (pCntntNode)
-            {
-                SwAttrSet & rAttrSet = pCntntNode->GetSwAttrSet();
-
-                /* #111078# Do not propagate the adjustment but set
-                    the adjustment according to the text direction of
-                    the paragraph. */
-
-                SvxFrameDirection aDir = (SvxFrameDirection)
-                    rAttrSet.GetFrmDir().GetValue();
-
-                switch (aDir)
-                {
-                case FRMDIR_HORI_LEFT_TOP:
-                    pNew->SetNumAdjust(SVX_ADJUST_LEFT);
-
-                    break;
-
-                case FRMDIR_HORI_RIGHT_TOP:
-                    pNew->SetNumAdjust(SVX_ADJUST_RIGHT);
-
-                    break;
-
-                case FRMDIR_ENVIRONMENT :
-                    // --> FME 2004-08-06 #i32203# If the direction attribute
-                    // has not been set directly, we have to get it from the
-                    // layout:
-                    {
-                        SwClientIter aClientIter( *pCntntNode );
-                        SwClient* pLast = aClientIter.GoStart();
-                        if ( pLast && pLast->ISA( SwTxtFrm ) )
-                        {
-                            if ( static_cast<const SwTxtFrm*>(pLast)->IsRightToLeft() )
-                                pNew->SetNumAdjust(SVX_ADJUST_RIGHT);
-                            else
-                                pNew->SetNumAdjust(SVX_ADJUST_LEFT);
-                        }
-                    }
-
-                    break;
-
-                default:
-                    break;
-                }
-            }
-        }
-
     }
 	else if( rRule.IsAutoRule() && !(*pNew == rRule) )
 	{
@@ -1500,6 +1345,59 @@ BOOL SwDoc::ReplaceNumRule( const SwPosi
 	return bRet;
 }
 
+
+void SwDoc::MakeUniqueNumRules(const SwPaM & rPaM)
+{
+    map<SwNumRule *, SwNumRule *> aNumRuleMap;
+
+ 	ULONG nStt = rPaM.Start()->nNode.GetIndex();
+	ULONG nEnd = rPaM.End()->nNode.GetIndex();
+
+    bool bFirst = true;
+
+    for (ULONG n = nStt; n <= nEnd; n++)
+    {
+        SwTxtNode * pCNd = GetNodes()[n]->GetTxtNode();
+
+        if (pCNd)
+        {
+            SwNumRule * pRule = pCNd->GetNumRule();
+
+            if (pRule && pRule->IsAutoRule())
+            {
+                SwNumRule * pReplaceNumRule = aNumRuleMap[pRule];
+
+                if (! pReplaceNumRule)
+                {
+                    if (bFirst)
+                    {
+                        SwPosition aPos(*pCNd);
+                        pReplaceNumRule = 
+                            const_cast<SwNumRule *>
+                            (SearchNumRule(aPos, FALSE, pCNd->HasNumber(), 
+                                           FALSE, 0));
+                    }
+                    
+                    if (! pReplaceNumRule)
+                    {
+                        pReplaceNumRule = new SwNumRule(*pRule);
+                        pReplaceNumRule->SetName(GetUniqueNumRuleName());
+                        
+                    }
+                    
+                    aNumRuleMap[pRule] = pReplaceNumRule;
+                }
+
+                SwPaM aPam(*pCNd);
+
+                SetNumRule(aPam, *pReplaceNumRule);
+
+                bFirst = false;
+            }
+        }
+    }
+}
+
 BOOL SwDoc::NoNum( const SwPaM& rPam )
 {
 
@@ -2394,7 +2292,7 @@ SwNumRule* SwDoc::FindNumRulePtr( const 
             if ((*pNumRuleTbl)[n]->GetName() == rName)
             {
                 pResult = (*pNumRuleTbl)[n];
-                
+
                 break;
             }
         }
@@ -2406,7 +2304,7 @@ SwNumRule* SwDoc::FindNumRulePtr( const 
 // #i36749#
 void SwDoc::AddNumRule(SwNumRule * pRule)
 {
-    pNumRuleTbl->Insert(pRule, pNumRuleTbl->Count());    
+    pNumRuleTbl->Insert(pRule, pNumRuleTbl->Count());
     aNumRuleMap[pRule->GetName()] = pRule;
     pRule->SetNumRuleMap(&aNumRuleMap);
 }
@@ -2806,7 +2704,7 @@ void lcl_UpdateNumRuleRange( SwNumRule &
     @param rRule        the SwNumRule we wish to update
     @param rNumRuleInfo contains the list of nodes using rRule to be updated
     @param rNode        SwNode whose section will be updated
-                        Note: the entire section from rNode.FindStartNode() 
+                        Note: the entire section from rNode.FindStartNode()
                         will be updated (see also nUpdatePos)
     @param nUpdatePos   update nodes >= rNumRuleInfo.GetList()[nUpdatePos]
 */
@@ -2831,7 +2729,7 @@ void lcl_UpdateNumRuleSection( SwNumRule
         // restart numbering unless nUpdatePos forces an update into the
         // middle of a section
         BOOL bInit = ( nUpdatePos <= nStartPos );
-        lcl_UpdateNumRuleRange( rRule, rNumRuleInfo, 
+        lcl_UpdateNumRuleRange( rRule, rNumRuleInfo,
                                 nStartPos, nEndPos, bInit );
     }
 }
@@ -2910,17 +2808,17 @@ void SwDoc::UpdateNumRule( SwNumRule & r
     }
 
     /* number each range (frames, redlines, footnotes, etc.) seperately */
-    lcl_UpdateNumRuleSectionOfSections( 
+    lcl_UpdateNumRuleSectionOfSections(
         rRule, aNumRuleInfo, aNodes.GetEndOfPostIts(), nUpdatePos );
-    lcl_UpdateNumRuleSectionOfSections( 
+    lcl_UpdateNumRuleSectionOfSections(
         rRule, aNumRuleInfo, aNodes.GetEndOfInserts(), nUpdatePos );
-    lcl_UpdateNumRuleSectionOfSections( 
+    lcl_UpdateNumRuleSectionOfSections(
         rRule, aNumRuleInfo, aNodes.GetEndOfAutotext(), nUpdatePos );
-    lcl_UpdateNumRuleSectionOfSections( 
+    lcl_UpdateNumRuleSectionOfSections(
         rRule, aNumRuleInfo, aNodes.GetEndOfRedlines(), nUpdatePos );
-    lcl_UpdateNumRuleSectionOfSections( 
+    lcl_UpdateNumRuleSectionOfSections(
         rRule, aNumRuleInfo, aNodes.GetEndOfExtras(), nUpdatePos );
-    lcl_UpdateNumRuleSection( 
+    lcl_UpdateNumRuleSection(
         rRule, aNumRuleInfo, aNodes.GetEndOfContent(), nUpdatePos );
 }
 
@@ -3023,7 +2921,7 @@ void SwDoc::UpdateNumRuleOld( SwNumRule 
 				{
 					aNum.SetStart( TRUE );
                     // OD 10.12.2002 #106111# - correct reset of level numbers
-                    for ( int nSubLvl = GetRealLevel(nLevel); 
+                    for ( int nSubLvl = GetRealLevel(nLevel);
                           nSubLvl < MAXLEVEL; ++nSubLvl)
                         aNum.GetLevelVal()[ nSubLvl ] = 0;
 					if( pRule->IsContinusNum() )
@@ -3093,7 +2991,7 @@ void SwDoc::UpdateNumRuleOld( SwNumRule 
                             if( !(nInitLevels & ( 1 << nPrevLvl )) )
                                 ++nPrevLvl;
 
-                            for( int ii = nPrevLvl; ii < GetRealLevel(nLevel); 
+                            for( int ii = nPrevLvl; ii < GetRealLevel(nLevel);
                                  ++ii )
                             {
                                 nInitLevels &= ~( 1 << ii );
@@ -3106,14 +3004,14 @@ void SwDoc::UpdateNumRuleOld( SwNumRule 
 								: aNum.GetSetValue();
                         }
                         else if( USHRT_MAX != aNum.GetSetValue() )
-                            aNum.GetLevelVal()[ GetRealLevel(nLevel) ] = 
+                            aNum.GetLevelVal()[ GetRealLevel(nLevel) ] =
                                 aNum.GetSetValue();
                         else if( nInitLevels & ( 1 << GetRealLevel(nLevel) ))
                             aNum.GetLevelVal()[ GetRealLevel(nLevel) ] =
                                 pRule->Get( GetRealLevel(nLevel) ).GetStart();
                         else
                         {
-                            const SwNumFmt * pTmpNumFmt = 
+                            const SwNumFmt * pTmpNumFmt =
                                 pRule->GetNumFmt(GetRealLevel(nLevel));
 
                             if (pTmpNumFmt &&
@@ -3128,7 +3026,7 @@ void SwDoc::UpdateNumRuleOld( SwNumRule 
                     // OD 10.12.2002 #106111# - reset numbers of all sublevels and
                     // note in <nInitLevels> that numbering of all sublevels have
                     // to be restarted.
-                    for ( int nSubLvl = GetRealLevel(nLevel)+1; 
+                    for ( int nSubLvl = GetRealLevel(nLevel)+1;
                           nSubLvl < MAXLEVEL; ++nSubLvl)
                     {
                         aNum.GetLevelVal()[ nSubLvl ] = 0;
Index: sw/source/core/doc/number.cxx
===================================================================
RCS file: /cvs/sw/sw/source/core/doc/number.cxx,v
retrieving revision 1.26
retrieving revision 1.26.68.2
diff -u -p -u -p -r1.26 -r1.26.68.2
--- sw/source/core/doc/number.cxx	8 Dec 2004 17:41:17 -0000	1.26
+++ sw/source/core/doc/number.cxx	9 Feb 2005 17:27:44 -0000	1.26.68.2
@@ -231,11 +231,20 @@ USHORT SwNumRule::GetBullIndent( BYTE nL
 	return aDefNumIndents[ nLvl ];
 }
 
+#ifndef PRODUCT
+long SwNodeNum::nSerial = 0;
+#endif
+
 SwNodeNum::SwNodeNum( BYTE nLevel, USHORT nSetVal )
 	: nSetValue( nSetVal ), nMyLevel( nLevel ), bStartNum( FALSE ),
       bContNum(FALSE)
 {
 	memset( nLevelVal, 0, sizeof( nLevelVal ) );
+
+#ifndef PRODUCT
+    nMySerial = nSerial;
+    nSerial++;
+#endif
 }
 
 SwNodeNum& SwNodeNum::operator=( const SwNodeNum& rCpy )
Index: sw/source/core/doc/poolfmt.cxx
===================================================================
RCS file: /cvs/sw/sw/source/core/doc/poolfmt.cxx,v
retrieving revision 1.35
retrieving revision 1.35.22.1
diff -u -p -u -p -r1.35 -r1.35.22.1
--- sw/source/core/doc/poolfmt.cxx	3 Jan 2005 17:18:48 -0000	1.35
+++ sw/source/core/doc/poolfmt.cxx	25 Jan 2005 10:25:24 -0000	1.35.22.1
@@ -1686,7 +1686,12 @@ SwPageDesc* SwDoc::GetPageDescFromPool( 
 	else
 	{
 		BOOL bIsModified = IsModified();
+        
+        BOOL bDoesUndo = DoesUndo();
+        DoUndo(FALSE);
 		n = MakePageDesc( aNm, 0, bRegardLanguage );
+        DoUndo(bDoesUndo);
+
 		pNewPgDsc = aPageDescs[ n ];
 		pNewPgDsc->SetPoolFmtId( nId );
 		if( !bIsModified )
Index: sw/source/core/docnode/ndnum.cxx
===================================================================
RCS file: /cvs/sw/sw/source/core/docnode/ndnum.cxx,v
retrieving revision 1.11
retrieving revision 1.11.82.1
diff -u -p -u -p -r1.11 -r1.11.82.1
--- sw/source/core/docnode/ndnum.cxx	26 Nov 2004 13:25:03 -0000	1.11
+++ sw/source/core/docnode/ndnum.cxx	14 Jan 2005 16:32:50 -0000	1.11.82.1
@@ -80,7 +80,9 @@
 #ifndef _FLDBAS_HXX
 #include <fldbas.hxx>			// UpdateFlds der KapitelNummerierung
 #endif
-
+#ifndef _DOCARY_HXX
+#include <docary.hxx>
+#endif
 
 _SV_IMPL_SORTAR_ALG( SwOutlineNodes, SwNodePtr )
 BOOL SwOutlineNodes::Seek_Entry( const SwNodePtr rSrch, USHORT* pFndPos ) const
@@ -223,3 +225,35 @@ void SwNodes::UpdateOutlineNodes()
 	if( pOutlineNds->Count() )		// OutlineNodes vorhanden ?
 		UpdateOutlineNode( *(*pOutlineNds)[ 0 ], 0, 0 );
 }
+
+void SwNodes::UpdateOutlineNodeList() const
+{
+    if (pOutlineNds->Count() > 0)
+        pOutlineNds->Remove((*pOutlineNds)[0], pOutlineNds->Count());
+
+    const SwNumRuleTbl & rNumRuleTbl = GetDoc()->GetNumRuleTbl();
+
+    for (int i = 0; i < rNumRuleTbl.Count(); i++)
+    {
+        SwNumRule * pRule = rNumRuleTbl[i];
+
+        if (pRule->IsOutlineRule())
+        {
+            SwNumRuleInfo aInfo(pRule->GetName());
+
+            aInfo.MakeList(*const_cast<SwDoc *>(GetDoc()));
+
+            for (int j = 0; j < aInfo.GetList().Count(); j++)
+            {
+                pOutlineNds->Insert(aInfo.GetList().GetObject(j));
+            }
+        }
+    }
+}
+
+const SwOutlineNodes & SwNodes::GetOutLineNds() const
+{
+    UpdateOutlineNodeList();
+
+    return *pOutlineNds;
+}
Index: sw/source/core/docnode/node.cxx
===================================================================
RCS file: /cvs/sw/sw/source/core/docnode/node.cxx,v
retrieving revision 1.18
retrieving revision 1.18.236.2
diff -u -p -u -p -r1.18 -r1.18.236.2
--- sw/source/core/docnode/node.cxx	12 Aug 2004 12:20:46 -0000	1.18
+++ sw/source/core/docnode/node.cxx	9 Feb 2005 17:27:44 -0000	1.18.236.2
@@ -264,6 +264,9 @@ USHORT SwNode::GetSectionLevel() const
 |*
 *******************************************************************/
 
+#ifndef PRODUCT
+long SwNode::nSerial = 0;
+#endif
 
 SwNode::SwNode( const SwNodeIndex &rWhere, const BYTE nNdType )
 	: pStartOfSection( 0 ), nNodeType( nNdType )
@@ -293,6 +296,11 @@ SwNode::SwNode( const SwNodeIndex &rWher
 		rNodes.Insert( pInsNd, rWhere );
 		pStartOfSection = (SwStartNode*)this;
 	}
+
+#ifndef PRODUCT
+    nMySerial = nSerial;
+    nSerial++;
+#endif
 }
 
 SwNode::SwNode( SwNodes& rNodes, ULONG nPos, const BYTE nNdType )
@@ -322,6 +330,11 @@ SwNode::SwNode( SwNodes& rNodes, ULONG n
 		rNodes.Insert( pInsNd, nPos );
 		pStartOfSection = (SwStartNode*)this;
 	}
+
+#ifndef PRODUCT
+    nMySerial = nSerial;
+    nSerial++;
+#endif
 }
 
 SwNode::~SwNode()
Index: sw/source/core/edit/eddel.cxx
===================================================================
RCS file: /cvs/sw/sw/source/core/edit/eddel.cxx,v
retrieving revision 1.7
retrieving revision 1.7.110.1
diff -u -p -u -p -r1.7 -r1.7.110.1
--- sw/source/core/edit/eddel.cxx	9 Nov 2004 13:45:20 -0000	1.7
+++ sw/source/core/edit/eddel.cxx	17 Jan 2005 11:27:36 -0000	1.7.110.1
@@ -271,6 +271,9 @@ long SwEditShell::Copy( SwEditShell* pDe
 		if( !GetDoc()->Copy( *PCURCRSR, *pPos ))
 			continue;
 
+        SwPaM aInsertPaM(*pPos, aSttNdIdx);
+        GetDoc()->MakeUniqueNumRules(aInsertPaM);
+
 		bRet = TRUE;
 	FOREACHPAM_END()
 
Index: sw/source/core/edit/ednumber.cxx
===================================================================
RCS file: /cvs/sw/sw/source/core/edit/ednumber.cxx,v
retrieving revision 1.11
retrieving revision 1.11.236.1
diff -u -p -u -p -r1.11 -r1.11.236.1
--- sw/source/core/edit/ednumber.cxx	12 Aug 2004 12:23:18 -0000	1.11
+++ sw/source/core/edit/ednumber.cxx	21 Jan 2005 11:46:03 -0000	1.11.236.1
@@ -231,9 +231,9 @@ BOOL SwEditShell::HasNumber() const
 {
     BOOL bResult = FALSE;
 
-    const SwTxtNode * pTxtNd = 
+    const SwTxtNode * pTxtNd =
         GetCrsr()->GetPoint()->nNode.GetNode().GetTxtNode();
-    
+
     if (pTxtNd)
     {
         bResult = pTxtNd->HasNumber();
@@ -246,9 +246,9 @@ BOOL SwEditShell::HasBullet() const
 {
     BOOL bResult = FALSE;
 
-    const SwTxtNode * pTxtNd = 
+    const SwTxtNode * pTxtNd =
         GetCrsr()->GetPoint()->nNode.GetNode().GetTxtNode();
-    
+
     if (pTxtNd)
     {
         bResult = pTxtNd->HasBullet();
@@ -318,7 +318,7 @@ BOOL SwEditShell::IsFirstOfNumRule() con
     if (pCrsr->GetNext() == pCrsr)
     {
         bResult = IsFirstOfNumRule(*pCrsr);
-    }    
+    }
 
     return bResult;
 }
@@ -353,7 +353,7 @@ void SwEditShell::NumIndent(short nInden
     StartAllAction();
 
     SwNumRule *pCurNumRule = GetDoc()->GetCurrNumRule(rPos);
-    
+
     if (pCurNumRule)
     {
         SwPaM aPaM(rPos);
@@ -361,14 +361,14 @@ void SwEditShell::NumIndent(short nInden
 
         int nLevel = -1;
         int nReferenceLevel = pTxtNode->GetNum()->GetLevel();
-        
+
         if (! IsFirstOfNumRule(aPaM) && pTxtNode->GetNum())
             nLevel = nReferenceLevel;
-                
+
         SwNumRule aRule(*pCurNumRule);
         aRule.Indent(nIndent, nLevel, nReferenceLevel, FALSE);
-        
-        GetDoc()->SetNumRule(aPaM, aRule, sal_False, sal_True);
+
+        GetDoc()->SetNumRule(aPaM, aRule, sal_False );
     }
 
     EndAllAction();
@@ -586,7 +586,7 @@ BOOL SwEditShell::IsProtectedOutlinePara
 	return bRet;
 }
 
-/** Test whether outline may be moved (bCopy == false) 
+/** Test whether outline may be moved (bCopy == false)
  *                           or copied (bCopy == true)
  * Verify these conditions:
  * 1) outline must be within main body (and not in redline)
@@ -750,13 +750,13 @@ void SwEditShell::SetCurNumRule( const S
 		SwPaM aPam( *pCrsr->GetPoint() );
 		for( USHORT n = 0; n < aRangeArr.Count(); ++n )
             /* #109308# adapt to new signature of SetNumRule */
-			GetDoc()->SetNumRule( aRangeArr.SetPam( n, aPam ), rRule, 
-                                  sal_False, sal_True );
+			GetDoc()->SetNumRule( aRangeArr.SetPam( n, aPam ), rRule,
+                                  sal_False );
 		GetDoc()->EndUndo( UNDO_END );
 	}
 	else
         /* #109308# adapt to new signature of SetNumRule */
-		GetDoc()->SetNumRule( *pCrsr, rRule, sal_False, sal_True );
+        GetDoc()->SetNumRule( *pCrsr, rRule, sal_False );
 
 	EndAllAction();
 }
Index: sw/source/core/frmedt/fecopy.cxx
===================================================================
RCS file: /cvs/sw/sw/source/core/frmedt/fecopy.cxx,v
retrieving revision 1.29
retrieving revision 1.29.116.2
diff -u -p -u -p -r1.29 -r1.29.116.2
--- sw/source/core/frmedt/fecopy.cxx	3 Nov 2004 09:51:59 -0000	1.29
+++ sw/source/core/frmedt/fecopy.cxx	14 Feb 2005 14:14:23 -0000	1.29.116.2
@@ -1094,7 +1094,21 @@ BOOL SwFEShell::Paste( SwDoc* pClpDoc, B
             //find out if the clipboard document starts with a table
             bool bStartWithTable = 0 != aCpyPam.Start()->nNode.GetNode().FindTableNode();
             SwPosition aInsertPosition( rInsPos );
-            pClpDoc->Copy( aCpyPam, rInsPos );
+            
+            {
+                SwNodeIndex aIndexBefore(rInsPos.nNode);
+                aIndexBefore--;
+                
+                pClpDoc->Copy( aCpyPam, rInsPos );
+                
+                {
+                    aIndexBefore++;
+                    SwPaM aPaM(SwPosition(aIndexBefore, 0), rInsPos);
+                    
+                    GetDoc()->MakeUniqueNumRules(aPaM);
+                }
+            }
+
 			SaveTblBoxCntnt( &rInsPos );
             if(bIncludingPageFrames && bStartWithTable)
             {
Index: sw/source/core/txtnode/ndtxt.cxx
===================================================================
RCS file: /cvs/sw/sw/source/core/txtnode/ndtxt.cxx,v
retrieving revision 1.43
retrieving revision 1.43.14.1
diff -u -p -u -p -r1.43 -r1.43.14.1
--- sw/source/core/txtnode/ndtxt.cxx	5 Jan 2005 11:47:24 -0000	1.43
+++ sw/source/core/txtnode/ndtxt.cxx	13 Jan 2005 16:16:26 -0000	1.43.14.1
@@ -2519,7 +2519,9 @@ BOOL SwTxtNode::HasNumber() const
         {
             SwNumFmt aFmt(pRule->Get(pNum->GetRealLevel()));
 
-            bResult = aFmt.IsEnumeration();
+            // #i40041#
+            bResult = aFmt.IsEnumeration() && 
+                SVX_NUM_NUMBER_NONE != aFmt.GetNumberingType();
         }
     }
 
Index: sw/source/core/undo/docundo.cxx
===================================================================
RCS file: /cvs/sw/sw/source/core/undo/docundo.cxx,v
retrieving revision 1.14
retrieving revision 1.14.14.3
diff -u -p -u -p -r1.14 -r1.14.14.3
--- sw/source/core/undo/docundo.cxx	5 Jan 2005 16:09:05 -0000	1.14
+++ sw/source/core/undo/docundo.cxx	28 Jan 2005 17:03:00 -0000	1.14.14.3
@@ -598,15 +598,6 @@ String SwDoc::GetUndoIdsStr( String* pSt
     }
     else
         GetUndoIds( &aTmpStr, pUndoIds);        
-
-	// --> FME 2004-08-11 #i30716# Correct initializazion for nId
-    const USHORT nId = 0 < nUndoPos ?
-                       (*pUndos)[ nUndoPos - 1 ]->GetId() :
-                       UNDO_END;
-    // <--					   
-
-    if (nId <= UNDO_END)
-        return String();
     
     return aTmpStr;
 }
@@ -1011,8 +1002,20 @@ BOOL SwDoc::Repeat( SwUndoIter& rUndoIte
 	BOOL bOneUndo = nSize + 1 == nUndoPos;
 
 	SwPaM* pTmpCrsr = rUndoIter.pAktPam;
+    USHORT nId = 0;
+
 	if( pTmpCrsr != pTmpCrsr->GetNext() || !bOneUndo )	// Undo-Klammerung aufbauen
-		StartUndo( 0 );
+    {
+        if (pUndo->GetId() == UNDO_END)
+        {
+            SwUndoStart * pStartUndo = 
+                (SwUndoStart *) (*pUndos)[nSize];
+
+            nId = pStartUndo->GetUserId();
+        }
+
+		StartUndo( nId );
+    }
 	do {		// dann durchlaufe mal den gesamten Ring
 		for( USHORT nRptCnt = nRepeatCnt; nRptCnt > 0; --nRptCnt )
 		{
@@ -1023,7 +1026,7 @@ BOOL SwDoc::Repeat( SwUndoIter& rUndoIte
 	} while( pTmpCrsr !=
 		( rUndoIter.pAktPam = (SwPaM*)rUndoIter.pAktPam->GetNext() ));
 	if( pTmpCrsr != pTmpCrsr->GetNext() || !bOneUndo )
-		EndUndo( 0 );
+		EndUndo( nId );
 
 	return TRUE;
 }
Index: sw/source/core/undo/undo.hrc
===================================================================
RCS file: /cvs/sw/sw/source/core/undo/undo.hrc,v
retrieving revision 1.3
retrieving revision 1.3.220.1
diff -u -p -u -p -r1.3 -r1.3.220.1
--- sw/source/core/undo/undo.hrc	8 Sep 2004 14:59:21 -0000	1.3
+++ sw/source/core/undo/undo.hrc	17 Jan 2005 14:25:57 -0000	1.3.220.1
@@ -104,9 +104,9 @@
 #define STR_AUTOCORRECT			(UNDO_BASE      +37)
 #define STR_MERGE_TABLE			(UNDO_BASE      +38)
 #define STR_TRANSLITERATE		(UNDO_BASE      +39)
+#define STR_PASTE_CLIPBOARD_UNDO    (UNDO_BASE      +40)
+#define STR_TYPING_UNDO 		    (UNDO_BASE      +41)
 
-#define STR_REPEAT_DUMMY_4		(UNDO_BASE      +40)
-#define STR_REPEAT_DUMMY_5		(UNDO_BASE      +41)
 #define STR_REPEAT_DUMMY_6		(UNDO_BASE      +42)
 #define STR_REPEAT_DUMMY_7		(UNDO_BASE      +43)
 #define STR_REPEAT_DUMMY_8		(UNDO_BASE      +44)
@@ -160,32 +160,30 @@
 #define STR_UNDO_TMPAUTOCORR 		(CORE_REPEAT_END      +41) 
 
 #define STR_TOXCHANGE		        (CORE_REPEAT_END      +42)
-#define STR_PASTE_CLIPBOARD_UNDO    (CORE_REPEAT_END      +43)
-#define STR_TYPING_UNDO 		    (CORE_REPEAT_END      +44)
-#define STR_UNDO_PAGEDESC_CREATE    (CORE_REPEAT_END      +45)
-#define STR_UNDO_PAGEDESC    	    (CORE_REPEAT_END      +46)
-#define STR_UNDO_PAGEDESC_DELETE	(CORE_REPEAT_END      +47)
-#define STR_UNDO_HEADER_FOOTER		(CORE_REPEAT_END      +48) // #i7983# 
-#define STR_UNDO_FIELD      		(CORE_REPEAT_END      +49) // #111840# 
-#define STR_UNDO_TXTFMTCOL_CREATE      		(CORE_REPEAT_END      +50)
-#define STR_UNDO_TXTFMTCOL_DELETE      		(CORE_REPEAT_END      +51)
-#define STR_UNDO_TXTFMTCOL_RENAME      		(CORE_REPEAT_END      +52)
-#define STR_UNDO_CHARFMT_CREATE      		(CORE_REPEAT_END      +53)
-#define STR_UNDO_CHARFMT_DELETE      		(CORE_REPEAT_END      +54)
-#define STR_UNDO_CHARFMT_RENAME      		(CORE_REPEAT_END      +55)
-#define STR_UNDO_FRMFMT_CREATE      		(CORE_REPEAT_END      +56)
-#define STR_UNDO_FRMFMT_DELETE      		(CORE_REPEAT_END      +57)
-#define STR_UNDO_FRMFMT_RENAME      		(CORE_REPEAT_END      +58)
-#define STR_UNDO_NUMRULE_CREATE      		(CORE_REPEAT_END      +59)
-#define STR_UNDO_NUMRULE_DELETE      		(CORE_REPEAT_END      +60)
-#define STR_UNDO_NUMRULE_RENAME      		(CORE_REPEAT_END      +61)
-#define STR_UNDO_BOOKMARK_RENAME      		(CORE_REPEAT_END      +62)
-#define STR_UNDO_INDEX_ENTRY_INSERT         (CORE_REPEAT_END      +63)
-#define STR_UNDO_INDEX_ENTRY_DELETE         (CORE_REPEAT_END      +64)
-#define STR_UNDO_COL_DELETE                 (CORE_REPEAT_END      +65)
-#define STR_UNDO_ROW_DELETE                 (CORE_REPEAT_END      +66)
-#define STR_UNDO_PAGEDESC_RENAME            (CORE_REPEAT_END      +67)
-#define STR_NUMDOWN                         (CORE_REPEAT_END      +68)
+#define STR_UNDO_PAGEDESC_CREATE    (CORE_REPEAT_END      +43)
+#define STR_UNDO_PAGEDESC    	    (CORE_REPEAT_END      +44)
+#define STR_UNDO_PAGEDESC_DELETE	(CORE_REPEAT_END      +45)
+#define STR_UNDO_HEADER_FOOTER		(CORE_REPEAT_END      +46) // #i7983# 
+#define STR_UNDO_FIELD      		(CORE_REPEAT_END      +47) // #111840# 
+#define STR_UNDO_TXTFMTCOL_CREATE      		(CORE_REPEAT_END      +48)
+#define STR_UNDO_TXTFMTCOL_DELETE      		(CORE_REPEAT_END      +49)
+#define STR_UNDO_TXTFMTCOL_RENAME      		(CORE_REPEAT_END      +50)
+#define STR_UNDO_CHARFMT_CREATE      		(CORE_REPEAT_END      +51)
+#define STR_UNDO_CHARFMT_DELETE      		(CORE_REPEAT_END      +52)
+#define STR_UNDO_CHARFMT_RENAME      		(CORE_REPEAT_END      +53)
+#define STR_UNDO_FRMFMT_CREATE      		(CORE_REPEAT_END      +54)
+#define STR_UNDO_FRMFMT_DELETE      		(CORE_REPEAT_END      +55)
+#define STR_UNDO_FRMFMT_RENAME      		(CORE_REPEAT_END      +56)
+#define STR_UNDO_NUMRULE_CREATE      		(CORE_REPEAT_END      +57)
+#define STR_UNDO_NUMRULE_DELETE      		(CORE_REPEAT_END      +58)
+#define STR_UNDO_NUMRULE_RENAME      		(CORE_REPEAT_END      +59)
+#define STR_UNDO_BOOKMARK_RENAME      		(CORE_REPEAT_END      +60)
+#define STR_UNDO_INDEX_ENTRY_INSERT         (CORE_REPEAT_END      +61)
+#define STR_UNDO_INDEX_ENTRY_DELETE         (CORE_REPEAT_END      +62)
+#define STR_UNDO_COL_DELETE                 (CORE_REPEAT_END      +63)
+#define STR_UNDO_ROW_DELETE                 (CORE_REPEAT_END      +64)
+#define STR_UNDO_PAGEDESC_RENAME            (CORE_REPEAT_END      +65)
+#define STR_NUMDOWN                         (CORE_REPEAT_END      +66)
 
 // !!!!!! umsetzen !!!!!!!!!!! umsetzen !!!!!!!!!!! umsetzen !!!!
 #define CORE_UNDO_END           STR_NUMDOWN// !!!! umsetzen !!!
Index: sw/source/core/undo/unnum.cxx
===================================================================
RCS file: /cvs/sw/sw/source/core/undo/unnum.cxx,v
retrieving revision 1.6
retrieving revision 1.6.220.1
diff -u -p -u -p -r1.6 -r1.6.220.1
--- sw/source/core/undo/unnum.cxx	8 Sep 2004 15:00:34 -0000	1.6
+++ sw/source/core/undo/unnum.cxx	14 Jan 2005 08:55:38 -0000	1.6.220.1
@@ -410,24 +410,38 @@ SwUndoNumOrNoNum::SwUndoNumOrNoNum( cons
 {
 }
 
-// #115901#
+// #115901#, #i40034#
 void SwUndoNumOrNoNum::Undo( SwUndoIter& rUndoIter )
 {
 	SwNodeIndex aIdx( rUndoIter.GetDoc().GetNodes(), nIdx );
     SwTxtNode * pTxtNd = aIdx.GetNode().GetTxtNode();
 
     if (NULL != pTxtNd)
+    {
         pTxtNd->UpdateNum(mOldNum);
+        
+        SwNumRule * pRule = pTxtNd->GetNumRule();
+        
+        if (pRule != NULL)
+            pRule->SetInvalidRule(TRUE);
+    }
 }
 
-// #115901#
+// #115901#, #i40034#
 void SwUndoNumOrNoNum::Redo( SwUndoIter& rUndoIter )
 {
 	SwNodeIndex aIdx( rUndoIter.GetDoc().GetNodes(), nIdx );
     SwTxtNode * pTxtNd = aIdx.GetNode().GetTxtNode();
 
     if (NULL != pTxtNd)
+    {
         pTxtNd->UpdateNum(mNewNum);
+        
+        SwNumRule * pRule = pTxtNd->GetNumRule();
+        
+        if (pRule != NULL)
+            pRule->SetInvalidRule(TRUE);
+    }
 }
 
 // #115901#
Index: sw/source/filter/ww8/ww8par3.cxx
===================================================================
RCS file: /cvs/sw/sw/source/filter/ww8/ww8par3.cxx,v
retrieving revision 1.64
retrieving revision 1.64.82.1
diff -u -p -u -p -r1.64 -r1.64.82.1
--- sw/source/filter/ww8/ww8par3.cxx	26 Nov 2004 13:29:23 -0000	1.64
+++ sw/source/filter/ww8/ww8par3.cxx	20 Jan 2005 16:20:56 -0000	1.64.82.1
@@ -1727,8 +1727,13 @@ void SwWW8ImplReader::RegisterNumFmtOnTx
                             SwNumRuleItem(pRule->GetName()));
                     }
                 }
-                pTxtNd->UpdateNum(aNum);
+
             }
+            
+            if (pTxtNd->IsOutline() && pTxtNd->Len() == 0)
+                aNum.SetNoNum(TRUE);
+            
+            pTxtNd->UpdateNum(aNum);
 
             SfxItemSet aListIndent(rDoc.GetAttrPool(), RES_LR_SPACE,
                     RES_LR_SPACE);
@@ -1869,8 +1874,9 @@ void SwWW8ImplReader::Read_LFOPosition(s
                 {
                     pTxtNode->SwCntntNode::SetAttr(
                         *GetDfltAttr(RES_PARATR_NUMRULE));
-                    pTxtNode->UpdateNum(SwNodeNum(NO_NUMBERING));
+                    pTxtNode->UpdateNum(SwNodeNum(NO_NUMLEVEL));
                 }
+
                 /*
                 #i24553#
                 Hmm, I can't remove outline numbering on a per txtnode basis,
@@ -1888,10 +1894,10 @@ void SwWW8ImplReader::Read_LFOPosition(s
                     {
                         pTxtNode->SwCntntNode::SetAttr(
                             SwNumRuleItem(mpChosenOutlineNumRule->GetName()));
-                        pTxtNode->UpdateNum(SwNodeNum());
+                        pTxtNode->UpdateNum(SwNodeNum(NO_NUMLEVEL));
                     }
                     else
-                        pTxtNode->UpdateNum(SwNodeNum());
+                        pTxtNode->UpdateNum(SwNodeNum(NO_NUMLEVEL));
                 }
 
                 //#94672#
Index: sw/source/ui/shells/txtnum.cxx
===================================================================
RCS file: /cvs/sw/sw/source/ui/shells/txtnum.cxx,v
retrieving revision 1.9
retrieving revision 1.9.340.1
diff -u -p -u -p -r1.9 -r1.9.340.1
--- sw/source/ui/shells/txtnum.cxx	11 Jun 2004 15:23:37 -0000	1.9
+++ sw/source/ui/shells/txtnum.cxx	21 Jan 2005 11:46:06 -0000	1.9.340.1
@@ -89,9 +89,9 @@
 #include "textsh.hxx"
 #include "uiitems.hxx"
 //CHINA001 #include "num.hxx"
-#include "swabstdlg.hxx" //CHINA001 
-#include <globals.hrc> //CHINA001 
-#include <sfx2/tabdlg.hxx> //CHINA001 
+#include "swabstdlg.hxx" //CHINA001
+#include <globals.hrc> //CHINA001
+#include <sfx2/tabdlg.hxx> //CHINA001
 
 void SwTextShell::ExecEnterNum(SfxRequest &rReq)
 {
@@ -181,15 +181,27 @@ void SwTextShell::ExecEnterNum(SfxReques
 		{
 			SwNumRule aRule( GetShell().GetUniqueNumRuleName() );
 			SvxNumRule aSvxRule = aRule.MakeSvxNumRule();
-			if(bHtml)
+            const bool bRightToLeft = GetShell().IsInRightToLeftText( 0 );
+
+            if( bHtml || bRightToLeft )
 			{
-				for( BYTE n = 1; n < MAXLEVEL; ++n )
+                for( BYTE n = 0; n < MAXLEVEL; ++n )
 				{
 					SvxNumberFormat aFmt( aSvxRule.GetLevel( n ) );
-					// 1/2" fuer HTML
-					aFmt.SetLSpace(720);
-					aFmt.SetAbsLSpace(n * 720);
-					aSvxRule.SetLevel( n, aFmt, FALSE );
+                    if ( n && bHtml )
+                    {
+                        // 1/2" fuer HTML
+                        aFmt.SetLSpace(720);
+                        aFmt.SetAbsLSpace(n * 720);
+                    }
+                    // --> FME 2005-01-21 #i38904#  Default alignment for
+                    // numbering/bullet should be rtl in rtl paragraph:
+                    if ( bRightToLeft )
+                    {
+                        aFmt.SetNumAdjust( SVX_ADJUST_RIGHT );
+                    }
+                    // <--
+                    aSvxRule.SetLevel( n, aFmt, FALSE );
 				}
 				aSvxRule.SetFeatureFlag(NUM_ENABLE_EMBEDDED_BMP, FALSE);
 			}
Index: sw/source/ui/wrtsh/wrtsh1.cxx
===================================================================
RCS file: /cvs/sw/sw/source/ui/wrtsh/wrtsh1.cxx,v
retrieving revision 1.42
retrieving revision 1.40.82.4
diff -u -p -u -p -r1.42 -r1.40.82.4
--- sw/source/ui/wrtsh/wrtsh1.cxx	21 Jan 2005 16:43:27 -0000	1.42
+++ sw/source/ui/wrtsh/wrtsh1.cxx	28 Jan 2005 12:33:57 -0000	1.40.82.4
@@ -240,6 +240,11 @@
 #ifndef _SFXREQUEST_HXX //autogen
 #include <sfx2/request.hxx>
 #endif
+
+#ifndef _PARATR_HXX
+#include <paratr.hxx>
+#endif
+
 #include <ndtxt.hxx>
 #include <svx/acorrcfg.hxx>
 
@@ -1132,76 +1137,34 @@ void SwWrtShell::SplitNode( BOOL bAutoFm
 // zum Testen der CharFormate an der Numerierung
 // extern void SetNumChrFmt( SwWrtShell*, SwNumRules& );
 
-// -> #i29560#
+// -> #i40041#
 void SwWrtShell::NumOrBulletOn(BOOL bNum)
 {
     const SwNumRule* pCurRule = GetCurNumRule();
 
     StartUndo(UNDO_NUMORNONUM);
 
-    if( !pCurRule || !pCurRule->IsOutlineRule())
-    {
-        const SwNumRule * pNumRule =
-            GetDoc()->SearchNumRule(*GetCrsr()->GetPoint(), FALSE, bNum, FALSE,
-                                    0);
-
-        if (pNumRule)
-            SetCurNumRule(*pNumRule);
-        else
-        {
-            SwNumRule aNumRule(GetUniqueNumRuleName());
-            // Zeichenvorlage an die Numerierung haengen
-            SwCharFmt* pChrFmt;
-            SwDocShell* pDocSh = GetView().GetDocShell();
-            const Font* pFnt = &SwNumRule::GetDefBulletFont();
-
-            if (bNum)
-            {
-                pChrFmt = GetCharFmtFromPool( RES_POOLCHR_NUM_LEVEL );
-            }
-            else
-            {
-                pChrFmt = GetCharFmtFromPool( RES_POOLCHR_BUL_LEVEL );
-            }
+    const SwNumRule * pNumRule = pCurRule;
 
-            SwTxtNode * pTxtNode =
-                GetCrsr()->GetPoint()->nNode.GetNode().GetTxtNode();
-            USHORT nWidthOfTabs = pTxtNode->GetWidthOfLeadingTabs();
-            GetDoc()->RemoveLeadingWhiteSpace( *GetCrsr()->GetPoint() );
+    SwTxtFmtColl * pColl = GetCurTxtFmtColl();
+    SwNumRule * pCollRule = NULL;
 
-            BOOL bHtml = 0 != PTR_CAST(SwWebDocShell, pDocSh);
-            for( BYTE nLvl = 0; nLvl < MAXLEVEL; ++nLvl )
-            {
-                SwNumFmt aFmt( aNumRule.Get( nLvl ) );
-                aFmt.SetCharFmt( pChrFmt );
+    if (pColl)
+    {
+        pCollRule = pDoc->FindNumRulePtr(pColl->GetNumRule().GetValue());
+        pNumRule = pCollRule;
 
-                if (! bNum)
-                {
-                    aFmt.SetBulletFont( pFnt );
-                    aFmt.SetBulletChar( cBulletChar );
-                    aFmt.SetNumberingType(SVX_NUM_CHAR_SPECIAL);
-                }
+        if (pNumRule == NULL && NO_NUMBERING != pColl->GetOutlineLevel())
+            pNumRule = GetDoc()->GetOutlineNumRule();
+    }
 
-                if(bHtml && nLvl)
-                {
-                    // 1/2" fuer HTML
-                    aFmt.SetLSpace(720);
-                    aFmt.SetAbsLSpace(nLvl * 720);
-                }
-                else if ( nWidthOfTabs > 0 )
-                {
-                    aFmt.SetAbsLSpace(nWidthOfTabs + nLvl * 720);
-                }
+    if (!pNumRule )
+        pNumRule = GetDoc()->SearchNumRule(*GetCrsr()->GetPoint(),
+                                           FALSE, bNum, FALSE, 0);
 
-                aNumRule.Set( nLvl, aFmt );
-            }
-            SetCurNumRule( aNumRule );
-        }
-    }
-    else if (pCurRule && pCurRule->IsOutlineRule())
+    if (pNumRule)
     {
-        SwNumRule aNumRule(*pCurRule);
-
+        SwNumRule aNumRule(*pNumRule);
         SwTxtNode * pTxtNode =
             GetCrsr()->GetPoint()->nNode.GetNode().GetTxtNode();
 
@@ -1223,14 +1186,75 @@ void SwWrtShell::NumOrBulletOn(BOOL bNum
                     aFmt.SetNumberingType(SVX_NUM_CHAR_SPECIAL);
                 }
                 aNumRule.Set(pNum->GetRealLevel(), aFmt);
+            }
+        }
+
+        SetCurNumRule(aNumRule);
+    }
+    else
+    {
+        SwNumRule aNumRule(GetUniqueNumRuleName());
+        // Zeichenvorlage an die Numerierung haengen
+        SwCharFmt* pChrFmt;
+        SwDocShell* pDocSh = GetView().GetDocShell();
+        const Font* pFnt = &SwNumRule::GetDefBulletFont();
+
+        if (bNum)
+        {
+            pChrFmt = GetCharFmtFromPool( RES_POOLCHR_NUM_LEVEL );
+        }
+        else
+        {
+            pChrFmt = GetCharFmtFromPool( RES_POOLCHR_BUL_LEVEL );
+        }
 
-                SetCurNumRule(aNumRule);
+        SwTxtNode * pTxtNode =
+            GetCrsr()->GetPoint()->nNode.GetNode().GetTxtNode();
+        USHORT nWidthOfTabs = pTxtNode->GetWidthOfLeadingTabs();
+        GetDoc()->RemoveLeadingWhiteSpace( *GetCrsr()->GetPoint() );
+        
+        const bool bHtml = 0 != PTR_CAST(SwWebDocShell, pDocSh);
+        const bool bRightToLeft = IsInRightToLeftText();
+        for( BYTE nLvl = 0; nLvl < MAXLEVEL; ++nLvl )
+        {
+            SwNumFmt aFmt( aNumRule.Get( nLvl ) );
+            aFmt.SetCharFmt( pChrFmt );
+
+            if (! bNum)
+            {
+                aFmt.SetBulletFont( pFnt );
+                aFmt.SetBulletChar( cBulletChar );
+                aFmt.SetNumberingType(SVX_NUM_CHAR_SPECIAL);
             }
+
+            if(bHtml && nLvl)
+            {
+                // 1/2" fuer HTML
+                aFmt.SetLSpace(720);
+                aFmt.SetAbsLSpace(nLvl * 720);
+            }
+            else if ( nWidthOfTabs > 0 )
+            {
+                aFmt.SetAbsLSpace(nWidthOfTabs + nLvl * 720);
+            }
+
+            // --> FME 2005-01-21 #i38904#  Default alignment for
+            // numbering/bullet should be rtl in rtl paragraph:
+            if ( bRightToLeft )
+            {
+                aFmt.SetNumAdjust( SVX_ADJUST_RIGHT );
+            }
+            // <--
+
+            aNumRule.Set( nLvl, aFmt );
         }
+
+        SetCurNumRule( aNumRule );
     }
 
     EndUndo(UNDO_NUMORNONUM);
 }
+// <- #i40041#
 
 void SwWrtShell::NumOn()
 {
