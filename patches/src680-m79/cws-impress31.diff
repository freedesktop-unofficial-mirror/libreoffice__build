cvs [diff aborted]: received interrupt signal
Index: xmloff/source/draw/animationimport.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/draw/animationimport.cxx,v
retrieving revision 1.2
retrieving revision 1.2.54.1
diff -u -p -u -p -r1.2 -r1.2.54.1
--- xmloff/source/draw/animationimport.cxx	26 Nov 2004 19:31:14 -0000	1.2
+++ xmloff/source/draw/animationimport.cxx	28 Jan 2005 14:10:15 -0000	1.2.54.1
@@ -246,12 +246,14 @@ public:
 	Sequence< TimeFilterPair > convertTimeFilter( const OUString& rValue );
 
 	bool convertAnimationValue( XMLTokenEnum eAttributeName, Any& rValue );
+	const OUString mastrHSL;
 };
 
 AnimationsImportHelperImpl::AnimationsImportHelperImpl( SvXMLImport& rImport )
 :	mrImport( rImport ),
 	mpAnimationNodeTokenMap( NULL ),
-	mpAnimationNodeAttributeTokenMap( NULL )	
+	mpAnimationNodeAttributeTokenMap( NULL ),
+	mastrHSL( RTL_CONSTASCII_USTRINGPARAM( "hsl" ) )
 {
 }
 
@@ -499,7 +501,7 @@ Any AnimationsImportHelperImpl::convertT
 Any AnimationsImportHelperImpl::convertValue( XMLTokenEnum eAttributeName, const OUString& rValue )
 {
 	sal_Int32 nPos = rValue.indexOf( ',' );
-	if( nPos >= 0 )
+	if( nPos >= 0 && !rValue.matchIgnoreAsciiCase( mastrHSL ) )
 	{
 		ValuePair aPair;
 		aPair.First = convertValue( eAttributeName, rValue.copy( 0, nPos ) );
@@ -519,40 +521,6 @@ Any AnimationsImportHelperImpl::convertV
 		case XML_HEIGHT:
 		case XML_TRANSLATE:
 		{
-/*
-			OUString aString( rValue );
-
-			const sal_Char* pSource[] = { "$x", "$y", "$width", "$height", NULL };
-			const sal_Char* pDest[] = { "$X", "$Y", "$Width", "$Height", NULL };
-			const sal_Int32 nLength[] = { 2, 2, 6, 7, 0 };
-
-			sal_Int32 nIndex = 0;
-			while( (nIndex = aString.indexOf( (sal_Unicode)'$', nIndex )) != -1  )
-			{
-				const sal_Char** ps = pSource;
-				const sal_Char** pd = pDest;
-				const sal_Int32* pl = nLength;
-
-				while( *ps )
-				{
-					if( aString.matchAsciiL( *ps, *pl, nIndex ) )
-					{
-						const OUString aNew( OUString::createFromAscii( *pd ) );
-						aString = aString.replaceAt( nIndex, *pl, aNew );
-						break;
-					}
-
-					ps++;
-					pd++;
-					pl++;
-				}
-
-				if( *ps == 0 )
-					nIndex++;
-			}
-
-			return makeAny( aString );
-*/
 			return makeAny( rValue );
 		}
 
Index: xmloff/source/style/xmlbahdl.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/style/xmlbahdl.cxx,v
retrieving revision 1.16
retrieving revision 1.16.54.1
diff -u -p -u -p -r1.16 -r1.16.54.1
--- xmloff/source/style/xmlbahdl.cxx	26 Nov 2004 13:04:06 -0000	1.16
+++ xmloff/source/style/xmlbahdl.cxx	28 Jan 2005 14:17:19 -0000	1.16.54.1
@@ -531,8 +531,31 @@ sal_Bool XMLColorPropHdl::importXML( con
 	sal_Bool bRet = sal_False;
 	Color aColor;
 
-	bRet = rUnitConverter.convertColor( aColor, rStrImpValue );
-	rValue <<= (sal_Int32)( aColor.GetColor() );
+	const OUString astrHSL( RTL_CONSTASCII_USTRINGPARAM( "hsl" ) );
+	if( rStrImpValue.matchIgnoreAsciiCase( astrHSL ) )
+	{
+		sal_Int32 nOpen = rStrImpValue.indexOf( '(' );
+		sal_Int32 nClose = rStrImpValue.lastIndexOf( ')' );
+
+		if( (nOpen != -1) && (nClose > nOpen) )
+		{
+			const OUString aTmp( rStrImpValue.copy( nOpen+1, nClose - nOpen-1) );
+
+			sal_Int32 nIndex = 0;
+
+			Sequence< double > aHSL(3);
+            aHSL[0] = aTmp.getToken( 0, ',', nIndex ).toDouble();
+            aHSL[1] = aTmp.getToken( 0, ',', nIndex ).toDouble() / 100.0;
+            aHSL[2] = aTmp.getToken( 0, ',', nIndex ).toDouble() / 100.0;
+			rValue <<= aHSL;
+			bRet = true;
+        }
+	}
+	else
+	{
+		bRet = rUnitConverter.convertColor( aColor, rStrImpValue );
+		rValue <<= (sal_Int32)( aColor.GetColor() );
+	}
 
 	return bRet;
 }
@@ -543,16 +566,33 @@ sal_Bool XMLColorPropHdl::exportXML( OUS
 	Color aColor;
 	sal_Int32 nColor;
 
+	OUStringBuffer aOut;
 	if( rValue >>= nColor )
 	{
 		aColor.SetColor( nColor );
 
-		OUStringBuffer aOut;
 		rUnitConverter.convertColor( aOut, aColor );
 		rStrExpValue = aOut.makeStringAndClear();
 
 		bRet = sal_True;
 	}
+	else
+	{
+		Sequence< double > aHSL;
+		if( (rValue >>= aHSL) && (aHSL.getLength() == 3) )
+		{
+			aOut.append( OUString::createFromAscii("hsl(") );
+			aOut.append( aHSL[0] );
+			aOut.append( OUString::createFromAscii(",") );
+			aOut.append( aHSL[1] * 100.0 );
+			aOut.append( OUString::createFromAscii("%,") );
+			aOut.append( aHSL[2] * 100.0 );
+			aOut.append( OUString::createFromAscii("%)") );
+			rStrExpValue = aOut.makeStringAndClear();
+
+			bRet = sal_True;
+		}
+	}
 
 	return bRet;
 }
Index: sd/inc/sdpage.hxx
===================================================================
RCS file: /cvs/graphics/sd/inc/sdpage.hxx,v
retrieving revision 1.20
retrieving revision 1.20.16.1
diff -u -p -u -p -r1.20 -r1.20.16.1
--- sd/inc/sdpage.hxx	13 Jan 2005 17:25:13 -0000	1.20
+++ sd/inc/sdpage.hxx	28 Jan 2005 09:06:08 -0000	1.20.16.1
@@ -123,6 +123,7 @@ struct StyleRequestData;
 class SdPage;
 class Paragraph;
 class Outliner;
+class SdStyleSheet;
 
 namespace sd
 {
@@ -181,14 +182,6 @@ namespace sd {
 		PresObjKind meKind;
 	};
 
-	/** this unary_function can be used with stl algorithms to remove presentation objects from its page */
-	struct removePresObj_func : public std::unary_function< PresentationObjectDescriptor, void >
-	{
-		removePresObj_func( SdPage* pPage ) : mpPage( pPage ) {}
-		void operator() (PresentationObjectDescriptor x);
-		SdPage* mpPage;
-	};
-
 	struct SD_DLLPUBLIC HeaderFooterSettings
 	{
 		bool mbHeaderVisible;
@@ -450,6 +443,9 @@ public:
 	/** callback from the sd::View when a paragraph from one object on this page is removed */
 	void onParagraphRemoving( ::Outliner* pOutliner, Paragraph* pPara, SdrObject* pObj );
 
+	/** returns the presentation style with the given helpid from this masterpage or this
+		slides masterpage */
+	SdStyleSheet* getPresentationStyle( sal_uInt32 nHelpId ) const;
 };
 
 #endif	   // _SDPAGE_HXX
Index: sd/source/core/sdpage.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/core/sdpage.cxx,v
retrieving revision 1.48
retrieving revision 1.48.16.1
diff -u -p -u -p -r1.48 -r1.48.16.1
--- sd/source/core/sdpage.cxx	13 Jan 2005 17:25:42 -0000	1.48
+++ sd/source/core/sdpage.cxx	28 Jan 2005 09:06:56 -0000	1.48.16.1
@@ -166,6 +166,7 @@
 #include "stlsheet.hxx"
 #include "glob.hrc"
 #include "glob.hxx"
+#include "helpids.h"
 
 #ifndef _SDR_CONTACT_DISPLAYINFO_HXX
 #include <svx/sdr/contact/displayinfo.hxx>
@@ -721,6 +722,48 @@ SfxStyleSheet* SdPage::GetStyleSheetForP
 	return (SfxStyleSheet*)pResult;
 }
 
+/** returns the presentation style with the given helpid from this masterpage or this
+	slides masterpage */
+SdStyleSheet* SdPage::getPresentationStyle( sal_uInt32 nHelpId ) const
+{
+	String aStyleName( pPage->GetLayoutName() );
+	const String aSep( RTL_CONSTASCII_USTRINGPARAM( SD_LT_SEPARATOR ));
+	aStyleName.Erase(aStyleName.Search(aSep) + aSep.Len());
+
+	sal_uInt16 nNameId;
+	switch( nHelpId )
+	{
+	case HID_PSEUDOSHEET_TITLE:				nNameId = STR_LAYOUT_TITLE; 			break;
+	case HID_PSEUDOSHEET_SUBTITLE:	 		nNameId = STR_LAYOUT_SUBTITLE; 			break;
+	case HID_PSEUDOSHEET_OUTLINE1:
+	case HID_PSEUDOSHEET_OUTLINE2:
+	case HID_PSEUDOSHEET_OUTLINE3:
+	case HID_PSEUDOSHEET_OUTLINE4:
+	case HID_PSEUDOSHEET_OUTLINE5:
+	case HID_PSEUDOSHEET_OUTLINE6:
+	case HID_PSEUDOSHEET_OUTLINE7:
+	case HID_PSEUDOSHEET_OUTLINE8:
+	case HID_PSEUDOSHEET_OUTLINE9:			nNameId = STR_LAYOUT_OUTLINE; 			break;
+	case HID_PSEUDOSHEET_BACKGROUNDOBJECTS:	nNameId = STR_LAYOUT_BACKGROUNDOBJECTS; break;
+	case HID_PSEUDOSHEET_BACKGROUND:		nNameId = STR_LAYOUT_BACKGROUND; 		break;
+	case HID_PSEUDOSHEET_NOTES:				nNameId = STR_LAYOUT_NOTES; 			break;
+
+	default:
+		DBG_ERROR( "SdPage::getPresentationStyle(), illegal argument!" );
+		return 0;
+	}
+	aStyleName.Append( String( SdResId( nNameId ) ) );
+	if( nNameId == STR_LAYOUT_OUTLINE )
+	{
+		aStyleName.Append( sal_Unicode( ' ' ));
+		aStyleName.Append( String::CreateFromInt32( sal_Int32( nHelpId - HID_PSEUDOSHEET_OUTLINE )));
+	}
+
+	SfxStyleSheetBasePool* pStShPool = pModel->GetStyleSheetPool();
+	SfxStyleSheetBase*	   pResult	 = pStShPool->Find(aStyleName, SD_LT_FAMILY);
+	return dynamic_cast<SdStyleSheet*>(pResult);
+}
+
 /*************************************************************************
 |*
 |* Das Praesentationsobjekt rObj hat sich geaendert und wird nicht mehr
@@ -3466,9 +3509,3 @@ bool HeaderFooterSettings::operator==( c
 		   (maDateTimeText == rSettings.maDateTimeText);
 }
 
-// stl functions to use with the presentation object list
-
-void sd::removePresObj_func::operator() (PresentationObjectDescriptor x)
-{
-	delete mpPage->RemoveObject(x.mpObject->GetOrdNum());
-}
Index: sd/source/core/stlsheet.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/core/stlsheet.cxx,v
retrieving revision 1.9
retrieving revision 1.9.212.1
diff -u -p -u -p -r1.9 -r1.9.212.1
--- sd/source/core/stlsheet.cxx	13 Jul 2004 13:45:54 -0000	1.9
+++ sd/source/core/stlsheet.cxx	28 Jan 2005 09:08:40 -0000	1.9.212.1
@@ -385,7 +385,6 @@ SdStyleSheet* SdStyleSheet::GetRealStyle
 	SdStyleSheet* pRealStyle = NULL;
 	SdDrawDocument* pDoc = ((SdStyleSheetPool&) rPool).GetDoc();
 
-#ifndef SVX_LIGHT
 	SfxViewShell* pViewShellBase = SfxViewShell::Current();
 	if (pViewShellBase!=NULL && pViewShellBase->ISA(::sd::ViewShellBase))
     {
@@ -404,15 +403,6 @@ SdStyleSheet* SdStyleSheet::GetRealStyle
         }
     }
     
-#else
-	SdrPage* pPage = pDoc->GetSdPage(0, PK_STANDARD);
-	if( pPage )
-	{
-		aRealStyle = pPage->GetLayoutName();
-		aRealStyle.Erase(aRealStyle.Search(aSep) + aSep.Len());
-	}
-#endif // !SVX_LIGHT
-
 	if (aRealStyle.Len() == 0)
 	{
 		SdPage* pPage = pDoc->GetSdPage(0, PK_STANDARD);
Index: sd/source/ui/animations/CustomAnimationList.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/animations/CustomAnimationList.cxx,v
retrieving revision 1.2
retrieving revision 1.2.72.1
diff -u -p -u -p -r1.2 -r1.2.72.1
--- sd/source/ui/animations/CustomAnimationList.cxx	26 Nov 2004 19:54:45 -0000	1.2
+++ sd/source/ui/animations/CustomAnimationList.cxx	25 Jan 2005 10:30:11 -0000	1.2.72.1
@@ -288,7 +288,6 @@ class CustomAnimationListEntryItem : pub
 public:
 					CustomAnimationListEntryItem( SvLBoxEntry*,USHORT nFlags, OUString aDescription, CustomAnimationEffectPtr pEffect, CustomAnimationList* pParent  );
 	virtual			~CustomAnimationListEntryItem();
-	virtual USHORT	IsA();
 	void			InitViewData( SvLBox*,SvLBoxEntry*,SvViewDataItem* );
 	void			Paint( const Point&, SvLBox& rDev, USHORT nFlags,SvLBoxEntry* );
 	SvLBoxItem* 	Create() const;
@@ -315,13 +314,6 @@ CustomAnimationListEntryItem::~CustomAni
 
 // --------------------------------------------------------------------
 
-USHORT CustomAnimationListEntryItem::IsA()
-{
-	return -1;
-}
-
-// --------------------------------------------------------------------
-
 void CustomAnimationListEntryItem::InitViewData( SvLBox* pView, SvLBoxEntry* pEntry, SvViewDataItem* pViewData )
 {
 	if( !pViewData )
Index: sd/source/ui/app/menuids_tmpl.src
===================================================================
RCS file: /cvs/graphics/sd/source/ui/app/menuids_tmpl.src,v
retrieving revision 1.3
retrieving revision 1.3.94.1
diff -u -p -u -p -r1.3 -r1.3.94.1
--- sd/source/ui/app/menuids_tmpl.src	4 Nov 2004 16:04:05 -0000	1.3
+++ sd/source/ui/app/menuids_tmpl.src	31 Jan 2005 10:51:46 -0000	1.3.94.1
@@ -104,8 +104,8 @@
         Identifier = SID_DIAMODE ; \
         HelpID = SID_DIAMODE ; \
         Check = TRUE ; \
-        Text [ de ] = "~Diaansicht" ; \
-        Text [ en-US ] = "~Slides View" ; \
+        Text [ de ] = "~Foliensortierung" ; \
+        Text [ en-US ] = "~Slide Sorter" ; \
 	};
 
 #define MN_PRESENTATION \
Index: sd/source/ui/func/fupage.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/func/fupage.cxx,v
retrieving revision 1.19
retrieving revision 1.19.146.1
diff -u -p -u -p -r1.19 -r1.19.146.1
--- sd/source/ui/func/fupage.cxx	4 Oct 2004 18:32:53 -0000	1.19
+++ sd/source/ui/func/fupage.cxx	28 Jan 2005 09:12:52 -0000	1.19.146.1
@@ -151,6 +151,8 @@
 #include "undoback.hxx"
 #include "sdabstdlg.hxx" //CHINA001 
 #include "dlgpage.hrc" //CHINA001 	
+#include "helpids.h"
+
 namespace sd {
 
 class Window;
@@ -163,6 +165,28 @@ class Window;
 
 TYPEINIT1( FuPage, FuPoor );
 
+void mergeItemSetsImpl( SfxItemSet& rTarget, const SfxItemSet& rSource )
+{
+	const USHORT* pPtr = rSource.GetRanges();
+	USHORT p1, p2;
+	while( *pPtr )
+	{
+		p1 = pPtr[0];
+		p2 = pPtr[1];
+
+		// make ranges discret
+		while(pPtr[2] && (pPtr[2] - p2 == 1))
+		{
+			p2 = pPtr[3];
+			pPtr += 2;
+		}
+		rTarget.MergeRange( p1, p2 );
+		pPtr += 2;
+	}
+
+	rTarget.Put(rSource);
+}
+
 /*************************************************************************
 |*
 |* Konstruktor
@@ -171,367 +195,312 @@ TYPEINIT1( FuPage, FuPoor );
 
 FuPage::FuPage( ViewShell* pViewSh, ::sd::Window* pWin, ::sd::View* pView,
 				 SdDrawDocument* pDoc, SfxRequest& rReq )
-	   : FuPoor(pViewSh, pWin, pView, pDoc, rReq)
+:	FuPoor(pViewSh, pWin, pView, pDoc, rReq),
+	mrReq(rReq),
+	mpArgs( rReq.GetArgs() ),
+    mpBackgroundObjUndoAction( 0 ),
+	mbPageBckgrdDeleted( false ),
+	mpPage(0),
+	mbMasterPage( false ),
+	mbDisplayBackgroundTabPage( true )
 {
-	const SfxItemSet*           pArgs = rReq.GetArgs();
-	SdPage* 	                pPage = NULL;
-    SdBackgroundObjUndoAction*  pBackgroundObjUndoAction = NULL;
-	Size		                aSize;
-	PageKind	                ePageKind = PK_STANDARD;
-	BOOL                        bMasterPage = TRUE;
-	BOOL                        bPageBckgrdDeleted = FALSE;
-
-	///////////////////////////////////////////////////////////////////////////
-	//
-	// Retrieve current page
-	//
-	if ( pViewSh->ISA(DrawViewShell) )
-		ePageKind = static_cast<DrawViewShell*>(pViewSh)->GetPageKind();
-
-	 // shall we display background area tabpage?
-	bool bDisplayBackgroundTabPage = (ePageKind == PK_STANDARD) ? TRUE : FALSE;
-
-	if (static_cast<DrawViewShell*>(pViewSh)->GetEditMode() == EM_MASTERPAGE)
+	mpDrawViewShell = dynamic_cast<DrawViewShell*>(pViewSh);
+	DBG_ASSERT( mpDrawViewShell, "sd::FuPage::FuPage(), called without a current DrawViewShell!" );
+	if( mpDrawViewShell )
 	{
-		pPage = pDoc->GetSdPage(0, ePageKind);
+		mbMasterPage = mpDrawViewShell->GetEditMode() == EM_MASTERPAGE;
+		mbDisplayBackgroundTabPage = (mpDrawViewShell->GetPageKind() == PK_STANDARD);
+		mpPage = mpDrawViewShell->getCurrentPage();
 	}
-	else
+
+	if( mpPage )
 	{
-		bMasterPage = FALSE;
-		pPage = static_cast<DrawViewShell*>(pViewSh)->GetActualPage();
+		// if there are no arguments given, open the dialog
+		if( !mpArgs )
+		{
+			pView->EndTextEdit();
+			mpArgs = ExecuteDialog(pWin);
+		}
+
+		// if we now have arguments, apply them to current page
+		if( mpArgs )
+			ApplyItemSet( mpArgs );
 	}
+}
 
-	if( !pArgs )
-	{
-		pView->EndTextEdit();
+FuPage::~FuPage()
+{
+	delete mpBackgroundObjUndoAction;
+}
 
-		SfxItemSet aNewAttr(pDoc->GetPool(),
-							pDoc->GetPool().GetWhich(SID_ATTR_LRSPACE),
-							pDoc->GetPool().GetWhich(SID_ATTR_ULSPACE),
-							SID_ATTR_PAGE, SID_ATTR_PAGE_BSP,
-							SID_ATTR_BORDER_OUTER, SID_ATTR_BORDER_OUTER,
-							SID_ATTR_BORDER_SHADOW, SID_ATTR_BORDER_SHADOW,
-							XATTR_FILL_FIRST, XATTR_FILL_LAST,
-							EE_PARA_WRITINGDIR, EE_PARA_WRITINGDIR,
-							0);
-
-		SfxItemSet *pDialogItems = 0;
-
-		///////////////////////////////////////////////////////////////////////
-		//
-		// Retrieve additional data for dialog
-		//
-		SvxShadowItem aShadowItem;
-		aNewAttr.Put( aShadowItem );
-		SvxBoxItem aBoxItem;
-		aNewAttr.Put( aBoxItem );
-
-		
-		aNewAttr.Put( SvxFrameDirectionItem( pDoc->GetDefaultWritingMode() == ::com::sun::star::text::WritingMode_RL_TB ? FRMDIR_HORI_RIGHT_TOP : FRMDIR_HORI_LEFT_TOP ) );
-
-		///////////////////////////////////////////////////////////////////////
-		//
-		// Retrieve page-data for dialog
-		//
-		SvxPageItem aPageItem;
-		aPageItem.SetDescName( pPage->GetName() );
-		aPageItem.SetPageUsage( (SvxPageUsage) SVX_PAGE_ALL );
+void FuPage::Activate()
+{
+}
 
-		Orientation eOrientation = pPage->GetOrientation();
+void FuPage::Deactivate()
+{
+}
 
-		if (eOrientation == ORIENTATION_LANDSCAPE)
-		{
-			aPageItem.SetLandscape(TRUE);
-		}
-		else
-		{
-			aPageItem.SetLandscape(FALSE);
-		}
+const SfxItemSet* FuPage::ExecuteDialog( Window* pParent )
+{
+	PageKind ePageKind = mpDrawViewShell->GetPageKind();
 
-		aPageItem.SetNumType( pDoc->GetPageNumType() );
-		aNewAttr.Put( aPageItem );
+	SfxItemSet aNewAttr(pDoc->GetPool(),
+						pDoc->GetPool().GetWhich(SID_ATTR_LRSPACE),
+						pDoc->GetPool().GetWhich(SID_ATTR_ULSPACE),
+						SID_ATTR_PAGE, SID_ATTR_PAGE_BSP,
+						SID_ATTR_BORDER_OUTER, SID_ATTR_BORDER_OUTER,
+						SID_ATTR_BORDER_SHADOW, SID_ATTR_BORDER_SHADOW,
+						XATTR_FILL_FIRST, XATTR_FILL_LAST,
+						EE_PARA_WRITINGDIR, EE_PARA_WRITINGDIR,
+						0);
 
-		// size
-		aSize = pPage->GetSize();
-		SvxSizeItem aSizeItem( SID_ATTR_PAGE_SIZE, aSize );
-		aNewAttr.Put( aSizeItem );
-
-		// Max size
-		SvxSizeItem aMaxSizeItem( SID_ATTR_PAGE_MAXSIZE, Size( MAXWIDTH, MAXHEIGHT ) );
-		aNewAttr.Put( aMaxSizeItem );
-
-		// get printer
-		SfxPrinter* pPrinter = ( (DrawDocShell*) pViewSh->GetViewFrame()->GetObjectShell() )->GetPrinter(TRUE);
-
-		// paperbin
-		SvxPaperBinItem aPaperBinItem( SID_ATTR_PAGE_PAPERBIN, 
-            (const BYTE)pPage->GetPaperBin() );
-		aNewAttr.Put( aPaperBinItem );
-
-		// Raender, Umrandung und das andere Zeug
-		//
-		SvxLRSpaceItem aLRSpaceItem(
-							(USHORT) pPage->GetLftBorder(),
-							(USHORT) pPage->GetRgtBorder(), 0, 0,
-								pDoc->GetPool().GetWhich(SID_ATTR_LRSPACE));
-		aNewAttr.Put( aLRSpaceItem );
-
-		SvxULSpaceItem aULSpaceItem(
-							(USHORT) pPage->GetUppBorder(),
-							(USHORT) pPage->GetLwrBorder(),
-							pDoc->GetPool().GetWhich(SID_ATTR_ULSPACE));
-		aNewAttr.Put( aULSpaceItem );
-
-
-		// Applikation
-		BOOL bScale = TRUE;
-		if( pDoc->GetDocumentType() == DOCUMENT_TYPE_DRAW )
-			bScale = FALSE;
-		aNewAttr.Put( SfxBoolItem( SID_ATTR_PAGE_EXT1, bScale ) );
-
-		BOOL bFullSize = ((SdPage&)(pPage->TRG_GetMasterPage())).IsBackgroundFullSize();
-		aNewAttr.Put( SfxBoolItem( SID_ATTR_PAGE_EXT2, bFullSize ) );
-
-		///////////////////////////////////////////////////////////////////////
-		//
-		// Merge ItemSet for dialog
-		//
-		const USHORT* pPtr = aNewAttr.GetRanges();
-		USHORT p1 = pPtr[0], p2 = pPtr[1];
-		while(pPtr[2] && (pPtr[2] - p2 == 1))
-		{
-			p2 = pPtr[3];
-			pPtr += 2;
-		}
+	SfxItemSet *pDialogItems = 0;
+
+	///////////////////////////////////////////////////////////////////////
+	// Retrieve additional data for dialog
+
+	SvxShadowItem aShadowItem;
+	aNewAttr.Put( aShadowItem );
+	SvxBoxItem aBoxItem;
+	aNewAttr.Put( aBoxItem );
+
+	aNewAttr.Put( SvxFrameDirectionItem( pDoc->GetDefaultWritingMode() == ::com::sun::star::text::WritingMode_RL_TB ? FRMDIR_HORI_RIGHT_TOP : FRMDIR_HORI_LEFT_TOP ) );
+
+	///////////////////////////////////////////////////////////////////////
+	// Retrieve page-data for dialog
+
+	SvxPageItem aPageItem;
+	aPageItem.SetDescName( mpPage->GetName() );
+	aPageItem.SetPageUsage( (SvxPageUsage) SVX_PAGE_ALL );
+	aPageItem.SetLandscape( mpPage->GetOrientation() == ORIENTATION_LANDSCAPE ? TRUE: FALSE );
+	aPageItem.SetNumType( pDoc->GetPageNumType() );
+	aNewAttr.Put( aPageItem );
+
+	// size
+	maSize = mpPage->GetSize();
+	SvxSizeItem aSizeItem( SID_ATTR_PAGE_SIZE, maSize );
+	aNewAttr.Put( aSizeItem );
+
+	// Max size
+	SvxSizeItem aMaxSizeItem( SID_ATTR_PAGE_MAXSIZE, Size( MAXWIDTH, MAXHEIGHT ) );
+	aNewAttr.Put( aMaxSizeItem );
+
+	// get printer
+	SfxPrinter* pPrinter = GetDocSh()->GetPrinter(TRUE);
+
+	// paperbin
+	SvxPaperBinItem aPaperBinItem( SID_ATTR_PAGE_PAPERBIN, (const BYTE)mpPage->GetPaperBin() );
+	aNewAttr.Put( aPaperBinItem );
+
+	SvxLRSpaceItem aLRSpaceItem( (USHORT)mpPage->GetLftBorder(), (USHORT)mpPage->GetRgtBorder(), 0, 0, pDoc->GetPool().GetWhich(SID_ATTR_LRSPACE));
+	aNewAttr.Put( aLRSpaceItem );
+
+	SvxULSpaceItem aULSpaceItem( (USHORT)mpPage->GetUppBorder(), (USHORT)mpPage->GetLwrBorder(), pDoc->GetPool().GetWhich(SID_ATTR_ULSPACE));
+	aNewAttr.Put( aULSpaceItem );
+
+	// Applikation
+	bool bScale = pDoc->GetDocumentType() != DOCUMENT_TYPE_DRAW;
+	aNewAttr.Put( SfxBoolItem( SID_ATTR_PAGE_EXT1, bScale ? TRUE : FALSE ) );
+
+	BOOL bFullSize = mpPage->IsMasterPage() ? 
+		mpPage->IsBackgroundFullSize() : ((SdPage&)mpPage->TRG_GetMasterPage()).IsBackgroundFullSize();
+
+	aNewAttr.Put( SfxBoolItem( SID_ATTR_PAGE_EXT2, bFullSize ) );
+
+	///////////////////////////////////////////////////////////////////////
+	// Merge ItemSet for dialog
+
+	const USHORT* pPtr = aNewAttr.GetRanges();
+	USHORT p1 = pPtr[0], p2 = pPtr[1];
+	while(pPtr[2] && (pPtr[2] - p2 == 1))
+	{
+		p2 = pPtr[3];
 		pPtr += 2;
-		SfxItemSet aMergedAttr( *aNewAttr.GetPool(), p1, p2 );
+	}
+	pPtr += 2;
+	SfxItemSet aMergedAttr( *aNewAttr.GetPool(), p1, p2 );
 
-		while( *pPtr )
-		{
-			p1 = pPtr[0];
-			p2 = pPtr[1];
+	mergeItemSetsImpl( aMergedAttr, aNewAttr );
 
-			// erstmal das ganze discret machen
-			while(pPtr[2] && (pPtr[2] - p2 == 1))
-			{
-				p2 = pPtr[3];
-				pPtr += 2;
-			}
-			aMergedAttr.MergeRange( p1, p2 );
-			pPtr += 2;
-		}
+	SdStyleSheet* pStyleSheet = mpPage->getPresentationStyle(HID_PSEUDOSHEET_BACKGROUND);
 
-		SfxStyleSheetBasePool* pSSPool = pDoc->GetDocSh()->GetStyleSheetPool();
-		SfxStyleSheetBase* pStyleSheet = NULL;
-		if(pSSPool)
+	// merge page background filling to the dialogs input set
+	if( mbDisplayBackgroundTabPage )
+	{
+		if( mbMasterPage )
 		{
-			String aStr(SdResId(STR_PSEUDOSHEET_BACKGROUND));
-			pStyleSheet = pSSPool->Find( aStr, SFX_STYLE_FAMILY_PSEUDO);
+			if(pStyleSheet)
+				mergeItemSetsImpl( aMergedAttr, pStyleSheet->GetItemSet() );
 		}
-
-		if( bDisplayBackgroundTabPage )
+		else
 		{
-			if( bMasterPage )
+			// Only this page, check if there is a background-object on that page
+			SdrObject* pObj = mpPage->GetBackgroundObj();
+			if( pObj )
 			{
-				if(pStyleSheet)
-				{
-					SfxItemSet aStyleSet( pStyleSheet->GetItemSet());
-
-					pPtr = aStyleSet.GetRanges();
-					while( *pPtr )
-					{
-						p1 = pPtr[0];
-						p2 = pPtr[1];
-
-						// erstmal das ganze discret machen
-						while(pPtr[2] && (pPtr[2] - p2 == 1))
-						{
-							p2 = pPtr[3];
-							pPtr += 2;
-						}
-						aMergedAttr.MergeRange( p1, p2 );
-						pPtr += 2;
-					}
-
-					aMergedAttr.Put(aStyleSet);
-				}
+				aMergedAttr.Put(pObj->GetMergedItemSet());
 			}
 			else
 			{
-				// Only this page
-				SdrObject* pObj = pPage->GetBackgroundObj();
-				if( pObj )
-				{
-					aMergedAttr.Put(pObj->GetMergedItemSet());
-				}
+				// if the page hasn't got a background-object, than use
+				// the fillstyle-settings of the masterpage for the dialog
+				if( pStyleSheet && pStyleSheet->GetItemSet().GetItemState( XATTR_FILLSTYLE ) != SFX_ITEM_DEFAULT )
+					mergeItemSetsImpl( aMergedAttr, pStyleSheet->GetItemSet() );
 				else
-				{
-					// if the page hasn't got a background-object, than use
-					// the fillstyle-settings of the masterpage for the dialog
-					if( pStyleSheet->GetItemSet().GetItemState( XATTR_FILLSTYLE ) != SFX_ITEM_DEFAULT )
-						aMergedAttr.Put( pStyleSheet->GetItemSet() );
-					else
-						aMergedAttr.Put( XFillStyleItem( XFILL_NONE ) );
-				}
+					aMergedAttr.Put( XFillStyleItem( XFILL_NONE ) );
 			}
 		}
+	}
 
-		aMergedAttr.Put(aNewAttr);
+	// create the dialog
+	SdAbstractDialogFactory* pFact = SdAbstractDialogFactory::Create();
+	std::auto_ptr<SfxAbstractTabDialog> pDlg;
+	if( pFact )
+		pDlg.reset( pFact->CreateSdTabDialog(ResId( TAB_PAGE ), NULL, &aMergedAttr, pDocSh, mbDisplayBackgroundTabPage ) );
+
+	DBG_ASSERT(pDlg.get(), "sd::FuPage::FuPage(), call to CreateSdTabDialog failed!");
+	if( !pDlg.get() )
+		return false;
 
-		//CHINA001 SdPageDlg* pDlg = new SdPageDlg( pDocSh, NULL, &aMergedAttr, bDisplayBackgroundTabPage );
-		SdAbstractDialogFactory* pFact = SdAbstractDialogFactory::Create();//CHINA001
-		DBG_ASSERT(pFact, "SdAbstractDialogFactory fail!");//CHINA001
-		SfxAbstractTabDialog* pDlg = pFact->CreateSdTabDialog(ResId( TAB_PAGE ), NULL, &aMergedAttr, pDocSh, bDisplayBackgroundTabPage );
-		DBG_ASSERT(pDlg, "Dialogdiet fail!");//CHINA001
-		USHORT nResult = pDlg->Execute();
+	if( pDlg->Execute() == RET_OK )
+	{
+		SfxItemSet aTempSet(*pDlg->GetOutputItemSet());
+		pStyleSheet->AdjustToFontHeight(aTempSet);
 
-		switch( nResult )
+		if( mbDisplayBackgroundTabPage )
 		{
-			case RET_OK:
+			// if some fillstyle-items are not set in the dialog, then
+			// try to use the items before
+			BOOL bChanges = FALSE;
+			for( int i=XATTR_FILL_FIRST; i<XATTR_FILL_LAST; i++ )
 			{
-				SfxItemSet aTempSet(*pDlg->GetOutputItemSet());
-				((SdStyleSheet*)pStyleSheet)->AdjustToFontHeight(aTempSet);
+				if( aMergedAttr.GetItemState( i ) != SFX_ITEM_DEFAULT )
+				{
+					if( aTempSet.GetItemState( i ) == SFX_ITEM_DEFAULT )
+						aTempSet.Put( aMergedAttr.Get( i ) );
+					else
+						if( aMergedAttr.GetItem( i ) != aTempSet.GetItem( i ) )
+							bChanges = TRUE;
+				}
+			}
+
+			// if the background for this page was set to invisible, the background-object has to be deleted, too.
+			if( ( ( (XFillStyleItem*) aTempSet.GetItem( XATTR_FILLSTYLE ) )->GetValue() == XFILL_NONE ) ||
+				( ( aTempSet.GetItemState( XATTR_FILLSTYLE ) == SFX_ITEM_DEFAULT ) &&
+					( ( (XFillStyleItem*) aMergedAttr.GetItem( XATTR_FILLSTYLE ) )->GetValue() == XFILL_NONE ) ) )
+				mbPageBckgrdDeleted = TRUE;
 
-				if( bDisplayBackgroundTabPage )
+			// Ask, wether the setting are for the background-page or for the current page
+			if( !mbMasterPage && bChanges )
+			{
+				// But don't ask in notice-view, because we can't change the background of
+				// notice-masterpage (at the moment)
+				if( ePageKind != PK_NOTES )
 				{
-					// if some fillstyle-items are not set in the dialog, then
-					// try to use the items before
-					BOOL bChanges = FALSE;
-					for( int i=XATTR_FILL_FIRST; i<XATTR_FILL_LAST; i++ )
-					{
-						if( aMergedAttr.GetItemState( i ) != SFX_ITEM_DEFAULT )
-						{
-							if( aTempSet.GetItemState( i ) == SFX_ITEM_DEFAULT )
-								aTempSet.Put( aMergedAttr.Get( i ) );
-							else
-								if( aMergedAttr.GetItem( i ) != aTempSet.GetItem( i ) )
-									bChanges = TRUE;
-						}
-					}
-
-					// if the background for this page was set to invisible, the background-object has to be deleted, too.
-					if( ( ( (XFillStyleItem*) aTempSet.GetItem( XATTR_FILLSTYLE ) )->GetValue() == XFILL_NONE ) ||
-						( ( aTempSet.GetItemState( XATTR_FILLSTYLE ) == SFX_ITEM_DEFAULT ) &&
-						  ( ( (XFillStyleItem*) aMergedAttr.GetItem( XATTR_FILLSTYLE ) )->GetValue() == XFILL_NONE ) ) )
-						bPageBckgrdDeleted = TRUE;
-
-					// Ask, wether the setting are for the background-page or for the current page
-					if( !bMasterPage && bChanges )
-					{
-						// But don't ask in notice-view, because we can't change the background of
-						// notice-masterpage (at the moment)
-						if( ePageKind != PK_NOTES )
-						{
-							String aTit(SdResId( STR_PAGE_BACKGROUND_TITLE ));
-							String aTxt(SdResId( STR_PAGE_BACKGROUND_TXT ));
-							MessBox aQuestionBox (
-                                pWin, 
-                                WB_YES_NO | WB_DEF_YES,
-                                aTit,
-                                aTxt );
-							aQuestionBox.SetImage( QueryBox::GetStandardImage() );
-							bMasterPage = ( RET_YES == aQuestionBox.Execute() );
-						}
-
-                        if( bPageBckgrdDeleted )
-						{
-                            pBackgroundObjUndoAction = new SdBackgroundObjUndoAction( *pDoc, *pPage, pPage->GetBackgroundObj() );
-							pPage->SetBackgroundObj( NULL );
-
-							// #110094#-15
-							// tell the page that it's visualization has changed
-							pPage->ActionChanged();
-						}
-
-					}
-
-					// Sonderbehandlung: die INVALIDS auf NULL-Pointer
-					// zurueckgesetzen (sonst landen INVALIDs oder
-					// Pointer auf die DefaultItems in der Vorlage;
-					// beides wuerde die Attribut-Vererbung unterbinden)
-					aTempSet.ClearInvalidItems();
-
-					if( bMasterPage )
-					{
-						StyleSheetUndoAction* pAction = new StyleSheetUndoAction(pDoc, (SfxStyleSheet*)pStyleSheet, &aTempSet);
-						pDocSh->GetUndoManager()->AddUndoAction(pAction);
-						pStyleSheet->GetItemSet().Put( aTempSet );
-						SdStyleSheet* pRealSheet =((SdStyleSheet*)pStyleSheet)->GetRealStyleSheet();
-						pRealSheet->Broadcast(SfxSimpleHint(SFX_HINT_DATACHANGED));
-					}
-
-					const SfxPoolItem *pItem;
-					if( SFX_ITEM_SET == aTempSet.GetItemState( EE_PARA_WRITINGDIR, sal_False, &pItem ) )
-					{
-					    sal_uInt32 nVal = ((SvxFrameDirectionItem*)pItem)->GetValue();
-						pDoc->SetDefaultWritingMode( nVal == FRMDIR_HORI_RIGHT_TOP ? ::com::sun::star::text::WritingMode_RL_TB : ::com::sun::star::text::WritingMode_LR_TB );
-					}
-
-					pDoc->SetChanged(TRUE);
-
-					SdrObject* pObj = ((SdPage&)(pPage->TRG_GetMasterPage())).GetPresObj( PRESOBJ_BACKGROUND );
-					if( pObj )
-					{
-						// BackgroundObj: no hard attributes allowed
-						SfxItemSet aSet( pDoc->GetPool() );
-						pObj->SetMergedItemSet(aSet);
-					}
+					String aTit(SdResId( STR_PAGE_BACKGROUND_TITLE ));
+					String aTxt(SdResId( STR_PAGE_BACKGROUND_TXT ));
+					MessBox aQuestionBox (
+                        pParent, 
+                        WB_YES_NO | WB_DEF_YES,
+                        aTit,
+                        aTxt );
+					aQuestionBox.SetImage( QueryBox::GetStandardImage() );
+					mbMasterPage = ( RET_YES == aQuestionBox.Execute() );
 				}
 
-				aNewAttr.Put(aTempSet);
-				rReq.Done( aNewAttr );
+                if( mbPageBckgrdDeleted )
+				{
+                    mpBackgroundObjUndoAction = new SdBackgroundObjUndoAction( *pDoc, *mpPage, mpPage->GetBackgroundObj() );
+					mpPage->SetBackgroundObj( NULL );
 
-				pArgs = rReq.GetArgs();
+					// #110094#-15
+					// tell the page that it's visualization has changed
+					mpPage->ActionChanged();
+				}
 			}
-			break;
 
-			default:
+			// Sonderbehandlung: die INVALIDS auf NULL-Pointer
+			// zurueckgesetzen (sonst landen INVALIDs oder
+			// Pointer auf die DefaultItems in der Vorlage;
+			// beides wuerde die Attribut-Vererbung unterbinden)
+			aTempSet.ClearInvalidItems();
+
+			if( mbMasterPage )
+			{
+				StyleSheetUndoAction* pAction = new StyleSheetUndoAction(pDoc, (SfxStyleSheet*)pStyleSheet, &aTempSet);
+				pDocSh->GetUndoManager()->AddUndoAction(pAction);
+				pStyleSheet->GetItemSet().Put( aTempSet );
+				pStyleSheet->Broadcast(SfxSimpleHint(SFX_HINT_DATACHANGED));
+			}
+
+			const SfxPoolItem *pItem;
+			if( SFX_ITEM_SET == aTempSet.GetItemState( EE_PARA_WRITINGDIR, sal_False, &pItem ) )
+			{
+				sal_uInt32 nVal = ((SvxFrameDirectionItem*)pItem)->GetValue();
+				pDoc->SetDefaultWritingMode( nVal == FRMDIR_HORI_RIGHT_TOP ? ::com::sun::star::text::WritingMode_RL_TB : ::com::sun::star::text::WritingMode_LR_TB );
+			}
+
+			pDoc->SetChanged(TRUE);
+
+			SdrObject* pObj = mpPage->IsMasterPage() ?
+				mpPage->GetPresObj( PRESOBJ_BACKGROUND ) :
+				((SdPage&)(mpPage->TRG_GetMasterPage())).GetPresObj( PRESOBJ_BACKGROUND );
+			if( pObj )
 			{
-				delete pDlg;
+				// BackgroundObj: no hard attributes allowed
+				SfxItemSet aSet( pDoc->GetPool() );
+				pObj->SetMergedItemSet(aSet);
 			}
-			return; // Abbruch
 		}
-		delete( pDlg );
+
+		aNewAttr.Put(aTempSet);
+		mrReq.Done( aNewAttr );
+
+		return mrReq.GetArgs();
 	}
+	else
+	{
+		return 0;
+	}
+}
+
+void FuPage::ApplyItemSet( const SfxItemSet* pArgs )
+{
+	if( !pArgs )
+		return;
 
 	///////////////////////////////////////////////////////////////////////////
-	//
 	// Set new page-attributes
-	//
+	PageKind ePageKind = mpDrawViewShell->GetPageKind();
 	const SfxPoolItem*  pPoolItem;
 	BOOL                bSetPageSizeAndBorder = FALSE;
-	Size                aNewSize(aSize);
+	Size                aNewSize(maSize);
 	INT32	            nLeft  = -1, nRight = -1, nUpper = -1, nLower = -1;
 	BOOL	            bScaleAll = TRUE;
-	Orientation         eOrientation = pPage->GetOrientation();
-	BOOL                bFullSize =	((SdPage&)(pPage->TRG_GetMasterPage())).IsBackgroundFullSize();
-	USHORT              nPaperBin = pPage->GetPaperBin();
+	Orientation         eOrientation = mpPage->GetOrientation();
+	SdPage*				pMasterPage = mpPage->IsMasterPage() ? mpPage : &(SdPage&)(mpPage->TRG_GetMasterPage());
+	BOOL                bFullSize = pMasterPage->IsBackgroundFullSize();
+	USHORT              nPaperBin = mpPage->GetPaperBin();
 
 	if( pArgs->GetItemState(SID_ATTR_PAGE, TRUE, &pPoolItem) == SFX_ITEM_SET )
 	{
 		pDoc->SetPageNumType(((const SvxPageItem*) pPoolItem)->GetNumType());
 
-		if (((const SvxPageItem*) pPoolItem)->IsLandscape() == ORIENTATION_LANDSCAPE)
-		{
-			eOrientation = ORIENTATION_LANDSCAPE;
-		}
-		else
-		{
-			eOrientation = ORIENTATION_PORTRAIT;
-		}
+		eOrientation = (((const SvxPageItem*) pPoolItem)->IsLandscape() == ORIENTATION_LANDSCAPE) ? 
+			ORIENTATION_LANDSCAPE : eOrientation = ORIENTATION_PORTRAIT;
 
-		if( pPage->GetOrientation() != eOrientation )
+		if( mpPage->GetOrientation() != eOrientation )
 			bSetPageSizeAndBorder = TRUE;
 
-		if ( pViewSh->ISA(DrawViewShell) )
-			static_cast<DrawViewShell*>(pViewSh)->ResetActualPage();
+		mpDrawViewShell->ResetActualPage();
 	}
 
 	if( pArgs->GetItemState(SID_ATTR_PAGE_SIZE, TRUE, &pPoolItem) == SFX_ITEM_SET )
 	{
 		aNewSize = ((const SvxSizeItem*) pPoolItem)->GetSize();
 
-		if( pPage->GetSize() != aNewSize )
+		if( mpPage->GetSize() != aNewSize )
 			bSetPageSizeAndBorder = TRUE;
 	}
 
@@ -541,7 +510,7 @@ FuPage::FuPage( ViewShell* pViewSh, ::sd
 		nLeft = ((const SvxLRSpaceItem*) pPoolItem)->GetLeft();
 		nRight = ((const SvxLRSpaceItem*) pPoolItem)->GetRight();
 
-		if( pPage->GetLftBorder() != nLeft || pPage->GetRgtBorder() != nRight )
+		if( mpPage->GetLftBorder() != nLeft || mpPage->GetRgtBorder() != nRight )
 			bSetPageSizeAndBorder = TRUE;
 
 	}
@@ -552,78 +521,74 @@ FuPage::FuPage( ViewShell* pViewSh, ::sd
 		nUpper = ((const SvxULSpaceItem*) pPoolItem)->GetUpper();
 		nLower = ((const SvxULSpaceItem*) pPoolItem)->GetLower();
 
-		if( pPage->GetUppBorder() != nUpper || pPage->GetLwrBorder() != nLower )
+		if( mpPage->GetUppBorder() != nUpper || mpPage->GetLwrBorder() != nLower )
 			bSetPageSizeAndBorder = TRUE;
 	}
 
-	if( pArgs->GetItemState(pDoc->GetPool().GetWhich(SID_ATTR_PAGE_EXT1),
-							TRUE, &pPoolItem) == SFX_ITEM_SET )
+	if( pArgs->GetItemState(pDoc->GetPool().GetWhich(SID_ATTR_PAGE_EXT1), TRUE, &pPoolItem) == SFX_ITEM_SET )
 	{
 		bScaleAll = ((const SfxBoolItem*) pPoolItem)->GetValue();
 	}
 
-	if( pArgs->GetItemState(pDoc->GetPool().GetWhich(SID_ATTR_PAGE_EXT2),
-							TRUE, &pPoolItem) == SFX_ITEM_SET )
+	if( pArgs->GetItemState(pDoc->GetPool().GetWhich(SID_ATTR_PAGE_EXT2), TRUE, &pPoolItem) == SFX_ITEM_SET )
 	{
 		bFullSize = ((const SfxBoolItem*) pPoolItem)->GetValue();
 
-		if(((SdPage&)(pPage->TRG_GetMasterPage())).IsBackgroundFullSize() != bFullSize )
+		if(pMasterPage->IsBackgroundFullSize() != bFullSize )
 			bSetPageSizeAndBorder = TRUE;
 	}
 
 	// Papierschacht (PaperBin)
-	if( pArgs->GetItemState(pDoc->GetPool().GetWhich(SID_ATTR_PAGE_PAPERBIN),
-							TRUE, &pPoolItem) == SFX_ITEM_SET )
+	if( pArgs->GetItemState(pDoc->GetPool().GetWhich(SID_ATTR_PAGE_PAPERBIN), TRUE, &pPoolItem) == SFX_ITEM_SET )
 	{
 		nPaperBin = ((const SvxPaperBinItem*) pPoolItem)->GetValue();
 
-		if( pPage->GetPaperBin() != nPaperBin )
+		if( mpPage->GetPaperBin() != nPaperBin )
 			bSetPageSizeAndBorder = TRUE;
 	}
 
 	if (nLeft == -1 && nUpper != -1)
 	{
 		bSetPageSizeAndBorder = TRUE;
-		nLeft  = pPage->GetLftBorder();
-		nRight = pPage->GetRgtBorder();
+		nLeft  = mpPage->GetLftBorder();
+		nRight = mpPage->GetRgtBorder();
 	}
 	else if (nLeft != -1 && nUpper == -1)
 	{
 		bSetPageSizeAndBorder = TRUE;
-		nUpper = pPage->GetUppBorder();
-		nLower = pPage->GetLwrBorder();
+		nUpper = mpPage->GetUppBorder();
+		nLower = mpPage->GetLwrBorder();
 	}
 
-	if( bSetPageSizeAndBorder || !bMasterPage )
-		pViewSh->SetPageSizeAndBorder(ePageKind, aNewSize, nLeft, nRight, nUpper, 
-		                              nLower, bScaleAll, eOrientation, nPaperBin, bFullSize );
+	if( bSetPageSizeAndBorder || !mbMasterPage )
+		mpDrawViewShell->SetPageSizeAndBorder(ePageKind, aNewSize, nLeft, nRight, nUpper, nLower, bScaleAll, eOrientation, nPaperBin, bFullSize );
 
 	////////////////////////////////////////////////////////////////////////////////
 	//
 	// if bMasterPage==FALSE then create a background-object for this page with the
-	// properties set in the dialog before, but if bPageBckgrdDeleted==TRUE then
+	// properties set in the dialog before, but if mbPageBckgrdDeleted==TRUE then
 	// the background of this page was set to invisible, so it would be a mistake
 	// to create a new background-object for this page !
 	//
 
-	if( bDisplayBackgroundTabPage )
+	if( mbDisplayBackgroundTabPage )
 	{
-		if ( !bMasterPage && !bPageBckgrdDeleted )
+		if( !mbMasterPage && !mbPageBckgrdDeleted )
 		{
 			// Only this page
-			SdrObject* pObj = pPage->GetBackgroundObj();
+			SdrObject* pObj = mpPage->GetBackgroundObj();
 
-            delete pBackgroundObjUndoAction;
-            pBackgroundObjUndoAction = new SdBackgroundObjUndoAction( *pDoc, *pPage, pObj );
+			delete mpBackgroundObjUndoAction;
+			mpBackgroundObjUndoAction = new SdBackgroundObjUndoAction( *pDoc, *mpPage, pObj );
 
 			if( !pObj )
 			{
 				pObj = new SdrRectObj();
-				pPage->SetBackgroundObj( pObj );
+				mpPage->SetBackgroundObj( pObj );
 			}
 
 			Point aPos ( nLeft, nUpper );
-			Size aSize( pPage->GetSize() );
+			Size aSize( mpPage->GetSize() );
 			aSize.Width()  -= nLeft  + nRight - 1;
 			aSize.Height() -= nUpper + nLower - 1;
 			Rectangle aRect( aPos, aSize );
@@ -632,16 +597,17 @@ FuPage::FuPage( ViewShell* pViewSh, ::sd
 
 			// #110094#-15
 			// tell the page that it's visualization has changed
-			pPage->ActionChanged();
+			mpPage->ActionChanged();
 		}
 	}
 	
 	// add undo action for background object
-	if( pBackgroundObjUndoAction )
+	if( mpBackgroundObjUndoAction )
 	{
-        // set merge flag, because a SdUndoGroupAction could have been inserted before
-        pDocSh->GetUndoManager()->AddUndoAction( pBackgroundObjUndoAction, TRUE );
-    }
+		// set merge flag, because a SdUndoGroupAction could have been inserted before
+		pDocSh->GetUndoManager()->AddUndoAction( mpBackgroundObjUndoAction, TRUE );
+		mpBackgroundObjUndoAction = 0;
+	}
 
 	///////////////////////////////////////////////////////////////////////////
 	//
@@ -655,8 +621,7 @@ FuPage::FuPage( ViewShell* pViewSh, ::sd
 	//
 	// ggfs. Preview den neuen Kontext mitteilen
 	//
-	pViewSh->UpdatePreview( pViewSh->GetActualPage() );
+	mpDrawViewShell->UpdatePreview( mpDrawViewShell->GetActualPage() );
 }
 
-
 } // end of namespace sd
Index: sd/source/ui/func/futext.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/func/futext.cxx,v
retrieving revision 1.47
retrieving revision 1.47.154.1
diff -u -p -u -p -r1.47 -r1.47.154.1
--- sd/source/ui/func/futext.cxx	31 Aug 2004 13:49:12 -0000	1.47
+++ sd/source/ui/func/futext.cxx	28 Jan 2005 10:24:00 -0000	1.47.154.1
@@ -1394,8 +1394,15 @@ BOOL FuText::DeleteDefaultText()
 			{
 				::Outliner* pOutliner = pView->GetTextEditOutliner();
 				SfxStyleSheet* pSheet = pOutliner->GetStyleSheet( 0 );
+				BOOL bIsUndoEnabled = pOutliner->IsUndoEnabled();
+				if( bIsUndoEnabled )
+					pOutliner->EnableUndo(FALSE);
+
 				pOutliner->SetText( String(), pOutliner->GetParagraph( 0 ) );
 
+				if( bIsUndoEnabled )
+					pOutliner->EnableUndo(TRUE);
+
 				if (pSheet &&
 					(ePresObjKind == PRESOBJ_NOTES || ePresObjKind == PRESOBJ_TEXT))
 					pOutliner->SetStyleSheet(0, pSheet);
Index: sd/source/ui/inc/DrawViewShell.hxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/inc/DrawViewShell.hxx,v
retrieving revision 1.12
retrieving revision 1.12.72.1
diff -u -p -u -p -r1.12 -r1.12.72.1
--- sd/source/ui/inc/DrawViewShell.hxx	26 Nov 2004 20:12:05 -0000	1.12
+++ sd/source/ui/inc/DrawViewShell.hxx	28 Jan 2005 09:13:03 -0000	1.12.72.1
@@ -292,6 +292,9 @@ public:
 	EditMode	    GetEditMode() const { return eEditMode; }
 	virtual SdPage*	GetActualPage() { return pActualPage; }
 
+	/// inherited from sd::ViewShell
+	virtual SdPage* getCurrentPage() const; 
+
 	void		    ResetActualPage();
 	void		    ResetActualLayer();
 	BOOL		    SwitchPage(USHORT nPage);
Index: sd/source/ui/inc/OutlineViewShell.hxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/inc/OutlineViewShell.hxx,v
retrieving revision 1.6
retrieving revision 1.6.24.1
diff -u -p -u -p -r1.6 -r1.6.24.1
--- sd/source/ui/inc/OutlineViewShell.hxx	11 Jan 2005 12:12:37 -0000	1.6
+++ sd/source/ui/inc/OutlineViewShell.hxx	28 Jan 2005 09:13:04 -0000	1.6.24.1
@@ -135,7 +135,11 @@ public:
 	virtual void Deactivate( BOOL IsMDIActivate );
 
 	virtual SdPage*	GetActualPage();
-    /** Return a string that describes the currently selected pages.
+
+	/// inherited from sd::ViewShell
+	virtual SdPage* getCurrentPage() const; 
+	
+	/** Return a string that describes the currently selected pages.
     */
     String GetPageRangeString (void);
 
Index: sd/source/ui/inc/SlideSorterViewShell.hxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/inc/SlideSorterViewShell.hxx,v
retrieving revision 1.3
retrieving revision 1.3.72.1
diff -u -p -u -p -r1.3 -r1.3.72.1
--- sd/source/ui/inc/SlideSorterViewShell.hxx	26 Nov 2004 20:14:31 -0000	1.3
+++ sd/source/ui/inc/SlideSorterViewShell.hxx	28 Jan 2005 09:13:04 -0000	1.3.72.1
@@ -131,6 +131,9 @@ public:
     virtual void LoseFocus (void);
 	virtual SdPage*	GetActualPage (void);
 
+	/// inherited from sd::ViewShell
+	virtual SdPage* getCurrentPage() const; 
+
 	void ExecCtrl (SfxRequest& rRequest);
 	virtual void GetCtrlState (SfxItemSet &rSet);
 	virtual void FuSupport (SfxRequest& rRequest);
Index: sd/source/ui/inc/SlideViewShell.hxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/inc/SlideViewShell.hxx,v
retrieving revision 1.5
retrieving revision 1.5.210.1
diff -u -p -u -p -r1.5 -r1.5.210.1
--- sd/source/ui/inc/SlideViewShell.hxx	13 Jul 2004 14:01:51 -0000	1.5
+++ sd/source/ui/inc/SlideViewShell.hxx	28 Jan 2005 09:13:05 -0000	1.5.210.1
@@ -139,6 +139,11 @@ public:
 
 	virtual SdPage*	GetActualPage();
 
+	/** @returns
+			current or selected page or 0.
+	*/
+	virtual SdPage* getCurrentPage() const;
+
     /** Return a string that describes the currently selected pages.
     */
 	String GetPageRangeString (void);
Index: sd/source/ui/inc/TaskPaneViewShell.hxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/inc/TaskPaneViewShell.hxx,v
retrieving revision 1.3
retrieving revision 1.3.72.1
diff -u -p -u -p -r1.3 -r1.3.72.1
--- sd/source/ui/inc/TaskPaneViewShell.hxx	26 Nov 2004 20:14:46 -0000	1.3
+++ sd/source/ui/inc/TaskPaneViewShell.hxx	28 Jan 2005 09:13:05 -0000	1.3.72.1
@@ -135,6 +135,7 @@ public:
     virtual void KeyInput (const KeyEvent& rEvent);
 
 	virtual SdPage*	GetActualPage (void);
+	virtual SdPage*	getCurrentPage (void) const;
 
     void Execute (SfxRequest& rRequest);
     void GetState (SfxItemSet& rItemSet);
Index: sd/source/ui/inc/ViewShell.hxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/inc/ViewShell.hxx,v
retrieving revision 1.11
retrieving revision 1.11.70.1
diff -u -p -u -p -r1.11 -r1.11.70.1
--- sd/source/ui/inc/ViewShell.hxx	26 Nov 2004 20:15:14 -0000	1.11
+++ sd/source/ui/inc/ViewShell.hxx	28 Jan 2005 09:13:05 -0000	1.11.70.1
@@ -324,8 +324,18 @@ public:
 
 	virtual BOOL  ActivateObject(SdrOle2Obj* pObj, long nVerb);
 
+	/** @returns
+			current or selected page or 0. This method
+			will fail in master page mode.
+			
+		@deprecated, please use getCurrentPage();
+	*/
 	virtual SdPage*	GetActualPage() = 0;
-					// kann auch NULL sein
+
+	/** @returns
+			current or selected page or 0.
+	*/
+	virtual SdPage* getCurrentPage() const = 0;
 
 	FuPoor* GetOldFunction() const	  { return pFuOld; }
 	FuPoor* GetActualFunction() const { return pFuActual; }
Index: sd/source/ui/inc/fupage.hxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/inc/fupage.hxx,v
retrieving revision 1.2
retrieving revision 1.2.346.1
diff -u -p -u -p -r1.2 -r1.2.346.1
--- sd/source/ui/inc/fupage.hxx	20 Jan 2004 12:07:14 -0000	1.2
+++ sd/source/ui/inc/fupage.hxx	28 Jan 2005 09:13:05 -0000	1.2.346.1
@@ -66,7 +66,12 @@
 #include "fupoor.hxx"
 #endif
 
+class SfxItemSet;
+class SdBackgroundObjUndoAction;
+class SdPage;
+
 namespace sd {
+class DrawViewShell;
 
 class FuPage 
     : public FuPoor
@@ -80,10 +85,24 @@ class FuPage 
         ::sd::View* pView,
         SdDrawDocument* pDoc, 
         SfxRequest& rReq );
-	virtual ~FuPage (void) {}
+	virtual ~FuPage (void);
+
+	virtual void Activate();		   // Function aktivieren
+	virtual void Deactivate();		   // Function deaktivieren
+
+	const SfxItemSet* ExecuteDialog( Window* pParent );
+	void ApplyItemSet( const SfxItemSet* pArgs );
 
-	virtual void Activate() {}		   // Function aktivieren
-	virtual void Deactivate() {}		   // Function deaktivieren
+private:
+	SfxRequest&					mrReq;
+	const SfxItemSet*			mpArgs;
+    SdBackgroundObjUndoAction*	mpBackgroundObjUndoAction;
+	Size						maSize;
+	bool						mbPageBckgrdDeleted;
+	bool						mbMasterPage;
+	bool						mbDisplayBackgroundTabPage;
+	SdPage*						mpPage;
+	DrawViewShell*				mpDrawViewShell;
 };
 
 } // end of namespace sd
Index: sd/source/ui/inc/tools/IdleDetection.hxx
===================================================================
RCS file: sd/source/ui/inc/tools/IdleDetection.hxx
diff -N sd/source/ui/inc/tools/IdleDetection.hxx
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ sd/source/ui/inc/tools/IdleDetection.hxx	25 Jan 2005 10:36:14 -0000	1.1.2.1
@@ -0,0 +1,114 @@
+/*************************************************************************
+ *
+ *  $RCSfile$
+ *
+ *  $Revision$
+ *
+ *  last change: $Author$ $Date$
+ *
+ *  The Contents of this file are made available subject to the terms of
+ *  either of the following licenses
+ *
+ *         - GNU Lesser General Public License Version 2.1
+ *         - Sun Industry Standards Source License Version 1.1
+ *
+ *  Sun Microsystems Inc., October, 2000
+ *
+ *  GNU Lesser General Public License Version 2.1
+ *  =============================================
+ *  Copyright 2000 by Sun Microsystems, Inc.
+ *  901 San Antonio Road, Palo Alto, CA 94303, USA
+ *
+ *  This library is free software; you can redistribute it and/or
+ *  modify it under the terms of the GNU Lesser General Public
+ *  License version 2.1, as published by the Free Software Foundation.
+ *
+ *  This library is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ *  Lesser General Public License for more details.
+ *
+ *  You should have received a copy of the GNU Lesser General Public
+ *  License along with this library; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston,
+ *  MA  02111-1307  USA
+ *
+ *
+ *  Sun Industry Standards Source License Version 1.1
+ *  =================================================
+ *  The contents of this file are subject to the Sun Industry Standards
+ *  Source License Version 1.1 (the "License"); You may not use this file
+ *  except in compliance with the License. You may obtain a copy of the
+ *  License at http://www.openoffice.org/license.html.
+ *
+ *  Software provided under this License is provided on an "AS IS" basis,
+ *  WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING,
+ *  WITHOUT LIMITATION, WARRANTIES THAT THE SOFTWARE IS FREE OF DEFECTS,
+ *  MERCHANTABLE, FIT FOR A PARTICULAR PURPOSE, OR NON-INFRINGING.
+ *  See the License for the specific provisions governing your rights and
+ *  obligations concerning the Software.
+ *
+ *  The Initial Developer of the Original Code is: Sun Microsystems, Inc.
+ *
+ *  Copyright: 2000 by Sun Microsystems, Inc.
+ *
+ *  All Rights Reserved.
+ *
+ *  Contributor(s): _______________________________________
+ *
+ *
+ ************************************************************************/
+
+#ifndef SD_IDLE_DETECTION_HXX
+#define SD_IDLE_DETECTION_HXX
+
+#include <sal/types.h>
+
+namespace sd { namespace tools {
+
+/** Detect whether the system is idle and some time consuming operation may
+    be carried out.  This class ditinguishes between different states of
+    idle-ness.
+*/
+class IdleDetection
+{
+public:
+    /** When GetIdleState() returns this value, then the system is idle.
+    */
+    static const sal_Int32 IDET_IDLE = 0x0000;
+
+    /** There are system event pending.
+    */
+    static const sal_Int32 IDET_SYSTEM_EVENT_PENDING = 0x0001;
+
+    /** A full screen slide show is running and is active.  In contrast
+        there may be a full screen show be running in an inactive window,
+        i.e. in the background.
+    */
+    static const sal_Int32 IDET_FULL_SCREEN_SHOW_ACTIVE = 0x0002;
+
+    /** A slide show is running in a window.
+    */
+    static const sal_Int32 IDET_WINDOW_SHOW_ACTIVE = 0x0004;
+
+    /** Determine whether the system is idle.
+        @return
+            This method either returns IDET_IDLE or a combination of
+            IdleStates values or-ed together that describe what the system
+            is currently doing so that the caller can decide what to do.
+    */
+    static sal_Int32 GetIdleState (void);
+
+private:
+    /** Check whether there are input events pending.
+    */
+    static sal_Int32 CheckInputPending (void);
+
+    /** Check whether a slide show is running full screen or in a window.
+    */
+    static sal_Int32 CheckSlideShowRunning (void);
+};
+
+} } // end of namespace ::sd::tools
+
+#endif
Index: sd/source/ui/slideshow/showwin.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/slideshow/showwin.cxx,v
retrieving revision 1.2
retrieving revision 1.2.72.1
diff -u -p -u -p -r1.2 -r1.2.72.1
--- sd/source/ui/slideshow/showwin.cxx	26 Nov 2004 20:20:03 -0000	1.2
+++ sd/source/ui/slideshow/showwin.cxx	26 Jan 2005 15:41:51 -0000	1.2.72.1
@@ -117,6 +117,7 @@ ShowWindow::ShowWindow( ::Window* pParen
 
 	maShowBackground = Wallpaper( Color( COL_BLACK ) );
 //	SetBackground( Wallpaper( Color( COL_BLACK ) ) );
+    SetBackground();
 	GetParent()->Show();
 }
 
Index: sd/source/ui/slidesorter/cache/SlsQueueProcessor.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/slidesorter/cache/SlsQueueProcessor.cxx,v
retrieving revision 1.3
retrieving revision 1.3.112.1
diff -u -p -u -p -r1.3 -r1.3.112.1
--- sd/source/ui/slidesorter/cache/SlsQueueProcessor.cxx	28 Oct 2004 13:28:46 -0000	1.3
+++ sd/source/ui/slidesorter/cache/SlsQueueProcessor.cxx	25 Jan 2005 10:51:34 -0000	1.3.112.1
@@ -68,7 +68,8 @@ namespace sd { namespace slidesorter { n
 
 QueueProcessorBase::QueueProcessorBase (void)
     : mnTimeBetweenHighPriorityRequests (50/*ms*/),
-      mnTimeBetweenLowPriorityRequests (250/*ms*/)
+      mnTimeBetweenLowPriorityRequests (250/*ms*/),
+      mnTimeBetweenRequestsWhenNotIdle (1000/*ms*/)
 {
     maTimer.SetTimeoutHdl (LINK(this,QueueProcessorBase,ProcessRequest));
     maTimer.SetTimeout (mnTimeBetweenHighPriorityRequests);
Index: sd/source/ui/slidesorter/cache/SlsQueueProcessor.hxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/slidesorter/cache/SlsQueueProcessor.hxx,v
retrieving revision 1.5
retrieving revision 1.5.112.1
diff -u -p -u -p -r1.5 -r1.5.112.1
--- sd/source/ui/slidesorter/cache/SlsQueueProcessor.hxx	28 Oct 2004 13:28:59 -0000	1.5
+++ sd/source/ui/slidesorter/cache/SlsQueueProcessor.hxx	25 Jan 2005 10:51:42 -0000	1.5.112.1
@@ -64,7 +64,8 @@
 
 #include "view/SlsPageObject.hxx"
 #include "view/SlideSorterView.hxx"
-#include "TextLogger.hxx"
+#include "tools/IdleDetection.hxx"
+
 #include <svx/svdpagv.hxx>
 #include <vcl/svapp.hxx>
 #include <vcl/timer.hxx>
@@ -96,11 +97,13 @@ public:
 protected:
     virtual void ProcessRequest (void) = 0;
 
+    const ULONG mnTimeBetweenHighPriorityRequests;
+    const ULONG mnTimeBetweenLowPriorityRequests;
+    const ULONG mnTimeBetweenRequestsWhenNotIdle;
+
 private:
     /// This time controls when to process the next element from the queue.
     Timer maTimer;
-    const ULONG mnTimeBetweenHighPriorityRequests;
-    const ULONG mnTimeBetweenLowPriorityRequests;
     DECL_LINK(ProcessRequest, Timer*);
 };
 
@@ -183,8 +186,19 @@ template <class Queue, 
     Queue, RequestData, BitmapCache, BitmapFactory
     >::ProcessRequest (void)
 {
-    while ( ! (mrQueue.IsEmpty() || GetpApp()->AnyInput()))
+    bool bIsShowingFullScreenShow (false);
+
+    while ( ! mrQueue.IsEmpty())
     {
+        // Determine whether the system is idle.
+        sal_Int32 nIdleState (tools::IdleDetection::GetIdleState());
+        if (nIdleState != tools::IdleDetection::IDET_IDLE)
+        {
+            if (nIdleState&tools::IdleDetection::IDET_FULL_SCREEN_SHOW_ACTIVE != 0)
+                bIsShowingFullScreenShow = true;
+            break;
+        }
+
         RequestData* pRequest = NULL;
         int nPriorityClass = 0;
         bool bRequestIsValid = false;
@@ -210,7 +224,8 @@ template <class Queue, 
             {
                 ::osl::MutexGuard aGuard (maMutex);
                 // Create a new preview bitmap and store it in the cache.
-                BitmapEx aBitmap (maBitmapFactory.CreateBitmap (*pRequest));
+
+				BitmapEx aBitmap (maBitmapFactory.CreateBitmap (*pRequest));
                 mrCache.SetBitmap (
                     pRequest->GetPage(),
                     aBitmap,
@@ -234,7 +249,10 @@ template <class Queue, 
     }
 
     if ( ! mrQueue.IsEmpty())
-        Start(mrQueue.GetFrontPriorityClass());
+        if (bIsShowingFullScreenShow)
+            Start(mnTimeBetweenRequestsWhenNotIdle);
+        else
+            Start(mrQueue.GetFrontPriorityClass());
 }
 
 
Index: sd/source/ui/slidesorter/controller/SlsFocusManager.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/slidesorter/controller/SlsFocusManager.cxx,v
retrieving revision 1.3
retrieving revision 1.3.16.1
diff -u -p -u -p -r1.3 -r1.3.16.1
--- sd/source/ui/slidesorter/controller/SlsFocusManager.cxx	13 Jan 2005 17:28:15 -0000	1.3
+++ sd/source/ui/slidesorter/controller/SlsFocusManager.cxx	28 Jan 2005 09:17:16 -0000	1.3.16.1
@@ -239,8 +239,11 @@ bool FocusManager::IsFocusShowing (void)
 
 void FocusManager::HideFocusIndicator (model::PageDescriptor* pDescriptor)
 {
-    pDescriptor->RemoveFocus();
-    mrController.GetView().RequestRepaint (*pDescriptor);
+	if( pDescriptor )
+	{
+	    pDescriptor->RemoveFocus();
+		mrController.GetView().RequestRepaint (*pDescriptor);
+	}
 }
 
 
Index: sd/source/ui/slidesorter/controller/SlsSelectionFunction.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/slidesorter/controller/SlsSelectionFunction.cxx,v
retrieving revision 1.12
retrieving revision 1.12.14.1
diff -u -p -u -p -r1.12 -r1.12.14.1
--- sd/source/ui/slidesorter/controller/SlsSelectionFunction.cxx	13 Jan 2005 17:28:33 -0000	1.12
+++ sd/source/ui/slidesorter/controller/SlsSelectionFunction.cxx	27 Jan 2005 17:05:34 -0000	1.12.14.1
@@ -801,6 +801,8 @@ void SelectionFunction::ProcessMouseEven
 
     mrController.GetPageSelector().DisableBroadcasting();
     bool bMakeSelectionVisible = true;
+    if (nEventType==BUTTON_DOWN)
+        mbPageHit = (pHitPage!=NULL);
 
     // 2a. Set the focus to the slide under the mouse.
     if (pHitPage != NULL)
@@ -814,7 +816,6 @@ void SelectionFunction::ProcessMouseEven
         // Simple single selection.
         case BUTTON_DOWN | LEFT_BUTTON | SINGLE_CLICK | OVER_UNSELECTED_PAGE:
         case BUTTON_UP | LEFT_BUTTON | SINGLE_CLICK | OVER_SELECTED_PAGE:
-            mbPageHit = true;
             // Without the shift key the selection is set to only the page
             // object under the mouse. The center pane is switched to the
             // edit view that shows the elected slide when the slide sorter
@@ -844,13 +845,11 @@ void SelectionFunction::ProcessMouseEven
 
         // Multi selection with the control modifier.
         case BUTTON_UP | LEFT_BUTTON | SINGLE_CLICK | OVER_SELECTED_PAGE | CONTROL_MODIFIER:
-            mbPageHit = true;
             DeselectHitPage(*pHitDescriptor);
             PrepareMouseMotion(pWindow->PixelToLogic(aMousePosition));
             break;
 
         case BUTTON_UP | LEFT_BUTTON | SINGLE_CLICK | OVER_UNSELECTED_PAGE | CONTROL_MODIFIER:
-            mbPageHit = true;
             SelectHitPage(*pHitDescriptor);
             PrepareMouseMotion(pWindow->PixelToLogic(aMousePosition));
             break;
Index: sd/source/ui/slidesorter/inc/view/SlsViewOverlay.hxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/slidesorter/inc/view/SlsViewOverlay.hxx,v
retrieving revision 1.4
retrieving revision 1.4.72.1
diff -u -p -u -p -r1.4 -r1.4.72.1
--- sd/source/ui/slidesorter/inc/view/SlsViewOverlay.hxx	26 Nov 2004 15:12:40 -0000	1.4
+++ sd/source/ui/slidesorter/inc/view/SlsViewOverlay.hxx	28 Jan 2005 18:51:58 -0000	1.4.72.1
@@ -107,6 +107,7 @@ public:
     virtual void Hide (void);
     void Toggle (void);
     bool IsShowing (void);
+    ViewOverlay& GetViewOverlay (void);
 
 protected:
     ::osl::Mutex maMutex;
@@ -263,16 +264,17 @@ public:
 
     void Paint (void);
 
-    /** The overlay type describes how an overlay is painted.  That can be
+    /** The overlay paint type describes how an overlay is painted.  That can be
         either by using XOR operation or by doing a regular paint.
     */
     enum OverlayPaintType { OPT_ALL, OPT_XOR, OPT_PAINT };
 
-    /** As a preparation for a scrolling--or some other kind of action that
-        changes the map mode of a window--this method saves the current
-        state of all overlays so that the next call to Restore() can restore
-        them.  After that it hides the overlays so they do not corrupt the
-        window during the scrolling does.
+    /** As a preparation for draw operations that are not caused by the
+        overlays this method saves the current state of all overlays so that
+        the next call to Restore() can restore them.  After that it hides
+        the overlays so they do not interfere with the drawing operations.
+        @param eType
+            This parameter specifies what overlays to hide.
     */
     void HideAndSave (OverlayPaintType eType = OPT_ALL);
     
Index: sd/source/ui/slidesorter/shell/SlideSorterViewShell.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/slidesorter/shell/SlideSorterViewShell.cxx,v
retrieving revision 1.6
retrieving revision 1.6.72.1
diff -u -p -u -p -r1.6 -r1.6.72.1
--- sd/source/ui/slidesorter/shell/SlideSorterViewShell.cxx	26 Nov 2004 20:22:48 -0000	1.6
+++ sd/source/ui/slidesorter/shell/SlideSorterViewShell.cxx	28 Jan 2005 09:17:54 -0000	1.6.72.1
@@ -378,6 +378,14 @@ void SlideSorterViewShell::LoseFocus (vo
 
 
 
+SdPage* SlideSorterViewShell::getCurrentPage(void) const
+{
+	// since SlideSorterViewShell::GetActualPage() currently also
+	// returns master pages, which is a wrong behaviour for GetActualPage(),
+	// we can just use that for now
+	return const_cast<SlideSorterViewShell*>(this)->GetActualPage();
+}
+
 SdPage*	SlideSorterViewShell::GetActualPage (void)
 {
     return mpSlideSorterController->GetActualPage();
Index: sd/source/ui/slidesorter/view/SlideSorterView.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/slidesorter/view/SlideSorterView.cxx,v
retrieving revision 1.5
retrieving revision 1.5.62.1
diff -u -p -u -p -r1.5 -r1.5.62.1
--- sd/source/ui/slidesorter/view/SlideSorterView.cxx	9 Dec 2004 16:12:01 -0000	1.5
+++ sd/source/ui/slidesorter/view/SlideSorterView.cxx	28 Jan 2005 18:52:33 -0000	1.5.62.1
@@ -515,7 +515,7 @@ void SlideSorterView::CompleteRedraw (
     // it remember the request for a redraw.  The overlay is hidden during
     // this call and restored afterwards so that its XOR painting works
     // properly.
-    GetOverlay().HideAndSave();
+    GetOverlay().HideAndSave(ViewOverlay::OPT_PAINT);
     View::CompleteRedraw (pDevice, rPaintArea, pRedirector);
     GetOverlay().Restore();
 }
Index: sd/source/ui/slidesorter/view/SlsViewOverlay.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/slidesorter/view/SlsViewOverlay.cxx,v
retrieving revision 1.4
retrieving revision 1.4.70.1
diff -u -p -u -p -r1.4 -r1.4.70.1
--- sd/source/ui/slidesorter/view/SlsViewOverlay.cxx	26 Nov 2004 15:13:08 -0000	1.4
+++ sd/source/ui/slidesorter/view/SlsViewOverlay.cxx	28 Jan 2005 18:53:05 -0000	1.4.70.1
@@ -79,23 +79,36 @@ namespace {
 class ShowingModeGuard
 {
 public:
-    explicit ShowingModeGuard (::sd::slidesorter::view::OverlayBase& rOverlay) 
+    explicit ShowingModeGuard (::sd::slidesorter::view::OverlayBase& rOverlay,
+        bool bHideAndSave = false) 
         : mrOverlay (rOverlay),
-          mbIsShowing (mrOverlay.IsShowing())
+          mbIsShowing (mrOverlay.IsShowing()),
+          mbRestorePending(false)
     {
         if (mbIsShowing)
+            if (bHideAndSave)
+            {
+                mrOverlay.GetViewOverlay().HideAndSave (
+                    ::sd::slidesorter::view::ViewOverlay::OPT_XOR);
+                mbRestorePending = true;
+            }
             mrOverlay.Hide();
     }
 
     ~ShowingModeGuard (void)
     {
         if (mbIsShowing)
+        {
             mrOverlay.Show();
+            if (mbRestorePending)
+                mrOverlay.GetViewOverlay().Restore ();
+        }
     }
 
 private:
     ::sd::slidesorter::view::OverlayBase& mrOverlay;
     bool mbIsShowing;
+    bool mbRestorePending;
 };
 }
 
@@ -202,11 +215,19 @@ void ViewOverlay::HideAndSave (OverlayPa
         // Hide the overlays.
         if (eType==OPT_ALL || eType==OPT_XOR)
         {
-            maSelectionRectangleOverlay.Hide();
-            maSubstitutionOverlay.Hide();
+            if (mbSelectionRectangleWasVisible)
+                maSelectionRectangleOverlay.Hide();
         }
+        if (mbSubstitutionDisplayWasVisible)
+            maSubstitutionOverlay.Hide();
+        
         if (eType==OPT_ALL || eType==OPT_PAINT)
-            maInsertionIndicatorOverlay.Hide();
+        {
+            if (mbMouseOverIndicatorWasVisible)
+                maMouseOverIndicatorOverlay.Hide();
+            if (mbInsertionIndicatorWasVisible)
+                maInsertionIndicatorOverlay.Hide();
+        }
     }
 }
 
@@ -224,10 +245,10 @@ void ViewOverlay::Restore (void)
             if (mbMouseOverIndicatorWasVisible)
                 maMouseOverIndicatorOverlay.Show();
         }
+        if (mbSubstitutionDisplayWasVisible)
+            maSubstitutionOverlay.Show();
         if (meSavedStateType==OPT_ALL || meSavedStateType==OPT_XOR)
         {
-            if (mbSubstitutionDisplayWasVisible)
-                maSubstitutionOverlay.Show();
             if (mbSelectionRectangleWasVisible)
                 maSelectionRectangleOverlay.Show();
         }
@@ -256,7 +277,6 @@ OverlayBase::~OverlayBase (void)
 
 
 void OverlayBase::Paint (void)
-
 {
 }
 
@@ -306,6 +326,14 @@ void OverlayBase::Hide (void)
 
 
 
+ViewOverlay& OverlayBase::GetViewOverlay (void)
+{
+    return mrViewOverlay;
+}
+
+
+
+
 //=====  SubstitutionOverlay  =================================================
 
 SubstitutionOverlay::SubstitutionOverlay (ViewOverlay& rViewOverlay)
@@ -426,9 +454,12 @@ void SelectionRectangleOverlay::Paint (v
 
 void SelectionRectangleOverlay::Show (void)
 {
-    Start (maAnchor);
-    Update (maSecondCorner);
-    OverlayBase::Show();
+    if ( ! mbIsShowing)
+    {
+        Start (maAnchor);
+        Update (maSecondCorner);
+        OverlayBase::Show();
+    }
 }
 
 
@@ -436,8 +467,11 @@ void SelectionRectangleOverlay::Show (vo
 
 void SelectionRectangleOverlay::Hide (void)
 {
-	mrViewOverlay.GetViewShell().GetSlideSorterController().GetView().EndEncirclement();
-    OverlayBase::Hide();
+    if (mbIsShowing)
+    {
+        mrViewOverlay.GetViewShell().GetSlideSorterController().GetView().EndEncirclement();
+        OverlayBase::Hide();
+    }
 }
 
 
@@ -487,20 +521,9 @@ void InsertionIndicatorOverlay::SetPosit
 {
     if (maBoundingBox != aNewBoundingBox)
     {
-        bool bIsShowing = IsShowing();
-        if (bIsShowing)
-        {
-            mrViewOverlay.HideAndSave (ViewOverlay::OPT_XOR);
-            Hide();
-        }
+        ShowingModeGuard aGuard (*this, true);
 
         maBoundingBox = aNewBoundingBox;
-
-        if (bIsShowing)
-        {
-            Show();
-            mrViewOverlay.Restore ();
-        }
     }
 }
 
@@ -511,9 +534,9 @@ void InsertionIndicatorOverlay::Paint (v
 {
     Color aColor;
     if (mbIsShowing)
-        aColor =Application::GetSettings().GetStyleSettings().GetFontColor();
+        aColor = Application::GetSettings().GetStyleSettings().GetFontColor();
     else
-        aColor =Application::GetSettings().GetStyleSettings().GetWindowColor();
+        aColor = Application::GetSettings().GetStyleSettings().GetWindowColor();
     mrViewOverlay.GetViewShell().DrawFilledRect (
         maBoundingBox,
         aColor, 
@@ -620,7 +643,7 @@ void MouseOverIndicatorOverlay::SetSlide
 {
     if (mpPageUnderMouse != pDescriptor)
     {
-        ShowingModeGuard aGuard (*this);
+        ShowingModeGuard aGuard (*this, true);
 
         mpPageUnderMouse = pDescriptor;
     }
Index: sd/source/ui/toolpanel/TaskPaneViewShell.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/toolpanel/TaskPaneViewShell.cxx,v
retrieving revision 1.5
retrieving revision 1.5.72.1
diff -u -p -u -p -r1.5 -r1.5.72.1
--- sd/source/ui/toolpanel/TaskPaneViewShell.cxx	26 Nov 2004 20:24:37 -0000	1.5
+++ sd/source/ui/toolpanel/TaskPaneViewShell.cxx	28 Jan 2005 09:21:22 -0000	1.5.72.1
@@ -559,6 +559,10 @@ SdPage*	TaskPaneViewShell::GetActualPage
     return NULL;
 }
 
+SdPage*	TaskPaneViewShell::getCurrentPage(void) const
+{
+    return NULL;
+}
 
 
 
Index: sd/source/ui/toolpanel/controls/MasterPageContainer.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/toolpanel/controls/MasterPageContainer.cxx,v
retrieving revision 1.7
retrieving revision 1.7.112.1
diff -u -p -u -p -r1.7 -r1.7.112.1
--- sd/source/ui/toolpanel/controls/MasterPageContainer.cxx	28 Oct 2004 13:31:57 -0000	1.7
+++ sd/source/ui/toolpanel/controls/MasterPageContainer.cxx	25 Jan 2005 10:51:01 -0000	1.7.112.1
@@ -126,6 +126,7 @@
 #include "stlpool.hxx"
 #include "unmovss.hxx"
 #include "sdresid.hxx"
+#include "tools/IdleDetection.hxx"
 
 using namespace ::com::sun::star;
 using namespace ::com::sun::star::uno;
@@ -293,6 +294,7 @@ public:
 
 private:
     Timer maDelayedPreviewCreationTimer;
+
     /** Use a vector for the queue so that we can iterate over all
         elements and remove those that became invalid.
     */
@@ -305,6 +307,9 @@ private:
 
     /// The time to wait (in milliseconds) between the creation of previews.
     static const int DELAYED_CREATION_TIMEOUT=250;
+    /// The time to wait when the system is not idle.
+    static const int DELAYED_CREATION_TIMEOUT_WHEN_NOT_IDLE=1000;
+
     DECL_LINK(DelayedPreviewCreation, Timer *);
     ::sd::DrawDocShell* LoadDocument (
         const String& sFileName,
@@ -691,8 +696,19 @@ IMPL_LINK(MasterPageContainer::Implement
     DelayedPreviewCreation, 
     Timer*, pTimer)
 {
-    while (maRequestQueue.size()>0 && ! GetpApp()->AnyInput())
+    bool bIsShowingFullScreenShow (true);
+
+    while (maRequestQueue.size() > 0)
     {
+        // First check whether the system is idle.
+        sal_Int32 nIdleState (tools::IdleDetection::GetIdleState());
+        if (nIdleState != tools::IdleDetection::IDET_IDLE)
+        {
+            if (nIdleState&tools::IdleDetection::IDET_FULL_SCREEN_SHOW_ACTIVE != 0)
+                bIsShowingFullScreenShow = true;
+            break;
+        }
+
         PreviewCreationRequest aRequest (maRequestQueue.front());
         maRequestQueue.pop();
 
@@ -708,7 +724,13 @@ IMPL_LINK(MasterPageContainer::Implement
     }
 
     if (maRequestQueue.size() > 0)
+    {
+        if (bIsShowingFullScreenShow)
+            maDelayedPreviewCreationTimer.SetTimeout (DELAYED_CREATION_TIMEOUT_WHEN_NOT_IDLE);
+        else
+            maDelayedPreviewCreationTimer.SetTimeout (DELAYED_CREATION_TIMEOUT);
         pTimer->Start();
+    }
 
     return 0;
 }
Index: sd/source/ui/tools/IdleDetection.cxx
===================================================================
RCS file: sd/source/ui/tools/IdleDetection.cxx
diff -N sd/source/ui/tools/IdleDetection.cxx
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ sd/source/ui/tools/IdleDetection.cxx	25 Jan 2005 10:35:31 -0000	1.1.2.1
@@ -0,0 +1,138 @@
+/*************************************************************************
+ *
+ *  $RCSfile$
+ *
+ *  $Revision$
+ *
+ *  last change: $Author$ $Date$
+ *
+ *  The Contents of this file are made available subject to the terms of
+ *  either of the following licenses
+ *
+ *         - GNU Lesser General Public License Version 2.1
+ *         - Sun Industry Standards Source License Version 1.1
+ *
+ *  Sun Microsystems Inc., October, 2000
+ *
+ *  GNU Lesser General Public License Version 2.1
+ *  =============================================
+ *  Copyright 2000 by Sun Microsystems, Inc.
+ *  901 San Antonio Road, Palo Alto, CA 94303, USA
+ *
+ *  This library is free software; you can redistribute it and/or
+ *  modify it under the terms of the GNU Lesser General Public
+ *  License version 2.1, as published by the Free Software Foundation.
+ *
+ *  This library is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ *  Lesser General Public License for more details.
+ *
+ *  You should have received a copy of the GNU Lesser General Public
+ *  License along with this library; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston,
+ *  MA  02111-1307  USA
+ *
+ *
+ *  Sun Industry Standards Source License Version 1.1
+ *  =================================================
+ *  The contents of this file are subject to the Sun Industry Standards
+ *  Source License Version 1.1 (the "License"); You may not use this file
+ *  except in compliance with the License. You may obtain a copy of the
+ *  License at http://www.openoffice.org/license.html.
+ *
+ *  Software provided under this License is provided on an "AS IS" basis,
+ *  WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING,
+ *  WITHOUT LIMITATION, WARRANTIES THAT THE SOFTWARE IS FREE OF DEFECTS,
+ *  MERCHANTABLE, FIT FOR A PARTICULAR PURPOSE, OR NON-INFRINGING.
+ *  See the License for the specific provisions governing your rights and
+ *  obligations concerning the Software.
+ *
+ *  The Initial Developer of the Original Code is: Sun Microsystems, Inc.
+ *
+ *  Copyright: 2000 by Sun Microsystems, Inc.
+ *
+ *  All Rights Reserved.
+ *
+ *  Contributor(s): _______________________________________
+ *
+ *
+ ************************************************************************/
+
+#include "tools/IdleDetection.hxx"
+
+#include "ViewShell.hxx"
+#include "slideshow.hxx"
+#include "ViewShellBase.hxx"
+
+#include <sfx2/viewfrm.hxx>
+
+#include <com/sun/star/frame/XFrame.hdl>
+
+using namespace ::com::sun::star;
+
+namespace sd { namespace tools {
+
+
+sal_Int32 IdleDetection::GetIdleState (void)
+{
+    return CheckInputPending() | CheckSlideShowRunning();
+}
+
+
+
+
+sal_Int32 IdleDetection::CheckInputPending (void)
+{
+    if (GetpApp()->AnyInput())
+        return IDET_SYSTEM_EVENT_PENDING;
+    else
+        return IDET_IDLE;
+}
+
+
+
+
+sal_Int32 IdleDetection::CheckSlideShowRunning (void)
+{
+    sal_Int32 eResult (IDET_IDLE);
+    
+	bool bIsSlideShowShowing = false;
+
+	// Iterate over all view frames.
+	SfxViewFrame* pViewFrame = SfxViewFrame::GetFirst();
+	for (pViewFrame = SfxViewFrame::GetFirst();
+         pViewFrame!=NULL && !bIsSlideShowShowing;
+         pViewFrame = SfxViewFrame::GetNext(*pViewFrame))
+    {
+        // Check whether the frame is the active one.
+        uno::Reference<frame::XFrame> xFrame (pViewFrame->GetFrame()->GetFrameInterface());
+        if (xFrame.is() && ! xFrame->isActive())
+        {
+            // Frames that are not active are ignored.
+            continue;
+        }
+
+		// Get sd::ViewShell from active frame.
+		ViewShellBase* pBase = ViewShellBase::GetViewShellBase(pViewFrame);
+		if (pBase != NULL)
+		{
+			ViewShell* pViewShell = pBase->GetMainViewShell();
+			// Test whether the view shell has a running full screen
+			// show.
+			Slideshow* pSlideShow = pViewShell->GetSlideShow();
+			if (pSlideShow != NULL)
+			{
+				if (pSlideShow->isFullScreen())
+                    eResult |= IDET_FULL_SCREEN_SHOW_ACTIVE;
+                else
+                    eResult |= IDET_WINDOW_SHOW_ACTIVE;
+			}
+		}
+	}
+
+	return eResult;
+}
+
+
+} } // end of namespace ::sd::tools
Index: sd/source/ui/tools/makefile.mk
===================================================================
RCS file: /cvs/graphics/sd/source/ui/tools/makefile.mk,v
retrieving revision 1.4
retrieving revision 1.4.72.1
diff -u -p -u -p -r1.4 -r1.4.72.1
--- sd/source/ui/tools/makefile.mk	26 Nov 2004 20:27:16 -0000	1.4
+++ sd/source/ui/tools/makefile.mk	25 Jan 2005 10:45:05 -0000	1.4.72.1
@@ -80,6 +80,7 @@ AUTOSEG=true
 
 SLOFILES =      							\
 	$(SLO)$/IconCache.obj					\
+	$(SLO)$/IdleDetection.obj				\
 	$(SLO)$/EventMultiplexer.obj			\
 	$(SLO)$/PreviewRenderer.obj				\
 	$(SLO)$/SdGlobalResourceContainer.obj
Index: sd/source/ui/unoidl/unopage.hxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/unoidl/unopage.hxx,v
retrieving revision 1.10
retrieving revision 1.10.72.1
diff -u -p -u -p -r1.10 -r1.10.72.1
--- sd/source/ui/unoidl/unopage.hxx	26 Nov 2004 20:29:18 -0000	1.10
+++ sd/source/ui/unoidl/unopage.hxx	25 Jan 2005 12:46:46 -0000	1.10.72.1
@@ -86,7 +86,7 @@
 #include <svtools/itemprop.hxx>
 #endif
 
-#ifndef _SVX_UNOWPAGE_HXX
+#ifndef _SVX_UNOPAGE_HXX
 #include <svx/unopage.hxx>
 #endif
 #ifndef _SVX_FMDPAGE_HXX
Index: sd/source/ui/view/PaneManager.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/view/PaneManager.cxx,v
retrieving revision 1.10
retrieving revision 1.10.16.1
diff -u -p -u -p -r1.10 -r1.10.16.1
--- sd/source/ui/view/PaneManager.cxx	14 Jan 2005 12:02:33 -0000	1.10
+++ sd/source/ui/view/PaneManager.cxx	26 Jan 2005 16:37:42 -0000	1.10.16.1
@@ -294,15 +294,13 @@ public:
         @param eType
             The requested type of the new view shell.
         @return
-            Returns a pointer to a view shell that meets the specified
-            requirements.  That is the existing shell when that has the
-            correct shell type, a new view shell or <NULL/> when it is not
-            possible to create a view shell for the given values then
-            <NULL/> is returned.  That is most probably the case when either
-            the shell type is invalid or the pane type is not (yet)
-            supported.
+            Returns whether the current shell has been replaced by one of
+            the requested type.  Reasons for returning <FALSE/>, i.e. that
+            the current shell is not replaced, are that the the current
+            shell is already of the requested type or that switching the
+            view shell is not possible at the moment.
     */
-    ViewShell* SetViewShellType (ViewShell::ShellType eType, bool bForce = false);
+    bool SetViewShellType (ViewShell::ShellType eType, bool bForce = false);
 
 private:
     PaneManager::PaneType mePane;
@@ -1004,7 +1002,7 @@ void PaneDescriptor::ShowWindow (void)
     objects bars onto the sub shell stack.
     3.) Create and initialize the new main sub shell.
 */
-ViewShell* PaneDescriptor::SetViewShellType (ViewShell::ShellType eShellType, bool bForceChange)
+bool PaneDescriptor::SetViewShellType (ViewShell::ShellType eShellType, bool bForceChange)
 {
     if (bForceChange
         || (mpViewShell==NULL && eShellType!=ViewShell::ST_NONE)
@@ -1062,9 +1060,13 @@ ViewShell* PaneDescriptor::SetViewShellT
             PaneManagerEvent::EID_VIEW_SHELL_ADDED, 
             mePane, 
             mpViewShell);
-    }
 
-    return mpViewShell;
+        // Tell the caller that the view shell in this pane has successfully
+        // been replaced.
+        return true;
+    }
+    else
+        return false;
 }
 
 
@@ -1884,21 +1886,16 @@ void PaneManager::Implementation::Update
         // First update the center pane.
         if ( ! bCenterUpToDate)
         {
-            // We have to remember the old shell to compare the new one
-            // against it.  This is to prevent updating the controller when
-            // just the window visibility is not as requested.
-            ViewShell* pOldShell = rCenterPane.GetViewShell();
-            // Switch the center pane to the requested view shell.  Use the
-            // provided call mode.
-            ViewShell* pShell = rCenterPane.SetViewShellType(eCenterType);
+            bool bIsShellReplaced = rCenterPane.SetViewShellType(eCenterType);
             // When the view shell in the center pane has changed we have to
             // update the controller of the ViewShellBase.  We do not do
             // this when the ViewShellBase is just being initialized.  In
             // that case the controller is set automatically.  Interfering
             // with that would be dangerous.
+            ViewShell* pShell = rCenterPane.GetViewShell();
             if (mbIsInitialized 
                 && pShell!=NULL
-                && pShell!=pOldShell)
+                && bIsShellReplaced)
             {
                 mrBase.UpdateController(pShell->GetController());
             }
Index: sd/source/ui/view/drviews1.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/view/drviews1.cxx,v
retrieving revision 1.48
retrieving revision 1.48.68.1
diff -u -p -u -p -r1.48 -r1.48.68.1
--- sd/source/ui/view/drviews1.cxx	26 Nov 2004 20:30:41 -0000	1.48
+++ sd/source/ui/view/drviews1.cxx	28 Jan 2005 09:14:43 -0000	1.48.68.1
@@ -806,6 +806,28 @@ IMPL_LINK( DrawViewShell, TabSplitHdl, T
 	return 0;
 }
 
+/// inherited from sd::ViewShell
+SdPage* DrawViewShell::getCurrentPage() const
+{
+	const sal_Int32 nPageCount = (eEditMode == EM_PAGE)?
+									GetDoc()->GetSdPageCount(ePageKind):
+									GetDoc()->GetMasterSdPageCount(ePageKind);
+
+	sal_Int32 nCurrentPage = aTabControl.GetCurPageId() - 1;
+	DBG_ASSERT( (nPageCount>0) && (nCurrentPage<nPageCount), "sd::DrawViewShell::getCurrentPage(), illegal page index!" );
+	if( (nPageCount < 0) || (nCurrentPage>=nPageCount) )
+		nCurrentPage = 0; // play safe here
+
+	if (eEditMode == EM_PAGE)
+	{
+		return GetDoc()->GetSdPage(nCurrentPage, ePageKind);
+	}
+	else // EM_MASTERPAGE
+	{
+		return GetDoc()->GetMasterSdPage(nCurrentPage, ePageKind);
+	}
+}
+
 /*************************************************************************
 |*
 |* neue aktuelle Seite auswaehlen, falls sich die Seitenfolge geaendert
Index: sd/source/ui/view/drviews7.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/view/drviews7.cxx,v
retrieving revision 1.54
retrieving revision 1.54.70.1
diff -u -p -u -p -r1.54 -r1.54.70.1
--- sd/source/ui/view/drviews7.cxx	26 Nov 2004 20:32:02 -0000	1.54
+++ sd/source/ui/view/drviews7.cxx	24 Jan 2005 16:59:49 -0000	1.54.70.1
@@ -194,6 +194,7 @@
 #include "LayerTabBar.hxx"
 #include "fupoor.hxx"
 #include "Window.hxx"
+#include "fuediglu.hxx"
 
 using namespace ::rtl;
 using namespace ::com::sun::star;
@@ -491,9 +492,14 @@ void DrawViewShell::GetMenuState( SfxIte
 	}
 
 	if (!pDrView->IsFrameDragSingles())
-	{
         rSet.Put(SfxBoolItem(SID_BEZIER_EDIT, TRUE));
-    }
+    else
+        rSet.Put(SfxBoolItem(SID_BEZIER_EDIT, FALSE));
+
+    if (pFuActual!=NULL && pFuActual->ISA(FuEditGluePoints))
+        rSet.Put(SfxBoolItem(SID_GLUE_EDITMODE, TRUE));
+    else
+        rSet.Put(SfxBoolItem(SID_GLUE_EDITMODE, FALSE));
 
     if( !pDrView->IsMirrorAllowed( TRUE, TRUE ) )
 	{
Index: sd/source/ui/view/outlnvsh.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/view/outlnvsh.cxx,v
retrieving revision 1.61
retrieving revision 1.61.24.1
diff -u -p -u -p -r1.61 -r1.61.24.1
--- sd/source/ui/view/outlnvsh.cxx	11 Jan 2005 12:13:20 -0000	1.61
+++ sd/source/ui/view/outlnvsh.cxx	28 Jan 2005 09:14:44 -0000	1.61.24.1
@@ -1959,6 +1959,13 @@ void OutlineViewShell::MouseButtonUp(con
 	*/
 }
 
+SdPage* OutlineViewShell::getCurrentPage() const
+{
+	// since there are no master pages in outline view, we can
+	// for now use the GetActualPage method
+	return const_cast<OutlineViewShell*>(this)->GetActualPage();
+}
+
 /*************************************************************************
 |*
 |* Liefert die erste selektierte Seite zurueck.
Index: sd/source/ui/view/slidvish.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/view/slidvish.cxx,v
retrieving revision 1.49
retrieving revision 1.49.70.1
diff -u -p -u -p -r1.49 -r1.49.70.1
--- sd/source/ui/view/slidvish.cxx	26 Nov 2004 20:35:26 -0000	1.49
+++ sd/source/ui/view/slidvish.cxx	28 Jan 2005 09:14:44 -0000	1.49.70.1
@@ -1740,6 +1740,13 @@ void SlideViewShell::DrawFocusRect( USHO
 
 // -----------------------------------------------------------------------------
 
+SdPage* SlideViewShell::getCurrentPage() const
+{
+	return const_cast<SlideViewShell*>(this)->GetActualPage();
+}
+
+// -----------------------------------------------------------------------------
+
 SdPage* SlideViewShell::GetActualPage()
 {
 	SdPage* pPage;
Index: sd/uiconfig/simpress/toolbar/drawingobjectbar.xml
===================================================================
RCS file: /cvs/graphics/sd/uiconfig/simpress/toolbar/drawingobjectbar.xml,v
retrieving revision 1.3
retrieving revision 1.3.72.1
diff -u -p -u -p -r1.3 -r1.3.72.1
--- sd/uiconfig/simpress/toolbar/drawingobjectbar.xml	26 Nov 2004 19:47:56 -0000	1.3
+++ sd/uiconfig/simpress/toolbar/drawingobjectbar.xml	24 Jan 2005 15:46:43 -0000	1.3.72.1
@@ -17,6 +17,5 @@
  <toolbar:toolbaritem xlink:href=".uno:FillStyle" toolbar:helpid="10164"/>
  <toolbar:toolbarseparator/>
  <toolbar:toolbaritem xlink:href=".uno:FillShadow" toolbar:helpid="10299"/>
- <toolbar:toolbaritem xlink:href=".uno:CommonTaskBarVisible" toolbar:helpid="5928"/>
  <toolbar:toolbaritem xlink:href=".uno:ImageMapDialog" toolbar:visible="false" toolbar:helpid="10371"/>
 </toolbar:toolbar>
\ No newline at end of file
Index: sd/uiconfig/simpress/toolbar/toolbar.xml
===================================================================
RCS file: /cvs/graphics/sd/uiconfig/simpress/toolbar/toolbar.xml,v
retrieving revision 1.5
retrieving revision 1.5.72.1
diff -u -p -u -p -r1.5 -r1.5.72.1
--- sd/uiconfig/simpress/toolbar/toolbar.xml	27 Nov 2004 14:51:28 -0000	1.5
+++ sd/uiconfig/simpress/toolbar/toolbar.xml	24 Jan 2005 15:46:11 -0000	1.5.72.1
@@ -40,7 +40,7 @@
  <toolbar:toolbaritem xlink:href=".uno:Config" toolbar:helpid="helpid:10593" toolbar:text="" toolbar:style="dropdown" toolbar:visible="false" />
  <toolbar:toolbarseparator/>
  <toolbar:toolbaritem xlink:href=".uno:ExtrusionToggle" toolbar:helpid="10960"/>
- <toolbar:toolbaritem xlink:href=".uno:CustomAnimation" toolbar:helpid="helpid:27328" toolbar:text="" toolbar:style="auto" />
+ <toolbar:toolbaritem xlink:href=".uno:CustomAnimation" toolbar:helpid="helpid:27328" toolbar:text="" toolbar:style="auto" toolbar:visible="false" />
  <toolbar:toolbaritem xlink:href=".uno:AnimationEffects" toolbar:helpid="helpid:27063" toolbar:text="" />
  <toolbar:toolbaritem xlink:href=".uno:AnimationObjects" toolbar:helpid="helpid:27062" toolbar:text="" toolbar:style="auto" toolbar:visible="false" />
  <toolbar:toolbaritem xlink:href=".uno:Window3D" toolbar:helpid="helpid:10644" toolbar:text="" toolbar:style="auto" toolbar:visible="false" />
Index: sd/xml/effects.xml
===================================================================
RCS file: /cvs/graphics/sd/xml/effects.xml,v
retrieving revision 1.2
retrieving revision 1.2.72.1
diff -u -p -u -p -r1.2 -r1.2.72.1
--- sd/xml/effects.xml	26 Nov 2004 20:37:41 -0000	1.2
+++ sd/xml/effects.xml	28 Jan 2005 14:17:53 -0000	1.2.72.1
@@ -1003,9 +1003,9 @@
     <anim:par smil:begin="indefinite" smil:fill="hold">
     <anim:par smil:begin="0" smil:fill="hold">
     <anim:par smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="emphasis" pres:preset-id="ooo-emphasis-complementary-color">
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="fill-color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="stroke-color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="color" smil:by="hsl(120,0%,0%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="fill-color" smil:by="hsl(120,0%,0%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="stroke-color" smil:by="hsl(120,0%,0%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
         <anim:set smil:dur="0.5" smil:fill="hold" smil:attributeName="fill" smil:to="solid"/>
     </anim:par>
     </anim:par>
@@ -1013,9 +1013,9 @@
     <anim:par smil:begin="indefinite" smil:fill="hold">
     <anim:par smil:begin="0" smil:fill="hold">
     <anim:par smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="emphasis" pres:preset-id="ooo-emphasis-complementary-color-2">
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="fill-color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="stroke-color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="color" smil:by="hsl(-120,0%,0%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="fill-color" smil:by="hsl(-120,0%,0%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="stroke-color" smil:by="hsl(-120,0%,0%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
         <anim:set smil:dur="0.5" smil:fill="hold" smil:attributeName="fill" smil:to="solid"/>
     </anim:par>
     </anim:par>
@@ -1023,9 +1023,9 @@
     <anim:par smil:begin="indefinite" smil:fill="hold">
     <anim:par smil:begin="0" smil:fill="hold">
     <anim:par smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="emphasis" pres:preset-id="ooo-emphasis-contrasting-color">
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="fill-color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="stroke-color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="color" smil:by="hsl(180,0%,0%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="fill-color" smil:by="hsl(180,0%,0%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="stroke-color" smil:by="hsl(180,0%,0%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
         <anim:set smil:dur="0.5" smil:fill="hold" smil:attributeName="fill" smil:to="solid"/>
     </anim:par>
     </anim:par>
@@ -1033,9 +1033,9 @@
     <anim:par smil:begin="indefinite" smil:fill="hold">
     <anim:par smil:begin="0" smil:fill="hold">
     <anim:par smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="emphasis" pres:preset-id="ooo-emphasis-darken">
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="fill-color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="stroke-color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="color" smil:by="hsl(0,-12%,-25%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="fill-color" smil:by="hsl(0,-12%,-25%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="stroke-color" smil:by="hsl(0,-12%,-25%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
         <anim:set smil:dur="0.5" smil:fill="hold" smil:attributeName="fill" smil:to="solid"/>
     </anim:par>
     </anim:par>
@@ -1043,9 +1043,9 @@
     <anim:par smil:begin="indefinite" smil:fill="hold">
     <anim:par smil:begin="0" smil:fill="hold">
     <anim:par smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="emphasis" pres:preset-id="ooo-emphasis-desaturate">
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="fill-color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="stroke-color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="color" smil:by="hsl(0,-70%,0%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="fill-color" smil:by="hsl(0,-70%,0%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="stroke-color" smil:by="hsl(0,-70%,0%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
         <anim:set smil:dur="0.5" smil:fill="hold" smil:attributeName="fill" smil:to="solid"/>
     </anim:par>
     </anim:par>
@@ -1061,9 +1061,9 @@
     <anim:par smil:begin="indefinite" smil:fill="hold">
     <anim:par smil:begin="0" smil:fill="hold">
     <anim:par smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="emphasis" pres:preset-id="ooo-emphasis-lighten">
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="fill-color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
-        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="stroke-color" smil:by="" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="color" smil:by="hsl(0,12%,25%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="fill-color" smil:by="hsl(0,12%,25%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
+        <anim:animateColor smil:dur="0.5" smil:fill="hold" smil:attributeName="stroke-color" smil:by="hsl(0,12%,25%)" pres:additive="base" anim:color-interpolation="hsl" anim:color-interpolation-direction="clockwise"/>
         <anim:set smil:dur="0.5" smil:fill="hold" smil:attributeName="fill" smil:to="solid"/>
     </anim:par>
     </anim:par>
Index: svx/source/svdraw/svdoole2.cxx
===================================================================
RCS file: /cvs/graphics/svx/source/svdraw/svdoole2.cxx,v
retrieving revision 1.49
retrieving revision 1.49.42.1
diff -u -p -u -p -r1.49 -r1.49.42.1
--- svx/source/svdraw/svdoole2.cxx	18 Jan 2005 15:01:22 -0000	1.49
+++ svx/source/svdraw/svdoole2.cxx	28 Jan 2005 13:35:00 -0000	1.49.42.1
@@ -795,7 +795,7 @@ void SdrOle2Obj::SetModel(SdrModel* pNew
     DBG_ASSERT( pSrcPers || !mpImpl->mbConnected, "Connected object without a model?!" );
     RemoveListeners_Impl();
 
-    if( pDestPers && pSrcPers )
+    if( pDestPers && pSrcPers && !IsEmptyPresObj() )
     {
         // move the objects' storage; ObjectRef remains the same, but PersistName may change
         ::rtl::OUString aTmp;
@@ -822,7 +822,7 @@ void SdrOle2Obj::SetModel(SdrModel* pNew
 
     if( pDestPers )
     {
-        if ( !pSrcPers )
+        if ( !pSrcPers || IsEmptyPresObj() )
             // object wasn't connected, now it should
             Connect_Impl();
         else
