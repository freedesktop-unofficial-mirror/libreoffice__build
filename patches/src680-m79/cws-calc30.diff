Index: binfilter/bf_sc/source/core/data/sc_documen2.cxx
===================================================================
RCS file: /cvs/framework/binfilter/bf_sc/source/core/data/sc_documen2.cxx,v
retrieving revision 1.7
retrieving revision 1.7.68.1
diff -u -p -r1.7 -r1.7.68.1
--- binfilter/bf_sc/source/core/data/sc_documen2.cxx	3 Aug 2004 11:04:22 -0000	1.7
+++ binfilter/bf_sc/source/core/data/sc_documen2.cxx	10 Feb 2005 13:08:38 -0000	1.7.68.1
@@ -350,7 +350,7 @@ namespace binfilter {
 /*N*/ 		pEOFormulaTrack( NULL ),
 /*N*/ 		nFormulaTrackCount(0),
 /*N*/ 		bInsertingFromOtherDoc( FALSE ),
-/*N*/ 		bImportingXML( TRUE ),//STRIP004 bImportingXML( FALSE ),
+            bImportingXML( FALSE ),             // #i41083# this has to be set in ScXMLImport::startDocument
 /*N*/ 		nHardRecalcState(0),
 /*N*/ 		bCalcingAfterLoad( FALSE ),
 /*N*/ 		bNoListening( FALSE ),
Index: binfilter/bf_sc/source/ui/docshell/sc_docsh.cxx
===================================================================
RCS file: /cvs/framework/binfilter/bf_sc/source/ui/docshell/sc_docsh.cxx,v
retrieving revision 1.6
retrieving revision 1.6.26.2
diff -u -p -r1.6 -r1.6.26.2
--- binfilter/bf_sc/source/ui/docshell/sc_docsh.cxx	23 Dec 2004 10:42:00 -0000	1.6
+++ binfilter/bf_sc/source/ui/docshell/sc_docsh.cxx	10 Feb 2005 13:08:16 -0000	1.6.26.2
@@ -253,7 +253,8 @@ static const sal_Char __FAR_DATA pFilter
 /*N*/ 		*pFullTypeName	= String( ScResId( SCSTR_50_LONG_DOCNAME ) );
 /*N*/ 		*pShortTypeName	= String( ScResId( SCSTR_SHORT_SCDOC_NAME ) );
 /*N*/ 	}
-/*N*/ 	else if ( nFileFormat == SOFFICE_FILEFORMAT_60 )
+/*N*/ 	else if ( nFileFormat == SOFFICE_FILEFORMAT_60 ||
+                  nFileFormat == SOFFICE_FILEFORMAT_CURRENT )   // #i41083# also allow CURRENT
 /*N*/ 	{
 /*N*/ 		// for binfilter, we need the FormatIDs to be set. Not setting them
 			// has always been an error (!)
@@ -711,15 +712,16 @@ static const sal_Char __FAR_DATA pFilter
 //STRIP001     else
 //STRIP001 		aDocument.SetInsertingFromOtherDoc( FALSE );
 //STRIP001 
-//STRIP001 	aDocument.SetImportingXML( FALSE );
-//STRIP001 
-//STRIP001     if (pModificator)
-//STRIP001     {
-//STRIP001         delete pModificator;
-//STRIP001         pModificator = NULL;
-//STRIP001     }
-//STRIP001     else
-//STRIP001         DBG_ERROR("The Modificator should exist");
+            aDocument.SetInsertingFromOtherDoc( FALSE );
+            aDocument.SetImportingXML( FALSE );
+
+            if (pModificator)
+            {
+                delete pModificator;
+                pModificator = NULL;
+            }
+            else
+                DBG_ERROR("The Modificator should exist");
 /*N*/ }
 
 /*N*/ BOOL ScDocShell::LoadXML( SfxMedium* pMedium, SvStorage* pStor )
Index: binfilter/bf_xmloff/source/style/xmloff_xmlimppr.cxx
===================================================================
RCS file: /cvs/framework/binfilter/bf_xmloff/source/style/xmloff_xmlimppr.cxx,v
retrieving revision 1.3
retrieving revision 1.3.68.1
diff -u -p -r1.3 -r1.3.68.1
--- binfilter/bf_xmloff/source/style/xmloff_xmlimppr.cxx	3 Aug 2004 20:18:21 -0000	1.3
+++ binfilter/bf_xmloff/source/style/xmloff_xmlimppr.cxx	10 Feb 2005 09:52:34 -0000	1.3.68.1
@@ -332,8 +332,9 @@ void SvXMLImportPropertyMapper::importXM
 					if( -1 == nIndex )
 						nIndex = maPropMapper->FindEntryIndex( "TextUserDefinedAttributes", XML_NAMESPACE_TEXT, GetXMLToken(XML_XMLNS) );
 
-					OSL_ENSURE( nIndex != -1,
-								"not able to store alien attribute");
+                    // #i41083# no assertion because an extra attribute (writing-mode) is in
+                    // spreadsheet table styles, which don't have user defined attributes.
+                    // In normal xmloff, the assertion was removed for #i30395#.
 
                     // #106963#; use userdefined attribute only if it is in the specified property range
 					if( nIndex != -1 && nIndex >= nStartIdx && nIndex < nEndIdx)
Index: xmloff/inc/nmspmap.hxx
===================================================================
RCS file: /cvs/xml/xmloff/inc/nmspmap.hxx,v
retrieving revision 1.9
retrieving revision 1.9.44.1
diff -u -p -r1.9 -r1.9.44.1
--- xmloff/inc/nmspmap.hxx	11 Jan 2005 14:17:18 -0000	1.9
+++ xmloff/inc/nmspmap.hxx	18 Feb 2005 11:32:22 -0000	1.9.44.1
@@ -175,7 +175,8 @@ public:
 	const ::rtl::OUString& GetPrefixByKey( sal_uInt16 nKey ) const;
 
 	::rtl::OUString GetQNameByKey( sal_uInt16 nKey, 
-						   const ::rtl::OUString& rLocalName ) const;
+						   const ::rtl::OUString& rLocalName,
+                           sal_Bool bCache = sal_True) const;
 
 	::rtl::OUString GetAttrNameByKey( sal_uInt16 nKey ) const;
 
@@ -183,11 +184,13 @@ public:
 	sal_uInt16 _GetKeyByAttrName( const ::rtl::OUString& rAttrName,
 							 ::rtl::OUString *pPrefix,
 							 ::rtl::OUString *pLocalName,
-							 ::rtl::OUString *pNamespace = 0 ) const;
+							 ::rtl::OUString *pNamespace = 0,
+                             sal_Bool bCache = sal_True) const;
 
 	/* This will replace the version with the unused 3rd default parameter */
 	sal_uInt16 _GetKeyByAttrName( const ::rtl::OUString& rAttrName,
-							 ::rtl::OUString *pLocalName = 0 ) const;
+							 ::rtl::OUString *pLocalName = 0,
+                             sal_Bool bCache = sal_True) const;
 
 	sal_uInt16 GetFirstKey() const;
 	sal_uInt16 GetNextKey( sal_uInt16 nOldKey ) const;
Index: xmloff/inc/xmlnumfi.hxx
===================================================================
RCS file: /cvs/xml/xmloff/inc/xmlnumfi.hxx,v
retrieving revision 1.17
retrieving revision 1.17.44.1
diff -u -p -r1.17 -r1.17.44.1
--- xmloff/inc/xmlnumfi.hxx	11 Jan 2005 14:23:26 -0000	1.17
+++ xmloff/inc/xmlnumfi.hxx	15 Feb 2005 12:26:21 -0000	1.17.44.1
@@ -255,7 +255,8 @@ public:
 
 	SvXMLNumImpData* GetData() const				{ return pData; }
 	sal_Int32 GetKey();
-	void GetFormat(rtl::OUString& rFormatString, com::sun::star::lang::Locale& rLocale);
+    sal_Int32 CreateAndInsert( SvNumberFormatter* pFormatter );
+    sal_Int32 CreateAndInsert( com::sun::star::uno::Reference< com::sun::star::util::XNumberFormatsSupplier >& xFormatsSupplier );
 	sal_uInt16 GetType() const						{ return nType; }	// SvXMLStylesTokens
 
 	sal_Bool IsFromSystem() const					{ return bFromSystem; }
Index: xmloff/source/core/nmspmap.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/core/nmspmap.cxx,v
retrieving revision 1.12
retrieving revision 1.12.42.1
diff -u -p -r1.12 -r1.12.42.1
--- xmloff/source/core/nmspmap.cxx	14 Jan 2005 11:58:55 -0000	1.12
+++ xmloff/source/core/nmspmap.cxx	18 Feb 2005 11:32:36 -0000	1.12.42.1
@@ -244,7 +244,8 @@ OUString SvXMLNamespaceMap::GetAttrNameB
 }
 
 OUString SvXMLNamespaceMap::GetQNameByKey( sal_uInt16 nKey,
-							const OUString& rLocalName ) const
+							const OUString& rLocalName,
+                            sal_Bool bCache) const
 {
 	// We always want to return at least the rLocalName...
 
@@ -270,7 +271,11 @@ OUString SvXMLNamespaceMap::GetQNameByKe
 		break;
 		default:
 		{
-			QNameCache::const_iterator aQCacheIter = aQNameCache.find ( QNamePair ( nKey, &rLocalName ) );
+            QNameCache::const_iterator aQCacheIter;
+            if (bCache)
+			    aQCacheIter = aQNameCache.find ( QNamePair ( nKey, &rLocalName ) );
+            else
+                aQCacheIter = aQNameCache.end();
 			if ( aQCacheIter != aQNameCache.end() )
 				return (*aQCacheIter).second;
 			else
@@ -283,10 +288,15 @@ OUString SvXMLNamespaceMap::GetQNameByKe
 					sQName.append ( (*aIter).second->sPrefix);
 					sQName.append ( sal_Unicode(':') );
 					sQName.append ( rLocalName );
-                    OUString *pString = new OUString ( rLocalName );
-                    OUString sString = sQName.makeStringAndClear();
-                    const_cast < QNameCache * > (&aQNameCache)->operator[] ( QNamePair ( nKey, pString ) ) = sString;
-                    return sString;
+                    if (bCache)
+                    {
+                        OUString sString(sQName.makeStringAndClear());
+                        OUString *pString = new OUString ( rLocalName );
+                        const_cast < QNameCache * > (&aQNameCache)->operator[] ( QNamePair ( nKey, pString ) ) = sString;
+                        return sString;
+                    }
+                    else
+                        return sQName.makeStringAndClear();
 				}
 				else
 				{
@@ -301,19 +311,25 @@ OUString SvXMLNamespaceMap::GetQNameByKe
 
 sal_uInt16 SvXMLNamespaceMap::_GetKeyByAttrName(
 							const OUString& rAttrName,
-							OUString *pLocalName ) const
+							OUString *pLocalName,
+                            sal_Bool bCache) const
 {
-	return GetKeyByAttrName( rAttrName, 0, pLocalName, 0 );
+	return _GetKeyByAttrName( rAttrName, 0, pLocalName, 0, bCache );
 }
 
 sal_uInt16 SvXMLNamespaceMap::_GetKeyByAttrName( const OUString& rAttrName,
 											OUString *pPrefix,
 											OUString *pLocalName,
-											OUString *pNamespace ) const
+											OUString *pNamespace,
+                                            sal_Bool bCache) const
 {
 	sal_uInt16 nKey = XML_NAMESPACE_UNKNOWN;
 
-    NameSpaceHash::const_iterator aIter = aNameCache.find ( rAttrName );
+    NameSpaceHash::const_iterator aIter;
+    if (bCache)
+        aIter = aNameCache.find ( rAttrName );
+    else
+        aIter = aNameCache.end();
     if ( aIter != aNameCache.end() )
 	{
         const NameSpaceEntry &rEntry = (*aIter).second.getBody();
@@ -365,7 +381,8 @@ sal_uInt16 SvXMLNamespaceMap::_GetKeyByA
             // not found, and no namespace: 'namespace' none
             nKey = pEntry->nKey = XML_NAMESPACE_NONE;
 
-        const_cast < NameSpaceHash* > ( &aNameCache )->operator[] ( rAttrName ) = pEntry;
+        if (bCache)
+            const_cast < NameSpaceHash* > ( &aNameCache )->operator[] ( rAttrName ) = pEntry;
     }
 
 	return nKey;
Index: xmloff/source/forms/layerimport.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/forms/layerimport.cxx,v
retrieving revision 1.24
retrieving revision 1.24.80.1
diff -u -p -r1.24 -r1.24.80.1
--- xmloff/source/forms/layerimport.cxx	26 Nov 2004 13:02:00 -0000	1.24
+++ xmloff/source/forms/layerimport.cxx	15 Feb 2005 12:27:27 -0000	1.24.80.1
@@ -391,10 +391,6 @@ namespace xmloff
 			{
 				const SvXMLNumFormatContext* pDataStyle = static_cast<const SvXMLNumFormatContext*>(pStyle);
 
-				::rtl::OUString sFormatDescription;
-				Locale aFormatLocale;
-				const_cast<SvXMLNumFormatContext*>(pDataStyle)->GetFormat(sFormatDescription, aFormatLocale);
-
 				// set this format at the control model
 				try
 				{
@@ -409,14 +405,10 @@ namespace xmloff
 					// obtain a key
 					if (xFormats.is())
 					{
-						sal_Int32 nFormatKey = xFormats->queryKey(sFormatDescription, aFormatLocale, sal_False);
-						if (-1 == nFormatKey)
-						{	// not yet available -> add it
-							nFormatKey = xFormats->addNew(sFormatDescription, aFormatLocale);
-						}
-
+				        sal_Int32 nFormatKey = const_cast<SvXMLNumFormatContext*>(pDataStyle)->CreateAndInsert( xFormatsSupplier );
 						OSL_ENSURE(-1 != nFormatKey, "OFormLayerXMLImport_Impl::applyControlNumberStyle: could not obtain a format key!");
-						// set the format on the control model
+
+                        // set the format on the control model
 						_rxControlModel->setPropertyValue(PROPERTY_FORMATKEY, makeAny(nFormatKey));
 					}
 				}
Index: xmloff/source/style/xmlnumfi.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/style/xmlnumfi.cxx,v
retrieving revision 1.36
retrieving revision 1.36.114.1
diff -u -p -r1.36 -r1.36.114.1
--- xmloff/source/style/xmlnumfi.cxx	22 Oct 2004 07:55:57 -0000	1.36
+++ xmloff/source/style/xmlnumfi.cxx	15 Feb 2005 12:35:40 -0000	1.36.114.1
@@ -1532,261 +1532,243 @@ sal_Int32 SvXMLNumFormatContext::Private
 	}
 }
 
-void SvXMLNumFormatContext::GetFormat(rtl::OUString& rFormatString, lang::Locale& rLocale)
+sal_Int32 SvXMLNumFormatContext::CreateAndInsert( com::sun::star::uno::Reference< com::sun::star::util::XNumberFormatsSupplier >& xFormatsSupplier )
 {
-	//#95893#; remember the created FormatString and Locales
-	if (!sFormatString.getLength() &&
-		!aLocale.Language.getLength() &&
-		!aLocale.Country.getLength())
-	{
-		if (aMyConditions.size())
-		{
-			rtl::OUString sFormat;
-			lang::Locale aLoc;
-			for (sal_uInt32 i = 0; i < aMyConditions.size(); i++)
-			{
-				SvXMLNumFormatContext* pStyle = (SvXMLNumFormatContext *)pStyles->FindStyleChildContext(
-					XML_STYLE_FAMILY_DATA_STYLE, aMyConditions[i].sMapName, sal_False);
-				if (pStyle)
-				{
-					pStyle->GetFormat(sFormat, aLoc);
-					AddCondition(i, sFormat, pStyle->GetLocaleData());
-				}
-			}
-		}
-
-		if ( !aFormatCode.getLength() )
-		{
-			//	insert empty format as empty string (with quotes)
-			//	#93901# this check has to be done before inserting the conditions
-			aFormatCode.appendAscii("\"\"");	// ""
-		}
-		
-		aFormatCode.insert( 0, aConditions.makeStringAndClear() );
-		sFormatString = aFormatCode.makeStringAndClear();
-		String aLanguage, aCountry;
-		ConvertLanguageToIsoNames(nFormatLang, aLanguage, aCountry);
-		aLocale.Language = rtl::OUString(aLanguage);
-		aLocale.Country = rtl::OUString(aCountry);
-	}
-	rLocale = aLocale;
-	rFormatString = sFormatString;
+    if (!nKey > -1)
+    {
+        SvNumberFormatter* pFormatter = NULL;
+	    SvNumberFormatsSupplierObj* pObj =
+					    SvNumberFormatsSupplierObj::getImplementation( xFormatsSupplier );
+	    if (pObj)
+		    pFormatter = pObj->GetNumberFormatter();
+
+	    if ( pFormatter )
+            return CreateAndInsert( pFormatter );
+        else
+            return -1;
+    }
+    else
+        return nKey;
 }
 
 void SvXMLNumFormatContext::CreateAndInsert(sal_Bool bOverwrite)
 {
-	if (!(nKey > -1))
+    if (!(nKey > -1))
+	    CreateAndInsert(pData->GetNumberFormatter());
+}
+
+sal_Int32 SvXMLNumFormatContext::CreateAndInsert(SvNumberFormatter* pFormatter)
+{
+	if (!pFormatter)
 	{
-		SvNumberFormatter* pFormatter = pData->GetNumberFormatter();
-		if (!pFormatter)
-		{
-			DBG_ERROR("no number formatter");
-			return;
-		}
+		DBG_ERROR("no number formatter");
+		return -1;
+	}
 
-		sal_uInt32 nIndex = NUMBERFORMAT_ENTRY_NOT_FOUND;
+	sal_uInt32 nIndex = NUMBERFORMAT_ENTRY_NOT_FOUND;
 
-		for (sal_uInt32 i = 0; i < aMyConditions.size(); i++)
+	for (sal_uInt32 i = 0; i < aMyConditions.size(); i++)
+	{
+		SvXMLNumFormatContext* pStyle = (SvXMLNumFormatContext *)pStyles->FindStyleChildContext(
+			XML_STYLE_FAMILY_DATA_STYLE, aMyConditions[i].sMapName, sal_False);
+		if (pStyle)
 		{
-			SvXMLNumFormatContext* pStyle = (SvXMLNumFormatContext *)pStyles->FindStyleChildContext(
-				XML_STYLE_FAMILY_DATA_STYLE, aMyConditions[i].sMapName, sal_False);
-			if (pStyle)
-			{
-				if ((pStyle->PrivateGetKey() > -1))		// don't reset pStyle's bRemoveAfterUse flag
-					AddCondition(i);
-			}
+			if ((pStyle->PrivateGetKey() > -1))		// don't reset pStyle's bRemoveAfterUse flag
+				AddCondition(i);
 		}
+	}
 
-		if ( !aFormatCode.getLength() )
-		{
-			//	insert empty format as empty string (with quotes)
-			//	#93901# this check has to be done before inserting the conditions
-			aFormatCode.appendAscii("\"\"");	// ""
-		}
+	if ( !aFormatCode.getLength() )
+	{
+		//	insert empty format as empty string (with quotes)
+		//	#93901# this check has to be done before inserting the conditions
+		aFormatCode.appendAscii("\"\"");	// ""
+	}
 
-		aFormatCode.insert( 0, aConditions.makeStringAndClear() );
-		OUString sFormat = aFormatCode.makeStringAndClear();
+	aFormatCode.insert( 0, aConditions.makeStringAndClear() );
+	OUString sFormat = aFormatCode.makeStringAndClear();
 
-		//	test special cases
+	//	test special cases
 
-		if ( bAutoDec )			// automatic decimal places
-		{
-			//	#99391# adjust only if the format contains no text elements, no conditions
-			//	and no color definition (detected by the '[' at the start)
+	if ( bAutoDec )			// automatic decimal places
+	{
+		//	#99391# adjust only if the format contains no text elements, no conditions
+		//	and no color definition (detected by the '[' at the start)
 
-			if ( nType == XML_TOK_STYLES_NUMBER_STYLE && !bHasExtraText &&
-					aMyConditions.size() == 0 && sFormat.toChar() != (sal_Unicode)'[' )
-				nIndex = pFormatter->GetStandardIndex( nFormatLang );
-		}
-		if ( bAutoInt )			// automatic integer digits
-		{
-			//!	only if two decimal places was set?
+		if ( nType == XML_TOK_STYLES_NUMBER_STYLE && !bHasExtraText &&
+				aMyConditions.size() == 0 && sFormat.toChar() != (sal_Unicode)'[' )
+			nIndex = pFormatter->GetStandardIndex( nFormatLang );
+	}
+	if ( bAutoInt )			// automatic integer digits
+	{
+		//!	only if two decimal places was set?
 
-			if ( nType == XML_TOK_STYLES_NUMBER_STYLE && !bHasExtraText &&
-					aMyConditions.size() == 0 && sFormat.toChar() != (sal_Unicode)'[' )
-				nIndex = pFormatter->GetFormatIndex( NF_NUMBER_SYSTEM, nFormatLang );
-		}
+		if ( nType == XML_TOK_STYLES_NUMBER_STYLE && !bHasExtraText &&
+				aMyConditions.size() == 0 && sFormat.toChar() != (sal_Unicode)'[' )
+			nIndex = pFormatter->GetFormatIndex( NF_NUMBER_SYSTEM, nFormatLang );
+	}
 
-		//	boolean is always the builtin boolean format
-		//	(no other boolean formats are implemented)
-		if ( nType == XML_TOK_STYLES_BOOLEAN_STYLE )
-			nIndex = pFormatter->GetFormatIndex( NF_BOOLEAN, nFormatLang );
+	//	boolean is always the builtin boolean format
+	//	(no other boolean formats are implemented)
+	if ( nType == XML_TOK_STYLES_BOOLEAN_STYLE )
+		nIndex = pFormatter->GetFormatIndex( NF_BOOLEAN, nFormatLang );
 
-		//	check for default date formats
-		if ( nType == XML_TOK_STYLES_DATE_STYLE && bAutoOrder && !bDateNoDefault )
-		{
-			NfIndexTableOffset eFormat = (NfIndexTableOffset) SvXMLNumFmtDefaults::GetDefaultDateFormat(
-				eDateDOW, eDateDay, eDateMonth, eDateYear,
-				eDateHours, eDateMins, eDateSecs, bFromSystem );
-			if ( eFormat < NF_INDEX_TABLE_ENTRIES )
-			{
-				//	#109651# if a date format has the automatic-order attribute and
-				//	contains exactly the elements of one of the default date formats,
-				//	use that default format, with the element order and separators
-				//	from the current locale settings
+	//	check for default date formats
+	if ( nType == XML_TOK_STYLES_DATE_STYLE && bAutoOrder && !bDateNoDefault )
+	{
+		NfIndexTableOffset eFormat = (NfIndexTableOffset) SvXMLNumFmtDefaults::GetDefaultDateFormat(
+			eDateDOW, eDateDay, eDateMonth, eDateYear,
+			eDateHours, eDateMins, eDateSecs, bFromSystem );
+		if ( eFormat < NF_INDEX_TABLE_ENTRIES )
+		{
+			//	#109651# if a date format has the automatic-order attribute and
+			//	contains exactly the elements of one of the default date formats,
+			//	use that default format, with the element order and separators
+			//	from the current locale settings
 
-				nIndex = pFormatter->GetFormatIndex( eFormat, nFormatLang );
-			}
+			nIndex = pFormatter->GetFormatIndex( eFormat, nFormatLang );
 		}
+	}
 
-		if ( nIndex == NUMBERFORMAT_ENTRY_NOT_FOUND && sFormat.getLength() )
-		{
-			//	insert by format string
+	if ( nIndex == NUMBERFORMAT_ENTRY_NOT_FOUND && sFormat.getLength() )
+	{
+		//	insert by format string
 
-			String aFormatStr( sFormat );
-			nIndex = pFormatter->GetEntryKey( aFormatStr, nFormatLang );
-			if ( nIndex == NUMBERFORMAT_ENTRY_NOT_FOUND )
-			{
-				xub_StrLen	nErrPos	= 0;
-				short		nType	= 0;
-				sal_Bool bOk = pFormatter->PutEntry( aFormatStr, nErrPos, nType, nIndex, nFormatLang );
-				if ( !bOk && nErrPos == 0 && aFormatStr != String(sFormat) )
-				{
-					//	if the string was modified by PutEntry, look for an existing format
-					//	with the modified string
-					nIndex = pFormatter->GetEntryKey( aFormatStr, nFormatLang );
-					if ( nIndex != NUMBERFORMAT_ENTRY_NOT_FOUND )
-						bOk = sal_True;
-				}
-				if (!bOk)
-					nIndex = NUMBERFORMAT_ENTRY_NOT_FOUND;
+		String aFormatStr( sFormat );
+		nIndex = pFormatter->GetEntryKey( aFormatStr, nFormatLang );
+		if ( nIndex == NUMBERFORMAT_ENTRY_NOT_FOUND )
+		{
+			xub_StrLen	nErrPos	= 0;
+			short		nType	= 0;
+			sal_Bool bOk = pFormatter->PutEntry( aFormatStr, nErrPos, nType, nIndex, nFormatLang );
+			if ( !bOk && nErrPos == 0 && aFormatStr != String(sFormat) )
+			{
+				//	if the string was modified by PutEntry, look for an existing format
+				//	with the modified string
+				nIndex = pFormatter->GetEntryKey( aFormatStr, nFormatLang );
+				if ( nIndex != NUMBERFORMAT_ENTRY_NOT_FOUND )
+					bOk = sal_True;
 			}
+			if (!bOk)
+				nIndex = NUMBERFORMAT_ENTRY_NOT_FOUND;
 		}
+	}
 
 #if 0
 //! I18N doesn't provide SYSTEM or extended date information yet
-		if ( nIndex != NUMBERFORMAT_ENTRY_NOT_FOUND && !bFromSystem )
-		{
-			//	instead of automatic date format, use fixed formats if bFromSystem is not set
-			//!	prevent use of automatic formats in other cases, force user-defined format?
+	if ( nIndex != NUMBERFORMAT_ENTRY_NOT_FOUND && !bFromSystem )
+	{
+		//	instead of automatic date format, use fixed formats if bFromSystem is not set
+		//!	prevent use of automatic formats in other cases, force user-defined format?
 
-			sal_uInt32 nNewIndex = nIndex;
+		sal_uInt32 nNewIndex = nIndex;
 
-			NfIndexTableOffset eOffset = pFormatter->GetIndexTableOffset( nIndex );
-			if ( eOffset == NF_DATE_SYSTEM_SHORT )
+		NfIndexTableOffset eOffset = pFormatter->GetIndexTableOffset( nIndex );
+		if ( eOffset == NF_DATE_SYSTEM_SHORT )
+		{
+			const International& rInt = pData->GetInternational( nFormatLang );
+			if ( rInt.IsDateDayLeadingZero() && rInt.IsDateMonthLeadingZero() )
 			{
-				const International& rInt = pData->GetInternational( nFormatLang );
-				if ( rInt.IsDateDayLeadingZero() && rInt.IsDateMonthLeadingZero() )
-				{
-					if ( rInt.IsDateCentury() )
-						nNewIndex = pFormatter->GetFormatIndex( NF_DATE_SYS_DDMMYYYY, nFormatLang );
-					else
-						nNewIndex = pFormatter->GetFormatIndex( NF_DATE_SYS_DDMMYY, nFormatLang );
-				}
+				if ( rInt.IsDateCentury() )
+					nNewIndex = pFormatter->GetFormatIndex( NF_DATE_SYS_DDMMYYYY, nFormatLang );
+				else
+					nNewIndex = pFormatter->GetFormatIndex( NF_DATE_SYS_DDMMYY, nFormatLang );
 			}
-			else if ( eOffset == NF_DATE_SYSTEM_LONG )
+		}
+		else if ( eOffset == NF_DATE_SYSTEM_LONG )
+		{
+			const International& rInt = pData->GetInternational( nFormatLang );
+			if ( !rInt.IsLongDateDayLeadingZero() )
 			{
-				const International& rInt = pData->GetInternational( nFormatLang );
-				if ( !rInt.IsLongDateDayLeadingZero() )
+				sal_Bool bCentury = rInt.IsLongDateCentury();
+				MonthFormat eMonth = rInt.GetLongDateMonthFormat();
+				if ( eMonth == MONTH_LONG && bCentury )
 				{
-					sal_Bool bCentury = rInt.IsLongDateCentury();
-					MonthFormat eMonth = rInt.GetLongDateMonthFormat();
-					if ( eMonth == MONTH_LONG && bCentury )
-					{
-						if ( rInt.GetLongDateDayOfWeekFormat() == DAYOFWEEK_LONG )
-							nNewIndex = pFormatter->GetFormatIndex( NF_DATE_SYS_NNNNDMMMMYYYY, nFormatLang );
-						else
-							nNewIndex = pFormatter->GetFormatIndex( NF_DATE_SYS_NNDMMMMYYYY, nFormatLang );
-					}
-					else if ( eMonth == MONTH_SHORT && !bCentury )
-						nNewIndex = pFormatter->GetFormatIndex( NF_DATE_SYS_NNDMMMYY, nFormatLang );
+					if ( rInt.GetLongDateDayOfWeekFormat() == DAYOFWEEK_LONG )
+						nNewIndex = pFormatter->GetFormatIndex( NF_DATE_SYS_NNNNDMMMMYYYY, nFormatLang );
+					else
+						nNewIndex = pFormatter->GetFormatIndex( NF_DATE_SYS_NNDMMMMYYYY, nFormatLang );
 				}
-			}
-
-			if ( nNewIndex != nIndex )
-			{
-				//	verify the fixed format really matches the format string
-				//	(not the case with some formats from locale data)
-
-				const SvNumberformat* pFixedFormat = pFormatter->GetEntry( nNewIndex );
-				if ( pFixedFormat && pFixedFormat->GetFormatstring() == String(sFormat) )
-					nIndex = nNewIndex;
+				else if ( eMonth == MONTH_SHORT && !bCentury )
+					nNewIndex = pFormatter->GetFormatIndex( NF_DATE_SYS_NNDMMMYY, nFormatLang );
 			}
 		}
-#endif
 
-		if ( nIndex != NUMBERFORMAT_ENTRY_NOT_FOUND && !bAutoOrder )
+		if ( nNewIndex != nIndex )
 		{
-			//	use fixed-order formats instead of SYS... if bAutoOrder is false
-			//	(only if the format strings are equal for the locale)
+			//	verify the fixed format really matches the format string
+			//	(not the case with some formats from locale data)
 
-			NfIndexTableOffset eOffset = pFormatter->GetIndexTableOffset( nIndex );
-			if ( eOffset == NF_DATE_SYS_DMMMYYYY )
-			{
-				sal_uInt32 nNewIndex = pFormatter->GetFormatIndex( NF_DATE_DIN_DMMMYYYY, nFormatLang );
-				const SvNumberformat* pOldEntry = pFormatter->GetEntry( nIndex );
-				const SvNumberformat* pNewEntry = pFormatter->GetEntry( nNewIndex );
-				if ( pOldEntry && pNewEntry && pOldEntry->GetFormatstring() == pNewEntry->GetFormatstring() )
-					nIndex = nNewIndex;
-			}
-			else if ( eOffset == NF_DATE_SYS_DMMMMYYYY )
-			{
-				sal_uInt32 nNewIndex = pFormatter->GetFormatIndex( NF_DATE_DIN_DMMMMYYYY, nFormatLang );
-				const SvNumberformat* pOldEntry = pFormatter->GetEntry( nIndex );
-				const SvNumberformat* pNewEntry = pFormatter->GetEntry( nNewIndex );
-				if ( pOldEntry && pNewEntry && pOldEntry->GetFormatstring() == pNewEntry->GetFormatstring() )
-					nIndex = nNewIndex;
-			}
+			const SvNumberformat* pFixedFormat = pFormatter->GetEntry( nNewIndex );
+			if ( pFixedFormat && pFixedFormat->GetFormatstring() == String(sFormat) )
+				nIndex = nNewIndex;
 		}
+	}
+#endif
+
+	if ( nIndex != NUMBERFORMAT_ENTRY_NOT_FOUND && !bAutoOrder )
+	{
+		//	use fixed-order formats instead of SYS... if bAutoOrder is false
+		//	(only if the format strings are equal for the locale)
 
-		if ((nIndex != NUMBERFORMAT_ENTRY_NOT_FOUND) && sFormatTitle.getLength())
+		NfIndexTableOffset eOffset = pFormatter->GetIndexTableOffset( nIndex );
+		if ( eOffset == NF_DATE_SYS_DMMMYYYY )
 		{
-			SvNumberformat* pFormat = const_cast<SvNumberformat*>(pFormatter->GetEntry( nIndex ));
-			if (pFormat)
-			{
-				String sTitle (sFormatTitle);
-				pFormat->SetComment(sTitle);
-			}
+			sal_uInt32 nNewIndex = pFormatter->GetFormatIndex( NF_DATE_DIN_DMMMYYYY, nFormatLang );
+			const SvNumberformat* pOldEntry = pFormatter->GetEntry( nIndex );
+			const SvNumberformat* pNewEntry = pFormatter->GetEntry( nNewIndex );
+			if ( pOldEntry && pNewEntry && pOldEntry->GetFormatstring() == pNewEntry->GetFormatstring() )
+				nIndex = nNewIndex;
+		}
+		else if ( eOffset == NF_DATE_SYS_DMMMMYYYY )
+		{
+			sal_uInt32 nNewIndex = pFormatter->GetFormatIndex( NF_DATE_DIN_DMMMMYYYY, nFormatLang );
+			const SvNumberformat* pOldEntry = pFormatter->GetEntry( nIndex );
+			const SvNumberformat* pNewEntry = pFormatter->GetEntry( nNewIndex );
+			if ( pOldEntry && pNewEntry && pOldEntry->GetFormatstring() == pNewEntry->GetFormatstring() )
+				nIndex = nNewIndex;
 		}
+	}
 
-		if ( nIndex == NUMBERFORMAT_ENTRY_NOT_FOUND )
+	if ((nIndex != NUMBERFORMAT_ENTRY_NOT_FOUND) && sFormatTitle.getLength())
+	{
+		SvNumberformat* pFormat = const_cast<SvNumberformat*>(pFormatter->GetEntry( nIndex ));
+		if (pFormat)
 		{
-			DBG_ERROR("invalid number format");
-			nIndex = pFormatter->GetStandardIndex( nFormatLang );
+			String sTitle (sFormatTitle);
+			pFormat->SetComment(sTitle);
 		}
+	}
 
-		pData->AddKey( nIndex, GetName(), bRemoveAfterUse );
-		nKey = nIndex;
-
-		//	Add to import's list of keys (shared between styles and content import)
-		//	only if not volatile - formats are removed from NumberFormatter at the
-		//	end of each import (in SvXMLNumFmtHelper dtor).
-		//	If bRemoveAfterUse is reset later in GetKey, AddNumberStyle is called there.
-
-		if (!bRemoveAfterUse)
-			GetImport().AddNumberStyle( nKey, GetName() );
-
-	#if 0
-		ByteString aByte( String(sFormatName), gsl_getSystemTextEncoding() );
-		aByte.Append( " | " );
-		aByte.Append(ByteString( String(sFormat), gsl_getSystemTextEncoding() ));
-		aByte.Append( " | " );
-		aByte.Append(ByteString::CreateFromInt32( nIndex ));
-
-	//	DBG_ERROR(aByte.GetBuffer());
-		int xxx=42;
-	#endif
+	if ( nIndex == NUMBERFORMAT_ENTRY_NOT_FOUND )
+	{
+		DBG_ERROR("invalid number format");
+		nIndex = pFormatter->GetStandardIndex( nFormatLang );
 	}
+
+	pData->AddKey( nIndex, GetName(), bRemoveAfterUse );
+	nKey = nIndex;
+
+	//	Add to import's list of keys (shared between styles and content import)
+	//	only if not volatile - formats are removed from NumberFormatter at the
+	//	end of each import (in SvXMLNumFmtHelper dtor).
+	//	If bRemoveAfterUse is reset later in GetKey, AddNumberStyle is called there.
+
+	if (!bRemoveAfterUse)
+		GetImport().AddNumberStyle( nKey, GetName() );
+
+#if 0
+	ByteString aByte( String(sFormatName), gsl_getSystemTextEncoding() );
+	aByte.Append( " | " );
+	aByte.Append(ByteString( String(sFormat), gsl_getSystemTextEncoding() ));
+	aByte.Append( " | " );
+	aByte.Append(ByteString::CreateFromInt32( nIndex ));
+
+//	DBG_ERROR(aByte.GetBuffer());
+	int xxx=42;
+#endif
+
+    return nKey;
 }
 
 void SvXMLNumFormatContext::Finish( sal_Bool bOverwrite )
Index: xmloff/source/text/XMLSectionExport.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/text/XMLSectionExport.cxx,v
retrieving revision 1.37
retrieving revision 1.37.142.1
diff -u -p -r1.37 -r1.37.142.1
--- xmloff/source/text/XMLSectionExport.cxx	8 Sep 2004 15:00:38 -0000	1.37
+++ xmloff/source/text/XMLSectionExport.cxx	18 Feb 2005 11:32:36 -0000	1.37.142.1
@@ -561,7 +561,7 @@ void XMLSectionExport::ExportRegularSect
 	{
 		OUString sQValue = 
 			GetExport().GetNamespaceMap().GetQNameByKey( XML_NAMESPACE_OOOW,
-														 sCond );
+														 sCond, sal_False );
 		GetExport().AddAttribute(XML_NAMESPACE_TEXT, XML_CONDITION, sQValue);
 		eDisplay = XML_CONDITION;
 
Index: xmloff/source/text/XMLSectionImportContext.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/text/XMLSectionImportContext.cxx,v
retrieving revision 1.20
retrieving revision 1.20.178.1
diff -u -p -r1.20 -r1.20.178.1
--- xmloff/source/text/XMLSectionImportContext.cxx	13 Jul 2004 08:35:22 -0000	1.20
+++ xmloff/source/text/XMLSectionImportContext.cxx	18 Feb 2005 11:32:37 -0000	1.20.178.1
@@ -370,7 +370,7 @@ void XMLSectionImportContext::ProcessAtt
 				{
 					OUString sTmp;
 					sal_uInt16 nPrefix = GetImport().GetNamespaceMap().
-									GetKeyByAttrName( sAttr, &sTmp );
+									_GetKeyByAttrName( sAttr, &sTmp, sal_False );
 					if( XML_NAMESPACE_OOOW == nPrefix )
 					{
 						sCond = sTmp;
Index: xmloff/source/text/txtflde.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/text/txtflde.cxx,v
retrieving revision 1.61
retrieving revision 1.61.26.1
diff -u -p -r1.61 -r1.61.26.1
--- xmloff/source/text/txtflde.cxx	27 Jan 2005 11:10:05 -0000	1.61
+++ xmloff/source/text/txtflde.cxx	18 Feb 2005 11:32:37 -0000	1.61.26.1
@@ -2543,7 +2543,7 @@ void XMLTextFieldExport::ProcessString(e
 									   sal_uInt16 nPrefix)
 {
 	OUString sQValue = 
-		GetExport().GetNamespaceMap().GetQNameByKey( nValuePrefix, sValue );
+		GetExport().GetNamespaceMap().GetQNameByKey( nValuePrefix, sValue, sal_False );
 	ProcessString( eName, sQValue, bOmitEmpty, nPrefix );
 }
 
Index: xmloff/source/text/txtfldi.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/text/txtfldi.cxx,v
retrieving revision 1.55
retrieving revision 1.55.98.1
diff -u -p -r1.55 -r1.55.98.1
--- xmloff/source/text/txtfldi.cxx	9 Nov 2004 12:19:52 -0000	1.55
+++ xmloff/source/text/txtfldi.cxx	18 Feb 2005 11:32:49 -0000	1.55.98.1
@@ -1757,8 +1757,8 @@ void XMLDatabaseNextImportContext::Proce
 	if (XML_TOK_TEXTFIELD_CONDITION == nAttrToken)
 	{
 		OUString sTmp;
-		sal_uInt16 nPrefix = GetImport().GetNamespaceMap().GetKeyByAttrName(
-									sAttrValue, &sTmp );
+		sal_uInt16 nPrefix = GetImport().GetNamespaceMap()._GetKeyByAttrName(
+									sAttrValue, &sTmp, sal_False );
 		if( XML_NAMESPACE_OOOW == nPrefix )
 		{
 			sCondition = sTmp;
@@ -2314,8 +2314,8 @@ void XMLHiddenParagraphImportContext::Pr
 	if (XML_TOK_TEXTFIELD_CONDITION == nAttrToken)
 	{
 		OUString sTmp;
-		sal_uInt16 nPrefix = GetImport().GetNamespaceMap().GetKeyByAttrName(
-									sAttrValue, &sTmp );
+		sal_uInt16 nPrefix = GetImport().GetNamespaceMap()._GetKeyByAttrName(
+									sAttrValue, &sTmp, sal_False );
 		if( XML_NAMESPACE_OOOW == nPrefix )
 		{
 			sCondition = sTmp;
@@ -2383,7 +2383,7 @@ void XMLConditionalTextImportContext::Pr
 			{
 				OUString sTmp;
 				sal_uInt16 nPrefix = GetImport().GetNamespaceMap().
-						GetKeyByAttrName( sAttrValue, &sTmp );
+						_GetKeyByAttrName( sAttrValue, &sTmp, sal_False );
 				if( XML_NAMESPACE_OOOW == nPrefix )
 				{
 					sCondition = sTmp;
@@ -2470,7 +2470,7 @@ void XMLHiddenTextImportContext::Process
 			{
 				OUString sTmp;
 				sal_uInt16 nPrefix = GetImport().GetNamespaceMap().
-										GetKeyByAttrName( sAttrValue, &sTmp );
+										_GetKeyByAttrName( sAttrValue, &sTmp, sal_False );
 				if( XML_NAMESPACE_OOOW == nPrefix )
 				{
 					sCondition = sTmp;
Index: xmloff/source/text/txtvfldi.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/text/txtvfldi.cxx,v
retrieving revision 1.21
retrieving revision 1.21.144.1
diff -u -p -r1.21 -r1.21.144.1
--- xmloff/source/text/txtvfldi.cxx	8 Sep 2004 15:01:53 -0000	1.21
+++ xmloff/source/text/txtvfldi.cxx	18 Feb 2005 11:32:50 -0000	1.21.144.1
@@ -251,7 +251,7 @@ void XMLVarFieldImportContext::ProcessAt
 			{
 				OUString sTmp;
 				sal_uInt16 nPrefix = GetImport().GetNamespaceMap().
-						GetKeyByAttrName( sAttrValue, &sTmp );
+						_GetKeyByAttrName( sAttrValue, &sTmp, sal_False );
 				if( XML_NAMESPACE_OOOW == nPrefix )
 				{
 					sFormula = sTmp;
@@ -1451,7 +1451,7 @@ void XMLValueImportHelper::ProcessAttrib
 			{
 				OUString sTmp;
 				sal_uInt16 nPrefix = rImport.GetNamespaceMap().
-						GetKeyByAttrName( sAttrValue, &sTmp );
+						_GetKeyByAttrName( sAttrValue, &sTmp, sal_False );
 				if( XML_NAMESPACE_OOOW == nPrefix )
 				{
 					sFormula = sTmp;
Index: xmloff/source/transform/PropertyActionsOASIS.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/transform/PropertyActionsOASIS.cxx,v
retrieving revision 1.11
retrieving revision 1.11.78.1
diff -u -p -r1.11 -r1.11.78.1
--- xmloff/source/transform/PropertyActionsOASIS.cxx	26 Nov 2004 13:10:17 -0000	1.11
+++ xmloff/source/transform/PropertyActionsOASIS.cxx	18 Feb 2005 16:24:02 -0000	1.11.78.1
@@ -437,7 +437,7 @@ XMLTransformerActionInit aParagraphPrope
 	  	NO_PARAMS }, /* generated entry */
     { XML_NAMESPACE_FO, XML_KEEP_TOGETHER, XML_OPTACTION_KEEP_TOGETHER,
         NO_PARAMS },
-	{ XML_NAMESPACE_STYLE, XML_WRITING_MODE, XML_OPTACTION_DRAW_WRITING_MODE, 0 },
+//	{ XML_NAMESPACE_STYLE, XML_WRITING_MODE, XML_OPTACTION_DRAW_WRITING_MODE, 0 },
 	{ XML_NAMESPACE_OFFICE, XML_TOKEN_INVALID, XML_ATACTION_EOT, NO_PARAMS }
 };
 
Index: xmloff/source/transform/TransformerBase.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/transform/TransformerBase.cxx,v
retrieving revision 1.10
retrieving revision 1.10.80.1
diff -u -p -r1.10 -r1.10.80.1
--- xmloff/source/transform/TransformerBase.cxx	26 Nov 2004 21:33:01 -0000	1.10
+++ xmloff/source/transform/TransformerBase.cxx	18 Feb 2005 11:32:51 -0000	1.10.80.1
@@ -1284,7 +1284,7 @@ sal_Bool XMLTransformerBase::NegPercent(
 sal_Bool XMLTransformerBase::AddNamespacePrefix( ::rtl::OUString& rName,
 							 sal_uInt16 nPrefix ) const
 {
-	rName = GetNamespaceMap().GetQNameByKey( nPrefix, rName );
+	rName = GetNamespaceMap().GetQNameByKey( nPrefix, rName, sal_False );
 	return sal_True;
 }
 
@@ -1293,7 +1293,7 @@ sal_Bool XMLTransformerBase::RemoveNames
 {
 	OUString aLocalName;
 	sal_uInt16 nPrefix =
-		GetNamespaceMap().GetKeyByAttrName( rName, &aLocalName );
+		GetNamespaceMap()._GetKeyByAttrName( rName, &aLocalName, sal_False );
 	sal_Bool bRet = XML_NAMESPACE_UNKNOWN != nPrefix &&
 					(USHRT_MAX == nPrefixOnly || nPrefix == nPrefixOnly);
 	if( bRet )
Index: sc/inc/editutil.hxx
===================================================================
RCS file: /cvs/sc/sc/inc/editutil.hxx,v
retrieving revision 1.8
retrieving revision 1.8.186.1
diff -u -p -r1.8 -r1.8.186.1
--- sc/inc/editutil.hxx	8 Sep 2004 13:41:52 -0000	1.8
+++ sc/inc/editutil.hxx	14 Feb 2005 16:39:46 -0000	1.8.186.1
@@ -98,6 +98,7 @@
 class OutputDevice;
 class ScDocument;
 class ScPatternAttr;
+class ScEditEngineDefaulter;
 
 class ScEditUtil
 {
@@ -133,13 +134,13 @@ public:
 
 class ScEditAttrTester
 {
-	EditEngine*	pEngine;
+	ScEditEngineDefaulter* pEngine;
 	SfxItemSet*	pEditAttrs;
 	BOOL		bNeedsObject;
 	BOOL		bNeedsCellAttr;
 
 public:
-				ScEditAttrTester( EditEngine* pEng );
+				ScEditAttrTester( ScEditEngineDefaulter* pEng );
 				~ScEditAttrTester();
 
 	BOOL				NeedsObject() const		{ return bNeedsObject; }
@@ -186,6 +187,9 @@ public:
 					/// if it doesn't exist yet.
 					/// The default ItemSet is then applied to each paragraph.
 	void			SetDefaultItem( const SfxPoolItem& rItem );
+
+                    /// Returns the stored defaults, used to find non-default character attributes
+    const SfxItemSet& GetDefaults();
 
 					/// Overwritten method to be able to apply defaults already set
 	void			SetText( const EditTextObject& rTextObject );
Index: sc/source/core/data/documen2.cxx
===================================================================
RCS file: /cvs/sc/sc/source/core/data/documen2.cxx,v
retrieving revision 1.48
retrieving revision 1.47.96.2
diff -u -p -r1.48 -r1.47.96.2
--- sc/source/core/data/documen2.cxx	16 Feb 2005 18:05:58 -0000	1.48
+++ sc/source/core/data/documen2.cxx	21 Feb 2005 18:36:01 -0000	1.47.96.2
@@ -641,6 +641,11 @@ void ScDocument::InitClipPtrs( ScDocumen
 	}
 	else
 		pClipData = NULL;
+
+    // Options pointers exist (ImplCreateOptions) for any document.
+    // Must be copied for correct results in OLE objects (#i42666#).
+    SetDocOptions( pSourceDoc->GetDocOptions() );
+    SetViewOptions( pSourceDoc->GetViewOptions() );
 }
 
 SvNumberFormatter* ScDocument::GetFormatTable() const
Index: sc/source/core/tool/editutil.cxx
===================================================================
RCS file: /cvs/sc/sc/source/core/tool/editutil.cxx,v
retrieving revision 1.25
retrieving revision 1.25.186.1
diff -u -p -r1.25 -r1.25.186.1
--- sc/source/core/tool/editutil.cxx	8 Sep 2004 13:45:18 -0000	1.25
+++ sc/source/core/tool/editutil.cxx	14 Feb 2005 16:40:06 -0000	1.25.186.1
@@ -224,7 +224,7 @@ Rectangle ScEditUtil::GetEditArea( const
 
 //------------------------------------------------------------------------
 
-ScEditAttrTester::ScEditAttrTester( EditEngine* pEng ) :
+ScEditAttrTester::ScEditAttrTester( ScEditEngineDefaulter* pEng ) :
 	pEngine( pEng ),
 	pEditAttrs( NULL ),
 	bNeedsObject( FALSE ),
@@ -239,7 +239,7 @@ ScEditAttrTester::ScEditAttrTester( Edit
 		const SfxPoolItem* pItem = NULL;
 		pEditAttrs = new SfxItemSet( pEngine->GetAttribs(
 										ESelection(0,0,0,pEngine->GetTextLen(0)) ) );
-		const SfxItemPool* pEditPool = pEditAttrs->GetPool();
+        const SfxItemSet& rEditDefaults = pEngine->GetDefaults();
 
 		for (USHORT nId = EE_CHAR_START; nId <= EE_CHAR_END && !bNeedsObject; nId++)
 		{
@@ -256,14 +256,14 @@ ScEditAttrTester::ScEditAttrTester( Edit
 					//	EditEngine because "user attributes applied to all the text" is different
 					//	from "user attributes applied to the cell".
 
-					if ( *pItem != pEditPool->GetDefaultItem(nId) )
+					if ( *pItem != rEditDefaults.Get(nId) )
 						bNeedsObject = TRUE;
 				}
 				else
 					if (!bNeedsCellAttr)
-						if ( *pItem != pEditPool->GetDefaultItem(nId) )
+						if ( *pItem != rEditDefaults.Get(nId) )
 							bNeedsCellAttr = TRUE;
-				//	SetDefaults an der EditEngine setzt Pool-Defaults
+                //  rEditDefaults contains the defaults from the cell format
 			}
 		}
 
@@ -397,6 +397,15 @@ void ScEditEngineDefaulter::SetDefaultIt
 	SetDefaults( *pDefaults, FALSE );
 }
 
+const SfxItemSet& ScEditEngineDefaulter::GetDefaults()
+{
+    if ( !pDefaults )
+    {
+        pDefaults = new SfxItemSet( GetEmptyItemSet() );
+        bDeleteDefaults = TRUE;
+    }
+    return *pDefaults;
+}
 
 void ScEditEngineDefaulter::SetText( const EditTextObject& rTextObject )
 {
Index: sc/source/filter/xml/XMLChangeTrackingExportHelper.cxx
===================================================================
RCS file: /cvs/sc/sc/source/filter/xml/XMLChangeTrackingExportHelper.cxx,v
retrieving revision 1.23
retrieving revision 1.23.250.1
diff -u -p -r1.23 -r1.23.250.1
--- sc/source/filter/xml/XMLChangeTrackingExportHelper.cxx	13 Jul 2004 07:45:32 -0000	1.23
+++ sc/source/filter/xml/XMLChangeTrackingExportHelper.cxx	18 Feb 2005 11:34:29 -0000	1.23.250.1
@@ -472,12 +472,12 @@ void ScChangeTrackingExportHelper::Write
 				rExport.AddAttribute(XML_NAMESPACE_TABLE, XML_MATRIX_COVERED, XML_TRUE);
 			}
 			rtl::OUString sMatrixFormula = sOUFormula.copy(1, sOUFormula.getLength() - 2);
-            rtl::OUString sQValue = rExport.GetNamespaceMap().GetQNameByKey( XML_NAMESPACE_OOOC, sMatrixFormula ); 
+            rtl::OUString sQValue = rExport.GetNamespaceMap().GetQNameByKey( XML_NAMESPACE_OOOC, sMatrixFormula, sal_False ); 
 			rExport.AddAttribute(XML_NAMESPACE_TABLE, XML_FORMULA, sQValue);
 		}
 		else
         {
-            rtl::OUString sQValue = rExport.GetNamespaceMap().GetQNameByKey( XML_NAMESPACE_OOOC, sFormula ); 
+            rtl::OUString sQValue = rExport.GetNamespaceMap().GetQNameByKey( XML_NAMESPACE_OOOC, sFormula, sal_False ); 
 			rExport.AddAttribute(XML_NAMESPACE_TABLE, XML_FORMULA, sQValue);
         }
 		if (pFormulaCell->IsValue())
Index: sc/source/filter/xml/XMLStylesExportHelper.cxx
===================================================================
RCS file: /cvs/sc/sc/source/filter/xml/XMLStylesExportHelper.cxx,v
retrieving revision 1.40
retrieving revision 1.40.94.1
diff -u -p -r1.40 -r1.40.94.1
--- sc/source/filter/xml/XMLStylesExportHelper.cxx	15 Nov 2004 15:10:41 -0000	1.40
+++ sc/source/filter/xml/XMLStylesExportHelper.cxx	18 Feb 2005 11:34:30 -0000	1.40.94.1
@@ -363,7 +363,7 @@ rtl::OUString ScMyValidationsContainer::
 				sCondition = rtl::OUString();
 	}
     if (sCondition.getLength())
-        sCondition = rExport.GetNamespaceMap().GetQNameByKey( XML_NAMESPACE_OOOC, sCondition ); 
+        sCondition = rExport.GetNamespaceMap().GetQNameByKey( XML_NAMESPACE_OOOC, sCondition, sal_False ); 
 
 	return sCondition;
 }
Index: sc/source/filter/xml/XMLTrackedChangesContext.cxx
===================================================================
RCS file: /cvs/sc/sc/source/filter/xml/XMLTrackedChangesContext.cxx,v
retrieving revision 1.21
retrieving revision 1.21.250.1
diff -u -p -r1.21 -r1.21.250.1
--- sc/source/filter/xml/XMLTrackedChangesContext.cxx	13 Jul 2004 07:47:15 -0000	1.21
+++ sc/source/filter/xml/XMLTrackedChangesContext.cxx	18 Feb 2005 11:34:30 -0000	1.21.250.1
@@ -1227,7 +1227,7 @@ ScXMLChangeCellContext::ScXMLChangeCellC
 			{
 				bEmpty = sal_False;
 				sal_uInt16 nPrefix = GetImport().GetNamespaceMap().
-						GetKeyByAttrName( sValue, &rFormula );
+						_GetKeyByAttrName( sValue, &rFormula, sal_False );
 				if (XML_NAMESPACE_OOOC != nPrefix)
                     rFormula = sValue;
 				ScXMLConverter::ParseFormula(rFormula);
Index: sc/source/filter/xml/xmlcelli.cxx
===================================================================
RCS file: /cvs/sc/sc/source/filter/xml/xmlcelli.cxx,v
retrieving revision 1.81
retrieving revision 1.81.4.1
diff -u -p -r1.81 -r1.81.4.1
--- sc/source/filter/xml/xmlcelli.cxx	2 Feb 2005 13:53:46 -0000	1.81
+++ sc/source/filter/xml/xmlcelli.cxx	18 Feb 2005 11:34:30 -0000	1.81.4.1
@@ -251,7 +251,7 @@ ScXMLTableRowCellContext::ScXMLTableRowC
 					        DBG_ASSERT(!pOUFormula, "here should be only one formula");
                             pOUFormula = new rtl::OUString();
 				            sal_uInt16 nPrefix = GetImport().GetNamespaceMap().
-						            GetKeyByAttrName( sValue, pOUFormula );
+						            _GetKeyByAttrName( sValue, pOUFormula, sal_False );
 				            if (XML_NAMESPACE_OOOC != nPrefix)
                             {
                                 delete pOUFormula;
Index: sc/source/filter/xml/xmlcvali.cxx
===================================================================
RCS file: /cvs/sc/sc/source/filter/xml/xmlcvali.cxx,v
retrieving revision 1.17
retrieving revision 1.17.88.1
diff -u -p -r1.17 -r1.17.88.1
--- sc/source/filter/xml/xmlcvali.cxx	26 Nov 2004 12:30:24 -0000	1.17
+++ sc/source/filter/xml/xmlcvali.cxx	18 Feb 2005 11:34:31 -0000	1.17.88.1
@@ -307,7 +307,7 @@ ScXMLContentValidationContext::ScXMLCont
 			case XML_TOK_CONTENT_VALIDATION_CONDITION:
                 {
 				    sal_uInt16 nPrefix = GetImport().GetNamespaceMap().
-						    GetKeyByAttrName( sValue, &sCondition );
+						    _GetKeyByAttrName( sValue, &sCondition, sal_False );
 				    if (XML_NAMESPACE_OOOC != nPrefix)
                         sCondition = sValue;
                 }
Index: sc/source/filter/xml/xmlexprt.cxx
===================================================================
RCS file: /cvs/sc/sc/source/filter/xml/xmlexprt.cxx,v
retrieving revision 1.188
retrieving revision 1.188.18.1
diff -u -p -r1.188 -r1.188.18.1
--- sc/source/filter/xml/xmlexprt.cxx	27 Jan 2005 11:14:13 -0000	1.188
+++ sc/source/filter/xml/xmlexprt.cxx	18 Feb 2005 11:34:31 -0000	1.188.18.1
@@ -2514,14 +2514,11 @@ void ScXMLExport::WriteCell (ScMyCell& a
 					rtl::OUString sOUFormula(sFormula.makeStringAndClear());
 					if (!bIsMatrix)
                     {
-                        rtl::OUString sQValue = GetNamespaceMap().GetQNameByKey( XML_NAMESPACE_OOOC, sOUFormula );
-						AddAttribute(sAttrFormula, sQValue);
+						AddAttribute(sAttrFormula, GetNamespaceMap().GetQNameByKey( XML_NAMESPACE_OOOC, sOUFormula, sal_False ));
                     }
 					else
 					{
-						rtl::OUString sMatrixFormula = sOUFormula.copy(1, sOUFormula.getLength() - 2);
-                        rtl::OUString sQValue = GetNamespaceMap().GetQNameByKey( XML_NAMESPACE_OOOC, sMatrixFormula );
-						AddAttribute(sAttrFormula, sQValue);
+						AddAttribute(sAttrFormula, GetNamespaceMap().GetQNameByKey( XML_NAMESPACE_OOOC, sOUFormula.copy(1, sOUFormula.getLength() - 2), sal_False ));
 					}
 				}
 				if (pFormulaCell->IsValue())
Index: sc/source/ui/app/transobj.cxx
===================================================================
RCS file: /cvs/sc/sc/source/ui/app/transobj.cxx,v
retrieving revision 1.25
retrieving revision 1.24.46.2
diff -u -p -r1.25 -r1.24.46.2
--- sc/source/ui/app/transobj.cxx	7 Feb 2005 14:42:52 -0000	1.25
+++ sc/source/ui/app/transobj.cxx	21 Feb 2005 18:39:22 -0000	1.24.46.2
@@ -617,6 +617,8 @@ void ScTransferObj::InitDocShell()
 		ScMarkData aDestMark;
 		aDestMark.SelectTable( 0, TRUE );
 
+        pDestDoc->SetDocOptions( pDoc->GetDocOptions() );   // #i42666#
+
 		String aTabName;
 		pDoc->GetName( aBlock.aStart.Tab(), aTabName );
 		pDestDoc->RenameTab( 0, aTabName, FALSE );			// no UpdateRef (empty)
Index: sc/source/ui/cctrl/cbuttonw.cxx
===================================================================
RCS file: /cvs/sc/sc/source/ui/cctrl/cbuttonw.cxx,v
retrieving revision 1.3
retrieving revision 1.3.754.1
diff -u -p -r1.3 -r1.3.754.1
--- sc/source/ui/cctrl/cbuttonw.cxx	1 Aug 2002 14:36:42 -0000	1.3
+++ sc/source/ui/cctrl/cbuttonw.cxx	18 Feb 2005 15:40:54 -0000	1.3.754.1
@@ -105,6 +105,9 @@ void ScDDComboBoxButton::Draw( const Poi
                                BOOL         bState,
 							   BOOL			bBtnIn  /* = FALSE */ )
 {
+    if ( rSize.Width() == 0 || rSize.Height() == 0 )
+        return;     // #i43092# rectangle with size 0 would have RECT_EMPTY as end position
+
 	// save old state
 	BOOL		bHadFill   = pOut->IsFillColor();
 	Color		aOldFill   = pOut->GetFillColor();
Index: sc/source/ui/docshell/docfunc.cxx
===================================================================
RCS file: /cvs/sc/sc/source/ui/docshell/docfunc.cxx,v
retrieving revision 1.52
retrieving revision 1.52.186.1
diff -u -p -r1.52 -r1.52.186.1
--- sc/source/ui/docshell/docfunc.cxx	8 Sep 2004 13:52:34 -0000	1.52
+++ sc/source/ui/docshell/docfunc.cxx	14 Feb 2005 16:40:45 -0000	1.52.186.1
@@ -884,7 +884,7 @@ void ScDocFunc::NotifyInputHandler( cons
 
 		typedef ::std::list<ScMyRememberItem*> ScMyRememberItemList;
 
-BOOL ScDocFunc::PutData( const ScAddress& rPos, EditEngine& rEngine, BOOL bInterpret, BOOL bApi )
+BOOL ScDocFunc::PutData( const ScAddress& rPos, ScEditEngineDefaulter& rEngine, BOOL bInterpret, BOOL bApi )
 {
 	//	PutData ruft PutCell oder SetNormalString
 
Index: sc/source/ui/docshell/docsh4.cxx
===================================================================
RCS file: /cvs/sc/sc/source/ui/docshell/docsh4.cxx,v
retrieving revision 1.41
retrieving revision 1.41.88.1
diff -u -p -r1.41 -r1.41.88.1
--- sc/source/ui/docshell/docsh4.cxx	26 Nov 2004 15:04:13 -0000	1.41
+++ sc/source/ui/docshell/docsh4.cxx	10 Feb 2005 14:01:44 -0000	1.41.88.1
@@ -1906,6 +1906,7 @@ void ScDocShell::Print( SfxProgress& rPr
 			long nTabStart = 0;
 			long nDisplayStart = 0;
 			long nAttrPage = 1;
+            long nPrinted = 0;
 
 			for ( nTab=0; nTab<nTabCount; nTab++ )
 			{
@@ -1926,7 +1927,7 @@ void ScDocShell::Print( SfxProgress& rPr
 
 					ScPrintFunc aPrintFunc( this, pPrinter, nTab, nAttrPage, nTotalPages, pMarkedRange, &aOptions );
 					aPrintFunc.SetDrawView( pDrawView );
-					aPrintFunc.DoPrint( aPageRanges, nTabStart, nDisplayStart, TRUE, &rProgress, NULL );
+                    nPrinted += aPrintFunc.DoPrint( aPageRanges, nTabStart, nDisplayStart, TRUE, &rProgress, NULL );
 
 					nTabStart += aPageArr[nTab];
 					if ( aDocument.NeedPageResetAfterTab(nTab) )
@@ -1938,6 +1939,17 @@ void ScDocShell::Print( SfxProgress& rPr
 					delete pDrawView;
 				}
 			}
+
+            if ( n+1 < nCollateCopies && pPrinter->GetDuplexMode() == DUPLEX_ON && ( nPrinted % 2 ) == 1 )
+            {
+                // #105584# when several collated copies are printed in duplex mode, and there is
+                // an odd number of pages, print an empty page between copies, so the first page of
+                // the second copy isn't printed on the back of the last page of the first copy.
+                // (same as in Writer ViewShell::Prt)
+
+                pPrinter->StartPage();
+                pPrinter->EndPage();
+            }
 		}
 	}
 
Index: sc/source/ui/inc/docfunc.hxx
===================================================================
RCS file: /cvs/sc/sc/source/ui/inc/docfunc.hxx,v
retrieving revision 1.10
retrieving revision 1.10.186.1
diff -u -p -r1.10 -r1.10.186.1
--- sc/source/ui/inc/docfunc.hxx	8 Sep 2004 13:55:07 -0000	1.10
+++ sc/source/ui/inc/docfunc.hxx	14 Feb 2005 16:40:27 -0000	1.10.186.1
@@ -74,7 +74,7 @@
 #include "postit.hxx"
 #endif
 
-class EditEngine;
+class ScEditEngineDefaulter;
 class SfxUndoAction;
 class ScAddress;
 class ScDocShell;
@@ -123,7 +123,7 @@ public:
 
 	BOOL			SetNormalString( const ScAddress& rPos, const String& rText, BOOL bApi );
 	BOOL			PutCell( const ScAddress& rPos, ScBaseCell* pNewCell, BOOL bApi );
-	BOOL			PutData( const ScAddress& rPos, EditEngine& rEngine,
+	BOOL			PutData( const ScAddress& rPos, ScEditEngineDefaulter& rEngine,
 								BOOL bInterpret, BOOL bApi );
 	BOOL			SetCellText( const ScAddress& rPos, const String& rText,
 									BOOL bInterpret, BOOL bEnglish, BOOL bApi );
Index: sc/source/ui/inc/gridwin.hxx
===================================================================
RCS file: /cvs/sc/sc/source/ui/inc/gridwin.hxx,v
retrieving revision 1.19
retrieving revision 1.19.94.1
diff -u -p -r1.19 -r1.19.94.1
--- sc/source/ui/inc/gridwin.hxx	15 Nov 2004 16:37:38 -0000	1.19
+++ sc/source/ui/inc/gridwin.hxx	16 Feb 2005 09:34:41 -0000	1.19.94.1
@@ -169,6 +169,7 @@ private:
 	USHORT					nButtonDown;
 	BOOL					bEEMouse;				// Edit-Engine hat Maus
 	BYTE					nMouseStatus;
+    BYTE                    nNestedButtonState;     // track nested button up/down calls
 
 	BOOL					bPivotMouse;			// Pivot-D&D (alte Pivottabellen)
 	ScPivot*				pDragPivot;
@@ -264,6 +265,8 @@ private:
 	sal_Int8		ExecutePrivateDrop( const ExecuteDropEvent& rEvt );
 	sal_Int8		DropTransferObj( ScTransferObj* pTransObj, SCCOL nDestPosX, SCROW nDestPosY,
 									const Point& rLogicPos, sal_Int8 nDndAction );
+
+    void            HandleMouseButtonDown( const MouseEvent& rMEvt );
 
 	BOOL			DrawMouseButtonDown(const MouseEvent& rMEvt);
 	BOOL			DrawMouseButtonUp(const MouseEvent& rMEvt);

Index: sc/source/ui/view/gridwin.cxx
===================================================================
RCS file: /cvs/sc/sc/source/ui/view/gridwin.cxx,v
retrieving revision 1.67
retrieving revision 1.67.92.1
diff -u -p -r1.67 -r1.67.92.1
--- sc/source/ui/view/gridwin.cxx	15 Nov 2004 16:38:47 -0000	1.67
+++ sc/source/ui/view/gridwin.cxx	16 Feb 2005 09:35:05 -0000	1.67.92.1
@@ -168,6 +168,10 @@
 
 using namespace com::sun::star;
 
+const BYTE SC_NESTEDBUTTON_NONE = 0;
+const BYTE SC_NESTEDBUTTON_DOWN = 1;
+const BYTE SC_NESTEDBUTTON_UP   = 2;
+
 #define SC_AUTOFILTER_ALL		0
 #define	SC_AUTOFILTER_CUSTOM	1
 #define	SC_AUTOFILTER_TOP10		2
@@ -468,6 +472,7 @@ ScGridWindow::ScGridWindow( Window* pPar
 			bEEMouse( FALSE ),
 			nButtonDown( 0 ),
 			nMouseStatus( SC_GM_NONE ),
+            nNestedButtonState( SC_NESTEDBUTTON_NONE ),
 			bPivotMouse( FALSE ),
 			bDPMouse( FALSE ),
 			bRFMouse( FALSE ),
@@ -1523,6 +1528,27 @@ BOOL ScGridWindow::TestMouse( const Mous
 
 void __EXPORT ScGridWindow::MouseButtonDown( const MouseEvent& rMEvt )
 {
+    nNestedButtonState = SC_NESTEDBUTTON_DOWN;
+
+    HandleMouseButtonDown( rMEvt );
+
+    if ( nNestedButtonState == SC_NESTEDBUTTON_UP )
+    {
+        // #i41690# If an object is deactivated from MouseButtonDown, it might reschedule,
+        // so MouseButtonUp comes before the MouseButtonDown call is finished. In this case,
+        // simulate another MouseButtonUp call, so the selection state is consistent.
+
+        nButtonDown = rMEvt.GetButtons();
+        FakeButtonUp();
+
+        if ( IsTracking() )
+            EndTracking();      // normally done in VCL as part of MouseButtonUp handling
+    }
+    nNestedButtonState = SC_NESTEDBUTTON_NONE;
+}
+
+void ScGridWindow::HandleMouseButtonDown( const MouseEvent& rMEvt )
+{
 	aCurMousePos = rMEvt.GetPosPixel();
 
 	//	Filter-Popup beendet sich mit eigenem Mausklick, nicht erst beim Klick
@@ -1867,6 +1893,12 @@ void __EXPORT ScGridWindow::MouseButtonU
 	aCurMousePos = rMEvt.GetPosPixel();
 	ScDocument* pDoc = pViewData->GetDocument();
 	ScMarkData& rMark = pViewData->GetMarkData();
+
+    // #i41690# detect a MouseButtonUp call from within MouseButtonDown
+    // (possible through Reschedule from storing an OLE object that is deselected)
+
+    if ( nNestedButtonState == SC_NESTEDBUTTON_DOWN )
+        nNestedButtonState = SC_NESTEDBUTTON_UP;
 
 	if (nButtonDown != rMEvt.GetButtons())
 		nMouseStatus = SC_GM_IGNORE;			// reset und return
Index: sc/source/ui/view/output2.cxx
===================================================================
RCS file: /cvs/sc/sc/source/ui/view/output2.cxx,v
retrieving revision 1.44
retrieving revision 1.44.130.1
diff -u -p -r1.44 -r1.44.130.1
--- sc/source/ui/view/output2.cxx	28 Oct 2004 09:57:25 -0000	1.44
+++ sc/source/ui/view/output2.cxx	18 Feb 2005 16:06:49 -0000	1.44.130.1
@@ -1383,7 +1383,7 @@ void ScOutputData::DrawStrings( BOOL bPi
 				ScBaseCell* pCell = NULL;
 				if (bDoCell)
 				{
-					if ( nCellY == nY && nCellX >= nX1 && nCellX <= nX2 )
+					if ( nCellY == nY && nCellX == nX && nCellX >= nX1 && nCellX <= nX2 )
 						pCell = pThisRowInfo->pCellInfo[nCellX+1].pCell;
 					else
 						GetVisibleCell( nCellX, nCellY, nTab, pCell );		// get from document
@@ -2069,7 +2069,8 @@ void ScOutputData::DrawEdit(BOOL bPixelT
 					const SfxItemSet* pCondSet;
 					if (bDoCell)
 					{
-						if ( nCellY == nY && nCellX >= nX1 && nCellX <= nX2 )
+                        if ( nCellY == nY && nCellX >= nX1 && nCellX <= nX2 &&
+                             (pDoc->GetColFlags(nCellX,nTab) & CR_HIDDEN) == 0 )
 						{
 							CellInfo& rCellInfo = pThisRowInfo->pCellInfo[nCellX+1];
 							pPattern = rCellInfo.pPatternAttr;
Index: sw/source/filter/xml/xmltble.cxx
===================================================================
RCS file: /cvs/sw/sw/source/filter/xml/xmltble.cxx,v
retrieving revision 1.31
retrieving revision 1.31.178.1
diff -u -p -r1.31 -r1.31.178.1
--- sw/source/filter/xml/xmltble.cxx	26 Nov 2004 13:30:27 -0000	1.31
+++ sw/source/filter/xml/xmltble.cxx	18 Feb 2005 11:37:38 -0000	1.31.178.1
@@ -942,7 +942,7 @@ void SwXMLExport::ExportTableBox( const 
 			    {
 					OUString sQValue = 
 						GetNamespaceMap().GetQNameByKey( 
-								XML_NAMESPACE_OOOW, sCellFormula );
+								XML_NAMESPACE_OOOW, sCellFormula, sal_False );
 				    // formula
 				    AddAttribute(XML_NAMESPACE_TABLE, XML_FORMULA, sQValue );
 			    }
Index: sw/source/filter/xml/xmltbli.cxx
===================================================================
RCS file: /cvs/sw/sw/source/filter/xml/xmltbli.cxx,v
retrieving revision 1.48
retrieving revision 1.48.308.1
diff -u -p -r1.48 -r1.48.308.1
--- sw/source/filter/xml/xmltbli.cxx	4 Oct 2004 19:22:53 -0000	1.48
+++ sw/source/filter/xml/xmltbli.cxx	18 Feb 2005 11:37:39 -0000	1.48.308.1
@@ -555,7 +555,7 @@ SwXMLTableCellContext_Impl::SwXMLTableCe
 			{
 				OUString sTmp;
 				sal_uInt16 nPrefix = GetImport().GetNamespaceMap().
-						GetKeyByAttrName( rValue, &sTmp );
+						_GetKeyByAttrName( rValue, &sTmp, sal_False );
 				sFormula = XML_NAMESPACE_OOOW == nPrefix ? sTmp : rValue;
 			}
 			break;
