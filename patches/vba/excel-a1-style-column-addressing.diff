--- /data4/sles/ooo-build-m6/ooo-build/build/ooc680-m6/sc/inc/address.hxx	2006-07-11 13:54:25.000000000 +0100
+++ sc/inc/address.hxx	2006-07-11 12:15:45.000000000 +0100
@@ -221,6 +221,7 @@ inline bool ValidColRowTab( SCCOL nCol, 
 #define SCA_VALID_ROW       0x0100
 #define SCA_VALID_COL       0x0200
 #define SCA_VALID_TAB       0x0400
+#define SCA_COLROWADDR      0x0800
 #define SCA_VALID_ROW2      0x1000
 #define SCA_VALID_COL2      0x2000
 #define SCA_VALID_TAB2      0x4000
--- /data4/sles/ooo-build-m6/ooo-build/build/ooc680-m6/sc/source/core/tool/address.cxx	2006-07-11 13:54:25.000000000 +0100
+++ sc/source/core/tool/address.cxx	2006-07-11 14:44:05.000000000 +0100
@@ -42,6 +42,12 @@
 
 #include "globstr.hrc"
 
+#include <com/sun/star/frame/XModel.hpp>
+#include <com/sun/star/beans/XPropertySet.hpp>
+#include <sfx2/objsh.hxx>
+#include <tools/urlobj.hxx>
+using namespace ::com::sun::star;
+
 ////////////////////////////////////////////////////////////////////////////
 const ScAddress::Details ScAddress::detailsOOOa1( CONV_OOO, 0, 0 );
 
@@ -393,7 +399,13 @@ lcl_ConvertSingleRef( BOOL& bExternal, c
                 nCol = ((nCol + 1) * 26) + toupper( char(*p++) ) - 'A';
         }
         else
-            nBits = 0;
+	{
+            //nBits = 0;
+            // Assume "10:20" for full rows
+            nBits &= ~SCA_VALID_COL;
+            nBits |= SCA_COLROWADDR;
+            nCol = MAXCOL;
+	}
 
         if( nCol > MAXCOL || CharClass::isAsciiAlpha( *p ) )
             nBits = 0;
@@ -427,6 +439,13 @@ lcl_ConvertSingleRef( BOOL& bExternal, c
         if( !nBits )
             p = q;
     }
+    else // assume its "E:F" for full Column
+    {
+        //nBits = SCA_VALID_ROW ;
+        nBits |= SCA_COLROWADDR;
+        nRow = MAXROW;
+        nRes |= nBits;
+    }
     if ( bNeedExtTab )
     {
         if ( (nRes & SCA_VALID_ROW) && (nRes & SCA_VALID_COL)
@@ -437,7 +456,7 @@ lcl_ConvertSingleRef( BOOL& bExternal, c
         else
             nRes = 0;   // #NAME? statt #REF!, Dateiname bleibt erhalten
     }
-    if ( !(nRes & SCA_VALID_ROW) && (nRes & SCA_VALID_COL)
+    if ( !( nRes & SCA_COLROWADDR) && !(nRes & SCA_VALID_ROW) && (nRes & SCA_VALID_COL)
             && !( (nRes & SCA_TAB_3D) && (nRes & SCA_VALID_TAB)) )
     {   // keine Row, keine Tab, aber Col => DM (...), B (...) o.ae.
         nRes = 0;
@@ -600,6 +619,9 @@ USHORT ScRange::Parse( const String& r, 
             aEnd = aStart;  // die Tab _muss_ gleich sein, so ist`s weniger Code
             if ( nRes2 = lcl_ConvertSingleRef( bExternal, p + nPos+ 1, pDoc, aEnd, rDetails ) )
             {
+                bool bColRowFormat1 = ( ( nRes1 & SCA_COLROWADDR ) == SCA_COLROWADDR );
+                bool bColRowFormat2 = ( ( nRes2 & SCA_COLROWADDR ) == SCA_COLROWADDR );
+
                 if ( bExternal && aStart.Tab() != aEnd.Tab() )
                     nRes2 &= ~SCA_VALID_TAB;    // #REF!
                 else
@@ -640,6 +662,37 @@ USHORT ScRange::Parse( const String& r, 
                             == ( SCA_TAB_ABSOLUTE | SCA_TAB_3D ))
                             && !(nRes2 & SCA_TAB_3D) )
                         nRes2 |= SCA_TAB_ABSOLUTE;
+
+                    // "E:F" is legal but "E1:F" 
+                    // or "10:12" is legal but "10:z5" is not
+                    if  ( bColRowFormat2 || bColRowFormat1 ) 
+                    {
+                    	if ( ( bColRowFormat2 && bColRowFormat1 ) ) 
+                        {
+                            USHORT nBits = 0;
+                            if ( ( nRes1 & nRes2 ) & SCA_VALID_COL  )
+                            {
+                                // make sure the whole column range
+                                // is in the range
+                                nBits = ( SCA_VALID | SCA_VALID_ROW);
+                                aStart.SetRow(0);
+                            }
+                            else if ( ( nRes1 & nRes2 ) & SCA_VALID_ROW  )
+                            {
+                                // make sure the whole row range
+                                // is in the range
+                                nBits = ( SCA_VALID | SCA_VALID_COL );
+                                aStart.SetCol(0);
+                            }
+                            else
+                                nBits &= ( ~SCA_VALID_COL | ~SCA_VALID_ROW );
+
+                            nRes1 |= nBits;
+                            nRes2 |= nBits;
+                        }		
+                        else
+                            nRes2 &= ( ~SCA_VALID_COL | ~SCA_VALID_ROW ); // raise error
+                    }
                 }
             }
             else
@@ -661,14 +714,101 @@ USHORT ScRange::ParseAny( const String& 
         SCA_VALID_TAB2;
     if ( (nRet & nValid) != nValid )
     {
+	// single address
         ScAddress aAdr;
         nRet = aAdr.Parse( r, pDoc, rDetails );
-        if ( nRet & SCA_VALID )
+        if ( nRet & ( SCA_VALID | SCA_COLROWADDR ) )
+        {
             aStart = aEnd = aAdr;
+            if ( nRet &  SCA_COLROWADDR )
+            {
+                if ( nRet & SCA_VALID_COL )
+                {
+                    aStart.SetRow(0);
+                    USHORT  nBits = SCA_VALID_ROW;
+                    nBits |= SCA_VALID;
+		    nRet |= nBits;
+                }
+                else if ( nRet & SCA_VALID_ROW )
+                {
+                    aStart.SetCol(0);
+                    USHORT  nBits = SCA_VALID_COL;
+                    nBits |= SCA_VALID;
+		    nRet |= nBits;
+                }
+
+            }
+        }
     }
     return nRet;
 }
 
+static String 
+getFileNameFromDoc(  ScDocument* pDoc )
+{
+	String sFileName;
+	SfxObjectShell* pShell = NULL;
+	if ( pDoc && ( pShell = pDoc->GetDocumentShell() ) )
+	{
+		uno::Reference< frame::XModel > xModel( pShell->GetModel(), uno::UNO_QUERY );
+		if ( xModel.is() )
+		{
+			if ( xModel->getURL().getLength() )
+			{
+				INetURLObject aURL( xModel->getURL() );
+				sFileName = aURL.GetLastName();
+			}
+			else
+				sFileName = pShell->GetTitle();
+		}		
+	}
+	return sFileName;
+}
+
+static void 
+append_external_address( String &r, USHORT nFlags, ScDocument* pDoc, USHORT nTab, const ScAddress::Details& rDetails)
+{
+	if( nFlags & SCA_TAB_3D )
+	{
+		String aTabName;
+
+		pDoc->GetName( nTab, aTabName );
+		//  externe Referenzen (wie in ScCompiler::MakeTabStr)
+		String aDoc;
+		if ( aTabName.GetChar(0) == '\'' )
+		{   // "'Doc'#Tab"
+			xub_StrLen nPos, nLen = 1;
+			while( (nPos = aTabName.Search( '\'', nLen ))
+				!= STRING_NOTFOUND )
+			nLen = nPos + 1;
+			if ( aTabName.GetChar(nLen) == SC_COMPILER_FILE_TAB_SEP )
+			{
+				aDoc = aTabName.Copy( 0, nLen + 1 );
+				aTabName.Erase( 0, nLen + 1 );
+			}
+		}
+		ScCompiler::CheckTabQuotes( aTabName );
+	
+		if (rDetails.eConv != ScAddress::CONV_OOO) {
+			String sDocName = getFileNameFromDoc( pDoc );
+			if ( sDocName.Len() ) // ahem, what to do if there is no doc name
+			{
+				r += '[';
+				r += sDocName;
+				r += ']';
+			}
+			r += aTabName;
+			r += '!';
+		} else {
+			r += aDoc;
+			if( nFlags & SCA_TAB_ABSOLUTE )
+				r += '$';
+			r += aTabName;
+			r += '.';
+		}
+	}	
+}
+
 static void
 r1c1_append_c ( String &r, int num, bool is_abs,
 				const ScAddress::Details& rDetails )
@@ -718,38 +875,7 @@ void ScAddress::Format( String& r, USHOR
             return;
         }
 //      if( nFlags & ( SCA_TAB_ABSOLUTE | SCA_TAB_3D ) )
-        if( nFlags & SCA_TAB_3D )
-        {
-            String aTabName;
-            pDoc->GetName( nTab, aTabName );
-
-            //  externe Referenzen (wie in ScCompiler::MakeTabStr)
-            String aDoc;
-            if ( aTabName.GetChar(0) == '\'' )
-            {   // "'Doc'#Tab"
-                xub_StrLen nPos, nLen = 1;
-                while( (nPos = aTabName.Search( '\'', nLen ))
-                        != STRING_NOTFOUND )
-                    nLen = nPos + 1;
-                if ( aTabName.GetChar(nLen) == SC_COMPILER_FILE_TAB_SEP )
-                {
-                    aDoc = aTabName.Copy( 0, nLen + 1 );
-                    aTabName.Erase( 0, nLen + 1 );
-                }
-            }
-            r += aDoc;
-            ScCompiler::CheckTabQuotes( aTabName );
-
-			if (rDetails.eConv != CONV_OOO) {
-				r += aTabName;
-				r += '!';
-			} else {
-            if( nFlags & SCA_TAB_ABSOLUTE )
-                r += '$';
-            r += aTabName;
-            r += '.';
-        }
-    }
+	    append_external_address( r, nFlags, pDoc, nTab, rDetails );
     }
 	switch (rDetails.eConv) {
 	default :
@@ -812,22 +938,51 @@ void ScRange::Format( String& r, USHORT 
 
 	case ScAddress::CONV_XL_A1: {
 		BOOL bOneTab = (aStart.Tab() == aEnd.Tab());
-
-		pDoc = NULL;
-		aStart.Format( r, nFlags, pDoc, rDetails );
-		if( aStart != aEnd )
+		USHORT nTmpFlags = nFlags;
+		String aName;
+		if (  aStart.Col() == 0 && aEnd.Col() >= MAXCOLCOUNT-1 )
 		{
-			String aName;
-			nFlags = ( nFlags & SCA_VALID ) | ( ( nFlags >> 4 ) & 0x070F );
-			aEnd.Format( aName, nFlags, pDoc, rDetails );
-			r += ':';
-			r += aName;
+			// if range is a full row the address is like $2 
+			// ( with no col letter )
+			nFlags &= ~SCA_VALID_COL;
+			nFlags |= ( SCA_VALID_ROW | SCA_VALID_TAB );
+			nFlags &= ~SCA_VALID; // daft Format code
+			aStart.Format( r, nFlags, pDoc, rDetails );
+			aEnd.Format( aName, nFlags, NULL, rDetails );
 		}
-}
+		else if ( aStart.Row() == 0 && aEnd.Row() >= MAXROWCOUNT-1 )
+		{
+			// if range is a full column the address is like $C 
+			// ( with no row num )
+			nFlags &= ~SCA_VALID_ROW;
+			nFlags |= ( SCA_VALID_COL | SCA_VALID_TAB );
+			nFlags &= ~SCA_VALID; // daft Format code
+			aStart.Format( r, nFlags, pDoc, rDetails );
+			aEnd.Format( aName, nFlags, NULL, rDetails );
+		}
+		else
+		{
+			aStart.Format( r, nFlags, pDoc, rDetails );
+			if( aStart != aEnd )
+			{
+				pDoc = NULL;
+				nFlags = ( nFlags & SCA_VALID ) | ( ( nFlags >> 4 ) & 0x070F );
+				aEnd.Format( aName, nFlags, pDoc, rDetails );
+			}
+		}
+		if ( aName.Len() )
+		{
+				r += ':';
+				r += aName;
+		}
+	}
 	break;
 
 	case ScAddress::CONV_XL_R1C1:
 #define	absrel_differ(nFlags, mask)	(((nFlags) & (mask)) ^ (((nFlags) >> 4) & (mask)))
+	
+		append_external_address( r, nFlags, pDoc, aStart.Tab(), rDetails );
+		
 		/* be sure to use else if so that a1:iv65535 does not vanish */
 		if( aStart.Col() == 0 && aEnd.Col() >= MAXCOLCOUNT-1 )
 		{
