Index: svx/source/form/fmundo.cxx
===================================================================
RCS file: /cvs/graphics/svx/source/form/fmundo.cxx,v
retrieving revision 1.31
diff -u -r1.31 fmundo.cxx
--- svx/source/form/fmundo.cxx	13 Apr 2005 08:30:13 -0000	1.31
+++ svx/source/form/fmundo.cxx	31 Aug 2005 08:39:38 -0000
@@ -181,6 +181,10 @@
 #include <comphelper/stl_types.hxx>
 #endif
 
+#ifdef ENABLE_VBA
+#include "formControlVBAHandler.hxx"
+#endif
+
 using namespace ::com::sun::star::uno;
 using namespace ::com::sun::star::awt;
 using namespace ::com::sun::star::beans;
@@ -232,6 +236,9 @@
 				   ,m_pPropertySetCache(NULL)
 {
 	DBG_CTOR(FmXUndoEnvironment,NULL);
+#ifdef ENABLE_VBA
+	m_vbaListener = new VBAScriptEventListener( rModel );
+#endif
 }
 
 //------------------------------------------------------------------------------
@@ -810,9 +817,19 @@
 	    Reference< XEventAttacherManager > xManager( _rxContainer, UNO_QUERY );
 	    if ( xManager.is() )
             if ( _bStartListening )
+            {
 		        xManager->addScriptListener( this );
+#ifdef ENABLE_VBA
+		        xManager->addScriptListener( m_vbaListener );
+#endif
+            }
             else
+            {
 		        xManager->removeScriptListener( this );
+#ifdef ENABLE_VBA
+		        xManager->removeScriptListener( m_vbaListener );
+#endif
+            }
 
         // also handle all children of this element
 	    sal_uInt32 nCount = _rxContainer->getCount();
@@ -921,12 +938,18 @@
 	{
 		Reference< XInterface >  xThis;
 		evt.Helper >>= xThis;
-
-		aSolarGuard.clear();
 		if (xThis.is())
 		{
 			::rtl::OUString sScriptType = evt.ScriptType;
 			::rtl::OUString sScriptCode = evt.ScriptCode;
+
+#ifdef ENABLE_VBA
+			static const ::rtl::OUString vbaInterOp =
+				::rtl::OUString::createFromAscii("VBAInterop");
+                        if ( sScriptType.equals(vbaInterOp) )
+                            return; // not handled here
+#endif
+
 			Sequence< Any > aArguments = evt.Arguments;
 
 			::rtl::OUString sMacroLocation;
