--- oovbaapi/genconstidl/ApiSAXHandler.pm	1970-01-01 01:00:00.000000000 +0100
+++ oovbaapi/genconstidl/ApiSAXHandler.pm	2007-07-13 14:08:01.000000000 +0200
@@ -0,0 +1,134 @@
+#*************************************************************************
+#
+#   OpenOffice.org - a multi-platform office productivity suite
+#
+#   $RCSfile$
+#
+#   $Revision$
+#
+#   last change: $Author$ $Date$
+#
+#   The Contents of this file are made available subject to
+#   the terms of GNU Lesser General Public License Version 2.1.
+#
+#
+#     GNU Lesser General Public License Version 2.1
+#     =============================================
+#     Copyright 2005 by Sun Microsystems, Inc.
+#     901 San Antonio Road, Palo Alto, CA 94303, USA
+#
+#     This library is free software; you can redistribute it and/or
+#     modify it under the terms of the GNU Lesser General Public
+#     License version 2.1, as published by the Free Software Foundation.
+#
+#     This library is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+#     Lesser General Public License for more details.
+#
+#     You should have received a copy of the GNU Lesser General Public
+#     License along with this library; if not, write to the Free Software
+#     Foundation, Inc., 59 Temple Place, Suite 330, Boston,
+#     MA  02111-1307  USA
+#
+#*************************************************************************
+
+package ApiSAXHandler;
+use base qw(XML::SAX::Base);
+
+my $state = "";
+my $source = "";
+my $name = "";
+my $value = "";
+
+my %result;
+
+# process element start event
+sub start_element {
+    my ($self, $el) = @_;
+    my $element = $el->{'Name'};
+
+    if ( $element eq "element" ) {
+        my $type = "$el->{'Attributes'}->{'{}type'}->{'Value'}";
+        if ( $type eq "constant" ) {
+            $state = "constant";
+            $source = "";
+            $name = "";
+            $value = "";
+        }
+    }
+    elsif ( $state eq "constant" && $element eq "source" ) {
+        $state = "source";
+        chomp( $source = "$el->{'Attributes'}->{'{}id'}->{'Value'}" );
+    }
+    elsif ( $state eq "source" && $element eq "name" ) {
+        $state = "name";
+    }
+    elsif ( $state eq "source" && $element eq "value" ) {
+        $state = "value";
+    }
+}
+
+# process element end event
+sub end_element {
+    my ($self, $el) = @_;
+    my $element = $el->{'Name'};
+
+    if ( $state eq "name" && $element eq "name" ) {
+        $state = "source";
+    }
+    elsif ( $state eq "value" && $element eq "value" ) {
+        $state = "source";
+    }
+    elsif ( $state ne "" && $element eq "element" ) {
+        $state = "";
+        
+        my @destination = split( /\./, $source );
+        my $module = shift( @destination );
+        my $type = shift( @destination );
+
+        $module =~ tr/[A-Z]/[a-z]/;
+
+        $result{$module} = {} unless exists $result{$module};
+        $result{$module}{$type} = [] unless exists $result{$module}{$type};
+
+        push( @{$result{$module}{$type}},
+              { "name" => $name, "value" => $value } );
+    }
+}
+
+# process characters
+sub characters {
+    my ($self, $data) = @_;
+    
+    if ( $state eq "name" ) {
+        chomp( $name = $data->{'Data'} );
+    }
+    elsif ( $state eq "value" ) {
+        chomp( $value = $data->{'Data'} );
+    }
+}
+
+# create idls from the parsed data
+sub generate_idls($$) {
+    my ($self, $path) = @_;
+    
+    foreach $module ( keys %result ) {
+        foreach $type ( keys %{$result{$module}} ) {
+            my $fname = $path . "/" . $type . ".idl";
+            open( IDL, ">$fname" ) || die "Cannot write $fname.";
+            
+            print IDL "module org { module openoffice { module $module {\n";
+            print IDL "    constants $type {\n";
+            foreach $constant ( @{$result{$module}{$type}} ) {
+                print IDL "        const long $constant->{'name'} = $constant->{'value'};\n";
+            }
+            print IDL "    };\n}; }; };\n";
+
+            close( IDL );
+        }
+    }
+}
+
+1; # needed by "use" or "require"
+# vim: set ts=4 shiftwidth=4 expandtab syntax=perl:
--- oovbaapi/genconstidl/api-to-idl.pl	1970-01-01 01:00:00.000000000 +0100
+++ oovbaapi/genconstidl/api-to-idl.pl	2007-07-13 13:47:07.000000000 +0200
@@ -0,0 +1,63 @@
+:
+    eval 'exec perl -S $0 ${1+"$@"}'
+        if 0;
+#*************************************************************************
+#
+#   OpenOffice.org - a multi-platform office productivity suite
+#
+#   $RCSfile$
+#
+#   $Revision$
+#
+#   last change: $Author$ $Date$
+#
+#   The Contents of this file are made available subject to
+#   the terms of GNU Lesser General Public License Version 2.1.
+#
+#
+#     GNU Lesser General Public License Version 2.1
+#     =============================================
+#     Copyright 2005 by Sun Microsystems, Inc.
+#     901 San Antonio Road, Palo Alto, CA 94303, USA
+#
+#     This library is free software; you can redistribute it and/or
+#     modify it under the terms of the GNU Lesser General Public
+#     License version 2.1, as published by the Free Software Foundation.
+#
+#     This library is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+#     Lesser General Public License for more details.
+#
+#     You should have received a copy of the GNU Lesser General Public
+#     License along with this library; if not, write to the Free Software
+#     Foundation, Inc., 59 Temple Place, Suite 330, Boston,
+#     MA  02111-1307  USA
+#
+#*************************************************************************
+
+use XML::SAX;
+use ApiSAXHandler;
+
+sub usage() {
+    print "Usage: api-to-idl.pl source.api destination_path\n";
+    print;
+    print "This tool converts oovbaapi *.api files into *.idl's.\n";
+    exit 1;
+}
+
+my $src = shift;
+my $dest = shift;
+
+if ( !defined( $src ) || !defined( $dest ) || $src eq "-h" || $src eq "--help" ) {
+    usage();
+}
+
+# Parse the input
+my $handler = ApiSAXHandler->new();
+
+my $parser = XML::SAX::ParserFactory->parser( Handler => $handler );
+$parser->parse_uri($src);
+
+# Generate the output
+$handler->generate_idls($dest);
--- oovbaapi/genconstidl/makefile.mk	2007-07-12 10:59:57.000000000 +0200
+++ oovbaapi/genconstidl/makefile.mk	2007-07-13 13:50:59.000000000 +0200
@@ -52,44 +52,20 @@ MYSYMFILES = access.api vba.api adodb.ap
 
 MY_GEN_IDL_PATH=$(MISC)$/idl
 
-.IF "$(SYSTEM_XALAN)" == "YES"
-MYCLASSPATH!:=$(MYCLASSPATH)$(PATH_SEPERATOR)$(XALAN_JAR)
-.IF "$(SERIALIZER_JAR)" != ""
-MYCLASSPATH!:=$(MYCLASSPATH)$(PATH_SEPERATOR)$(SERIALIZER_JAR)
-.ELSE # "$(SERIALIZER_JAR)" != ""
-MYCLASSPATH!:=$(MYCLASSPATH)$(PATH_SEPERATOR)$(SOLARBINDIR)$/serializer.jar
-.ENDIF # "$(SERIALIZER_JAR)" != ""
-.ELSE # "$(SYSTEM_XALAN)" == "YES"
-MYCLASSPATH!:=$(MYCLASSPATH)$(PATH_SEPERATOR)$(SOLARBINDIR)$/xalan.jar$(PATH_SEPERATOR)$(SOLARBINDIR)$/serializer.jar
-.ENDIF # "$(SYSTEM_XALAN)" == "YES"
-
-.IF "$(SYSTEM_XERCES)" == "YES"
-MYCLASSPATH!:=$(MYCLASSPATH)$(PATH_SEPERATOR)$(XERCES_JAR)
-.ELSE
-MYCLASSPATH!:=$(MYCLASSPATH)$(PATH_SEPERATOR)$(SOLARBINDIR)$/xercesImpl.jar
-.ENDIF
-
-.IF "$(SYSTEM_XML_APIS)" == "YES"
-MYCLASSPATH!:=$(MYCLASSPATH)$(PATH_SEPERATOR)$(XML_APIS_JAR)
-.ELSE
-MYCLASSPATH!:=$(MYCLASSPATH)$(PATH_SEPERATOR)$(SOLARBINDIR)$/xml-apis.jar
-.ENDIF
-
 MYDONEFILES += $(foreach,i,$(MYSYMFILES) $(MISC)$/$(i:b).done)
 
 # --- Targets ------------------------------------------------------
 
 ALLTAR: GENIDL
 
-GENIDL : $(MYDONEFILES) $(MY_GEN_IDL_PATH) 
+GENIDL : $(MY_GEN_IDL_PATH) $(MYDONEFILES)
 
 GENRDB : GENIDL $(MYURDFILES)
 
 $(MISC)$/%.done : %.api
-    @echo Parsing $?
-    +$(JAVAINTERPRETER) -cp $(MYCLASSPATH) -Xbootclasspath/p:$(MYCLASSPATH)\
-    org.apache.xalan.xslt.Process -v -xsl oovbaconsts.xsl -param IDL_DIRECTORY $(MISC)$/idl/ -in $?
-    $(TOUCH) $@
+    @echo Processing $?
+    $(PERL) api-to-idl.pl $? $(MY_GEN_IDL_PATH)
+    @$(TOUCH) $@
 
 $(MY_GEN_IDL_PATH) : 
     @@-$(MKDIR) $@
