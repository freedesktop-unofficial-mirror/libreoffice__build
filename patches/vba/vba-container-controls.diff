From f0936c5417ba19a28eaf6cb1b8055fdab3783df8 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:00:13 +0200
Subject: [PATCH 400/878] vba-container-controls.diff

---
 basic/source/uno/dlgcont.cxx                       |   80 +
 .../source/propctrlr/formcomponenthandler.cxx      |    5 +-
 scripting/source/dlgprov/dlgevtatt.cxx             |   74 +-
 scripting/source/dlgprov/dlgevtatt.hxx             |    1 +
 scripting/source/vbaevents/eventhelper.cxx         |   18 +-
 svx/inc/svx/msocximex.hxx                          |  368 +---
 svx/source/msfilter/msocximex.cxx                  | 2258 ++++++++++----------
 toolkit/inc/toolkit/awt/vclxwindows.hxx            |   89 +
 toolkit/inc/toolkit/controls/dialogcontrol.hxx     |  251 ++-
 .../inc/toolkit/controls/unocontrolcontainer.hxx   |   18 +-
 toolkit/inc/toolkit/controls/unocontrols.hxx       |   49 +-
 toolkit/inc/toolkit/helper/listenermultiplexer.hxx |   12 +
 toolkit/inc/toolkit/helper/macros.hxx              |   51 +
 toolkit/inc/toolkit/helper/property.hxx            |    3 +
 toolkit/inc/toolkit/helper/servicenames.hxx        |    6 +
 toolkit/source/awt/vclxtabcontrol.cxx              |    2 +-
 toolkit/source/awt/vclxtabcontrol.hxx              |    3 +-
 toolkit/source/awt/vclxtabpage.cxx                 |    3 +-
 toolkit/source/awt/vclxtoolkit.cxx                 |   26 +-
 toolkit/source/awt/vclxwindows.cxx                 |  410 ++++
 toolkit/source/controls/dialogcontrol.cxx          | 1493 ++++++++++---
 toolkit/source/controls/unocontrolcontainer.cxx    |    4 +-
 toolkit/source/controls/unocontrols.cxx            |   84 +-
 toolkit/source/helper/listenermultiplexer.cxx      |   15 +
 toolkit/source/helper/property.cxx                 |    5 +-
 toolkit/source/helper/registerservices.cxx         |   13 +-
 toolkit/source/helper/servicenames.cxx             |    4 +
 toolkit/source/helper/unowrapper.cxx               |    4 +
 vbahelper/source/msforms/vbacontrol.cxx            |   36 +-
 vbahelper/source/msforms/vbacontrol.hxx            |    1 -
 vbahelper/source/msforms/vbacontrols.cxx           |   24 +-
 vbahelper/source/msforms/vbamultipage.cxx          |   22 +-
 vbahelper/source/msforms/vbauserform.cxx           |   43 +-
 vbahelper/source/msforms/vbauserform.hxx           |    2 +
 vcl/inc/vcl/tabctrl.hxx                            |    1 +
 vcl/source/control/group.cxx                       |    1 +
 vcl/source/control/tabctrl.cxx                     |   34 +-
 xmlscript/inc/xmlscript/xmldlg_imexp.hxx           |    1 +
 xmlscript/source/xmldlg_imexp/common.hxx           |    1 +
 xmlscript/source/xmldlg_imexp/exp_share.hxx        |   26 +-
 xmlscript/source/xmldlg_imexp/imp_share.hxx        |   95 +-
 xmlscript/source/xmldlg_imexp/xmldlg_expmodels.cxx |  421 ++++-
 xmlscript/source/xmldlg_imexp/xmldlg_export.cxx    |  303 +---
 xmlscript/source/xmldlg_imexp/xmldlg_impmodels.cxx |  241 ++-
 xmlscript/source/xmldlg_imexp/xmldlg_import.cxx    |   58 +-
 xmlscript/util/makefile.mk                         |    2 +-
 46 files changed, 4269 insertions(+), 2392 deletions(-)

diff --git a/basic/source/uno/dlgcont.cxx b/basic/source/uno/dlgcont.cxx
index 07d02fd..ea7673e 100644
--- a/basic/source/uno/dlgcont.cxx
+++ b/basic/source/uno/dlgcont.cxx
@@ -40,6 +40,7 @@
 #include <com/sun/star/xml/sax/XExtendedDocumentHandler.hpp>
 #include "com/sun/star/resource/XStringResourceWithStorage.hpp"
 #include "com/sun/star/resource/XStringResourceWithLocation.hpp"
+#include "com/sun/star/document/XGraphicObjectResolver.hpp"
 #include "dlgcont.hxx"
 #include "sbmodule.hxx"
 #include <comphelper/processfactory.hxx>
@@ -73,6 +74,8 @@ using namespace osl;
 
 using com::sun::star::uno::Reference;
 
+#define GRAPHOBJ_URLPREFIX "vnd.sun.star.GraphicObject:"
+
 //============================================================================
 // Implementation class SfxDialogLibraryContainer
 
@@ -223,6 +226,35 @@ void SAL_CALL SfxDialogLibraryContainer::writeLibraryElement
     xInput->closeInput();
 }
 
+void lcl_deepInspectForEmbeddedImages( const Reference< XInterface >& xIf,  std::vector< rtl::OUString >& rvEmbedImgUrls )
+{
+    static rtl::OUString sImageURL= OUString(RTL_CONSTASCII_USTRINGPARAM( "ImageURL" ) );
+    Reference< beans::XPropertySet > xProps( xIf, UNO_QUERY );
+    if ( xProps.is() )
+    {
+
+        if ( xProps->getPropertySetInfo()->hasPropertyByName( sImageURL ) )
+        {
+            rtl::OUString sURL;
+            xProps->getPropertyValue( sImageURL ) >>= sURL;
+            if ( sURL.getLength() && sURL.compareToAscii( GRAPHOBJ_URLPREFIX, RTL_CONSTASCII_LENGTH( GRAPHOBJ_URLPREFIX ) ) == 0 )
+                rvEmbedImgUrls.push_back( sURL );
+        }
+    }
+    Reference< XNameContainer > xContainer( xIf, UNO_QUERY );
+    if ( xContainer.is() )
+    {
+        Sequence< rtl::OUString > sNames = xContainer->getElementNames();
+        sal_Int32 nContainees = sNames.getLength();
+        for ( sal_Int32 index = 0; index < nContainees; ++index )
+        {
+            Reference< XInterface > xCtrl;
+            xContainer->getByName( sNames[ index ] ) >>= xCtrl;
+            lcl_deepInspectForEmbeddedImages( xCtrl, rvEmbedImgUrls );
+        }
+    }
+}
+
 void SfxDialogLibraryContainer::storeLibrariesToStorage( const uno::Reference< embed::XStorage >& xStorage ) throw ( RuntimeException )
 {
     LibraryContainerMethodGuard aGuard( *this );
@@ -251,6 +283,54 @@ void SfxDialogLibraryContainer::storeLibrariesToStorage( const uno::Reference< e
 
     SfxLibraryContainer::storeLibrariesToStorage( xStorage );
 
+    // we need to export out any embedded image object(s)
+    // associated with any Dialogs. First, we need to actually gather any such urls
+    // for each dialog in this container
+    Sequence< OUString > sLibraries = getElementNames();
+    for ( sal_Int32 i=0; i < sLibraries.getLength(); ++i )
+    {
+        // libraries will already be loaded from above
+        Reference< XNameContainer > xLib;
+        getByName( sLibraries[ i ] ) >>= xLib;
+        if ( xLib.is() )
+        {
+            Sequence< OUString > sDialogs = xLib->getElementNames();
+            sal_Int32 nDialogs( sDialogs.getLength() );
+            for ( sal_Int32 j=0; j < nDialogs; ++j )
+            {
+                // Each Dialog has an associated xISP
+                Reference< io::XInputStreamProvider > xISP;
+                xLib->getByName( sDialogs[ j ] ) >>= xISP;
+                if ( xISP.is() )
+                {
+                    Reference< io::XInputStream > xInput( xISP->createInputStream() );
+                    Reference< XNameContainer > xDialogModel( mxMSF->createInstance
+                        ( OUString(RTL_CONSTASCII_USTRINGPARAM( "com.sun.star.awt.UnoControlDialogModel" ) ) ), UNO_QUERY );
+                    Reference< XComponentContext > xContext;
+                    Reference< beans::XPropertySet > xProps( mxMSF, UNO_QUERY );
+                    OSL_ASSERT( xProps.is() );
+                    OSL_VERIFY( xProps->getPropertyValue( OUString(RTL_CONSTASCII_USTRINGPARAM("DefaultContext")) ) >>= xContext );
+                    ::xmlscript::importDialogModel( xInput, xDialogModel, xContext, mxOwnerDocument );
+                    std::vector< rtl::OUString > vEmbeddedImageURLs;
+                    lcl_deepInspectForEmbeddedImages( Reference< XInterface >( xDialogModel, UNO_QUERY ),  vEmbeddedImageURLs );
+                    if ( vEmbeddedImageURLs.size() )
+                    {
+                        // Export the images to the storage
+                        Sequence< Any > aArgs( 1 );
+                        aArgs[ 0 ] <<= xStorage;
+                        Reference< document::XGraphicObjectResolver > xGraphicResolver( mxMSF->createInstanceWithArguments(  OUString(RTL_CONSTASCII_USTRINGPARAM("com.sun.star.comp.Svx.GraphicExportHelper" ) ), aArgs ), UNO_QUERY );
+                        std::vector< rtl::OUString >::iterator it = vEmbeddedImageURLs.begin();
+                        std::vector< rtl::OUString >::iterator it_end = vEmbeddedImageURLs.end();
+                        if ( xGraphicResolver.is() )
+                        {
+                            for ( sal_Int32 count = 0; it != it_end; ++it, ++count )
+                                xGraphicResolver->resolveGraphicObjectURL( *it );
+                        }
+                    }
+                }
+            }
+        }
+    }
     mbOasis2OOoFormat = sal_False;
 }
 
diff --git a/extensions/source/propctrlr/formcomponenthandler.cxx b/extensions/source/propctrlr/formcomponenthandler.cxx
index c84b33f..0daf9c0 100644
--- a/extensions/source/propctrlr/formcomponenthandler.cxx
+++ b/extensions/source/propctrlr/formcomponenthandler.cxx
@@ -2761,8 +2761,9 @@ namespace pcr
 
         aFileDlg.SetTitle(aStrTrans);
         // non-linked images ( e.g. those located in the document 
-        // stream ) cannot *currently* be handled by openoffice basic dialogs. 
-        bool bHandleNonLink = ( m_eComponentClass == eFormControl );
+        // stream ) only if document is available
+        Reference< XModel > xModel( impl_getContextDocument_nothrow() );
+        bool bHandleNonLink = xModel.is();
         
         Reference< XFilePickerControlAccess > xController(aFileDlg.GetFilePicker(), UNO_QUERY);
         DBG_ASSERT(xController.is(), "FormComponentPropertyHandler::impl_browseForImage_nothrow: missing the controller interface on the file picker!");
diff --git a/scripting/source/dlgprov/dlgevtatt.cxx b/scripting/source/dlgprov/dlgevtatt.cxx
index 4785563..9e2da8d 100644
--- a/scripting/source/dlgprov/dlgevtatt.cxx
+++ b/scripting/source/dlgprov/dlgevtatt.cxx
@@ -38,6 +38,7 @@
 #include <vcl/msgbox.hxx>
 #endif 
 #include <com/sun/star/awt/XControl.hpp>
+#include <com/sun/star/awt/XControlContainer.hpp>
 #include <com/sun/star/awt/XDialogEventHandler.hpp>
 #include <com/sun/star/awt/XContainerWindowEventHandler.hpp>
 #include <com/sun/star/beans/XPropertySet.hpp>
@@ -216,6 +217,9 @@ namespace dlgprov
             Reference< container::XNameContainer > xEventCont = xEventsSupplier->getEvents();
 
             Reference< XControlModel > xControlModel = xControl->getModel();
+            Reference< XPropertySet > xProps( xControlModel, uno::UNO_QUERY );
+            rtl::OUString sName;
+            xProps->getPropertyValue( rtl::OUString::createFromAscii("Name") ) >>= sName;
             if ( xEventCont.is() )
             {
                 Sequence< ::rtl::OUString > aNames = xEventCont->getElementNames();
@@ -288,6 +292,50 @@ namespace dlgprov
         }
     }
 
+
+    void DialogEventsAttacherImpl::nestedAttachEvents( const Sequence< Reference< XInterface > >& Objects, const Any& Helper, rtl::OUString& sDialogCodeName )
+    {
+        const Reference< XInterface >* pObjects = Objects.getConstArray();
+        sal_Int32 nObjCount = Objects.getLength();
+
+        for ( sal_Int32 i = 0; i < nObjCount; ++i )
+        {
+            // We know that we have to do with instances of XControl.
+            // Otherwise this is not the right implementation for
+            // XScriptEventsAttacher and we have to give up.
+            Reference< XControl > xControl( pObjects[ i ], UNO_QUERY );
+            Reference< XControlContainer > xControlContainer( xControl, UNO_QUERY );
+            Reference< XDialog > xDialog( xControl, UNO_QUERY );
+            if ( !xControl.is() )
+                throw IllegalArgumentException();
+
+            // get XEventsSupplier from control model
+            Reference< XControlModel > xControlModel = xControl->getModel();
+            Reference< XScriptEventsSupplier > xEventsSupplier( xControlModel, UNO_QUERY );
+            attachEventsToControl( xControl, xEventsSupplier, Helper );
+#ifdef FAKE_VBA_EVENT_SUPPORT
+            xEventsSupplier.set( getFakeVbaEventsSupplier( xControl, sDialogCodeName ) );
+            Any newHelper(xControl );
+            attachEventsToControl( xControl, xEventsSupplier, newHelper );
+#endif
+            if ( xControlContainer.is() && !xDialog.is() )
+            {
+                Sequence< Reference< XControl > > aControls = xControlContainer->getControls();
+                sal_Int32 nControlCount = aControls.getLength();
+
+                Sequence< Reference< XInterface > > aObjects( nControlCount );
+                Reference< XInterface >* pObjects = aObjects.getArray();
+                const Reference< XControl >* pControls = aControls.getConstArray();
+
+                for ( sal_Int32 i = 0; i < nControlCount; ++i )
+                {
+                    pObjects[i] = Reference< XInterface >( pControls[i], UNO_QUERY );
+                }
+                nestedAttachEvents( aObjects, Helper, sDialogCodeName );
+            }
+        }
+    }
+
     // -----------------------------------------------------------------------------
     // XScriptEventsAttacher
     // -----------------------------------------------------------------------------
@@ -321,12 +369,10 @@ namespace dlgprov
             }
         }
 
-        // go over all objects
-        const Reference< XInterface >* pObjects = Objects.getConstArray();
-        sal_Int32 nObjCount = Objects.getLength();
+        rtl::OUString sDialogCodeName;
 #ifdef FAKE_VBA_EVENT_SUPPORT
+        sal_Int32 nObjCount = Objects.getLength();
         Reference< awt::XControl > xDlgControl( Objects[ nObjCount - 1 ], uno::UNO_QUERY ); // last object is the dialog
-        rtl::OUString sDialogCodeName;
         if ( xDlgControl.is() )
         {
             Reference< XPropertySet > xProps( xDlgControl->getModel(), UNO_QUERY );
@@ -337,25 +383,7 @@ namespace dlgprov
             catch( Exception& ){}
         }
 #endif
-
-        for ( sal_Int32 i = 0; i < nObjCount; ++i )
-        {
-            // We know that we have to do with instances of XControl.
-            // Otherwise this is not the right implementation for
-            // XScriptEventsAttacher and we have to give up.
-            Reference< XControl > xControl( pObjects[ i ], UNO_QUERY );
-            if ( !xControl.is() )
-                throw IllegalArgumentException();
-
-            // get XEventsSupplier from control model
-            Reference< XControlModel > xControlModel = xControl->getModel();
-            Reference< XScriptEventsSupplier > xEventsSupplier( xControlModel, UNO_QUERY );
-            attachEventsToControl( xControl, xEventsSupplier, Helper );
-#ifdef FAKE_VBA_EVENT_SUPPORT
-            xEventsSupplier.set( getFakeVbaEventsSupplier( xControl, sDialogCodeName ) );
-            attachEventsToControl( xControl, xEventsSupplier, Helper );
-#endif
-        }
+        nestedAttachEvents( Objects, Helper, sDialogCodeName );
     }
 
 
diff --git a/scripting/source/dlgprov/dlgevtatt.hxx b/scripting/source/dlgprov/dlgevtatt.hxx
index c39433f..31adba4 100644
--- a/scripting/source/dlgprov/dlgevtatt.hxx
+++ b/scripting/source/dlgprov/dlgevtatt.hxx
@@ -73,6 +73,7 @@ namespace dlgprov
 #ifdef FAKE_VBA_EVENT_SUPPORT
         ::com::sun::star::uno::Reference< ::com::sun::star::script::XScriptEventsSupplier > getFakeVbaEventsSupplier( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControl>& xControl, rtl::OUString& sCodeName );
 #endif
+        void nestedAttachEvents( const ::com::sun::star::uno::Sequence< ::com::sun::star::uno::Reference< ::com::sun::star::uno::XInterface > >& Objects, const ::com::sun::star::uno::Any& Helper, rtl::OUString& sDialogCodeName );
         void  SAL_CALL attachEventsToControl( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControl>& xControl, const ::com::sun::star::uno::Reference< ::com::sun::star::script::XScriptEventsSupplier >& events, const ::com::sun::star::uno::Any& Helper  );
     public:
         DialogEventsAttacherImpl( const ::com::sun::star::uno::Reference< ::com::sun::star::uno::XComponentContext >& rxContext, 
diff --git a/scripting/source/vbaevents/eventhelper.cxx b/scripting/source/vbaevents/eventhelper.cxx
index b04c842..df872f2 100644
--- a/scripting/source/vbaevents/eventhelper.cxx
+++ b/scripting/source/vbaevents/eventhelper.cxx
@@ -36,6 +36,7 @@
 #include <com/sun/star/awt/XComboBox.hpp> //liuchen 2009-6-18
 #include <com/sun/star/awt/XRadioButton.hpp> //liuchen 2009-7-30
 #include <com/sun/star/awt/XListBox.hpp>
+#include <com/sun/star/awt/XSimpleTabController.hpp>
 
 #include <msforms/ReturnInteger.hpp>
 
@@ -52,6 +53,7 @@
 
 #include <com/sun/star/lang/XMultiComponentFactory.hpp>
 #include <com/sun/star/script/XScriptListener.hpp>
+#include <com/sun/star/awt/XTabListener.hpp>
 #include <cppuhelper/implbase1.hxx>
 #include <cppuhelper/implbase3.hxx>
 #include <comphelper/evtmethodhelper.hxx>
@@ -83,6 +85,11 @@ const static sal_Int32 DELIMLEN = DELIM.getLength();
 #if 0
 void dumpListeners( const Reference< beans::XIntrospection >& xIntrospection, const Reference<XInterface>& xIfc)
 {
+    uno::Reference<lang::XServiceInfo> xInfo( xIfc, uno::UNO_QUERY );
+    if ( xInfo.is() )
+    {
+        OSL_TRACE("** listener Dump for %s", rtl::OUStringToOString( xInfo->getImplementationName(), RTL_TEXTENCODING_UTF8 ).getStr() );
+    }
     Reference< beans::XIntrospectionAccess > xIntrospectionAccess;
     if ( xIntrospection.is() )
     {
@@ -300,6 +307,7 @@ static TranslatePropMap aTranslatePropMap_Impl[] =
     { MAP_CHAR_LEN("itemStateChanged"), { MAP_CHAR_LEN("_Click"), NULL, ApproveType, (void*)(&listBoxList) } },
     // changed ooo event
     { MAP_CHAR_LEN("changed"), { MAP_CHAR_LEN("_Change"), NULL, ApproveAll, NULL } },
+    { MAP_CHAR_LEN("activated"), { MAP_CHAR_LEN("_Change"), NULL, ApproveAll, NULL} },
 
     // focusGained ooo event
     { MAP_CHAR_LEN("focusGained"), { MAP_CHAR_LEN("_GotFocus"), NULL, ApproveAll, NULL } },
@@ -445,6 +453,11 @@ ScriptEventHelper::getEventListeners()
         Reference< beans::XIntrospection > xIntrospection(
             xMFac->createInstanceWithContext( rtl::OUString(
                 RTL_CONSTASCII_USTRINGPARAM( "com.sun.star.beans.Introspection"  ) ), m_xCtx ), UNO_QUERY );
+        rtl::OUString implName;
+        uno::Reference<lang::XServiceInfo> xInfo( m_xControl, uno::UNO_QUERY );
+        if ( xInfo.is() )
+            implName = xInfo->getImplementationName();
+
 #if 0
         dumpListeners( xIntrospection, m_xControl );
         dumpListeners( xIntrospection, m_xControl->getModel() );
@@ -946,8 +959,11 @@ EventListener::firing_Impl(const ScriptEvent& evt, Any* pRet ) throw(RuntimeExce
                 // Userform control ( fired from the api or from event manager )
         uno::Reference< beans::XPropertySet > xProps;
         OSL_TRACE("Getting properties");
+                if ( !xControl.is() )
+                    evt.Helper >>= xControl;
             xProps.set( xControl->getModel(), uno::UNO_QUERY_THROW );
-            xProps->getPropertyValue( rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("Name") ) ) >>= sName;
+                if ( xProps.is() )
+                    xProps->getPropertyValue( rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("Name") ) ) >>= sName;
     }
 
     }
diff --git a/svx/inc/svx/msocximex.hxx b/svx/inc/svx/msocximex.hxx
index 34e67f0..8efd6f6 100644
--- a/svx/inc/svx/msocximex.hxx
+++ b/svx/inc/svx/msocximex.hxx
@@ -293,6 +293,8 @@ public:
     rtl::OUString msCtrlSource;
     rtl::OUString msRowSource;
         SfxObjectShell *pDocSh;
+        ::rtl::OUString sImageUrl;
+    com::sun::star::uno::Reference< com::sun::star::graphic::XGraphicObject> mxGrfObj;
 protected:
 
     sal_uInt32 ImportColor(sal_uInt32 nColorCode) const;
@@ -415,22 +417,21 @@ public:
 
     sal_uInt8 pPictureHeader[20];
     sal_uInt32 nPictureLen;
-    ::rtl::OUString sImageUrl;
-    com::sun::star::uno::Reference< com::sun::star::graphic::XGraphicObject> mxGrfObj;
-
 };
 
 class OCX_TabStrip : public OCX_Control
 {
 public:
-    OCX_TabStrip() : OCX_Control( rtl::OUString::createFromAscii("TabStrip")) {}
+    OCX_TabStrip() : OCX_Control( rtl::OUString::createFromAscii("TabStrip")), nIdentifier(0), nFixedAreaLen(0), nNumTabs(0), bHasTabs(true) {}
         virtual sal_Bool ReadFontData(SotStorageStream *pS);
         virtual sal_Bool Read(SotStorageStream *pS);
 
+        std::vector< rtl::OUString > msItems;
     sal_uInt16	nIdentifier;
     sal_uInt16	nFixedAreaLen;
     sal_uInt8	pBlockFlags[4];
-    sal_uInt16	nNumTabs;
+    sal_Int32	nNumTabs;
+    bool	        bHasTabs;
 };
 
 class OCX_Image : public OCX_Control
@@ -464,8 +465,6 @@ public:
     sal_uInt8	nSpecialEffect;
 
         bool bAutoSize;
-        ::rtl::OUString sImageUrl;
-        com::sun::star::uno::Reference< com::sun::star::graphic::XGraphicObject> mxGrfObj;
         sal_Bool Read(SotStorageStream *pS);
 
     using OCX_Control::Import; // to not hide the other two import methods
@@ -486,7 +485,7 @@ public:
 };
 struct ContainerRecord
 {
-    ContainerRecord():nTop(0), nLeft(0), nSubStorageId(0), nSubStreamLen(0), nTabPos(0), nTypeIdent(0), bVisible( true ) {}
+   ContainerRecord():nTop(0), nLeft(0), nSubStorageId(0), nSubStreamLen(0), nTabPos(0), nTypeIdent(0), bVisible( true ), bTabStop( true ) {}
 
     ::rtl::OUString cName;
     ::rtl::OUString controlTip;
@@ -500,6 +499,7 @@ struct ContainerRecord
     sal_uInt16  nTabPos;
     sal_uInt16 nTypeIdent;
     bool bVisible;
+    bool bTabStop;
 };
 
 typedef std::vector<OCX_Control*>::iterator CtrlIterator;
@@ -508,130 +508,85 @@ typedef std::vector<OCX_Control*>  CtrlList;
 
 class OCX_OptionButton;
 
-class OCX_ContainerControl : public OCX_Control
+class OCX_ParentControl : public OCX_Control
 {
 public:
-    virtual ~OCX_ContainerControl();
-        // sub class will process the control specific information
-        // e.g frame or userform ( maybe tab, mulipage in the future )
-        // Base (this) class will process the container specific information
-        // e.g. the controls contained by this container
-        // will
-        // a) create the controls
-        // b) read the controls
-        // c) store these controls in a list for post processing
-        //     e.g. import
-        //
     virtual sal_Bool Read(SvStorageStream *pS);
-        // No Font record
     virtual sal_Bool ReadFontData(SvStorageStream* /*pS*/) { return sal_True; }
 
     using OCX_Control::Import; // to not hide the other two import methods
+
     virtual sal_Bool Import(com::sun::star::uno::Reference<
         com::sun::star::beans::XPropertySet> &rPropSet);
-
         SotStorageStreamRef getContainerStream() { return mContainerStream; }
-
+        SotStorageStreamRef getOStream() { return mContainedControlsStream; }
         virtual void ProcessControl( OCX_Control* pControl, SvStorageStream* pS, ContainerRecord& rec );
-        bool createFromContainerRecord( ContainerRecord& record,
+        bool createFromContainerRecord( const ContainerRecord& record,
             OCX_Control*& );
-        SotStorageStreamRef getContainedControlsStream(){ return mContainedControlsStream; }
 protected:
-        // This class not meant to be instantiated
-        // needs to be subclassed
-    OCX_ContainerControl( SotStorageRef& parent,
+    OCX_ParentControl( SotStorageRef& parent,
             const ::rtl::OUString& storageName,
             const ::rtl::OUString& sN,
             const com::sun::star::uno::Reference<
-                com::sun::star::container::XNameContainer >  &rParent,
+                com::sun::star::container::XNameContainer >  &rDialog,
             OCX_Control* pParent = NULL );
-        rtl::OUString createSubStreamName( const sal_uInt32& subStorageID );
+    ~OCX_ParentControl();
 
-        com::sun::star::uno::Reference<
-                com::sun::star::container::XNameContainer > mxParent;
+        com::sun::star::uno::Reference< com::sun::star::container::XNameContainer > mxParent;
     std::vector<OCX_Control*> mpControls;
-        std::hash_map<sal_uInt16, sal_uInt16> mActiveXIDMap;
         SotStorageRef mContainerStorage;
         SotStorageStreamRef mContainerStream;
         SotStorageStreamRef mContainedControlsStream;
-    sal_uInt32 nNoRecords;
-    sal_uInt32 nTotalLen;
-        sal_uInt32 containerType;
-
-private:
-        OCX_ContainerControl(); // not implemented
-        OCX_ContainerControl(const OCX_ContainerControl&); // not implemented
-};
-
-
-class OCX_MultiPage : public OCX_ContainerControl
-{
-public:
-    OCX_MultiPage( SotStorageRef& parent,
-            const ::rtl::OUString& storageName,
-            const ::rtl::OUString& sN,
-            const com::sun::star::uno::Reference<
-                com::sun::star::container::XNameContainer >  &rDialog, OCX_Control* pParent = NULL);
-    virtual ~OCX_MultiPage()
-    {
-        delete[] pCaption;
-        delete[] pIcon;
-        delete[] pPicture;
-    }
-    virtual sal_Bool Read(SvStorageStream *pS);
-
-    using OCX_ContainerControl::Import; // to not hide the other two import methods
-    virtual sal_Bool Import(com::sun::star::uno::Reference<
-        com::sun::star::beans::XPropertySet> &rPropSet);
-    virtual sal_Bool Import(com::sun::star::uno::Reference<
-        com::sun::star::container::XNameContainer>
-        &rDialog);
-        virtual void ProcessControl( OCX_Control* pControl, SvStorageStream* pS, ContainerRecord& rec );
-    /*sal_uInt8 for sal_uInt8 Word Struct*/
-    sal_uInt16 nIdentifier;
-    sal_uInt16 nFixedAreaLen;
-    sal_uInt8	pBlockFlags[4];
+	sal_uInt16 nIdentifier;
+	sal_uInt16 nFixedAreaLen;
+	sal_uInt8	pBlockFlags[4];
 
-    sal_uInt32  fUnknown1;
+    sal_uInt32  nNextAvailableID;
+    sal_uInt32  nBooleanProperties;
+    sal_uInt32  nGroupCnt;
+    sal_uInt32  nZoom;
 
-    sal_uInt8	fUnknown2:1;
+    sal_uInt8	fUnknown1:1;
     sal_uInt8	fEnabled:1;
     sal_uInt8	fLocked:1;
     sal_uInt8	fBackStyle:1;
-    sal_uInt8	fUnknown3:4;
+    sal_uInt8	fUnknown2:4;
 
-    sal_uInt8	fUnknown4:8;
+    sal_uInt8	fUnknown3:8;
 
-    sal_uInt8	fUnknown5:7;
+    sal_uInt8	fUnknown4:7;
     sal_uInt8	fWordWrap:1;
 
-    sal_uInt8	fUnknown6:4;
+    sal_uInt8	fUnknown5:4;
     sal_uInt8	fAutoSize:1;
-    sal_uInt8	fUnknown7:3;
+    sal_uInt8	fUnknown6:3;
 
     sal_uInt32	nCaptionLen;
     sal_uInt16  nVertPos;
     sal_uInt16  nHorzPos;
-    sal_uInt8 	nMousePointer;
     sal_uInt32	nBorderColor;
-    sal_uInt32  fUnknown8;
-    sal_uInt32  fUnknown9;
+    sal_uInt32  nDrawBuffer;
+    sal_uInt32  nShapeCookie;
     sal_uInt8   nKeepScrollBarsVisible;
     sal_uInt8   nCycle;
-    sal_uInt16	nBorderStyle;
-    sal_uInt16	nSpecialEffect;
+    sal_uInt8	nBorderStyle;
+    sal_uInt8 	nMousePointer;
+
+    sal_uInt8	nSpecialEffect;
     sal_uInt16	nPicture;
     sal_uInt8   nPictureAlignment;
     sal_uInt8   nPictureSizeMode;
     bool        bPictureTiling;
     sal_uInt16	nAccelerator;
     sal_uInt16	nIcon;
+    sal_uInt16	fUnknown7;
 
     char *pCaption;
 
     sal_uInt32 	nScrollWidth;
     sal_uInt32 	nScrollHeight;
-
+    sal_uInt32 	nScrollLeft;
+    sal_uInt32 	nScrollTop;
 
     sal_uInt8 pIconHeader[20];
     sal_uInt32  nIconLen;
@@ -639,94 +594,59 @@ public:
 
     sal_uInt8 pPictureHeader[20];
     sal_uInt32  nPictureLen;
-    sal_uInt8 *pPicture;
 private:
-        sal_Int32 mnCurrentPageStep;
-};
-
+        OCX_ParentControl(); // not implemented
+        OCX_ParentControl(const OCX_ParentControl&); // not implemented
 
+};
 
-class OCX_Page : public OCX_ContainerControl
+class OCX_Page;
+class OCX_MultiPage : public OCX_ParentControl
 {
 public:
-    OCX_Page( SotStorageRef& parentStorage,
+    OCX_MultiPage( SotStorageRef& parent,
             const ::rtl::OUString& storageName,
             const ::rtl::OUString& sN,
             const com::sun::star::uno::Reference<
-                com::sun::star::container::XNameContainer >  &rDialog, OCX_Control* parent = NULL);
-    virtual ~OCX_Page()
-    {
-        delete[] pCaption;
-        delete[] pIcon;
-        delete[] pPicture;
-    }
+                com::sun::star::container::XNameContainer >  &rDialog, OCX_Control* pParent = NULL);
+
     virtual sal_Bool Read(SvStorageStream *pS);
 
-    using OCX_ContainerControl::Import; // to not hide the other two import methods
+    using OCX_ParentControl::Import; // to not hide the other two import methods
     virtual sal_Bool Import(com::sun::star::uno::Reference<
-        com::sun::star::container::XNameContainer>
-        &rDialog);
-/*	virtual sal_Bool Import(com::sun::star::uno::Reference<
         com::sun::star::beans::XPropertySet> &rPropSet);
-*/
-    /*sal_uInt8 for sal_uInt8 Word Struct*/
-    sal_uInt16 nIdentifier;
-    sal_uInt16 nFixedAreaLen;
-    sal_uInt8	pBlockFlags[4];
-
-    sal_uInt32  fUnknown1;
-
-    sal_uInt8	fUnknown2:1;
-    sal_uInt8	fEnabled:1;
-    sal_uInt8	fLocked:1;
-    sal_uInt8	fBackStyle:1;
-    sal_uInt8	fUnknown3:4;
-
-    sal_uInt8	fUnknown4:8;
-
-    sal_uInt8	fUnknown5:7;
-    sal_uInt8	fWordWrap:1;
-
-    sal_uInt8	fUnknown6:4;
-    sal_uInt8	fAutoSize:1;
-    sal_uInt8	fUnknown7:3;
-
-    sal_uInt32	nCaptionLen;
-    sal_uInt16  nVertPos;
-    sal_uInt16  nHorzPos;
-    sal_uInt8 	nMousePointer;
-    sal_uInt32	nBorderColor;
-    sal_uInt32  fUnknown8;
-    sal_uInt32  fUnknown9;
-    sal_uInt8   nKeepScrollBarsVisible;
-    sal_uInt8   nCycle;
-    sal_uInt16	nBorderStyle;
-    sal_uInt16	nSpecialEffect;
-    sal_uInt16	nPicture;
-    sal_uInt8   nPictureAlignment;
-    sal_uInt8   nPictureSizeMode;
-    bool        bPictureTiling;
-    sal_uInt16	nAccelerator;
-    sal_uInt16	nIcon;
-
-    char *pCaption;
-
-    sal_uInt32 	nScrollWidth;
-    sal_uInt32 	nScrollHeight;
+        virtual void ProcessControl( OCX_Control* pControl, SvStorageStream* pS, ContainerRecord& rec );
+private:
+        sal_Int32 nActiveTab;
+        SotStorageStreamRef mXStream;
+        bool bHasTabs;
+        std::vector< rtl::OUString > sCaptions;
+        // order of Ids corrosponds to the order of captions above
+        std::vector< sal_Int32 > mPageIds;
+        std::hash_map< sal_Int32, OCX_Page* > idToPage;
+};
 
 
-    sal_uInt8 pIconHeader[20];
-    sal_uInt32  nIconLen;
-    sal_uInt8 *pIcon;
+class OCX_Page : public OCX_ParentControl
+{
+public:
+    OCX_Page( SotStorageRef& parentStorage,
+            sal_Int32 nID,
+            const ::rtl::OUString& sN,
+            const com::sun::star::uno::Reference<
+                com::sun::star::container::XNameContainer >  &rDialog, OCX_Control* parent = NULL);
+    virtual sal_Bool Read(SvStorageStream *pS);
 
-    sal_uInt8 pPictureHeader[20];
-    sal_uInt32  nPictureLen;
-    sal_uInt8 *pPicture;
+    using OCX_ParentControl::Import; // to not hide the other two import methods
+    virtual sal_Bool Import(com::sun::star::uno::Reference<
+        com::sun::star::beans::XPropertySet> &rPropSet);
+        rtl::OUString msTitle; // #FIXME we should use the existing caption
+        sal_Int32 mnID;
 private:
 };
 
 
-class OCX_Frame : public OCX_ContainerControl
+class OCX_Frame : public OCX_ParentControl
 {
 public:
     OCX_Frame( SotStorageRef& parent,
@@ -734,162 +654,32 @@ public:
             const ::rtl::OUString& sN,
             const com::sun::star::uno::Reference<
                 com::sun::star::container::XNameContainer >  &rDialog, OCX_Control* pParent = NULL);
-    virtual ~OCX_Frame()
-    {
-        delete[] pCaption;
-        delete[] pIcon;
-        delete[] pPicture;
-    }
     virtual sal_Bool Read(SvStorageStream *pS);
 
-    using OCX_ContainerControl::Import; // to not hide the other two import methods
+    using OCX_ParentControl::Import; // to not hide the other two import methods
     virtual sal_Bool Import(com::sun::star::uno::Reference<
         com::sun::star::beans::XPropertySet> &rPropSet);
-
-    /*sal_uInt8 for sal_uInt8 Word Struct*/
-    sal_uInt16 nIdentifier;
-    sal_uInt16 nFixedAreaLen;
-    sal_uInt8	pBlockFlags[4];
-
-    sal_uInt32  fUnknown1;
-
-    sal_uInt8	fUnknown2:1;
-    sal_uInt8	fEnabled:1;
-    sal_uInt8	fLocked:1;
-    sal_uInt8	fBackStyle:1;
-    sal_uInt8	fUnknown3:4;
-
-    sal_uInt8	fUnknown4:8;
-
-    sal_uInt8	fUnknown5:7;
-    sal_uInt8	fWordWrap:1;
-
-    sal_uInt8	fUnknown6:4;
-    sal_uInt8	fAutoSize:1;
-    sal_uInt8	fUnknown7:3;
-
-    sal_uInt32	nCaptionLen;
-    sal_uInt16  nVertPos;
-    sal_uInt16  nHorzPos;
-    sal_uInt8 	nMousePointer;
-    sal_uInt32	nBorderColor;
-    sal_uInt32  fUnknown8;
-    sal_uInt32  fUnknown9;
-    sal_uInt8   nKeepScrollBarsVisible;
-    sal_uInt8   nCycle;
-    sal_uInt16	nBorderStyle;
-    sal_uInt16	nSpecialEffect;
-    sal_uInt16	nPicture;
-    sal_uInt8   nPictureAlignment;
-    sal_uInt8   nPictureSizeMode;
-    bool        bPictureTiling;
-    sal_uInt16	nAccelerator;
-    sal_uInt16	nIcon;
-
-    char *pCaption;
-
-    sal_uInt32 	nScrollWidth;
-    sal_uInt32 	nScrollHeight;
-    sal_uInt32 	nScrollLeft;
-    sal_uInt32 	nScrollTop;
-
-
-    sal_uInt8 pIconHeader[20];
-    sal_uInt32  nIconLen;
-    sal_uInt8 *pIcon;
-
-    sal_uInt8 pPictureHeader[20];
-    sal_uInt32  nPictureLen;
-    sal_uInt8 *pPicture;
-private:
 };
 
-class OCX_UserForm : public OCX_ContainerControl
+
+class OCX_UserForm : public OCX_ParentControl
 {
 public:
-    OCX_UserForm( SotStorageRef& parent,
+        OCX_UserForm( SotStorageRef& parent,
             const ::rtl::OUString& storageName,
             const ::rtl::OUString& sN,
             const com::sun::star::uno::Reference<
                 com::sun::star::container::XNameContainer >  &rDialog,
             const com::sun::star::uno::Reference<
                 com::sun::star::lang::XMultiServiceFactory >& rMsf);
-    ~OCX_UserForm()
-    {
-        delete[] pCaption;
-        delete[] pIcon;
-    }
-
-    virtual sal_Bool Read(SvStorageStream *pS);
-
-    using OCX_ContainerControl::Import; // to not hide the other two import methods
     virtual sal_Bool Import( com::sun::star::uno::Reference<
         com::sun::star::container::XNameContainer>
         &rDialog);
-
-    /*sal_uInt8 for sal_uInt8 Word Struct*/
-    sal_uInt16 nIdentifier;
-    sal_uInt16 nFixedAreaLen;
-    sal_uInt8	pBlockFlags[4];
-
-    sal_uInt32  nChildrenA;
-
-    sal_uInt8	fUnknown1:1;
-    sal_uInt8	fEnabled:1;
-    sal_uInt8	fLocked:1;
-    sal_uInt8	fBackStyle:1;
-    sal_uInt8	fUnknown2:4;
-
-    sal_uInt8	fUnknown3:8;
-
-    sal_uInt8	fUnknown4:7;
-    sal_uInt8	fWordWrap:1;
-
-    sal_uInt8	fUnknown5:4;
-    sal_uInt8	fAutoSize:1;
-    sal_uInt8	fUnknown6:3;
-
-    sal_uInt32	nCaptionLen;
-    sal_uInt16  nVertPos;
-    sal_uInt16  nHorzPos;
-    sal_uInt8 	nMousePointer;
-    sal_uInt32	nBorderColor;
-    sal_uInt32  nDrawBuffer;
-    sal_uInt32  nChildrenB;
-    sal_uInt8   nKeepScrollBarsVisible;
-    sal_uInt8   nCycle;
-    sal_uInt16	nBorderStyle;
-    sal_uInt8	nSpecialEffect;
-    sal_uInt16	nPicture;
-    sal_uInt8   nPictureAlignment;
-    sal_uInt8   nPictureSizeMode;
-    bool        bPictureTiling;
-    sal_uInt16	nAccelerator;
-    sal_uInt16	nIcon;
-    sal_uInt16	fUnknown7;
-
-    char *pCaption;
-
-    sal_uInt32 	nScrollWidth;
-    sal_uInt32 	nScrollHeight;
-    sal_uInt32 	nScrollLeft;
-    sal_uInt32 	nScrollTop;
-
-    sal_uInt8 pIconHeader[20];
-    sal_uInt32  nIconLen;
-    sal_uInt8 *pIcon;
-
-    sal_uInt8 pPictureHeader[20];
-    sal_uInt32  nPictureLen;
-    ::rtl::OUString sImageUrl;
-    com::sun::star::uno::Reference< com::sun::star::graphic::XGraphicObject> mxGrfObj;
 private:
         com::sun::star::uno::Reference<
                 com::sun::star::uno::XComponentContext> mxCtx;
 };
 
-
-
 class OCX_CheckBox : public OCX_ModernControl
 {
 public:
@@ -1130,8 +920,6 @@ public:
 
     sal_uInt8 pPictureHeader[20];
     sal_uInt32  nPictureLen;
-    ::rtl::OUString sImageUrl;
-    com::sun::star::uno::Reference< com::sun::star::graphic::XGraphicObject> mxGrfObj;
 
     bool        mbTakeFocus;
 
@@ -1193,7 +981,7 @@ public:
     fAutoSize(0),nCaptionLen(0),nVertPos(1),nHorzPos(7),nMousePointer(0),
     nBorderColor(0x80000006),nBorderStyle(0),nSpecialEffect(0),
     nPicture(0),nAccelerator(0),nIcon(0),pCaption(0),nIconLen(0),pIcon(0),
-    nPictureLen(0),pPicture(0)
+    nPictureLen(0)
     {
         msFormType = rtl::OUString::createFromAscii("com.sun.star.form.component.FixedText");
         msDialogType = rtl::OUString::createFromAscii("com.sun.star.awt.UnoControlFixedTextModel");
@@ -1205,7 +993,6 @@ public:
     ~OCX_Label() {
         if (pCaption) delete[] pCaption;
         if (pIcon) delete[] pIcon;
-        if (pPicture) delete[] pPicture;
     }
     sal_Bool Read(SotStorageStream *pS);
 
@@ -1249,7 +1036,6 @@ public:
 
     sal_uInt8 pPictureHeader[20];
     sal_uInt32  nPictureLen;
-	sal_uInt8 *pPicture;
 
     static OCX_Control *Create() { return new OCX_Label;}
 
diff --git a/svx/source/msfilter/msocximex.cxx b/svx/source/msfilter/msocximex.cxx
index fa0b3f1..d132dc0 100644
--- a/svx/source/msfilter/msocximex.cxx
+++ b/svx/source/msfilter/msocximex.cxx
@@ -359,6 +359,39 @@ OUString lclCreateOUString( const char* pcCharArr, sal_uInt32 nLenFld )
     return svt::BinFilterUtils::CreateOUStringFromUniStringArray( pcCharArr, nBufSize );
 }
 
+void readArrayString( SotStorageStream *pS, std::vector< rtl::OUString >& sStringsOut, sal_Int32 nSize, long nStart )
+{
+    unsigned long nFinish = pS->Tell() + nSize;
+    while ( pS->Tell() < nFinish )
+    {
+        sal_Int32 nStringLen = 0;
+        *pS >> nStringLen;
+        sal_uInt32 nStringSize = lclGetBufferSize( nStringLen );
+        sal_Char* pString = new sal_Char[ nStringSize ];
+        pS->Read( pString, nStringSize );
+        rtl::OUString sString = lclCreateOUString( pString, nStringLen );
+        delete[] pString;
+        sStringsOut.push_back( sString );
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+    }
+}
+
+OUString createSubStreamName( const sal_uInt32& subStorageId )
+{
+    static OUString sI = OUString::createFromAscii("i");
+    static OUString sZero = OUString::createFromAscii( "0" );
+    OUStringBuffer buf( 6 );
+    buf.append( sI );
+    // for subStorage id < 10 stream name has leading '0'
+    // eg "i07"
+    if ( subStorageId < 10 )
+    {
+        buf.append( sZero );
+    }
+    buf.append( OUString::valueOf( (sal_Int32)subStorageId ) );
+    return buf.makeStringAndClear();
+}
+
 // export ---------------------------------------------------------------------
 
 /** This class implements writing a character array from a Unicode string.
@@ -451,6 +484,44 @@ void SvxOcxString::WriteCharArray( SvStorageStream& rStrm ) const
     }
 }
 
+class MultiPageProps
+{
+public:
+    sal_uInt16	nIdentifier; // major & minor version
+    sal_uInt16	nFixedAreaLen; // size of record
+    sal_uInt8	pBlockFlags[4]; // size of record
+    sal_Int32   mnPageCount;
+    sal_Int32   mnID;
+    bool        mbEnabled;
+    std::vector< sal_Int32 > mnIDs;
+
+    MultiPageProps();
+    bool Read(SotStorageStream *pS);
+};
+
+MultiPageProps::MultiPageProps() : nIdentifier(0), nFixedAreaLen(0), mnPageCount(0), mnID(0), mbEnabled( true )
+{
+}
+
+bool MultiPageProps::Read(SotStorageStream *pS)
+{
+    *pS >> nIdentifier >> nFixedAreaLen;
+    pS->Read( pBlockFlags, sizeof( pBlockFlags ) );
+    if ( pBlockFlags[ 0 ] & 0x02 )
+        *pS >> mnPageCount;
+    if ( pBlockFlags[ 0 ] & 0x04 )
+        *pS >> mnID;
+    if ( pBlockFlags[ 0 ] & 0x08 )
+        mbEnabled = false;
+    for ( sal_Int32 i=0; i<mnPageCount; ++i )
+    {
+        sal_Int32 nID(0);
+        *pS >> nID;
+        mnIDs.push_back( nID );
+    }
+    return true;
+}
+
 const sal_uInt16 USERFORM = (sal_uInt16)0xFF;
 const sal_uInt16 STDCONTAINER = (sal_uInt16)0xFE;
 
@@ -476,48 +547,42 @@ const sal_uInt16 TOGGLEBUTTON = (sal_uInt16)0x1C;
 const sal_uInt16 SCROLLBAR = (sal_uInt16)0x2F;
 
 const sal_uInt16 MULTIPAGE = (sal_uInt16)0x39;
-// The IDs with bit 0x8000 set appear to be generated.
-// It looks like these ID's are used with the non-toolbox [1]
-// ActiveX controls that can be present in a Userform
-// ( note: RefEdit seems to be an exception )
-// In UserForm::Read just before the Container record starts
-// you will notice there can be sometimes trailing records,
-// it seems that these records have a 1:1 relationship with the non-toolbox
-// controls present in the Userform. An id in the trailing record
-// seems to identify the specific ActiveX control and an artificial nTypeIdent
-// e.g. 0x8000, 0x8001 etc. is created so as to be able to associate
-// the ActiveX control when referenced later
-// [1] Such ActiveX controls are added via Tools/AddionalControls
-// menu
-
-// create a fixed set of those special id(s)
-// ahem, we can only read one Progress bars at the moment so....
+
+const sal_uInt16 UNKNOWNCTRL = (sal_uInt16)0x7FFF;
 const sal_uInt16 PROGRESSBAR = (sal_uInt16)0x8000;
 
-// A set of IDs from the trailing records mentioned above that seem to
-// identify the following ActiveX controls
+// following ActiveX controls are just for reference ( are NOT supported )
+const sal_uInt16 REFEDIT = (sal_uInt16)0x8001;
+const sal_uInt16 CALENDAR = (sal_uInt16)0x8002;
+const sal_uInt16 IMAGECOMBO = (sal_uInt16)0x8003;
+const sal_uInt16 IMAGELIST = (sal_uInt16)0x8004;
+const sal_uInt16 SLIDER = (sal_uInt16)0x8005;
+const sal_uInt16 STATUSBAR = (sal_uInt16)0x8006;
+const sal_uInt16 CHARTSPACE = (sal_uInt16)0x8007;
+
+// A set of common CLSIDs
+// there are to identify the following ActiveX controls ( that appear in the ClassTable records )
 // Currently we only can process ( in a limited way ) the ProgressBar
 // the other ID's are for reference ( & future )
 
-// RefEdit control {00024512-0000-0000-c000-000000000046}
-const sal_uInt8 aRefEditID[] =
-{
-0x12, 0x45, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x46,
-};
-
 // Microsoft ProgressBar Control, version 6.0 {35053A22-8589-11D1-B16A-00C0F0283628}
 const sal_uInt8 aProgressID[] =
 {
 0x22, 0x3a, 0x05, 0x35, 0x89, 0x85, 0xd1, 0x11,  0xb1, 0x6a, 0x00, 0xc0, 0xf0, 0x28, 0x36, 0x28,
 };
 
+// RefEdit control {00024512-0000-0000-c000-000000000046}
+const sal_uInt8 aRefEditID[] =
+{
+0x12, 0x45, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x46,
+};
+
 // Calendar Control 10.0
 const sal_uInt8 aCalendarID[] =
 {
 0x2b, 0xc9, 0x27, 0x8e, 0x64, 0x12, 0x1c, 0x10, 0x8a, 0x2f, 0x04, 0x02, 0x24, 0x00, 0x9c, 0x02,
 };
 
-
 // Microsoft ImageComboxBox Control, version 6.0 {DD9DA666-8594-11D1-B16A-00C0F0283628}
 const sal_uInt8 aImageComboID[] =
 {
@@ -548,243 +613,368 @@ const sal_uInt8 aChartSpaceID[] =
 0x46, 0xe5, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x46,
 };
 
-const sal_Int16 ActiveXIDLen = 0x10; // CLSID len
-const sal_Int16 ActiveXIDBlockLen = 0x30; // the block len that contains the CLSID
+const sal_uInt8 nSizeOfClsid = sizeof( aProgressID );
 
-bool lcl_handleActiveXControl(  SvStorageStream *pS, sal_uInt16& nTypeID )
+struct ClsIdTypeIDPair
 {
-    nTypeID = 0; // Illegal ActiveX ID
-    bool bRes = false;
-    sal_uInt16 nIdentifier, nFixedAreaLen;
-    *pS >> nIdentifier;
-    *pS >> nFixedAreaLen;
-    pS->SeekRel( ( nFixedAreaLen - ActiveXIDBlockLen ) );
-    sal_uInt8 aID[ ActiveXIDLen ];
-    if ( !pS->IsEof() )
-    {
-        pS->Read( aID, ActiveXIDLen );
-        pS->SeekRel( ActiveXIDBlockLen - ActiveXIDLen ); // read remainer of record
-        if ( memcmp( aID, aProgressID, ActiveXIDLen ) == 0 )
+//    ClsIdTypeIDPair() : pClsID( NULL ), nTypeID( UNKNOWNCTRL ) {}
+    const sal_uInt8* pClsID;
+    const sal_uInt16 nTypeID;
+};
+
+ClsIdTypeIDPair ClsidList[] = { { aProgressID, PROGRESSBAR },
+// unsupported common activex controls
+#ifdef DEBUG
+                                 { aRefEditID, REFEDIT },
+                                 { aCalendarID, CALENDAR },
+                                 { aImageComboID, IMAGECOMBO },
+                                 { aImageListID, IMAGELIST },
+                                 { aSliderID, SLIDER },
+                                 { aStatusBarID, STATUSBAR },
+                                 { aChartSpaceID, CHARTSPACE },
+#endif
+};
+
+
+typedef std::vector< ContainerRecord > ContainerRecordList;
+
+class FormObjectDepthTypeCount
+{
+    public:
+    sal_uInt8 depth;
+    sal_uInt8 TypeOrCount;
+    std::auto_ptr< sal_uInt8 > OptionalType;
+    FormObjectDepthTypeCount() : depth(0), TypeOrCount(0) {}
+    bool Read( SvStorageStream* pS )
+    {
+        *pS >> depth >> TypeOrCount;
+        if ( TypeOrCount &  0x80 )
         {
-            nTypeID = PROGRESSBAR;
-            OSL_TRACE("Found supported ***PROGRESSBAR*** ActiveX control");
-            bRes = true;
+            OptionalType.reset( new sal_uInt8 );
+            *pS >> *OptionalType;
         }
-#if (OSL_DEBUG_LEVEL > 0)
-        // If we really want to process these more controls we should put them in
-        // a list or array and have a single loop testing each id. For the moment
-        // as we only can process PROGRESSBAR, not much point doing that until
-        // we add support for at least another activex control
-
-        else if ( memcmp( aID, aCalendarID, ActiveXIDLen ) == 0 )
-            OSL_TRACE("Found unsupported ***CALENDAR*** ActiveX control");
-        else if ( memcmp( aID, aRefEditID, ActiveXIDLen ) == 0 )
-            OSL_TRACE("Found unsupported ***REFEDIT*** ActiveX control");
-        else if ( memcmp( aID, aImageComboID, ActiveXIDLen ) == 0 )
-            OSL_TRACE("Found unsupported ***IMAGECOMBO*** ActiveX control");
-        else if ( memcmp( aID, aImageListID, ActiveXIDLen ) == 0 )
-            OSL_TRACE("Found unsupported ***IMAGELIST*** ActiveX control");
-        else if ( memcmp( aID, aChartSpaceID, ActiveXIDLen ) == 0 )
-            OSL_TRACE("Found unsupported ***CHARTSPACE*** ActiveX control");
-        else if ( memcmp( aID, aSliderID, ActiveXIDLen ) == 0 )
-            OSL_TRACE("Found unsupported ***SLIDER*** ActiveX control");
-        else if ( memcmp( aID, aStatusBarID, ActiveXIDLen ) == 0 )
-            OSL_TRACE("Found unsupported ***STATUSBAR*** ActiveX control");
-#endif
-        else
+        TypeOrCount = ( TypeOrCount >> 1 );
+        return true;
+    }
+};
+
+class ClassTable
+{
+    sal_uInt16 nIdentifier;
+    sal_uInt16 nFixedAreaLen;
+    sal_uInt32 nContentFlags;
+    sal_uInt16 nClassTableFlags;
+    sal_uInt16 nVarFlags;
+    sal_Int32 nCountOfMethods;
+    sal_Int32 nDispidBind;
+    sal_uInt16 nGetBindIndex;
+    sal_uInt16 nPutBindIndex;
+    sal_uInt16 nBindType;
+    sal_uInt16 nGetValueIndex;
+    sal_uInt16 nPutValueIndex;
+    sal_uInt16 nValueType;
+    sal_uInt32 nDisidRowset;
+    sal_uInt16 nSetRowset;
+    sal_uInt8 pClsId[16];
+    sal_uInt8 pDispEvent[16];
+    sal_uInt8 pDefaultProg[16];
+    sal_uInt16 nTypeId;
+public:
+    ClassTable() :  nIdentifier( 0 )
+                   ,nFixedAreaLen( 0 )
+                   ,nContentFlags(0)
+                   ,nClassTableFlags(0)
+                   ,nVarFlags(0)
+                   ,nCountOfMethods(0)
+                   ,nDispidBind(0)
+                   ,nGetBindIndex(0)
+                   ,nPutBindIndex(0)
+                   ,nBindType(0)
+                   ,nGetValueIndex(0)
+                   ,nPutValueIndex(0)
+                   ,nValueType(0)
+                   ,nDisidRowset(0)
+                   ,nSetRowset(0)
+                   ,nTypeId(UNKNOWNCTRL)
+
+    {
+        memset( pClsId, 0, sizeof( pClsId ) );
+        memset( pDispEvent, 0, sizeof( pDispEvent ) );
+        memset( pDefaultProg, 0, sizeof( pDefaultProg ) );
+    }
+    bool Read(  SvStorageStream* pS )
+    {
+        long nStartPos = pS->Tell();
+        *pS >> nIdentifier >> nFixedAreaLen >> nContentFlags;
+        bool bClsID( false );
+        bool bDispEvent( false );
+        bool bDefaultProg( false );
+        if (  nContentFlags & 0x00000001 )
+            bClsID = true;
+        if (  nContentFlags & 0x00000002 )
+            bDispEvent = true;
+//        if (  nContentFlags & 0x00000004 ) ' not set should be 0
+        if (  nContentFlags & 0x00000008 )
+            bDefaultProg = true;
+        if (  nContentFlags & 0x00000010 )
+            *pS >> nClassTableFlags >> nVarFlags;
+        if (  nContentFlags & 0x00000020 )
+            *pS >> nCountOfMethods;
+        if (  nContentFlags & 0x00000040 )
+            *pS >> nDispidBind;
+        if (  nContentFlags & 0x00000080 )
+            *pS >> nGetBindIndex;
+        if (  nContentFlags & 0x00000100 )
+            *pS >> nPutBindIndex;
+        if (  nContentFlags & 0x00000200 )
+            *pS >> nBindType;
+        if (  nContentFlags & 0x00000400 )
+            *pS >> nGetValueIndex;
+        if (  nContentFlags & 0x00000800 )
+            *pS >> nPutValueIndex;
+        if (  nContentFlags & 0x00001000 )
+            *pS >> nValueType;
+        if (  nContentFlags & 0x00002000 )
         {
-            OSL_TRACE("Unknown activeX ID !");
+            ReadAlign( pS, pS->Tell() - nStartPos, 4 );
+            *pS >> nDisidRowset;
         }
+        if (  nContentFlags & 0x00004000 )
+            *pS >> nSetRowset;
+        ReadAlign( pS, pS->Tell() - nStartPos, 4 );
+        // Extra Block
+        if ( bClsID )
+            pS->Read( pClsId, sizeof( pClsId ) );
+        if ( bDispEvent )
+            pS->Read( pDispEvent, sizeof( pDispEvent ) );
+        if ( bDefaultProg )
+            pS->Read( pDefaultProg, sizeof( pDefaultProg ) );
+
+        sal_Int32 nNumIds =  sizeof( ClsidList ) / sizeof( ClsidList[0] );
+
+        if ( bClsID )
+        {
+            for ( sal_Int32 index = 0; index < nNumIds; ++index )
+            {
+                if ( memcmp( pClsId, ClsidList[ index ].pClsID, nSizeOfClsid ) == 0 )
+                {
+                    nTypeId = ClsidList[ index ].nTypeID;
+                    OSL_TRACE( "... found activex control ClsidList[ %d ] and have given it TypeIdent 0x%x", index, nTypeId );
+                }
+            }
+        }
+        ReadAlign( pS, pS->Tell() - nStartPos, 4 );
+        return true;
     }
-    return bRes;
-}
 
-typedef std::vector< ContainerRecord > ContainerRecordList;
+    sal_uInt16 getTypeId() { return nTypeId; }
+};
 
-class ContainerRecReader
+class OleSiteConcreteControl
 {
-    public:
+    sal_uInt16 nIdentifier;
+    sal_uInt16 nFixedAreaLen;
+    sal_uInt32 nContentFlags;
+public:
+    OleSiteConcreteControl() :  nIdentifier( 0 ), nFixedAreaLen( 0 ), nContentFlags(0) {}
+    bool Read( ContainerRecord& rec, SvStorageStream* pS )
+    {
+        long nStartPos = pS->Tell();
+        *pS >> nIdentifier >> nFixedAreaLen >> nContentFlags;
+
+        bool bPosition( false );
+
+        sal_uInt32 nNameLen = 0;
+        // length of control name
+        if ( nContentFlags & 0x00000001 )
+            *pS >> nNameLen;
+        // length of control tag
+        sal_uInt32 nTagLen = 0;
+        if( nContentFlags & 0x00000002 )
+            *pS >> nTagLen;
+        // substorage id for frames
+        if( nContentFlags & 0x00000004 )
+            *pS >> rec.nSubStorageId;
+        // help-context id
+        if( nContentFlags & 0x00000008 )
+            pS->SeekRel( 4 );
+        // option flags
+        if( nContentFlags & 0x00000010 )
+        {
+            sal_uInt32 nBitFlags = 0;
+            *pS >> nBitFlags;
+            rec.bVisible = ( nBitFlags & 0x02 );
+            rec.bTabStop = ( nBitFlags & 0x01 );
+        }
+        // substream size
+        if( nContentFlags & 0x00000020 )
+            *pS >> rec.nSubStreamLen;
+        // tabstop position
+        if( nContentFlags & 0x00000040 )
+        {
+            ReadAlign( pS, pS->Tell() - nStartPos, 2 );
+            *pS >> rec.nTabPos;
+        }
+        // control type
+        if( nContentFlags & 0x00000080 )
+        {
+            ReadAlign( pS, pS->Tell() - nStartPos, 2 );
+            *pS >> rec.nTypeIdent;
+        }
+        if( nContentFlags & 0x00000100 )
+            bPosition = true;
+        sal_Int16 nGroupId = 0;
+        if( nContentFlags & 0x00000200 )
+        {
+            ReadAlign( pS, pS->Tell() - nStartPos, 2 );
+            *pS >> nGroupId;
+        }
 
-    virtual ~ContainerRecReader() {}
+        // length of infotip
+        sal_uInt32 nTipLen = 0;
+        if( nContentFlags & 0x00000800 )
+        {
+            ReadAlign( pS, pS->Tell() - nStartPos, 4 );
+            *pS >> nTipLen;
+        }
+        sal_uInt32 nCntrlIdLen = 0;
+        if( nContentFlags & 0x00001000 )
+        {
+            ReadAlign( pS, pS->Tell() - nStartPos, 4 );
+            *pS >> nCntrlIdLen;
+        }
 
-    virtual bool Read( OCX_ContainerControl* pContainerControl, SvStorageStream *pS)
-    {
-        *pS >> nNoRecords;
-        *pS >> nTotalLen;
+        // length of control source name
+        sal_uInt32 nCtrlSrcLen = 0;
+        if( nContentFlags & 0x00002000 )
+        {
+            ReadAlign( pS, pS->Tell() - nStartPos, 4 );
+            *pS >> nCtrlSrcLen;
+        }
 
-        if ( isMultiPage )
+        // length of row source name
+        sal_uInt32 nRowSrcLen = 0;
+        if( nContentFlags & 0x00004000 )
         {
-            if ( !handleMultiPageHdr( pS ) )
-            {
-                return false;
-            }
+            ReadAlign( pS, pS->Tell() - nStartPos, 4 );
+            *pS >> nRowSrcLen;
         }
-        else
+
+        ReadAlign( pS, pS->Tell() - nStartPos, 4 );
+        // control name
+        sal_Char* pName = 0;
+        sal_uInt32 nNameBufSize = lclGetBufferSize( nNameLen );
+        if( nNameBufSize > 0 )
         {
-            if ( !handleStandardHdr( pS ) )
-            {
-                return false;
-            }
+            ReadAlign( pS, pS->Tell() - nStartPos, 4 );
+            pName = new char[ nNameBufSize ];
+            pS->Read( pName, nNameBufSize );
+        }
+        // control tag
+        sal_uInt32 nTagBufSize = lclGetBufferSize( nTagLen );
+        if( nTagBufSize > 0 )
+        {
+            ReadAlign( pS, pS->Tell() - nStartPos, 4 );
+            pS->SeekRel( nTagBufSize );
         }
 
-        records.clear();
-        for (sal_uInt32 nRecord = 0; nRecord < nNoRecords; ++nRecord)
+        // control position
+        if( bPosition )
         {
-            // DR #134146# redo loading of FrameChild data
+            ReadAlign( pS, pS->Tell() - nStartPos, 4 );
+            *pS >> rec.nLeft >> rec.nTop;
+        }
 
-            ContainerRecord rec;
+        // control infotip
+        sal_uInt32 nTipBufSize = lclGetBufferSize( nTipLen );
+        if( nTipBufSize > 0 )
+        {
+            ReadAlign( pS, pS->Tell() - nStartPos, 4 );
+            std::auto_ptr< sal_Char > pTipName;
+            pTipName.reset( new sal_Char[ nTipBufSize ] );
+            pS->Read( pTipName.get(), nTipBufSize );
+            rec.controlTip = lclCreateOUString( pTipName.get(), nTipLen );
+        }
+        // control id
+        sal_uInt32 nCntrlIdSize = lclGetBufferSize( nCntrlIdLen );
+        if( nCntrlIdSize > 0 )
+        {
+            ReadAlign( pS, pS->Tell() - nStartPos, 4 );
+            pS->SeekRel( nCntrlIdSize );
+        }
+        // control source name
+        sal_uInt32 nCtrlSrcBufSize = lclGetBufferSize( nCtrlSrcLen );
+        if( nCtrlSrcBufSize > 0 )
+        {
+            ReadAlign( pS, pS->Tell() - nStartPos, 4 );
+            std::vector< sal_Char > pCtrlSrcName( nCtrlSrcBufSize );
+            pS->Read( &pCtrlSrcName[0], nCtrlSrcBufSize );
+            rec.sCtrlSource = lclCreateOUString( &pCtrlSrcName[0], nCtrlSrcLen );
+            OSL_TRACE("*** *** *** ControlSourceName -> %s ", rtl::OUStringToOString( rec.sCtrlSource, RTL_TEXTENCODING_UTF8 ).getStr() );
+        }
+        // row source name
+        sal_uInt32 nRowSrcBufSize = lclGetBufferSize( nRowSrcLen );
+        if( nRowSrcBufSize > 0 )
+        {
+            ReadAlign( pS, pS->Tell() - nStartPos, 4 );
+            std::vector< sal_Char > pRowSrcName( nRowSrcBufSize );
+            pS->Read( &pRowSrcName[0], nRowSrcBufSize );
+            rec.sRowSource =  lclCreateOUString( &pRowSrcName[0], nRowSrcLen );
+            OSL_TRACE("*** *** *** RowSourceName -> %s ", rtl::OUStringToOString( rec.sRowSource, RTL_TEXTENCODING_UTF8 ).getStr() );
+        }
 
-            // record header
-            sal_uInt16 nId, nSize;
-            *pS >> nId >> nSize;
-            sal_Size nStartPos = pS->Tell();
-
-            // content flags
-            sal_uInt32 nContentFlags;
-            *pS >> nContentFlags;
-
-            // length of control name
-            sal_uInt32 nNameLen = 0;
-            if( nContentFlags & 0x00000001 )
-                *pS >> nNameLen;
-            // length of control tag
-            sal_uInt32 nTagLen = 0;
-            if( nContentFlags & 0x00000002 )
-                *pS >> nTagLen;
-            // substorage id for frames
-            if( nContentFlags & 0x00000004 )
-                *pS >> rec.nSubStorageId;
-            // help-context id
-            if( nContentFlags & 0x00000008 )
-                pS->SeekRel( 4 );
-            // option flags
-            if( nContentFlags & 0x00000010 )
-            {
-                sal_uInt32 nBitFlags = 0;
-                *pS >> nBitFlags;
-                rec.bVisible = ( ( nBitFlags & 0x02 ) == 0x02 );
-            }
-            // substream size
-            if( nContentFlags & 0x00000020 )
-                *pS >> rec.nSubStreamLen;
-            // tabstop position
-            if( nContentFlags & 0x00000040 )
-                *pS >> rec.nTabPos;
-            // control type
-            if( nContentFlags & 0x00000080 )
-                *pS >> rec.nTypeIdent;
-            if( nContentFlags & 0x00000200 )
-                pS->SeekRel( 4 ); // Grouping?
-            // length of infotip
-            sal_uInt32 nTipLen = 0;
-            if( nContentFlags & 0x00000800 )
-            {
-                ReadAlign( pS, pS->Tell() - nStartPos, 4 );
-                *pS >> nTipLen;
-            }
+        ReadAlign( pS, pS->Tell() - nStartPos, 4 );
+        rec.cName = lclCreateOUString(pName, nNameLen);
+        delete[] pName;
+        return true;
+    }
+};
 
-            sal_uInt32 nCntrlIdLen = 0;
-            if( nContentFlags & 0x00001000 )
-                *pS >> nCntrlIdLen;
+class ContainerRecReader
+{
+    public:
 
-            // length of control source name
-            sal_uInt32 nCtrlSrcLen = 0;
-            if( nContentFlags & 0x00002000 )
-            {
-                ReadAlign( pS, pS->Tell() - nStartPos, 4 );
-                *pS >> nCtrlSrcLen;
-            }
+    virtual ~ContainerRecReader() {}
 
-            // length of row source name
-            sal_uInt32 nRowSrcLen = 0;
-            if( nContentFlags & 0x00004000 )
-            {
-                ReadAlign( pS, pS->Tell() - nStartPos, 4 );
-                *pS >> nRowSrcLen;
-            }
+    virtual bool Read( OCX_ParentControl* pContainerControl, SvStorageStream *pS, std::vector< ClassTable >& rSiteClassInfo )
+    {
+        *pS >> nNoRecords;
+        *pS >> nTotalLen;
+        long nStart = pS->Tell();
+        for ( sal_uInt32 nSite = 0; nSite < nNoRecords; )
+        {
+            FormObjectDepthTypeCount siteAndDepth;
+            siteAndDepth.Read( pS );
+            nSite += ( siteAndDepth.OptionalType.get() ? siteAndDepth.TypeOrCount : 1 );
+        }
+        ReadAlign(pS, pS->Tell() - nStart, 4);
 
-            // control name
-            sal_Char* pName = 0;
-            sal_uInt32 nNameBufSize = lclGetBufferSize( nNameLen );
-            if( nNameBufSize > 0 )
-            {
-                pName = new char[ nNameBufSize ];
-                ReadAlign( pS, pS->Tell() - nStartPos, 4 );
-                pS->Read( pName, nNameBufSize );
-            }
-            // control tag
-            sal_uInt32 nTagBufSize = lclGetBufferSize( nTagLen );
-            if( nTagBufSize > 0 )
-            {
-                ReadAlign( pS, pS->Tell() - nStartPos, 4 );
-                pS->SeekRel( nTagBufSize );
-            }
+        for (sal_uInt32 nRecord = 0; nRecord < nNoRecords; ++nRecord)
+        {
 
-            // control position
-            if( nContentFlags & 0x00000100 )
-            {
-                ReadAlign( pS, pS->Tell() - nStartPos, 4 );
-                *pS >> rec.nLeft >> rec.nTop;
-            }
-   
-            // control infotip
-            sal_uInt32 nTipBufSize = lclGetBufferSize( nTipLen );
-            if( nTipBufSize > 0 )
-            {
-                std::auto_ptr< sal_Char > pTipName;
-                pTipName.reset( new sal_Char[ nTipBufSize ] );
-                ReadAlign( pS, pS->Tell() - nStartPos, 4 );
-                pS->Read( pTipName.get(), nTipBufSize );
-                rec.controlTip = lclCreateOUString( pTipName.get(), nTipLen );
-            }
-            // control id
-            sal_uInt32 nCntrlIdSize = lclGetBufferSize( nCntrlIdLen );
-            if( nCntrlIdSize > 0 )
-            {
-                ReadAlign( pS, pS->Tell() - nStartPos, 4 );
-                pS->SeekRel( nCntrlIdSize );
-            }
-            // control source name
-            sal_uInt32 nCtrlSrcBufSize = lclGetBufferSize( nCtrlSrcLen );
-            if( nCtrlSrcBufSize > 0 )
-            {
-                ReadAlign( pS, pS->Tell() - nStartPos, 4 );
-                std::auto_ptr< sal_Char > pCtrlSrcName;
-                pCtrlSrcName.reset( new sal_Char[ nCtrlSrcBufSize ] );
-                pS->Read( pCtrlSrcName.get(), nCtrlSrcBufSize );
-                rec.sCtrlSource = lclCreateOUString( pCtrlSrcName.get(), nCtrlSrcLen );
-                OSL_TRACE("*** *** *** ControlSourceName -> %s ", rtl::OUStringToOString( rec.sCtrlSource, RTL_TEXTENCODING_UTF8 ).getStr() );
-            }
-            // row source name
-            sal_uInt32 nRowSrcBufSize = lclGetBufferSize( nRowSrcLen );
-            if( nRowSrcBufSize > 0 )
+            ContainerRecord rec;
+            OleSiteConcreteControl site;
+            site.Read( rec, pS );
+            if ( rec.nTypeIdent >= ( UNKNOWNCTRL + 1 ) )
             {
-                ReadAlign( pS, pS->Tell() - nStartPos, 4 );
-                std::auto_ptr< sal_Char > pRowSrcName;
-                pRowSrcName.reset( new sal_Char[ nRowSrcBufSize ] );
-                pS->Read( pRowSrcName.get(), nRowSrcBufSize );
-                rec.sRowSource =  lclCreateOUString( pRowSrcName.get(), nRowSrcLen );
-                OSL_TRACE("*** *** *** RowSourceName -> %s ", rtl::OUStringToOString( rec.sRowSource, RTL_TEXTENCODING_UTF8 ).getStr() );
+                sal_uInt16 nIndex = rec.nTypeIdent - ( UNKNOWNCTRL + 1 );
+                if ( nIndex <  rSiteClassInfo.size() )
+                    rec.nTypeIdent = rSiteClassInfo[ nIndex ].getTypeId();
             }
-
-            // seek to end of data
-            pS->Seek( nStartPos + nSize );
-
-            rec.cName = lclCreateOUString(pName, nNameLen);
-            delete[] pName;
-
             OCX_Control* pControl = NULL;
+           OSL_TRACE("** About to create control of type 0x%x with name %s from rec", rec.nTypeIdent, rtl::OUStringToOString( rec.cName, RTL_TEXTENCODING_UTF8 ).getStr() );
             if( pContainerControl->createFromContainerRecord( rec, pControl ) &&
                 pControl )
             {
                 // propagate doc shell from parent
                 pControl->pDocSh = pContainerControl->pDocSh;
                 pContainerControl->ProcessControl( pControl, pS, rec );
+
             }
             else if ( rec.nTypeIdent & 0x8000 )
             {
                 // Skip ActiveX Controls we can't import
-                SotStorageStreamRef oStream = pContainerControl->getContainedControlsStream();
+                SotStorageStreamRef oStream = pContainerControl->getOStream();
                 ULONG nStrmPos = oStream->Tell();
                 oStream->Seek( nStrmPos + rec.nSubStreamLen );
             }
@@ -797,91 +987,14 @@ class ContainerRecReader
         return true;
     }
 
+    ContainerRecReader():nNoRecords(0), nTotalLen(0){}
     protected:
-    ContainerRecReader() : isMultiPage(false){}
-    bool isMultiPage;
     sal_uInt32 nNoRecords;
     sal_uInt32 nTotalLen;
 
     private:
-    bool handleStandardHdr( SvStorageStream* pS )
-    {
-        sal_uInt8 aUnknown11[4];
-        pS->Read(aUnknown11, sizeof(aUnknown11));
-        // discovered a dialog with value of 0xFF for aUnknown11
-        // needed an extra 4 bytes to offset correctly  into the control
-        // records. Valid test or coincidence ?
-        if ( aUnknown11[1] == 0xFF )
-           pS->Read( aUnknown11, sizeof(aUnknown11));
-        return true;
-    }
-
-    bool handleMultiPageHdr( SvStorageStream* pS )
-    {
-        sal_uInt32 nUnknown_32b; // unknown 32 bit structure, flags ?
-        sal_uInt16 nUnknown_16b; // unknown 16 bit structure
-        sal_uInt16 nMysteryLen; // lenght of unknown sub record
-
-        *pS >> nUnknown_32b;
-        *pS >> nUnknown_16b;
-        *pS >> nMysteryLen;
-
-        pS->SeekRel( nMysteryLen );
-        return true;
-    }
-    ContainerRecordList records;
 };
 
-class StdContainerRecReader : public ContainerRecReader
-{
-    public:
-    StdContainerRecReader(){}
-};
-
-class MultiPageContainerRecReader : public ContainerRecReader
-{
-    public:
-    MultiPageContainerRecReader()
-    {
-        // NP ( 27-01-05 )
-        // Strictly speaking this approach shouldn't be necessary.
-        // It should be possible to have a common routine read the
-        // container record array and by examining the flags present in
-        // the record to determine we expect to read or not.
-        // In this case for a MultPage control there is no Top or Left
-        // values in the control record array, however time contraints
-        // and associated risk prevent further investigation of this
-        // at the moment.
-        // similar situation exists for the start of the container record
-        // which in the case of the MultiPage is different from
-        // UserForm & Frame ( the other containers )
-
-        isMultiPage = true; // tell the base class skip
-    }
-};
-
-class ContainerRecordReaderFac
-{
-    public:
-    static ContainerRecReader* instance( sal_uInt32 containerType )
-    {
-        switch( containerType )
-        {
-            case PAGE:
-            case FRAME:
-            case USERFORM:
-            case STDCONTAINER:
-                return new StdContainerRecReader();
-            case MULTIPAGE:
-                return new MultiPageContainerRecReader();
-            default:
-                DBG_ERROR("Illegal container type for factory");
-                return NULL;
-        }
-    }
-    private:
-    ContainerRecordReaderFac();
-};
 
 } // namespace
 
@@ -1069,13 +1182,20 @@ sal_Bool OCX_Control::Import(uno::Reference<container::XNameContainer> &rDialog
         return sal_False;
 
     sal_Bool bVBA = sal_False;
+    uno::Reference<beans::XPropertySet> xPropSet(xCreate, uno::UNO_QUERY);
+
+    if (!xPropSet.is())
+        return sal_False;
     /*  #147900# sometimes insertion of a control fails due to existing name,
         do not break entire form import then... */
     try
     {
         rDialog->insertByName(sName, uno::makeAny(xModel));
         if ( xDlgProps.is() )
+        {
             xDlgProps->getPropertyValue( OUString(RTL_CONSTASCII_USTRINGPARAM("VBAForm") ) ) >>= bVBA;
+            xPropSet->setPropertyValue( OUString(RTL_CONSTASCII_USTRINGPARAM("VBAForm") ), uno::makeAny( bVBA ) );
+        }
 
     }
     catch( uno::Exception& )
@@ -1086,15 +1206,10 @@ sal_Bool OCX_Control::Import(uno::Reference<container::XNameContainer> &rDialog
             Append( '"' ).GetBuffer() );
     }
 
-    uno::Reference<beans::XPropertySet> xPropSet(xCreate, uno::UNO_QUERY);
-    if (!xPropSet.is())
-        return sal_False;
-
     if (!Import(xPropSet))
         return sal_False;
 
     uno::Any aTmp;
-    sal_Int32 nFactor = 3528;
 
     if ( !bVBA  )
     {
@@ -3472,8 +3587,15 @@ sal_Bool OCX_Label::Read(SvStorageStream *pS)
     {
         pS->Read(pPictureHeader,20);
         *pS >> nPictureLen;
-        pPicture = new sal_uInt8[nPictureLen];
-        pS->Read(pPicture,nPictureLen);
+        long imagePos = pS->Tell();
+        mxGrfObj = lcl_readGraphicObject( pS );
+        if( mxGrfObj.is() )
+        {
+            sImageUrl = rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( GRAPHOBJ_URLPREFIX ) );
+            sImageUrl = sImageUrl + mxGrfObj->getUniqueID();
+        }
+        // make sure the stream position should be pointing after the image
+        pS->Seek( imagePos + nPictureLen );
     }
     if (nIcon)
     {
@@ -3493,165 +3615,6 @@ TypeName::TypeName(sal_Char *pName, sal_uInt32 nStoreId, sal_uInt32 nLen, sal_uI
 {
 }
 
-OCX_ContainerControl::OCX_ContainerControl( SotStorageRef& parent,
-            const ::rtl::OUString& storageName,
-            const ::rtl::OUString& sN,
-            const uno::Reference< container::XNameContainer >  &rParent,
-            OCX_Control* pParent ) :
-                OCX_Control(sN, pParent), mxParent(rParent), nNoRecords(0), nTotalLen(0), containerType( STDCONTAINER )
-{
-
-    mContainerStorage = parent->OpenSotStorage(storageName,
-        STREAM_READWRITE |
-        STREAM_NOCREATE |
-        STREAM_SHARE_DENYALL);
-    mContainerStream = mContainerStorage->OpenSotStream(
-        String(RTL_CONSTASCII_STRINGPARAM("f"),
-        RTL_TEXTENCODING_MS_1252),
-        STREAM_STD_READ | STREAM_NOCREATE);
-    mContainedControlsStream = mContainerStorage->OpenSotStream( String(RTL_CONSTASCII_STRINGPARAM("o"),
-        RTL_TEXTENCODING_MS_1252),
-        STREAM_STD_READ | STREAM_NOCREATE);
-}
-OCX_ContainerControl::~OCX_ContainerControl()
-{
-    CtrlIterator aEnd = mpControls.end();
-    for (CtrlIterator aIter = mpControls.begin(); aIter != aEnd; ++ aIter )
-    {
-        delete *aIter;
-    }
-}
-
-// Really import should receive the parent e.g. a Userform, Frame or Multi Page
-// and call import on its containees with itself  ( up-called from
-// the base class ) but... the reality is we have no containment model
-// so we make sure rPropSet is always the parent Dialog
-
-sal_Bool OCX_ContainerControl::Import(uno::Reference<beans::XPropertySet>& /* rProps */ )
-{
-    if ( !mxParent.is() )
-    {
-        return sal_False;
-    }
-    CtrlIterator aEnd = mpControls.end();
-//    int count = 0;
-    for (CtrlIterator aIter = mpControls.begin(); aIter != aEnd; ++ aIter )
-    {
-        if ( !(*aIter)->Import( mxParent ) )
-        {
-            return sal_False;
-        }
-    }
-    return sal_True;
-}
-
-OUString OCX_ContainerControl::createSubStreamName( const sal_uInt32& subStorageId )
-{
-    static OUString sI = OUString::createFromAscii("i");
-    static OUString sZero = OUString::createFromAscii( "0" );
-    OUStringBuffer buf( 6 );
-    buf.append( sI );
-    // for subStorage id < 10 stream name has leading '0'
-    // eg "i07"
-    if ( subStorageId < 10 )
-    {
-        buf.append( sZero );
-    }
-    buf.append( OUString::valueOf( (sal_Int32)subStorageId ) );
-    return buf.makeStringAndClear();
-}
-
-
-bool OCX_ContainerControl::createFromContainerRecord( ContainerRecord& record, OCX_Control*& pControl )
-{
-    pControl = NULL;
-    if (  record.nTypeIdent & 0x8000 )
-    {
-        std::hash_map<sal_uInt16, sal_uInt16>::iterator it = mActiveXIDMap.find( record.nTypeIdent );
-        if ( it == mActiveXIDMap.end() )
-            return false;
-        // replace the generated id with our hardcoded one
-        record.nTypeIdent = it->second;
-    }
-    switch ( record.nTypeIdent)
-        {
-            case CMDBUTTON:
-                pControl = new OCX_CommandButton;
-                break;
-            case LABEL:
-                pControl = new OCX_UserFormLabel(this);
-                break;
-            case TEXTBOX:
-                pControl = new OCX_TextBox;
-                break;
-            case LISTBOX:
-                pControl = new OCX_ListBox;
-                break;
-            case COMBOBOX:
-                pControl = new OCX_ComboBox;
-                break;
-            case CHECKBOX:
-                pControl =  new OCX_CheckBox;
-                break;
-            case OPTIONBUTTON:
-                pControl = new OCX_OptionButton;
-                break;
-            case TOGGLEBUTTON:
-                pControl = new OCX_ToggleButton;
-                break;
-            case IMAGE: //Image
-            {
-                pControl = new OCX_Image;
-                break;
-            }
-            case PAGE: // Page
-            {
-                OUString sMSStore = createSubStreamName( record.nSubStorageId );
-                pControl = new OCX_Page(mContainerStorage, sMSStore,
-                    record.cName, mxParent, this);
-                break;
-            }
-            case MULTIPAGE: // MultiPage
-            {
-                OUString sMSStore = createSubStreamName( record.nSubStorageId );
-                pControl = new OCX_MultiPage( mContainerStorage, sMSStore,
-                    record.cName, mxParent, this);
-                break;
-            }
-            case FRAME:  //Frame
-            {
-                OUString sFrameStore = createSubStreamName( record.nSubStorageId );
-                pControl = new OCX_Frame(mContainerStorage, sFrameStore,
-                    record.cName, mxParent, this);
-
-                break;
-            }
-            case SPINBUTTON: //SpinButton
-            {
-                pControl = new OCX_SpinButton;
-                break;
-            }
-            case TABSTRIP: //TabStrip
-            {
-                pControl = new OCX_TabStrip;
-                break;
-            }
-            case SCROLLBAR: //ScrollBar
-                pControl = new OCX_ScrollBar;
-                break;
-            case PROGRESSBAR: //ProgressBar Active X control
-                pControl = new OCX_ProgressBar;
-                break;
-            default:
-                OSL_TRACE( "**** Unknown control 0x%x", record.nTypeIdent );
-                DBG_ERROR( "Unknown control");
-                return false;
-        }
-        pControl->sName = record.cName;
-        return true;
-}
-
-
 void addSeperator( std::vector< OCX_Control* >& dest )
 {
     OCX_Control* seperator = new OCX_CommandButton;
@@ -3675,143 +3638,59 @@ void addRButtons( std::vector< OCX_Control* >& src,
     }
 }
 
-void OCX_ContainerControl::ProcessControl(OCX_Control* pControl,SvStorageStream* /* pS */,  ContainerRecord& rec )
-{
-    SotStorageStreamRef oStream = mContainedControlsStream;
-
-    // can insert into OO Dialog (e.g is this a supported dialog control)??
-    if ( rec.nTypeIdent == TABSTRIP )
-    {
-        // skip the record in the stream, discard the control
-        oStream->SeekRel( rec.nSubStreamLen );
-        delete pControl;
-    }
-    else
-    {
-        // A container control needs to read the f stream in
-        // the folder ( substorage ) associated with this control
-        switch ( rec.nTypeIdent )
-        {
-            case FRAME:
-            case MULTIPAGE:
-            case PAGE:
-                {
-                    OCX_ContainerControl* pContainer =
-                        static_cast< OCX_ContainerControl* >( pControl );
-                    oStream = pContainer->getContainerStream();
-                    break;
-                }
-            case LISTBOX:
-            case OPTIONBUTTON:
-            case COMBOBOX:
-            case SPINBUTTON:
-            case SCROLLBAR:
-                {
-                    pControl->msCtrlSource = rec.sCtrlSource;
-                    pControl->msRowSource = rec.sRowSource;
-                }
-        }
-        pControl->sName = rec.cName;
-        pControl->msToolTip = rec.controlTip;
-        // Position of controls is relative to the container
-        pControl->mnTop = rec.nTop + mnTop;
-        pControl->mnLeft = rec.nLeft + mnLeft;
-        // MS tabIndex, pretty useless in OpenOffice land
-        // as tab indexes in MS are relative to parent container.
-        // However we need this value in order to set
-        // OpenOffice tab indices in a sensible way to
-        // reflect the ms tabbing from orig MS UserForm, see below
-        pControl->mnTabPos = rec.nTabPos;
-        pControl->SetInDialog(true);
-        pControl->mbVisible = rec.bVisible;
-        if ( mnStep )
-        {
-            // If the container has a step then it should be
-            // applied to all containees
-            pControl->mnStep = mnStep;
-        }
-        pControl->msParentName = sName;
-
-        // #117490# DR: container records provide size of substream, use it here...
-
-        // remember initial position to set correct stream position
-        ULONG nStrmPos = oStream->Tell();
-        // import control, may return with invalid stream position
-        pControl->FullRead(oStream);
-        // set stream to position behind substream of this control
-        oStream->Seek( nStrmPos + rec.nSubStreamLen );
-
-        mpControls.push_back( pControl );
-    }
-}
-
-sal_Bool OCX_ContainerControl::Read(SvStorageStream *pS)
-{
-
-    if ( mpParent )
-    {
-        mnBackColor = mpParent->mnBackColor;
-    }
-
-    std::auto_ptr< ContainerRecReader > reader (
-        ContainerRecordReaderFac::instance( containerType ) );
-
-    reader->Read( this, pS );
-    // Need to honour the MS Tab Indexes. However MS tab indexes are
-    // relative to parent, this hack sorts the controls in each container
-    // based on the ms tab indexes. When import is called we create the
-    // controls in Open/Star office based on the order of the tab indexes,
-    // this ensures that the default tab index created by Star/Open office
-    // reflects the "flattened" ms tab order.
-    ::std::sort( mpControls.begin(), mpControls.end(), SortOrderByTabPos() );
-    return true;
-}
-
 OCX_MultiPage::OCX_MultiPage( SotStorageRef& parent,
             const ::rtl::OUString& storageName,
             const ::rtl::OUString& sN,
             const uno::Reference< container::XNameContainer >  &rDialog,
             OCX_Control* pParent):
-        OCX_ContainerControl(parent, storageName, sN, rDialog, pParent ), fUnknown1(0), fEnabled(1),
-        fLocked(0), fBackStyle(1), fWordWrap(1), fAutoSize(0), nCaptionLen(0),
-        nVertPos(1), nHorzPos(7), nMousePointer(0), nBorderColor(0x80000012),
-        nKeepScrollBarsVisible(3), nCycle(0), nBorderStyle(0), nSpecialEffect(0),
-        nPicture(0), nPictureAlignment(2), nPictureSizeMode(0),
-        bPictureTiling(FALSE), nAccelerator(0), nIcon(0), pCaption(0),
-        nScrollWidth(0), nScrollHeight(0), nIconLen(0), pIcon(0), nPictureLen(0),
-        pPicture(0)
-{
-    //msDialogType = C2U("NotSupported");
+        OCX_ParentControl(parent, storageName, sN, rDialog, pParent ), bHasTabs( true )
+{
     msDialogType = C2U("com.sun.star.awt.UnoMultiPageModel");
     mnForeColor = 0x80000012L,
     mnBackColor = 0x8000000FL;
     bSetInDialog = true;// UserForm control only
     aFontData.SetHasAlign(TRUE);
-    containerType = MULTIPAGE;
-    mnCurrentPageStep = 0;
+    nActiveTab = 0;
+    // open up the 'x' stream
+    mXStream = mContainerStorage->OpenSotStream(
+        String(RTL_CONSTASCII_STRINGPARAM("x"),
+        RTL_TEXTENCODING_MS_1252),
+        STREAM_STD_READ | STREAM_NOCREATE);
 }
 
 void OCX_MultiPage::ProcessControl(OCX_Control* pControl, SvStorageStream* /* pS */,  ContainerRecord& rec )
 {
     SotStorageStreamRef oStream = mContainedControlsStream;
 
-    OCX_Page *pPage = NULL;
-    if ( rec.nTypeIdent == PAGE )
-        pPage = static_cast< OCX_Page* >( pControl );
-    if ( pPage != NULL )
+    if ( rec.nTypeIdent == TABSTRIP )
     {
-        pPage->mnStep = ++mnCurrentPageStep;
-
-        pPage->mnTop =  mnTop;// move these to Page::import ?
-        pPage->mnLeft = mnLeft;
-        pPage->mnBackColor = mnBackColor;
-
-        oStream = pPage->getContainerStream();;
-        // Position of controls is relative to pos of this MuliPage
-        // Control
-        pPage->FullRead( oStream );
-
-        mpControls.push_back( pPage );
+        // TabStrip reads the 'o' stream
+        OCX_TabStrip oTabStrip;
+        oTabStrip.sName = C2S("FromMultiPage-o");
+        oTabStrip.Read( mContainedControlsStream );
+        sCaptions = oTabStrip.msItems;
+        bHasTabs = oTabStrip.bHasTabs;
+        nHeight = oTabStrip.nHeight;
+        nWidth = oTabStrip.nWidth;
+    }
+    else if ( rec.nTypeIdent == PAGE )
+    {
+        OCX_Page *pPage = NULL;
+        pPage = static_cast< OCX_Page* >( pControl );
+        if ( pPage != NULL )
+        {
+            oStream = pPage->getContainerStream();;
+            // Position of controls is relative to pos of this MuliPage
+            // Control
+            pPage->FullRead( oStream );
+            // nWidth & nHeight seem to screw up multipage control
+            pPage->nWidth = 0;
+            pPage->nHeight = 0;
+            pPage->mnBackColor = mnBackColor;
+
+            mpControls.push_back( pPage );
+            idToPage[ pPage->mnID ] = pPage;
+        }
     }
     else
     {
@@ -3825,110 +3704,79 @@ sal_Bool OCX_MultiPage::Read(SvStorageStream *pS)
 {
     // Unlike the other containers e.g. UserForm & Frame
     // the o stream is does not contain info for the contained controls
-    // ( e.g. the pages themselves ) but seems to be for the MultiPage
-    // itself - need to check this in more detail
-
-    // For the moment skip read of the MultiPage specific properties
-    // not much point reading these as we can't display the multi page
-    // control or in fact any sort of tabbed layout, best we can do is
-    // import just the contained controls of the individual pages
-    // Note: the record skipped below ( does not contain the expected
-    // info on this control, that seems to be contained in the o stream,
-    // see comment above)
+    // 'o' stream contains a tabstrip control
+    // 'f' stream as usual ( info about the containees )
+    // '01..09' ( etc. ) these streams contain the page controls
+    // 'x' stream, this contains an array of properties for each page followed
+    //    by a set of properties for the multipage control itself
+
+    // read the 'f' stream
+    OCX_ParentControl::Read(pS);
+
+    // Read the 'x' stream
+    // consists of
+    //   a) nTabs + 1 PageProperties ( which are little use to us )
+    //      => skip
+    //   b) a MutliPageProperty ( which contains at least the page count and
+    //       IDs of the pages ( and order ) - useful for associating correct page
+    //       with correct tab
+
     OCX_Control skip(C2S("Dummy"));
-    skip.Read( pS );
-    mnCurrentPageStep = mnStep; //( set step of of pages relative to step
-                                //of this MultiPage ( e.g. emulate containment )
-    return OCX_ContainerControl::Read(pS);
+    sal_Int32 nPagePropsToRead = sCaptions.size() + 1;
+    for ( sal_Int32 page = 0; page < nPagePropsToRead; ++page )
+        skip.Read( mXStream );
+    MultiPageProps multiPage;
+    multiPage.Read( mXStream );
+    mPageIds = multiPage.mnIDs;
+    return true;
 }
 
 
 sal_Bool OCX_MultiPage::Import(com::sun::star::uno::Reference<
     com::sun::star::beans::XPropertySet> &rPropSet)
 {
-    OCX_ContainerControl::Import( rPropSet );
-    return sal_True;
-}
-
-sal_Bool OCX_MultiPage::Import(com::sun::star::uno::Reference<
-        com::sun::star::container::XNameContainer>
-        &rDialog)
-{
-    uno::Reference<beans::XPropertySet> xPropSet( rDialog, uno::UNO_QUERY );
-
-    // Although MultiPage is not represeted by a "real" control we still
-    // need to propagate the backcolor of this logical parent
-    // ( the dialog or Frame or whatever ) to the children of this control.
-    // For example the controls contained in the Page of a
-    // MultiPage control use the parents backcolor ( e,g,
-    // Pages backcolor ) when trying to fake transparency
-    mnBackColor = mpParent->mnBackColor;
-
-    if ( xPropSet.is() )
-    {
-        uno::Reference<lang::XMultiServiceFactory>
-            xFactory(rDialog, uno::UNO_QUERY);
-    OSL_TRACE("** MultiPage creating control %s", rtl::OUStringToOString( msDialogType, RTL_TEXTENCODING_UTF8 ).getStr() );
-    uno::Reference<uno::XInterface> xCreate = xFactory->createInstance(msDialogType);
-    if (!xCreate.is())
-        return sal_False;
-
-    uno::Reference<awt::XControlModel> xModel(xCreate, uno::UNO_QUERY);
-    if (!xModel.is())
-        return sal_False;
-
-        try
-        {
-        // we should just call MultiPage::Import( XPropertySet )
-            OSL_TRACE("********* MULTIPAGE cName %s", rtl::OUStringToOString( sName, RTL_TEXTENCODING_UTF8 ).getStr() );
-        uno::Any aTmp(&sName,getCppuType((OUString *)0));
-        uno::Reference<beans::XPropertySet> xPrps(xModel, uno::UNO_QUERY);
-        xPrps->setPropertyValue( WW8_ASCII2STR("Name"), aTmp );
-        aTmp = uno::makeAny( mnCurrentPageStep );
-        xPrps->setPropertyValue( WW8_ASCII2STR("ProgressValueMax"), aTmp );
-        // default current page to 0 ( #FIXME, we need to read this value )
-        aTmp = uno::makeAny( sal_Int32(0) );
-        xPrps->setPropertyValue( WW8_ASCII2STR("ProgressValue"), aTmp );
-            OSL_TRACE("********* MULTIPAGE vomitted out properties");
+    uno::Any aTmp(&sName,getCppuType((OUString *)0));
+    rPropSet->setPropertyValue(
+        OUString(RTL_CONSTASCII_USTRINGPARAM("Name")), aTmp);
+    if ( !bHasTabs )
+        rPropSet->setPropertyValue(
+            OUString(RTL_CONSTASCII_USTRINGPARAM("Decoration")), uno::makeAny( sal_False ) );
+    aTmp <<= ImportColor(mnBackColor);
+    rPropSet->setPropertyValue( WW8_ASCII2STR("BackgroundColor"), aTmp);
+    // apply caption/titles to pages
 
     // Calls import on contained controls
-            rDialog->insertByName(sName, uno::makeAny(xModel));
-            OSL_TRACE("*** inserted ***");
-        }
-        catch( uno::Exception& )
+    std::vector<sal_Int32>::iterator itCtrlId = mPageIds.begin();
+    std::vector<sal_Int32>::iterator itCtrlId_end = mPageIds.end();
+    std::vector< rtl::OUString >::iterator  itCaption = sCaptions.begin();
+    mpControls.clear();
+    // need to sort the controls according to the order of the ids
+    for ( sal_Int32 index = 1 ; ( sCaptions.size() == idToPage.size() ) && itCtrlId != itCtrlId_end; ++itCtrlId, ++itCaption, ++index )
+    {
+        std::hash_map< sal_Int32, OCX_Page* >::iterator it = idToPage.find( *itCtrlId );
+        if ( it != idToPage.end() )
         {
-            DBG_ERRORFILE(
-                ByteString( "OCX_Control::Import - cannot insert control \"" ).
-                Append( ByteString( sName, RTL_TEXTENCODING_UTF8 ) ).
-                Append( '"' ).GetBuffer() );
-        }
+            it->second->msTitle = *itCaption;
+            if ( it->second->mbVisible )
+                nActiveTab = index;
+            mpControls.push_back( it->second );
 
-        // Calls import on contained pages
-        return OCX_ContainerControl::Import( xPropSet );
+        }
     }
-    OSL_TRACE("*** Major problem, no dialog to add controls to ");
-    DBG_ERROR(" Major problem, no dialog to add controls to ");
-    return false;
-}
-
 
+    OCX_ParentControl::Import( rPropSet );
+    rPropSet->setPropertyValue( WW8_ASCII2STR("MultiPageValue"), uno::makeAny( nActiveTab ));
+    return sal_True;
+}
 
 OCX_Page::OCX_Page( SotStorageRef& parent,
-            const ::rtl::OUString& storageName,
+            sal_Int32 nId,
             const ::rtl::OUString& sN,
             const uno::Reference< container::XNameContainer >  &rDialog,
             OCX_Control* pParent):
-        OCX_ContainerControl(parent, storageName, sN, rDialog, pParent ),
-        fUnknown1(0), fEnabled(1), fLocked(0),
-        fBackStyle(1), fWordWrap(1), fAutoSize(0), nCaptionLen(0), nVertPos(1),
-        nHorzPos(7), nMousePointer(0), nBorderColor(0x80000012),
-        nKeepScrollBarsVisible(3), nCycle(0), nBorderStyle(0), nSpecialEffect(0),
-        nPicture(0), nPictureAlignment(2), nPictureSizeMode(0),
-        bPictureTiling(FALSE), nAccelerator(0), nIcon(0), pCaption(0),
-        nScrollWidth(0), nScrollHeight(0), nIconLen(0), pIcon(0), nPictureLen(0),
-        pPicture(0)
-{
-    msDialogType = C2U("NotSupported");
+        OCX_ParentControl(parent, createSubStreamName( nId ), sN, rDialog, pParent ), mnID( nId )
+{
+    msDialogType = C2U("com.sun.star.awt.UnoPageModel");
     mnForeColor = 0x80000012,
     mnBackColor = 0x8000000F,
     bSetInDialog = true;// UserForm control only
@@ -3938,65 +3786,34 @@ OCX_Page::OCX_Page( SotStorageRef& parent,
 
 sal_Bool OCX_Page::Read(SvStorageStream *pS)
 {
-    long nStart = pS->Tell();
-    *pS >> nIdentifier;
-    DBG_ASSERT(0x400==nIdentifier,
-            "A control that has a different identifier");
-    *pS >> nFixedAreaLen;
-    pS->Read(pBlockFlags,4);
-
-    pS->SeekRel( nFixedAreaLen - sizeof( pBlockFlags ) );
-
-    ReadAlign( pS, pS->Tell() - nStart, 4);
-
-    if (pBlockFlags[2] & 0x10)
-    {
-        //Font Stuff..
-        pS->SeekRel(0x1a);
-        sal_uInt8 nFontLen;
-        *pS >> nFontLen;
-        pS->SeekRel(nFontLen);
-    }
-    return OCX_ContainerControl::Read(pS);
-
+    return OCX_ParentControl::Read(pS);
 }
 
 sal_Bool OCX_Page::Import(com::sun::star::uno::Reference<
-        com::sun::star::container::XNameContainer>
-        &rDialog)
+        com::sun::star::beans::XPropertySet>
+        &rPropSet)
 {
+    uno::Any aTmp(&sName,getCppuType((OUString *)0));
+    rPropSet->setPropertyValue(
+        OUString(RTL_CONSTASCII_USTRINGPARAM("Name")), aTmp);
 
-    uno::Reference<beans::XPropertySet> xPropSet( rDialog, uno::UNO_QUERY );
-    if ( xPropSet.is() )
-    {
-        // apply Step to contained controls
-        CtrlIterator aEnd = mpControls.end();
-        for (CtrlIterator aIter = mpControls.begin(); aIter != aEnd; ++ aIter )
-        {
-            (*aIter)->mnStep = mnStep;
-        }
-        // Calls import on contained pages
-        return OCX_ContainerControl::Import( xPropSet );
-    }
-    OSL_TRACE("*** Major problem, no dialog to add controls to ");
-    DBG_ERROR("*** Major problem, no dialog to add controls to ");
-    return sal_False;
+    if (msTitle.getLength())
+        rPropSet->setPropertyValue( WW8_ASCII2STR("Title"), uno::makeAny( msTitle ) );
+
+    aTmp <<= ImportColor(mnBackColor);
+    rPropSet->setPropertyValue( WW8_ASCII2STR("BackgroundColor"), aTmp);
+
+    // Calls import on contained controls
+    OCX_ParentControl::Import( rPropSet );
+    return sal_True;
 }
 
 OCX_Frame::OCX_Frame( SotStorageRef& parent,
             const ::rtl::OUString& storageName,
             const ::rtl::OUString& sN,
-            const uno::Reference< container::XNameContainer >  &rDialog, OCX_Control* pParent):
-        OCX_ContainerControl(parent, storageName, sN, rDialog, pParent ),fUnknown1(0),fEnabled(1), fLocked(0),
-        fBackStyle(1), fWordWrap(1), fAutoSize(0), nCaptionLen(0), nVertPos(1),
-        nHorzPos(7), nMousePointer(0), nBorderColor(0x80000012),
-        nKeepScrollBarsVisible(3), nCycle(0), nBorderStyle(0), nSpecialEffect(0),
-        nPicture(0), nPictureAlignment(2), nPictureSizeMode(0),
-        bPictureTiling(FALSE), nAccelerator(0), nIcon(0), pCaption(0),
-        nScrollWidth(0), nScrollHeight(0), nScrollLeft(0), nScrollTop(0), nIconLen(0), pIcon(0), nPictureLen(0),
-        pPicture(0)
-{
-    msDialogType = C2U("com.sun.star.awt.UnoControlGroupBoxModel");
+            const uno::Reference< container::XNameContainer >  &rDialog, OCX_Control* pParent): OCX_ParentControl(parent, storageName, sN, rDialog, pParent )
+{
+    msDialogType = C2U("com.sun.star.awt.UnoFrameModel");
     mnForeColor = 0x80000012;
     mnBackColor = 0x8000000F;
     bSetInDialog = true;// UserForm control only
@@ -4006,159 +3823,7 @@ OCX_Frame::OCX_Frame( SotStorageRef& parent,
 
 sal_Bool OCX_Frame::Read(SvStorageStream *pS)
 {
-    long nStart = pS->Tell();
-    *pS >> nIdentifier;
-    DBG_ASSERT(0x400==nIdentifier,
-            "A control that has a different identifier");
-    *pS >> nFixedAreaLen;
-    pS->Read(pBlockFlags,4);
-
-    if (pBlockFlags[0] & 0x01)
-    {
-            DBG_ASSERT(!this, "ARSE");
-    }
-    if (pBlockFlags[0] & 0x02)
-            *pS >> mnBackColor;
-    if (pBlockFlags[0] & 0x04)
-            *pS >> mnForeColor;
-    if (pBlockFlags[0] & 0x08)
-        *pS >> fUnknown1;
-    if (pBlockFlags[0] & 0x40)
-    {
-        sal_uInt8 nTemp;
-        *pS >> nTemp;
-        fEnabled = (nTemp&0x04)>>2;
-        fBackStyle = (nTemp&0x08)>>3;
-        *pS >> nTemp;
-        *pS >> nTemp;
-        fWordWrap = (nTemp&0x80)>>7;
-        *pS >> nTemp;
-        fAutoSize = (nTemp&0x10)>>4;
-    }
-    if (pBlockFlags[0] & 0x80)
-    {
-        *pS >> nBorderStyle;
-    }
-
-    ReadAlign(pS, pS->Tell() - nStart, 4);
-
-    if (pBlockFlags[1] & 0x01)
-        *pS >> nMousePointer;
-    if (pBlockFlags[1] & 0x02)
-        *pS >> nKeepScrollBarsVisible;
-    if (pBlockFlags[1] & 0x20)
-        *pS >> fUnknown1; // another unknown 32 bit ( or is 8 or 16 bit with padding ? )
-
-    if (pBlockFlags[1] & 0x80)
-    {
-        ReadAlign(pS, pS->Tell() - nStart, 2);
-        *pS >> nIcon;
-        DBG_ASSERT(nIcon == 0xFFFF, "Unexpected nIcon");
-    }
-
-    bool bCaption = false;
-
-    if (pBlockFlags[2] & 0x01)
-        *pS >> nCycle;
-    if (pBlockFlags[2] & 0x02)
-        *pS >> nSpecialEffect;
-
-    if (pBlockFlags[2] & 0x04)
-    {
-        ReadAlign(pS, pS->Tell() - nStart, 4);
-        *pS >> nBorderColor;
-    }
-
-    if (pBlockFlags[2] & 0x08)
-    {
-        ReadAlign(pS, pS->Tell() - nStart, 4);
-        *pS >> nCaptionLen;
-        bCaption = true;
-    }
-
-    if (pBlockFlags[2] & 0x10)
-    {
-        ReadAlign(pS, pS->Tell() - nStart, 2);
-        sal_uInt16 nNoIdea;
-        *pS >> nNoIdea;
-        DBG_ASSERT(nNoIdea == 0xFFFF, "Expected 0xFFFF, (related to font ?)");
-    }
-
-    if (pBlockFlags[2] & 0x20)
-    {
-        ReadAlign(pS, pS->Tell() - nStart, 2);
-        *pS >> nPicture;
-        DBG_ASSERT(nPicture == 0xFFFF, "Unexpected nIcon");
-    }
-
-    if (pBlockFlags[2] & 0x80)
-        *pS >> nPictureAlignment;
-
-    if (pBlockFlags[3] & 0x01)
-        bPictureTiling = true;
-
-    if (pBlockFlags[3] & 0x02)
-        *pS >> nPictureSizeMode;
-
-    if (pBlockFlags[3] & 0x04)
-    {
-        ReadAlign(pS, pS->Tell() - nStart, 4);
-        *pS >> fUnknown8;
-    }
-
-    if (pBlockFlags[3] & 0x08)
-    {
-        ReadAlign(pS, pS->Tell() - nStart, 4);
-        *pS >> fUnknown9;
-    }
-
-    ReadAlign(pS, pS->Tell() - nStart, 4);
-    *pS >> nWidth;
-    *pS >> nHeight;
-    *pS >> nScrollWidth;
-    *pS >> nScrollHeight;
-
-    if (pBlockFlags[1] & 0x10)
-    {
-        *pS >> nScrollLeft;
-        *pS >> nScrollTop;
-    }
-
-    if ( bCaption )
-    {
-        lclReadCharArray( *pS, pCaption, nCaptionLen, pS->Tell() - nStart);
-    }
-
-    OUString tempCaption =  lclCreateOUString( pCaption, nCaptionLen );
-
-    if (nIcon)
-    {
-        pS->Read(pIconHeader,20);
-        *pS >> nIconLen;
-        pIcon = new sal_uInt8[nIconLen];
-        pS->Read(pIcon,nIconLen);
-    }
-
-    if (nPicture)
-    {
-        pS->Read(pPictureHeader,20);
-        *pS >> nPictureLen;
-        pPicture = new sal_uInt8[nPictureLen];
-        pS->Read(pPicture,nPictureLen);
-    }
-
-    ReadAlign( pS, pS->Tell() - nStart, 4);
-
-    if (pBlockFlags[2] & 0x10)
-    {
-        //Font Stuff..
-        pS->SeekRel(0x1a);
-        sal_uInt8 nFontLen;
-        *pS >> nFontLen;
-        pS->SeekRel(nFontLen);
-    }
-
-    return OCX_ContainerControl::Read( pS );
+    return OCX_ParentControl::Read( pS );
 }
 
 sal_Bool OCX_Frame::Import(com::sun::star::uno::Reference<
@@ -4172,196 +3837,28 @@ sal_Bool OCX_Frame::Import(com::sun::star::uno::Reference<
         aTmp <<= lclCreateOUString( pCaption, nCaptionLen );
         rPropSet->setPropertyValue( WW8_ASCII2STR("Label"), aTmp);
     }
+/*
+    aTmp <<= ImportColor(mnBackColor);
+    rPropSet->setPropertyValue( WW8_ASCII2STR("BackgroundColor"), aTmp);
+*/
 
     // Calls import on contained controls
-    OCX_ContainerControl::Import( rPropSet );
+    OCX_ParentControl::Import( rPropSet );
     return sal_True;
 }
+
 OCX_UserForm::OCX_UserForm( SotStorageRef& parent,
             const OUString& storageName,
             const OUString& sN,
             const ::uno::Reference< container::XNameContainer >  &rDialog,
             const ::uno::Reference< lang::XMultiServiceFactory >& rMsf):
-        OCX_ContainerControl(parent, storageName, sN, rDialog),
-        nChildrenA(0), fEnabled(1), fLocked(0),
-        fBackStyle(1), fWordWrap(1), fAutoSize(0), nCaptionLen(0), nVertPos(1),
-        nHorzPos(7), nMousePointer(0), nBorderColor(0x80000012), nChildrenB(0),
-        nKeepScrollBarsVisible(3), nCycle(0), nBorderStyle(0), nSpecialEffect(0),
-        nPicture(0), nPictureAlignment(2), nPictureSizeMode(0),
-        bPictureTiling(FALSE), nAccelerator(0), nIcon(0), pCaption(0),
-        nScrollWidth(0), nScrollHeight(0), nScrollLeft(0), nScrollTop(0), nIconLen(0), pIcon(0), nPictureLen(0)
-    {
-            mnForeColor = 0x80000012;
-            mnBackColor = 0x8000000F;
-            uno::Reference< beans::XPropertySet> xProps( rMsf, uno::UNO_QUERY);
-            if ( xProps.is() )
-            {
-                xProps->getPropertyValue(C2S("DefaultContext"))  >>= mxCtx;
-            }
-            aFontData.SetHasAlign(TRUE);
-        }
-sal_Bool OCX_UserForm::Read(SvStorageStream *pS)
+        OCX_ParentControl(parent, storageName, sN, rDialog )
 {
-    long nStart = pS->Tell();
-    *pS >> nIdentifier;
-    DBG_ASSERT(0x400==nIdentifier,
-            "A control that has a different identifier");
-    *pS >> nFixedAreaLen;
-    pS->Read(pBlockFlags,4);
-
-    if (pBlockFlags[0] & 0x01)
-    {
-            DBG_ASSERT(!this, "ARSE");
-    }
-    if (pBlockFlags[0] & 0x02)
-        *pS >> mnBackColor;
-    if (pBlockFlags[0] & 0x04)
-        *pS >> mnForeColor;
-    if (pBlockFlags[0] & 0x08)
-        *pS >> nChildrenA;
-    if (pBlockFlags[0] & 0x40)
-    {
-        sal_uInt8 nTemp;
-        *pS >> nTemp;
-        fEnabled = (nTemp&0x04)>>2;
-        fBackStyle = (nTemp&0x08)>>3;
-        *pS >> nTemp;
-        *pS >> nTemp;
-        fWordWrap = (nTemp&0x80)>>7;
-        *pS >> nTemp;
-        fAutoSize = (nTemp&0x10)>>4;
-    }
-    if (pBlockFlags[0] & 0x80)
-    {
-        ReadAlign(pS, pS->Tell() - nStart, 4);
-        *pS >> nBorderStyle;
-    }
-#if 0
-        sal_uInt16 nFixedOrAlign;
-        *pS >> nFixedOrAlign;
-#endif
-    if (pBlockFlags[1] & 0x01)
-        *pS >> nMousePointer;
-    if (pBlockFlags[1] & 0x02)
-        *pS >> nKeepScrollBarsVisible;
-    if (pBlockFlags[1] & 0x20)
-    {
-        sal_uInt32 nUnknown32;
-        *pS >> nUnknown32;
-    }
-    if (pBlockFlags[1] & 0x80)
-    {
-        ReadAlign(pS, pS->Tell() - nStart, 2);
-        *pS >> nIcon;
-        DBG_ASSERT(nIcon == 0xFFFF, "Unexpected nIcon");
-    }
-    if (pBlockFlags[2] & 0x01)
-        *pS >> nCycle;
-    if (pBlockFlags[2] & 0x02)
-        *pS >> nSpecialEffect;
-
-    if (pBlockFlags[2] & 0x04)
-    {
-        ReadAlign(pS, pS->Tell() - nStart, 4);
-        *pS >> nBorderColor;
-    }
-
-    if (pBlockFlags[2] & 0x10)
-    {
-        ReadAlign(pS, pS->Tell() - nStart, 2);
-        sal_uInt16 nNoIdea;
-        *pS >> nNoIdea;
-        DBG_ASSERT(nNoIdea == 0xFFFF, "Expected 0xFFFF, (related to font ?)");
-    }
-
-    if (pBlockFlags[2] & 0x20)
+    uno::Reference< beans::XPropertySet> xProps( rMsf, uno::UNO_QUERY);
+    if ( xProps.is() )
     {
-        ReadAlign(pS, pS->Tell() - nStart, 2);
-        *pS >> nPicture;
-        DBG_ASSERT(nPicture == 0xFFFF, "Unexpected nIcon");
+        xProps->getPropertyValue(C2S("DefaultContext"))  >>= mxCtx;
     }
-
-    if (pBlockFlags[2] & 0x80)
-        *pS >> nPictureAlignment;
-
-    if (pBlockFlags[3] & 0x01)
-        bPictureTiling = true;
-
-    if (pBlockFlags[3] & 0x02)
-        *pS >> nPictureSizeMode;
-
-    if (pBlockFlags[3] & 0x04)
-    {
-        ReadAlign(pS, pS->Tell() - nStart, 4);
-        *pS >> nChildrenB;
-    }
-
-    ReadAlign(pS, pS->Tell() - nStart, 4);
-    *pS >> nDrawBuffer;
-
-    ReadAlign(pS, pS->Tell() - nStart, 4);
-    *pS >> nWidth;
-    *pS >> nHeight;
-    *pS >> nScrollWidth;
-    *pS >> nScrollHeight;
-
-    if (pBlockFlags[1] & 0x10)
-    {
-        *pS >> nScrollLeft;
-        *pS >> nScrollTop;
-    }
-
-    if (nIcon)
-    {
-        pS->Read(pIconHeader,20);
-        *pS >> nIconLen;
-        pIcon = new sal_uInt8[nIconLen];
-        pS->Read(pIcon,nIconLen);
-    }
-
-    ReadAlign( pS, pS->Tell() - nStart, 4);
-    if (pBlockFlags[2] & 0x10)
-    {
-        //Font Stuff..
-        pS->SeekRel(0x1a);
-        sal_uInt8 nFontLen;
-        *pS >> nFontLen;
-        pS->SeekRel(nFontLen);
-    }
-    if (nPicture)
-    {
-        pS->Read(pPictureHeader,20);
-        *pS >> nPictureLen;
-        long imagePos = pS->Tell();
-        // great embedded object
-        mxGrfObj = lcl_readGraphicObject( pS );
-        if( mxGrfObj.is() )
-        {
-            sImageUrl = rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( GRAPHOBJ_URLPREFIX ) );
-            sImageUrl = sImageUrl + mxGrfObj->getUniqueID();
-        }
-        // make sure the stream position should be pointing after the image.
-        pS->Seek( imagePos + nPictureLen );
-    }
-
-    sal_Int16 numTrailingRecs = 0;
-    *pS >> numTrailingRecs;
-    // seems to be no. of trailing records,
-    // before container record starts proper
-    // ( unknown what these trailing records are for)
-    if ( numTrailingRecs )
-    {
-        for ( sal_Int16 i = 0 ; numTrailingRecs ; --numTrailingRecs, ++i )
-        {
-            sal_uInt16 nTypeID = 0;
-            if ( lcl_handleActiveXControl( pS, nTypeID ) )
-            {
-                if ( nTypeID & 0x8000 ) // valid ActiveXID
-                    mActiveXIDMap[ ( i | 0x8000 ) ] = nTypeID;
-            }
-        }
-    }
-    return OCX_ContainerControl::Read( pS );
 }
 
 sal_Bool OCX_UserForm::Import(
@@ -4388,7 +3885,7 @@ sal_Bool OCX_UserForm::Import(
     catch( uno::Exception& e )
     {
     }
-    sal_Int32 nFactor( 3528 );
+
     if ( !bVBA )
     {
         aTmp <<= sal_Int32((nWidth * 2) / 100);
@@ -4404,30 +3901,23 @@ sal_Bool OCX_UserForm::Import(
         xDialogPropSet->setPropertyValue(WW8_ASCII2STR("Height"), aTmp);
     }
 
+    if ( sImageUrl.getLength() )
+    {
+        aTmp <<= sImageUrl;
+        xDialogPropSet->setPropertyValue( WW8_ASCII2STR("ImageURL"), aTmp);
+    }
 
     uno::Reference<beans::XPropertySet> xPropSet( mxParent, uno::UNO_QUERY );
-    OCX_ContainerControl::Import( xPropSet );
-
-    uno::Reference<io::XInputStreamProvider> xSource =
-        xmlscript::exportDialogModel(mxParent, mxCtx, pDocSh->GetModel() );
+    OCX_ParentControl::Import( xPropSet );
+    uno::Reference< frame::XModel > xModel(  pDocSh ? pDocSh->GetModel() : NULL );
+   uno::Reference<io::XInputStreamProvider> xSource =
+        xmlscript::exportDialogModel(mxParent, mxCtx, xModel );
     uno::Any aSourceAny(uno::makeAny(xSource));
     if (rLib->hasByName(sName))
         rLib->replaceByName(sName, aSourceAny);
     else
         rLib->insertByName(sName, aSourceAny);
 
-    if ( sImageUrl.getLength() )
-    {
-        aTmp <<= sImageUrl;
-        try
-        {
-            xDialogPropSet->setPropertyValue( WW8_ASCII2STR("ImageURL"), aTmp);
-        }
-        catch( uno::Exception& )
-        {
-            OSL_TRACE("OCX_UserForm::Import, Image fails to import");
-        }
-    }
     return sal_True;
 }
 
@@ -4973,6 +4463,11 @@ sal_Bool OCX_CheckBox::Import(com::sun::star::uno::Reference<
     rPropSet->setPropertyValue( WW8_ASCII2STR("VerticalAlign"), aTmp );
 
     aFontData.Import(rPropSet);
+    if ( sImageUrl.getLength() )
+    {
+        aTmp <<= sImageUrl;
+        rPropSet->setPropertyValue( WW8_ASCII2STR("ImageURL"), aTmp);
+    }
     return(sal_True);
 }
 
@@ -5340,33 +4835,238 @@ sal_Bool OCX_FontData::Export(SvStorageStreamRef &rContent,
 // record.
 sal_Bool OCX_TabStrip::Read(SotStorageStream *pS)
 {
-    const long skipLen = 0x18;
+    long nStart = pS->Tell();
     *pS >> nIdentifier;
     DBG_ASSERT(nStandardId==nIdentifier,
         "A control that has a different identifier");
     *pS >> nFixedAreaLen;
 
     pS->Read(pBlockFlags, sizeof(pBlockFlags));
-    pS->SeekRel(skipLen);
-    *pS >> nNumTabs;
-    // skip to end of control
-    pS->SeekRel(nFixedAreaLen - sizeof(pBlockFlags) - sizeof(nNumTabs) - skipLen );
-    return sal_True;
-}
 
-sal_Bool OCX_TabStrip::ReadFontData(SotStorageStream *pS)
-{
-    // Seems like there is a real font record followed by
-    // a number of blank records ( e.g. nFixedAreaLen = 0 )
-    // The number of trailing blank records is equal to the number of tabs
-    OCX_Control::ReadFontData(pS);
-    for ( sal_uInt16 index = 0; index < nNumTabs; index++ )
+    bool bSize = false;
+    bool bMultiRow = false;
+    bool bTooltips = true;
+    bool hasEmbeddedImage = false;
+    sal_Int32 nameSize = 0;
+    sal_Int32 tipStringSize = 0;
+    sal_Int32 nAcceleratorSize = 0;
+    sal_Int32 nItemSize = 0;
+    sal_Int32 nTagSize = 0;
+    if ( pBlockFlags[ 0 ] & 0x01 )
+    {
+        //List index
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        sal_Int32 nOptional32 = 0; //
+        *pS >> nOptional32;
+    }
+    if (pBlockFlags[0] & 0x02)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        *pS >> mnBackColor;
+    }
+    if (pBlockFlags[0] & 0x04)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        *pS >> mnForeColor;
+    }
+    if (pBlockFlags[0] & 0x10)
+         bSize = true;
+    if (pBlockFlags[0] & 0x20)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        *pS >> nItemSize;
+    }
+    if (pBlockFlags[0] & 0x40)
     {
-        OCX_Control::Read(pS); // read trailing records
+        sal_Int8 nOptional8 = 0; // mouse pointer
+        *pS >> nOptional8;
+    }
+    if (pBlockFlags[1] & 0x01)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        sal_Int32 nOptional32 = 0; // taborientation
+        *pS >> nOptional32;
+    }
+    if (pBlockFlags[1] & 0x02)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        sal_Int32 nOptional32 = 0; // tabstyle
+        *pS >> nOptional32;
+        if ( nOptional32 == 2 )
+            bHasTabs =false;
+    }
+    if (pBlockFlags[1] & 0x04)
+        bMultiRow = true;
+    if (pBlockFlags[1] & 0x08)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        sal_Int32 nOptional32 = 0; // tabfixedwidth
+        *pS >> nOptional32;
+    }
+    if (pBlockFlags[1] & 0x10)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        sal_Int32 nOptional32 = 0; // tabfixedheight
+        *pS >> nOptional32;
+    }
+    if (pBlockFlags[1] & 0x20)
+        bTooltips = false;
+
+    if (pBlockFlags[1] & 0x80)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        *pS >> tipStringSize;
+    }
+
+    if (pBlockFlags[2] & 0x02)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        *pS >> nameSize;
+    }
+
+    if (pBlockFlags[2] & 0x04)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        sal_Int32 nOptional32 = 0; // variouspropertybits
+        *pS >> nOptional32;
+    }
+
+    if (pBlockFlags[2] & 0x10)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        sal_Int32 nOptional32 = 0; // tabsallocated
+        *pS >> nOptional32;
+    }
+
+    if (pBlockFlags[2] & 0x20)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        *pS >> nTagSize;
+    }
+
+    if (pBlockFlags[2] & 0x40)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        *pS >> nNumTabs;
+    }
+
+    if (pBlockFlags[2] & 0x80)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        *pS >> nAcceleratorSize;
+    }
+
+    if (pBlockFlags[3] & 0x01)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 2);
+        sal_Int16 nOptional16 = 0; //  Mouse Icon
+        *pS >> nOptional16;
+        hasEmbeddedImage = true;
+    }
+
+    // Extra block
+    if ( bSize )
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        *pS >> nWidth;
+        *pS >> nHeight;
+    }
+    if ( nItemSize )
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        // read the caption for each tab
+        readArrayString( pS, msItems, nItemSize, nStart );
+        std::vector< rtl::OUString >::iterator it = msItems.begin();
+        std::vector< rtl::OUString >::iterator it_end = msItems.end();
+        for ( sal_Int32 i=0; it != it_end; ++i, ++it )
+            OSL_TRACE(" Caption [ %d ] is %s", i, rtl::OUStringToOString( *it, RTL_TEXTENCODING_UTF8 ).getStr() );
+    }
+
+    if ( tipStringSize )
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        // read the tip for each tab
+        std::vector< rtl::OUString > sTips;
+        readArrayString( pS, sTips, tipStringSize, nStart );
+        std::vector< rtl::OUString >::iterator it = sTips.begin();
+        std::vector< rtl::OUString >::iterator it_end = sTips.end();
+        for ( sal_Int32 i=0; it != it_end; ++i, ++it )
+            OSL_TRACE(" Tip [ %d ] is %s", i, rtl::OUStringToOString( *it, RTL_TEXTENCODING_UTF8 ).getStr() );
+    }
+
+    if ( nameSize )
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        // read the name for each tab
+        std::vector< rtl::OUString > sNames;
+        readArrayString( pS, sNames, nameSize, nStart );
+        std::vector< rtl::OUString >::iterator it = sNames.begin();
+        std::vector< rtl::OUString >::iterator it_end = sNames.end();
+        for ( sal_Int32 i=0; it != it_end; ++i, ++it )
+            OSL_TRACE(" Name [ %d ] is %s", i, rtl::OUStringToOString( *it, RTL_TEXTENCODING_UTF8 ).getStr() );
+    }
+
+    if ( nTagSize )
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        // read the name for each tab
+        std::vector< rtl::OUString > sTags;
+        readArrayString( pS, sTags, nTagSize, nStart );
+        std::vector< rtl::OUString >::iterator it = sTags.begin();
+        std::vector< rtl::OUString >::iterator it_end = sTags.end();
+        for ( sal_Int32 i=0; it != it_end; ++i, ++it )
+            OSL_TRACE(" Tag [ %d ] is %s", i, rtl::OUStringToOString( *it, RTL_TEXTENCODING_UTF8 ).getStr() );
+    }
+
+    if ( nAcceleratorSize )
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        // read the name for each tab
+        std::vector< rtl::OUString > sAccelerators;
+        readArrayString( pS, sAccelerators, nAcceleratorSize, nStart );
+        std::vector< rtl::OUString >::iterator it = sAccelerators.begin();
+        std::vector< rtl::OUString >::iterator it_end = sAccelerators.end();
+        for ( sal_Int32 i=0; it != it_end; ++i, ++it )
+            OSL_TRACE(" Accelerator [ %d ] is %s", i, rtl::OUStringToOString( *it, RTL_TEXTENCODING_UTF8 ).getStr() );
+    }
+
+    // Stream data
+    if ( hasEmbeddedImage )
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        sal_uInt8 pPictureHeader[20];
+        sal_uInt32 nPictureLen(0);
+        pS->Read(pPictureHeader,20);
+        *pS >> nPictureLen;
+        long imagePos = pS->Tell();
+        // great embedded object
+        mxGrfObj = lcl_readGraphicObject( pS );
+        if( mxGrfObj.is() )
+        {
+            sImageUrl = rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( GRAPHOBJ_URLPREFIX ) );
+            sImageUrl = sImageUrl + mxGrfObj->getUniqueID();
+        }
+        // make sure the stream position should be pointing after the image.
+        pS->Seek( imagePos + nPictureLen );
+    }
+
+    ReadAlign(pS, pS->Tell() - nStart, 4);
+    OCX_Control::ReadFontData(pS); // read textprops
+    ReadAlign(pS, pS->Tell() - nStart, 4);
+    for ( sal_Int32 i = 0; i < nNumTabs; ++i )
+    {
+        sal_uInt32 TabStripTabFlags(0);
+        *pS >> TabStripTabFlags;
     }
     return sal_True;
 }
 
+sal_Bool OCX_TabStrip::ReadFontData(SotStorageStream* /* pS */)
+{
+    // OCX_TabStrip::Read includes the text props
+    return true;
+}
+
 sal_Bool OCX_Image::Read(SotStorageStream *pS)
 {
     ULONG nStart = pS->Tell();
@@ -5450,12 +5150,10 @@ sal_Bool OCX_Image::Read(SotStorageStream *pS)
 
     if ( hasEmbeddedImage )
     {
-        //image follows this block
-        //len of image is 0x14 relative to end of this block
-        pS->Seek( pS->Tell() + 0x14 );
-
-        sal_uInt32 nImageLen = 0;
-        *pS >> nImageLen;
+        sal_uInt8 pPictureHeader[20];
+        sal_uInt32 nPictureLen(0);
+        pS->Read(pPictureHeader,20);
+        *pS >> nPictureLen;
 
         long imagePos = pS->Tell();
 
@@ -5466,7 +5164,7 @@ sal_Bool OCX_Image::Read(SotStorageStream *pS)
             sImageUrl = sImageUrl + mxGrfObj->getUniqueID();
         }
         // make sure the stream position should be pointing after the image
-        pS->Seek( imagePos + nImageLen );
+        pS->Seek( imagePos + nPictureLen );
     }
     return sal_True;
 }
@@ -6144,5 +5842,381 @@ sal_Bool OCX_ProgressBar::Import(uno::Reference< beans::XPropertySet > &rPropSet
     return sal_True;
 }
 // ============================================================================
+OCX_ParentControl::OCX_ParentControl( SotStorageRef& parent, const OUString& storageName, const OUString& sN, const ::uno::Reference< container::XNameContainer >  &rParent, OCX_Control* pParent ) : OCX_Control(sN, pParent), mxParent(rParent), nNextAvailableID(0), nBooleanProperties(0), nGroupCnt(0), nZoom(0), fEnabled(1), fLocked(0), fBackStyle(1), fWordWrap(1), fAutoSize(0), nCaptionLen(0), nVertPos(1), nHorzPos(7), nBorderColor(0x80000012), nShapeCookie(0), nKeepScrollBarsVisible(3), nCycle(0), nBorderStyle(0), nMousePointer(0), nSpecialEffect(0), nPicture(0), nPictureAlignment(2), nPictureSizeMode(0), bPictureTiling(FALSE), nAccelerator(0), nIcon(0), pCaption(0), nScrollWidth(0), nScrollHeight(0), nScrollLeft(0), nScrollTop(0), nIconLen(0), pIcon(0), nPictureLen(0)
+{
+    mnForeColor = 0x80000012;
+    mnBackColor = 0x8000000F;
+    aFontData.SetHasAlign(TRUE);
+    mContainerStorage = parent->OpenSotStorage(storageName,
+        STREAM_READWRITE |
+        STREAM_NOCREATE |
+        STREAM_SHARE_DENYALL);
+    mContainerStream = mContainerStorage->OpenSotStream(
+        String(RTL_CONSTASCII_STRINGPARAM("f"),
+        RTL_TEXTENCODING_MS_1252),
+        STREAM_STD_READ | STREAM_NOCREATE);
+    mContainedControlsStream = mContainerStorage->OpenSotStream( String(RTL_CONSTASCII_STRINGPARAM("o"),
+        RTL_TEXTENCODING_MS_1252),
+        STREAM_STD_READ | STREAM_NOCREATE);
+}
+
+OCX_ParentControl::~OCX_ParentControl()
+{
+    CtrlIterator aEnd = mpControls.end();
+    for (CtrlIterator aIter = mpControls.begin(); aIter != aEnd; ++ aIter )
+    {
+        delete *aIter;
+    }
+}
+
+sal_Bool OCX_ParentControl::Import(uno::Reference<beans::XPropertySet>&  rProps  )
+{
+    // #FIXME we probably don't need this (fake) parent (mxParen) which is the dialog iirc
+    if ( !mxParent.is() )
+    {
+        return sal_False;
+    }
+    CtrlIterator aEnd = mpControls.end();
+//    int count = 0;
+    for (CtrlIterator aIter = mpControls.begin(); aIter != aEnd; ++ aIter )
+    {
+        uno::Reference< container::XNameContainer > xNameContainer( rProps, uno::UNO_QUERY );
+        if ( !(*aIter)->Import( xNameContainer ) )
+        {
+            return sal_False;
+        }
+    }
+    return sal_True;
+}
+
+bool OCX_ParentControl::createFromContainerRecord( const ContainerRecord& record, OCX_Control*& pControl )
+{
+    pControl = NULL;
+    switch ( record.nTypeIdent)
+        {
+            case CMDBUTTON:
+                pControl = new OCX_CommandButton;
+                break;
+            case LABEL:
+                pControl = new OCX_UserFormLabel(this);
+                break;
+            case TEXTBOX:
+                pControl = new OCX_TextBox;
+                break;
+            case LISTBOX:
+                pControl = new OCX_ListBox;
+                break;
+            case COMBOBOX:
+                pControl = new OCX_ComboBox;
+                break;
+            case CHECKBOX:
+                pControl =  new OCX_CheckBox;
+                break;
+            case OPTIONBUTTON:
+                pControl = new OCX_OptionButton;
+                break;
+            case TOGGLEBUTTON:
+                pControl = new OCX_ToggleButton;
+                break;
+            case IMAGE: //Image
+            {
+                pControl = new OCX_Image;
+                break;
+            }
+            case PAGE: // Page
+            {
+                pControl = new OCX_Page(mContainerStorage, record.nSubStorageId,
+                    record.cName, mxParent, this);
+                break;
+            }
+            case MULTIPAGE: // MultiPage
+            {
+                OUString sMSStore = createSubStreamName( record.nSubStorageId );
+                pControl = new OCX_MultiPage( mContainerStorage, sMSStore,
+                    record.cName, mxParent, this);
+                break;
+            }
+            case FRAME:  //Frame
+            {
+                OUString sFrameStore = createSubStreamName( record.nSubStorageId );
+                pControl = new OCX_Frame(mContainerStorage, sFrameStore,
+                    record.cName, mxParent, this);
 
+                break;
+            }
+            case SPINBUTTON: //SpinButton
+            {
+                pControl = new OCX_SpinButton;
+                break;
+            }
+            case TABSTRIP: //TabStrip
+            {
+                pControl = new OCX_TabStrip;
+                break;
+            }
+            case SCROLLBAR: //ScrollBar
+                pControl = new OCX_ScrollBar;
+                break;
+            case PROGRESSBAR: //ProgressBar Active X control
+                pControl = new OCX_ProgressBar;
+                break;
+            default:
+                OSL_TRACE( "**** Unknown control 0x%x", record.nTypeIdent );
+                DBG_ERROR( "Unknown control");
+                return false;
+        }
+        pControl->sName = record.cName;
+
+        pControl->msToolTip = record.controlTip;
+        pControl->mnTop = record.nTop;
+        pControl->mnLeft = record.nLeft;
+        // MS tabIndex, pretty useless in OpenOffice land
+        // as tab indexes in MS are relative to parent container.
+        // However we need this value in order to set
+        // OpenOffice tab indices in a sensible way to
+        // reflect the ms tabbing from orig MS UserForm, see below
+        pControl->mnTabPos = record.nTabPos;
+        pControl->SetInDialog(true);
+        pControl->mbVisible = record.bVisible;
+
+        return true;
+}
+
+void OCX_ParentControl::ProcessControl(OCX_Control* pControl,SvStorageStream* /* pS */,  ContainerRecord& rec )
+{
+    SotStorageStreamRef oStream = mContainedControlsStream;
+
+    // can insert into OO Dialog (e.g is this a supported dialog control)??
+    if ( rec.nTypeIdent == TABSTRIP )
+    {
+        // skip the record in the stream, discard the control
+        oStream->SeekRel( rec.nSubStreamLen );
+        delete pControl;
+    }
+    else
+    {
+        // A container control needs to read the f stream in
+        // the folder ( substorage ) associated with this control
+        if (  rec.nTypeIdent ==  FRAME ||
+            rec.nTypeIdent ==  MULTIPAGE||
+            rec.nTypeIdent ==  PAGE )
+        {
+            OCX_ParentControl* pContainer =
+               static_cast< OCX_ParentControl* >( pControl );
+            oStream = pContainer->getContainerStream();
+        }
+        // #117490# DR: container records provide size of substream, use it here...
+
+        // remember initial position to set correct stream position
+        ULONG nStrmPos = oStream->Tell();
+        // import control, may return with invalid stream position
+        pControl->FullRead(oStream);
+        // set stream to position behind substream of this control
+        oStream->Seek( nStrmPos + rec.nSubStreamLen );
+
+        mpControls.push_back( pControl );
+    }
+}
+
+sal_Bool OCX_ParentControl::Read(SvStorageStream *pS)
+{
+    long nStart = pS->Tell();
+
+    *pS >> nIdentifier;
+    DBG_ASSERT(0x400==nIdentifier,
+        "A control that has a different identifier");
+    *pS >> nFixedAreaLen;
+    pS->Read(pBlockFlags,4);
+
+    bool bExtraSize = false;
+    bool bLogicalSize = false;
+    bool bScrollPosition = false;
+    bool bFont = false;
+    if (pBlockFlags[0] & 0x01)
+    {
+        DBG_ASSERT(!this, "ARSE");
+    }
+    if (pBlockFlags[0] & 0x02)
+        *pS >> mnBackColor;
+    if (pBlockFlags[0] & 0x04)
+        *pS >> mnForeColor;
+    if (pBlockFlags[0] & 0x08)
+        *pS >> nNextAvailableID;
+    if (pBlockFlags[0] & 0x40)
+        *pS >> nBooleanProperties;
+    ReadAlign(pS, pS->Tell() - nStart, 4);
+    if (pBlockFlags[0] & 0x80)
+    {
+        *pS >> nBorderStyle;
+    }
+    if (pBlockFlags[1] & 0x01)
+        *pS >> nMousePointer;
+    if (pBlockFlags[1] & 0x02)
+        *pS >> nKeepScrollBarsVisible;
+    if (pBlockFlags[1] & 0x04)
+        bExtraSize = true;
+    if (pBlockFlags[1] & 0x08)
+        bLogicalSize = true;
+    if (pBlockFlags[1] & 0x10)
+        bScrollPosition = true;
+    if (pBlockFlags[1] & 0x20)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        *pS >> nGroupCnt;
+    }
+
+    if (pBlockFlags[1] & 0x80)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 2);
+        *pS >> nIcon;
+        DBG_ASSERT(nIcon == 0xFFFF, "Unexpected nIcon");
+    }
+    if (pBlockFlags[2] & 0x01)
+        *pS >> nCycle;
+    if (pBlockFlags[2] & 0x02)
+        *pS >> nSpecialEffect;
+    if (pBlockFlags[2] & 0x04)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        *pS >> nBorderColor;
+    }
+    if (pBlockFlags[2] & 0x08)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        *pS >> nCaptionLen;
+    }
+
+    if (pBlockFlags[2] & 0x10)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 2);
+        sal_uInt16 nNoIdea;
+        *pS >> nNoIdea;
+        DBG_ASSERT(nNoIdea == 0xFFFF, "Expected 0xFFFF, (related to font ?)");
+        bFont = true;
+    }
+    if (pBlockFlags[2] & 0x20)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 2);
+        *pS >> nPicture;
+        DBG_ASSERT(nPicture == 0xFFFF, "Unexpected nIcon");
+    }
+
+    if (pBlockFlags[2] & 0x40)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        *pS >> nZoom;
+    }
+    if (pBlockFlags[2] & 0x80)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        *pS >> nPictureAlignment;
+    }
+
+    if (pBlockFlags[3] & 0x01)
+        bPictureTiling = true;
+
+    if (pBlockFlags[3] & 0x02)
+        *pS >> nPictureSizeMode;
+
+    if (pBlockFlags[3] & 0x04)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        *pS >> nShapeCookie;
+    }
+    if (pBlockFlags[3] & 0x08)
+    {
+        ReadAlign(pS, pS->Tell() - nStart, 4);
+        *pS >> nDrawBuffer;
+    }
+
+    ReadAlign(pS, pS->Tell() - nStart, 4);
+    // Extra
+    if ( bExtraSize )
+    {
+        *pS >> nWidth;
+        *pS >> nHeight;
+    }
+    if ( bLogicalSize )
+    {
+        *pS >> nScrollWidth;
+        *pS >> nScrollHeight;
+    }
+    if ( bScrollPosition )
+    {
+        *pS >> nScrollLeft;
+        *pS >> nScrollTop;
+    }
+    if  ( nCaptionLen )
+    {
+        sal_uInt32 nCaptionSize = lclGetBufferSize( nCaptionLen );
+        if ( nCaptionSize )
+        {
+            pCaption = new sal_Char[ nCaptionSize ];
+            pS->Read( pCaption, nCaptionSize );
+        }
+    }
+
+    ReadAlign(pS, pS->Tell() - nStart, 4);
+
+    // StreamData
+    if (nIcon)
+    {
+        pS->Read(pIconHeader,20);
+        *pS >> nIconLen;
+        pIcon = new sal_uInt8[nIconLen];
+        pS->Read(pIcon,nIconLen);
+    }
+    if ( bFont )
+    {
+        //Font Stuff..
+        pS->SeekRel(0x1a);
+        sal_uInt8 nFontLen;
+        *pS >> nFontLen;
+        pS->SeekRel(nFontLen);
+    }
+    if (nPicture)
+    {
+        pS->Read(pPictureHeader,20);
+        *pS >> nPictureLen;
+        long imagePos = pS->Tell();
+        // great embedded object
+        mxGrfObj = lcl_readGraphicObject( pS );
+        if( mxGrfObj.is() )
+        {
+            sImageUrl = rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( GRAPHOBJ_URLPREFIX ) );
+            sImageUrl = sImageUrl + mxGrfObj->getUniqueID();
+        }
+        // make sure the stream position should be pointing after the image.
+        pS->Seek( imagePos + nPictureLen );
+    }
+    // FormSiteData
+    std::vector< ClassTable > siteClassInfo;
+    if ( ( nBooleanProperties & 0x00008000 ) == 0x0)
+    {
+        sal_Int16 numTrailingRecs = 0;
+        *pS >> numTrailingRecs;
+        if ( numTrailingRecs )
+        {
+            for ( ; numTrailingRecs ; --numTrailingRecs )
+            {
+                ClassTable cacheClass;
+                cacheClass.Read( pS );
+                siteClassInfo.push_back( cacheClass );
+            }
+        }
+    }
+    // Sites
+    ContainerRecReader reader;
+    reader.Read( this, pS, siteClassInfo );
+
+    // Need to honour the MS Tab Indexes. However MS tab indexes are
+    // relative to parent, this hack sorts the controls in each container
+    // based on the ms tab indexes. When import is called we create the
+    // controls in Open/Star office based on the order of the tab indexes,
+    // this ensures that the default tab index created by Star/Open office
+    // reflects the "flattened" ms tab order.
+// #FIXME we probably need to remove this
+    ::std::sort( mpControls.begin(), mpControls.end(), SortOrderByTabPos() );
+    return true;
+}
 /* vi:set tabstop=4 shiftwidth=4 expandtab: */
diff --git a/toolkit/inc/toolkit/awt/vclxwindows.hxx b/toolkit/inc/toolkit/awt/vclxwindows.hxx
index 6685b88..a39bdb2 100644
--- a/toolkit/inc/toolkit/awt/vclxwindows.hxx
+++ b/toolkit/inc/toolkit/awt/vclxwindows.hxx
@@ -82,6 +82,7 @@
 #include <com/sun/star/awt/XComboBox.hpp>
 #include <com/sun/star/awt/XCheckBox.hpp>
 #include <com/sun/star/awt/XImageConsumer.hpp>
+#include <com/sun/star/awt/XSimpleTabController.hpp>
 #include <cppuhelper/weak.hxx>
 #include <cppuhelper/implbase2.hxx>
 
@@ -92,6 +93,7 @@
 #include <vcl/pointr.hxx>
 #include <vcl/imgcons.hxx>
 #include <vcl/image.hxx>
+#include <vcl/tabctrl.hxx>
 
 #include <com/sun/star/document/XVbaMethodParameter.hpp>  //liuchen 2009-6-22, add the support of input/output parameters to VBA Dialog_QueryClose event
 class Button;
@@ -383,6 +385,40 @@ public:
     virtual void    GetPropertyIds( std::list< sal_uInt16 > &aIds ) { return ImplGetPropertyIds( aIds ); }
 };
 
+//	----------------------------------------------------
+//	class VCLXFrame
+//	----------------------------------------------------
+class VCLXFrame :	public VCLXContainer
+{
+protected:
+    void                        ProcessWindowEvent( const VclWindowEvent& rVclWindowEvent );
+
+public:
+                        VCLXFrame();
+                        ~VCLXFrame();
+
+    // ::com::sun::star::uno::XInterface
+    ::com::sun::star::uno::Any					SAL_CALL queryInterface( const ::com::sun::star::uno::Type & rType ) throw(::com::sun::star::uno::RuntimeException);
+    void										SAL_CALL acquire() throw()	{ OWeakObject::acquire(); }
+    void										SAL_CALL release() throw()	{ OWeakObject::release(); }
+
+    // ::com::sun::star::lang::XTypeProvider
+    ::com::sun::star::uno::Sequence< ::com::sun::star::uno::Type >	SAL_CALL getTypes() throw(::com::sun::star::uno::RuntimeException);
+    ::com::sun::star::uno::Sequence< sal_Int8 >						SAL_CALL getImplementationId() throw(::com::sun::star::uno::RuntimeException);
+
+    // ::com::sun::star::awt::XView
+    void SAL_CALL draw( sal_Int32 nX, sal_Int32 nY ) throw(::com::sun::star::uno::RuntimeException);
+
+    // ::com::sun::star::awt::XDevice,
+    ::com::sun::star::awt::DeviceInfo SAL_CALL getInfo() throw(::com::sun::star::uno::RuntimeException);
+
+    // ::com::sun::star::awt::XVclWindowPeer
+    void SAL_CALL setProperty( const ::rtl::OUString& PropertyName, const ::com::sun::star::uno::Any& Value ) throw(::com::sun::star::uno::RuntimeException);
+
+    static void     ImplGetPropertyIds( std::list< sal_uInt16 > &aIds );
+    virtual void    GetPropertyIds( std::list< sal_uInt16 > &aIds ) { return ImplGetPropertyIds( aIds ); }
+};
+
 
 
 //	----------------------------------------------------
@@ -456,6 +492,59 @@ public:
     // ::com::sun::star::awt::XVclWindowPeer
     void SAL_CALL setProperty( const ::rtl::OUString& PropertyName, const ::com::sun::star::uno::Any& Value ) throw(::com::sun::star::uno::RuntimeException);
 
+    TabPage*  getTabPage() const throw ( ::com::sun::star::uno::RuntimeException);
+    static void     ImplGetPropertyIds( std::list< sal_uInt16 > &aIds );
+    virtual void    GetPropertyIds( std::list< sal_uInt16 > &aIds ) { return ImplGetPropertyIds( aIds ); }
+};
+
+class VCLXMultiPage : public ::com::sun::star::awt::XSimpleTabController, public VCLXContainer
+{
+    TabListenerMultiplexer maTabListeners;
+    sal_Int32 mTabId;
+protected:
+    void ProcessWindowEvent( const VclWindowEvent& rVclWindowEvent );
+public:
+    VCLXMultiPage();
+    ~VCLXMultiPage();
+
+    // ::com::sun::star::uno::XInterface
+    ::com::sun::star::uno::Any SAL_CALL queryInterface( const ::com::sun::star::uno::Type & rType ) throw(::com::sun::star::uno::RuntimeException);
+    void SAL_CALL acquire() throw()	{ OWeakObject::acquire(); }
+    void SAL_CALL release() throw()	{ OWeakObject::release(); }
+
+    // ::com::sun::star::lang::XTypeProvider
+    ::com::sun::star::uno::Sequence< ::com::sun::star::uno::Type > SAL_CALL getTypes() throw(::com::sun::star::uno::RuntimeException);
+    ::com::sun::star::uno::Sequence< sal_Int8 > SAL_CALL getImplementationId() throw(::com::sun::star::uno::RuntimeException);
+
+    // ::com::sun::star::lang::XComponent
+    void SAL_CALL dispose(  ) throw(::com::sun::star::uno::RuntimeException);
+
+    // ::com::sun::star::awt::XView
+    void SAL_CALL draw( sal_Int32 nX, sal_Int32 nY ) throw(::com::sun::star::uno::RuntimeException);
+
+    // ::com::sun::star::awt::XDevice,
+    ::com::sun::star::awt::DeviceInfo SAL_CALL getInfo() throw(::com::sun::star::uno::RuntimeException);
+
+    // ::com::sun::star::awt::XVclWindowPeer
+    void SAL_CALL setProperty( const ::rtl::OUString& PropertyName, const ::com::sun::star::uno::Any& Value ) throw(::com::sun::star::uno::RuntimeException);
+    ::com::sun::star::uno::Any SAL_CALL getProperty( const ::rtl::OUString& PropertyName ) throw(::com::sun::star::uno::RuntimeException);
+    // XSimpleTabController
+    virtual ::sal_Int32 SAL_CALL insertTab() throw (::com::sun::star::uno::RuntimeException);
+    virtual void SAL_CALL removeTab( ::sal_Int32 ID ) throw (::com::sun::star::lang::IndexOutOfBoundsException, ::com::sun::star::uno::RuntimeException);
+
+    virtual void SAL_CALL setTabProps( ::sal_Int32 ID, const ::com::sun::star::uno::Sequence< ::com::sun::star::beans::NamedValue >& Properties ) throw (::com::sun::star::lang::IndexOutOfBoundsException, ::com::sun::star::uno::RuntimeException);
+    virtual ::com::sun::star::uno::Sequence< ::com::sun::star::beans::NamedValue > SAL_CALL getTabProps( ::sal_Int32 ID ) throw (::com::sun::star::lang::IndexOutOfBoundsException, ::com::sun::star::uno::RuntimeException);
+
+    virtual void SAL_CALL activateTab( ::sal_Int32 ID ) throw (::com::sun::star::lang::IndexOutOfBoundsException, ::com::sun::star::uno::RuntimeException);
+    virtual ::sal_Int32 SAL_CALL getActiveTabID() throw (::com::sun::star::uno::RuntimeException);
+
+    virtual void SAL_CALL addTabListener( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XTabListener >& Listener ) throw (::com::sun::star::uno::RuntimeException);
+    virtual void SAL_CALL removeTabListener( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XTabListener >& Listener ) throw (::com::sun::star::uno::RuntimeException);
+    // C++
+    TabControl*  getTabControl() const throw ( ::com::sun::star::uno::RuntimeException);
+    USHORT insertTab( TabPage*, rtl::OUString& sTitle );
+    static void     ImplGetPropertyIds( std::list< sal_uInt16 > &aIds );
+    virtual void    GetPropertyIds( std::list< sal_uInt16 > &aIds ) { return ImplGetPropertyIds( aIds ); }
 };
 
 //  ----------------------------------------------------
diff --git a/toolkit/inc/toolkit/controls/dialogcontrol.hxx b/toolkit/inc/toolkit/controls/dialogcontrol.hxx
index 93b9464..7ead237 100644
--- a/toolkit/inc/toolkit/controls/dialogcontrol.hxx
+++ b/toolkit/inc/toolkit/controls/dialogcontrol.hxx
@@ -34,12 +34,16 @@
 #include <com/sun/star/awt/XTopWindow.hpp>
 #include <com/sun/star/util/XChangesNotifier.hpp>
 #include <com/sun/star/util/XChangesListener.hpp>
+#include <com/sun/star/awt/XTabListener.hpp>
+#include <com/sun/star/awt/XSimpleTabController.hpp>
 #include <com/sun/star/util/XModifyListener.hpp>
 #include <com/sun/star/beans/XPropertyChangeListener.hpp>
 #include <com/sun/star/awt/XDialog.hpp>
 #include <com/sun/star/resource/XStringResourceResolver.hpp>
+#include <com/sun/star/graphic/XGraphicObject.hpp>
 #include <cppuhelper/implbase6.hxx>
 #include <cppuhelper/implbase5.hxx>
+#include <cppuhelper/implbase2.hxx>
 #include <toolkit/helper/listenermultiplexer.hxx>
 #include <toolkit/controls/unocontrolmodel.hxx>
 #include "toolkit/helper/servicenames.hxx"
@@ -67,11 +71,12 @@ class UnoControlDialogModel :	public UnoControlDialogModel_IBase
                             ,	public UnoControlDialogModel_Base
 {
 public:
+    enum ChildOperation { Insert = 0, Remove };
     // would like to make this typedef private, too, but the Forte 7 compiler does have
     // problems with this .....
     typedef ::std::pair< ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControlModel >, ::rtl::OUString >
                                                         UnoControlModelHolder;
-private:
+protected:
     typedef ::std::list< UnoControlModelHolder >		UnoControlModelHolderList;
 
     // for grouping control models (XTabControllerModel::getGroupXXX)
@@ -83,7 +88,7 @@ private:
     friend struct FindControlModel;
     friend struct CompareControlModel;
 
-private:
+protected:
     ContainerListenerMultiplexer		maContainerListeners;
     ::cppu::OInterfaceContainerHelper	maChangeListeners;
     UnoControlModelHolderList			maModels;
@@ -94,13 +99,14 @@ private:
     ::com::sun::star::uno::Reference< ::com::sun::star::graphic::XGraphicObject > mxGrfObj;
     bool mbAdjustingGraphic;
 protected:	
-    ::com::sun::star::uno::Any			ImplGetDefaultValue( sal_uInt16 nPropId ) const;
+    virtual ::com::sun::star::uno::Any			ImplGetDefaultValue( sal_uInt16 nPropId ) const;
     ::cppu::IPropertyArrayHelper&		SAL_CALL getInfoHelper();
 
     UnoControlModelHolderList::iterator			ImplFindElement( const ::rtl::OUString& rName );
+    void updateUserFormChildren(  const ::com::sun::star::uno::Reference< ::com::sun::star::container::XNameContainer >& xAllChildren, const rtl::OUString& aName, ChildOperation Operation,  const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControlModel >& xTarget ) throw(::com::sun::star::lang::IllegalArgumentException, ::com::sun::star::container::ElementExistException, ::com::sun::star::lang::WrappedTargetException, ::com::sun::star::uno::RuntimeException) ;
 
 public:
-                        UnoControlDialogModel();
+                        UnoControlDialogModel( bool bRegProps = true );
                         UnoControlDialogModel( const UnoControlDialogModel& rModel );
                         ~UnoControlDialogModel();
                         
@@ -123,13 +129,6 @@ public:
     ::com::sun::star::uno::Type SAL_CALL getElementType(  ) throw(::com::sun::star::uno::RuntimeException);
     sal_Bool SAL_CALL hasElements(  ) throw(::com::sun::star::uno::RuntimeException);
     
-    // ::com::sun::star::container::XIndexContainer, XIndexReplace, XIndexAcces
-    // void SAL_CALL replaceByIndex( sal_Int32 Index, const ::com::sun::star::uno::Any& Element ) throw(::com::sun::star::lang::IllegalArgumentException, ::com::sun::star::lang::IndexOutOfBoundsException, ::com::sun::star::lang::WrappedTargetException, ::com::sun::star::uno::RuntimeException) = 0;
-    // sal_Int32 SAL_CALL getCount(  ) throw(::com::sun::star::uno::RuntimeException) = 0;
-    // ::com::sun::star::uno::Any SAL_CALL getByIndex( sal_Int32 Index ) throw(::com::sun::star::lang::IndexOutOfBoundsException, ::com::sun::star::lang::WrappedTargetException, ::com::sun::star::uno::RuntimeException) = 0;
-    // void SAL_CALL insertByIndex( sal_Int32 Index, const ::com::sun::star::uno::Any& Element ) throw(::com::sun::star::lang::IllegalArgumentException, ::com::sun::star::lang::IndexOutOfBoundsException, ::com::sun::star::lang::WrappedTargetException, ::com::sun::star::uno::RuntimeException) = 0;
-    // void SAL_CALL removeByIndex( sal_Int32 Index ) throw(::com::sun::star::lang::IndexOutOfBoundsException, ::com::sun::star::lang::WrappedTargetException, ::com::sun::star::uno::RuntimeException) = 0;
-    
     // ::com::sun::star::container::XNameContainer, XNameReplace, XNameAccess
     void SAL_CALL replaceByName( const ::rtl::OUString& aName, const ::com::sun::star::uno::Any& aElement ) throw(::com::sun::star::lang::IllegalArgumentException, ::com::sun::star::container::NoSuchElementException, ::com::sun::star::lang::WrappedTargetException, ::com::sun::star::uno::RuntimeException);
     ::com::sun::star::uno::Any SAL_CALL getByName( const ::rtl::OUString& aName ) throw(::com::sun::star::container::NoSuchElementException, ::com::sun::star::lang::WrappedTargetException, ::com::sun::star::uno::RuntimeException);
@@ -144,7 +143,7 @@ public:
     // ::com::sun::star::lang::XMultiServiceFactory
     ::com::sun::star::uno::Reference< ::com::sun::star::uno::XInterface > SAL_CALL createInstance( const ::rtl::OUString& aServiceSpecifier ) throw(::com::sun::star::uno::Exception, ::com::sun::star::uno::RuntimeException);
     ::com::sun::star::uno::Reference< ::com::sun::star::uno::XInterface > SAL_CALL createInstanceWithArguments( const ::rtl::OUString& ServiceSpecifier, const ::com::sun::star::uno::Sequence< ::com::sun::star::uno::Any >& Arguments ) throw(::com::sun::star::uno::Exception, ::com::sun::star::uno::RuntimeException);
-    ::com::sun::star::uno::Sequence< ::rtl::OUString > SAL_CALL getAvailableServiceNames(  ) throw(::com::sun::star::uno::RuntimeException);
+    ::com::sun::star::uno::Sequence< ::rtl::OUString > SAL_CALL getAvailableServiceNames(  ) throw(::com::sun::star::uno::RuntimeException);;
     
     // ::com::sun::star::io::XPersistObject
     ::rtl::OUString SAL_CALL getServiceName() throw(::com::sun::star::uno::RuntimeException);
@@ -179,12 +178,12 @@ public:
 protected:
     void startControlListening( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControlModel >& _rxChildModel );
     void stopControlListening( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControlModel >& _rxChildModel );
-    // ::cppu::OPropertySetHelper
-    void SAL_CALL setFastPropertyValue_NoBroadcast( sal_Int32 nHandle, const ::com::sun::star::uno::Any& rValue ) throw (::com::sun::star::uno::Exception);
 
     void implNotifyTabModelChange( const ::rtl::OUString& _rAccessor );
 
     void implUpdateGroupStructure();
+    // ::cppu::OPropertySetHelper
+    void SAL_CALL setFastPropertyValue_NoBroadcast( sal_Int32 nHandle, const ::com::sun::star::uno::Any& rValue ) throw (::com::sun::star::uno::Exception);
 private:
     void AddRadioButtonToGroup (
             const ::com::sun::star::uno::Reference< XControlModel >& rControlModel,
@@ -195,16 +194,6 @@ private:
             ::std::map< ::rtl::OUString, ModelGroup >& pNamedGroups );
 };
 
-//	----------------------------------------------------
-//	class UnoDialogControl
-//	----------------------------------------------------
-typedef ::cppu::ImplHelper6	<	::com::sun::star::container::XContainerListener
-                            ,	::com::sun::star::awt::XTopWindow
-                            ,	::com::sun::star::awt::XDialog
-                            ,	::com::sun::star::util::XChangesListener
-                            ,   ::com::sun::star::util::XModifyListener
-                            ,   ::com::sun::star::awt::XWindowListener
-                            >	UnoDialogControl_IBase;
 
 class ResourceListener  :public ::com::sun::star::util::XModifyListener,
                          public ::cppu::OWeakObject,
@@ -234,29 +223,78 @@ class ResourceListener  :public ::com::sun::star::util::XModifyListener,
         bool                                                                                    m_bListening;
 };
 
-class UnoDialogControl	:public UnoControlContainer
-                        ,public UnoDialogControl_IBase
+typedef ::cppu::ImplHelper2	< ::com::sun::star::container::XContainerListener
+                            ,	::com::sun::star::util::XChangesListener
+                            >	UnoDialogContainerControl_IBase;
+
+class UnoDialogContainerControl : public UnoControlContainer, public UnoDialogContainerControl_IBase
+{
+protected:
+    ::com::sun::star::uno::Reference< ::com::sun::star::awt::XTabController >	mxTabController;
+    void		ImplInsertControl( ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControlModel >& rxModel, const ::rtl::OUString& rName );
+    void		ImplRemoveControl( ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControlModel >& rxModel );
+    virtual void		ImplSetPosSize( ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControl >& rxCtrl );
+
+public:
+    UnoDialogContainerControl();
+    ~UnoDialogContainerControl();
+
+    DECLIMPL_SERVICEINFO_DERIVED( UnoDialogContainerControl, UnoControlBase, "com.sun.star.awt.UnoDialogContainerControl" )
+    ::com::sun::star::uno::Any	SAL_CALL queryInterface( const ::com::sun::star::uno::Type & rType ) throw(::com::sun::star::uno::RuntimeException) { return UnoControlContainer::queryInterface(rType); }
+    ::com::sun::star::uno::Any	SAL_CALL queryAggregation( const ::com::sun::star::uno::Type & rType ) throw(::com::sun::star::uno::RuntimeException);
+    void SAL_CALL acquire() throw()	{ OWeakAggObject::acquire(); }
+    void SAL_CALL release() throw()	{ OWeakAggObject::release(); }
+
+    void SAL_CALL disposing( const ::com::sun::star::lang::EventObject& Source ) throw(::com::sun::star::uno::RuntimeException);
+    void SAL_CALL dispose() throw(::com::sun::star::uno::RuntimeException);
+
+    void SAL_CALL createPeer( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XToolkit >& Toolkit, const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XWindowPeer >& Parent ) throw(::com::sun::star::uno::RuntimeException);
+
+    // ::com::sun::star::container::XContainerListener
+    void SAL_CALL elementInserted( const ::com::sun::star::container::ContainerEvent& Event ) throw(::com::sun::star::uno::RuntimeException);
+    void SAL_CALL elementRemoved( const ::com::sun::star::container::ContainerEvent& Event ) throw(::com::sun::star::uno::RuntimeException);
+    void SAL_CALL elementReplaced( const ::com::sun::star::container::ContainerEvent& Event ) throw(::com::sun::star::uno::RuntimeException);
+
+    // ::com::sun::star::lang::XTypeProvider
+    ::com::sun::star::uno::Sequence< ::com::sun::star::uno::Type >	SAL_CALL getTypes() throw(::com::sun::star::uno::RuntimeException);
+    ::com::sun::star::uno::Sequence< sal_Int8 >						SAL_CALL getImplementationId() throw(::com::sun::star::uno::RuntimeException);
+
+    // XChangesListener
+    virtual void SAL_CALL changesOccurred( const ::com::sun::star::util::ChangesEvent& Event ) throw (::com::sun::star::uno::RuntimeException);
+
+    // ::com::sun::star::awt::XControl
+    sal_Bool SAL_CALL setModel( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControlModel >& Model ) throw(::com::sun::star::uno::RuntimeException);
+    void SAL_CALL setDesignMode( sal_Bool bOn ) throw(::com::sun::star::uno::RuntimeException);
+protected:
+    virtual void ImplModelPropertiesChanged( const ::com::sun::star::uno::Sequence< ::com::sun::star::beans::PropertyChangeEvent >& rEvents ) throw(::com::sun::star::uno::RuntimeException);
+    virtual void removingControl( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControl >& _rxControl );
+    virtual void addingControl( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControl >& _rxControl );
+};
+
+
+
+class UnoDialogControl :public UnoDialogContainerControl
+                        ,public ::com::sun::star::awt::XTopWindow, public ::com::sun::star::awt::XDialog , public ::com::sun::star::awt::XWindowListener
 {
 private:
     ::com::sun::star::uno::Reference< ::com::sun::star::awt::XMenuBar >			mxMenuBar;
-    ::com::sun::star::uno::Reference< ::com::sun::star::awt::XTabController >	mxTabController;
-    ::com::sun::star::uno::Reference< ::com::sun::star::util::XModifyListener > mxListener;                
     TopWindowListenerMultiplexer	                                            maTopWindowListeners;
     bool                                                                        mbWindowListener;
     bool                                                                        mbSizeModified;
     bool                                                                        mbPosModified;
+    ::com::sun::star::uno::Reference< ::com::sun::star::graphic::XGraphicObject > mxGrfObj;
+    ::com::sun::star::uno::Reference< ::com::sun::star::util::XModifyListener > mxListener;
 
 protected:
     
     void		ImplInsertControl( ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControlModel >& rxModel, const ::rtl::OUString& rName );
-    void		ImplRemoveControl( ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControlModel >& rxModel );
-    void		ImplSetPosSize( ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControl >& rxCtrl );
     void        ImplUpdateResourceResolver();
     void        ImplStartListingForResourceEvents();
 
 public:
 
                                 UnoDialogControl();
+                                ~UnoDialogControl();
     ::rtl::OUString				GetComponentServiceName();
 
     ::com::sun::star::uno::Any	SAL_CALL queryInterface( const ::com::sun::star::uno::Type & rType ) throw(::com::sun::star::uno::RuntimeException) { return UnoControlContainer::queryInterface(rType); }
@@ -281,11 +319,6 @@ public:
     virtual void SAL_CALL windowShown( const ::com::sun::star::lang::EventObject& e ) throw (::com::sun::star::uno::RuntimeException);
     virtual void SAL_CALL windowHidden( const ::com::sun::star::lang::EventObject& e ) throw (::com::sun::star::uno::RuntimeException);
     
-    // ::com::sun::star::container::XContainerListener
-    void SAL_CALL elementInserted( const ::com::sun::star::container::ContainerEvent& Event ) throw(::com::sun::star::uno::RuntimeException);
-    void SAL_CALL elementRemoved( const ::com::sun::star::container::ContainerEvent& Event ) throw(::com::sun::star::uno::RuntimeException);
-    void SAL_CALL elementReplaced( const ::com::sun::star::container::ContainerEvent& Event ) throw(::com::sun::star::uno::RuntimeException);
-    
     // ::com::sun::star::awt::XDialog
     void SAL_CALL setTitle( const ::rtl::OUString& Title ) throw(::com::sun::star::uno::RuntimeException);
     ::rtl::OUString SAL_CALL getTitle() throw(::com::sun::star::uno::RuntimeException);
@@ -298,10 +331,6 @@ public:
 
     // ::com::sun::star::awt::XControl
     sal_Bool SAL_CALL setModel( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControlModel >& Model ) throw(::com::sun::star::uno::RuntimeException);
-    void SAL_CALL setDesignMode( sal_Bool bOn ) throw(::com::sun::star::uno::RuntimeException);
-
-    // XChangesListener
-    virtual void SAL_CALL changesOccurred( const ::com::sun::star::util::ChangesEvent& Event ) throw (::com::sun::star::uno::RuntimeException);
 
     // XModifyListener
     virtual void SAL_CALL modified( const ::com::sun::star::lang::EventObject& aEvent ) throw (::com::sun::star::uno::RuntimeException);
@@ -312,11 +341,151 @@ public:
 protected:
     virtual void ImplModelPropertiesChanged( const ::com::sun::star::uno::Sequence< ::com::sun::star::beans::PropertyChangeEvent >& rEvents ) throw(::com::sun::star::uno::RuntimeException);
     virtual void PrepareWindowDescriptor( ::com::sun::star::awt::WindowDescriptor& rDesc );
+protected:
+};
+
+class UnoMultiPageModel : public UnoControlDialogModel
+{
+public:
+                        UnoMultiPageModel();
+                        ~UnoMultiPageModel();
+                        UnoMultiPageModel( const UnoMultiPageModel& rModel );
+
+    UnoControlModel*	Clone() const;
 
+    DECLIMPL_SERVICEINFO_DERIVED( UnoMultiPageModel, UnoControlDialogModel, szServiceName_UnoMultiPageModel )
+
+    virtual ::rtl::OUString SAL_CALL getServiceName() throw(::com::sun::star::uno::RuntimeException);
+    virtual ::com::sun::star::uno::Reference< ::com::sun::star::beans::XPropertySetInfo > SAL_CALL getPropertySetInfo(  ) throw( ::com::sun::star::uno::RuntimeException);
+    // XNamedContainer
+    void SAL_CALL insertByName( const ::rtl::OUString& aName, const ::com::sun::star::uno::Any& aElement ) throw(::com::sun::star::lang::IllegalArgumentException, ::com::sun::star::container::ElementExistException, ::com::sun::star::lang::WrappedTargetException, ::com::sun::star::uno::RuntimeException);
+
+    // Override the method of parent Class
+    virtual sal_Bool SAL_CALL getGroupControl(  ) throw (::com::sun::star::uno::RuntimeException);
 protected:
-    virtual void removingControl( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControl >& _rxControl );
-    virtual void addingControl( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControl >& _rxControl );
+    virtual ::com::sun::star::uno::Any			ImplGetDefaultValue( sal_uInt16 nPropId ) const;
+    ::cppu::IPropertyArrayHelper&		SAL_CALL getInfoHelper();
+
+};
+
+
+
+class UnoMultiPageControl :  public UnoDialogContainerControl
+                            ,public ::com::sun::star::awt::XSimpleTabController
+                            ,public ::com::sun::star::awt::XTabListener
+{
+    TabListenerMultiplexer maTabListeners;
+    void bindPage( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControl >& _rxControl );
+public:
+    UnoMultiPageControl();
+    ~UnoMultiPageControl();
+    ::rtl::OUString		GetComponentServiceName();
+
+    // ::com::sun::star::lang::XServiceInfo
+    DECLIMPL_SERVICEINFO_DERIVED( UnoMultiPageControl, UnoDialogContainerControl, szServiceName_UnoMultiPageControl )
+        ::com::sun::star::uno::Any	SAL_CALL queryInterface( const ::com::sun::star::uno::Type & rType ) throw(::com::sun::star::uno::RuntimeException) { return UnoDialogContainerControl::queryInterface(rType); }
+        ::com::sun::star::uno::Any	SAL_CALL queryAggregation( const ::com::sun::star::uno::Type & rType ) throw(::com::sun::star::uno::RuntimeException);
+    void						SAL_CALL acquire() throw()	{ OWeakAggObject::acquire(); }
+    void						SAL_CALL release() throw()	{ OWeakAggObject::release(); }
+    // ::com::sun::star::lang::XTypeProvider
+    ::com::sun::star::uno::Sequence< ::com::sun::star::uno::Type >	SAL_CALL getTypes() throw(::com::sun::star::uno::RuntimeException);
+    ::com::sun::star::uno::Sequence< sal_Int8 >						SAL_CALL getImplementationId() throw(::com::sun::star::uno::RuntimeException);
+    void SAL_CALL createPeer( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XToolkit >& Toolkit, const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XWindowPeer >& Parent ) throw(::com::sun::star::uno::RuntimeException);
+    // com::sun::star::awt::XSimpleTabController
+    virtual ::sal_Int32 SAL_CALL insertTab() throw (::com::sun::star::uno::RuntimeException);
+    virtual void SAL_CALL removeTab( ::sal_Int32 ID ) throw (::com::sun::star::lang::IndexOutOfBoundsException, ::com::sun::star::uno::RuntimeException);
+
+    virtual void SAL_CALL setTabProps( ::sal_Int32 ID, const ::com::sun::star::uno::Sequence< ::com::sun::star::beans::NamedValue >& Properties ) throw (::com::sun::star::lang::IndexOutOfBoundsException, ::com::sun::star::uno::RuntimeException);
+    virtual ::com::sun::star::uno::Sequence< ::com::sun::star::beans::NamedValue > SAL_CALL getTabProps( ::sal_Int32 ID ) throw (::com::sun::star::lang::IndexOutOfBoundsException, ::com::sun::star::uno::RuntimeException);
+
+    virtual void SAL_CALL activateTab( ::sal_Int32 ID ) throw (::com::sun::star::lang::IndexOutOfBoundsException, ::com::sun::star::uno::RuntimeException);
+    virtual ::sal_Int32 SAL_CALL getActiveTabID() throw (::com::sun::star::uno::RuntimeException);
+
+    virtual void SAL_CALL addTabListener( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XTabListener >& Listener ) throw (::com::sun::star::uno::RuntimeException);
+    virtual void SAL_CALL removeTabListener( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XTabListener >& Listener ) throw (::com::sun::star::uno::RuntimeException);
+    // XTabListener
+    virtual void SAL_CALL inserted( ::sal_Int32 ID ) throw (::com::sun::star::uno::RuntimeException);
+    virtual void SAL_CALL removed( ::sal_Int32 ID ) throw (::com::sun::star::uno::RuntimeException);
+    virtual void SAL_CALL changed( ::sal_Int32 ID, const ::com::sun::star::uno::Sequence< ::com::sun::star::beans::NamedValue >& Properties ) throw (::com::sun::star::uno::RuntimeException);
+    virtual void SAL_CALL activated( ::sal_Int32 ID ) throw (::com::sun::star::uno::RuntimeException);
+    virtual void SAL_CALL deactivated( ::sal_Int32 ID ) throw (::com::sun::star::uno::RuntimeException);
+    virtual void SAL_CALL disposing( const ::com::sun::star::lang::EventObject& evt ) throw (::com::sun::star::uno::RuntimeException);
+    // XComponent
+    void SAL_CALL dispose(  ) throw(::com::sun::star::uno::RuntimeException);
+
+protected:
+    virtual void    impl_createControlPeerIfNecessary(
+        const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControl >& _rxControl
+    );
+
+};
+
+
+class UnoPageModel : public UnoControlDialogModel
+{
+public:
+                        UnoPageModel();
+                        ~UnoPageModel();
+                        UnoPageModel( const UnoPageModel& rModel );
+
+    UnoControlModel*	Clone() const;
+
+    DECLIMPL_SERVICEINFO_DERIVED( UnoPageModel, UnoControlDialogModel, szServiceName_UnoPageModel )
+
+    virtual ::rtl::OUString SAL_CALL getServiceName() throw(::com::sun::star::uno::RuntimeException);
+    virtual ::com::sun::star::uno::Reference< ::com::sun::star::beans::XPropertySetInfo > SAL_CALL getPropertySetInfo(  ) throw( ::com::sun::star::uno::RuntimeException);
+
+    // Override the method of parent Class
+    virtual sal_Bool SAL_CALL getGroupControl(  ) throw (::com::sun::star::uno::RuntimeException);
+protected:
+    virtual ::com::sun::star::uno::Any			ImplGetDefaultValue( sal_uInt16 nPropId ) const;
+    ::cppu::IPropertyArrayHelper&		SAL_CALL getInfoHelper();
+
+};
+
+
+class UnoPageControl :  public UnoDialogContainerControl
+{
+public:
+    UnoPageControl();
+    ~UnoPageControl();
+    ::rtl::OUString		GetComponentServiceName();
+
+
+    // ::com::sun::star::lang::XServiceInfo
+    DECLIMPL_SERVICEINFO_DERIVED( UnoPageControl, UnoDialogContainerControl, szServiceName_UnoPageControl )
 };
 
+class UnoFrameModel : public UnoControlDialogModel
+{
+public:
+                        UnoFrameModel();
+                        ~UnoFrameModel();
+                        UnoFrameModel( const UnoFrameModel& rModel );
+
+    UnoControlModel*	Clone() const;
+
+    DECLIMPL_SERVICEINFO_DERIVED( UnoFrameModel, UnoControlDialogModel, szServiceName_UnoFrameModel )
+
+    virtual ::rtl::OUString SAL_CALL getServiceName() throw(::com::sun::star::uno::RuntimeException);
+    virtual ::com::sun::star::uno::Reference< ::com::sun::star::beans::XPropertySetInfo > SAL_CALL getPropertySetInfo(  ) throw( ::com::sun::star::uno::RuntimeException);
+
+protected:
+    virtual ::com::sun::star::uno::Any			ImplGetDefaultValue( sal_uInt16 nPropId ) const;
+    ::cppu::IPropertyArrayHelper&		SAL_CALL getInfoHelper();
+};
+
+class UnoFrameControl :  public UnoDialogContainerControl
+{
+protected:
+        virtual void		ImplSetPosSize( ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControl >& rxCtrl );
+public:
+    UnoFrameControl();
+    ~UnoFrameControl();
+    ::rtl::OUString		GetComponentServiceName();
+
+    // ::com::sun::star::lang::XServiceInfo
+    DECLIMPL_SERVICEINFO_DERIVED( UnoFrameControl, UnoDialogContainerControl, szServiceName_UnoPageControl )
+};
 
 #endif // TOOLKIT_DIALOG_CONTROL_HXX
diff --git a/toolkit/inc/toolkit/controls/unocontrolcontainer.hxx b/toolkit/inc/toolkit/controls/unocontrolcontainer.hxx
index 9b3af49..ed5e30b 100644
--- a/toolkit/inc/toolkit/controls/unocontrolcontainer.hxx
+++ b/toolkit/inc/toolkit/controls/unocontrolcontainer.hxx
@@ -119,6 +119,15 @@ protected:
     virtual void removingControl( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControl >& _rxControl );
     virtual void addingControl( const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControl >& _rxControl );
 
+    /** ensures that the given control has a peer, if necessary and possible
+        @param _rxControl
+            an ->XControl which has just been inserted into the container. Must not be <NULL/>.
+        @precond
+            our mutex is locked
+    */
+    virtual void    impl_createControlPeerIfNecessary(
+        const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControl >& _rxControl
+    );
 private:
     /** adds the control to the container, does necessary notifications, and the like
         @param _rxControl
@@ -149,15 +158,6 @@ private:
         const ::rtl::OUString* _pNameAccessor
     );
 
-    /** ensures that the given control has a peer, if necessary and possible
-        @param _rxControl
-            an ->XControl which has just been inserted into the container. Must not be <NULL/>.
-        @precond
-            our mutex is locked
-    */
-    void    impl_createControlPeerIfNecessary(
-        const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControl >& _rxControl
-    );
 };
 
 
diff --git a/toolkit/inc/toolkit/controls/unocontrols.hxx b/toolkit/inc/toolkit/controls/unocontrols.hxx
index ac45479..7830b61 100644
--- a/toolkit/inc/toolkit/controls/unocontrols.hxx
+++ b/toolkit/inc/toolkit/controls/unocontrols.hxx
@@ -68,6 +68,16 @@
 #define UNO_NAME_GRAPHOBJ_URLPREFIX                             "vnd.sun.star.GraphicObject:"
 #define UNO_NAME_GRAPHOBJ_URLPKGPREFIX                  "vnd.sun.star.Package:"
  
+class ImageHelper
+{
+public:
+    // The routine will always attempt to return a valid XGraphic for the passed _rURL
+    // additionallly xOutGraphicObject will container the associated XGraphicObject ( if url
+    // is valid for that )
+    // and is set appropriately ( e.g. NULL if non GraphicObject scheme ) or valid object
+    // if the rURL points to a valid object
+    static ::com::sun::star::uno::Reference< ::com::sun::star::graphic::XGraphic > getGraphicAndGraphicObjectFromURL_nothrow( ::com::sun::star::uno::Reference< ::com::sun::star::graphic::XGraphicObject >& xOutGraphicObject, const ::rtl::OUString& _rURL );
+};
 
 //	----------------------------------------------------
 //	class UnoControlEditModel
@@ -222,6 +232,7 @@ private:
     bool                                                                                    mbAdjustingGraphic;
     
     ::com::sun::star::uno::Reference< ::com::sun::star::graphic::XGraphicObject > mxGrfObj;
+    ::com::sun::star::uno::Reference< ::com::sun::star::graphic::XGraphic > getGraphicFromURL_nothrow( const ::rtl::OUString& _rURL );
 protected:
     ImageProducerControlModel() : mbAdjustingImagePosition( false ), mbAdjustingGraphic( false ) { }
     ImageProducerControlModel( const ImageProducerControlModel& _rSource ) : com::sun::star::awt::XImageProducer(), UnoControlModel( _rSource ), mbAdjustingImagePosition( false ), mbAdjustingGraphic( false ) { }
@@ -666,44 +677,6 @@ public:
 
 };
 
-class UnoMultiPageModel : public UnoControlModel
-{
-protected:
-    ::com::sun::star::uno::Any 		ImplGetDefaultValue( sal_uInt16 nPropId ) const;
-    ::cppu::IPropertyArrayHelper& 	SAL_CALL getInfoHelper();
-
-public:
-                        UnoMultiPageModel();
-                        UnoMultiPageModel( const UnoMultiPageModel& rModel ) : UnoControlModel( rModel ) {;}
-
-    UnoControlModel*	Clone() const { return new UnoMultiPageModel( *this ); }
-
-    // ::com::sun::star::io::XPersistObject
-    ::rtl::OUString SAL_CALL getServiceName() throw(::com::sun::star::uno::RuntimeException);
-
-    // ::com::sun::star::beans::XMultiPropertySet
-    ::com::sun::star::uno::Reference< ::com::sun::star::beans::XPropertySetInfo > SAL_CALL getPropertySetInfo(  ) throw(::com::sun::star::uno::RuntimeException);
-
-    // ::com::sun::star::lang::XServiceInfo
-    DECLIMPL_SERVICEINFO_DERIVED( UnoMultiPageModel, UnoControlModel, szServiceName_UnoMultiPageModel )
-
-};
-//	----------------------------------------------------
-//	class UnoGroupBoxControl
-//	----------------------------------------------------
-class UnoMultiPageControl :	public UnoControlBase
-{
-public:
-                        UnoMultiPageControl();
-    ::rtl::OUString		GetComponentServiceName();
-
-    sal_Bool SAL_CALL isTransparent(  ) throw(::com::sun::star::uno::RuntimeException);
-
-    // ::com::sun::star::lang::XServiceInfo
-    DECLIMPL_SERVICEINFO_DERIVED( UnoMultiPageControl, UnoControlBase, szServiceName_UnoMultiPageControl )
-
-};
-
 //  ----------------------------------------------------
 //  class UnoFixedTextControl
 //  ----------------------------------------------------
diff --git a/toolkit/inc/toolkit/helper/listenermultiplexer.hxx b/toolkit/inc/toolkit/helper/listenermultiplexer.hxx
index 11bc909..589ba45 100644
--- a/toolkit/inc/toolkit/helper/listenermultiplexer.hxx
+++ b/toolkit/inc/toolkit/helper/listenermultiplexer.hxx
@@ -41,6 +41,7 @@
 #include <com/sun/star/awt/XTextListener.hpp>
 #include <com/sun/star/awt/XActionListener.hpp>
 #include <com/sun/star/awt/XItemListener.hpp>
+#include <com/sun/star/awt/XTabListener.hpp>
 #include <com/sun/star/container/XContainerListener.hpp>
 #include <com/sun/star/awt/XSpinListener.hpp>
 #include <com/sun/star/awt/XAdjustmentListener.hpp>
@@ -183,6 +184,17 @@ DECL_LISTENERMULTIPLEXER_START_DLLPUB( ItemListenerMultiplexer, ::com::sun::star
 DECL_LISTENERMULTIPLEXER_END
 
 //	----------------------------------------------------
+//	class TabListenerMultiplexer
+//	----------------------------------------------------
+DECL_LISTENERMULTIPLEXER_START_DLLPUB( TabListenerMultiplexer, ::com::sun::star::awt::XTabListener )
+    void SAL_CALL inserted( ::sal_Int32 ID ) throw (::com::sun::star::uno::RuntimeException);
+    void SAL_CALL removed( ::sal_Int32 ID ) throw (::com::sun::star::uno::RuntimeException);
+    void SAL_CALL changed( ::sal_Int32 ID, const ::com::sun::star::uno::Sequence< ::com::sun::star::beans::NamedValue >& Properties ) throw (::com::sun::star::uno::RuntimeException);
+    void SAL_CALL activated( ::sal_Int32 ID ) throw (::com::sun::star::uno::RuntimeException);
+    void SAL_CALL deactivated( ::sal_Int32 ID ) throw (::com::sun::star::uno::RuntimeException);
+DECL_LISTENERMULTIPLEXER_END
+
+//	----------------------------------------------------
 //	class ContainerListenerMultiplexer
 //	----------------------------------------------------
 DECL_LISTENERMULTIPLEXER_START( ContainerListenerMultiplexer, ::com::sun::star::container::XContainerListener )
diff --git a/toolkit/inc/toolkit/helper/macros.hxx b/toolkit/inc/toolkit/helper/macros.hxx
index 824ee2b..f5e0720 100644
--- a/toolkit/inc/toolkit/helper/macros.hxx
+++ b/toolkit/inc/toolkit/helper/macros.hxx
@@ -189,6 +189,57 @@ void ClassName::disposing( const ::com::sun::star::lang::EventObject& ) throw(::
     #define DISPLAY_EXCEPTION( ClassName, MethodName, e )
 #endif
 
+#define IMPL_TABLISTENERMULTIPLEXER_LISTENERMETHOD_BODY_2PARAM( ClassName, InterfaceName, MethodName, ParamType1, ParamType2 ) \
+{ \
+    ParamType1 aMulti( evt ); \
+    ParamType2 aMulti2( evt2 ); \
+    ::cppu::OInterfaceIteratorHelper aIt( *this ); \
+    while( aIt.hasMoreElements() ) \
+    { \
+        ::com::sun::star::uno::Reference< InterfaceName > xListener( \
+            static_cast< InterfaceName* >( aIt.next() ) ); \
+        try \
+        { \
+            xListener->MethodName( aMulti, aMulti2 ); \
+        } \
+        catch( ::com::sun::star::lang::DisposedException e ) \
+        { \
+            OSL_ENSURE( e.Context.is(), "caught DisposedException with empty Context field" ); \
+            if ( e.Context == xListener || !e.Context.is() ) \
+                aIt.remove(); \
+        } \
+        catch( ::com::sun::star::uno::RuntimeException e ) \
+        { \
+            DISPLAY_EXCEPTION( ClassName, MethodName, e ) \
+        } \
+    } \
+}
+
+#define IMPL_TABLISTENERMULTIPLEXER_LISTENERMETHOD_BODY_1PARAM( ClassName, InterfaceName, MethodName, ParamType1 ) \
+{ \
+    ParamType1 aMulti( evt ); \
+    ::cppu::OInterfaceIteratorHelper aIt( *this ); \
+    while( aIt.hasMoreElements() ) \
+    { \
+        ::com::sun::star::uno::Reference< InterfaceName > xListener( \
+            static_cast< InterfaceName* >( aIt.next() ) ); \
+        try \
+        { \
+            xListener->MethodName( aMulti ); \
+        } \
+        catch( ::com::sun::star::lang::DisposedException e ) \
+        { \
+            OSL_ENSURE( e.Context.is(), "caught DisposedException with empty Context field" ); \
+            if ( e.Context == xListener || !e.Context.is() ) \
+                aIt.remove(); \
+        } \
+        catch( ::com::sun::star::uno::RuntimeException e ) \
+        { \
+            DISPLAY_EXCEPTION( ClassName, MethodName, e ) \
+        } \
+    } \
+}
+
 #define IMPL_LISTENERMULTIPLEXER_LISTENERMETHOD_BODY( ClassName, InterfaceName, MethodName, EventType ) \
 { \
     EventType aMulti( evt ); \
diff --git a/toolkit/inc/toolkit/helper/property.hxx b/toolkit/inc/toolkit/helper/property.hxx
index 3f27fa2..09e9003 100644
--- a/toolkit/inc/toolkit/helper/property.hxx
+++ b/toolkit/inc/toolkit/helper/property.hxx
@@ -196,6 +196,9 @@ namespace rtl {
 #define BASEPROPERTY_ENABLEVISIBLE                  145  // sal_Bool
 #define BASEPROPERTY_GROUPNAME                      146  // ::rtl::OUString
 #define BASEPROPERTY_VBAFORM                        147  // sal_Boo
+#define BASEPROPERTY_MULTIPAGEVALUE                 148  // sal_Int32
+#define BASEPROPERTY_USERFORMCONTAINEES             149  // css::container::XNameContainer
+
 
 
 // Keine gebundenen Properties, werden immer aus der Property BASEPROPERTY_FONTDESCRIPTOR entnommen.
diff --git a/toolkit/inc/toolkit/helper/servicenames.hxx b/toolkit/inc/toolkit/helper/servicenames.hxx
index 842d1de..a795ebd 100644
--- a/toolkit/inc/toolkit/helper/servicenames.hxx
+++ b/toolkit/inc/toolkit/helper/servicenames.hxx
@@ -40,6 +40,12 @@ extern const sal_Char __FAR_DATA szServiceName_UnoControlContainer[], szServiceN
 extern const sal_Char __FAR_DATA szServiceName_UnoMultiPageControl[], szServiceName2_UnoMultiPageControl[];
 extern const sal_Char __FAR_DATA szServiceName_UnoMultiPageModel[], szServiceName2_UnoMultiPageModel[];
 extern const sal_Char __FAR_DATA szServiceName_UnoControlContainerModel[], szServiceName2_UnoControlContainerModel[];
+extern const sal_Char __FAR_DATA szServiceName_UnoMultiPageControl[], szServiceName2_UnoMultiPageControl[];
+extern const sal_Char __FAR_DATA szServiceName_UnoMultiPageModel[], szServiceName2_UnoMultiPageModel[];
+extern const sal_Char __FAR_DATA szServiceName_UnoPageControl[], szServiceName2_UnoPageControl[];
+extern const sal_Char __FAR_DATA szServiceName_UnoPageModel[], szServiceName2_UnoPageModel[];
+extern const sal_Char __FAR_DATA szServiceName_UnoFrameControl[], szServiceName2_UnoFrameControl[];
+extern const sal_Char __FAR_DATA szServiceName_UnoFrameModel[], szServiceName2_UnoFrameModel[];
 extern const sal_Char __FAR_DATA szServiceName_TabController[], szServiceName2_TabController[];
 extern const sal_Char __FAR_DATA szServiceName_TabControllerModel[], szServiceName2_TabControllerModel[];
 extern const sal_Char __FAR_DATA szServiceName_UnoControlDialog[], szServiceName2_UnoControlDialog[];
diff --git a/toolkit/source/awt/vclxtabcontrol.cxx b/toolkit/source/awt/vclxtabcontrol.cxx
index 1dfd526..cb9be45 100644
--- a/toolkit/source/awt/vclxtabcontrol.cxx
+++ b/toolkit/source/awt/vclxtabcontrol.cxx
@@ -25,7 +25,7 @@
  *
  ************************************************************************/
 
-#include "vclxtabcontrol.hxx"
+#include <vclxtabcontrol.hxx>
 
 #include <com/sun/star/awt/PosSize.hpp>
 #include <sal/macros.h>
diff --git a/toolkit/source/awt/vclxtabcontrol.hxx b/toolkit/source/awt/vclxtabcontrol.hxx
index 8f5debf..50773c5 100644
--- a/toolkit/source/awt/vclxtabcontrol.hxx
+++ b/toolkit/source/awt/vclxtabcontrol.hxx
@@ -122,6 +122,8 @@ public:
         ChildProps( VCLXTabControl::ChildData *pData );
     };
 
+    inline TabControl *getTabControl() const throw (::com::sun::star::uno::RuntimeException);
+
 protected:
     ChildData *createChild( css::uno::Reference< css::awt::XLayoutConstrains > const& xChild );
     ChildProps *createChildProps( Box_Base::ChildData* pData );
@@ -132,7 +134,6 @@ protected:
     std::list< ::com::sun::star::uno::Reference
                < ::com::sun::star::awt::XTabListener > > mxTabListeners;
 
-    inline TabControl *getTabControl() const throw (::com::sun::star::uno::RuntimeException);
 
 private:
     VCLXTabControl( const VCLXTabControl& );            // never implemented
diff --git a/toolkit/source/awt/vclxtabpage.cxx b/toolkit/source/awt/vclxtabpage.cxx
index 79b5b7f..ad0726e 100644
--- a/toolkit/source/awt/vclxtabpage.cxx
+++ b/toolkit/source/awt/vclxtabpage.cxx
@@ -25,7 +25,8 @@
  *
  ************************************************************************/
 
-#include "vclxtabpage.hxx"
+#include <vclxtabpage.hxx>
+
 #include "forward.hxx"
 
 #include <com/sun/star/awt/PosSize.hpp>
diff --git a/toolkit/source/awt/vclxtoolkit.cxx b/toolkit/source/awt/vclxtoolkit.cxx
index b203b34..e3907b8 100644
--- a/toolkit/source/awt/vclxtoolkit.cxx
+++ b/toolkit/source/awt/vclxtoolkit.cxx
@@ -119,6 +119,7 @@
 
 #include <tools/debug.hxx>
 #include <comphelper/processfactory.hxx>
+#include "awt/vclxtabcontrol.hxx"
 
 namespace css = ::com::sun::star;
 
@@ -286,6 +287,7 @@ static ComponentInfo __FAR_DATA aComponentInfos [] =
     { "floatingwindow",		WINDOW_FLOATINGWINDOW },
     { "framewindow",		VCLWINDOW_FRAMEWINDOW },
     { "groupbox",			WINDOW_GROUPBOX },
+    { "frame",			WINDOW_GROUPBOX },
     { "helpbutton",			WINDOW_HELPBUTTON },
     { "imagebutton",		WINDOW_IMAGEBUTTON },
     { "imageradiobutton",	WINDOW_IMAGERADIOBUTTON },
@@ -626,7 +628,14 @@ Window*	VCLXToolkit::ImplCreateWindow( VCLXWindow** ppNewComp,
 
     Window* pNewWindow = NULL;
     sal_uInt16 nType = ImplGetComponentType( aServiceName );
-
+    bool bFrameControl = false;
+    if ( aServiceName == String( RTL_CONSTASCII_USTRINGPARAM("frame") ) )
+        bFrameControl = true;
+    if ( aServiceName == String( RTL_CONSTASCII_USTRINGPARAM("tabcontrolnotabs") ) )
+    {
+        nWinBits |= WB_NOBORDER;
+        nType = ImplGetComponentType( String( RTL_CONSTASCII_USTRINGPARAM("tabcontrol") ) );
+    }
     if ( !pParent )
     {
         // Wenn die Component einen Parent braucht, dann NULL zurueckgeben,
@@ -715,7 +724,19 @@ Window*	VCLXToolkit::ImplCreateWindow( VCLXWindow** ppNewComp,
                 pNewWindow = new FloatingWindow( pParent, nWinBits );
             break;
             case WINDOW_GROUPBOX:
-                pNewWindow = new GroupBox( pParent, nWinBits );
+                        {
+                                if ( bFrameControl )
+                                {
+                                    GroupBox* pGroupBox =  new GroupBox( pParent, nWinBits | TEXT_DRAW_TOP );
+                                    *ppNewComp = new VCLXFrame;
+                                    // Frame control needs to recieve
+                                    // Mouse events
+                                    pGroupBox->SetMouseTransparent( FALSE );
+                    pNewWindow = pGroupBox;
+                                }
+                                else
+                    pNewWindow = new GroupBox( pParent, nWinBits );
+                        }
             break;
             case WINDOW_HELPBUTTON:
                 pNewWindow = new HelpButton( pParent, nWinBits );
@@ -855,6 +876,7 @@ Window*	VCLXToolkit::ImplCreateWindow( VCLXWindow** ppNewComp,
             break;
             case WINDOW_TABCONTROL:
                 pNewWindow = new TabControl( pParent, nWinBits );
+                *ppNewComp = new VCLXMultiPage;
             break;
             case WINDOW_TABDIALOG:
                 pNewWindow = new TabDialog( pParent, nWinBits );
diff --git a/toolkit/source/awt/vclxwindows.cxx b/toolkit/source/awt/vclxwindows.cxx
index 2878cf8..faec139 100644
--- a/toolkit/source/awt/vclxwindows.cxx
+++ b/toolkit/source/awt/vclxwindows.cxx
@@ -2192,6 +2192,7 @@ void VCLXDialog::ImplGetPropertyIds( std::list< sal_uInt16 > &rIds )
 
 VCLXDialog::VCLXDialog()
 {
+    OSL_TRACE("XDialog created");
 }
 
 VCLXDialog::~VCLXDialog()
@@ -2381,6 +2382,292 @@ throw(::com::sun::star::uno::RuntimeException)
     }
 }
 
+
+//	----------------------------------------------------
+//	class VCLXTabPage
+//	----------------------------------------------------
+VCLXMultiPage::VCLXMultiPage() : maTabListeners( *this ), mTabId( 1 )
+{
+    OSL_TRACE("VCLXMultiPage::VCLXMultiPage()" );
+}
+
+void VCLXMultiPage::ImplGetPropertyIds( std::list< sal_uInt16 > &rIds )
+{
+    PushPropertyIds( rIds,
+                     BASEPROPERTY_BACKGROUNDCOLOR,
+                     BASEPROPERTY_DEFAULTCONTROL,
+                     BASEPROPERTY_ENABLED,
+                     BASEPROPERTY_MULTIPAGEVALUE,
+                     BASEPROPERTY_ENABLEVISIBLE,
+                     BASEPROPERTY_FONTDESCRIPTOR,
+                     BASEPROPERTY_GRAPHIC,
+                     BASEPROPERTY_HELPTEXT,
+                     BASEPROPERTY_HELPURL,
+                     BASEPROPERTY_IMAGEALIGN,
+                     BASEPROPERTY_IMAGEPOSITION,
+                     BASEPROPERTY_IMAGEURL,
+                     BASEPROPERTY_PRINTABLE,
+                     BASEPROPERTY_TABSTOP,
+                     BASEPROPERTY_FOCUSONCLICK,
+                     0);
+    VCLXContainer::ImplGetPropertyIds( rIds );
+}
+
+VCLXMultiPage::~VCLXMultiPage()
+{
+}
+void SAL_CALL VCLXMultiPage::dispose() throw(::com::sun::star::uno::RuntimeException)
+{
+    ::vos::OGuard aGuard( GetMutex() );
+
+    ::com::sun::star::lang::EventObject aObj;
+    aObj.Source = (::cppu::OWeakObject*)this;
+    maTabListeners.disposeAndClear( aObj );
+    VCLXContainer::dispose();
+}
+::com::sun::star::uno::Any SAL_CALL VCLXMultiPage::queryInterface(const ::com::sun::star::uno::Type & rType )
+throw(::com::sun::star::uno::RuntimeException)
+{
+    uno::Any aRet = ::cppu::queryInterface( rType, static_cast< awt::XSimpleTabController*>( this ) );
+
+    return ( aRet.hasValue() ? aRet : VCLXContainer::queryInterface( rType ) );
+}
+
+// ::com::sun::star::lang::XTypeProvider
+IMPL_XTYPEPROVIDER_START( VCLXMultiPage )
+    VCLXContainer::getTypes()
+IMPL_XTYPEPROVIDER_END
+
+// ::com::sun::star::awt::XView
+void SAL_CALL VCLXMultiPage::draw( sal_Int32 nX, sal_Int32 nY )
+throw(::com::sun::star::uno::RuntimeException)
+{
+    ::vos::OGuard aGuard( GetMutex() );
+    Window* pWindow = GetWindow();
+
+    if ( pWindow )
+    {
+        OutputDevice* pDev = VCLUnoHelper::GetOutputDevice( getGraphics() );
+        if ( !pDev )
+            pDev = pWindow->GetParent();
+
+        Size aSize = pDev->PixelToLogic( pWindow->GetSizePixel() );
+        Point aPos = pDev->PixelToLogic( Point( nX, nY ) );
+
+        pWindow->Draw( pDev, aPos, aSize, WINDOW_DRAW_NOCONTROLS );
+    }
+}
+
+// ::com::sun::star::awt::XDevice,
+::com::sun::star::awt::DeviceInfo SAL_CALL VCLXMultiPage::getInfo()
+throw(::com::sun::star::uno::RuntimeException)
+{
+    ::com::sun::star::awt::DeviceInfo aInfo = VCLXDevice::getInfo();
+    return aInfo;
+}
+
+uno::Any SAL_CALL VCLXMultiPage::getProperty( const ::rtl::OUString& PropertyName ) throw(::com::sun::star::uno::RuntimeException)
+{
+    ::vos::OGuard aGuard( GetMutex() );
+    OSL_TRACE(" **** VCLXMultiPage::getProperty( %s )",
+        rtl::OUStringToOString( PropertyName,
+        RTL_TEXTENCODING_UTF8 ).getStr() );
+    ::com::sun::star::uno::Any aProp;
+    sal_uInt16 nPropType = GetPropertyId( PropertyName );
+    switch ( nPropType )
+    {
+
+        case BASEPROPERTY_MULTIPAGEVALUE:
+        {
+            aProp <<= getActiveTabID();
+        }
+        break;
+        default:
+            aProp <<= VCLXContainer::getProperty( PropertyName );
+    }
+    return aProp;
+}
+
+void SAL_CALL VCLXMultiPage::setProperty(
+    const ::rtl::OUString& PropertyName,
+    const ::com::sun::star::uno::Any& Value )
+throw(::com::sun::star::uno::RuntimeException)
+{
+    ::vos::OGuard aGuard( GetMutex() );
+    OSL_TRACE(" **** VCLXMultiPage::setProperty( %s )", rtl::OUStringToOString( PropertyName, RTL_TEXTENCODING_UTF8 ).getStr() );
+
+    TabControl* pTabControl = (TabControl*)GetWindow();
+    if ( pTabControl )
+    {
+        sal_Bool bVoid = Value.getValueType().getTypeClass() == ::com::sun::star::uno::TypeClass_VOID;
+
+        sal_uInt16 nPropType = GetPropertyId( PropertyName );
+        switch ( nPropType )
+        {
+            case BASEPROPERTY_MULTIPAGEVALUE:
+            {
+                OSL_TRACE("***MULTIPAGE VALUE");
+                sal_Int32 nId(0);
+                Value >>= nId;
+                // when the multipage is created we attempt to set the activepage
+                // but no pages created
+                if ( nId && nId <= getWindows().getLength() )
+                    activateTab( nId );
+            }
+            case BASEPROPERTY_GRAPHIC:
+            {
+                Reference< XGraphic > xGraphic;
+                if (( Value >>= xGraphic ) && xGraphic.is() )
+                {
+                    Image aImage( xGraphic );
+
+                    Wallpaper aWallpaper( aImage.GetBitmapEx());
+                    aWallpaper.SetStyle( WALLPAPER_SCALE );
+                    pTabControl->SetBackground( aWallpaper );
+                }
+                else if ( bVoid || !xGraphic.is() )
+                {
+                    Color aColor = pTabControl->GetControlBackground().GetColor();
+                    if ( aColor == COL_AUTO )
+                        aColor = pTabControl->GetSettings().GetStyleSettings().GetDialogColor();
+
+                    Wallpaper aWallpaper( aColor );
+                    pTabControl->SetBackground( aWallpaper );
+                }
+            }
+            break;
+
+            default:
+            {
+                VCLXContainer::setProperty( PropertyName, Value );
+            }
+        }
+    }
+}
+
+TabControl *VCLXMultiPage::getTabControl() const throw (uno::RuntimeException)
+{
+    TabControl *pTabControl = dynamic_cast< TabControl* >( GetWindow() );
+    if ( pTabControl )
+        return pTabControl;
+    throw uno::RuntimeException();
+}
+sal_Int32 SAL_CALL VCLXMultiPage::insertTab() throw (uno::RuntimeException)
+{
+    TabControl *pTabControl = getTabControl();
+    TabPage* pTab = new TabPage( pTabControl );
+    rtl::OUString title (RTL_CONSTASCII_USTRINGPARAM( "" ) );
+    return static_cast< sal_Int32 >( insertTab( pTab, title ) );
+}
+
+USHORT VCLXMultiPage::insertTab( TabPage* pPage, rtl::OUString& sTitle )
+{
+    TabControl *pTabControl = getTabControl();
+    USHORT id = sal::static_int_cast< USHORT >( mTabId++ );
+    pTabControl->InsertPage( id, sTitle.getStr(), TAB_APPEND );
+    pTabControl->SetTabPage( id, pPage );
+    return id;
+}
+
+void SAL_CALL VCLXMultiPage::removeTab( sal_Int32 ID ) throw (uno::RuntimeException, lang::IndexOutOfBoundsException)
+{
+    TabControl *pTabControl = getTabControl();
+    if ( pTabControl->GetTabPage( sal::static_int_cast< USHORT >( ID ) ) == NULL )
+        throw lang::IndexOutOfBoundsException();
+    pTabControl->RemovePage( sal::static_int_cast< USHORT >( ID ) );
+}
+
+void SAL_CALL VCLXMultiPage::activateTab( sal_Int32 ID ) throw (uno::RuntimeException, lang::IndexOutOfBoundsException)
+{
+    TabControl *pTabControl = getTabControl();
+    OSL_TRACE("Attempting to activate tab %d, active tab is %d, numtabs is %d", ID, getActiveTabID(), getWindows().getLength() );
+    if ( pTabControl->GetTabPage( sal::static_int_cast< USHORT >( ID ) ) == NULL )
+        throw lang::IndexOutOfBoundsException();
+    pTabControl->SelectTabPage( sal::static_int_cast< USHORT >( ID ) );
+}
+
+sal_Int32 SAL_CALL VCLXMultiPage::getActiveTabID() throw (uno::RuntimeException)
+{
+    return getTabControl()->GetCurPageId( );
+}
+
+void SAL_CALL VCLXMultiPage::addTabListener( const uno::Reference< awt::XTabListener >& xListener ) throw (uno::RuntimeException)
+{
+    ::vos::OGuard aGuard( GetMutex() );
+    maTabListeners.addInterface( xListener );
+}
+
+void SAL_CALL VCLXMultiPage::removeTabListener( const uno::Reference< awt::XTabListener >& xListener ) throw (uno::RuntimeException)
+{
+    ::vos::OGuard aGuard( GetMutex() );
+    maTabListeners.addInterface( xListener );
+}
+
+void SAL_CALL VCLXMultiPage::setTabProps( sal_Int32 ID, const uno::Sequence< beans::NamedValue >& Properties ) throw (uno::RuntimeException, lang::IndexOutOfBoundsException)
+{
+    ::vos::OGuard aGuard( GetMutex() );
+    TabControl *pTabControl = getTabControl();
+    if ( pTabControl->GetTabPage( sal::static_int_cast< USHORT >( ID ) ) == NULL )
+        throw lang::IndexOutOfBoundsException();
+
+    for ( int i = 0; i < Properties.getLength(); i++ )
+    {
+        const rtl::OUString &name = Properties[i].Name;
+        const uno::Any &value = Properties[i].Value;
+
+        if ( name  == rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( "Title" ) ) )
+        {
+            rtl::OUString title = value.get<rtl::OUString>();
+            pTabControl->SetPageText( sal::static_int_cast< USHORT >( ID ), title.getStr() );
+        }
+    }
+}
+
+uno::Sequence< beans::NamedValue > SAL_CALL VCLXMultiPage::getTabProps( sal_Int32 ID )
+    throw (lang::IndexOutOfBoundsException, uno::RuntimeException)
+{
+    ::vos::OGuard aGuard( GetMutex() );
+    TabControl *pTabControl = getTabControl();
+    if ( pTabControl->GetTabPage( sal::static_int_cast< USHORT >( ID ) ) == NULL )
+        throw lang::IndexOutOfBoundsException();
+
+#define ADD_PROP( seq, i, name, val ) {                                \
+        beans::NamedValue value;                                                  \
+        value.Name = rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( name ) ); \
+        value.Value = uno::makeAny( val );                                      \
+        seq[i] = value;                                                    \
+    }
+
+    uno::Sequence< beans::NamedValue > props( 2 );
+    ADD_PROP( props, 0, "Title", rtl::OUString( pTabControl->GetPageText( sal::static_int_cast< USHORT >( ID ) ) ) );
+    ADD_PROP( props, 1, "Position", pTabControl->GetPagePos( sal::static_int_cast< USHORT >( ID ) ) );
+#undef ADD_PROP
+    return props;
+}
+void VCLXMultiPage::ProcessWindowEvent( const VclWindowEvent& rVclWindowEvent )
+{
+    ::com::sun::star::uno::Reference< ::com::sun::star::awt::XWindow > xKeepAlive( this );
+    switch ( rVclWindowEvent.GetId() )
+    {
+        case VCLEVENT_TABPAGE_DEACTIVATE:
+        {
+            ULONG nPageID = (ULONG)( rVclWindowEvent.GetData() );
+            maTabListeners.deactivated( nPageID );
+            break;
+
+        }
+        case VCLEVENT_TABPAGE_ACTIVATE:
+        {
+            ULONG nPageID = (ULONG)( rVclWindowEvent.GetData() );
+            maTabListeners.activated( nPageID );
+            break;
+        }
+        default:
+            VCLXContainer::ProcessWindowEvent( rVclWindowEvent );
+            break;
+    };
+}
+
 //	----------------------------------------------------
 //	class VCLXTabPage
 //	----------------------------------------------------
@@ -2388,6 +2675,27 @@ VCLXTabPage::VCLXTabPage()
 {
 }
 
+void VCLXTabPage::ImplGetPropertyIds( std::list< sal_uInt16 > &rIds )
+{
+    PushPropertyIds( rIds,
+                     BASEPROPERTY_BACKGROUNDCOLOR,
+                     BASEPROPERTY_DEFAULTCONTROL,
+                     BASEPROPERTY_ENABLED,
+                     BASEPROPERTY_ENABLEVISIBLE,
+                     BASEPROPERTY_FONTDESCRIPTOR,
+                     BASEPROPERTY_GRAPHIC,
+                     BASEPROPERTY_HELPTEXT,
+                     BASEPROPERTY_HELPURL,
+                     BASEPROPERTY_IMAGEALIGN,
+                     BASEPROPERTY_IMAGEPOSITION,
+                     BASEPROPERTY_IMAGEURL,
+                     BASEPROPERTY_PRINTABLE,
+                     BASEPROPERTY_TABSTOP,
+                     BASEPROPERTY_FOCUSONCLICK,
+                     0);
+    VCLXContainer::ImplGetPropertyIds( rIds );
+}
+
 VCLXTabPage::~VCLXTabPage()
 {
 }
@@ -2477,6 +2785,14 @@ throw(::com::sun::star::uno::RuntimeException)
     }
 }
 
+TabPage *VCLXTabPage::getTabPage() const throw (uno::RuntimeException)
+{
+    TabPage *pTabPage = dynamic_cast< TabPage* >( GetWindow() );
+    if ( pTabPage )
+        return pTabPage;
+    throw uno::RuntimeException();
+}
+
 //	----------------------------------------------------
 //  class VCLXFixedHyperlink
 //	----------------------------------------------------
@@ -6061,4 +6377,98 @@ VCLXToolBox::~VCLXToolBox()
 {
     return getAccessibleFactory().createAccessibleContext( this );
 }
+//	----------------------------------------------------
+//	class VCLXFrame
+//	----------------------------------------------------
+VCLXFrame::VCLXFrame()
+{
+}
+
+void VCLXFrame::ImplGetPropertyIds( std::list< sal_uInt16 > &rIds )
+{
+    PushPropertyIds( rIds,
+                     BASEPROPERTY_BACKGROUNDCOLOR,
+                     BASEPROPERTY_DEFAULTCONTROL,
+                     BASEPROPERTY_ENABLED,
+                     BASEPROPERTY_ENABLEVISIBLE,
+                     BASEPROPERTY_FONTDESCRIPTOR,
+                     BASEPROPERTY_GRAPHIC,
+                     BASEPROPERTY_HELPTEXT,
+                     BASEPROPERTY_HELPURL,
+                     BASEPROPERTY_PRINTABLE,
+                     BASEPROPERTY_LABEL,
+                     0);
+    VCLXContainer::ImplGetPropertyIds( rIds );
+}
+
+VCLXFrame::~VCLXFrame()
+{
+}
+
+::com::sun::star::uno::Any SAL_CALL VCLXFrame::queryInterface(const ::com::sun::star::uno::Type & rType )
+throw(::com::sun::star::uno::RuntimeException)
+{
+    return VCLXContainer::queryInterface( rType );
+}
+
+// ::com::sun::star::lang::XTypeProvider
+IMPL_XTYPEPROVIDER_START( VCLXFrame )
+    VCLXContainer::getTypes()
+IMPL_XTYPEPROVIDER_END
+
+// ::com::sun::star::awt::XView
+void SAL_CALL VCLXFrame::draw( sal_Int32 nX, sal_Int32 nY )
+throw(::com::sun::star::uno::RuntimeException)
+{
+    ::vos::OGuard aGuard( GetMutex() );
+    Window* pWindow = GetWindow();
+
+    if ( pWindow )
+    {
+        OutputDevice* pDev = VCLUnoHelper::GetOutputDevice( getGraphics() );
+        if ( !pDev )
+            pDev = pWindow->GetParent();
+
+        Size aSize = pDev->PixelToLogic( pWindow->GetSizePixel() );
+        Point aPos = pDev->PixelToLogic( Point( nX, nY ) );
+
+        pWindow->Draw( pDev, aPos, aSize, WINDOW_DRAW_NOCONTROLS );
+    }
+}
+
+// ::com::sun::star::awt::XDevice,
+::com::sun::star::awt::DeviceInfo SAL_CALL VCLXFrame::getInfo()
+throw(::com::sun::star::uno::RuntimeException)
+{
+    ::com::sun::star::awt::DeviceInfo aInfo = VCLXDevice::getInfo();
+    return aInfo;
+}
+
+void SAL_CALL VCLXFrame::setProperty(
+    const ::rtl::OUString& PropertyName,
+    const ::com::sun::star::uno::Any& Value )
+throw(::com::sun::star::uno::RuntimeException)
+{
+    ::vos::OGuard aGuard( GetMutex() );
+
+#if OSL_DEBUG_LEVEL > 0
+    sal_Bool bVoid = Value.getValueType().getTypeClass() == ::com::sun::star::uno::TypeClass_VOID;
+    (void)bVoid;
+#endif
+
+    sal_uInt16 nPropType = GetPropertyId( PropertyName );
+    switch ( nPropType )
+    {
+            default:
+            {
+                VCLXContainer::setProperty( PropertyName, Value );
+            }
+        }
+}
+
+void VCLXFrame::ProcessWindowEvent( const VclWindowEvent& rVclWindowEvent )
+{
+    ::com::sun::star::uno::Reference< ::com::sun::star::awt::XWindow > xKeepAlive( this );
+    VCLXContainer::ProcessWindowEvent( rVclWindowEvent );
+}
 
diff --git a/toolkit/source/controls/dialogcontrol.cxx b/toolkit/source/controls/dialogcontrol.cxx
index 14b045a..2447dcf 100644
--- a/toolkit/source/controls/dialogcontrol.cxx
+++ b/toolkit/source/controls/dialogcontrol.cxx
@@ -66,10 +66,16 @@
 #include "grid/gridcontrol.hxx"
 
 #include <map>
+#include <hash_map>
 #include <algorithm>
 #include <functional>
 #include "tools/urlobj.hxx"
 #include "osl/file.hxx"
+#include <com/sun/star/awt/XSimpleTabController.hpp>
+#include <vcl/tabctrl.hxx>
+#include <vcl/tabpage.hxx>
+#include <vcl/button.hxx>
+#include <toolkit/awt/vclxwindows.hxx>
 
 using namespace ::com::sun::star;
 using namespace ::com::sun::star::uno;
@@ -89,8 +95,6 @@ using namespace toolkit;
 //HELPER
 ::rtl::OUString getPhysicalLocation( const ::com::sun::star::uno::Any& rbase, const ::com::sun::star::uno::Any& rUrl );
 
-uno::Reference< graphic::XGraphic > getGraphicFromURL_nothrow( uno::Reference< graphic::XGraphicObject >& rxGrfObj, const ::rtl::OUString& _rURL );
-
 struct LanguageDependentProp
 {
     const char* pPropName;
@@ -117,32 +121,6 @@ namespace
         return s_aLanguageDependentProperties;
     }
 
-    static uno::Reference< graphic::XGraphic > lcl_getGraphicFromURL_nothrow( const ::rtl::OUString& _rURL )
-    {
-        uno::Reference< graphic::XGraphic > xGraphic;
-        if ( !_rURL.getLength() )
-            return xGraphic;
-
-        try
-        {
-            ::comphelper::ComponentContext aContext( ::comphelper::getProcessServiceFactory() );
-            uno::Reference< graphic::XGraphicProvider > xProvider;
-            if ( aContext.createComponent( "com.sun.star.graphic.GraphicProvider", xProvider ) )
-            {
-                uno::Sequence< beans::PropertyValue > aMediaProperties(1);
-                aMediaProperties[0].Name = ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( "URL" ) );
-                aMediaProperties[0].Value <<= _rURL;
-                xGraphic = xProvider->queryGraphic( aMediaProperties );
-            }
-        }
-        catch( const Exception& )
-        {
-            DBG_UNHANDLED_EXCEPTION();
-        }
-
-        return xGraphic;
-    }
-
     static ::rtl::OUString lcl_GetStringProperty( const ::rtl::OUString& sProperty, const Reference< XPropertySet >& xSet )
     {
         ::rtl::OUString sValue;
@@ -260,36 +238,117 @@ static const ::rtl::OUString& getStepPropertyName( )
     return s_sStepProperty;
 }
 
+// we probably will need both a hash of control models and hash of controls
+// => use some template magic
+
+typedef ::cppu::WeakImplHelper1< container::XNameContainer > SimpleNameContainer_BASE;
+
+template< typename T >
+class SimpleNamedThingContainer : public SimpleNameContainer_BASE
+{
+    typedef std::hash_map< rtl::OUString, Reference< T >, ::rtl::OUStringHash,
+       ::std::equal_to< ::rtl::OUString > > NamedThingsHash;
+    NamedThingsHash things;
+    ::osl::Mutex m_aMutex;
+public:
+    // ::com::sun::star::container::XNameContainer, XNameReplace, XNameAccess
+    virtual void SAL_CALL replaceByName( const ::rtl::OUString& aName, const Any& aElement ) throw(IllegalArgumentException, NoSuchElementException, WrappedTargetException, RuntimeException)
+    {
+        ::osl::MutexGuard aGuard( m_aMutex );
+        if ( !hasByName( aName ) )
+            throw NoSuchElementException();
+        Reference< T > xElement;
+        if ( ! ( aElement >>= xElement ) )
+            throw IllegalArgumentException();
+        things[ aName ] = xElement;
+    }
+    virtual Any SAL_CALL getByName( const ::rtl::OUString& aName ) throw(NoSuchElementException, WrappedTargetException, RuntimeException)
+    {
+        ::osl::MutexGuard aGuard( m_aMutex );
+        if ( !hasByName( aName ) )
+            throw NoSuchElementException();
+        return uno::makeAny( things[ aName ] );
+    }
+    virtual Sequence< ::rtl::OUString > SAL_CALL getElementNames(  ) throw(RuntimeException)
+    {
+        ::osl::MutexGuard aGuard( m_aMutex );
+        Sequence< ::rtl::OUString > aResult( things.size() );
+        typename NamedThingsHash::iterator it = things.begin();
+        typename NamedThingsHash::iterator it_end = things.end();
+        rtl::OUString* pName = aResult.getArray();
+        for (; it != it_end; ++it, ++pName )
+            *pName = it->first;
+        return aResult;
+    }
+    virtual sal_Bool SAL_CALL hasByName( const ::rtl::OUString& aName ) throw(RuntimeException)
+    {
+        ::osl::MutexGuard aGuard( m_aMutex );
+        return ( things.find( aName ) != things.end() );
+    }
+    virtual void SAL_CALL insertByName( const ::rtl::OUString& aName, const Any& aElement ) throw(IllegalArgumentException, ElementExistException, WrappedTargetException, RuntimeException)
+    {
+        ::osl::MutexGuard aGuard( m_aMutex );
+        if ( hasByName( aName ) )
+            throw ElementExistException();
+        Reference< T > xElement;
+        if ( ! ( aElement >>= xElement ) )
+            throw IllegalArgumentException();
+        things[ aName ] = xElement;
+    }
+    virtual void SAL_CALL removeByName( const ::rtl::OUString& aName ) throw(NoSuchElementException, WrappedTargetException, RuntimeException)
+    {
+        ::osl::MutexGuard aGuard( m_aMutex );
+        if ( !hasByName( aName ) )
+            throw NoSuchElementException();
+        things.erase( things.find( aName ) );
+    }
+    virtual Type SAL_CALL getElementType(  ) throw (RuntimeException)
+    {
+        return T::static_type( NULL );
+    }
+    virtual ::sal_Bool SAL_CALL hasElements(  ) throw (RuntimeException)
+    {
+        ::osl::MutexGuard aGuard( m_aMutex );
+        return ( things.size() > 0 );
+    }
+};
+
 //	----------------------------------------------------
 //	class UnoControlDialogModel
 //	----------------------------------------------------
-UnoControlDialogModel::UnoControlDialogModel()
+UnoControlDialogModel::UnoControlDialogModel( bool regProps )
     :maContainerListeners( *this )
     ,maChangeListeners ( GetMutex() )
-    ,mbGroupsUpToDate( sal_False ), mbAdjustingGraphic( false )
+    ,mbGroupsUpToDate( sal_False )
+    ,mbAdjustingGraphic( false )
 {
-    ImplRegisterProperty( BASEPROPERTY_BACKGROUNDCOLOR );
-//	ImplRegisterProperty( BASEPROPERTY_BORDER );
-    ImplRegisterProperty( BASEPROPERTY_DEFAULTCONTROL );
-    ImplRegisterProperty( BASEPROPERTY_ENABLED );
-    ImplRegisterProperty( BASEPROPERTY_FONTDESCRIPTOR );
-//	ImplRegisterProperty( BASEPROPERTY_PRINTABLE );
-    ImplRegisterProperty( BASEPROPERTY_HELPTEXT );
-    ImplRegisterProperty( BASEPROPERTY_HELPURL );
-    ImplRegisterProperty( BASEPROPERTY_TITLE );
-    ImplRegisterProperty( BASEPROPERTY_SIZEABLE );
-    ImplRegisterProperty( BASEPROPERTY_DESKTOP_AS_PARENT );
-    ImplRegisterProperty( BASEPROPERTY_DECORATION );
-    ImplRegisterProperty( BASEPROPERTY_DIALOGSOURCEURL );
-    ImplRegisterProperty( BASEPROPERTY_GRAPHIC );
-    ImplRegisterProperty( BASEPROPERTY_IMAGEURL );
-
-    Any aBool;
-    aBool <<= (sal_Bool) sal_True;
-    ImplRegisterProperty( BASEPROPERTY_MOVEABLE, aBool );
-    ImplRegisterProperty( BASEPROPERTY_CLOSEABLE, aBool );
-    aBool <<= (sal_Bool) sal_False;
-    ImplRegisterProperty( BASEPROPERTY_VBAFORM, aBool );
+    if ( regProps )
+    {
+        ImplRegisterProperty( BASEPROPERTY_BACKGROUNDCOLOR );
+    //	ImplRegisterProperty( BASEPROPERTY_BORDER );
+        ImplRegisterProperty( BASEPROPERTY_DEFAULTCONTROL );
+        ImplRegisterProperty( BASEPROPERTY_ENABLED );
+        ImplRegisterProperty( BASEPROPERTY_FONTDESCRIPTOR );
+    //	ImplRegisterProperty( BASEPROPERTY_PRINTABLE );
+        ImplRegisterProperty( BASEPROPERTY_HELPTEXT );
+        ImplRegisterProperty( BASEPROPERTY_HELPURL );
+        ImplRegisterProperty( BASEPROPERTY_TITLE );
+        ImplRegisterProperty( BASEPROPERTY_SIZEABLE );
+        ImplRegisterProperty( BASEPROPERTY_DESKTOP_AS_PARENT );
+        ImplRegisterProperty( BASEPROPERTY_DECORATION );
+        ImplRegisterProperty( BASEPROPERTY_DIALOGSOURCEURL );
+        ImplRegisterProperty( BASEPROPERTY_GRAPHIC );
+        ImplRegisterProperty( BASEPROPERTY_IMAGEURL );
+
+        Any aBool;
+        aBool <<= (sal_Bool) sal_True;
+        ImplRegisterProperty( BASEPROPERTY_MOVEABLE, aBool );
+        ImplRegisterProperty( BASEPROPERTY_CLOSEABLE, aBool );
+        aBool <<= (sal_Bool) sal_False;
+        ImplRegisterProperty( BASEPROPERTY_VBAFORM, aBool );
+        uno::Reference< XNameContainer > xNameCont = new SimpleNamedThingContainer< XControlModel >();
+        ImplRegisterProperty( BASEPROPERTY_USERFORMCONTAINEES, uno::makeAny( xNameCont ) );
+    }
 }
 
 UnoControlDialogModel::UnoControlDialogModel( const UnoControlDialogModel& rModel )
@@ -297,7 +356,9 @@ UnoControlDialogModel::UnoControlDialogModel( const UnoControlDialogModel& rMode
     , UnoControlDialogModel_Base( rModel )
     , maContainerListeners( *this )
     , maChangeListeners ( GetMutex() )
-    , mbGroupsUpToDate( sal_False ), mbAdjustingGraphic( false )
+    , mbGroupsUpToDate( sal_False )
+    , mxGrfObj( rModel.mxGrfObj )
+    , mbAdjustingGraphic( false )
 {
 }
 
@@ -330,7 +391,7 @@ Sequence< Type > UnoControlDialogModel::getTypes() throw(RuntimeException)
 
 void SAL_CALL UnoControlDialogModel::setFastPropertyValue_NoBroadcast( sal_Int32 nHandle, const ::com::sun::star::uno::Any& rValue ) throw (::com::sun::star::uno::Exception)
 {
-    UnoControlModel::setFastPropertyValue_NoBroadcast( nHandle, rValue );
+    UnoControlDialogModel_Base::setFastPropertyValue_NoBroadcast( nHandle, rValue );
     try
     {
         switch ( nHandle )
@@ -341,7 +402,7 @@ void SAL_CALL UnoControlDialogModel::setFastPropertyValue_NoBroadcast( sal_Int32
                 mbAdjustingGraphic = true;
                 ::rtl::OUString sImageURL;
                 OSL_VERIFY( rValue >>= sImageURL );
-                setPropertyValue( GetPropertyName( BASEPROPERTY_GRAPHIC ), uno::makeAny( getGraphicFromURL_nothrow( mxGrfObj, sImageURL ) ) );
+                setPropertyValue( GetPropertyName( BASEPROPERTY_GRAPHIC ), uno::makeAny( ImageHelper::getGraphicAndGraphicObjectFromURL_nothrow( mxGrfObj, sImageURL ) ) );
                 mbAdjustingGraphic = false;
             }
             break;
@@ -504,6 +565,10 @@ Reference< XInterface > UnoControlDialogModel::createInstance( const ::rtl::OUSt
         pNewModel = new OGeometryControlModel< UnoTreeModel >;
     else if ( aServiceSpecifier.compareToAscii( szServiceName_GridControlModel ) == 0 )
         pNewModel = new OGeometryControlModel< UnoGridModel >;
+    else if ( aServiceSpecifier.compareToAscii( szServiceName_UnoMultiPageModel ) == 0 )
+        pNewModel = new OGeometryControlModel< UnoMultiPageModel >;
+    else if ( aServiceSpecifier.compareToAscii( szServiceName_UnoFrameModel ) == 0 )
+        pNewModel = new OGeometryControlModel< UnoFrameModel >;
 
     if ( !pNewModel )
     {
@@ -543,7 +608,7 @@ Sequence< ::rtl::OUString > UnoControlDialogModel::getAvailableServiceNames() th
     static Sequence< ::rtl::OUString >* pNamesSeq = NULL;
     if ( !pNamesSeq )
     {
-        pNamesSeq = new Sequence< ::rtl::OUString >( 21 );
+        pNamesSeq = new Sequence< ::rtl::OUString >( 22 );
         ::rtl::OUString* pNames = pNamesSeq->getArray();
         pNames[0] = ::rtl::OUString::createFromAscii( szServiceName2_UnoControlEditModel );
         pNames[1] = ::rtl::OUString::createFromAscii( szServiceName2_UnoControlFormattedFieldModel );
@@ -567,6 +632,7 @@ Sequence< ::rtl::OUString > UnoControlDialogModel::getAvailableServiceNames() th
         pNames[19] = ::rtl::OUString::createFromAscii( szServiceName2_UnoControlRoadmapModel );
         pNames[20] = ::rtl::OUString::createFromAscii( szServiceName_TreeControlModel );
         pNames[20] = ::rtl::OUString::createFromAscii( szServiceName_GridControlModel );
+        pNames[21] = ::rtl::OUString::createFromAscii( szServiceName_UnoMultiPageModel );
 
     }
     return *pNamesSeq;
@@ -590,11 +656,80 @@ Type UnoControlDialogModel::getElementType() throw(RuntimeException)
     return aType;
 }
 
+void UnoControlDialogModel::updateUserFormChildren( const Reference< XNameContainer >& xAllChildren, const rtl::OUString& aName, ChildOperation Operation, const ::com::sun::star::uno::Reference< ::com::sun::star::awt::XControlModel >& xTarget ) throw(IllegalArgumentException, ElementExistException, WrappedTargetException, RuntimeException)
+{
+    if ( Operation < Insert || Operation > Remove )
+        throw IllegalArgumentException();
+
+    if ( xAllChildren.is() )
+    {
+        if ( Operation == Remove )
+        {
+            Reference< XControlModel > xOldModel( xAllChildren->getByName( aName ), UNO_QUERY );
+            xAllChildren->removeByName( aName );
+
+            Reference< XNameContainer > xChildContainer( xOldModel, UNO_QUERY );
+            if ( xChildContainer.is() )
+            {
+                Reference< XPropertySet > xProps( xChildContainer, UNO_QUERY );
+                // container control is being removed from this container, reset the
+                // global list of containees
+                if ( xProps.is() )
+                    xProps->setPropertyValue(  GetPropertyName( BASEPROPERTY_USERFORMCONTAINEES ), uno::makeAny( uno::Reference< XNameContainer >() ) );
+                Sequence< rtl::OUString > aChildNames = xChildContainer->getElementNames();
+                for ( sal_Int32 index=0; index< aChildNames.getLength(); ++index )
+                    updateUserFormChildren( xAllChildren, aChildNames[ index ], Operation,  Reference< XControlModel > () );
+            }
+        }
+        else if ( Operation == Insert )
+        {
+            xAllChildren->insertByName( aName, uno::makeAny( xTarget ) );
+            Reference< XNameContainer > xChildContainer( xTarget, UNO_QUERY );
+            if ( xChildContainer.is() )
+            {
+                // container control is being added from this container, reset the
+                // global list of containees to point to the correct global list
+                Reference< XPropertySet > xProps( xChildContainer, UNO_QUERY );
+                if ( xProps.is() )
+                    xProps->setPropertyValue(  GetPropertyName( BASEPROPERTY_USERFORMCONTAINEES ), uno::makeAny( xAllChildren ) );
+                Sequence< rtl::OUString > aChildNames = xChildContainer->getElementNames();
+                for ( sal_Int32 index=0; index< aChildNames.getLength(); ++index )
+                {
+                    Reference< XControlModel > xChildTarget( xChildContainer->getByName( aChildNames[ index ] ), UNO_QUERY );
+                    updateUserFormChildren( xAllChildren, aChildNames[ index ], Operation, xChildTarget );
+                }
+            }
+        }
+    }
+    else
+        throw IllegalArgumentException();
+}
+
 sal_Bool UnoControlDialogModel::hasElements() throw(RuntimeException)
 {
     return !maModels.empty();
 }
 
+void
+lcl_propagateVBAFormMode( const Any& rVal, const Reference< container::XNameContainer >& xContainer )
+{
+    Reference< XPropertySet > xProps( xContainer, UNO_QUERY );
+    if ( xProps.is() )
+        xProps->setPropertyValue(  GetPropertyName( BASEPROPERTY_VBAFORM ), rVal );
+    if ( xContainer.is() )
+    {
+        Sequence< rtl::OUString > sNames = xContainer->getElementNames();
+        sal_Int32 nContainees = sNames.getLength();
+        for ( sal_Int32 index = 0; index < nContainees; ++index )
+        {
+            Reference< container::XNameContainer > xChildContainer;
+            xContainer->getByName( sNames[ index ] ) >>= xChildContainer;
+            if ( xChildContainer.is() )
+                lcl_propagateVBAFormMode( rVal, xChildContainer );
+        }
+    }
+}
+
 // XNameContainer, XNameReplace, XNameAccess
 void UnoControlDialogModel::replaceByName( const ::rtl::OUString& aName, const Any& aElement ) throw(IllegalArgumentException, NoSuchElementException, WrappedTargetException, RuntimeException)
 {
@@ -609,6 +744,21 @@ void UnoControlDialogModel::replaceByName( const ::rtl::OUString& aName, const A
     if ( maModels.end() == aElementPos )
         lcl_throwNoSuchElementException();
 
+    // Dialog behaviour is to have all containee names unique ( MSO Userform is the same )
+    // With container controls you could have constructed an existing hierachy and are now
+    // add this to an existing container, in this case a name nested in the containment
+    // hierachy of the added control could contain a name clash, if we have access to the
+    // list of global names then recursively check for previously existing names ( we need
+    // to do this obviously before the 'this' objects container is updated
+    Reference< XNameContainer > xAllChildren( getPropertyValue( GetPropertyName( BASEPROPERTY_USERFORMCONTAINEES ) ), UNO_QUERY );
+    if ( xAllChildren.is() )
+    {
+        // remove old control ( and children ) from global list of containees
+        updateUserFormChildren( xAllChildren, aName, Remove, uno::Reference< XControlModel >() );
+        // Add new control ( and containees if they exist )
+        updateUserFormChildren( xAllChildren, aName, Insert, xNewModel );
+    }
+    lcl_propagateVBAFormMode( getPropertyValue( GetPropertyName( BASEPROPERTY_VBAFORM ) ), Reference< container::XNameContainer >( xNewModel, UNO_QUERY ) );
     // stop listening at the old model
     stopControlListening( aElementPos->first );
     Reference< XControlModel > xReplaced( aElementPos->first );
@@ -616,6 +766,7 @@ void UnoControlDialogModel::replaceByName( const ::rtl::OUString& aName, const A
     aElementPos->first = xNewModel;
     startControlListening( xNewModel );
 
+
     ContainerEvent aEvent;
     aEvent.Source = *this;
     aEvent.Element = aElement;
@@ -672,11 +823,17 @@ void UnoControlDialogModel::insertByName( const ::rtl::OUString& aName, const An
                 Reference< beans::XPropertySetInfo > xPropInfo = xProps.get()->getPropertySetInfo();
 
                 ::rtl::OUString sImageSourceProperty = GetPropertyName( BASEPROPERTY_IMAGEURL );
-                if ( xPropInfo.get()->hasPropertyByName(  sImageSourceProperty ))
+                if ( xPropInfo.get()->hasPropertyByName( sImageSourceProperty ))
                 {
                     Any aUrl = xProps.get()->getPropertyValue(  sImageSourceProperty );
 
-                    ::rtl::OUString absoluteUrl =
+                    ::rtl::OUString absoluteUrl;
+                    aUrl >>= absoluteUrl;
+                    if ( absoluteUrl.compareToAscii( UNO_NAME_GRAPHOBJ_URLPREFIX, RTL_CONSTASCII_LENGTH( UNO_NAME_GRAPHOBJ_URLPREFIX ) ) == 0 )
+                    xProps.get()->setPropertyValue(  sImageSourceProperty , aUrl );
+                    // Now we inherit from this class, no all containers have
+                    // DialogSourceURL
+                    else if ( getPropertySetInfo()->hasPropertyByName( GetPropertyName( BASEPROPERTY_DIALOGSOURCEURL ) ) )
                         getPhysicalLocation( getPropertyValue( GetPropertyName( BASEPROPERTY_DIALOGSOURCEURL ) ), aUrl );
 
                     aUrl <<= absoluteUrl;
@@ -692,10 +849,26 @@ void UnoControlDialogModel::insertByName( const ::rtl::OUString& aName, const An
         lcl_throwIllegalArgumentException();
 
     UnoControlModelHolderList::iterator aElementPos = ImplFindElement( aName );
+
     if ( maModels.end() != aElementPos )
         lcl_throwElementExistException();
 
+    // Dialog behaviour is to have all containee names unique ( MSO Userform is the same )
+    // With container controls you could have constructed an existing hierachy and are now
+    // add this to an existing container, in this case a name nested in the containment
+    // hierachy of the added control could contain a name clash, if we have access to the
+    // list of global names then we need to recursively check for previously existing
+    // names ( we need to do this obviously before the 'this' objects container is updated
+    // remove old control ( and children ) from global list of containees
+    Reference< XNameContainer > xAllChildren( getPropertyValue( GetPropertyName( BASEPROPERTY_USERFORMCONTAINEES ) ), UNO_QUERY );
+
+    if ( xAllChildren.is() )
+        updateUserFormChildren( xAllChildren, aName, Insert, xM );
+
+    lcl_propagateVBAFormMode( getPropertyValue( GetPropertyName( BASEPROPERTY_VBAFORM ) ), Reference< container::XNameContainer >( xM, UNO_QUERY ) );
     maModels.push_back( UnoControlModelHolder( xM, aName ) );
+
+
     mbGroupsUpToDate = sal_False;
     startControlListening( xM );
 
@@ -717,6 +890,15 @@ void UnoControlDialogModel::removeByName( const ::rtl::OUString& aName ) throw(N
     if ( maModels.end() == aElementPos )
         lcl_throwNoSuchElementException();
 
+    // Dialog behaviour is to have all containee names unique ( MSO Userform is the same )
+    // With container controls you could have constructed an existing hierachy and are now
+    // removing this control from an existing container, in this case all nested names in
+    // the containment hierachy of the control to be removed need to be removed from the global
+    // names cache ( we need to do this obviously before the 'this' objects container is updated )
+    Reference< XNameContainer > xAllChildren( getPropertyValue( GetPropertyName( BASEPROPERTY_USERFORMCONTAINEES ) ), UNO_QUERY );
+    if ( xAllChildren.is() )
+        updateUserFormChildren( xAllChildren, aName, Remove, uno::Reference< XControlModel >() );
+
     ContainerEvent aEvent;
     aEvent.Source = *this;
     aEvent.Element <<= aElementPos->first;
@@ -726,6 +908,7 @@ void UnoControlDialogModel::removeByName( const ::rtl::OUString& aName ) throw(N
     stopControlListening( aElementPos->first );
     Reference< XPropertySet > xPS( aElementPos->first, UNO_QUERY );
     maModels.erase( aElementPos );
+
     mbGroupsUpToDate = sal_False;
 
     if ( xPS.is() )
@@ -1384,67 +1567,657 @@ throw ( RuntimeException )
     }
 }
 
-// ============================================================================
-// = class UnoDialogControl
-// ============================================================================
+static ::Size ImplMapPixelToAppFont( OutputDevice* pOutDev, const ::Size& aSize )
+{
+    ::Size aTmp = pOutDev->PixelToLogic( aSize, MAP_APPFONT );
+    return aTmp;
+}
 
-UnoDialogControl::UnoDialogControl() :
-    maTopWindowListeners( *this ),
-    mbWindowListener(false),
-    mbSizeModified(false),
-    mbPosModified(false)
+//	----------------------------------------------------
+//	Helper Method to convert relative url to physical location
+//	----------------------------------------------------
+
+::rtl::OUString getPhysicalLocation( const ::com::sun::star::uno::Any& rbase, const ::com::sun::star::uno::Any& rUrl )
 {
-    maComponentInfos.nWidth = 300;
-    maComponentInfos.nHeight = 450;
-    mxListener = new ResourceListener( Reference< util::XModifyListener >(
-                        static_cast< OWeakObject* >( this ), UNO_QUERY ));
+
+
+    ::rtl::OUString ret;
+
+    ::rtl::OUString baseLocation;
+    ::rtl::OUString url;
+
+    rbase  >>= baseLocation;
+    rUrl  >>= url;
+
+    if ( url.getLength() )
+    {
+        INetURLObject urlObj(baseLocation);
+        urlObj.removeSegment();
+        baseLocation = urlObj.GetMainURL( INetURLObject::NO_DECODE );
+        ::osl::FileBase::getAbsoluteFileURL( baseLocation, url, ret );
+    }
+
+    return ret;
 }
 
-::rtl::OUString UnoDialogControl::GetComponentServiceName()
+
+//	----------------------------------------------------
+//	class MultiPageControl
+//	----------------------------------------------------
+UnoMultiPageControl::UnoMultiPageControl() : maTabListeners( *this )
 {
+    maComponentInfos.nWidth = 280;
+    maComponentInfos.nHeight = 400;
+}
 
-    sal_Bool bDecoration( sal_True );
-    ImplGetPropertyValue( GetPropertyName( BASEPROPERTY_DECORATION )) >>= bDecoration;
-    if ( bDecoration )
-        return ::rtl::OUString::createFromAscii( "Dialog" );
-    else
-        return ::rtl::OUString::createFromAscii( "TabPage" );
+UnoMultiPageControl::~UnoMultiPageControl()
+{
+}
+// XTabListener
+
+void SAL_CALL UnoMultiPageControl::inserted( ::sal_Int32 ID ) throw (RuntimeException)
+{
+}
+void SAL_CALL UnoMultiPageControl::removed( ::sal_Int32 ID ) throw (RuntimeException)
+{
+}
+void SAL_CALL UnoMultiPageControl::changed( ::sal_Int32 ID, const Sequence< NamedValue >& Properties ) throw (RuntimeException)
+{
+}
+void SAL_CALL UnoMultiPageControl::activated( ::sal_Int32 ID ) throw (RuntimeException)
+{
+    ImplSetPropertyValue( GetPropertyName( BASEPROPERTY_MULTIPAGEVALUE ), uno::makeAny( ID ), sal_False );
+
+}
+void SAL_CALL UnoMultiPageControl::deactivated( ::sal_Int32 ID ) throw (RuntimeException)
+{
+}
+void SAL_CALL UnoMultiPageControl::disposing(const EventObject&) throw (RuntimeException)
+{
+}
+
+void SAL_CALL UnoMultiPageControl::dispose() throw (RuntimeException)
+{
+    lang::EventObject aEvt;
+    aEvt.Source = (::cppu::OWeakObject*)this;
+    maTabListeners.disposeAndClear( aEvt );
+    UnoDialogContainerControl::dispose();
+}
+
+// com::sun::star::awt::XSimpleTabController
+::sal_Int32 SAL_CALL UnoMultiPageControl::insertTab() throw (RuntimeException)
+{
+    Reference< XSimpleTabController > xMultiPage( getPeer(), UNO_QUERY );
+    if ( !xMultiPage.is() )
+        throw RuntimeException();
+    return xMultiPage->insertTab();
+}
+
+void SAL_CALL UnoMultiPageControl::removeTab( ::sal_Int32 ID ) throw (IndexOutOfBoundsException, RuntimeException)
+{
+    Reference< XSimpleTabController > xMultiPage( getPeer(), UNO_QUERY );
+    if ( !xMultiPage.is() )
+        throw RuntimeException();
+    xMultiPage->removeTab( ID );
+}
+
+void SAL_CALL UnoMultiPageControl::setTabProps( ::sal_Int32 ID, const Sequence< NamedValue >& Properties ) throw (IndexOutOfBoundsException, RuntimeException)
+{
+    Reference< XSimpleTabController > xMultiPage( getPeer(), UNO_QUERY );
+    if ( !xMultiPage.is() )
+        throw RuntimeException();
+    xMultiPage->setTabProps( ID, Properties );
+}
+
+Sequence< NamedValue > SAL_CALL UnoMultiPageControl::getTabProps( ::sal_Int32 ID ) throw (IndexOutOfBoundsException, RuntimeException)
+{
+    Reference< XSimpleTabController > xMultiPage( getPeer(), UNO_QUERY );
+    if ( !xMultiPage.is() )
+        throw RuntimeException();
+    return xMultiPage->getTabProps( ID );
+}
+
+void SAL_CALL UnoMultiPageControl::activateTab( ::sal_Int32 ID ) throw (IndexOutOfBoundsException, RuntimeException)
+{
+    Reference< XSimpleTabController > xMultiPage( getPeer(), UNO_QUERY );
+    if ( !xMultiPage.is() )
+        throw RuntimeException();
+    xMultiPage->activateTab( ID );
+    ImplSetPropertyValue( GetPropertyName( BASEPROPERTY_MULTIPAGEVALUE ), uno::makeAny( ID ), sal_True );
+
+}
+
+::sal_Int32 SAL_CALL UnoMultiPageControl::getActiveTabID() throw (RuntimeException)
+{
+    Reference< XSimpleTabController > xMultiPage( getPeer(), UNO_QUERY );
+    if ( !xMultiPage.is() )
+        throw RuntimeException();
+    return xMultiPage->getActiveTabID();
+}
+
+void SAL_CALL UnoMultiPageControl::addTabListener( const Reference< XTabListener >& Listener ) throw (RuntimeException)
+{
+    maTabListeners.addInterface( Listener );
+    Reference< XSimpleTabController > xMultiPage( getPeer(), UNO_QUERY );
+    if ( xMultiPage.is()  && maTabListeners.getLength() == 1 )
+        xMultiPage->addTabListener( &maTabListeners );
+}
+
+void SAL_CALL UnoMultiPageControl::removeTabListener( const Reference< XTabListener >& Listener ) throw (RuntimeException)
+{
+    Reference< XSimpleTabController > xMultiPage( getPeer(), UNO_QUERY );
+    if ( xMultiPage.is()  && maTabListeners.getLength() == 1 )
+        xMultiPage->removeTabListener( &maTabListeners );
+    maTabListeners.removeInterface( Listener );
+}
+
+
+// lang::XTypeProvider
+IMPL_XTYPEPROVIDER_START( UnoMultiPageControl )
+    getCppuType( ( uno::Reference< awt::XSimpleTabController>* ) NULL ),
+    getCppuType( ( uno::Reference< awt::XTabListener>* ) NULL ),
+    UnoDialogContainerControl::getTypes()
+IMPL_XTYPEPROVIDER_END
+
+// uno::XInterface
+uno::Any UnoMultiPageControl::queryAggregation( const uno::Type & rType ) throw(uno::RuntimeException)
+{
+    uno::Any aRet = ::cppu::queryInterface( rType,
+                                        SAL_STATIC_CAST( awt::XTabListener*, this ), SAL_STATIC_CAST( awt::XSimpleTabController*, this ) );
+    return (aRet.hasValue() ? aRet : UnoDialogContainerControl::queryAggregation( rType ));
+}
+
+::rtl::OUString UnoMultiPageControl::GetComponentServiceName()
+{
+        sal_Bool bDecoration( sal_True );
+        ImplGetPropertyValue( GetPropertyName( BASEPROPERTY_DECORATION )) >>= bDecoration;
+        if ( bDecoration )
+        return ::rtl::OUString::createFromAscii( "tabcontrol" );
+        // Hopefully we can tweak the tabcontrol to display without tabs
+    return ::rtl::OUString::createFromAscii( "tabcontrolnotabs" );
+}
+
+void UnoMultiPageControl::bindPage( const uno::Reference< awt::XControl >& _rxControl )
+{
+    uno::Reference< awt::XWindowPeer > xPage( _rxControl->getPeer() );
+    uno::Reference< awt::XSimpleTabController > xTabCntrl( getPeer(), uno::UNO_QUERY );
+    uno::Reference< beans::XPropertySet > xProps( _rxControl->getModel(), uno::UNO_QUERY );
+
+   VCLXTabPage* pXPage = dynamic_cast< VCLXTabPage* >( xPage.get() );
+   TabPage* pPage = pXPage ? pXPage->getTabPage() : NULL;
+    if ( xTabCntrl.is() && pPage )
+    {
+        VCLXMultiPage* pXTab = dynamic_cast< VCLXMultiPage* >( xTabCntrl.get() );
+        if ( pXTab )
+        {
+            rtl::OUString sTitle;
+            xProps->getPropertyValue( GetPropertyName( BASEPROPERTY_TITLE ) ) >>= sTitle;
+            pXTab->insertTab( pPage, sTitle);
+        }
+    }
+
+}
+
+void UnoMultiPageControl::createPeer( const Reference< XToolkit > & rxToolkit, const Reference< XWindowPeer >  & rParentPeer ) throw(RuntimeException)
+{
+    vos::OGuard aSolarGuard( Application::GetSolarMutex() );
+    UnoControlContainer::createPeer( rxToolkit, rParentPeer );
+
+    uno::Sequence< uno::Reference< awt::XControl > > aCtrls = getControls();
+    sal_uInt32 nCtrls = aCtrls.getLength();
+    for( sal_uInt32 n = 0; n < nCtrls; n++ )
+       bindPage( aCtrls[ n ] );
+    sal_Int32 nActiveTab(0);
+    Reference< XPropertySet > xMultiProps( getModel(), UNO_QUERY );
+    xMultiProps->getPropertyValue( GetPropertyName( BASEPROPERTY_MULTIPAGEVALUE ) ) >>= nActiveTab;
+
+    uno::Reference< awt::XSimpleTabController > xTabCntrl( getPeer(), uno::UNO_QUERY );
+    if ( xTabCntrl.is() )
+    {
+        xTabCntrl->addTabListener( this );
+        if ( nActiveTab && nCtrls ) // Ensure peer is initialise with correct activated tab
+        {
+            xTabCntrl->activateTab( nActiveTab );
+            ImplSetPropertyValue( GetPropertyName( BASEPROPERTY_MULTIPAGEVALUE ), uno::makeAny( nActiveTab ), sal_True );
+        }
+    }
+}
+
+void    UnoMultiPageControl::impl_createControlPeerIfNecessary( const uno::Reference< awt::XControl >& _rxControl)
+{
+    OSL_PRECOND( _rxControl.is(), "UnoMultiPageControl::impl_createControlPeerIfNecessary: invalid control, this will crash!" );
+
+    // if the container already has a peer, then also create a peer for the control
+    uno::Reference< awt::XWindowPeer > xMyPeer( getPeer() );
+
+    if( xMyPeer.is() )
+    {
+        _rxControl->createPeer( NULL, xMyPeer );
+        bindPage( _rxControl );
+        ImplActivateTabControllers();
+    }
+
+}
+
+// ------------- UnoMultiPageModel -----------------
+
+UnoMultiPageModel::UnoMultiPageModel() : UnoControlDialogModel( false )
+{
+    ImplRegisterProperty( BASEPROPERTY_DEFAULTCONTROL );
+    ImplRegisterProperty( BASEPROPERTY_BACKGROUNDCOLOR );
+    ImplRegisterProperty( BASEPROPERTY_ENABLEVISIBLE );
+    ImplRegisterProperty( BASEPROPERTY_ENABLED );
+
+    ImplRegisterProperty( BASEPROPERTY_FONTDESCRIPTOR );
+    ImplRegisterProperty( BASEPROPERTY_HELPTEXT );
+    ImplRegisterProperty( BASEPROPERTY_HELPURL );
+    ImplRegisterProperty( BASEPROPERTY_SIZEABLE );
+    //ImplRegisterProperty( BASEPROPERTY_DIALOGSOURCEURL );
+    ImplRegisterProperty( BASEPROPERTY_MULTIPAGEVALUE );
+    ImplRegisterProperty( BASEPROPERTY_PRINTABLE );
+    ImplRegisterProperty( BASEPROPERTY_USERFORMCONTAINEES );
+
+    Any aBool;
+    aBool <<= (sal_Bool) sal_False;
+    ImplRegisterProperty( BASEPROPERTY_VBAFORM, aBool );
+    aBool <<= (sal_Bool) sal_True;
+    ImplRegisterProperty( BASEPROPERTY_MOVEABLE, aBool );
+    ImplRegisterProperty( BASEPROPERTY_CLOSEABLE, aBool );
+    ImplRegisterProperty( BASEPROPERTY_DECORATION, aBool );
+    // MultiPage Control has the tab stop property. And the default value is True.
+    ImplRegisterProperty( BASEPROPERTY_TABSTOP, aBool );
+}
+
+UnoMultiPageModel::UnoMultiPageModel( const UnoMultiPageModel& rModel )
+    : UnoControlDialogModel( rModel )
+{
+}
+
+UnoMultiPageModel::~UnoMultiPageModel()
+{
+}
+
+UnoControlModel*
+UnoMultiPageModel::Clone() const
+{
+    // clone the container itself
+    UnoMultiPageModel* pClone = new UnoMultiPageModel( *this );
+
+    // clone all children
+    ::std::for_each(
+        maModels.begin(), maModels.end(),
+        CloneControlModel( pClone->maModels )
+    );
+
+    return pClone;
+}
+
+::rtl::OUString UnoMultiPageModel::getServiceName() throw(::com::sun::star::uno::RuntimeException)
+{
+    return ::rtl::OUString::createFromAscii( szServiceName_UnoMultiPageModel );
+}
+
+uno::Any UnoMultiPageModel::ImplGetDefaultValue( sal_uInt16 nPropId ) const
+{
+    if ( nPropId == BASEPROPERTY_DEFAULTCONTROL )
+    {
+        uno::Any aAny;
+        aAny <<= ::rtl::OUString::createFromAscii( szServiceName_UnoMultiPageControl );
+        return aAny;
+    }
+    return UnoControlDialogModel::ImplGetDefaultValue( nPropId );
+}
+
+::cppu::IPropertyArrayHelper& UnoMultiPageModel::getInfoHelper()
+{
+    static UnoPropertyArrayHelper* pHelper = NULL;
+    if ( !pHelper )
+    {
+        uno::Sequence<sal_Int32>	aIDs = ImplGetPropertyIds();
+        pHelper = new UnoPropertyArrayHelper( aIDs );
+    }
+    return *pHelper;
+}
+
+// beans::XMultiPropertySet
+uno::Reference< beans::XPropertySetInfo > UnoMultiPageModel::getPropertySetInfo(  ) throw(uno::RuntimeException)
+{
+    static uno::Reference< beans::XPropertySetInfo > xInfo( createPropertySetInfo( getInfoHelper() ) );
+    return xInfo;
+}
+
+void UnoMultiPageModel::insertByName( const ::rtl::OUString& aName, const Any& aElement ) throw(IllegalArgumentException, ElementExistException, WrappedTargetException, RuntimeException)
+{
+    Reference< XServiceInfo > xInfo;
+    aElement >>= xInfo;
+
+    if ( !xInfo.is() )
+        throw IllegalArgumentException();
+
+    // Only a Page model can be inserted into the multipage
+    if ( !xInfo->supportsService( rtl::OUString::createFromAscii( szServiceName_UnoPageModel ) ) )
+        throw IllegalArgumentException();
+
+    return UnoControlDialogModel::insertByName( aName, aElement );
+}
+
+// ----------------------------------------------------------------------------
+sal_Bool SAL_CALL UnoMultiPageModel::getGroupControl(  ) throw (RuntimeException)
+{
+    return sal_True;
+}
+
+//	----------------------------------------------------
+//	class UnoPageControl
+//	----------------------------------------------------
+UnoPageControl::UnoPageControl()
+{
+    maComponentInfos.nWidth = 280;
+    maComponentInfos.nHeight = 400;
+}
+
+UnoPageControl::~UnoPageControl()
+{
+}
+
+::rtl::OUString UnoPageControl::GetComponentServiceName()
+{
+    return ::rtl::OUString::createFromAscii( "tabpage" );
+}
+
+
+// ------------- UnoPageModel -----------------
+
+UnoPageModel::UnoPageModel() : UnoControlDialogModel( false )
+{
+    ImplRegisterProperty( BASEPROPERTY_DEFAULTCONTROL );
+    ImplRegisterProperty( BASEPROPERTY_BACKGROUNDCOLOR );
+    ImplRegisterProperty( BASEPROPERTY_ENABLED );
+    ImplRegisterProperty( BASEPROPERTY_ENABLEVISIBLE );
+
+    ImplRegisterProperty( BASEPROPERTY_FONTDESCRIPTOR );
+    ImplRegisterProperty( BASEPROPERTY_HELPTEXT );
+    ImplRegisterProperty( BASEPROPERTY_HELPURL );
+    ImplRegisterProperty( BASEPROPERTY_TITLE );
+    ImplRegisterProperty( BASEPROPERTY_SIZEABLE );
+    ImplRegisterProperty( BASEPROPERTY_PRINTABLE );
+    ImplRegisterProperty( BASEPROPERTY_USERFORMCONTAINEES );
+//    ImplRegisterProperty( BASEPROPERTY_DIALOGSOURCEURL );
+
+    Any aBool;
+    aBool <<= (sal_Bool) sal_False;
+    ImplRegisterProperty( BASEPROPERTY_VBAFORM, aBool );
+    aBool <<= (sal_Bool) sal_True;
+    ImplRegisterProperty( BASEPROPERTY_MOVEABLE, aBool );
+    ImplRegisterProperty( BASEPROPERTY_CLOSEABLE, aBool );
+    //ImplRegisterProperty( BASEPROPERTY_TABSTOP, aBool );
+}
+
+UnoPageModel::UnoPageModel( const UnoPageModel& rModel )
+    : UnoControlDialogModel( rModel )
+{
+}
+
+UnoPageModel::~UnoPageModel()
+{
+}
+
+UnoControlModel*
+UnoPageModel::Clone() const
+{
+    // clone the container itself
+    UnoPageModel* pClone = new UnoPageModel( *this );
+
+    // clone all children
+    ::std::for_each(
+        maModels.begin(), maModels.end(),
+        CloneControlModel( pClone->maModels )
+    );
+
+    return pClone;
+}
+
+::rtl::OUString UnoPageModel::getServiceName() throw(::com::sun::star::uno::RuntimeException)
+{
+    return ::rtl::OUString::createFromAscii( szServiceName_UnoPageModel );
+}
+
+uno::Any UnoPageModel::ImplGetDefaultValue( sal_uInt16 nPropId ) const
+{
+    if ( nPropId == BASEPROPERTY_DEFAULTCONTROL )
+    {
+        uno::Any aAny;
+        aAny <<= ::rtl::OUString::createFromAscii( szServiceName_UnoPageControl );
+        return aAny;
+    }
+    return UnoControlDialogModel::ImplGetDefaultValue( nPropId );
+}
+
+::cppu::IPropertyArrayHelper& UnoPageModel::getInfoHelper()
+{
+    static UnoPropertyArrayHelper* pHelper = NULL;
+    if ( !pHelper )
+    {
+        uno::Sequence<sal_Int32>	aIDs = ImplGetPropertyIds();
+        pHelper = new UnoPropertyArrayHelper( aIDs );
+    }
+    return *pHelper;
+}
+
+// beans::XMultiPropertySet
+uno::Reference< beans::XPropertySetInfo > UnoPageModel::getPropertySetInfo(  ) throw(uno::RuntimeException)
+{
+    static uno::Reference< beans::XPropertySetInfo > xInfo( createPropertySetInfo( getInfoHelper() ) );
+    return xInfo;
+}
+
+// ----------------------------------------------------------------------------
+sal_Bool SAL_CALL UnoPageModel::getGroupControl(  ) throw (RuntimeException)
+{
+    return sal_False;
+}
+
+// Frame control
+
+//	----------------------------------------------------
+//	class UnoFrameControl
+//	----------------------------------------------------
+UnoFrameControl::UnoFrameControl()
+{
+    maComponentInfos.nWidth = 280;
+    maComponentInfos.nHeight = 400;
+}
+
+UnoFrameControl::~UnoFrameControl()
+{
+}
+
+::rtl::OUString UnoFrameControl::GetComponentServiceName()
+{
+    return ::rtl::OUString::createFromAscii( "frame" );
+}
+
+void UnoFrameControl::ImplSetPosSize( Reference< XControl >& rxCtrl )
+{
+    bool bOwnCtrl = false;
+    rtl::OUString sTitle;
+    if ( rxCtrl.get() == Reference<XControl>( this ).get() )
+        bOwnCtrl = true;
+    Reference< XPropertySet > xProps( getModel(), UNO_QUERY );
+    //xProps->getPropertyValue( GetPropertyName( BASEPROPERTY_TITLE ) ) >>= sTitle;
+    xProps->getPropertyValue( GetPropertyName( BASEPROPERTY_LABEL ) ) >>= sTitle;
+
+    UnoDialogContainerControl::ImplSetPosSize( rxCtrl );
+    Reference < XWindow > xW( rxCtrl, UNO_QUERY );
+    if ( !bOwnCtrl && xW.is() && sTitle.getLength() )
+    {
+        awt::Rectangle aSizePos = xW->getPosSize();
+
+        sal_Int32 nX = aSizePos.X, nY = aSizePos.Y, nWidth = aSizePos.Width, nHeight = aSizePos.Height;
+        // Retrieve the values set by the base class
+        OutputDevice*pOutDev = Application::GetDefaultDevice();
+        if ( pOutDev )
+        {
+            if ( !bOwnCtrl && sTitle.getLength() )
+            {
+                // Adjust Y based on height of Title
+                ::Rectangle aRect = pOutDev->GetTextRect( aRect, sTitle );
+                nY = nY + ( aRect.GetHeight() / 2 );
+            }
+        }
+        else
+        {
+            Reference< XWindowPeer > xPeer = ImplGetCompatiblePeer( sal_True );
+            Reference< XDevice > xD( xPeer, UNO_QUERY );
+
+            SimpleFontMetric aFM;
+            FontDescriptor aFD;
+            Any aVal = ImplGetPropertyValue( GetPropertyName( BASEPROPERTY_FONTDESCRIPTOR ) );
+            aVal >>= aFD;
+            if ( aFD.StyleName.getLength() )
+            {
+                Reference< XFont > xFont = xD->getFont( aFD );
+                aFM = xFont->getFontMetric();
+            }
+            else
+            {
+                Reference< XGraphics > xG = xD->createGraphics();
+                aFM = xG->getFontMetric();
+            }
+
+            sal_Int16 nH = aFM.Ascent + aFM.Descent;
+            if ( !bOwnCtrl && sTitle.getLength() )
+                // offset y based on height of font ( not sure if my guess at the correct calculation is correct here )
+                nY = nY + ( nH / 8); // how do I test this
+        }
+        xW->setPosSize( nX, nY, nWidth, nHeight, PosSize::POSSIZE );
+    }
+}
+
+// ------------- UnoFrameModel -----------------
+
+UnoFrameModel::UnoFrameModel() : UnoControlDialogModel( false )
+{
+    ImplRegisterProperty( BASEPROPERTY_DEFAULTCONTROL );
+    ImplRegisterProperty( BASEPROPERTY_BACKGROUNDCOLOR );
+    ImplRegisterProperty( BASEPROPERTY_ENABLED );
+    ImplRegisterProperty( BASEPROPERTY_ENABLEVISIBLE );
+    ImplRegisterProperty( BASEPROPERTY_FONTDESCRIPTOR );
+    ImplRegisterProperty( BASEPROPERTY_HELPTEXT );
+    ImplRegisterProperty( BASEPROPERTY_HELPURL );
+    ImplRegisterProperty( BASEPROPERTY_PRINTABLE );
+    ImplRegisterProperty( BASEPROPERTY_LABEL );
+    ImplRegisterProperty( BASEPROPERTY_WRITING_MODE );
+    ImplRegisterProperty( BASEPROPERTY_CONTEXT_WRITING_MODE );
+    ImplRegisterProperty( BASEPROPERTY_USERFORMCONTAINEES );
+    Any aBool;
+    aBool <<= (sal_Bool) sal_False;
+    ImplRegisterProperty( BASEPROPERTY_VBAFORM, aBool );
+}
+
+UnoFrameModel::UnoFrameModel( const UnoFrameModel& rModel )
+    : UnoControlDialogModel( rModel )
+{
+}
+
+UnoFrameModel::~UnoFrameModel()
+{
+}
+
+UnoControlModel*
+UnoFrameModel::Clone() const
+{
+    // clone the container itself
+    UnoFrameModel* pClone = new UnoFrameModel( *this );
+
+    // clone all children
+    ::std::for_each(
+        maModels.begin(), maModels.end(),
+        CloneControlModel( pClone->maModels )
+    );
+
+    return pClone;
+}
+
+::rtl::OUString UnoFrameModel::getServiceName() throw(::com::sun::star::uno::RuntimeException)
+{
+    return ::rtl::OUString::createFromAscii( szServiceName_UnoFrameModel );
+}
+
+uno::Any UnoFrameModel::ImplGetDefaultValue( sal_uInt16 nPropId ) const
+{
+    if ( nPropId == BASEPROPERTY_DEFAULTCONTROL )
+    {
+        uno::Any aAny;
+        aAny <<= ::rtl::OUString::createFromAscii( szServiceName_UnoFrameControl );
+        return aAny;
+    }
+    return UnoControlDialogModel::ImplGetDefaultValue( nPropId );
+}
+
+::cppu::IPropertyArrayHelper& UnoFrameModel::getInfoHelper()
+{
+    static UnoPropertyArrayHelper* pHelper = NULL;
+    if ( !pHelper )
+    {
+        uno::Sequence<sal_Int32>	aIDs = ImplGetPropertyIds();
+        pHelper = new UnoPropertyArrayHelper( aIDs );
+    }
+    return *pHelper;
+}
+
+// beans::XMultiPropertySet
+uno::Reference< beans::XPropertySetInfo > UnoFrameModel::getPropertySetInfo(  ) throw(uno::RuntimeException)
+{
+    static uno::Reference< beans::XPropertySetInfo > xInfo( createPropertySetInfo( getInfoHelper() ) );
+    return xInfo;
+}
+
+
+//===============================================================
+//	----------------------------------------------------
+//	class DialogContainerControl
+//	----------------------------------------------------
+UnoDialogContainerControl::UnoDialogContainerControl()
+{
+    maComponentInfos.nWidth = 280;
+    maComponentInfos.nHeight = 400;
+}
+
+UnoDialogContainerControl::~UnoDialogContainerControl()
+{
 }
 
 // XInterface
-Any UnoDialogControl::queryAggregation( const Type & rType ) throw(RuntimeException)
+Any UnoDialogContainerControl::queryAggregation( const Type & rType ) throw(RuntimeException)
 {
-    Any aRet( UnoDialogControl_IBase::queryInterface( rType ) );
+    Any aRet( UnoDialogContainerControl_IBase::queryInterface( rType ) );
     return (aRet.hasValue() ? aRet : UnoControlContainer::queryAggregation( rType ));
 }
 
 // XTypeProvider
-IMPL_IMPLEMENTATION_ID( UnoDialogControl )
-Sequence< Type > UnoDialogControl::getTypes() throw(RuntimeException)
+IMPL_IMPLEMENTATION_ID( UnoDialogContainerControl )
+Sequence< Type >
+UnoDialogContainerControl::getTypes() throw(RuntimeException)
 {
     return ::comphelper::concatSequences(
-        UnoDialogControl_IBase::getTypes(),
+        UnoDialogContainerControl_IBase::getTypes(),
         UnoControlContainer::getTypes()
     );
 }
 
-void UnoDialogControl::ImplInsertControl( Reference< XControlModel >& rxModel, const ::rtl::OUString& rName )
+void UnoDialogContainerControl::createPeer( const Reference< XToolkit > & rxToolkit, const Reference< XWindowPeer >  & rParentPeer ) throw(RuntimeException)
+{
+    vos::OGuard aSolarGuard( Application::GetSolarMutex() );
+    UnoControlContainer::createPeer( rxToolkit, rParentPeer );
+}
+
+void UnoDialogContainerControl::ImplInsertControl( Reference< XControlModel >& rxModel, const ::rtl::OUString& rName )
 {
     Reference< XPropertySet > xP( rxModel, UNO_QUERY );
 
     ::rtl::OUString aDefCtrl;
     xP->getPropertyValue( GetPropertyName( BASEPROPERTY_DEFAULTCONTROL ) ) >>= aDefCtrl;
-
-    // Add our own resource resolver to a newly created control
-    Reference< resource::XStringResourceResolver > xStringResourceResolver;
-    rtl::OUString aPropName( PROPERTY_RESOURCERESOLVER );
-
-    Any aAny;
-    ImplGetPropertyValue( aPropName ) >>= xStringResourceResolver;
-
-    aAny <<= xStringResourceResolver;
-    xP->setPropertyValue( aPropName, aAny );
-
     Reference< XMultiServiceFactory > xMSF = ::comphelper::getProcessServiceFactory();
     Reference < XControl > xCtrl( xMSF->createInstance( aDefCtrl ), UNO_QUERY );
 
@@ -1461,7 +2234,7 @@ void UnoDialogControl::ImplInsertControl( Reference< XControlModel >& rxModel, c
     }
 }
 
-void UnoDialogControl::ImplRemoveControl( Reference< XControlModel >& rxModel )
+void UnoDialogContainerControl::ImplRemoveControl( Reference< XControlModel >& rxModel )
 {
     Sequence< Reference< XControl > > aControls = getControls();
     Reference< XControl > xCtrl = StdTabController::FindControl( aControls, rxModel );
@@ -1469,7 +2242,7 @@ void UnoDialogControl::ImplRemoveControl( Reference< XControlModel >& rxModel )
         removeControl( xCtrl );
 }
 
-void UnoDialogControl::ImplSetPosSize( Reference< XControl >& rxCtrl )
+void UnoDialogContainerControl::ImplSetPosSize( Reference< XControl >& rxCtrl )
 {
     Reference< XPropertySet > xP( rxCtrl->getModel(), UNO_QUERY );
 
@@ -1479,8 +2252,6 @@ void UnoDialogControl::ImplSetPosSize( Reference< XControl >& rxCtrl )
     xP->getPropertyValue( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( "Width" ) ) ) >>= nWidth;
     xP->getPropertyValue( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( "Height" ) ) ) >>= nHeight;
 
-    // Currentley we are simply using MAP_APPFONT ( for normal Dialogs )
-    // and MAP_100TH_MM for imported Userforms
     MapMode aMode( MAP_APPFONT );
     sal_Bool bVBAForm = sal_False;
     Reference< XPropertySet > xDlgModelProps( getModel(), UNO_QUERY );
@@ -1496,6 +2267,7 @@ void UnoDialogControl::ImplSetPosSize( Reference< XControl >& rxCtrl )
     }
     if ( bVBAForm )
         aMode = MapMode( MAP_100TH_MM );
+
     OutputDevice*pOutDev = Application::GetDefaultDevice();
     if ( pOutDev )
     {
@@ -1544,53 +2316,19 @@ void UnoDialogControl::ImplSetPosSize( Reference< XControl >& rxCtrl )
     xW->setPosSize( nX, nY, nWidth, nHeight, PosSize::POSSIZE );
 }
 
-void UnoDialogControl::dispose() throw(RuntimeException)
+void UnoDialogContainerControl::dispose() throw(RuntimeException)
 {
-    vos::OGuard aSolarGuard( Application::GetSolarMutex() );
-
-    EventObject aEvt;
-    aEvt.Source = static_cast< ::cppu::OWeakObject* >( this );
-    maTopWindowListeners.disposeAndClear( aEvt );
-
-    // Notify our listener helper about dispose
-    // --- SAFE ---
-    ::osl::ResettableGuard< ::osl::Mutex > aGuard( GetMutex() );
-    Reference< XEventListener > xListener( mxListener, UNO_QUERY );
-    mxListener.clear();
-    aGuard.clear();
-    // --- SAFE ---
-
-    if ( xListener.is() )
-        xListener->disposing( aEvt );
-
     UnoControlContainer::dispose();
 }
 
-void SAL_CALL UnoDialogControl::disposing(
+void SAL_CALL UnoDialogContainerControl::disposing(
     const EventObject& Source )
 throw(RuntimeException)
 {
-    rtl::OUString aPropName( PROPERTY_RESOURCERESOLVER );
-    Reference< resource::XStringResourceResolver > xStringResourceResolver;
-
-    ImplGetPropertyValue( aPropName ) >>= xStringResourceResolver;
-    Reference< XInterface > xIfac( xStringResourceResolver, UNO_QUERY );
-
-    if ( Source.Source == xIfac )
-    {
-        Any aAny;
-
-        // Reset resource resolver reference
-        ImplSetPropertyValue( aPropName, aAny, sal_True );
-        ImplUpdateResourceResolver();
-    }
-    else
-    {
-        UnoControlContainer::disposing( Source );
-    }
+    UnoControlContainer::disposing( Source );
 }
 
-sal_Bool UnoDialogControl::setModel( const Reference< XControlModel >& rxModel ) throw(RuntimeException)
+sal_Bool UnoDialogContainerControl::setModel( const Reference< XControlModel >& rxModel ) throw(RuntimeException)
 {
     vos::OGuard aSolarGuard( Application::GetSolarMutex() );
 
@@ -1659,12 +2397,11 @@ sal_Bool UnoDialogControl::setModel( const Reference< XControlModel >& rxModel )
         mxTabController->setModel( xTabbing );
         addTabController( mxTabController );
     }
-    ImplStartListingForResourceEvents();
+//    ImplStartListingForResourceEvents();
 
     return bRet;
 }
-
-void UnoDialogControl::setDesignMode( sal_Bool bOn ) throw(RuntimeException)
+void UnoDialogContainerControl::setDesignMode( sal_Bool bOn ) throw(RuntimeException)
 {
     vos::OGuard aSolarGuard( Application::GetSolarMutex() );
     ::osl::Guard< ::osl::Mutex > aGuard( GetMutex() );
@@ -1684,6 +2421,252 @@ void UnoDialogControl::setDesignMode( sal_Bool bOn ) throw(RuntimeException)
         mxTabController->activateTabOrder();
 }
 
+void UnoDialogContainerControl::elementInserted( const ContainerEvent& Event ) throw(RuntimeException)
+{
+    vos::OGuard aSolarGuard( Application::GetSolarMutex() );
+
+    Reference< XControlModel > xModel;
+    ::rtl::OUString aName;
+
+    Event.Accessor >>= aName;
+    Event.Element >>= xModel;
+    ImplInsertControl( xModel, aName );
+}
+
+void UnoDialogContainerControl::elementRemoved( const ContainerEvent& Event ) throw(RuntimeException)
+{
+    vos::OGuard aSolarGuard( Application::GetSolarMutex() );
+
+    Reference< XControlModel > xModel;
+    Event.Element >>= xModel;
+    if ( xModel.is() )
+        ImplRemoveControl( xModel );
+}
+
+void UnoDialogContainerControl::elementReplaced( const ContainerEvent& Event ) throw(RuntimeException)
+{
+    vos::OGuard aSolarGuard( Application::GetSolarMutex() );
+
+    Reference< XControlModel > xModel;
+    Event.ReplacedElement >>= xModel;
+    if ( xModel.is() )
+        ImplRemoveControl( xModel );
+
+    ::rtl::OUString aName;
+    Event.Accessor >>= aName;
+    Event.Element >>= xModel;
+    ImplInsertControl( xModel, aName );
+}
+
+// XPropertiesChangeListener
+void UnoDialogContainerControl::ImplModelPropertiesChanged( const Sequence< PropertyChangeEvent >& rEvents ) throw(RuntimeException)
+{
+    if( !isDesignMode() && !mbCreatingCompatiblePeer )
+    {
+        ::rtl::OUString s1( RTL_CONSTASCII_USTRINGPARAM( "PositionX" ) );
+        ::rtl::OUString s2( RTL_CONSTASCII_USTRINGPARAM( "PositionY" ) );
+        ::rtl::OUString s3( RTL_CONSTASCII_USTRINGPARAM( "Width" ) );
+        ::rtl::OUString s4( RTL_CONSTASCII_USTRINGPARAM( "Height" ) );
+
+        sal_Int32 nLen = rEvents.getLength();
+        for( sal_Int32 i = 0; i < nLen; i++ )
+        {
+            const PropertyChangeEvent& rEvt = rEvents.getConstArray()[i];
+            Reference< XControlModel > xModel( rEvt.Source, UNO_QUERY );
+            sal_Bool bOwnModel = (XControlModel*)xModel.get() == (XControlModel*)getModel().get();
+            if ( ( rEvt.PropertyName == s1 ) ||
+                 ( rEvt.PropertyName == s2 ) ||
+                 ( rEvt.PropertyName == s3 ) ||
+                 ( rEvt.PropertyName == s4 ) )
+            {
+                if ( bOwnModel )
+                {
+                        // Don't set new pos/size if we get new values from window listener
+                        Reference< XControl > xThis( (XAggregation*)(::cppu::OWeakAggObject*)this, UNO_QUERY );
+                        ImplSetPosSize( xThis );
+                }
+                else
+                {
+                    Sequence<Reference<XControl> > aControlSequence(getControls());
+                    Reference<XControl> aControlRef( StdTabController::FindControl( aControlSequence, xModel ) );
+                    ImplSetPosSize( aControlRef );
+                }
+                break;
+            }
+        }
+    }
+    UnoControlContainer::ImplModelPropertiesChanged( rEvents );
+}
+
+void UnoDialogContainerControl::addingControl( const Reference< XControl >& _rxControl )
+{
+    vos::OGuard aSolarGuard( Application::GetSolarMutex() );
+    UnoControlContainer::addingControl( _rxControl );
+
+    if ( _rxControl.is() )
+    {
+        Reference< XMultiPropertySet > xProps( _rxControl->getModel(), UNO_QUERY );
+        if ( xProps.is() )
+        {
+            Sequence< ::rtl::OUString > aNames( 4 );
+            ::rtl::OUString* pNames = aNames.getArray();
+            *pNames++ = ::rtl::OUString::createFromAscii( "PositionX" );
+            *pNames++ = ::rtl::OUString::createFromAscii( "PositionY" );
+            *pNames++ = ::rtl::OUString::createFromAscii( "Width" );
+            *pNames++ = ::rtl::OUString::createFromAscii( "Height" );
+
+            xProps->addPropertiesChangeListener( aNames, this );
+        }
+    }
+}
+
+void UnoDialogContainerControl::removingControl( const Reference< XControl >& _rxControl )
+{
+    vos::OGuard aSolarGuard( Application::GetSolarMutex() );
+    UnoControlContainer::removingControl( _rxControl );
+
+    if ( _rxControl.is() )
+    {
+        Reference< XMultiPropertySet > xProps( _rxControl->getModel(), UNO_QUERY );
+        if ( xProps.is() )
+            xProps->removePropertiesChangeListener( this );
+    }
+
+}
+
+void SAL_CALL UnoDialogContainerControl::changesOccurred( const ChangesEvent& ) throw (RuntimeException)
+{
+    vos::OGuard aSolarGuard( Application::GetSolarMutex() );
+    // a tab controller model may have changed
+
+    // #109067# in design mode don't notify the tab controller
+    // about tab index changes
+    if ( mxTabController.is() && !mbDesignMode )
+        mxTabController->activateTabOrder();
+}
+
+// ============================================================================
+// = class UnoDialogControl
+// ============================================================================
+
+UnoDialogControl::UnoDialogControl() :
+    maTopWindowListeners( *this ),
+    mbWindowListener(false),
+    mbSizeModified(false),
+    mbPosModified(false)
+{
+    maComponentInfos.nWidth = 300;
+    maComponentInfos.nHeight = 450;
+    mxListener = new ResourceListener( Reference< util::XModifyListener >(
+                        static_cast< OWeakObject* >( this ), UNO_QUERY ));
+}
+
+UnoDialogControl::~UnoDialogControl()
+{
+}
+
+::rtl::OUString UnoDialogControl::GetComponentServiceName()
+{
+
+    sal_Bool bDecoration( sal_True );
+    ImplGetPropertyValue( GetPropertyName( BASEPROPERTY_DECORATION )) >>= bDecoration;
+    if ( bDecoration )
+        return ::rtl::OUString::createFromAscii( "Dialog" );
+    else
+        return ::rtl::OUString::createFromAscii( "TabPage" );
+}
+
+// XInterface
+Any UnoDialogControl::queryAggregation( const Type & rType ) throw(RuntimeException)
+{
+        uno::Any aRet = ::cppu::queryInterface( rType, SAL_STATIC_CAST( awt::XTopWindow*, this ) );
+        if ( !aRet.hasValue() )
+            aRet = ::cppu::queryInterface( rType, SAL_STATIC_CAST( awt::XDialog*, this ) );
+        if ( !aRet.hasValue() )
+            aRet = ::cppu::queryInterface( rType, SAL_STATIC_CAST( awt::XWindowListener*, this ) );
+    return (aRet.hasValue() ? aRet : UnoDialogContainerControl::queryAggregation( rType ));
+}
+//lang::XTypeProvider
+IMPL_XTYPEPROVIDER_START( UnoDialogControl)
+    getCppuType( ( uno::Reference< awt::XTopWindow>* ) NULL ),
+    getCppuType( ( uno::Reference< awt::XDialog>* ) NULL ),
+    getCppuType( ( uno::Reference< awt::XWindowListener>* ) NULL ),
+    UnoDialogContainerControl::getTypes()
+IMPL_XTYPEPROVIDER_END
+
+void UnoDialogControl::ImplInsertControl( Reference< XControlModel >& rxModel, const ::rtl::OUString& rName )
+{
+   // maybe this should be in the UnoDialogContainerControl, lets see
+    Reference< XPropertySet > xP( rxModel, UNO_QUERY );
+
+    // Add our own resource resolver to a newly created control
+    Reference< resource::XStringResourceResolver > xStringResourceResolver;
+    rtl::OUString aPropName( PROPERTY_RESOURCERESOLVER );
+
+    Any aAny;
+    ImplGetPropertyValue( aPropName ) >>= xStringResourceResolver;
+
+    aAny <<= xStringResourceResolver;
+    xP->setPropertyValue( aPropName, aAny );
+
+    UnoDialogContainerControl::ImplInsertControl( rxModel, rName );
+
+}
+
+void UnoDialogControl::dispose() throw(RuntimeException)
+{
+    vos::OGuard aSolarGuard( Application::GetSolarMutex() );
+
+    EventObject aEvt;
+    aEvt.Source = static_cast< ::cppu::OWeakObject* >( this );
+    maTopWindowListeners.disposeAndClear( aEvt );
+    // Notify our listener helper about dispose
+    // --- SAFE ---
+    ::osl::ResettableGuard< ::osl::Mutex > aGuard( GetMutex() );
+    Reference< XEventListener > xListener( mxListener, UNO_QUERY );
+    mxListener.clear();
+    aGuard.clear();
+    // --- SAFE ---
+
+    if ( xListener.is() )
+        xListener->disposing( aEvt );
+    UnoDialogContainerControl::dispose();
+}
+
+void SAL_CALL UnoDialogControl::disposing(
+    const EventObject& Source )
+throw(RuntimeException)
+{
+    // #FIXME see what can be moved to  UnoDialogControlContainer
+    rtl::OUString aPropName( PROPERTY_RESOURCERESOLVER );
+    Reference< resource::XStringResourceResolver > xStringResourceResolver;
+
+    ImplGetPropertyValue( aPropName ) >>= xStringResourceResolver;
+    Reference< XInterface > xIfac( xStringResourceResolver, UNO_QUERY );
+
+    if ( Source.Source == xIfac )
+    {
+        Any aAny;
+
+        // Reset resource resolver reference
+        ImplSetPropertyValue( aPropName, aAny, sal_True );
+        ImplUpdateResourceResolver();
+    }
+    else
+    {
+        UnoDialogContainerControl::disposing( Source );
+    }
+}
+
+sal_Bool UnoDialogControl::setModel( const Reference< XControlModel >& rxModel ) throw(RuntimeException)
+{
+        // #Can we move all the Resource stuff to the UnoDialogContainerControl ?
+    vos::OGuard aSolarGuard( Application::GetSolarMutex() );
+        sal_Bool bRet = UnoDialogContainerControl::setModel( rxModel );
+    ImplStartListingForResourceEvents();
+    return bRet;
+}
+
 void UnoDialogControl::createPeer( const Reference< XToolkit > & rxToolkit, const Reference< XWindowPeer >  & rParentPeer ) throw(RuntimeException)
 {
     vos::OGuard aSolarGuard( Application::GetSolarMutex() );
@@ -1723,53 +2706,21 @@ void UnoDialogControl::PrepareWindowDescriptor( ::com::sun::star::awt::WindowDes
     // can lead to overwrites we have to set the graphic property
     // before the propertiesChangeEvents are sent!
     ::rtl::OUString aImageURL;
+    Reference< graphic::XGraphic > xGraphic;
     if (( ImplGetPropertyValue( PROPERTY_IMAGEURL ) >>= aImageURL ) &&
         ( aImageURL.getLength() > 0 ))
     {
-        aImageURL =
-            getPhysicalLocation( ImplGetPropertyValue( PROPERTY_DIALOGSOURCEURL ),
+        ::rtl::OUString absoluteUrl = aImageURL;
+        if ( aImageURL.compareToAscii( UNO_NAME_GRAPHOBJ_URLPREFIX, RTL_CONSTASCII_LENGTH( UNO_NAME_GRAPHOBJ_URLPREFIX ) ) != 0 )
+        {
+            absoluteUrl = getPhysicalLocation( ImplGetPropertyValue( PROPERTY_DIALOGSOURCEURL ),
                                  ImplGetPropertyValue( PROPERTY_IMAGEURL ));
+        }
+        // npower, not understanding the comment above, but it surely setting the URL is just as
+        // effective ( and prevents ambiguity with embedded images )
+        ImplSetPropertyValue( PROPERTY_IMAGEURL, uno::makeAny( absoluteUrl ), sal_True );
 
     }
-    if ( aImageURL.compareToAscii( UNO_NAME_GRAPHOBJ_URLPREFIX, RTL_CONSTASCII_LENGTH( UNO_NAME_GRAPHOBJ_URLPREFIX ) ) != 0 )
-        ImplSetPropertyValue( PROPERTY_IMAGEURL, uno::makeAny( aImageURL ), sal_True );
-}
-
-void UnoDialogControl::elementInserted( const ContainerEvent& Event ) throw(RuntimeException)
-{
-    vos::OGuard aSolarGuard( Application::GetSolarMutex() );
-
-    Reference< XControlModel > xModel;
-    ::rtl::OUString aName;
-
-    Event.Accessor >>= aName;
-    Event.Element >>= xModel;
-    ImplInsertControl( xModel, aName );
-}
-
-void UnoDialogControl::elementRemoved( const ContainerEvent& Event ) throw(RuntimeException)
-{
-    vos::OGuard aSolarGuard( Application::GetSolarMutex() );
-
-    Reference< XControlModel > xModel;
-    Event.Element >>= xModel;
-    if ( xModel.is() )
-        ImplRemoveControl( xModel );
-}
-
-void UnoDialogControl::elementReplaced( const ContainerEvent& Event ) throw(RuntimeException)
-{
-    vos::OGuard aSolarGuard( Application::GetSolarMutex() );
-
-    Reference< XControlModel > xModel;
-    Event.ReplacedElement >>= xModel;
-    if ( xModel.is() )
-        ImplRemoveControl( xModel );
-
-    ::rtl::OUString aName;
-    Event.Accessor >>= aName;
-    Event.Element >>= xModel;
-    ImplInsertControl( xModel, aName );
 }
 
 void UnoDialogControl::addTopWindowListener( const Reference< XTopWindowListener >& rxListener ) throw (RuntimeException)
@@ -1826,12 +2777,6 @@ void UnoDialogControl::setMenuBar( const Reference< XMenuBar >& rxMenuBar ) thro
     }
 }
 
-static ::Size ImplMapPixelToAppFont( OutputDevice* pOutDev, const ::Size& aSize )
-{
-    ::Size aTmp = pOutDev->PixelToLogic( aSize, MAP_APPFONT );
-    return aTmp;
-}
-
 // ::com::sun::star::awt::XWindowListener
 void SAL_CALL UnoDialogControl::windowResized( const ::com::sun::star::awt::WindowEvent& e )
 throw (::com::sun::star::uno::RuntimeException)
@@ -1913,72 +2858,38 @@ throw (::com::sun::star::uno::RuntimeException)
 // XPropertiesChangeListener
 void UnoDialogControl::ImplModelPropertiesChanged( const Sequence< PropertyChangeEvent >& rEvents ) throw(RuntimeException)
 {
-    if( !isDesignMode() && !mbCreatingCompatiblePeer )
-    {
-        ::rtl::OUString s1( RTL_CONSTASCII_USTRINGPARAM( "PositionX" ) );
-        ::rtl::OUString s2( RTL_CONSTASCII_USTRINGPARAM( "PositionY" ) );
-        ::rtl::OUString s3( RTL_CONSTASCII_USTRINGPARAM( "Width" ) );
-        ::rtl::OUString s4( RTL_CONSTASCII_USTRINGPARAM( "Height" ) );
-
-        sal_Int32 nLen = rEvents.getLength();
-        for( sal_Int32 i = 0; i < nLen; i++ )
-        {
-            const PropertyChangeEvent& rEvt = rEvents.getConstArray()[i];
-            Reference< XControlModel > xModel( rEvt.Source, UNO_QUERY );
-            sal_Bool bOwnModel = (XControlModel*)xModel.get() == (XControlModel*)getModel().get();
-            if ( ( rEvt.PropertyName == s1 ) ||
-                 ( rEvt.PropertyName == s2 ) ||
-                 ( rEvt.PropertyName == s3 ) ||
-                 ( rEvt.PropertyName == s4 ) )
-            {
-                if ( bOwnModel )
-                {
-                    if ( !mbPosModified && !mbSizeModified )
-                    {
-                        // Don't set new pos/size if we get new values from window listener
-                        Reference< XControl > xThis( (XAggregation*)(::cppu::OWeakAggObject*)this, UNO_QUERY );
-                        ImplSetPosSize( xThis );
-                    }
-                }
-                else
-                {
-                    Sequence<Reference<XControl> > aControlSequence(getControls());
-                    Reference<XControl> aControlRef( StdTabController::FindControl( aControlSequence, xModel ) );
-                    ImplSetPosSize( aControlRef );
-                }
-                break;
-            }
-            else if ( bOwnModel && rEvt.PropertyName.equalsAsciiL( "ResourceResolver", 16 ))
-            {
-                ImplStartListingForResourceEvents();
-            }
-        }
-    }
-
     sal_Int32 nLen = rEvents.getLength();
     for( sal_Int32 i = 0; i < nLen; i++ )
     {
         const PropertyChangeEvent& rEvt = rEvents.getConstArray()[i];
         Reference< XControlModel > xModel( rEvt.Source, UNO_QUERY );
         sal_Bool bOwnModel = (XControlModel*)xModel.get() == (XControlModel*)getModel().get();
-        if ( bOwnModel && rEvt.PropertyName.equalsAsciiL( "ImageURL", 8 ))
+        if( !isDesignMode() && !mbCreatingCompatiblePeer && bOwnModel )
+        {
+            if ( rEvt.PropertyName.equalsAsciiL( "ResourceResolver", 16 ) )
+                    ImplStartListingForResourceEvents();
+        }
+
+        else if ( bOwnModel && rEvt.PropertyName.equalsAsciiL( "ImageURL", 8 ))
         {
             ::rtl::OUString aImageURL;
+             Reference< graphic::XGraphic > xGraphic;
+            // Ignore GraphicObject urls
             if (( ImplGetPropertyValue( PROPERTY_IMAGEURL ) >>= aImageURL ) &&
                 ( aImageURL.getLength() > 0 ))
             {
-                aImageURL =
-                    getPhysicalLocation( ImplGetPropertyValue( PROPERTY_DIALOGSOURCEURL ),
-                                         ImplGetPropertyValue( PROPERTY_IMAGEURL ));
-
+                ::rtl::OUString absoluteUrl = aImageURL;
+                if ( aImageURL.compareToAscii( UNO_NAME_GRAPHOBJ_URLPREFIX, RTL_CONSTASCII_LENGTH( UNO_NAME_GRAPHOBJ_URLPREFIX ) ) != 0 )
+                {
+                    absoluteUrl = getPhysicalLocation( ImplGetPropertyValue( PROPERTY_DIALOGSOURCEURL ),
+                    ImplGetPropertyValue( PROPERTY_IMAGEURL ));
+                }
+                ImplSetPropertyValue( PROPERTY_IMAGEURL, uno::makeAny( absoluteUrl ), sal_True );
             }
-
-            ImplSetPropertyValue( PROPERTY_IMAGEURL, uno::makeAny( aImageURL ), sal_True );
-            break;
         }
     }
 
-    UnoControlContainer::ImplModelPropertiesChanged( rEvents );
+    UnoDialogContainerControl::ImplModelPropertiesChanged( rEvents );
 }
 
 void UnoDialogControl::ImplStartListingForResourceEvents()
@@ -1997,21 +2908,16 @@ void UnoDialogControl::ImplStartListingForResourceEvents()
     ImplUpdateResourceResolver();
 }
 
-void UnoDialogControl::ImplUpdateResourceResolver()
+void lcl_ApplyResolverToNestedContainees(  const Reference< resource::XStringResourceResolver >& xStringResourceResolver, const Reference< XControlContainer >& xContainer )
 {
     rtl::OUString aPropName( PROPERTY_RESOURCERESOLVER );
-    Reference< resource::XStringResourceResolver > xStringResourceResolver;
-
-    ImplGetPropertyValue( aPropName ) >>= xStringResourceResolver;
-    if ( !xStringResourceResolver.is() )
-        return;
 
     Any xNewStringResourceResolver; xNewStringResourceResolver <<= xStringResourceResolver;
 
     Sequence< rtl::OUString > aPropNames(1);
     aPropNames[0] = aPropName;
 
-    const Sequence< Reference< awt::XControl > > aSeq = getControls();
+    const Sequence< Reference< awt::XControl > > aSeq = xContainer->getControls();
     for ( sal_Int32 i = 0; i < aSeq.getLength(); i++ )
     {
         Reference< XControl > xControl( aSeq[i] );
@@ -2042,8 +2948,26 @@ void UnoDialogControl::ImplUpdateResourceResolver()
         catch ( const Exception& )
         {
         }
+
+        uno::Reference< XControlContainer > xNestedContainer( xControl, uno::UNO_QUERY );
+        if ( xNestedContainer.is() )
+            lcl_ApplyResolverToNestedContainees(  xStringResourceResolver, xNestedContainer );
+
     }
 
+}
+
+void UnoDialogControl::ImplUpdateResourceResolver()
+{
+    rtl::OUString aPropName( PROPERTY_RESOURCERESOLVER );
+    Reference< resource::XStringResourceResolver > xStringResourceResolver;
+
+    ImplGetPropertyValue( aPropName ) >>= xStringResourceResolver;
+    if ( !xStringResourceResolver.is() )
+        return;
+
+    lcl_ApplyResolverToNestedContainees(  xStringResourceResolver, this );
+
     // propagate resource resolver changes to language dependent props of the dialog
     Reference< XPropertySet > xPropertySet( getModel(), UNO_QUERY );
     if ( xPropertySet.is() )
@@ -2099,53 +3023,6 @@ void UnoDialogControl::endExecute() throw(RuntimeException)
     }
 }
 
-void UnoDialogControl::addingControl( const Reference< XControl >& _rxControl )
-{
-    vos::OGuard aSolarGuard( Application::GetSolarMutex() );
-    UnoControlContainer::addingControl( _rxControl );
-
-    if ( _rxControl.is() )
-    {
-        Reference< XMultiPropertySet > xProps( _rxControl->getModel(), UNO_QUERY );
-        if ( xProps.is() )
-        {
-            Sequence< ::rtl::OUString > aNames( 4 );
-            ::rtl::OUString* pNames = aNames.getArray();
-            *pNames++ = ::rtl::OUString::createFromAscii( "PositionX" );
-            *pNames++ = ::rtl::OUString::createFromAscii( "PositionY" );
-            *pNames++ = ::rtl::OUString::createFromAscii( "Width" );
-            *pNames++ = ::rtl::OUString::createFromAscii( "Height" );
-
-            xProps->addPropertiesChangeListener( aNames, this );
-        }
-    }
-}
-
-void UnoDialogControl::removingControl( const Reference< XControl >& _rxControl )
-{
-    vos::OGuard aSolarGuard( Application::GetSolarMutex() );
-    UnoControlContainer::removingControl( _rxControl );
-
-    if ( _rxControl.is() )
-    {
-        Reference< XMultiPropertySet > xProps( _rxControl->getModel(), UNO_QUERY );
-        if ( xProps.is() )
-            xProps->removePropertiesChangeListener( this );
-    }
-
-}
-
-void SAL_CALL UnoDialogControl::changesOccurred( const ChangesEvent& ) throw (RuntimeException)
-{
-    vos::OGuard aSolarGuard( Application::GetSolarMutex() );
-    // a tab controller model may have changed
-
-    // #109067# in design mode don't notify the tab controller
-    // about tab index changes
-    if ( mxTabController.is() && !mbDesignMode )
-        mxTabController->activateTabOrder();
-}
-
 // XModifyListener
 void SAL_CALL UnoDialogControl::modified(
     const lang::EventObject& /*rEvent*/ )
@@ -2154,37 +3031,3 @@ throw (RuntimeException)
     ImplUpdateResourceResolver();
 }
 
-//	----------------------------------------------------
-//	Helper Method to convert relative url to physical location
-//	----------------------------------------------------
-
-::rtl::OUString getPhysicalLocation( const ::com::sun::star::uno::Any& rbase, const ::com::sun::star::uno::Any& rUrl )
-{
-    
-    
-    ::rtl::OUString ret;
-
-    ::rtl::OUString baseLocation;
-    ::rtl::OUString url;
-
-    rbase  >>= baseLocation;
-    rUrl  >>= url;
-
-    if ( url.getLength() > 0 )
-    {
-        // Don't adjust GraphicObject url(s)
-        if ( url.compareToAscii( UNO_NAME_GRAPHOBJ_URLPREFIX, RTL_CONSTASCII_LENGTH( UNO_NAME_GRAPHOBJ_URLPREFIX ) ) != 0 )
-        {
-            INetURLObject urlObj(baseLocation);
-            urlObj.removeSegment();
-            baseLocation = urlObj.GetMainURL( INetURLObject::NO_DECODE );
-            ::osl::FileBase::getAbsoluteFileURL( baseLocation, url, ret );
-        }
-        else
-            ret = url;
-
-    }
-
-    return ret;
-}
-
diff --git a/toolkit/source/controls/unocontrolcontainer.cxx b/toolkit/source/controls/unocontrolcontainer.cxx
index 75a84ee..e38c149 100644
--- a/toolkit/source/controls/unocontrolcontainer.cxx
+++ b/toolkit/source/controls/unocontrolcontainer.cxx
@@ -808,8 +808,8 @@ void UnoControlContainer::createPeer( const uno::Reference< awt::XToolkit >& rxT
                 aCtrls.getArray()[n]->createPeer( rxToolkit, getPeer() );
 
             uno::Reference< awt::XVclContainerPeer >  xC( getPeer(), uno::UNO_QUERY );
-
-            xC->enableDialogControl( sal_True );
+            if ( xC.is() )
+                xC->enableDialogControl( sal_True );
             ImplActivateTabControllers();
         }
 
diff --git a/toolkit/source/controls/unocontrols.cxx b/toolkit/source/controls/unocontrols.cxx
index bae0a52..a62d0c9 100644
--- a/toolkit/source/controls/unocontrols.cxx
+++ b/toolkit/source/controls/unocontrols.cxx
@@ -568,7 +568,7 @@ uno::Any ImageProducerControlModel::ImplGetDefaultValue( sal_uInt16 nPropId ) co
 
     return UnoControlModel::ImplGetDefaultValue( nPropId );
 }
-    uno::Reference< graphic::XGraphic > getGraphicFromURL_nothrow( uno::Reference< graphic::XGraphicObject >& rxGrfObj, const ::rtl::OUString& _rURL )
+    uno::Reference< graphic::XGraphic > ImageHelper::getGraphicAndGraphicObjectFromURL_nothrow( uno::Reference< graphic::XGraphicObject >& xOutGraphicObj, const ::rtl::OUString& _rURL )
     {
         uno::Reference< graphic::XGraphic > xGraphic;
 
@@ -578,10 +578,10 @@ uno::Any ImageProducerControlModel::ImplGetDefaultValue( sal_uInt16 nPropId ) co
             rtl::OUString sID = _rURL.copy( sizeof( UNO_NAME_GRAPHOBJ_URLPREFIX ) - 1 );
             // get the DefaultContext
             ::comphelper::ComponentContext aContext( ::comphelper::getProcessServiceFactory() );
-            rxGrfObj = graphic::GraphicObject::createWithId( aContext.getUNOContext(), sID );
+            xOutGraphicObj = graphic::GraphicObject::createWithId( aContext.getUNOContext(), sID );
         }
         else // linked
-            rxGrfObj = NULL; // release the GraphicObject
+            xOutGraphicObj = NULL; // release the GraphicObject
 
         if ( !_rURL.getLength() )
             return xGraphic;
@@ -606,6 +606,11 @@ uno::Any ImageProducerControlModel::ImplGetDefaultValue( sal_uInt16 nPropId ) co
         return xGraphic;
     }
 
+    uno::Reference< graphic::XGraphic > ImageProducerControlModel::getGraphicFromURL_nothrow( const ::rtl::OUString& _rURL )
+    {
+        return ImageHelper::getGraphicAndGraphicObjectFromURL_nothrow( mxGrfObj, _rURL );
+    }
+
 void SAL_CALL ImageProducerControlModel::setFastPropertyValue_NoBroadcast( sal_Int32 nHandle, const ::com::sun::star::uno::Any& rValue ) throw (::com::sun::star::uno::Exception)
 {
     UnoControlModel::setFastPropertyValue_NoBroadcast( nHandle, rValue );
@@ -622,7 +627,7 @@ void SAL_CALL ImageProducerControlModel::setFastPropertyValue_NoBroadcast( sal_I
                 mbAdjustingGraphic = true;
                 ::rtl::OUString sImageURL;
                 OSL_VERIFY( rValue >>= sImageURL );
-                setPropertyValue( GetPropertyName( BASEPROPERTY_GRAPHIC ), uno::makeAny( getGraphicFromURL_nothrow( mxGrfObj, sImageURL ) ) );
+                setPropertyValue( GetPropertyName( BASEPROPERTY_GRAPHIC ), uno::makeAny( getGraphicFromURL_nothrow( sImageURL ) ) );
                 mbAdjustingGraphic = false;
             }
             break;
@@ -1839,77 +1844,6 @@ sal_Bool UnoGroupBoxControl::isTransparent() throw(uno::RuntimeException)
     return sal_True;
 }
 
-// MultiPage
-
-UnoMultiPageModel::UnoMultiPageModel()
-{
-    ImplRegisterProperty( BASEPROPERTY_DEFAULTCONTROL );
-    ImplRegisterProperty( BASEPROPERTY_ENABLED );
-    ImplRegisterProperty( BASEPROPERTY_FONTDESCRIPTOR );
-    ImplRegisterProperty( BASEPROPERTY_HELPTEXT );
-    ImplRegisterProperty( BASEPROPERTY_HELPURL );
-    ImplRegisterProperty( BASEPROPERTY_LABEL );
-    ImplRegisterProperty( BASEPROPERTY_PRINTABLE );
-    ImplRegisterProperty( BASEPROPERTY_PROGRESSVALUE );
-    ImplRegisterProperty( BASEPROPERTY_PROGRESSVALUE_MAX );
-}
-
-::rtl::OUString UnoMultiPageModel::getServiceName() throw(::com::sun::star::uno::RuntimeException)
-{
-    return ::rtl::OUString::createFromAscii( szServiceName_UnoMultiPageModel );
-}
-
-uno::Any UnoMultiPageModel::ImplGetDefaultValue( sal_uInt16 nPropId ) const
-{
-    if ( nPropId == BASEPROPERTY_DEFAULTCONTROL )
-    {
-        uno::Any aAny;
-        aAny <<= ::rtl::OUString::createFromAscii( szServiceName_UnoControlGroupBox );
-        //aAny <<= ::rtl::OUString::createFromAscii( szServiceName_UnoMultiPageControl );
-        return aAny;
-    }
-    return UnoControlModel::ImplGetDefaultValue( nPropId );
-}
-
-::cppu::IPropertyArrayHelper& UnoMultiPageModel::getInfoHelper()
-{
-    static UnoPropertyArrayHelper* pHelper = NULL;
-    if ( !pHelper )
-    {
-        uno::Sequence<sal_Int32>	aIDs = ImplGetPropertyIds();
-        pHelper = new UnoPropertyArrayHelper( aIDs );
-    }
-    return *pHelper;
-}
-
-// beans::XMultiPropertySet
-uno::Reference< beans::XPropertySetInfo > UnoMultiPageModel::getPropertySetInfo(  ) throw(uno::RuntimeException)
-{
-    static uno::Reference< beans::XPropertySetInfo > xInfo( createPropertySetInfo( getInfoHelper() ) );
-    return xInfo;
-}
-
-//	----------------------------------------------------
-//	class MultiPageControl
-//	----------------------------------------------------
-UnoMultiPageControl::UnoMultiPageControl()
-{
-    maComponentInfos.nWidth = 100;
-    maComponentInfos.nHeight = 100;
-}
-
-::rtl::OUString UnoMultiPageControl::GetComponentServiceName()
-{
-    return ::rtl::OUString::createFromAscii( "multipage" );
-}
-
-sal_Bool UnoMultiPageControl::isTransparent() throw(uno::RuntimeException)
-{
-    return sal_True;
-}
-
-
-
 //	----------------------------------------------------
 //	class UnoControlListBoxModel
 //	----------------------------------------------------
diff --git a/toolkit/source/helper/listenermultiplexer.cxx b/toolkit/source/helper/listenermultiplexer.cxx
index cffa43e..c5c1aa1 100644
--- a/toolkit/source/helper/listenermultiplexer.cxx
+++ b/toolkit/source/helper/listenermultiplexer.cxx
@@ -154,6 +154,21 @@ IMPL_LISTENERMULTIPLEXER_BASEMETHODS( ItemListenerMultiplexer, ::com::sun::star:
 IMPL_LISTENERMULTIPLEXER_LISTENERMETHOD( ItemListenerMultiplexer, ::com::sun::star::awt::XItemListener, itemStateChanged, ::com::sun::star::awt::ItemEvent )
 
 //	----------------------------------------------------
+//	class TabListenerMultiplexer
+//	----------------------------------------------------
+IMPL_LISTENERMULTIPLEXER_BASEMETHODS( TabListenerMultiplexer, ::com::sun::star::awt::XTabListener )
+void TabListenerMultiplexer::inserted( sal_Int32 evt ) throw(::com::sun::star::uno::RuntimeException)
+IMPL_TABLISTENERMULTIPLEXER_LISTENERMETHOD_BODY_1PARAM( TabListenerMultiplexer, ::com::sun::star::awt::XTabListener, inserted, ::sal_Int32 )
+void TabListenerMultiplexer::removed( sal_Int32 evt ) throw(::com::sun::star::uno::RuntimeException)
+IMPL_TABLISTENERMULTIPLEXER_LISTENERMETHOD_BODY_1PARAM( TabListenerMultiplexer, ::com::sun::star::awt::XTabListener, removed, ::sal_Int32 )
+void TabListenerMultiplexer::changed( sal_Int32 evt, const ::com::sun::star::uno::Sequence< ::com::sun::star::beans::NamedValue >& evt2 ) throw(::com::sun::star::uno::RuntimeException)
+IMPL_TABLISTENERMULTIPLEXER_LISTENERMETHOD_BODY_2PARAM( TabListenerMultiplexer, ::com::sun::star::awt::XTabListener, changed, ::sal_Int32, ::com::sun::star::uno::Sequence< ::com::sun::star::beans::NamedValue > )
+void TabListenerMultiplexer::activated( sal_Int32 evt ) throw(::com::sun::star::uno::RuntimeException)
+IMPL_TABLISTENERMULTIPLEXER_LISTENERMETHOD_BODY_1PARAM( TabListenerMultiplexer, ::com::sun::star::awt::XTabListener, activated, ::sal_Int32 )
+void TabListenerMultiplexer::deactivated( sal_Int32 evt ) throw(::com::sun::star::uno::RuntimeException)
+IMPL_TABLISTENERMULTIPLEXER_LISTENERMETHOD_BODY_1PARAM( TabListenerMultiplexer, ::com::sun::star::awt::XTabListener, deactivated, ::sal_Int32 )
+
+//	----------------------------------------------------
 //	class ContainerListenerMultiplexer
 //	----------------------------------------------------
 IMPL_LISTENERMULTIPLEXER_BASEMETHODS( ContainerListenerMultiplexer, ::com::sun::star::container::XContainerListener )
diff --git a/toolkit/source/helper/property.cxx b/toolkit/source/helper/property.cxx
index a3a94ab..2187ab1 100644
--- a/toolkit/source/helper/property.cxx
+++ b/toolkit/source/helper/property.cxx
@@ -54,6 +54,7 @@
 #include <com/sun/star/beans/PropertyAttribute.hpp>
 #include <com/sun/star/graphic/XGraphic.hpp>
 #include <com/sun/star/resource/XStringResourceResolver.hpp>
+#include <com/sun/star/container/XNameContainer.hpp>
 #include <comphelper/types.hxx>
 #include <functional>
 #include <algorithm>
@@ -279,7 +280,9 @@ ImplPropertyInfo* ImplGetPropertyInfos( sal_uInt16& rElementCount )
             DECL_PROP_3     ( "ColumnModel",		GRID_COLUMNMODEL,   Reference< ::com::sun::star::awt::grid::XGridColumnModel >,          BOUND, MAYBEDEFAULT, MAYBEVOID ),
             DECL_PROP_3     ( "SelectionModel",		GRID_SELECTIONMODE,   ::com::sun::star::view::SelectionType,          BOUND, MAYBEDEFAULT, MAYBEVOID ),
             DECL_PROP_2     ( "EnableVisible",          ENABLEVISIBLE,          sal_Bool,           BOUND, MAYBEDEFAULT ),
-            DECL_PROP_2     ( "VBAForm",                VBAFORM,                sal_Bool,           BOUND, MAYBEDEFAULT )
+           DECL_DEP_PROP_3 ( "MultiPageValue",          MULTIPAGEVALUE,      sal_Int32,          BOUND, MAYBEDEFAULT, MAYBEVOID ),
+            DECL_PROP_2     ( "VBAForm",                VBAFORM,                sal_Bool,           BOUND, MAYBEDEFAULT ),
+            DECL_PROP_3     ( "AllDialogChildren",                USERFORMCONTAINEES,                Reference< ::com::sun::star::container::XNameContainer >,           BOUND, MAYBEDEFAULT, MAYBEVOID ),
             };
             pPropertyInfos = aImplPropertyInfos;
             nElements = sizeof( aImplPropertyInfos ) / sizeof( ImplPropertyInfo );
diff --git a/toolkit/source/helper/registerservices.cxx b/toolkit/source/helper/registerservices.cxx
index f3aff67..b0133ab 100644
--- a/toolkit/source/helper/registerservices.cxx
+++ b/toolkit/source/helper/registerservices.cxx
@@ -166,6 +166,8 @@ IMPL_CREATEINSTANCE( UnoControlProgressBarModel )
 IMPL_CREATEINSTANCE( UnoControlScrollBarModel )
 IMPL_CREATEINSTANCE( UnoSpinButtonModel )
 IMPL_CREATEINSTANCE( UnoMultiPageModel )
+IMPL_CREATEINSTANCE( UnoPageModel )
+IMPL_CREATEINSTANCE( UnoFrameModel )
 IMPL_CREATEINSTANCE( UnoControlFixedLineModel )
 IMPL_CREATEINSTANCE( UnoCurrencyFieldControl )
 IMPL_CREATEINSTANCE( UnoDateFieldControl )
@@ -186,6 +188,8 @@ IMPL_CREATEINSTANCE( UnoProgressBarControl )
 IMPL_CREATEINSTANCE( UnoScrollBarControl )
 IMPL_CREATEINSTANCE( UnoSpinButtonControl )
 IMPL_CREATEINSTANCE( UnoMultiPageControl )
+IMPL_CREATEINSTANCE( UnoPageControl )
+IMPL_CREATEINSTANCE( UnoFrameControl )
 IMPL_CREATEINSTANCE( UnoFixedLineControl )
 IMPL_CREATEINSTANCE( VCLXMenuBar )
 IMPL_CREATEINSTANCE( VCLXPointer )
@@ -280,6 +284,10 @@ TOOLKIT_DLLPUBLIC sal_Bool SAL_CALL component_writeInfo( void* _pServiceManager,
         registerServices( xRegistryKey, "UnoSpinButtonControl", szServiceName_UnoSpinButtonControl );
         registerServices( xRegistryKey, "UnoMultiPageModel", szServiceName_UnoMultiPageModel );
         registerServices( xRegistryKey, "UnoMultiPageControl", szServiceName_UnoMultiPageControl );
+        registerServices( xRegistryKey, "UnoPageModel", szServiceName_UnoPageModel );
+        registerServices( xRegistryKey, "UnoPageControl", szServiceName_UnoPageControl );
+        registerServices( xRegistryKey, "UnoFrameModel", szServiceName_UnoFrameModel );
+        registerServices( xRegistryKey, "UnoFrameControl", szServiceName_UnoFrameControl );
         registerServices( xRegistryKey, "UnoFixedLineControl", szServiceName_UnoControlFixedLine, szServiceName2_UnoControlFixedLine );
         registerServices( xRegistryKey, "UnoControlFixedLineModel", szServiceName_UnoControlFixedLineModel, szServiceName2_UnoControlFixedLineModel );
         registerServices( xRegistryKey, "VCLXPrinterServer", szServiceName_PrinterServer, szServiceName2_PrinterServer );
@@ -316,7 +324,6 @@ TOOLKIT_DLLPUBLIC void* SAL_CALL component_getFactory( const sal_Char* sImplemen
     {
         ::com::sun::star::uno::Reference< ::com::sun::star::lang::XMultiServiceFactory > xServiceFactory =
             static_cast< ::com::sun::star::lang::XMultiServiceFactory* >( _pServiceManager );
-
         CHECKANDCREATEFACTORY( VCLXToolkit, szServiceName_Toolkit, szServiceName2_Toolkit )
         CHECKANDCREATEFACTORY( VCLXPopupMenu, szServiceName_PopupMenu, szServiceName2_PopupMenu )
         CHECKANDCREATEFACTORY( VCLXMenuBar, szServiceName_MenuBar, szServiceName2_MenuBar )
@@ -372,6 +379,10 @@ TOOLKIT_DLLPUBLIC void* SAL_CALL component_getFactory( const sal_Char* sImplemen
         CHECKANDCREATEFACTORY( UnoControlRoadmapModel, szServiceName_UnoControlRoadmapModel, szServiceName2_UnoControlRoadmapModel )
         CHECKANDCREATEFACTORY( UnoMultiPageModel, szServiceName_UnoMultiPageModel, NULL )
         CHECKANDCREATEFACTORY( UnoMultiPageControl, szServiceName_UnoMultiPageControl, NULL )
+        CHECKANDCREATEFACTORY( UnoPageModel, szServiceName_UnoPageModel, NULL )
+        CHECKANDCREATEFACTORY( UnoPageControl, szServiceName_UnoPageControl, NULL )
+        CHECKANDCREATEFACTORY( UnoFrameModel, szServiceName_UnoFrameModel, NULL )
+        CHECKANDCREATEFACTORY( UnoFrameControl, szServiceName_UnoFrameControl, NULL )
         CHECKANDCREATEFACTORY( UnoSpinButtonModel, szServiceName_UnoSpinButtonModel, NULL )
         CHECKANDCREATEFACTORY( UnoSpinButtonControl, szServiceName_UnoSpinButtonControl, NULL )
         CHECKANDCREATEFACTORY( TreeControl, szServiceName_TreeControl, NULL )
diff --git a/toolkit/source/helper/servicenames.cxx b/toolkit/source/helper/servicenames.cxx
index 5e24d03..be9c708 100644
--- a/toolkit/source/helper/servicenames.cxx
+++ b/toolkit/source/helper/servicenames.cxx
@@ -93,6 +93,10 @@ const sal_Char __FAR_DATA szServiceName_UnoSpinButtonControl[] = "com.sun.star.a
 const sal_Char __FAR_DATA szServiceName_UnoSpinButtonModel[] = "com.sun.star.awt.UnoControlSpinButtonModel";
 const sal_Char __FAR_DATA szServiceName_UnoMultiPageControl[] = "com.sun.star.awt.UnoControlMultiPage";
 const sal_Char __FAR_DATA szServiceName_UnoMultiPageModel[] = "com.sun.star.awt.UnoMultiPageModel";
+const sal_Char __FAR_DATA szServiceName_UnoPageControl[] = "com.sun.star.awt.UnoControlPage";
+const sal_Char __FAR_DATA szServiceName_UnoPageModel[] = "com.sun.star.awt.UnoPageModel";
+const sal_Char __FAR_DATA szServiceName_UnoFrameControl[] = "com.sun.star.awt.UnoControlFrame";
+const sal_Char __FAR_DATA szServiceName_UnoFrameModel[] = "com.sun.star.awt.UnoFrameModel";
 const sal_Char __FAR_DATA szServiceName_TreeControl[] = "com.sun.star.awt.tree.TreeControl";
 const sal_Char __FAR_DATA szServiceName_TreeControlModel[] = "com.sun.star.awt.tree.TreeControlModel";
 const sal_Char __FAR_DATA szServiceName_MutableTreeDataModel[] = "com.sun.star.awt.tree.MutableTreeDataModel";
diff --git a/toolkit/source/helper/unowrapper.cxx b/toolkit/source/helper/unowrapper.cxx
index 6e56a27..9cb0bdd 100644
--- a/toolkit/source/helper/unowrapper.cxx
+++ b/toolkit/source/helper/unowrapper.cxx
@@ -38,6 +38,7 @@
 #include <toolkit/awt/vclxcontainer.hxx>
 #include <toolkit/awt/vclxtopwindow.hxx>
 #include <toolkit/awt/vclxgraphics.hxx>
+#include <awt/vclxtabcontrol.hxx>
 
 #include "toolkit/dllapi.h"
 #include <vcl/svapp.hxx>
@@ -107,6 +108,9 @@ using namespace ::com::sun::star;
         case WINDOW_TABPAGE:        return new VCLXContainer;
 
         case WINDOW_TOOLBOX:		return new VCLXToolBox;
+        return new VCLXMultiPage;
+        case WINDOW_TABCONTROL:
+        return new VCLXMultiPage;
 
         // case WINDOW_FIXEDLINE:
         // case WINDOW_FIXEDBITMAP:
diff --git a/vbahelper/source/msforms/vbacontrol.cxx b/vbahelper/source/msforms/vbacontrol.cxx
index 44c7f2f..25b4ab1 100644
--- a/vbahelper/source/msforms/vbacontrol.cxx
+++ b/vbahelper/source/msforms/vbacontrol.cxx
@@ -71,37 +71,6 @@
 using namespace com::sun::star;
 using namespace ooo::vba;
 
-uno::Reference< css::awt::XWindowPeer >
-ScVbaControl::getWindowPeer() throw (uno::RuntimeException)
-{
-    uno::Reference< drawing::XControlShape > xControlShape( m_xControl, uno::UNO_QUERY );
-
-    uno::Reference< awt::XControlModel > xControlModel;
-    uno::Reference< css::awt::XWindowPeer >  xWinPeer;
-    if ( !xControlShape.is() )
-    {
-        // would seem to be a Userform control
-        uno::Reference< awt::XControl > xControl( m_xControl, uno::UNO_QUERY_THROW );
-        xWinPeer =  xControl->getPeer();
-    return xWinPeer;
-    }
-    // form control
-    xControlModel.set( xControlShape->getControl(), uno::UNO_QUERY_THROW );
-
-    uno::Reference< view::XControlAccess > xControlAccess( m_xModel->getCurrentController(), uno::UNO_QUERY_THROW );
-    try
-    {
-        uno::Reference< awt::XControl > xControl( xControlAccess->getControl( xControlModel ), uno::UNO_QUERY );
-        xWinPeer =  xControl->getPeer();
-    }
-    catch( uno::Exception )
-    {
-        throw uno::RuntimeException( rtl::OUString::createFromAscii( "The Control does not exsit" ),
-                uno::Reference< uno::XInterface >() );
-    }
-    return xWinPeer;
-}
-
 //ScVbaControlListener
 class ScVbaControlListener: public cppu::WeakImplHelper1< lang::XEventListener >
 {
@@ -566,6 +535,11 @@ ScVbaControl* ScVbaControlFactory::createControl( const uno::Reference< awt::XCo
     pControl = new ScVbaMultiPage( xVbaParent, m_xContext, xControl, m_xModel, new UserFormGeometryHelper( m_xContext, xControl ), xParent );
     else if ( xServiceInfo->supportsService( rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlSpinButtonModel") ) ) )
     pControl = new ScVbaSpinButton( xVbaParent, m_xContext, xControl, m_xModel, new UserFormGeometryHelper( m_xContext, xControl ) );
+    // #FIXME implement a page control
+    else if ( xServiceInfo->supportsService( rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoPageModel") ) ) )
+    pControl = new ScVbaControl( xVbaParent, m_xContext, xControl, m_xModel, new UserFormGeometryHelper( m_xContext, xControl ) );
+    else if ( xServiceInfo->supportsService( rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoFrameModel") ) ) )
+    pControl = new ScVbaFrame( xVbaParent, m_xContext, xControl, m_xModel, new UserFormGeometryHelper( m_xContext, xControl ) );
     else
         throw uno::RuntimeException( rtl::OUString::createFromAscii("Unsupported control " ), uno::Reference< uno::XInterface >() );
     return pControl;
diff --git a/vbahelper/source/msforms/vbacontrol.hxx b/vbahelper/source/msforms/vbacontrol.hxx
index fd1e1ff..cb97586 100644
--- a/vbahelper/source/msforms/vbacontrol.hxx
+++ b/vbahelper/source/msforms/vbacontrol.hxx
@@ -60,7 +60,6 @@ protected:
     css::uno::Reference< css::uno::XInterface > m_xControl;
     css::uno::Reference< css::frame::XModel > m_xModel;
 
-    virtual css::uno::Reference< css::awt::XWindowPeer > getWindowPeer() throw (css::uno::RuntimeException);
     void fireChangeEvent();
     void fireClickEvent();
     void fireEvent( css::script::ScriptEvent& evt );
diff --git a/vbahelper/source/msforms/vbacontrols.cxx b/vbahelper/source/msforms/vbacontrols.cxx
index ccef141..935f46c 100644
--- a/vbahelper/source/msforms/vbacontrols.cxx
+++ b/vbahelper/source/msforms/vbacontrols.cxx
@@ -58,20 +58,32 @@ class ControlArrayWrapper : public ArrayWrapImpl
         xProp->getPropertyValue( rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( "Name" ) ) ) >>= sName;
         return sName;
     }
+    void getNestedControls( ControlVec& vControls, uno::Reference< awt::XControlContainer >& xContainer )
+    {
+        uno::Sequence< uno::Reference< awt::XControl > > aControls = xContainer->getControls();
+        const uno::Reference< awt::XControl >* pCtrl = aControls.getConstArray();
+        const uno::Reference< awt::XControl >* pCtrlsEnd = pCtrl + aControls.getLength();
+        for ( ; pCtrl < pCtrlsEnd; ++pCtrl )
+        {
+            uno::Reference< awt::XControlContainer > xC( *pCtrl, uno::UNO_QUERY );
+            vControls.push_back( *pCtrl );
+            if ( xC.is() )
+                getNestedControls( vControls, xC );
+        }
+    }
 
 public:
 
     ControlArrayWrapper( const uno::Reference< awt::XControl >& xDialog )
     {
         mxDialog.set( xDialog, uno::UNO_QUERY_THROW );
-        uno::Sequence< uno::Reference< awt::XControl > > sXControls = mxDialog->getControls();
-
-        msNames.realloc( sXControls.getLength() );
-        for ( sal_Int32 i = 0; i < sXControls.getLength(); ++i )
+//        uno::Sequence< uno::Reference< awt::XControl > > sXControls = mxDialog->getControls();
+        getNestedControls( mControls, mxDialog );
+        msNames.realloc( mControls.size() );
+        for ( sal_uInt32 i = 0; i < mControls.size(); ++i )
         {
-            uno::Reference< awt::XControl > xCtrl = sXControls[ i ];
+            uno::Reference< awt::XControl > xCtrl = mControls[ i ];
             msNames[ i ] = getControlName( xCtrl );
-            mControls.push_back( xCtrl );
             mIndices[ msNames[ i ] ] = i;
         }
     }
diff --git a/vbahelper/source/msforms/vbamultipage.cxx b/vbahelper/source/msforms/vbamultipage.cxx
index 69410db..b8fa10b 100644
--- a/vbahelper/source/msforms/vbamultipage.cxx
+++ b/vbahelper/source/msforms/vbamultipage.cxx
@@ -40,10 +40,7 @@
 using namespace com::sun::star;
 using namespace ooo::vba;
 
-// uno servicename com.sun.star.awt.UnoControlProgressBarMode
-const rtl::OUString SVALUE( RTL_CONSTASCII_USTRINGPARAM("ProgressValue") );
-const rtl::OUString SVALUEMAX( RTL_CONSTASCII_USTRINGPARAM("ProgressValueMax") );
-const rtl::OUString SSTEP( RTL_CONSTASCII_USTRINGPARAM("Step") );
+const rtl::OUString SVALUE( RTL_CONSTASCII_USTRINGPARAM("MultiPageValue") );
 
 typedef cppu::WeakImplHelper1< container::XIndexAccess > PagesImpl_Base;
 class PagesImpl : public PagesImpl_Base
@@ -79,8 +76,6 @@ ScVbaMultiPage::getPages( sal_Int32 nPages )
 ScVbaMultiPage::ScVbaMultiPage( const uno::Reference< ov::XHelperInterface >& xParent, const uno::Reference< uno::XComponentContext >& xContext, const uno::Reference< uno::XInterface >& xControl, uno::Reference< frame::XModel >& xModel, AbstractGeometryAttributes* pGeomHelper, const uno::Reference< uno::XInterface >& xDialog ) : MultiPageImpl_BASE( xParent, xContext, xControl, xModel, pGeomHelper )
 {
     mxDialogProps.set( xDialog, uno::UNO_QUERY_THROW );
-    // set dialog step to value of multipage pseudo model
-    setValue(getValue());
 }
 
 // Attributes
@@ -89,15 +84,16 @@ ScVbaMultiPage::getValue() throw (css::uno::RuntimeException)
 {
     sal_Int32 nValue = 0;
     m_xProps->getPropertyValue( SVALUE ) >>= nValue;
-    return nValue;
+    // VBA 0 based tab index
+    return nValue - 1;
 }
 
 void SAL_CALL
 ScVbaMultiPage::setValue( const sal_Int32 _value ) throw (::com::sun::star::uno::RuntimeException)
 {
-    // track change in dialog ( dialog value is 1 based, 0 is a special value )
-    m_xProps->setPropertyValue( SVALUE, uno::makeAny( _value ) );
-    mxDialogProps->setPropertyValue( SSTEP, uno::makeAny( _value + 1) );
+    // Openoffice 1 based tab index
+   sal_Int32 nVal = _value + 1;
+    m_xProps->setPropertyValue( SVALUE, uno::makeAny( nVal ) );
 }
 
 
@@ -111,9 +107,9 @@ ScVbaMultiPage::getServiceImplName()
 uno::Any SAL_CALL
 ScVbaMultiPage::Pages( const uno::Any& index ) throw (uno::RuntimeException)
 {
-    sal_Int32 nValue = 0;
-    m_xProps->getPropertyValue( SVALUEMAX ) >>= nValue;
-    uno::Reference< XCollection > xColl( new ScVbaPages( this, mxContext, getPages( nValue ) ) );
+        // get the container model
+        uno::Reference< container::XNameContainer > xContainer( m_xProps, uno::UNO_QUERY_THROW );
+    uno::Reference< XCollection > xColl( new ScVbaPages( this, mxContext, getPages( xContainer->getElementNames().getLength() ) ) );
     if ( !index.hasValue() )
         return uno::makeAny( xColl );
     return xColl->Item( uno::makeAny( index ), uno::Any() );
diff --git a/vbahelper/source/msforms/vbauserform.cxx b/vbahelper/source/msforms/vbauserform.cxx
index ddf4ff2..7f62158 100644
--- a/vbahelper/source/msforms/vbauserform.cxx
+++ b/vbahelper/source/msforms/vbauserform.cxx
@@ -35,7 +35,6 @@
 #include <vbahelper/helperdecl.hxx>
 #include "vbauserform.hxx"
 #include <com/sun/star/awt/XControl.hpp>
-#include <com/sun/star/awt/XControlContainer.hpp>
 #include <com/sun/star/beans/PropertyConcept.hpp>
 #include <basic/sbx.hxx>
 #include <basic/sbstar.hxx>
@@ -174,18 +173,45 @@ ScVbaUserForm::setValue( const ::rtl::OUString& aPropertyName, const uno::Any& a
     xPropSet->setPropertyValue( aDfltPropName, aValue );
 }
 
+uno::Reference< awt::XControl >
+ScVbaUserForm::nestedSearch( const rtl::OUString& aPropertyName, uno::Reference< awt::XControlContainer >& xContainer )
+{
+    uno::Reference< awt::XControl > xControl = xContainer->getControl( aPropertyName );
+    if ( !xControl.is() )
+    {
+        uno::Sequence< uno::Reference< awt::XControl > > aControls = xContainer->getControls();
+        const uno::Reference< awt::XControl >* pCtrl = aControls.getConstArray();
+        const uno::Reference< awt::XControl >* pCtrlsEnd = pCtrl + aControls.getLength();
+
+        for ( ; pCtrl < pCtrlsEnd; ++pCtrl )
+        {
+            uno::Reference< awt::XControlContainer > xC( *pCtrl, uno::UNO_QUERY );
+            if ( xC.is() )
+            {
+                xControl.set( nestedSearch( aPropertyName, xC ) );
+                if ( xControl.is() )
+                    break;
+            }
+        }
+    }
+    return xControl;
+}
+
 uno::Any SAL_CALL
 ScVbaUserForm::getValue( const ::rtl::OUString& aPropertyName ) throw (beans::UnknownPropertyException, uno::RuntimeException)
 {
     uno::Reference< awt::XControl > xDialogControl( m_xDialog, uno::UNO_QUERY_THROW );
     uno::Reference< awt::XControlContainer > xContainer( m_xDialog, uno::UNO_QUERY_THROW );
-    uno::Reference< awt::XControl > xControl = xContainer->getControl( aPropertyName );
+
+    uno::Reference< awt::XControl > xControl = nestedSearch( aPropertyName, xContainer );
+xContainer->getControl( aPropertyName );
     ScVbaControlFactory aFac( mxContext, xControl, m_xModel );
         uno::Reference< msforms::XControl > xVBAControl( aFac.createControl( xDialogControl->getModel() ) );
         ScVbaControl* pControl  = dynamic_cast< ScVbaControl* >( xVBAControl.get() );
         pControl->setGeometryHelper( new UserFormGeometryHelper( mxContext, xControl ) );
         if ( m_sLibName.getLength() )
             pControl->setLibraryAndCodeName( m_sLibName.concat( rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( "." ) ) ).concat( getName() ) );
+
     return uno::makeAny( xVBAControl );
 }
 
@@ -208,13 +234,18 @@ ScVbaUserForm::Controls( const uno::Any& index ) throw (uno::RuntimeException)
 ScVbaUserForm::hasProperty( const ::rtl::OUString& aName ) throw (uno::RuntimeException)
 {
     uno::Reference< awt::XControl > xControl( m_xDialog, uno::UNO_QUERY );
+
     OSL_TRACE("ScVbaUserForm::hasProperty(%s) %d", rtl::OUStringToOString( aName, RTL_TEXTENCODING_UTF8 ).getStr(), xControl.is() );
     if ( xControl.is() )
     {
-        uno::Reference< container::XNameAccess > xNameAccess( xControl->getModel(), uno::UNO_QUERY_THROW );
-        sal_Bool bRes =  xNameAccess->hasByName( aName );
-    OSL_TRACE("ScVbaUserForm::hasProperty(%s) %d ---> %d", rtl::OUStringToOString( aName, RTL_TEXTENCODING_UTF8 ).getStr(), xControl.is(), bRes );
-        return bRes;
+            uno::Reference< beans::XPropertySet > xDlgProps( xControl->getModel(), uno::UNO_QUERY );
+                if ( xDlgProps.is() )
+                {
+                    uno::Reference< container::XNameContainer > xAllChildren( xDlgProps->getPropertyValue( rtl::OUString::createFromAscii("AllDialogChildren" ) ), uno::UNO_QUERY_THROW );
+            sal_Bool bRes =  xAllChildren->hasByName( aName );
+                    OSL_TRACE("ScVbaUserForm::hasProperty(%s) %d ---> %d", rtl::OUStringToOString( aName, RTL_TEXTENCODING_UTF8 ).getStr(), xAllChildren.is(), bRes );
+                    return bRes;
+                }
     }
     return sal_False;
 }
diff --git a/vbahelper/source/msforms/vbauserform.hxx b/vbahelper/source/msforms/vbauserform.hxx
index 9ad194d..dca074d 100644
--- a/vbahelper/source/msforms/vbauserform.hxx
+++ b/vbahelper/source/msforms/vbauserform.hxx
@@ -38,6 +38,7 @@
 #include <cppuhelper/implbase1.hxx>
 #include <ooo/vba/msforms/XUserForm.hpp>
 #include <com/sun/star/awt/XDialog.hpp>
+#include <com/sun/star/awt/XControlContainer.hpp>
 #include <com/sun/star/frame/XModel.hpp>
 
 #include <vbahelper/vbahelperinterface.hxx>
@@ -56,6 +57,7 @@ protected:
 public:
     ScVbaUserForm( css::uno::Sequence< css::uno::Any > const& aArgs, css::uno::Reference< css::uno::XComponentContext >const& xContext ) throw ( css::lang::IllegalArgumentException );
     virtual ~ScVbaUserForm();
+    static css::uno::Reference< css::awt::XControl > nestedSearch( const rtl::OUString& aPropertyName, css::uno::Reference< css::awt::XControlContainer >& xContainer );
     // XUserForm
     virtual void SAL_CALL RePaint(  ) throw (css::uno::RuntimeException);
     virtual void SAL_CALL Show(  ) throw (css::uno::RuntimeException);
diff --git a/vcl/inc/vcl/tabctrl.hxx b/vcl/inc/vcl/tabctrl.hxx
index 7f93abd..35ffbe0 100644
--- a/vcl/inc/vcl/tabctrl.hxx
+++ b/vcl/inc/vcl/tabctrl.hxx
@@ -95,6 +95,7 @@ private:
 protected:
     using Window::ImplInit;
     SAL_DLLPRIVATE void         ImplInit( Window* pParent, WinBits nStyle );
+    SAL_DLLPRIVATE WinBits      ImplInitStyle( WinBits nStyle );
     SAL_DLLPRIVATE void         ImplLoadRes( const ResId& rResId );
 
     virtual void		        FillLayoutData() const;
diff --git a/vcl/source/control/group.cxx b/vcl/source/control/group.cxx
index f07c3f2..2513d97 100644
--- a/vcl/source/control/group.cxx
+++ b/vcl/source/control/group.cxx
@@ -142,6 +142,7 @@ GroupBox::GroupBox( Window* pParent, const ResId& rResId ) :
 void GroupBox::ImplDraw( OutputDevice* pDev, ULONG nDrawFlags,
                          const Point& rPos, const Size& rSize, bool bLayout )
 {
+        OSL_TRACE("GroupBox::ImplDraw Y %d, X %d", rPos.Y(), rPos.X() );
     long					nTop;
     long					nTextOff;
     const StyleSettings&	rStyleSettings = GetSettings().GetStyleSettings();
diff --git a/vcl/source/control/tabctrl.cxx b/vcl/source/control/tabctrl.cxx
index 6c935fc..f3fb755 100644
--- a/vcl/source/control/tabctrl.cxx
+++ b/vcl/source/control/tabctrl.cxx
@@ -168,6 +168,18 @@ void TabControl::ImplInit( Window* pParent, WinBits nStyle )
 
 // -----------------------------------------------------------------------
 
+WinBits TabControl::ImplInitStyle( WinBits nStyle )
+{
+    if ( !(nStyle & WB_NOTABSTOP) )
+        nStyle |= WB_TABSTOP;
+    if ( !(nStyle & WB_NOGROUP) )
+        nStyle |= WB_GROUP;
+
+    return nStyle;
+}
+
+// -----------------------------------------------------------------------
+
 void TabControl::ImplInitSettings( BOOL bFont,
                                    BOOL bForeground, BOOL bBackground )
 {
@@ -243,6 +255,7 @@ TabControl::TabControl( Window* pParent, WinBits nStyle ) :
     Control( WINDOW_TABCONTROL )
 {
     ImplInit( pParent, nStyle );
+    OSL_TRACE("*** TABCONTROL no notabs? %s", ( GetStyle() & WB_NOBORDER ) ? "true" : "false" );
 }
 
 // -----------------------------------------------------------------------
@@ -701,7 +714,13 @@ void TabControl::ImplChangeTabPage( USHORT nId, USHORT nOldId )
 
     if ( pPage )
     {
-        pPage->SetPosSizePixel( aRect.TopLeft(), aRect.GetSize() );
+        if (  ( GetStyle() & WB_NOBORDER ) )
+        {
+            Rectangle aRectNoTab( (const Point&)Point( 0, 0 ), GetSizePixel() );
+            pPage->SetPosSizePixel( aRectNoTab.TopLeft(), aRectNoTab.GetSize() );
+        }
+        else
+            pPage->SetPosSizePixel( aRect.TopLeft(), aRect.GetSize() );
 
         // Hier Page aktivieren, damit die Controls entsprechend umgeschaltet
         // werden koennen und HilfeId gegebenenfalls beim Parent umsetzen
@@ -756,6 +775,12 @@ BOOL TabControl::ImplPosCurTabPage()
     ImplTabItem* pItem = ImplGetItem( GetCurPageId() );
     if ( pItem && pItem->mpTabPage )
     {
+        if (  ( GetStyle() & WB_NOBORDER ) )
+        {
+            Rectangle aRectNoTab( (const Point&)Point( 0, 0 ), GetSizePixel() );
+            pItem->mpTabPage->SetPosSizePixel( aRectNoTab.TopLeft(), aRectNoTab.GetSize() );
+            return TRUE;
+        }
         Rectangle aRect = ImplGetTabRect( TAB_PAGERECT );
         pItem->mpTabPage->SetPosSizePixel( aRect.TopLeft(), aRect.GetSize() );
         return TRUE;
@@ -1101,7 +1126,8 @@ void TabControl::KeyInput( const KeyEvent& rKEvt )
 
 void TabControl::Paint( const Rectangle& rRect )
 {
-    ImplPaint( rRect, false );
+    if (  !( GetStyle() & WB_NOBORDER ) )
+        ImplPaint( rRect, false );
 }
 
 // -----------------------------------------------------------------------
@@ -1515,6 +1541,10 @@ void TabControl::StateChanged( StateChangedType nType )
         ImplInitSettings( FALSE, FALSE, TRUE );
         Invalidate();
     }
+    else if ( nType == STATE_CHANGE_STYLE )
+    {
+        SetStyle( ImplInitStyle( GetStyle() ) );
+    }
 }
 
 // -----------------------------------------------------------------------
diff --git a/xmlscript/inc/xmlscript/xmldlg_imexp.hxx b/xmlscript/inc/xmlscript/xmldlg_imexp.hxx
index 2e1654a..f6648b6 100644
--- a/xmlscript/inc/xmlscript/xmldlg_imexp.hxx
+++ b/xmlscript/inc/xmlscript/xmldlg_imexp.hxx
@@ -41,6 +41,7 @@
 #ifndef _COM_SUN_STAR_UNO_XCOMPONENTCONTEXT_HXX_
 #include <com/sun/star/uno/XComponentContext.hpp>
 #endif
+#include <com/sun/star/frame/XModel.hpp>
 
 #include "xmlscript/xmlns.h"
 
diff --git a/xmlscript/source/xmldlg_imexp/common.hxx b/xmlscript/source/xmldlg_imexp/common.hxx
index f5bc516..8951291 100644
--- a/xmlscript/source/xmldlg_imexp/common.hxx
+++ b/xmlscript/source/xmldlg_imexp/common.hxx
@@ -39,4 +39,5 @@ const sal_Int16 BORDER_SIMPLE_COLOR = 3;
 
 }
 
+#define XMLSCRIPT_GRAPHOBJ_URLPREFIX "vnd.sun.star.GraphicObject:"
 #endif
diff --git a/xmlscript/source/xmldlg_imexp/exp_share.hxx b/xmlscript/source/xmldlg_imexp/exp_share.hxx
index 5ca673c..f69144a 100644
--- a/xmlscript/source/xmldlg_imexp/exp_share.hxx
+++ b/xmlscript/source/xmldlg_imexp/exp_share.hxx
@@ -90,16 +90,18 @@ class ElementDescriptor
 {
     css::uno::Reference< css::beans::XPropertySet > _xProps;
     css::uno::Reference< css::beans::XPropertyState > _xPropState;
+    css::uno::Reference< css::frame::XModel > _xDocument;
     
 public:
     inline ElementDescriptor(
         css::uno::Reference< css::beans::XPropertySet > const & xProps,
         css::uno::Reference< css::beans::XPropertyState > const & xPropState,
-        ::rtl::OUString const & name )
+        ::rtl::OUString const & name, css::uno::Reference< css::frame::XModel > const & xDocument )
         SAL_THROW( () )
         : XMLElement( name )
         , _xProps( xProps )
         , _xPropState( xPropState )
+	, _xDocument( xDocument )
         {}
     inline ElementDescriptor(
         ::rtl::OUString const & name )
@@ -141,6 +143,8 @@ public:
         ::rtl::OUString const & rPropName, ::rtl::OUString const & rAttrName );
     void readVerticalAlignAttr(
         ::rtl::OUString const & rPropName, ::rtl::OUString const & rAttrName );
+    void readImageURLAttr(
+        ::rtl::OUString const & rPropName, ::rtl::OUString const & rAttrName );
     void readImageAlignAttr(
         ::rtl::OUString const & rPropName, ::rtl::OUString const & rAttrName );
     void readImagePositionAttr(
@@ -171,17 +175,23 @@ public:
     //
     void readDialogModel( StyleBag * all_styles )
         SAL_THROW( (css::uno::Exception) );
+    void readBullitinBoard( StyleBag * all_styles )
+        SAL_THROW( (css::uno::Exception) );
     void readMultiPageModel( StyleBag * all_styles )
         SAL_THROW( (css::uno::Exception) );
+    void readFrameModel( StyleBag * all_styles )
+        SAL_THROW( (css::uno::Exception) );
+    void readPageModel( StyleBag * all_styles )
+        SAL_THROW( (css::uno::Exception) );
     void readButtonModel( StyleBag * all_styles )
         SAL_THROW( (css::uno::Exception) );
     void readEditModel( StyleBag * all_styles )
         SAL_THROW( (css::uno::Exception) );
     void readCheckBoxModel( StyleBag * all_styles )
         SAL_THROW( (css::uno::Exception) );
-    void readRadioButtonModel( StyleBag * all_styles, com::sun::star::uno::Reference< com::sun::star::frame::XModel > const & xDocument )
+    void readRadioButtonModel( StyleBag * all_styles )
         SAL_THROW( (css::uno::Exception) );
-    void readComboBoxModel( StyleBag * all_styles, com::sun::star::uno::Reference< com::sun::star::frame::XModel > const & xDocument )
+    void readComboBoxModel( StyleBag * all_styles )
         SAL_THROW( (css::uno::Exception) );
     void readCurrencyFieldModel( StyleBag * all_styles )
         SAL_THROW( (css::uno::Exception) );
@@ -195,9 +205,9 @@ public:
         SAL_THROW( (css::uno::Exception) );
     void readGroupBoxModel( StyleBag * all_styles )
         SAL_THROW( (css::uno::Exception) );
-    void readImageControlModel( StyleBag * all_styles, com::sun::star::uno::Reference< com::sun::star::frame::XModel > const & xDocument  )
+    void readImageControlModel( StyleBag * all_styles )
         SAL_THROW( (css::uno::Exception) );
-    void readListBoxModel( StyleBag * all_styles, com::sun::star::uno::Reference< com::sun::star::frame::XModel > const & xDocument )
+    void readListBoxModel( StyleBag * all_styles )
         SAL_THROW( (css::uno::Exception) );
     void readNumericFieldModel( StyleBag * all_styles )
         SAL_THROW( (css::uno::Exception) );
@@ -211,10 +221,10 @@ public:
         SAL_THROW( (css::uno::Exception) );
     void readProgressBarModel( StyleBag * all_styles )
         SAL_THROW( (css::uno::Exception) );
-    void readScrollBarModel( StyleBag * all_styles, com::sun::star::uno::Reference< com::sun::star::frame::XModel > const & xDocument )
-        SAL_THROW( (css::uno::Exception) );
-    void readSpinButtonModel( StyleBag * all_styles, com::sun::star::uno::Reference< com::sun::star::frame::XModel > const & xDocument )
+    void readScrollBarModel( StyleBag * all_styles )
         SAL_THROW( (css::uno::Exception) );
+    void readSpinButtonModel( StyleBag * all_styles )
+         SAL_THROW( (css::uno::Exception) );
     void readFixedHyperLinkModel( StyleBag * all_styles )
         SAL_THROW( (css::uno::Exception) );
 };
diff --git a/xmlscript/source/xmldlg_imexp/imp_share.hxx b/xmlscript/source/xmldlg_imexp/imp_share.hxx
index 5df06a8..062db37 100644
--- a/xmlscript/source/xmldlg_imexp/imp_share.hxx
+++ b/xmlscript/source/xmldlg_imexp/imp_share.hxx
@@ -44,7 +44,7 @@
 #include <com/sun/star/xml/input/XRoot.hpp>
 #include <com/sun/star/script/XLibraryContainer.hpp>
 #include <vector>
-
+#include <boost/shared_ptr.hpp>
 
 namespace css = ::com::sun::star;
 
@@ -124,8 +124,10 @@ struct DialogImport
     css::uno::Reference< css::uno::XComponentContext > _xContext;
     css::uno::Reference< css::util::XNumberFormatsSupplier > _xSupplier;
     
-    ::std::vector< ::rtl::OUString > _styleNames;
-    ::std::vector< css::uno::Reference< css::xml::input::XElement > > _styles;
+    ::boost::shared_ptr< ::std::vector< ::rtl::OUString > > _pStyleNames;
+    ::boost::shared_ptr< ::std::vector< css::uno::Reference< css::xml::input::XElement > > > _pStyles;
+    ::std::vector< ::rtl::OUString >& _styleNames;
+    ::std::vector< css::uno::Reference< css::xml::input::XElement > >& _styles;
     
     css::uno::Reference< css::container::XNameContainer > _xDialogModel;
     css::uno::Reference< css::lang::XMultiServiceFactory > _xDialogModelFactory;
@@ -165,13 +167,33 @@ public:
         css::uno::Reference<css::uno::XComponentContext> const & xContext,
         css::uno::Reference<css::container::XNameContainer>
         const & xDialogModel,
+        ::boost::shared_ptr< ::std::vector< ::rtl::OUString > >& pStyleNames,
+        ::boost::shared_ptr< ::std::vector< css::uno::Reference< css::xml::input::XElement > > >& pStyles,
         css::uno::Reference<css::frame::XModel> const & xDoc )
         SAL_THROW( () )
         : _xContext( xContext )
+        , _pStyleNames( pStyleNames )
+        , _pStyles( pStyles )
+        , _styleNames( *_pStyleNames )
+        , _styles( *_pStyles )
         , _xDialogModel( xDialogModel )
-        , _xDialogModelFactory( xDialogModel, css::uno::UNO_QUERY_THROW ), _xDoc( xDoc )
+        , _xDialogModelFactory( xDialogModel, css::uno::UNO_QUERY_THROW )
+        , _xDoc( xDoc )
         { OSL_ASSERT( _xDialogModel.is() && _xDialogModelFactory.is() &&
                       _xContext.is() ); }
+
+    inline DialogImport( const DialogImport& rOther ) : _xContext( rOther._xContext )
+        , _xSupplier( rOther._xSupplier )
+        , _pStyleNames( rOther._pStyleNames )
+        , _pStyles( rOther._pStyles )
+        , _styleNames( *_pStyleNames )
+        , _styles( *_pStyles )
+        , _xDialogModel( rOther._xDialogModel )
+        , _xDialogModelFactory( rOther._xDialogModelFactory )
+        , _xDoc( rOther._xDoc )
+        , _xScriptLibraryContainer( rOther._xScriptLibraryContainer )
+        , XMLNS_DIALOGS_UID( rOther.XMLNS_DIALOGS_UID )
+        , XMLNS_SCRIPT_UID( rOther.XMLNS_SCRIPT_UID ) {}
     virtual ~DialogImport()
         SAL_THROW( () );
     
@@ -434,6 +456,8 @@ public:
     bool importVerticalAlignProperty(
         ::rtl::OUString const & rPropName, ::rtl::OUString const & rAttrName,
         css::uno::Reference<css::xml::input::XAttributes> const & xAttributes );
+    bool importImageURLProperty( rtl::OUString const & rPropName, rtl::OUString const & rAttrName,
+        css::uno::Reference< css::xml::input::XAttributes > const & xAttributes );
     bool importImageAlignProperty(
         ::rtl::OUString const & rPropName, ::rtl::OUString const & rAttrName, 
         css::uno::Reference<css::xml::input::XAttributes> const & xAttributes );
@@ -473,6 +497,14 @@ public:
                 pImport->_xDialogModelFactory->createInstance( rControlName ),
                 css::uno::UNO_QUERY_THROW ), rId )
         {}
+    inline ControlImportContext(
+        DialogImport * pImport,
+        const css::uno::Reference< css::beans::XPropertySet >& xProps, ::rtl::OUString const & rControlName )
+        : ImportContext(
+            pImport,
+                xProps,
+                rControlName )
+        {}
     inline ~ControlImportContext()
     {
         _pImport->_xDialogModel->insertByName(
@@ -1043,7 +1075,62 @@ public:
         ElementBase * pParent, DialogImport * pImport )
         SAL_THROW( () )
         : ControlElement( rLocalName, xAttributes, pParent, pImport )
+        {
+            m_xContainer.set( _pImport->_xDialogModelFactory->createInstance( rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoMultiPageModel") ) ), css::uno::UNO_QUERY );
+        }
+private:
+    css::uno::Reference< css::container::XNameContainer > m_xContainer;
+};
+
+//==============================================================================
+class Frame
+    : public ControlElement
+{
+    ::rtl::OUString _label;
+public:
+    virtual css::uno::Reference< css::xml::input::XElement >
+    SAL_CALL startChildElement(
+        sal_Int32 nUid, ::rtl::OUString const & rLocalName,
+        css::uno::Reference<css::xml::input::XAttributes> const & xAttributes )
+        throw (css::xml::sax::SAXException, css::uno::RuntimeException);
+    virtual void SAL_CALL endElement()
+        throw (css::xml::sax::SAXException, css::uno::RuntimeException);
+
+    inline Frame(
+        ::rtl::OUString const & rLocalName,
+        css::uno::Reference< css::xml::input::XAttributes > const & xAttributes,
+        ElementBase * pParent, DialogImport * pImport )
+        SAL_THROW( () )
+        : ControlElement( rLocalName, xAttributes, pParent, pImport )
         {}
+private:
+    css::uno::Reference< css::container::XNameContainer > m_xContainer;
+};
+
+//==============================================================================
+class Page
+    : public ControlElement
+{
+public:
+    virtual css::uno::Reference< css::xml::input::XElement >
+    SAL_CALL startChildElement(
+        sal_Int32 nUid, ::rtl::OUString const & rLocalName,
+        css::uno::Reference<css::xml::input::XAttributes> const & xAttributes )
+        throw (css::xml::sax::SAXException, css::uno::RuntimeException);
+    virtual void SAL_CALL endElement()
+        throw (css::xml::sax::SAXException, css::uno::RuntimeException);
+
+    inline Page(
+        ::rtl::OUString const & rLocalName,
+        css::uno::Reference< css::xml::input::XAttributes > const & xAttributes,
+        ElementBase * pParent, DialogImport * pImport )
+        SAL_THROW( () )
+        : ControlElement( rLocalName, xAttributes, pParent, pImport )
+        {
+            m_xContainer.set( _pImport->_xDialogModelFactory->createInstance( rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoPageModel") ) ), css::uno::UNO_QUERY );
+        }
+private:
+    css::uno::Reference< css::container::XNameContainer > m_xContainer;
 };
 
 class ProgressBarElement
diff --git a/xmlscript/source/xmldlg_imexp/xmldlg_expmodels.cxx b/xmlscript/source/xmldlg_imexp/xmldlg_expmodels.cxx
index 814fb2c..a42cfee 100644
--- a/xmlscript/source/xmldlg_imexp/xmldlg_expmodels.cxx
+++ b/xmlscript/source/xmldlg_imexp/xmldlg_expmodels.cxx
@@ -35,11 +35,7 @@
 #include <com/sun/star/table/CellAddress.hpp>
 #include <com/sun/star/table/CellRangeAddress.hpp>
 #include <com/sun/star/util/XNumberFormatsSupplier.hpp>
-#include <com/sun/star/document/XStorageBasedDocument.hpp>
-#include <com/sun/star/document/XGraphicObjectResolver.hpp>
-#include <comphelper/componentcontext.hxx>
-#include <comphelper/processfactory.hxx>
-
+#include <com/sun/star/lang/XServiceInfo.hpp>
 
 using namespace ::com::sun::star;
 using namespace ::com::sun::star::uno;
@@ -137,7 +133,9 @@ static inline bool readFontProps( ElementDescriptor * element, Style & style )
 void ElementDescriptor::readMultiPageModel( StyleBag * all_styles )
 {
     // collect styles
-    Style aStyle( 0x2 | 0x8 | 0x20 );
+    Style aStyle( 0x1 | 0x2 | 0x8 | 0x20 );
+    if (readProp( OUString( RTL_CONSTASCII_USTRINGPARAM("BackgroundColor") ) ) >>= aStyle._backgroundColor)
+        aStyle._set |= 0x1;
     if (readProp( OUString( RTL_CONSTASCII_USTRINGPARAM("TextColor") ) ) >>= aStyle._textColor)
         aStyle._set |= 0x2;
     if (readProp( OUString( RTL_CONSTASCII_USTRINGPARAM("TextLineColor") ) ) >>= aStyle._textLineColor)
@@ -152,24 +150,101 @@ void ElementDescriptor::readMultiPageModel( StyleBag * all_styles )
 
     // collect elements
     readDefaults();
-    readLongAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("ProgressValue") ),
+    readLongAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("MultiPageValue") ),
                   OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":value") ) );
-    readLongAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("ProgressValueMax") ),
-                  OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":value-max") ) );
+    Any aDecorationAny( _xProps->getPropertyValue( OUString( RTL_CONSTASCII_USTRINGPARAM("Decoration") ) ) );
+    bool bDecoration = sal_True;
+    if ( (aDecorationAny >>= bDecoration) && !bDecoration )
+        addAttribute( OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":withtabs") ), OUString( RTL_CONSTASCII_USTRINGPARAM("false") ) );
 
+    readEvents();
+    uno::Reference< container::XNameContainer > xPagesContainer( _xProps, uno::UNO_QUERY );
+    if ( xPagesContainer.is() && xPagesContainer->getElementNames().getLength() )
+    {
+        ElementDescriptor * pElem = new ElementDescriptor( _xProps, _xPropState, OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":bulletinboard") ), _xDocument );
+        pElem->readBullitinBoard( all_styles );
+        addSubElement( pElem );
+    }
+}
+//__________________________________________________________________________________________________
+void ElementDescriptor::readFrameModel( StyleBag * all_styles )
+{
+    // collect styles
+    Style aStyle( 0x1 | 0x2 | 0x8 | 0x20 );
+/*
+    if (readProp( OUString( RTL_CONSTASCII_USTRINGPARAM("BackgroundColor") ) ) >>= aStyle._backgroundColor)
+        aStyle._set |= 0x1;
+*/
+    if (readProp( OUString( RTL_CONSTASCII_USTRINGPARAM("TextColor") ) ) >>= aStyle._textColor)
+        aStyle._set |= 0x2;
+    if (readProp( OUString( RTL_CONSTASCII_USTRINGPARAM("TextLineColor") ) ) >>= aStyle._textLineColor)
+        aStyle._set |= 0x20;
+    if (readFontProps( this, aStyle ))
+        aStyle._set |= 0x8;
+    if (aStyle._set)
+    {
+        addAttribute( OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":style-id") ),
+                      all_styles->getStyleId( aStyle ) );
+    }
+
+    // collect elements
+    readDefaults();
     OUString aTitle;
-    if (readProp( OUString( RTL_CONSTASCII_USTRINGPARAM("Label") ) ) >>= aTitle)
+
+    if ( readProp( OUString( RTL_CONSTASCII_USTRINGPARAM("Label") ) ) >>= aTitle)
     {
         ElementDescriptor * title = new ElementDescriptor(
             _xProps, _xPropState,
-            OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":title") ) );
+            OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":title") ), _xDocument );
         title->addAttribute( OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":value") ),
                              aTitle );
         addSubElement( title );
     }
 
+    uno::Reference< container::XNameContainer > xControlContainer( _xProps, uno::UNO_QUERY );
+    if ( xControlContainer.is() && xControlContainer->getElementNames().getLength() )
+    {
+        ElementDescriptor * pElem = new ElementDescriptor( _xProps, _xPropState, OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":bulletinboard") ), _xDocument );
+        pElem->readBullitinBoard( all_styles );
+        addSubElement( pElem );
+    }
     readEvents();
 }
+//__________________________________________________________________________________________________
+void ElementDescriptor::readPageModel( StyleBag * all_styles )
+{
+    // collect styles
+    Style aStyle( 0x1 | 0x2 | 0x8 | 0x20 );
+    if (readProp( OUString( RTL_CONSTASCII_USTRINGPARAM("BackgroundColor") ) ) >>= aStyle._backgroundColor)
+        aStyle._set |= 0x1;
+    if (readProp( OUString( RTL_CONSTASCII_USTRINGPARAM("TextColor") ) ) >>= aStyle._textColor)
+        aStyle._set |= 0x2;
+    if (readProp( OUString( RTL_CONSTASCII_USTRINGPARAM("TextLineColor") ) ) >>= aStyle._textLineColor)
+        aStyle._set |= 0x20;
+    if (readFontProps( this, aStyle ))
+        aStyle._set |= 0x8;
+    if (aStyle._set)
+    {
+        addAttribute( OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":style-id") ),
+                      all_styles->getStyleId( aStyle ) );
+    }
+
+    // collect elements
+    readDefaults();
+    rtl::OUString aTitle;
+    readStringAttr(
+        OUString( RTL_CONSTASCII_USTRINGPARAM("Title") ),
+        OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":title") ) );
+    uno::Reference< container::XNameContainer > xControlContainer( _xProps, uno::UNO_QUERY );
+    if ( xControlContainer.is() && xControlContainer->getElementNames().getLength() )
+    {
+        ElementDescriptor * pElem = new ElementDescriptor( _xProps, _xPropState, OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":bulletinboard") ), _xDocument );
+        pElem->readBullitinBoard( all_styles );
+        addSubElement( pElem );
+    }
+    readEvents();
+}
+
 void ElementDescriptor::readButtonModel( StyleBag * all_styles )
     SAL_THROW( (Exception) )
 {
@@ -203,8 +278,10 @@ void ElementDescriptor::readButtonModel( StyleBag * all_styles )
                            OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":valign") ) );
     readButtonTypeAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("PushButtonType") ),
                         OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":button-type") ) );
-    readStringAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("ImageURL") ),
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":image-src") ) );
+    readImageURLAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("ImageURL") ),
+                           OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":image-src") ) );
+
+
     readImagePositionAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("ImagePosition") ),
                            OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":image-position") ) );
     readImageAlignAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("ImageAlign") ),
@@ -274,8 +351,8 @@ void ElementDescriptor::readCheckBoxModel( StyleBag * all_styles )
                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":align") ) );
     readVerticalAlignAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("VerticalAlign") ),
                            OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":valign") ) );
-    readStringAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("ImageURL") ),
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":image-src") ) );
+    readImageURLAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("ImageURL") ),
+                           OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":image-src") ) );
     readImagePositionAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("ImagePosition") ),
                            OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":image-position") ) );
     readBoolAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("MultiLine") ),
@@ -311,7 +388,7 @@ void ElementDescriptor::readCheckBoxModel( StyleBag * all_styles )
     readEvents();
 }
 //__________________________________________________________________________________________________
-void ElementDescriptor::readComboBoxModel( StyleBag * all_styles, Reference< frame::XModel > const & xDocument )
+void ElementDescriptor::readComboBoxModel( StyleBag * all_styles )
     SAL_THROW( (Exception) )
 {
     // collect styles
@@ -353,7 +430,7 @@ void ElementDescriptor::readComboBoxModel( StyleBag * all_styles, Reference< fra
     readShortAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("LineCount") ),
                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":linecount") ) );
     // Cell Range, Ref Cell etc.
-    lclExportBindableAndListSourceBits( xDocument, _xProps, *this );
+    lclExportBindableAndListSourceBits( _xDocument, _xProps, *this );
     // string item list
     Sequence< OUString > itemValues;
     if ((readProp( OUString( RTL_CONSTASCII_USTRINGPARAM("StringItemList") ) ) >>= itemValues) &&
@@ -361,14 +438,14 @@ void ElementDescriptor::readComboBoxModel( StyleBag * all_styles, Reference< fra
     {
         ElementDescriptor * popup = new ElementDescriptor(
             _xProps, _xPropState,
-            OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":menupopup") ) );
+            OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":menupopup") ), _xDocument );
 
         OUString const * pItemValues = itemValues.getConstArray();
         for ( sal_Int32 nPos = 0; nPos < itemValues.getLength(); ++nPos )
         {
             ElementDescriptor * item = new ElementDescriptor(
                 _xProps, _xPropState,
-                OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":menuitem") ) );
+                OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":menuitem") ), _xDocument );
             item->addAttribute( OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":value") ),
                                 pItemValues[ nPos ] );
             popup->addSubElement( item );
@@ -379,7 +456,7 @@ void ElementDescriptor::readComboBoxModel( StyleBag * all_styles, Reference< fra
     readEvents();
 }
 //__________________________________________________________________________________________________
-void ElementDescriptor::readListBoxModel( StyleBag * all_styles, Reference< frame::XModel > const & xDocument  )
+void ElementDescriptor::readListBoxModel( StyleBag * all_styles )
     SAL_THROW( (Exception) )
 {
     // collect styles
@@ -414,7 +491,7 @@ void ElementDescriptor::readListBoxModel( StyleBag * all_styles, Reference< fram
                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":linecount") ) );
     readAlignAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("Align") ),
                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":align") ) );
-    lclExportBindableAndListSourceBits( xDocument, _xProps, *this );
+    lclExportBindableAndListSourceBits( _xDocument, _xProps, *this );
     // string item list
     Sequence< OUString > itemValues;
     if ((readProp( OUString( RTL_CONSTASCII_USTRINGPARAM("StringItemList") ) ) >>= itemValues) &&
@@ -422,7 +499,7 @@ void ElementDescriptor::readListBoxModel( StyleBag * all_styles, Reference< fram
     {
         ElementDescriptor * popup = new ElementDescriptor(
             _xProps, _xPropState,
-            OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":menupopup") ) );
+            OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":menupopup") ), _xDocument );
 
         OUString const * pItemValues = itemValues.getConstArray();
         sal_Int32 nPos;
@@ -430,7 +507,7 @@ void ElementDescriptor::readListBoxModel( StyleBag * all_styles, Reference< fram
         {
             ElementDescriptor * item = new ElementDescriptor(
                 _xProps, _xPropState,
-                OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":menuitem") ) );
+                OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":menuitem") ), _xDocument );
             item->addAttribute( OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":value") ),
                                 pItemValues[ nPos ] );
             popup->addSubElement( item );
@@ -454,7 +531,7 @@ void ElementDescriptor::readListBoxModel( StyleBag * all_styles, Reference< fram
     readEvents();
 }
 //__________________________________________________________________________________________________
-void ElementDescriptor::readRadioButtonModel( StyleBag * all_styles, Reference< frame::XModel > const & xDocument  )
+void ElementDescriptor::readRadioButtonModel( StyleBag * all_styles )
     SAL_THROW( (Exception) )
 {
     // collect styles
@@ -485,8 +562,8 @@ void ElementDescriptor::readRadioButtonModel( StyleBag * all_styles, Reference<
                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":align") ) );
     readVerticalAlignAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("VerticalAlign") ),
                            OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":valign") ) );
-    readStringAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("ImageURL") ),
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":image-src") ) );
+    readImageURLAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("ImageURL") ),
+                           OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":image-src") ) );
     readImagePositionAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("ImagePosition") ),
                            OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":image-position") ) );
     readBoolAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("MultiLine") ),
@@ -512,7 +589,7 @@ void ElementDescriptor::readRadioButtonModel( StyleBag * all_styles, Reference<
             break;
         }
     }
-    lclExportBindableAndListSourceBits( xDocument, _xProps, *this );
+    lclExportBindableAndListSourceBits( _xDocument, _xProps, *this );
     readEvents();
 }
 //__________________________________________________________________________________________________
@@ -537,11 +614,11 @@ void ElementDescriptor::readGroupBoxModel( StyleBag * all_styles )
     readDefaults();
 
     OUString aTitle;
-    if (readProp( OUString( RTL_CONSTASCII_USTRINGPARAM("Label") ) ) >>= aTitle)
+    if (readProp( OUString( RTL_CONSTASCII_USTRINGPARAM("Label") ) ) >>= aTitle )
     {
         ElementDescriptor * title = new ElementDescriptor(
             _xProps, _xPropState,
-            OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":title") ) );
+            OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":title") ), _xDocument );
         title->addAttribute( OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":value") ),
                              aTitle );
         addSubElement( title );
@@ -685,7 +762,7 @@ void ElementDescriptor::readEditModel( StyleBag * all_styles )
     readEvents();
 }
 //__________________________________________________________________________________________________
-void ElementDescriptor::readImageControlModel( StyleBag * all_styles, com::sun::star::uno::Reference< com::sun::star::frame::XModel > const & xDocument )
+void ElementDescriptor::readImageControlModel( StyleBag * all_styles )
     SAL_THROW( (Exception) )
 {
     // collect styles
@@ -704,33 +781,10 @@ void ElementDescriptor::readImageControlModel( StyleBag * all_styles, com::sun::
     readDefaults();
     readBoolAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("ScaleImage") ),
                   OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":scale-image") ) );
-    rtl::OUString sURL;
-    _xProps->getPropertyValue( OUSTR("ImageURL") ) >>= sURL;
-
-    if ( sURL.indexOf( rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( "vnd.sun.star.GraphicObject:"  ) ) ) == 0 )
-    {
-        Reference< document::XStorageBasedDocument > xDocStorage( xDocument, UNO_QUERY );
-
-        if ( xDocStorage.is() )
-        {
-            uno::Sequence< Any > aArgs( 1 );
-            aArgs[ 0 ] <<= xDocStorage->getDocumentStorage();
-
-            ::comphelper::ComponentContext aContext( ::comphelper::getProcessServiceFactory() );
-            uno::Reference< document::XGraphicObjectResolver > xGraphicResolver;
-            aContext.createComponentWithArguments( OUSTR( "com.sun.star.comp.Svx.GraphicExportHelper" ), aArgs, xGraphicResolver );
-            if ( xGraphicResolver.is() )
-            {
-                sURL = xGraphicResolver->resolveGraphicObjectURL( sURL );
-            }
-        }
-    }
-    if ( sURL.getLength() > 0 )
-    {
-        addAttribute( OUSTR(XMLNS_DIALOGS_PREFIX ":src"), sURL );
-    }
     readBoolAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("Tabstop") ),
                   OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":tabstop") ) );
+    readImageURLAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("ImageURL") ),
+                      OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":src") ) );
     readEvents();
 }
 //__________________________________________________________________________________________________
@@ -1148,6 +1202,7 @@ void ElementDescriptor::readFormattedFieldModel( StyleBag * all_styles )
     
     readEvents();
 }
+
 //__________________________________________________________________________________________________
 void ElementDescriptor::readFixedLineModel( StyleBag * all_styles )
     SAL_THROW( (Exception) )
@@ -1203,7 +1258,7 @@ void ElementDescriptor::readProgressBarModel( StyleBag * all_styles )
     readEvents();
 }
 //__________________________________________________________________________________________________
-void ElementDescriptor::readScrollBarModel( StyleBag * all_styles, Reference< frame::XModel > const & xDocument  )
+void ElementDescriptor::readScrollBarModel( StyleBag * all_styles )
     SAL_THROW( (Exception) )
 {
     // collect styles
@@ -1242,11 +1297,11 @@ void ElementDescriptor::readScrollBarModel( StyleBag * all_styles, Reference< fr
     readHexLongAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("SymbolColor") ),
                      OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":symbol-color") ) );
     // Cell Range, Ref Cell etc.
-    lclExportBindableAndListSourceBits( xDocument, _xProps, *this );
+    lclExportBindableAndListSourceBits( _xDocument, _xProps, *this );
     readEvents();
 }
 //__________________________________________________________________________________________________
-void ElementDescriptor::readSpinButtonModel( StyleBag * all_styles, Reference< frame::XModel > const & xDocument  )
+void ElementDescriptor::readSpinButtonModel( StyleBag * all_styles )
     SAL_THROW( (Exception) )
 {
     // collect styles
@@ -1281,7 +1336,7 @@ void ElementDescriptor::readSpinButtonModel( StyleBag * all_styles, Reference< f
     readHexLongAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("SymbolColor") ),
                      OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":symbol-color") ) );
     // Cell Range, Ref Cell etc.
-    lclExportBindableAndListSourceBits( xDocument, _xProps, *this );
+    lclExportBindableAndListSourceBits( _xDocument, _xProps, *this );
     readEvents();
 }
 //__________________________________________________________________________________________________
@@ -1331,10 +1386,254 @@ void ElementDescriptor::readDialogModel( StyleBag * all_styles )
         addAttribute( OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":withtitlebar") ),
                       OUString( RTL_CONSTASCII_USTRINGPARAM("false") ) ); 
 
-    readStringAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("ImageURL") ),
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":image-src") ) ); 
+    readImageURLAttr( OUString( RTL_CONSTASCII_USTRINGPARAM("ImageURL") ),
+                           OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":image-src") ) );
 
     readEvents();
 }
 
+void ElementDescriptor::readBullitinBoard( StyleBag * all_styles )
+    SAL_THROW( (Exception) )
+{
+    // collect elements
+    ::std::vector< ElementDescriptor* > all_elements;
+    // read out all props
+    Reference<  container::XNameContainer > xDialogModel( _xProps, UNO_QUERY );
+    if ( !xDialogModel.is() )
+        return; // #TODO throw???
+    Sequence< OUString > aElements( xDialogModel->getElementNames() );
+    OUString const * pElements = aElements.getConstArray();
+
+    ElementDescriptor * pRadioGroup = 0;
+
+    sal_Int32 nPos;
+    for ( nPos = 0; nPos < aElements.getLength(); ++nPos )
+    {
+        Any aControlModel( xDialogModel->getByName( pElements[ nPos ] ) );
+        Reference< beans::XPropertySet > xProps;
+        OSL_VERIFY( aControlModel >>= xProps );
+        if (! xProps.is())
+            continue;
+        Reference< beans::XPropertyState > xPropState( xProps, UNO_QUERY );
+        OSL_ENSURE( xPropState.is(), "no XPropertyState!" );
+        if (! xPropState.is())
+            continue;
+        Reference< lang::XServiceInfo > xServiceInfo( xProps, UNO_QUERY );
+        OSL_ENSURE( xServiceInfo.is(), "no XServiceInfo!" );
+        if (! xServiceInfo.is())
+            continue;
+
+        ElementDescriptor * pElem = 0;
+
+        // group up radio buttons
+        if ( xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlRadioButtonModel") ) ) )
+        {
+            if (! pRadioGroup) // open radiogroup
+            {
+                pRadioGroup = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":radiogroup") ), _xDocument );
+                all_elements.push_back( pRadioGroup );
+            }
+
+            pElem = new ElementDescriptor(
+                xProps, xPropState,
+                OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":radio") ), _xDocument );
+            pElem->readRadioButtonModel( all_styles );
+            pRadioGroup->addSubElement( pElem );
+        }
+        else // no radio
+        {
+            pRadioGroup = 0; // close radiogroup
+
+            if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlButtonModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":button") ), _xDocument );
+                pElem->readButtonModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlCheckBoxModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":checkbox") ), _xDocument );
+                pElem->readCheckBoxModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlComboBoxModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":combobox") ), _xDocument );
+                pElem->readComboBoxModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlListBoxModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":menulist") ), _xDocument );
+                pElem->readListBoxModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlGroupBoxModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":titledbox") ), _xDocument );
+                pElem->readGroupBoxModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoMultiPageModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":multipage") ), _xDocument );
+                pElem->readMultiPageModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoFrameModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":frame") ), _xDocument );
+                pElem->readFrameModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoPageModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":page") ), _xDocument );
+                pElem->readPageModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlFixedTextModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":text") ), _xDocument );
+                pElem->readFixedTextModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlEditModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":textfield") ), _xDocument );
+                pElem->readEditModel( all_styles );
+            }
+            // FixedHyperLink
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlFixedHyperlinkModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":linklabel") ), _xDocument );
+                pElem->readFixedHyperLinkModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlImageControlModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":img") ), _xDocument );
+                pElem->readImageControlModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlFileControlModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":filecontrol") ), _xDocument );
+                pElem->readFileControlModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.tree.TreeControlModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":treecontrol") ), _xDocument );
+                pElem->readTreeControlModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlCurrencyFieldModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":currencyfield") ), _xDocument );
+                pElem->readCurrencyFieldModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlDateFieldModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":datefield") ), _xDocument );
+                pElem->readDateFieldModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlNumericFieldModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":numericfield") ), _xDocument );
+                pElem->readNumericFieldModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlTimeFieldModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":timefield") ) , _xDocument);
+                pElem->readTimeFieldModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlPatternFieldModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":patternfield") ), _xDocument );
+                pElem->readPatternFieldModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlFormattedFieldModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":formattedfield") ), _xDocument );
+                pElem->readFormattedFieldModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlFixedLineModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":fixedline") ), _xDocument );
+                pElem->readFixedLineModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlScrollBarModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":scrollbar") ), _xDocument );
+                pElem->readScrollBarModel( all_styles );
+            }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlSpinButtonModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":spinbutton") ), _xDocument );
+                pElem->readSpinButtonModel( all_styles );
+             }
+            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlProgressBarModel") ) ) )
+            {
+                pElem = new ElementDescriptor(
+                    xProps, xPropState,
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":progressmeter") ), _xDocument );
+                pElem->readProgressBarModel( all_styles );
+            }
+            //
+
+            if (pElem)
+            {
+                all_elements.push_back( pElem );
+            }
+            else
+            {
+                OSL_ENSURE( sal_False, "unknown control type!" );
+                continue;
+            }
+        }
+    }
+    if (! all_elements.empty())
+    {
+        for ( std::size_t n = 0; n < all_elements.size(); ++n )
+        {
+            addSubElement( all_elements[ n ] );
+        }
+    }
+}
 }
diff --git a/xmlscript/source/xmldlg_imexp/xmldlg_export.cxx b/xmlscript/source/xmldlg_imexp/xmldlg_export.cxx
index 09f8c49..c8fb324 100644
--- a/xmlscript/source/xmldlg_imexp/xmldlg_export.cxx
+++ b/xmlscript/source/xmldlg_imexp/xmldlg_export.cxx
@@ -57,6 +57,12 @@
 
 #include <com/sun/star/view/SelectionType.hpp>
 
+#include <com/sun/star/lang/XServiceInfo.hpp>
+#include <com/sun/star/document/XStorageBasedDocument.hpp>
+#include <com/sun/star/document/XGraphicObjectResolver.hpp>
+
+#include <comphelper/componentcontext.hxx>
+#include <comphelper/processfactory.hxx>
 
 using namespace ::com::sun::star;
 using namespace ::com::sun::star::uno;
@@ -776,6 +782,33 @@ void ElementDescriptor::readVerticalAlignAttr( OUString const & rPropName, OUStr
     }
 }
 //__________________________________________________________________________________________________
+void ElementDescriptor::readImageURLAttr( OUString const & rPropName, OUString const & rAttrName )
+{
+    if (beans::PropertyState_DEFAULT_VALUE != _xPropState->getPropertyState( rPropName ))
+    {
+        rtl::OUString sURL;
+        _xProps->getPropertyValue( rPropName ) >>= sURL;
+
+        if ( sURL.getLength() && sURL.compareToAscii( XMLSCRIPT_GRAPHOBJ_URLPREFIX, RTL_CONSTASCII_LENGTH( XMLSCRIPT_GRAPHOBJ_URLPREFIX ) ) == 0 )
+        {
+            Reference< document::XStorageBasedDocument > xDocStorage( _xDocument, UNO_QUERY );
+            if ( xDocStorage.is() )
+            {
+                uno::Sequence< Any > aArgs( 1 );
+                aArgs[ 0 ] <<= xDocStorage->getDocumentStorage();
+
+                ::comphelper::ComponentContext aContext( ::comphelper::getProcessServiceFactory() );
+                uno::Reference< document::XGraphicObjectResolver > xGraphicResolver;
+                aContext.createComponentWithArguments( OUSTR( "com.sun.star.comp.Svx.GraphicExportHelper" ), aArgs, xGraphicResolver );
+                if ( xGraphicResolver.is() )
+                    sURL = xGraphicResolver->resolveGraphicObjectURL( sURL );
+            }
+        }
+        if ( sURL.getLength() )
+                addAttribute( rAttrName, sURL );
+    }
+}
+//__________________________________________________________________________________________________
 void ElementDescriptor::readImageAlignAttr( OUString const & rPropName, OUString const & rAttrName )
 {
     if (beans::PropertyState_DEFAULT_VALUE != _xPropState->getPropertyState( rPropName ))
@@ -1330,249 +1363,18 @@ void SAL_CALL exportDialogModel(
     SAL_THROW( (Exception) )
 {
     StyleBag all_styles;
-    ::std::vector< Reference< xml::sax::XAttributeList > > all_elements;
-    
-    // read out all props
-
-    Sequence< OUString > aElements( xDialogModel->getElementNames() );
-    OUString const * pElements = aElements.getConstArray();
-    
-    ElementDescriptor * pRadioGroup = 0;
-    
-    sal_Int32 nPos;
-    for ( nPos = 0; nPos < aElements.getLength(); ++nPos )
-    {
-        Any aControlModel( xDialogModel->getByName( pElements[ nPos ] ) );
-        Reference< beans::XPropertySet > xProps;
-        OSL_VERIFY( aControlModel >>= xProps );
-        if (! xProps.is())
-            continue;
-        Reference< beans::XPropertyState > xPropState( xProps, UNO_QUERY );
-        OSL_ENSURE( xPropState.is(), "no XPropertyState!" );
-        if (! xPropState.is())
-            continue;
-        Reference< lang::XServiceInfo > xServiceInfo( xProps, UNO_QUERY );
-        OSL_ENSURE( xServiceInfo.is(), "no XServiceInfo!" );
-        if (! xServiceInfo.is())
-            continue;
+    // window
+    Reference< beans::XPropertySet > xProps( xDialogModel, UNO_QUERY );
+    OSL_ASSERT( xProps.is() );
+    Reference< beans::XPropertyState > xPropState( xProps, UNO_QUERY );
+    OSL_ASSERT( xPropState.is() );
 
-        ElementDescriptor * pElem = 0;
-        Reference< xml::sax::XAttributeList > xElem;
-        
-        // group up radio buttons
-        if ( xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlRadioButtonModel") ) ) )
-        {
-            if (! pRadioGroup) // open radiogroup
-            {
-                pRadioGroup = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":radiogroup") ) );
-                all_elements.push_back( pRadioGroup );
-            }
-            
-            pElem = new ElementDescriptor(
-                xProps, xPropState,
-                OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":radio") ) );
-            xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-            pElem->readRadioButtonModel( &all_styles, xDocument  );
-            pRadioGroup->addSubElement( xElem );
-        }
-        else // no radio
-        {
-            pRadioGroup = 0; // close radiogroup
-            
-            if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlButtonModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":button") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readButtonModel( &all_styles );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlCheckBoxModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":checkbox") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readCheckBoxModel( &all_styles );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlComboBoxModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":combobox") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readComboBoxModel( &all_styles, xDocument );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlListBoxModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":menulist") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readListBoxModel( &all_styles, xDocument );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlGroupBoxModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":titledbox") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readGroupBoxModel( &all_styles );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoMultiPageModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":multipage") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readMultiPageModel( &all_styles );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlFixedTextModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":text") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readFixedTextModel( &all_styles );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlEditModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":textfield") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readEditModel( &all_styles );
-            }
-            // FixedHyperLink
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlFixedHyperlinkModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
+    ElementDescriptor * pElem = new ElementDescriptor(
                     xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":linklabel") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readFixedHyperLinkModel( &all_styles );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlImageControlModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":img") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readImageControlModel( &all_styles, xDocument );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlFileControlModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":filecontrol") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readFileControlModel( &all_styles );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.tree.TreeControlModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":treecontrol") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readTreeControlModel( &all_styles );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlCurrencyFieldModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":currencyfield") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readCurrencyFieldModel( &all_styles );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlDateFieldModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":datefield") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readDateFieldModel( &all_styles );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlNumericFieldModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":numericfield") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readNumericFieldModel( &all_styles );
-            }           
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlTimeFieldModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":timefield") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readTimeFieldModel( &all_styles );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlPatternFieldModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":patternfield") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readPatternFieldModel( &all_styles );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlFormattedFieldModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":formattedfield") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readFormattedFieldModel( &all_styles );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlFixedLineModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":fixedline") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readFixedLineModel( &all_styles );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlScrollBarModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":scrollbar") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readScrollBarModel( &all_styles, xDocument );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlSpinButtonModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":spinbutton") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readSpinButtonModel( &all_styles, xDocument );
-            }
-            else if (xServiceInfo->supportsService( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlProgressBarModel") ) ) )
-            {
-                pElem = new ElementDescriptor(
-                    xProps, xPropState,
-                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":progressmeter") ) );
-                xElem = static_cast< xml::sax::XAttributeList * >( pElem );
-                pElem->readProgressBarModel( &all_styles );
-            }
-            //
-            
-            OSL_ASSERT( xElem.is() );
-            if (xElem.is())
-            {
-                all_elements.push_back( xElem );
-            }
-            else
-            {
-                OSL_ENSURE( sal_False, "unknown control type!" );
-                continue;
-            }
-        }
-    }
-    
+                    OUString( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":bulletinboard") ), xDocument );
+    Reference< xml::sax::XAttributeList > xElem( pElem );
+    pElem->readBullitinBoard( &all_styles );
+
     xOut->startDocument();
     
     OUString aDocTypeStr( RTL_CONSTASCII_USTRINGPARAM(
@@ -1581,14 +1383,9 @@ void SAL_CALL exportDialogModel(
     xOut->unknown( aDocTypeStr );
     xOut->ignorableWhitespace( OUString() );
     
-    // window
-    Reference< beans::XPropertySet > xProps( xDialogModel, UNO_QUERY );
-    OSL_ASSERT( xProps.is() );
-    Reference< beans::XPropertyState > xPropState( xProps, UNO_QUERY );
-    OSL_ASSERT( xPropState.is() );
     
     OUString aWindowName( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":window") );
-    ElementDescriptor * pWindow = new ElementDescriptor( xProps, xPropState, aWindowName );
+    ElementDescriptor * pWindow = new ElementDescriptor( xProps, xPropState, aWindowName, xDocument );
     Reference< xml::sax::XAttributeList > xWindow( pWindow );
     pWindow->readDialogModel( &all_styles );
     xOut->ignorableWhitespace( OUString() );
@@ -1598,20 +1395,14 @@ void SAL_CALL exportDialogModel(
     // dump out stylebag
     all_styles.dump( xOut );
     
-    if (! all_elements.empty())
+    if ( xDialogModel->getElementNames().getLength() )
     {   
         // open up bulletinboard
         OUString aBBoardName( RTL_CONSTASCII_USTRINGPARAM(XMLNS_DIALOGS_PREFIX ":bulletinboard") );
         xOut->ignorableWhitespace( OUString() );
-        xOut->startElement( aBBoardName, Reference< xml::sax::XAttributeList >() );
-        
-        // export control elements
-        for ( std::size_t n = 0; n < all_elements.size(); ++n )
-        {
-            ElementDescriptor * pElem = static_cast< ElementDescriptor * >( all_elements[ n ].get() );
-            pElem->dump( xOut.get() );
-        }
+        xOut->startElement( aBBoardName, xElem );
         
+        pElem->dumpSubElements( xOut.get() );
         // end bulletinboard
         xOut->ignorableWhitespace( OUString() );
         xOut->endElement( aBBoardName );
diff --git a/xmlscript/source/xmldlg_imexp/xmldlg_impmodels.cxx b/xmlscript/source/xmldlg_imexp/xmldlg_impmodels.cxx
index 9652804..60be93d 100644
--- a/xmlscript/source/xmldlg_imexp/xmldlg_impmodels.cxx
+++ b/xmlscript/source/xmldlg_imexp/xmldlg_impmodels.cxx
@@ -37,30 +37,36 @@
 #include <com/sun/star/beans/XPropertySet.hpp>
 #include <com/sun/star/beans/XPropertyState.hpp>
 #include <com/sun/star/document/XStorageBasedDocument.hpp>
-#include <com/sun/star/document/XGraphicObjectResolver.hpp>
 #include <com/sun/star/script/XVBACompat.hpp>
 
-#include <comphelper/componentcontext.hxx>
-#include <comphelper/processfactory.hxx>
 using namespace ::com::sun::star;
 using namespace ::com::sun::star::uno;
 using ::rtl::OUString;
 
 namespace xmlscript
 {
-Reference< xml::input::XElement > MultiPage::startChildElement(
+
+Reference< xml::input::XElement > Frame::startChildElement(
     sal_Int32 nUid, OUString const & rLocalName,
     Reference< xml::input::XAttributes > const & xAttributes )
     throw (xml::sax::SAXException, RuntimeException)
 {
+    if ( !m_xContainer.is() )
+        m_xContainer.set( _pImport->_xDialogModelFactory->createInstance( rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoFrameModel") ) ), UNO_QUERY );
     // event
-rtl::OUString _label = rtl::OUString::createFromAscii("foo");
     if (_pImport->isEventElement( nUid, rLocalName ))
     {
         return new EventElement(
             nUid, rLocalName, xAttributes, this, _pImport );
     }
-    else if (rLocalName.equalsAsciiL( RTL_CONSTASCII_STRINGPARAM("title") ))
+    else if (rLocalName.equalsAsciiL( RTL_CONSTASCII_STRINGPARAM("bulletinboard") ))
+    {
+        // Create new DialogImport for this container
+        DialogImport* pFrameImport = new DialogImport( *_pImport );
+                pFrameImport->_xDialogModel = m_xContainer;
+        return new BulletinBoardElement( rLocalName, xAttributes, this,  pFrameImport );
+    }
+        else if (rLocalName.equalsAsciiL( RTL_CONSTASCII_STRINGPARAM("title") ))
     {
         getStringAttr( &_label,
                        OUString( RTL_CONSTASCII_USTRINGPARAM("value") ),
@@ -73,6 +79,69 @@ rtl::OUString _label = rtl::OUString::createFromAscii("foo");
     }
     else
     {
+                OSL_TRACE("****** ARGGGGG!!!! **********");
+        throw xml::sax::SAXException(
+            OUString( RTL_CONSTASCII_USTRINGPARAM("expected event element!") ),
+            Reference< XInterface >(), Any() );
+    }
+}
+//__________________________________________________________________________________________________
+
+void Frame::endElement()
+    throw (xml::sax::SAXException, RuntimeException)
+{
+        if ( !m_xContainer.is() )
+            m_xContainer.set( _pImport->_xDialogModelFactory->createInstance( rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoFrameModel") ) ), UNO_QUERY );
+        Reference< beans::XPropertySet > xProps( m_xContainer, UNO_QUERY_THROW );
+        // _pImport is what we need to add to ( e.g. the dialog in this case )
+    ControlImportContext ctx( _pImport, xProps,   getControlId( _xAttributes ) );
+
+    Reference< beans::XPropertySet > xControlModel( ctx.getControlModel() );
+
+    Reference< xml::input::XElement > xStyle( getStyle( _xAttributes ) );
+    if (xStyle.is())
+    {
+        StyleElement * pStyle = static_cast< StyleElement * >( xStyle.get () );
+        pStyle->importTextColorStyle( xControlModel );
+        pStyle->importTextLineColorStyle( xControlModel );
+        pStyle->importFontStyle( xControlModel );
+    }
+
+    ctx.importDefaults( 0, 0, _xAttributes ); // inherited from BulletinBoardElement
+    if (_label.getLength())
+    {
+        xControlModel->setPropertyValue( OUString( RTL_CONSTASCII_USTRINGPARAM("Label") ),
+                                         makeAny( _label ) );
+    }
+    ctx.importEvents( _events );
+    // avoid ring-reference:
+    // vector< event elements > holding event elements holding this (via _pParent)
+    _events.clear();
+}
+
+//===
+Reference< xml::input::XElement > MultiPage::startChildElement(
+    sal_Int32 nUid, OUString const & rLocalName,
+    Reference< xml::input::XAttributes > const & xAttributes )
+    throw (xml::sax::SAXException, RuntimeException)
+{
+    // event
+rtl::OUString _label = rtl::OUString::createFromAscii("foo");
+    if (_pImport->isEventElement( nUid, rLocalName ))
+    {
+        return new EventElement(
+            nUid, rLocalName, xAttributes, this, _pImport );
+    }
+    else if (rLocalName.equalsAsciiL( RTL_CONSTASCII_STRINGPARAM("bulletinboard") ))
+    {
+        // Create new DialogImport for this container
+
+        DialogImport* pMultiPageImport = new DialogImport( *_pImport );
+                pMultiPageImport->_xDialogModel = m_xContainer;
+        return new BulletinBoardElement( rLocalName, xAttributes, this,  pMultiPageImport );
+    }
+    else
+    {
 
         throw xml::sax::SAXException(
             OUString( RTL_CONSTASCII_USTRINGPARAM("expected event element!") ),
@@ -84,10 +153,10 @@ rtl::OUString _label = rtl::OUString::createFromAscii("foo");
 void MultiPage::endElement()
     throw (xml::sax::SAXException, RuntimeException)
 {
-    ControlImportContext ctx(
-        _pImport, getControlId( _xAttributes ),
-        OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoMultiPageModel") ) );
-//		OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.awt.UnoControlGroupBoxModel") ) );
+        Reference< beans::XPropertySet > xProps( m_xContainer, UNO_QUERY_THROW );
+        // _pImport is what we need to add to ( e.g. the dialog in this case )
+    ControlImportContext ctx( _pImport, xProps, getControlId( _xAttributes ));
+
     Reference< beans::XPropertySet > xControlModel( ctx.getControlModel() );
 
     Reference< xml::input::XElement > xStyle( getStyle( _xAttributes ) );
@@ -97,62 +166,76 @@ void MultiPage::endElement()
         pStyle->importTextColorStyle( xControlModel );
         pStyle->importTextLineColorStyle( xControlModel );
         pStyle->importFontStyle( xControlModel );
+        pStyle->importBackgroundColorStyle( xControlModel );
     }
 
     ctx.importDefaults( 0, 0, _xAttributes ); // inherited from BulletinBoardElement
-    ctx.importLongProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("ProgressValue") ),
+    ctx.importLongProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("MultiPageValue") ),
                             OUString( RTL_CONSTASCII_USTRINGPARAM("value") ),
                             _xAttributes );
-    ctx.importLongProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("ProgressValueMax") ),
-                            OUString( RTL_CONSTASCII_USTRINGPARAM("value-max") ),
-                            _xAttributes );
+        ctx.importBooleanProperty(
+            OUString( RTL_CONSTASCII_USTRINGPARAM("Decoration") ),
+            OUString( RTL_CONSTASCII_USTRINGPARAM("withtabs") ),
+        _xAttributes );
     ctx.importEvents( _events );
     // avoid ring-reference:
     // vector< event elements > holding event elements holding this (via _pParent)
     _events.clear();
 }
 
-// #FIXME cut'n'pasted from xmloff/source/core/xmlimp.cxx:1251
-// of course we need to find a common home for this helper
-
-bool IsPackageURL( const ::rtl::OUString& rURL )
+Reference< xml::input::XElement > Page::startChildElement(
+    sal_Int32 nUid, OUString const & rLocalName,
+    Reference< xml::input::XAttributes > const & xAttributes )
+    throw (xml::sax::SAXException, RuntimeException)
 {
-    // Some quick tests: Some may rely on the package structure!
-    sal_Int32 nLen = rURL.getLength();
-    if( (nLen > 0 && '/' == rURL[0]) )
-        // RFC2396 net_path or abs_path
-        return false;
-    else if( nLen > 1 && '.' == rURL[0] )
+    // event
+    if (_pImport->isEventElement( nUid, rLocalName ))
     {
-        if( '.' == rURL[1] )
-            // ../: We are never going up one level, so we know
-            // it's not an external URI
-            return false;
-        else if( '/' == rURL[1] )
-            // we are remaining on a level, so it's an package URI
-            return true;
+        return new EventElement(
+            nUid, rLocalName, xAttributes, this, _pImport );
     }
+    else if (rLocalName.equalsAsciiL( RTL_CONSTASCII_STRINGPARAM("bulletinboard") ))
+    {
 
-    // Now check for a RFC2396 schema
-    sal_Int32 nPos = 1;
-    while( nPos < nLen )
+        DialogImport* pPageImport = new DialogImport( *_pImport );
+                pPageImport->_xDialogModel = m_xContainer;
+        return new BulletinBoardElement( rLocalName, xAttributes, this,  pPageImport );
+    }
+    else
     {
-        switch( rURL[nPos] )
-        {
-            case '/':
-                // a relative path segement
-                return true;
-            case ':':
-                // a schema
-                return false;
-            default:
-                break;
-                // we don't care about any other characters
-        }
-        ++nPos;
+
+        throw xml::sax::SAXException(
+            OUString( RTL_CONSTASCII_USTRINGPARAM("expected event element!") ),
+            Reference< XInterface >(), Any() );
+    }
+}
+//__________________________________________________________________________________________________
+
+void Page::endElement()
+    throw (xml::sax::SAXException, RuntimeException)
+{
+        Reference< beans::XPropertySet > xProps( m_xContainer, UNO_QUERY_THROW );
+
+    ControlImportContext ctx( _pImport, xProps, getControlId( _xAttributes ));
+
+    Reference< beans::XPropertySet > xControlModel( ctx.getControlModel() );
+
+    Reference< xml::input::XElement > xStyle( getStyle( _xAttributes ) );
+    if (xStyle.is())
+    {
+        StyleElement * pStyle = static_cast< StyleElement * >( xStyle.get () );
+        pStyle->importTextColorStyle( xControlModel );
+        pStyle->importTextLineColorStyle( xControlModel );
+        pStyle->importFontStyle( xControlModel );
+        pStyle->importBackgroundColorStyle( xControlModel );
     }
 
-    return true;
+    ctx.importDefaults( 0, 0, _xAttributes ); // inherited from BulletinBoardElement
+    ctx.importStringProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("Title") ), OUString( RTL_CONSTASCII_USTRINGPARAM("title") ), _xAttributes );
+    ctx.importEvents( _events );
+    // avoid ring-reference:
+    // vector< event elements > holding event elements holding this (via _pParent)
+    _events.clear();
 }
 
 void importBindableAndListRangeBits( DialogImport* _pImport, const rtl::OUString sLinkedCell, const rtl::OUString & sCellRange, ControlImportContext& ctx )
@@ -450,7 +533,6 @@ void SpinButtonElement::endElement()
 }
 
 //##################################################################################################
-
 // fixedline
 //__________________________________________________________________________________________________
 Reference< xml::input::XElement > FixedLineElement::startChildElement(
@@ -1278,37 +1360,7 @@ void ImageControlElement::endElement()
     ctx.importBooleanProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("ScaleImage") ),
                                OUString( RTL_CONSTASCII_USTRINGPARAM("scale-image") ),
                                _xAttributes );
-    rtl::OUString sURL = _xAttributes->getValueByUidName( _pImport->XMLNS_DIALOGS_UID, OUSTR( "src" ) );
-    Reference< document::XStorageBasedDocument > xDocStorage( _pImport->getDocOwner(), UNO_QUERY );
-
-    if ( xDocStorage.is() && IsPackageURL( sURL ) )
-    {
-        uno::Sequence< Any > aArgs( 1 );
-        aArgs[ 0 ] <<= xDocStorage->getDocumentStorage();
-
-        ::comphelper::ComponentContext aContext( ::comphelper::getProcessServiceFactory() );
-        uno::Reference< document::XGraphicObjectResolver > xGraphicResolver;
-        aContext.createComponentWithArguments( OUSTR( "com.sun.star.comp.Svx.GraphicImportHelper" ), aArgs, xGraphicResolver );
-
-        if ( xGraphicResolver.is() )
-        {
-            rtl::OUString aTmp( RTL_CONSTASCII_USTRINGPARAM( "vnd.sun.star.Package:" ) );
-            aTmp += sURL;
-            sURL = xGraphicResolver->resolveGraphicObjectURL( aTmp );
-            Reference< beans::XPropertySet > xProps( ctx.getControlModel(), UNO_QUERY );
-            // we must set the url while the graphic object ( held by the resolver is in scope )
-            if ( xProps.is() )
-                xProps->setPropertyValue( OUSTR("ImageURL"), makeAny( sURL ) );
-        }
-    }
-
-    else if ( sURL.getLength() > 0 )
-    {
-        Reference< beans::XPropertySet > xProps( ctx.getControlModel(), UNO_QUERY );
-        if ( xProps.is() )
-            xProps->setPropertyValue( OUSTR("ImageURL"), makeAny( sURL ) );
-    }
-
+    ctx.importImageURLProperty( OUSTR( "ImageURL" ), OUSTR( "src" ), _xAttributes );
     ctx.importBooleanProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("Tabstop") ),
                                OUString( RTL_CONSTASCII_USTRINGPARAM("tabstop") ),
                                _xAttributes );
@@ -1685,9 +1737,7 @@ void TitledBoxElement::endElement()
         ctx.importVerticalAlignProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("VerticalAlign") ),
                                          OUString( RTL_CONSTASCII_USTRINGPARAM("valign") ),
                                          xAttributes );
-        ctx.importStringProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("ImageURL") ),
-                                  OUString( RTL_CONSTASCII_USTRINGPARAM("image-src") ),
-                                  xAttributes );
+        ctx.importImageURLProperty( OUSTR( "ImageURL" ), OUSTR( "image-src" ), _xAttributes );
         ctx.importImagePositionProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("ImagePosition") ),
                                          OUString( RTL_CONSTASCII_USTRINGPARAM("image-position") ),
                                          xAttributes );
@@ -1829,9 +1879,7 @@ void RadioGroupElement::endElement()
         ctx.importVerticalAlignProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("VerticalAlign") ),
                                          OUString( RTL_CONSTASCII_USTRINGPARAM("valign") ),
                                          xAttributes );
-        ctx.importStringProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("ImageURL") ),
-                                  OUString( RTL_CONSTASCII_USTRINGPARAM("image-src") ),
-                                  xAttributes );
+        ctx.importImageURLProperty( OUSTR( "ImageURL" ), OUSTR( "image-src" ), xAttributes );
         ctx.importImagePositionProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("ImagePosition") ),
                                          OUString( RTL_CONSTASCII_USTRINGPARAM("image-position") ),
                                          xAttributes );
@@ -2213,9 +2261,7 @@ void CheckBoxElement::endElement()
     ctx.importVerticalAlignProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("VerticalAlign") ),
                                      OUString( RTL_CONSTASCII_USTRINGPARAM("valign") ),
                                      _xAttributes );
-    ctx.importStringProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("ImageURL") ),
-                              OUString( RTL_CONSTASCII_USTRINGPARAM("image-src") ),
-                              _xAttributes );
+        ctx.importImageURLProperty( OUSTR( "ImageURL" ), OUSTR( "image-src" ), _xAttributes );
     ctx.importImagePositionProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("ImagePosition") ),
                                      OUString( RTL_CONSTASCII_USTRINGPARAM("image-position") ),
                                      _xAttributes );
@@ -2316,9 +2362,7 @@ void ButtonElement::endElement()
     ctx.importButtonTypeProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("PushButtonType") ),
                                   OUString( RTL_CONSTASCII_USTRINGPARAM("button-type") ),
                                   _xAttributes );
-    ctx.importStringProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("ImageURL") ),
-                              OUString( RTL_CONSTASCII_USTRINGPARAM("image-src") ),
-                              _xAttributes );
+        ctx.importImageURLProperty( OUSTR( "ImageURL" ), OUSTR( "image-src" ), _xAttributes );
     ctx.importImagePositionProperty( OUString( RTL_CONSTASCII_USTRINGPARAM("ImagePosition") ),
                                      OUString( RTL_CONSTASCII_USTRINGPARAM("image-position") ),
                                      _xAttributes );
@@ -2486,6 +2530,14 @@ Reference< xml::input::XElement > BulletinBoardElement::startChildElement(
     {
         return new MultiPage( rLocalName, xAttributes, this, _pImport );
     }
+    else if (rLocalName.equalsAsciiL( RTL_CONSTASCII_STRINGPARAM("frame") ))
+    {
+        return new Frame( rLocalName, xAttributes, this, _pImport );
+    }
+    else if (rLocalName.equalsAsciiL( RTL_CONSTASCII_STRINGPARAM("page") ))
+    {
+        return new Page( rLocalName, xAttributes, this, _pImport );
+    }
     // bulletinboard
     else if (rLocalName.equalsAsciiL( RTL_CONSTASCII_STRINGPARAM("bulletinboard") ))
     {
@@ -2661,10 +2713,7 @@ void WindowElement::endElement()
         OUString( RTL_CONSTASCII_USTRINGPARAM("Decoration") ),
         OUString( RTL_CONSTASCII_USTRINGPARAM("withtitlebar") ),
         _xAttributes );
-    ctx.importStringProperty( 
-        OUString( RTL_CONSTASCII_USTRINGPARAM("ImageURL") ),
-        OUString( RTL_CONSTASCII_USTRINGPARAM("image-src") ),
-        _xAttributes );
+        ctx.importImageURLProperty( OUSTR( "ImageURL" ), OUSTR( "image-src" ), _xAttributes );
     ctx.importEvents( _events );	
     // avoid ring-reference:
     // vector< event elements > holding event elements holding this (via _pParent)
diff --git a/xmlscript/source/xmldlg_imexp/xmldlg_import.cxx b/xmlscript/source/xmldlg_imexp/xmldlg_import.cxx
index e22a499..4384df4 100644
--- a/xmlscript/source/xmldlg_imexp/xmldlg_import.cxx
+++ b/xmlscript/source/xmldlg_imexp/xmldlg_import.cxx
@@ -57,10 +57,15 @@
 #include <com/sun/star/script/ScriptEventDescriptor.hpp>
 
 #include <com/sun/star/view/SelectionType.hpp>
+#include <com/sun/star/lang/XServiceInfo.hpp>
+
+#include <com/sun/star/document/XGraphicObjectResolver.hpp>
 #include <com/sun/star/document/XStorageBasedDocument.hpp>
 #include <com/sun/star/script/DocumentScriptLibraryContainer.hpp>
 #include <com/sun/star/script/XVBACompat.hpp>
 
+#include <comphelper/componentcontext.hxx>
+
 using namespace ::com::sun::star;
 using namespace ::com::sun::star::uno;
 using namespace ::com::sun::star::frame;
@@ -819,6 +824,7 @@ bool ImportContext::importDoubleProperty(
     }
     return false;
 }
+
 //__________________________________________________________________________________________________
 bool ImportContext::importBooleanProperty(
     OUString const & rPropName, OUString const & rAttrName,
@@ -970,6 +976,52 @@ bool ImportContext::importVerticalAlignProperty(
     return false;
 }
 //__________________________________________________________________________________________________
+bool ImportContext::importImageURLProperty(
+    OUString const & rPropName, OUString const & rAttrName,
+    Reference< xml::input::XAttributes > const & xAttributes )
+{
+    rtl::OUString sURL = xAttributes->getValueByUidName( _pImport->XMLNS_DIALOGS_UID, rAttrName );
+    if ( sURL.getLength() )
+    {
+        Reference< document::XStorageBasedDocument > xDocStorage( _pImport->getDocOwner(), UNO_QUERY );
+
+        uno::Reference< document::XGraphicObjectResolver > xGraphicResolver;
+        if ( xDocStorage.is() )
+        {
+            uno::Sequence< Any > aArgs( 1 );
+            aArgs[ 0 ] <<= xDocStorage->getDocumentStorage();
+            ::comphelper::ComponentContext aContext( _pImport->getComponentContext() );
+            aContext.createComponentWithArguments( OUSTR( "com.sun.star.comp.Svx.GraphicImportHelper" ), aArgs, xGraphicResolver );
+            if ( xGraphicResolver.is() )
+            {
+                rtl::OUString aTmp( RTL_CONSTASCII_USTRINGPARAM( "vnd.sun.star.Package:" ) );
+                aTmp += sURL;
+                try
+                {
+                    aTmp = xGraphicResolver->resolveGraphicObjectURL( aTmp );
+                    if ( aTmp.getLength() )
+                        sURL = aTmp;
+                }
+                catch( uno::Exception& e )
+                {
+                    return false;
+                }
+
+            }
+        }
+        if ( sURL.getLength() > 0 )
+        {
+            Reference< beans::XPropertySet > xProps( getControlModel(), UNO_QUERY );
+            if ( xProps.is() )
+            {
+                xProps->setPropertyValue( rPropName, makeAny( sURL ) );
+                return true;
+            }
+        }
+    }
+    return false;
+}
+//__________________________________________________________________________________________________
 bool ImportContext::importImageAlignProperty(
     OUString const & rPropName, OUString const & rAttrName,
     Reference< xml::input::XAttributes > const & xAttributes )
@@ -1922,7 +1974,11 @@ Reference< xml::sax::XDocumentHandler > SAL_CALL importDialogModel(
     Reference< XModel > const & xDocument )
     SAL_THROW( (Exception) )
 {
-    DialogImport* pImport = new DialogImport( xContext, xDialogModel, xDocument );
+    // single set of styles and stylenames apply to all containees
+    :: boost::shared_ptr< ::std::vector< ::rtl::OUString > > pStyleNames( new ::std::vector< ::rtl::OUString > );
+    :: boost::shared_ptr< ::std::vector< css::uno::Reference< css::xml::input::XElement > > > pStyles( new ::std::vector< css::uno::Reference< css::xml::input::XElement > > );
+    DialogImport* pImport = new DialogImport( xContext, xDialogModel,pStyleNames, pStyles, xDocument );
+
     uno::Reference< script::XVBACompat > xVBAModeSource( pImport->getScriptLibraryContainer(), uno::UNO_QUERY );
 
     uno::Reference< beans::XPropertySet > xDlgProps( xDialogModel, uno::UNO_QUERY );
diff --git a/xmlscript/util/makefile.mk b/xmlscript/util/makefile.mk
index 57d9c30..256cb29 100644
--- a/xmlscript/util/makefile.mk
+++ b/xmlscript/util/makefile.mk
@@ -54,8 +54,8 @@ SHL1LIBS= \
         $(LIB1TARGET)
 
 SHL1STDLIBS= \
-        $(COMPHELPERLIB)                \
         $(CPPUHELPERLIB)		\
+        $(COMPHELPERLIB)		\
         $(CPPULIB) 			\
         $(SALLIB)
 
-- 
1.7.0.1

