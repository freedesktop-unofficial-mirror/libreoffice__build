From 62c7136689a09b32a62edfac6d652ec613442bda Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:04:03 +0200
Subject: [PATCH 602/878] emf+-vcl-bitmap.diff

---
 vcl/aqua/inc/salbmp.h          |    3 +++
 vcl/aqua/source/gdi/salbmp.cxx |    7 +++++++
 vcl/inc/vcl/salbmp.hxx         |    5 +++++
 vcl/unx/headless/svpbmp.cxx    |    5 +++++
 vcl/unx/headless/svpbmp.hxx    |    3 +++
 vcl/unx/inc/salbmp.h           |    3 +++
 vcl/unx/source/gdi/salbmp.cxx  |   26 ++++++++++++++++++++++++++
 vcl/win/inc/salbmp.h           |    3 +++
 vcl/win/source/gdi/salbmp.cxx  |    7 +++++++
 9 files changed, 62 insertions(+), 0 deletions(-)

diff --git a/vcl/aqua/inc/salbmp.h b/vcl/aqua/inc/salbmp.h
index 3ba53a0..380c64f 100644
--- a/vcl/aqua/inc/salbmp.h
+++ b/vcl/aqua/inc/salbmp.h
@@ -75,6 +75,9 @@ public:
     bool            Create( const SalBitmap& rSalBmp );
     bool            Create( const SalBitmap& rSalBmp, SalGraphics* pGraphics );
     bool            Create( const SalBitmap& rSalBmp, USHORT nNewBitCount );
+    virtual bool    Create( const ::com::sun::star::uno::Reference< ::com::sun::star::rendering::XBitmapCanvas > xBitmapCanvas,
+                            Size& rSize,
+                            bool bMask = false );
     
     void            Destroy();
     
diff --git a/vcl/aqua/source/gdi/salbmp.cxx b/vcl/aqua/source/gdi/salbmp.cxx
index 5901bc0..a4c9ba7 100644
--- a/vcl/aqua/source/gdi/salbmp.cxx
+++ b/vcl/aqua/source/gdi/salbmp.cxx
@@ -153,6 +153,13 @@ bool AquaSalBitmap::Create( const SalBitmap& rSalBmp, USHORT nNewBitCount )
 
 // ------------------------------------------------------------------
 
+bool AquaSalBitmap::Create( const ::com::sun::star::uno::Reference< ::com::sun::star::rendering::XBitmapCanvas > /*xBitmapCanvas*/, Size& /*rSize*/, bool /*bMask*/ )
+{
+    return false;
+}
+
+// ------------------------------------------------------------------
+
 void AquaSalBitmap::Destroy()
 {
     DestroyContext();
diff --git a/vcl/inc/vcl/salbmp.hxx b/vcl/inc/vcl/salbmp.hxx
index 66efac8..7289de0 100644
--- a/vcl/inc/vcl/salbmp.hxx
+++ b/vcl/inc/vcl/salbmp.hxx
@@ -33,6 +33,8 @@
 #endif
 #include <vcl/dllapi.h>
 
+#include <com/sun/star/rendering/XBitmapCanvas.hpp>
+
 struct BitmapBuffer;
 class SalGraphics;
 class BitmapPalette;
@@ -52,6 +54,9 @@ public:
                                     SalGraphics* pGraphics ) = 0;
     virtual bool			Create( const SalBitmap& rSalBmp,
                                     USHORT nNewBitCount ) = 0;
+    virtual bool			Create( const ::com::sun::star::uno::Reference< ::com::sun::star::rendering::XBitmapCanvas > xBitmapCanvas,
+                                    Size& rSize,
+                                    bool bMask = false ) = 0;
     virtual void			Destroy() = 0;
     virtual Size			GetSize() const = 0;
     virtual USHORT			GetBitCount() const = 0;
diff --git a/vcl/unx/headless/svpbmp.cxx b/vcl/unx/headless/svpbmp.cxx
index 41b139a..19bc8b9 100644
--- a/vcl/unx/headless/svpbmp.cxx
+++ b/vcl/unx/headless/svpbmp.cxx
@@ -116,6 +116,11 @@ bool SvpSalBitmap::Create( const SalBitmap& /*rSalBmp*/,
     return false;
 }
 
+bool SvpSalBitmap::Create( const ::com::sun::star::uno::Reference< ::com::sun::star::rendering::XBitmapCanvas > /*xBitmapCanvas*/, Size& /*rSize*/, bool /*bMask*/ )
+{
+    return false;
+}
+
 void SvpSalBitmap::Destroy()
 {
     m_aBitmap.reset();
diff --git a/vcl/unx/headless/svpbmp.hxx b/vcl/unx/headless/svpbmp.hxx
index 40307ef..279c006 100644
--- a/vcl/unx/headless/svpbmp.hxx
+++ b/vcl/unx/headless/svpbmp.hxx
@@ -53,6 +53,9 @@ public:
                                     SalGraphics* pGraphics );
     virtual bool			Create( const SalBitmap& rSalBmp,
                                     USHORT nNewBitCount );
+    virtual bool            Create( const ::com::sun::star::uno::Reference< ::com::sun::star::rendering::XBitmapCanvas > xBitmapCanvas,
+                                    Size& rSize,
+                                    bool bMask = false );
     virtual void			Destroy();
     virtual Size			GetSize() const;
     virtual USHORT			GetBitCount() const;
diff --git a/vcl/unx/inc/salbmp.h b/vcl/unx/inc/salbmp.h
index 7f366a3..a6468b9 100644
--- a/vcl/unx/inc/salbmp.h
+++ b/vcl/unx/inc/salbmp.h
@@ -110,6 +110,9 @@ public:
                                     SalGraphics* pGraphics );
     virtual bool			Create( const SalBitmap& rSalBmp,
                                     USHORT nNewBitCount );
+    virtual bool			Create( const ::com::sun::star::uno::Reference< ::com::sun::star::rendering::XBitmapCanvas > xBitmapCanvas,
+                                    Size& rSize,
+                                    bool bMask = false );
                         
     virtual void			Destroy();
                         
diff --git a/vcl/unx/source/gdi/salbmp.cxx b/vcl/unx/source/gdi/salbmp.cxx
index ca7a7f5..f9180c6 100644
--- a/vcl/unx/source/gdi/salbmp.cxx
+++ b/vcl/unx/source/gdi/salbmp.cxx
@@ -47,6 +47,7 @@
 #include <salbmp.h>
 #include <salinst.h>
 #include <vcl/bitmap.hxx>
+#include <com/sun/star/beans/XFastPropertySet.hpp>
 
 // -----------
 // - Defines -
@@ -744,6 +745,31 @@ bool X11SalBitmap::Create( const SalBitmap&, USHORT )
 
 // -----------------------------------------------------------------------------
 
+bool X11SalBitmap::Create( const ::com::sun::star::uno::Reference< ::com::sun::star::rendering::XBitmapCanvas > xBitmapCanvas, Size& rSize, bool bMask )
+{
+    ::com::sun::star::uno::Reference< ::com::sun::star::beans::XFastPropertySet > xFastPropertySet( xBitmapCanvas, ::com::sun::star::uno::UNO_QUERY );
+    if( xFastPropertySet.get() ) {
+        long pixmapHandle;
+        sal_Int32 depth;
+        ::com::sun::star::uno::Sequence< ::com::sun::star::uno::Any > args;
+
+        if( xFastPropertySet->getFastPropertyValue(bMask ? 2 : 1) >>= args ) {
+            if( ( args[1] >>= pixmapHandle ) && ( args[2] >>= depth ) ) {
+                bool bSuccess = ImplCreateFromDrawable( pixmapHandle, 0, depth, 0, 0, (long) rSize.Width(), (long) rSize.Height() );
+                bool bFreePixmap;
+                if( bSuccess && (args[0] >>= bFreePixmap) && bFreePixmap )
+                    XFreePixmap( GetX11SalData()->GetDisplay()->GetDisplay(), pixmapHandle );
+
+                return bSuccess;
+            }
+        }
+    }
+
+    return false;
+}
+
+// -----------------------------------------------------------------------------
+
 void X11SalBitmap::Destroy()
 {
     if( mpDIB )
diff --git a/vcl/win/inc/salbmp.h b/vcl/win/inc/salbmp.h
index bf9275b..3404851 100644
--- a/vcl/win/inc/salbmp.h
+++ b/vcl/win/inc/salbmp.h
@@ -74,6 +74,9 @@ public:
     virtual bool                Create( const SalBitmap& rSalBmpImpl );
     virtual bool                Create( const SalBitmap& rSalBmpImpl, SalGraphics* pGraphics );
     virtual bool                Create( const SalBitmap& rSalBmpImpl, USHORT nNewBitCount );
+    virtual bool                Create( const ::com::sun::star::uno::Reference< ::com::sun::star::rendering::XBitmapCanvas > xBitmapCanvas,
+                                           Size& rSize,
+                                           bool bMask = false );
 
     virtual void                Destroy();
 
diff --git a/vcl/win/source/gdi/salbmp.cxx b/vcl/win/source/gdi/salbmp.cxx
index c619827..864fb2a 100644
--- a/vcl/win/source/gdi/salbmp.cxx
+++ b/vcl/win/source/gdi/salbmp.cxx
@@ -264,6 +264,13 @@ bool WinSalBitmap::Create( const SalBitmap& rSSalBmp, USHORT nNewBitCount )
 
 // ------------------------------------------------------------------
 
+bool WinSalBitmap::Create( const ::com::sun::star::uno::Reference< ::com::sun::star::rendering::XBitmapCanvas > /*xBitmapCanvas*/, Size& /*rSize*/, bool /*bMask*/ )
+{
+    return false;
+}
+
+// ------------------------------------------------------------------
+
 void WinSalBitmap::Destroy()
 {
     if( mhDIB )
-- 
1.7.0.1

