From df00a1a7369d48a243a59f6ad233ecad26fb4f63 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:04:09 +0200
Subject: [PATCH 533/768] emf+-crash-fix.diff

---
 cppcanvas/source/mtfrenderer/emfplus.cxx |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

diff --git cppcanvas/source/mtfrenderer/emfplus.cxx cppcanvas/source/mtfrenderer/emfplus.cxx
index ef1e76a..6f21a10 100644
--- cppcanvas/source/mtfrenderer/emfplus.cxx
+++ cppcanvas/source/mtfrenderer/emfplus.cxx
@@ -783,6 +783,10 @@ namespace cppcanvas
                 EMFPBrush* brush = (EMFPBrush*) aObjects [brushIndexOrColor];
                 EMFP_DEBUG (printf ("EMF+\tbrush fill slot: %d (type: %d)\n", brushIndexOrColor, brush->GetType ()));
 
+                // give up in case something wrong happened
+                if( !brush )
+                    return;
+
                 rState.isFillColorSet = false;
                 rState.isLineColorSet = false;
 
@@ -992,7 +996,8 @@ namespace cppcanvas
                             aObjects [index] = NULL;
                         }
 
-                        switch (flags & 0xff00) {
+                        // not sure yet, what 0x8000 means
+                        switch (flags & 0x7f00) {
                         case EmfPlusObjectTypeBrush:
                             {
                                 EMFPBrush *brush;
-- 
1.7.0.1

