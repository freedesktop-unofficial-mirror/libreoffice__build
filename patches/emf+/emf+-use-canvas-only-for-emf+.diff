From 760304d9c67526c7178e459d749b9931641d4210 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:04:12 +0200
Subject: [PATCH 536/768] emf+-use-canvas-only-for-emf+.diff

---
 svtools/source/filter.vcl/wmf/winmtf.cxx |    1 +
 vcl/inc/vcl/gdimtf.hxx                   |    3 +++
 vcl/source/gdi/gdimtf.cxx                |   14 +++++++++++---
 3 files changed, 15 insertions(+), 3 deletions(-)

diff --git svtools/source/filter.vcl/wmf/winmtf.cxx svtools/source/filter.vcl/wmf/winmtf.cxx
index 4a2fa7b..ba8efff 100644
--- svtools/source/filter.vcl/wmf/winmtf.cxx
+++ svtools/source/filter.vcl/wmf/winmtf.cxx
@@ -2256,6 +2256,7 @@ void WinMtfOutput::PassEMFPlusHeaderInfo()
     mem << one << zero << zero << one << zero << zero;
 
     mpGDIMetaFile->AddAction( new MetaCommentAction( "EMF_PLUS_HEADER_INFO", 0, (const BYTE*) mem.GetData(), mem.GetSize() ) );
+    mpGDIMetaFile->UseCanvas( TRUE );
 }
 
 void WinMtfOutput::PassEMFPlus( void* pBuffer, UINT32 nLength )
diff --git vcl/inc/vcl/gdimtf.hxx vcl/inc/vcl/gdimtf.hxx
index 7b78c51..a4f94f3 100644
--- vcl/inc/vcl/gdimtf.hxx
+++ vcl/inc/vcl/gdimtf.hxx
@@ -107,6 +107,7 @@ private:
     ImpLabelList*   pLabelList;
     BOOL            bPause;
     BOOL            bRecord;
+    BOOL            bUseCanvas;
 
 //#if 0 // _SOLAR__PRIVATE
 
@@ -244,6 +245,8 @@ public:
     friend VCL_DLLPUBLIC SvStream& operator<<( SvStream& rOStm, const GDIMetaFile& rGDIMetaFile );
 
     BOOL           CreateThumbnail( sal_uInt32 nMaximumExtent, BitmapEx& rBmpEx, const BitmapEx* pOverlay = NULL, const Rectangle* pOverlayRect = NULL ) const;
+
+    void           UseCanvas( BOOL _bUseCanvas );
 };
 
 #endif // _SV_GDIMTF_HXX
diff --git vcl/source/gdi/gdimtf.cxx vcl/source/gdi/gdimtf.cxx
index a406e4a..e13788f 100644
--- vcl/source/gdi/gdimtf.cxx
+++ vcl/source/gdi/gdimtf.cxx
@@ -212,7 +212,8 @@ GDIMetaFile::GDIMetaFile() :
     pOutDev 	( NULL ),
     pLabelList	( NULL ),
     bPause		( FALSE ),
-    bRecord 	( FALSE )
+    bRecord 	( FALSE ),
+    bUseCanvas  ( FALSE )
 {
 }
 
@@ -227,7 +228,8 @@ GDIMetaFile::GDIMetaFile( const GDIMetaFile& rMtf ) :
     pNext			( rMtf.pNext ),
     pOutDev 		( NULL ),
     bPause			( FALSE ),
-    bRecord 		( FALSE )
+    bRecord 		( FALSE ),
+    bUseCanvas 	    ( rMtf.bUseCanvas )
 {
     // RefCount der MetaActions erhoehen
     for( void* pAct = First(); pAct; pAct = Next() )
@@ -281,6 +283,7 @@ GDIMetaFile& GDIMetaFile::operator=( const GDIMetaFile& rMtf )
         pOutDev = NULL;
         bPause = FALSE;
         bRecord = FALSE;
+        bUseCanvas = rMtf.bUseCanvas;
 
         if( rMtf.bRecord )
         {
@@ -568,7 +571,7 @@ void GDIMetaFile::Play( OutputDevice* pOut, const Point& rPos,
     {
         GDIMetaFile*	pMtf = pOut->GetConnectMetaFile();
 
-        if( !pMtf && ImplPlayWithRenderer( pOut, rPos, aDestSize ) )
+        if( bUseCanvas && !pMtf && ImplPlayWithRenderer( pOut, rPos, aDestSize ) )
             return;
 
         Size aTmpPrefSize( pOut->LogicToPixel( GetPrefSize(), aDrawMap ) );
@@ -3074,3 +3077,8 @@ BOOL GDIMetaFile::CreateThumbnail( sal_uInt32 nMaximumExtent,
     
     return !rBmpEx.IsEmpty();
 }
+
+void GDIMetaFile::UseCanvas( BOOL _bUseCanvas )
+{
+    bUseCanvas = _bUseCanvas;
+}
-- 
1.7.0.1

