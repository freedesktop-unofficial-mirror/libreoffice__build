From 6cb4c1dd1e7e65fab2acf69a9655bc6b836e29c8 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:04:13 +0200
Subject: [PATCH 537/768] emf+-embedded-mf-image.diff

---
 cppcanvas/source/mtfrenderer/emfplus.cxx      |   24 ++++++++++++++++++++----
 cppcanvas/source/mtfrenderer/implrenderer.cxx |    1 +
 2 files changed, 21 insertions(+), 4 deletions(-)

diff --git cppcanvas/source/mtfrenderer/emfplus.cxx cppcanvas/source/mtfrenderer/emfplus.cxx
index c3bcb56..8a60ad2 100644
--- cppcanvas/source/mtfrenderer/emfplus.cxx
+++ cppcanvas/source/mtfrenderer/emfplus.cxx
@@ -632,12 +632,10 @@ namespace cppcanvas
             Graphic graphic;
 
 
-            void Read (SvStream &s)
+            void Read (SvMemoryStream &s)
             {
                 sal_uInt32 header, unknown;
 
-                EMFP_DEBUG (dumpWords(s, 16));
-
                 s >> header >> type;
 
                 EMFP_DEBUG (printf ("EMF+\timage\nEMF+\theader: 0x%08x type: 0x%08x\n", header, type));
@@ -652,6 +650,24 @@ namespace cppcanvas
                         EMFP_DEBUG (printf ("EMF+\tbitmap width: %d height: %d\n", graphic.GetBitmap ().GetSizePixel ().Width (), graphic.GetBitmap ().GetSizePixel ().Height ()));
                     }
 
+                } else if (type == 2) {
+                    sal_Int32 mfType, mfSize;
+
+                    s >> mfType >> mfSize;
+                    EMFP_DEBUG (printf ("EMF+\tmetafile type: %d dataSize: %d\n", mfType, mfSize));
+
+                    GraphicFilter filter;
+                    SvMemoryStream mfStream (((char *)s.GetData()) + s.Tell(), mfSize, STREAM_READ);
+
+                    filter.ImportGraphic (graphic, String (), mfStream);
+
+                    // debug code - write the stream to debug file /tmp/emf-stream.emf
+                    EMFP_DEBUG(mfStream.Seek(0);
+                               SvFileStream file( UniString::CreateFromAscii( "/tmp/emf-embedded-stream.emf" ), STREAM_WRITE | STREAM_TRUNC );
+
+                               mfStream >> file;
+                               file.Flush();
+                               file.Close());
                 }
             }
         };
@@ -1040,7 +1056,7 @@ namespace cppcanvas
                         mMFlags = flags;
                         mMStream.Seek(0);
                     }
-                    EMFP_DEBUG (dumpWords(rMF, 16));
+
                     // 1st 4 bytes are unknown
                     mMStream.Write (((const char *)rMF.GetData()) + rMF.Tell() + 4, dataSize - 4);
                     EMFP_DEBUG (printf ("EMF+ read next object part size: %d type: %04hx flags: %04hx data size: %d\n", size, type, flags, dataSize));
diff --git cppcanvas/source/mtfrenderer/implrenderer.cxx cppcanvas/source/mtfrenderer/implrenderer.cxx
index f3f68f2..3343e7f 100644
--- cppcanvas/source/mtfrenderer/implrenderer.cxx
+++ cppcanvas/source/mtfrenderer/implrenderer.cxx
@@ -1818,6 +1818,7 @@ namespace cppcanvas
                                 char *env;
                                 if (env = getenv ("EMF_PLUS_LIMIT")) {
                                     limit = atoi (env);
+                                    EMFP_DEBUG (printf ("EMF+ records limit: %d\n", limit));
                                 }
                             }
                             EMFP_DEBUG (printf ("EMF+ passed to canvas mtf renderer, size: %d\n", pAct->GetDataSize ()));
-- 
1.7.0.1

