From 77571183660c22d6f7dab954cc1c07822fedbd0d Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:04:00 +0200
Subject: [PATCH 599/878] emf+-cppcanvas-renderer.diff

---
 cppcanvas/prj/build.lst                  |    1 +
 cppcanvas/prj/d.lst                      |    1 +
 cppcanvas/source/uno/exports.dxp         |    3 +
 cppcanvas/source/uno/exports.map         |    8 +++
 cppcanvas/source/uno/makefile.mk         |   70 ++++++++++++++++++++++++++++++
 cppcanvas/source/uno/uno_mtfrenderer.cxx |   53 ++++++++++++++++++++++
 cppcanvas/source/uno/uno_mtfrenderer.hxx |   33 ++++++++++++++
 7 files changed, 169 insertions(+), 0 deletions(-)
 create mode 100644 cppcanvas/source/uno/exports.dxp
 create mode 100644 cppcanvas/source/uno/exports.map
 create mode 100644 cppcanvas/source/uno/makefile.mk
 create mode 100644 cppcanvas/source/uno/uno_mtfrenderer.cxx
 create mode 100644 cppcanvas/source/uno/uno_mtfrenderer.hxx

diff --git a/cppcanvas/prj/build.lst b/cppcanvas/prj/build.lst
index 3fc4eb7..317e327 100644
--- a/cppcanvas/prj/build.lst
+++ b/cppcanvas/prj/build.lst
@@ -5,3 +5,4 @@ cx	cppcanvas\source\tools				nmake	-	all	cx_tools cx_inc NULL
 cx	cppcanvas\source\wrapper			nmake	-	all cx_wrapper cx_inc NULL
 cx	cppcanvas\source\mtfrenderer		nmake	-	all	cx_mtfrenderer cx_inc NULL
 cx	cppcanvas\util						nmake	-	all	cx_util cx_tools cx_wrapper cx_mtfrenderer NULL
+cx	cppcanvas\source\uno				nmake	-	all	cx_uno cx_tools cx_wrapper cx_mtfrenderer cx_util NULL
diff --git a/cppcanvas/prj/d.lst b/cppcanvas/prj/d.lst
index f0f3237..7ed2d10 100644
--- a/cppcanvas/prj/d.lst
+++ b/cppcanvas/prj/d.lst
@@ -1,4 +1,5 @@
 ..\%__SRC%\bin\cppcanv*.dll %_DEST%\bin%_EXT%\cppcanv*.dll
+..\%__SRC%\bin\mtfrenderer*.dll %_DEST%\bin%_EXT%\mtfrenderer*.dll
 ..\%__SRC%\lib\icppcanvas.lib %_DEST%\lib%_EXT%\icppcanvas.lib
 ..\%__SRC%\lib\lib*.* %_DEST%\lib%_EXT%\lib*.*
 
diff --git a/cppcanvas/source/uno/exports.dxp b/cppcanvas/source/uno/exports.dxp
new file mode 100644
index 0000000..9630d7e
--- /dev/null
+++ b/cppcanvas/source/uno/exports.dxp
@@ -0,0 +1,3 @@
+component_getImplementationEnvironment
+component_writeInfo
+component_getFactory
diff --git a/cppcanvas/source/uno/exports.map b/cppcanvas/source/uno/exports.map
new file mode 100644
index 0000000..4101b0d
--- /dev/null
+++ b/cppcanvas/source/uno/exports.map
@@ -0,0 +1,8 @@
+CAN_1_0 {
+    global:
+        component_getImplementationEnvironment;
+        component_writeInfo;
+        component_getFactory;
+    local:
+        *;
+};
diff --git a/cppcanvas/source/uno/makefile.mk b/cppcanvas/source/uno/makefile.mk
new file mode 100644
index 0000000..3695e6c
--- /dev/null
+++ b/cppcanvas/source/uno/makefile.mk
@@ -0,0 +1,70 @@
+#*************************************************************************
+#
+#   OpenOffice.org - a multi-platform office productivity suite
+#
+#   $RCSfile: makefile.mk,v $
+#
+#   $Revision: 1.6 $
+#
+#   last change: $Author: hr $ $Date: 2006/06/20 05:14:24 $
+#
+#   The Contents of this file are made available subject to
+#   the terms of GNU Lesser General Public License Version 2.1.
+#
+#
+#     GNU Lesser General Public License Version 2.1
+#     =============================================
+#     Copyright 2005 by Sun Microsystems, Inc.
+#     901 San Antonio Road, Palo Alto, CA 94303, USA
+#
+#     This library is free software; you can redistribute it and/or
+#     modify it under the terms of the GNU Lesser General Public
+#     License version 2.1, as published by the Free Software Foundation.
+#
+#     This library is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+#     Lesser General Public License for more details.
+#
+#     You should have received a copy of the GNU Lesser General Public
+#     License along with this library; if not, write to the Free Software
+#     Foundation, Inc., 59 Temple Place, Suite 330, Boston,
+#     MA  02111-1307  USA
+#
+#*************************************************************************
+
+PRJ=..$/..
+
+PRJNAME=cppcanvas
+TARGET=mtfrenderer
+ENABLE_EXCEPTIONS=TRUE
+
+
+# --- Settings -----------------------------------------------------------
+
+.INCLUDE :	settings.mk
+
+# --- Common ----------------------------------------------------------
+
+.IF "$(verbose)"!="" || "$(VERBOSE)"!=""
+CDEFS+= -DVERBOSE
+.ENDIF
+
+SLOFILES =	$(SLO)$/uno_mtfrenderer.obj
+
+SHL1TARGET=$(TARGET).uno
+
+SHL1STDLIBS= $(SALLIB) $(CPPULIB) $(CPPUHELPERLIB) $(COMPHELPERLIB) $(CPPCANVASLIB) $(BASEGFXLIB)
+
+SHL1IMPLIB=i$(TARGET)
+SHL1LIBS=$(SLB)$/$(TARGET).lib
+SHL1DEF=$(MISC)$/$(SHL1TARGET).def
+
+SHL1VERSIONMAP=exports.map
+
+DEF1NAME=$(SHL1TARGET)
+DEF1EXPORTFILE=exports.dxp
+
+# ==========================================================================
+
+.INCLUDE :	target.mk
diff --git a/cppcanvas/source/uno/uno_mtfrenderer.cxx b/cppcanvas/source/uno/uno_mtfrenderer.cxx
new file mode 100644
index 0000000..7fd88d5
--- /dev/null
+++ b/cppcanvas/source/uno/uno_mtfrenderer.cxx
@@ -0,0 +1,53 @@
+#include "uno_mtfrenderer.hxx"
+#include <cppcanvas/vclfactory.hxx>
+#include <comphelper/servicedecl.hxx>
+#include <cppuhelper/factory.hxx>
+
+using namespace ::com::sun::star;
+
+void MtfRenderer::setMetafile (const uno::Sequence< sal_Int8 >& rMtf) throw (uno::RuntimeException)
+{
+        // printf ("MtfRenderer::setMetafile unimplemented, use fast property set or implement me\n");
+}
+
+void MtfRenderer::draw (double fScaleX, double fScaleY) throw (uno::RuntimeException)
+{
+    if (mpMetafile && mxCanvas.get()) {
+        cppcanvas::VCLFactory& factory = cppcanvas::VCLFactory::getInstance();
+        cppcanvas::BitmapCanvasSharedPtr canvas = factory.createCanvas (mxCanvas);
+        cppcanvas::RendererSharedPtr renderer = factory.createRenderer (canvas, *mpMetafile, cppcanvas::Renderer::Parameters ());
+        ::basegfx::B2DHomMatrix aMatrix;
+        aMatrix.scale( fScaleX, fScaleY );
+        canvas->setTransformation( aMatrix );
+        renderer->draw ();
+    }
+}
+
+void MtfRenderer::setFastPropertyValue( sal_Int32 nHandle, const uno::Any& aAny)  throw (uno::RuntimeException)
+{
+    if (nHandle == 0) {
+        mpMetafile = (GDIMetaFile*) *reinterpret_cast<const sal_Int64*>(aAny.getValue());
+    }
+}
+
+MtfRenderer::MtfRenderer (uno::Sequence<uno::Any> const& aArgs, uno::Reference<uno::XComponentContext> const&) : MtfRendererBase (m_aMutex), mpMetafile (NULL)
+{
+    if( aArgs.getLength() == 1 ) {
+        aArgs[0] >>= mxCanvas;
+    }
+}
+
+namespace sdecl = comphelper::service_decl;
+#if defined (__GNUC__) && (__GNUC__ == 3 && __GNUC_MINOR__ <= 3)
+ sdecl::class_<MtfRenderer, sdecl::with_args<true> > serviceImpl;
+ const sdecl::ServiceDecl MtfRendererDecl(
+     serviceImpl,
+#else
+ const sdecl::ServiceDecl MtfRendererDecl(
+     sdecl::class_<MtfRenderer, sdecl::with_args<true> >(),
+#endif
+    "com.sun.star.comp.rendering.MtfRenderer",
+    "com.sun.star.rendering.MtfRenderer" );
+
+// The C shared lib entry points
+COMPHELPER_SERVICEDECL_EXPORTS1(MtfRendererDecl)
diff --git a/cppcanvas/source/uno/uno_mtfrenderer.hxx b/cppcanvas/source/uno/uno_mtfrenderer.hxx
new file mode 100644
index 0000000..6c66946
--- /dev/null
+++ b/cppcanvas/source/uno/uno_mtfrenderer.hxx
@@ -0,0 +1,33 @@
+#ifndef _UNO_MTF_RENDERER_HXX_
+#define _UNO_MTF_RENDERER_HXX_
+#include <com/sun/star/rendering/MtfRenderer.hpp>
+#include <com/sun/star/rendering/XBitmapCanvas.hpp>
+#include <com/sun/star/uno/XComponentContext.hpp>
+#include <com/sun/star/beans/XFastPropertySet.hpp>
+#include <cppuhelper/compbase2.hxx>
+#include <cppuhelper/basemutex.hxx>
+#include <vcl/gdimtf.hxx>
+
+typedef cppu::WeakComponentImplHelper2<com::sun::star::rendering::XMtfRenderer, com::sun::star::beans::XFastPropertySet> MtfRendererBase;
+
+class MtfRenderer : private cppu::BaseMutex, public MtfRendererBase
+{
+public:
+    MtfRenderer (com::sun::star::uno::Sequence<com::sun::star::uno::Any> const& args,
+                 com::sun::star::uno::Reference<com::sun::star::uno::XComponentContext> const&);
+
+    // XMtfRenderer iface
+    void SAL_CALL setMetafile (const ::com::sun::star::uno::Sequence< sal_Int8 >& rMtf) throw (::com::sun::star::uno::RuntimeException);
+    void SAL_CALL draw (double fScaleX, double fScaleY) throw (::com::sun::star::uno::RuntimeException);
+
+    // XFastPropertySet
+    // setFastPropertyValue (0, GDIMetaFile*) is used to speedup the rendering
+    virtual ::com::sun::star::uno::Any SAL_CALL getFastPropertyValue(sal_Int32 nHandle)  throw (::com::sun::star::uno::RuntimeException) { return ::com::sun::star::uno::Any(); }
+    virtual void SAL_CALL setFastPropertyValue(sal_Int32 nHandle, const ::com::sun::star::uno::Any&)  throw (::com::sun::star::uno::RuntimeException);
+
+private:
+    GDIMetaFile* mpMetafile;
+    com::sun::star::uno::Reference<com::sun::star::rendering::XBitmapCanvas> mxCanvas;
+};
+
+#endif
-- 
1.7.0.1

