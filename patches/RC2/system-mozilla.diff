Index: config_office/configure.in
===================================================================
RCS file: /cvs/tools/config_office/configure.in,v
retrieving revision 1.54.2.6
diff -u -p -u -r1.54.2.6 configure.in
--- config_office/configure.in	17 Jul 2003 13:21:21 -0000	1.54.2.6
+++ config_office/configure.in	17 Jul 2003 14:13:10 -0000
@@ -89,6 +89,14 @@ AC_ARG_WITH(perl-home,
  
                           Usage: --with-perl-home=<absolute path to Perl 5 home>
 ],,)
+AC_ARG_WITH(mozilla,
+[  --with-mozilla         If you have development headers for mozilla installed
+			  on your system, you can use an external mozilla instead
+			  of the internal copy; Use PKG_CONFIG_PATH to specify a
+			  non default mozilla install.
+ 
+                          Usage: --with-mozilla
+],,)
 AC_ARG_WITH(cl-home,
 [  --with-cl-home          For Windows NT users, please supply the path
                           for the Microsoft C/C++ compiler. 
@@ -1303,10 +1311,28 @@ dnl ====================================
 WITH_LIBSN=NO
 if test -n "$enable_libsn"; then
   PKG_CHECK_MODULES( LIBSN, libstartup-notification-1.0 >= 0.5 )
-  AC_SUBST(LIBSN_CFLAGS)
-  AC_SUBST(LIBSN_LIBS)
   WITH_LIBSN=YES
 fi
+AC_SUBST(LIBSN_CFLAGS)
+AC_SUBST(LIBSN_LIBS)
+AC_SUBST(WITH_LIBSN)
+
+dnl ===================================================================
+dnl Test for the location of an installed system mozilla
+dnl ===================================================================
+WITH_MOZILLA=NO
+MOZILLA_VERSION=10000
+if test -n "$with_mozilla"; then
+   echo "With mozilla";
+   PKG_CHECK_MODULES( MOZILLA, mozilla-xpcom mozilla-nspr )
+   MOZILLA_INCLUDE=`$PKG_CONFIG --variable=includedir mozilla-xpcom`
+   MOZILLA_VERSION=`$PKG_CONFIG --modversion mozilla-xpcom | $AWK -F. '{ print \$1*10000+\$2*100+\$3 }'`
+   WITH_MOZILLA=YES
+fi
+AC_SUBST(MOZILLA_LIBS)
+AC_SUBST(MOZILLA_INCLUDE)
+AC_SUBST(MOZILLA_VERSION)
+AC_SUBST(WITH_MOZILLA)
 
 dnl ===================================================================
 dnl Test for the presence of Ant and that it works
Index: config_office/set_soenv.in
===================================================================
RCS file: /cvs/tools/config_office/set_soenv.in,v
retrieving revision 1.9.2.6
diff -u -p -u -r1.9.2.6 set_soenv.in
--- config_office/set_soenv.in	17 Jul 2003 13:21:22 -0000	1.9.2.6
+++ config_office/set_soenv.in	17 Jul 2003 14:13:11 -0000
@@ -1669,6 +1669,10 @@ ToFile( "LIBART_LIBS",       "@LIBART_LI
 ToFile( "WITH_LIBSN",        "@WITH_LIBSN@",       "e" );
 ToFile( "LIBSN_CFLAGS",      "@LIBSN_CFLAGS@",     "e" );
 ToFile( "LIBSN_LIBS",        "@LIBSN_LIBS@",       "e" );
+ToFile( "WITH_MOZILLA",      "@WITH_MOZILLA@",     "e" );
+ToFile( "MOZILLA_LIBS",      "@MOZILLA_LIBS@",     "e" );
+ToFile( "MOZILLA_INCLUDE",   "@MOZILLA_INCLUDE@",  "e" );
+ToFile( "MOZILLA_VERSION",   "@MOZILLA_VERSION@",  "e" );
 ToFile( "GXX_INCLUDE_PATH",  "@GXX_INCLUDE_PATH@", "e" );
 ToFile( "COMMON_BUILD_TOOLS",$COMMON_BUILD_TOOLS,  "e" );
 if ($platform ne "$Winnt")
Index: connectivity/source/drivers/mozab/makefile.mk
===================================================================
RCS file: /cvs/dba/connectivity/source/drivers/mozab/makefile.mk,v
retrieving revision 1.10
diff -u -p -u -r1.10 makefile.mk
--- connectivity/source/drivers/mozab/makefile.mk	28 Apr 2003 16:58:58 -0000	1.10
+++ connectivity/source/drivers/mozab/makefile.mk	17 Jul 2003 14:22:00 -0000
@@ -82,7 +82,13 @@ MOZ_INC=$(SOLARVERSION)$/$(INPATH)$/inc$
 LIB += $(MOZ_LIB)
 MOZ_LIB_XPCOM= $(MOZ_LIB)$/baseembed_s.lib $(MOZ_LIB)$/nspr4.lib $(MOZ_LIB)$/mozreg.lib $(MOZ_LIB)$/xpcom.lib
 .ELSE
+
+.IF "$(WITH_MOZILLA)" == "YES"
+MOZ_LIB_XPCOM= $(MOZILLA_LIBS)
+.ELSE
 MOZ_LIB_XPCOM= -L$(MOZ_LIB) -lembed_base_s -lnspr4 -lmozreg_s -lxpcom
+.ENDIF
+
 .ENDIF
 #End of mozilla specific stuff.
 
Index: connectivity/source/drivers/mozab/mozillasrc/MDatabaseMetaDataHelper.cxx
===================================================================
RCS file: /cvs/dba/connectivity/source/drivers/mozab/mozillasrc/MDatabaseMetaDataHelper.cxx,v
retrieving revision 1.7
diff -u -p -u -r1.7 MDatabaseMetaDataHelper.cxx
--- connectivity/source/drivers/mozab/mozillasrc/MDatabaseMetaDataHelper.cxx	15 Apr 2003 17:38:34 -0000	1.7
+++ connectivity/source/drivers/mozab/mozillasrc/MDatabaseMetaDataHelper.cxx	17 Jul 2003 14:22:03 -0000
@@ -550,7 +550,11 @@ void MLDAPMessageListener::setConnection
     m_aCondition.set();
 }
 
+#if SYSTEM_MOZ_VER >= 10200
+NS_IMETHODIMP MLDAPMessageListener::OnLDAPInit( nsILDAPConnection *pCnx, nsresult aStatus )
+#else
 NS_IMETHODIMP MLDAPMessageListener::OnLDAPInit( nsresult aStatus )
+#endif
 {
     nsresult rv;
 
@@ -568,14 +572,22 @@ NS_IMETHODIMP MLDAPMessageListener::OnLD
         return rv;
     }
 
+#if SYSTEM_MOZ_VER >= 10200
+    rv = ldapOperation->Init(m_LDAPConnection, this, nsnull);
+#else
     rv = ldapOperation->Init(m_LDAPConnection, this);
+#endif
     if ( NS_FAILED( rv ) ) {
         setConnectionStatus( sal_False );
         return rv;
     }
 
     // Bind
+#if SYSTEM_MOZ_VER >= 10200
+    rv = ldapOperation->SimpleBind(nsCString(NULL));
+#else
     rv = ldapOperation->SimpleBind(NULL);
+#endif
     if ( NS_FAILED( rv ) ) {
         setConnectionStatus( sal_False );
         return rv;
@@ -653,8 +665,13 @@ MDatabaseMetaDataHelper::testLDAPConnect
     if ( NS_FAILED(rv) )
         return sal_False;
 
+#if SYSTEM_MOZ_VER >= 10200
+    nsCAutoString dn;
+    rv = url->GetDn(dn);
+#else
     nsXPIDLCString dn;
     rv = url->GetDn(getter_Copies (dn));
+#endif
     if ( NS_FAILED(rv) )
         return sal_False;
 
@@ -681,8 +698,14 @@ MDatabaseMetaDataHelper::testLDAPConnect
 
     // Now lets initialize the LDAP connection properly. We'll kick
     // off the bind operation in the callback function, |OnLDAPInit()|.
+#if SYSTEM_MOZ_VER >= 10200
+    PRBool bSSL = options & nsILDAPURL::OPT_SECURE ? PR_TRUE : PR_FALSE;
+    rv = ldapConnection->Init(host.get(), port, bSSL, nsCString(NULL),
+			      nsnull, messageListener);
+#else
     rv = ldapConnection->Init(host.get(), port, options, nsnull,
                               messageListener);
+#endif
     if ( NS_FAILED(rv) )
         return sal_False;
 
Index: connectivity/source/drivers/mozab/mozillasrc/MNSInclude.hxx
===================================================================
RCS file: /cvs/dba/connectivity/source/drivers/mozab/mozillasrc/MNSInclude.hxx,v
retrieving revision 1.7
diff -u -p -u -r1.7 MNSInclude.hxx
--- connectivity/source/drivers/mozab/mozillasrc/MNSInclude.hxx	18 Oct 2002 08:51:22 -0000	1.7
+++ connectivity/source/drivers/mozab/mozillasrc/MNSInclude.hxx	17 Jul 2003 14:22:03 -0000
@@ -65,6 +65,10 @@
 // Only include Mozilla include files once and using this file...
 //
 
+#if SYSTEM_MOZ_VER >= 10200
+#  include <mozilla-config.h>
+#endif
+
 #ifndef BOOL
 # define MOZ_BOOL
 
Index: connectivity/source/drivers/mozab/mozillasrc/makefile.mk
===================================================================
RCS file: /cvs/dba/connectivity/source/drivers/mozab/mozillasrc/makefile.mk,v
retrieving revision 1.11
diff -u -p -u -r1.11 makefile.mk
--- connectivity/source/drivers/mozab/mozillasrc/makefile.mk	15 Apr 2003 17:39:14 -0000	1.11
+++ connectivity/source/drivers/mozab/mozillasrc/makefile.mk	17 Jul 2003 14:22:03 -0000
@@ -145,13 +145,21 @@ CFLAGS +=   -Zi -GR- -W3 -Gy -MDd -UNDEB
 .ENDIF
 .ENDIF
 .IF "$(GUI)" == "UNX"
-INCPOST += . -I.. -I$(MOZ_INC)  -I$(MOZ_INC)$/nspr -I$(MOZ_INC)$/xpcom \
+
+.IF "$(WITH_MOZILLA)" == "YES"
+MOZ_INC = $(MOZILLA_INCLUDE)
+.ELSE
+MOZILLA_VERSION = 10000
+.ENDIF
+
+INCPOST += . -I.. -I$(MOZ_INC)$/nspr -I$(MOZ_INC)$/xpcom -I$(MOZ_INC) \
 	    -I$(MOZ_INC)$/string -I$(MOZ_INC)$/rdf -I$(MOZ_INC)$/msgbase \
 	    -I$(MOZ_INC)$/addrbook -I$(MOZ_INC)$/mork -I$(MOZ_INC)$/locale \
 	    -I$(MOZ_INC)$/pref -I$(MOZ_INC)$/mime -I$(MOZ_INC)$/chrome \
 	    -I$(MOZ_INC)$/necko -I$(MOZ_INC)$/intl -I$(MOZ_INC)$/profile \
 	    -I$(MOZ_INC)$/embed_base -I$(MOZ_INC)$/mozldap
-CDEFS+=	    -DMOZILLA_CLIENT \
+
+CDEFS+=	    -DMOZILLA_CLIENT -DSYSTEM_MOZ_VER=$(MOZILLA_VERSION) \
             -DOSTYPE=\"Linux2.2.14-5\" -DOJI
 .IF "$(OS)" == "LINUX"
 CFLAGS +=   -fPIC -g
