--- vcl/source/gdi/impimagetree.cxx	2004-11-01 11:16:46.256270120 +0100
+++ vcl/source/gdi/impimagetree.cxx	2004-11-01 13:34:49.115084184 +0100
@@ -119,7 +119,11 @@
 
 #define DEFAULT_PROJECTNAME "res"
 #define IMAGES_ZIPFILENAME	"images.zip"
+#define IMAGES_ZIPFILENAME_GNOME	"images_gnome.zip"
+#define IMAGES_ZIPFILENAME_KDE		"images_kde.zip"
 #define IMAGES_CACHEDIR		"imagecache"
+#define IMAGES_CACHEDIR_GNOME	"imagecache_gnome"
+#define IMAGES_CACHEDIR_KDE		"imagecache_kde"
 
 using namespace ::com::sun::star;
 
@@ -219,24 +223,40 @@ const ::rtl::OUString& ImplImageTree::im
 	if( !aRet.getLength() && mxPathSettings.is() && mxFileAccess.is() )
 	{
 		const ::rtl::OUString	aZipFileName( ::rtl::OUString::createFromAscii( IMAGES_ZIPFILENAME ) );
+		::rtl::OUString			aConfigPath;
 		uno::Any 				aAny( mxPathSettings->getPropertyValue( ::rtl::OUString::createFromAscii( "UserConfig" ) ) );
-		INetURLObject			aZipURL;
+		INetURLObject			aZipURL, aDesktopZipURL;
 	
-		if( ( aAny >>= aRet ) && aRet.getLength() )
+		if( ( aAny >>= aConfigPath ) && aConfigPath.getLength() )
 		{
-			aZipURL = INetURLObject( aRet );
+			aZipURL = INetURLObject( aConfigPath );
 			aZipURL.Append( aZipFileName );
 			
 			if( !mxFileAccess->exists( aRet = aZipURL.GetMainURL( INetURLObject::NO_DECODE ) ) )
 			{
 				uno::Any aAny( mxPathSettings->getPropertyValue( ::rtl::OUString::createFromAscii( "Config" ) ) );
 			
-				if( ( aAny >>= aRet ) && aRet.getLength() )
+				if( ( aAny >>= aConfigPath ) && aConfigPath.getLength() )
 				{
-					aZipURL = INetURLObject( aRet );
+					aZipURL = aDesktopZipURL = INetURLObject( aConfigPath );
 					aZipURL.Append( aZipFileName );
+
+					const ::rtl::OUString &rDesktopEnvironment = Application::GetDesktopEnvironment();
+					bool bHasDesktopImages = false;
+					
+					if( rDesktopEnvironment.equalsIgnoreAsciiCaseAscii( "gnome" ) )
+					{
+						aDesktopZipURL.Append( ::rtl::OUString::createFromAscii( IMAGES_ZIPFILENAME_GNOME ) );
+						bHasDesktopImages = true;
+					}
+					else if( rDesktopEnvironment.equalsIgnoreAsciiCaseAscii( "kde" ) )
+					{
+						aDesktopZipURL.Append( ::rtl::OUString::createFromAscii( IMAGES_ZIPFILENAME_KDE ) );
+						bHasDesktopImages = true;
+					}
 				
-					if( !mxFileAccess->exists( aRet = aZipURL.GetMainURL( INetURLObject::NO_DECODE ) ) )
+					if( !( bHasDesktopImages && mxFileAccess->exists( aRet = aDesktopZipURL.GetMainURL( INetURLObject::NO_DECODE ) ) ) &&
+						!mxFileAccess->exists( aRet = aZipURL.GetMainURL( INetURLObject::NO_DECODE ) ) )
 					{
 						aRet = ::rtl::OUString();
 					}
@@ -256,7 +276,14 @@ const ::rtl::OUString& ImplImageTree::im
 	
 	if( !aRet.getLength() && mxPathSettings.is() && mxFileAccess.is() )
 	{
-		const ::rtl::OUString	aImagesCacheDir( ::rtl::OUString::createFromAscii( IMAGES_CACHEDIR ) );
+		::rtl::OUString	aImagesCacheDir( ::rtl::OUString::createFromAscii( IMAGES_CACHEDIR ) );
+
+		const ::rtl::OUString &rDesktopEnvironment = Application::GetDesktopEnvironment();
+		if( rDesktopEnvironment.equalsIgnoreAsciiCaseAscii( "gnome" ) )
+			aImagesCacheDir = ::rtl::OUString::createFromAscii( IMAGES_CACHEDIR_GNOME );
+		else if( rDesktopEnvironment.equalsIgnoreAsciiCaseAscii( "kde" ) )
+			aImagesCacheDir = ::rtl::OUString::createFromAscii( IMAGES_CACHEDIR_KDE );
+
 		uno::Any 				aAny( mxPathSettings->getPropertyValue( ::rtl::OUString::createFromAscii( "UserConfig" ) ) );
 	
 		if( ( aAny >>= aRet ) && aRet.getLength() )
