Index: psprint/inc/psprint/printergfx.hxx
===================================================================
RCS file: /cvs/gsl/psprint/inc/psprint/printergfx.hxx,v
retrieving revision 1.6
diff -u -p -u -r1.6 printergfx.hxx
--- psprint/inc/psprint/printergfx.hxx	6 Jul 2001 16:06:03 -0000	1.6
+++ psprint/inc/psprint/printergfx.hxx	11 Jan 2003 02:28:36 -0000
@@ -238,6 +238,8 @@ private:            
     osl::File*      mpPageHeader;
     osl::File*      mpPageBody;
 
+    void            InitForPrinter( const rtl::OUString &rPrinter );
+
     void            TranslateCoordinates (sal_Int32 &rXOut, sal_Int32 &rYOut, 
                                           sal_Int32 nXIn, sal_Int32 nYIn )
     { rXOut = nXIn; rYOut = nYIn; }
Index: psprint/inc/psprint/printerinfomanager.hxx
===================================================================
RCS file: /cvs/gsl/psprint/inc/psprint/printerinfomanager.hxx,v
retrieving revision 1.2
diff -u -p -u -r1.2 printerinfomanager.hxx
--- psprint/inc/psprint/printerinfomanager.hxx	15 Jun 2001 11:06:33 -0000	1.2
+++ psprint/inc/psprint/printerinfomanager.hxx	11 Jan 2003 02:28:36 -0000
@@ -81,8 +81,27 @@
 #include <psprint/helper.hxx>
 #endif
 
+#include <stdio.h>
+
 namespace psp
 {
+class PrinterInfoManager
+{
+  static PrinterInfoManager *pGlobalManager;
+protected:
+  static void set (PrinterInfoManager *pManager) { pGlobalManager = pManager; }
+public:
+  static PrinterInfoManager *get ()              { return pGlobalManager; }
+  virtual const PPDParser *getParserForPrinter( ::rtl::OUString rPrinter );
+  virtual ::std::hash_map< fontID, fontID > *getFontSubstitutesForPrinter( ::rtl::OUString rPrinter );
+  /* if( !rInfo.m_bPerformFontSubstitution ) == NULL 
+     else new ::std::hash_map< fontID, fontID >( rInfo.m_aFontSubstitutions ); */
+  virtual FILE *getPipeToPrinter( ::rtl::OUString rPrinter );
+};
+
+namespace lpr
+{
+
 struct PrinterInfo : JobData
 {
     // basename of PPD
@@ -112,7 +131,7 @@ struct PrinterInfo : JobData
     m_aFontSubstitutions;
 };
 
-class PrinterInfoManager
+  class PrinterInfoManagerLpr : ::psp::PrinterInfoManager
 {
     // needed for checkPrintersChanged: files (not necessarily existant)
     // and their last known modification time
@@ -147,8 +166,8 @@ class PrinterInfoManager
     ::rtl::OUString                     m_aSystemPrintCommand;
     ::std::list< ::rtl::OUString >      m_aSystemPrintQueues;
 
-    PrinterInfoManager();
-    ~PrinterInfoManager();
+    PrinterInfoManagerLpr();
+    ~PrinterInfoManagerLpr();
 
     void initialize();
 
@@ -206,8 +225,16 @@ public:
         
     // similar but returnse whole commandlines
     void getSystemPrintCommands( ::std::list< ::rtl::OUString >& rCommands );
+
+    virtual const PPDParser *getParserForPrinter( ::rtl::OUString rPrinter );
+    virtual ::std::hash_map< fontID, fontID > *getFontSubstitutesForPrinter( ::rtl::OUString rPrinter );
+  /* if( !rInfo.m_bPerformFontSubstitution ) == NULL 
+     else new ::std::hash_map< fontID, fontID >( rInfo.m_aFontSubstitutions ); */
+    virtual FILE *getPipeToPrinter( ::rtl::OUString rPrinter );
 };
+
+} // namespace lpr
     
-} // namespace
+} // namespace psp
 
 #endif // _PSPRINT_PRINTERINFOMANAGER_HXX_
Index: psprint/source/printer/jobdata.cxx
===================================================================
RCS file: /cvs/gsl/psprint/source/printer/jobdata.cxx,v
retrieving revision 1.1.1.1
diff -u -p -u -r1.1.1.1 jobdata.cxx
--- psprint/source/printer/jobdata.cxx	8 May 2001 11:46:03 -0000	1.1.1.1
+++ psprint/source/printer/jobdata.cxx	11 Jan 2003 02:28:38 -0000
@@ -199,9 +202,7 @@ bool JobData::constructFromStreamBuffer(
         {
             if( bPrinter )
             {
-                PrinterInfoManager& rManager = PrinterInfoManager::get();
-                const PrinterInfo& rInfo = rManager.getPrinterInfo( rJobData.m_aPrinterName );
-                rJobData.m_pParser = PPDParser::getParser( rInfo.m_aDriverName );
+	        rJobData.m_pParser = PrinterInfoManager::get()->getParserForPrinter( rJobData.m_aPrinterName );
                 if( rJobData.m_pParser )
                 {
                     rJobData.m_aContext.setParser( rJobData.m_pParser );
@@ -209,7 +210,7 @@ bool JobData::constructFromStreamBuffer(
                     void* pRemain = new char[ bytes - aStream.Tell() ];
                     aStream.Read( pRemain, nBytes );
                     rJobData.m_aContext.rebuildFromStreamBuffer( pRemain, nBytes );
-                    delete pRemain;
+                    delete (char *) pRemain;
                     bContext = true;
                 }
             }
Index: psprint/source/printer/printerinfomanager.cxx
===================================================================
RCS file: /cvs/gsl/psprint/source/printer/printerinfomanager.cxx,v
retrieving revision 1.11.8.1
diff -u -p -u -r1.11.8.1 printerinfomanager.cxx
--- psprint/source/printer/printerinfomanager.cxx	6 Apr 2002 09:56:35 -0000	1.11.8.1
+++ psprint/source/printer/printerinfomanager.cxx	11 Jan 2003 02:28:38 -0000
@@ -74,36 +74,66 @@
 using namespace psp;
 using namespace rtl;
 using namespace osl;
+using namespace lpr;
+
+#include <stdio.h>
 
 /*
  *  class PrinterInfoManager
  */
 
+PrinterInfoManager *::psp::PrinterInfoManager::pGlobalManager = NULL;
+
+const ::psp::PPDParser *
+PrinterInfoManager::getParserForPrinter( ::rtl::OUString rPrinter )
+{
+  fprintf( stderr, "error, base PrinterInfoManager::getParserForPrinter\n" );
+  return NULL;
+}
+
+::std::hash_map< fontID, fontID > *
+PrinterInfoManager::getFontSubstitutesForPrinter( ::rtl::OUString rPrinter )
+{ // font mapping tables are a terrible idea.
+  fprintf( stderr, "error, base PrinterInfoManager::getFontSubstitutesForPrinter\n" );
+  return NULL;
+}
+
+FILE *
+PrinterInfoManager::getPipeToPrinter( ::rtl::OUString rPrinter )
+{
+  fprintf( stderr, "error, base PrinterInfoManager::getPipeToPrinter\n" );
+  return NULL;
+}
+
+/*
+ *  class PrinterInfoManagerLpr
+ */
+
 // -----------------------------------------------------------------
 
-PrinterInfoManager& PrinterInfoManager::get()
+PrinterInfoManager& PrinterInfoManagerLpr::get()
 {
-    static PrinterInfoManager aManager;
+    static PrinterInfoManagerLpr aManager;
 
     return aManager;
 }
 
 // -----------------------------------------------------------------
 
-PrinterInfoManager::PrinterInfoManager()
+PrinterInfoManagerLpr::PrinterInfoManagerLpr()
 {
     initialize();
 }
 
 // -----------------------------------------------------------------
 
-PrinterInfoManager::~PrinterInfoManager()
+PrinterInfoManagerLpr::~PrinterInfoManagerLpr()
 {
 }
 
 // -----------------------------------------------------------------
 
-bool PrinterInfoManager::checkPrintersChanged()
+bool PrinterInfoManagerLpr::checkPrintersChanged()
 {
     // check if files were created, deleted or modified since initialize()
 
@@ -138,7 +168,7 @@ bool PrinterInfoManager::checkPrintersCh
 
 // -----------------------------------------------------------------
 
-void PrinterInfoManager::initialize()
+void PrinterInfoManagerLpr::initialize()
 {
     rtl_TextEncoding aEncoding = gsl_getSystemTextEncoding();
     m_aPrinters.clear();
@@ -501,7 +531,7 @@ void PrinterInfoManager::initialize()
 
 // -----------------------------------------------------------------
 
-void PrinterInfoManager::listPrinters( ::std::list< OUString >& rList ) const
+void PrinterInfoManagerLpr::listPrinters( ::std::list< OUString >& rList ) const
 {
     ::std::hash_map< OUString, Printer, OUStringHash >::const_iterator it;
     rList.clear();
@@ -511,7 +541,7 @@ void PrinterInfoManager::listPrinters( :
 
 // -----------------------------------------------------------------
 
-const PrinterInfo& PrinterInfoManager::getPrinterInfo( const OUString& rPrinter ) const
+const PrinterInfo& PrinterInfoManagerLpr::getPrinterInfo( const OUString& rPrinter ) const
 {
     static PrinterInfo aEmptyInfo;
     ::std::hash_map< OUString, Printer, OUStringHash >::const_iterator it = m_aPrinters.find( rPrinter );
@@ -523,7 +553,7 @@ const PrinterInfo& PrinterInfoManager::g
 
 // -----------------------------------------------------------------
 
-void PrinterInfoManager::changePrinterInfo( const OUString& rPrinter, const PrinterInfo& rNewInfo )
+void PrinterInfoManagerLpr::changePrinterInfo( const OUString& rPrinter, const PrinterInfo& rNewInfo )
 {
     ::std::hash_map< OUString, Printer, OUStringHash >::iterator it = m_aPrinters.find( rPrinter );
 
@@ -552,7 +582,7 @@ static bool checkWriteability( const OUS
     return bRet;
 }
 
-bool PrinterInfoManager::writePrinterConfig()
+bool PrinterInfoManagerLpr::writePrinterConfig()
 {
     // find at least one writeable config
     ::std::hash_map< OUString, Config*, OUStringHash > files;
@@ -677,7 +707,7 @@ bool PrinterInfoManager::writePrinterCon
 
 // -----------------------------------------------------------------
 
-bool PrinterInfoManager::addPrinter( const OUString& rPrinterName, const OUString& rDriverName )
+bool PrinterInfoManagerLpr::addPrinter( const OUString& rPrinterName, const OUString& rDriverName )
 {
     bool bSuccess = false;
 
@@ -722,7 +752,7 @@ bool PrinterInfoManager::addPrinter( con
 
 // -----------------------------------------------------------------
 
-bool PrinterInfoManager::removePrinter( const OUString& rPrinterName, bool bCheckOnly )
+bool PrinterInfoManagerLpr::removePrinter( const OUString& rPrinterName, bool bCheckOnly )
 {
     bool bSuccess = true;
 
@@ -757,7 +787,7 @@ bool PrinterInfoManager::removePrinter( 
 
 // -----------------------------------------------------------------
 
-bool PrinterInfoManager::setDefaultPrinter( const OUString& rPrinterName )
+bool PrinterInfoManagerLpr::setDefaultPrinter( const OUString& rPrinterName )
 {
     bool bSuccess = false;
 
@@ -775,7 +805,7 @@ bool PrinterInfoManager::setDefaultPrint
 
 // -----------------------------------------------------------------
 
-void PrinterInfoManager::fillFontSubstitutions( PrinterInfo& rInfo ) const
+void PrinterInfoManagerLpr::fillFontSubstitutions( PrinterInfo& rInfo ) const
 {
     PrintFontManager& rFontManager( PrintFontManager::get() );
     rInfo.m_aFontSubstitutions.clear();
@@ -895,7 +925,7 @@ static const struct SystemCommandParamet
 };
 
 
-const ::std::list< OUString >& PrinterInfoManager::getSystemPrintQueues()
+const ::std::list< OUString >& PrinterInfoManagerLpr::getSystemPrintQueues()
 {
     if( m_aSystemPrintQueues.begin() == m_aSystemPrintQueues.end() )
     {
@@ -962,7 +992,7 @@ const ::std::list< OUString >& PrinterIn
     return m_aSystemPrintQueues;
 }
 
-void PrinterInfoManager::getSystemPrintCommands( ::std::list< OUString >& rCommands )
+void PrinterInfoManagerLpr::getSystemPrintCommands( ::std::list< OUString >& rCommands )
 {
     const ::std::list< OUString >& rQueues = getSystemPrintQueues();
     ::std::list< OUString >::const_iterator it;
@@ -974,4 +1004,36 @@ void PrinterInfoManager::getSystemPrintC
         aCmd.SearchAndReplace( aPrinterConst, *it );
         rCommands.push_back( aCmd );
     }
+}
+
+// --- untested, just to show willing ---
+
+const PPDParser *
+PrinterInfoManagerLpr::getParserForPrinter( ::rtl::OUString rPrinter )
+{
+  PrinterInfo rInfo( getPrinterInfo( rPrinter ) );
+  return rInfo.m_pParser;
+}
+
+::std::hash_map< fontID, fontID > *
+PrinterInfoManagerLpr::getFontSubstitutesForPrinter( ::rtl::OUString rPrinter )
+{
+  PrinterInfo rInfo( getPrinterInfo( rPrinter ) );
+
+  if( !rInfo.m_bPerformFontSubstitution )
+    return NULL;
+
+  return new ::std::hash_map< fontID, fontID >( rInfo.m_aFontSubstitutions );
+}
+
+FILE *
+PrinterInfoManagerLpr::getPipeToPrinter( ::rtl::OUString rPrinter )
+{
+  const PrinterInfo&   rPrinterInfo = getPrinterInfo (rPrinter);
+  const rtl::OUString& rCommand     = rPrinterInfo.m_aCommand;
+  
+  const rtl::OString aShellCommand = rtl::OUStringToOString
+    ( rCommand, RTL_TEXTENCODING_ISO_8859_1);
+  
+  return popen (aShellCommand.getStr(), "w");
 }
Index: psprint/source/printergfx/common_gfx.cxx
===================================================================
RCS file: /cvs/gsl/psprint/source/printergfx/common_gfx.cxx,v
retrieving revision 1.8
diff -u -p -u -r1.8 common_gfx.cxx
--- psprint/source/printergfx/common_gfx.cxx	1 Oct 2002 10:06:17 -0000	1.8
+++ psprint/source/printergfx/common_gfx.cxx	11 Jan 2003 02:28:39 -0000
@@ -98,6 +98,17 @@ GraphicsStatus::GraphicsStatus() :
  * non graphics graphics routines
  */
 
+void
+PrinterGfx::InitForPrinter( const ::rtl::OUString &rPrinter )
+{
+  const PPDParser *pParser = PrinterInfoManager::get()->getParserForPrinter( rPrinter );
+    
+  mpFontSubstitutes = PrinterInfoManager::get()->getFontSubstitutesForPrinter( rPrinter );
+  
+  mbUploadPS42Fonts = pParser ? ( pParser->isType42Capable() ? sal_True : sal_False ) : sal_False;
+}
+
+
 sal_Bool
 PrinterGfx::Init (PrinterJob &rPrinterJob)
 {
@@ -109,14 +120,8 @@ PrinterGfx::Init (PrinterJob &rPrinterJo
 
     rPrinterJob.GetResolution (mnDpiX, mnDpiY);
     rPrinterJob.GetScale (mfScaleX, mfScaleY);
-    const PrinterInfo& rInfo( PrinterInfoManager::get().getPrinterInfo( rPrinterJob.GetPrinterName() ) );
-    if( mpFontSubstitutes )
-        delete const_cast< ::std::hash_map<fontID,fontID>* >(mpFontSubstitutes);
-    if( rInfo.m_bPerformFontSubstitution )
-        mpFontSubstitutes = new ::std::hash_map< fontID, fontID >( rInfo.m_aFontSubstitutions );
-    else
-        mpFontSubstitutes = NULL;
-    mbUploadPS42Fonts = rInfo.m_pParser ? ( rInfo.m_pParser->isType42Capable() ? sal_True : sal_False ) : sal_False;
+
+    InitForPrinter( rPrinterJob.GetPrinterName() );
 
     return sal_True;
 }
@@ -135,14 +140,8 @@ PrinterGfx::Init (const JobData& rData)
     mnDpiY          = nResY;
     mfScaleX        = (double)72.0 / (double)mnDpiX;
     mfScaleY        = (double)72.0 / (double)mnDpiY;
-    const PrinterInfo& rInfo( PrinterInfoManager::get().getPrinterInfo( rData.m_aPrinterName ) );
-    if( mpFontSubstitutes )
-        delete const_cast< ::std::hash_map<fontID,fontID>* >(mpFontSubstitutes);
-    if( rInfo.m_bPerformFontSubstitution )
-        mpFontSubstitutes = new ::std::hash_map< fontID, fontID >( rInfo.m_aFontSubstitutions );
-    else
-        mpFontSubstitutes = NULL;
-    mbUploadPS42Fonts = rInfo.m_pParser ? ( rInfo.m_pParser->isType42Capable() ? sal_True : sal_False ) : sal_False;
+
+    InitForPrinter( rData.m_aPrinterName );
     
     return sal_True;
 }
Index: psprint/source/printergfx/printerjob.cxx
===================================================================
RCS file: /cvs/gsl/psprint/source/printergfx/printerjob.cxx,v
retrieving revision 1.15.4.5
diff -u -p -u -r1.15.4.5 printerjob.cxx
--- psprint/source/printergfx/printerjob.cxx	20 Aug 2002 15:13:26 -0000	1.15.4.5
+++ psprint/source/printergfx/printerjob.cxx	11 Jan 2003 02:28:39 -0000
@@ -533,17 +535,10 @@ PrinterJob::EndJob ()
     }
     else
     {
-        const PrinterInfoManager& rPrinterInfoManager = PrinterInfoManager::get ();
-        const rtl::OUString& rPrinter     = m_aLastJobData.m_aPrinterName;
-        const PrinterInfo&   rPrinterInfo = rPrinterInfoManager.getPrinterInfo (rPrinter);
-        const rtl::OUString& rCommand     = rPrinterInfo.m_aCommand;
-
-        const rtl::OString aShellCommand = rtl::OUStringToOString (rCommand, 
-                                                                   RTL_TEXTENCODING_ISO_8859_1);
-													  
-        pDestFILE = popen (aShellCommand.getStr(), "w");
-        if (pDestFILE == NULL)
-            return sal_False;
+      pDestFILE = PrinterInfoManager::get ()->getPipeToPrinter( m_aLastJobData.m_aPrinterName );
+
+      if (pDestFILE == NULL)
+	return sal_False;
     }
 
     /* spool the document parts to the destination */
