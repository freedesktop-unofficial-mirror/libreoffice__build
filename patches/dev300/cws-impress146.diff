Index: xmloff/inc/xmloff/shapeimport.hxx
===================================================================
RCS file: /cvs/xml/xmloff/inc/xmloff/shapeimport.hxx,v
retrieving revision 1.4
retrieving revision 1.4.54.1
diff -u -p -u -p -b -w -B -r1.4 -r1.4.54.1
--- xmloff/inc/xmloff/shapeimport.hxx	10 Apr 2008 21:06:45 -0000	1.4
+++ xmloff/inc/xmloff/shapeimport.hxx	25 Jun 2008 14:08:11 -0000	1.4.54.1
@@ -83,6 +83,8 @@ enum SdXMLGroupShapeElemTokenMap
 
 	XML_TOK_GROUP_ANNOTATION,
 
+	XML_TOK_GROUP_A,
+
 	XML_TOK_GROUP_LAST
 };
 
@@ -259,6 +261,7 @@ class SvXMLShapeContext : public SvXMLIm
 protected:
 	com::sun::star::uno::Reference< com::sun::star::drawing::XShape >	mxShape;
     sal_Bool                                                            mbTemporaryShape;
+	rtl::OUString														msHyperlink;
 
 public:
 	SvXMLShapeContext( SvXMLImport& rImp, USHORT nPrfx,
@@ -267,6 +270,8 @@ public:
 	TYPEINFO();
 
 	const com::sun::star::uno::Reference< com::sun::star::drawing::XShape >& getShape() const { return mxShape; }
+
+	void setHyperlink( const ::rtl::OUString& rHyperlink );
 };
 
 //////////////////////////////////////////////////////////////////////////////
Index: xmloff/source/draw/makefile.mk
===================================================================
RCS file: /cvs/xml/xmloff/source/draw/makefile.mk,v
retrieving revision 1.23
retrieving revision 1.23.54.1
diff -u -p -u -p -b -w -B -r1.23 -r1.23.54.1
--- xmloff/source/draw/makefile.mk	10 Apr 2008 21:47:29 -0000	1.23
+++ xmloff/source/draw/makefile.mk	25 Jun 2008 14:09:12 -0000	1.23.54.1
@@ -80,7 +80,8 @@ SLOFILES =	\
 		$(SLO)$/ximpcustomshape.obj \
 		$(SLO)$/EnhancedCustomShapeToken.obj \
 		$(SLO)$/XMLReplacementImageContext.obj \
-		$(SLO)$/descriptionimp.obj
+		$(SLO)$/descriptionimp.obj \
+		$(SLO)$/ximplink.obj
 
 # --- Targets --------------------------------------------------------------
 
Index: xmloff/source/draw/shapeimport.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/draw/shapeimport.cxx,v
retrieving revision 1.67
retrieving revision 1.67.54.1
diff -u -p -u -p -b -w -B -r1.67 -r1.67.54.1
--- xmloff/source/draw/shapeimport.cxx	10 Apr 2008 21:51:45 -0000	1.67
+++ xmloff/source/draw/shapeimport.cxx	25 Jun 2008 14:09:12 -0000	1.67.54.1
@@ -30,10 +30,14 @@
 
 // MARKER(update_precomp.py): autogen include statement, do not remove
 #include "precompiled_xmloff.hxx"
-#include "unointerfacetouniqueidentifiermapper.hxx"
+
 #include <tools/debug.hxx>
+
+#include <com/sun/star/text/PositionLayoutDir.hpp>
 #include <com/sun/star/chart/XChartDocument.hpp>
 
+#include "unointerfacetouniqueidentifiermapper.hxx"
+
 #include <list>
 
 #ifndef _XMLOFF_SHAPEIMPORT_HXX
@@ -49,9 +53,7 @@
 #include "ximp3dscene.hxx"
 #include "ximp3dobject.hxx"
 #include "ximpgrp.hxx"
-// --> OD 2004-10-28 #i28749#, #i36248#
-#include <com/sun/star/text/PositionLayoutDir.hpp>
-// <--
+#include "ximplink.hxx"
 
 #include <map>
 #include <vector>
@@ -296,6 +298,7 @@ static __FAR_DATA SvXMLTokenMapEntry aGr
 
 	{ XML_NAMESPACE_DRAW,			XML_CUSTOM_SHAPE,	XML_TOK_GROUP_CUSTOM_SHAPE	},
 	{ XML_NAMESPACE_OFFICE,			XML_ANNOTATION,		XML_TOK_GROUP_ANNOTATION	},
+	{ XML_NAMESPACE_DRAW,			XML_A,				XML_TOK_GROUP_A				},
     
     XML_TOKEN_MAP_END
 };
@@ -826,12 +829,10 @@ SvXMLShapeContext* XMLShapeImportHelper:
 			pContext = new SdXMLCustomShapeContext( rImport, p_nPrefix, rLocalName, xAttrList, rShapes, sal_False );
 			break;
 		}
-// 		case XML_TOK_GROUP_CUSTOM_SHAPE:
-// 		{
-// 			// draw:customshape
-// 			pContext = new SdXMLCustomShapeContext( rImport, p_nPrefix, rLocalName, xAttrList, rShapes );
-// 			break;
-// 		}
+ 		case XML_TOK_GROUP_A:
+ 		{
+ 			return new SdXMLShapeLinkContext( rImport, p_nPrefix, rLocalName, xAttrList, rShapes );
+ 		}
 		// add other shapes here...
 		default:
 			return new SvXMLShapeContext( rImport, p_nPrefix, rLocalName, bTemporaryShape );
@@ -1385,3 +1386,8 @@ const rtl::Reference< XMLTableImport >& 
 
 	return mxShapeTableImport;
 }
+
+void SvXMLShapeContext::setHyperlink( const OUString& rHyperlink )
+{
+	msHyperlink = rHyperlink;
+}
\ No newline at end of file
Index: xmloff/source/draw/ximplink.cxx
===================================================================
RCS file: xmloff/source/draw/ximplink.cxx
diff -N xmloff/source/draw/ximplink.cxx
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ xmloff/source/draw/ximplink.cxx	25 Jun 2008 14:09:30 -0000	1.1.2.1
@@ -0,0 +1,105 @@
+/*************************************************************************
+ *
+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
+ * 
+ * Copyright 2008 by Sun Microsystems, Inc.
+ *
+ * OpenOffice.org - a multi-platform office productivity suite
+ *
+ * $RCSfile$
+ * $Revision$
+ *
+ * This file is part of OpenOffice.org.
+ *
+ * OpenOffice.org is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Lesser General Public License version 3
+ * only, as published by the Free Software Foundation.
+ *
+ * OpenOffice.org is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Lesser General Public License version 3 for more details
+ * (a copy is included in the LICENSE file that accompanied this code).
+ *
+ * You should have received a copy of the GNU Lesser General Public License
+ * version 3 along with OpenOffice.org.  If not, see
+ * <http://www.openoffice.org/license.html>
+ * for a copy of the LGPLv3 License.
+ *
+ ************************************************************************/
+
+// MARKER(update_precomp.py): autogen include statement, do not remove
+#include "precompiled_xmloff.hxx"
+#include"xmlnmspe.hxx"
+#include "ximplink.hxx"
+#include <xmloff/xmltoken.hxx>
+
+using ::rtl::OUString;
+using ::rtl::OUStringBuffer;
+
+using namespace ::com::sun::star;
+using namespace ::xmloff::token;
+
+//////////////////////////////////////////////////////////////////////////////
+
+TYPEINIT1( SdXMLShapeLinkContext, SvXMLImportContext );
+
+SdXMLShapeLinkContext::SdXMLShapeLinkContext( SvXMLImport& rImport, USHORT nPrfx, const OUString& rLocalName, const uno::Reference< xml::sax::XAttributeList>& xAttrList, uno::Reference< drawing::XShapes >& rShapes) 
+: SvXMLShapeContext( rImport, nPrfx, rLocalName, false )
+, mxParent( rShapes )
+{
+	sal_Int16 nAttrCount = xAttrList.is() ? xAttrList->getLength() : 0;
+
+	for(sal_Int16 i=0; i < nAttrCount; i++)
+	{
+		OUString sAttrName = xAttrList->getNameByIndex( i );
+		OUString aLocalName;
+		USHORT nPrefix = rImport.GetNamespaceMap().GetKeyByAttrName( sAttrName, &aLocalName );
+		if( (nPrefix == XML_NAMESPACE_XLINK) && IsXMLToken( aLocalName, XML_HREF ) )
+		{
+			msHyperlink = xAttrList->getValueByIndex( i );
+			break;
+		}
+	}
+}
+
+//////////////////////////////////////////////////////////////////////////////
+
+SdXMLShapeLinkContext::~SdXMLShapeLinkContext()
+{
+}
+
+//////////////////////////////////////////////////////////////////////////////
+
+SvXMLImportContext* SdXMLShapeLinkContext::CreateChildContext( USHORT nPrefix,
+	const OUString& rLocalName,
+	const uno::Reference< xml::sax::XAttributeList>& xAttrList )
+{
+	SvXMLShapeContext* pContext = GetImport().GetShapeImport()->CreateGroupChildContext( GetImport(), nPrefix, rLocalName, xAttrList, mxParent);
+
+	if( pContext )
+	{
+		pContext->setHyperlink( msHyperlink );
+		return pContext;
+	}
+
+	// call parent when no own context was created
+	return SvXMLImportContext::CreateChildContext( nPrefix, rLocalName, xAttrList);
+
+}
+
+//////////////////////////////////////////////////////////////////////////////
+
+void SdXMLShapeLinkContext::StartElement(const uno::Reference< xml::sax::XAttributeList>& xAttr )
+{
+	SvXMLImportContext::StartElement( xAttr );
+}
+
+//////////////////////////////////////////////////////////////////////////////
+
+void SdXMLShapeLinkContext::EndElement()
+{
+	SvXMLImportContext::EndElement();
+}
+
+
Index: xmloff/source/draw/ximplink.hxx
===================================================================
RCS file: xmloff/source/draw/ximplink.hxx
diff -N xmloff/source/draw/ximplink.hxx
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ xmloff/source/draw/ximplink.hxx	25 Jun 2008 14:09:40 -0000	1.1.2.1
@@ -0,0 +1,69 @@
+/*************************************************************************
+ *
+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
+ * 
+ * Copyright 2008 by Sun Microsystems, Inc.
+ *
+ * OpenOffice.org - a multi-platform office productivity suite
+ *
+ * $RCSfile$
+ * $Revision$
+ *
+ * This file is part of OpenOffice.org.
+ *
+ * OpenOffice.org is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Lesser General Public License version 3
+ * only, as published by the Free Software Foundation.
+ *
+ * OpenOffice.org is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Lesser General Public License version 3 for more details
+ * (a copy is included in the LICENSE file that accompanied this code).
+ *
+ * You should have received a copy of the GNU Lesser General Public License
+ * version 3 along with OpenOffice.org.  If not, see
+ * <http://www.openoffice.org/license.html>
+ * for a copy of the LGPLv3 License.
+ *
+ ************************************************************************/
+
+#ifndef _XIMPLINK_HXX
+#define _XIMPLINK_HXX
+
+#include <xmloff/xmlictxt.hxx>
+#include "sdxmlimp_impl.hxx"
+#include <xmloff/nmspmap.hxx>
+#include <com/sun/star/drawing/XShapes.hpp>
+#include <tools/rtti.hxx>
+#include "ximpshap.hxx"
+
+//////////////////////////////////////////////////////////////////////////////
+// draw:a context
+
+// this should have been a SvXMLImportContext but CreateGroupChildContext() returns
+// an unneeded derivation. Should be changed sometime during refactoring.
+
+class SdXMLShapeLinkContext : public SvXMLShapeContext
+{
+	// the parent shape group this link is placed in
+	com::sun::star::uno::Reference< com::sun::star::drawing::XShapes > mxParent;
+	rtl::OUString msHyperlink;
+
+public:
+	TYPEINFO();
+
+	SdXMLShapeLinkContext( SvXMLImport& rImport, USHORT nPrfx, const rtl::OUString& rLocalName,
+		const com::sun::star::uno::Reference< com::sun::star::xml::sax::XAttributeList>& xAttrList,
+		com::sun::star::uno::Reference< com::sun::star::drawing::XShapes >& rShapes);
+	virtual ~SdXMLShapeLinkContext();
+
+	virtual SvXMLImportContext *CreateChildContext( 
+		USHORT nPrefix, const rtl::OUString& rLocalName,
+		const com::sun::star::uno::Reference< com::sun::star::xml::sax::XAttributeList>& xAttrList );
+	virtual void StartElement(const com::sun::star::uno::Reference< com::sun::star::xml::sax::XAttributeList>& xAttrList);
+	virtual void EndElement();
+};
+
+
+#endif	//  _XIMPLINK_HXX
Index: xmloff/source/draw/ximpshap.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/draw/ximpshap.cxx,v
retrieving revision 1.126
retrieving revision 1.126.54.1
diff -u -p -u -p -b -w -B -r1.126 -r1.126.54.1
--- xmloff/source/draw/ximpshap.cxx	10 Apr 2008 21:56:35 -0000	1.126
+++ xmloff/source/draw/ximpshap.cxx	25 Jun 2008 14:09:12 -0000	1.126.54.1
@@ -34,6 +34,9 @@
 
 
 #include <tools/debug.hxx>
+#include <com/sun/star/document/XEventsSupplier.hpp>
+#include <com/sun/star/container/XNameReplace.hpp>
+#include <com/sun/star/presentation/ClickAction.hpp>
 #include <com/sun/star/drawing/FillStyle.hpp>
 #include <com/sun/star/drawing/LineStyle.hpp>
 #include "unointerfacetouniqueidentifiermapper.hxx"
@@ -99,6 +102,7 @@ using namespace ::com::sun::star::uno;
 using namespace ::com::sun::star::drawing;
 using namespace ::com::sun::star::style;
 using namespace ::com::sun::star::container;
+using namespace ::com::sun::star::document;
 using namespace ::xmloff::token;
 using namespace ::xmloff::EnhancedCustomShapeToken;
 
@@ -372,6 +376,35 @@ void SdXMLShapeContext::EndElement()
         GetImport().GetTextImport()->_SetListItem( mxOldListItem );
     }
 
+	if( msHyperlink.getLength() != 0 ) try
+	{
+        Reference< XEventsSupplier > xEventsSupplier( mxShape, UNO_QUERY_THROW );
+        Reference< XNameReplace > xEvents( xEventsSupplier->getEvents(), UNO_QUERY_THROW );
+
+        uno::Sequence< beans::PropertyValue > aProperties( 3 );
+		aProperties[0].Name = OUString( RTL_CONSTASCII_USTRINGPARAM( "EventType" ) );
+		aProperties[0].Handle = -1;
+		aProperties[0].Value <<= OUString( RTL_CONSTASCII_USTRINGPARAM("Presentation") );
+		aProperties[0].State = beans::PropertyState_DIRECT_VALUE;
+
+		aProperties[1].Name = OUString( RTL_CONSTASCII_USTRINGPARAM( "ClickAction" ) );
+		aProperties[1].Handle = -1;
+		aProperties[1].Value <<= ::com::sun::star::presentation::ClickAction_DOCUMENT;
+		aProperties[1].State = beans::PropertyState_DIRECT_VALUE;
+
+		aProperties[2].Name = OUString( RTL_CONSTASCII_USTRINGPARAM( "Bookmark" ) );
+		aProperties[2].Handle = -1;
+		aProperties[2].Value <<= msHyperlink;
+		aProperties[2].State = beans::PropertyState_DIRECT_VALUE;
+
+        const OUString sAPIEventName( RTL_CONSTASCII_USTRINGPARAM( "OnClick" ) );
+		xEvents->replaceByName( sAPIEventName, Any( aProperties ) );
+	}
+	catch( Exception& )
+	{
+		DBG_ERROR("xmloff::SdXMLShapeContext::EndElement(), exception caught!");
+	}
+
 	if( mxLockable.is() )
 		mxLockable->removeActionLock();
 }
Index: sd/source/core/drawdoc4.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/core/drawdoc4.cxx,v
retrieving revision 1.57
retrieving revision 1.57.18.1
diff -u -p -u -p -b -w -B -r1.57 -r1.57.18.1
--- sd/source/core/drawdoc4.cxx	6 Jun 2008 11:56:59 -0000	1.57
+++ sd/source/core/drawdoc4.cxx	24 Jun 2008 11:18:01 -0000	1.57.18.1
@@ -561,7 +561,9 @@ static Any implMakeSolidCellStyle( SdSty
 
 static void implCreateTableTemplate( const Reference< XNameContainer >& xTableFamily, const OUString& rName, const Any& rBody, const Any& rHeading, const Any& rBanding )
 {
-	try
+	if( xTableFamily.is() ) try
+	{
+        if( !xTableFamily->hasByName( OUString( rName ) ) )
 	{
 		Reference< XSingleServiceFactory > xFactory( xTableFamily, UNO_QUERY_THROW );
 		Reference< XNameReplace > xDefaultTableStyle( xFactory->createInstance(), UNO_QUERY_THROW );
@@ -575,6 +577,7 @@ static void implCreateTableTemplate( con
 		xDefaultTableStyle->replaceByName( OUString( RTL_CONSTASCII_USTRINGPARAM("last-row") ), rHeading );
 		xDefaultTableStyle->replaceByName( OUString( RTL_CONSTASCII_USTRINGPARAM("last-column") ), rHeading );
 	}
+	}
 	catch( Exception& )
 	{
 		DBG_ERROR("sd::implCreateTableTemplate(), exception caught!");
