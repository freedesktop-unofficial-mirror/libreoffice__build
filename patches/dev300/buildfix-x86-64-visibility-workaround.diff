From 22f4cb531cd25dfa815fa3913ebad8f736e6f09d Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:53:53 +0200
Subject: [PATCH 060/768] buildfix-x86-64-visibility-workaround.diff

---
 configure.in         |    8 +++++---
 set_soenv.in         |    2 ++
 solenv/inc/unxlng.mk |    2 +-
 3 files changed, 8 insertions(+), 4 deletions(-)

diff --git configure.in configure.in
index 976206c..504bf63 100644
--- configure.in
+++ configure.in
@@ -2557,6 +2557,7 @@ fi
 dnl ===================================================================
 dnl system stl sanity tests
 dnl ===================================================================
+HAVE_GCC_VISIBILITY_BROKEN=
 if test "$USE_SYSTEM_STL" = "YES"; then
    AC_MSG_CHECKING([if hash_map will be in __gnu_cxx namespace])
    AC_LANG_PUSH([C++])
@@ -2596,9 +2597,9 @@ using namespace std;
       gccvisok=no)
       AC_MSG_RESULT([$gccvisok])
       if test "$gccvisok" = "no"; then
-         AC_MSG_WARN([Your gcc is not -fvisibility-inlines-hidden safe. Disabling visibility])
-         echo "Your gcc is not -fvisibility-inlines-hidden safe. Disabling visibility" >> warn
-         unset HAVE_GCC_VISIBILITY_FEATURE
+         AC_MSG_WARN([Your gcc is not -fvisibility-inlines-hidden safe, disabling that.])
+         echo "Your gcc is not -fvisibility-inlines-hidden safe, disabling that." >> warn
+         HAVE_GCC_VISIBILITY_BROKEN="TRUE"
       fi
 
       LDFLAGS=$sharedlink_ldflags_save
@@ -2645,6 +2646,7 @@ _ACEOF
 fi
 
 AC_SUBST(HAVE_GCC_VISIBILITY_FEATURE)
+AC_SUBST(HAVE_GCC_VISIBILITY_BROKEN)
 
 dnl ===================================================================
 dnl allocator
diff --git set_soenv.in set_soenv.in
index fe51e71..0cb1516 100644
--- set_soenv.in
+++ set_soenv.in
@@ -1727,6 +1727,8 @@ ToFile( "JAVAHOME",          $JAVAHOME,          "e" );
 ToFile( "CC",                $CC,                "e" );
 ToFile( "HAVE_GCC_VISIBILITY_FEATURE",
 		"@HAVE_GCC_VISIBILITY_FEATURE@", "e" );
+ToFile( "HAVE_GCC_VISIBILITY_BROKEN",
+        "@HAVE_GCC_VISIBILITY_BROKEN@", "e" );
 ToFile( "HAVE_LD_HASH_STYLE","@HAVE_LD_HASH_STYLE@","e" );
 ToFile( "HAVE_LD_BSYMBOLIC_FUNCTIONS",
 		"@HAVE_LD_BSYMBOLIC_FUNCTIONS@","e" );
diff --git solenv/inc/unxlng.mk solenv/inc/unxlng.mk
index b27afb8..446775f 100644
--- solenv/inc/unxlng.mk
+++ solenv/inc/unxlng.mk
@@ -88,7 +88,7 @@ CFLAGS_NO_EXCEPTIONS=-fno-exceptions
 
 # -fpermissive should be removed as soon as possible
 CFLAGSCXX= -pipe $(ARCH_FLAGS)
-.IF "$(HAVE_GCC_VISIBILITY_FEATURE)" == "TRUE"
+.IF "$(HAVE_GCC_VISIBILITY_FEATURE)" == "TRUE" && "$(HAVE_GCC_VISIBILITY_BROKEN)" != "TRUE"
 CFLAGSCXX += -fvisibility-inlines-hidden
 .ENDIF # "$(HAVE_GCC_VISIBILITY_FEATURE)" == "TRUE"
 
-- 
1.7.0.1

