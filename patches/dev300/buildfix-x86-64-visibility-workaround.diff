---
 configure.in         |    8 +++++---
 set_soenv.in         |    2 ++
 solenv/inc/unxlng.mk |    2 +-
 3 files changed, 8 insertions(+), 4 deletions(-)

diff --git configure.in configure.in
index 05704cb..a92e359 100644
--- configure.in
+++ configure.in
@@ -2576,6 +2576,7 @@ fi
 dnl ===================================================================
 dnl system stl sanity tests
 dnl ===================================================================
+HAVE_GCC_VISIBILITY_BROKEN=
 if test "$USE_SYSTEM_STL" = "YES"; then
    AC_MSG_CHECKING([if hash_map will be in __gnu_cxx namespace])
    AC_LANG_PUSH([C++])
@@ -2615,9 +2616,9 @@ using namespace std;
       gccvisok=no)
       AC_MSG_RESULT([$gccvisok])
       if test "$gccvisok" = "no"; then
-         AC_MSG_WARN([Your gcc is not -fvisibility-inlines-hidden safe. Disabling visibility])
-         echo "Your gcc is not -fvisibility-inlines-hidden safe. Disabling visibility" >> warn
-         unset HAVE_GCC_VISIBILITY_FEATURE
+         AC_MSG_WARN([Your gcc is not -fvisibility-inlines-hidden safe, disabling that.])
+         echo "Your gcc is not -fvisibility-inlines-hidden safe, disabling that." >> warn
+         HAVE_GCC_VISIBILITY_BROKEN="TRUE"
       fi
 
       LDFLAGS=$sharedlink_ldflags_save
@@ -2664,6 +2665,7 @@ _ACEOF
 fi
 
 AC_SUBST(HAVE_GCC_VISIBILITY_FEATURE)
+AC_SUBST(HAVE_GCC_VISIBILITY_BROKEN)
 
 dnl ===================================================================
 dnl allocator
diff --git set_soenv.in set_soenv.in
index 4d83375..1c67478 100644
--- set_soenv.in
+++ set_soenv.in
@@ -1768,6 +1768,8 @@ ToFile( "JAVAHOME",          $JAVAHOME,          "e" );
 ToFile( "CC",                $CC,                "e" );
 ToFile( "HAVE_GCC_VISIBILITY_FEATURE",
 		"@HAVE_GCC_VISIBILITY_FEATURE@", "e" );
+ToFile( "HAVE_GCC_VISIBILITY_BROKEN",
+        "@HAVE_GCC_VISIBILITY_BROKEN@", "e" );
 ToFile( "HAVE_LD_HASH_STYLE","@HAVE_LD_HASH_STYLE@","e" );
 ToFile( "HAVE_LD_BSYMBOLIC_FUNCTIONS",
 		"@HAVE_LD_BSYMBOLIC_FUNCTIONS@","e" );
diff --git solenv/inc/unxlng.mk solenv/inc/unxlng.mk
index 62a96f9..d1b6e19 100644
--- solenv/inc/unxlng.mk
+++ solenv/inc/unxlng.mk
@@ -88,7 +88,7 @@ CFLAGS_NO_EXCEPTIONS=-fno-exceptions
 
 # -fpermissive should be removed as soon as possible
 CFLAGSCXX= -pipe $(ARCH_FLAGS)
-.IF "$(HAVE_GCC_VISIBILITY_FEATURE)" == "TRUE"
+.IF "$(HAVE_GCC_VISIBILITY_FEATURE)" == "TRUE" && "$(HAVE_GCC_VISIBILITY_BROKEN)" != "TRUE"
 CFLAGSCXX += -fvisibility-inlines-hidden
 .ENDIF # "$(HAVE_GCC_VISIBILITY_FEATURE)" == "TRUE"
 
-- 
1.7.0.1

