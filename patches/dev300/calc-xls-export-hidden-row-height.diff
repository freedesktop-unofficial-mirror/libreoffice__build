From abcb84576b8de99b342f689cd57868e4d6a7d4af Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:57:02 +0200
Subject: [PATCH 211/768] calc-xls-export-hidden-row-height.diff

---
 sc/inc/document.hxx                |    2 +-
 sc/inc/table.hxx                   |    2 +-
 sc/source/core/data/document.cxx   |    4 ++--
 sc/source/core/data/table2.cxx     |    4 ++--
 sc/source/filter/excel/xetable.cxx |   14 ++++----------
 5 files changed, 10 insertions(+), 16 deletions(-)

diff --git sc/inc/document.hxx sc/inc/document.hxx
index 90b0951..72b790c 100644
--- sc/inc/document.hxx
+++ sc/inc/document.hxx
@@ -1263,7 +1263,7 @@ public:
     void			SetManualHeight( SCROW nStartRow, SCROW nEndRow, SCTAB nTab, BOOL bManual );
 
     SC_DLLPUBLIC USHORT			GetColWidth( SCCOL nCol, SCTAB nTab ) const;
-    SC_DLLPUBLIC USHORT			GetRowHeight( SCROW nRow, SCTAB nTab ) const;
+    SC_DLLPUBLIC USHORT         GetRowHeight( SCROW nRow, SCTAB nTab, bool bHiddenAsZero = true ) const;
     SC_DLLPUBLIC ULONG			GetRowHeight( SCROW nStartRow, SCROW nEndRow, SCTAB nTab ) const;
     ULONG			GetScaledRowHeight( SCROW nStartRow, SCROW nEndRow, SCTAB nTab, double fScale ) const;
     SC_DLLPUBLIC ULONG			GetColOffset( SCCOL nCol, SCTAB nTab ) const;
diff --git sc/inc/table.hxx sc/inc/table.hxx
index 9cabfab..a901eab 100644
--- sc/inc/table.hxx
+++ sc/inc/table.hxx
@@ -610,7 +610,7 @@ public:
     void		SetManualHeight( SCROW nStartRow, SCROW nEndRow, BOOL bManual );
 
     USHORT		GetColWidth( SCCOL nCol );
-    SC_DLLPUBLIC USHORT GetRowHeight( SCROW nRow, SCROW* pStartRow = NULL, SCROW* pEndRow = NULL );
+    SC_DLLPUBLIC USHORT GetRowHeight( SCROW nRow, SCROW* pStartRow = NULL, SCROW* pEndRow = NULL, bool bHiddenAsZero = true );
     ULONG		GetRowHeight( SCROW nStartRow, SCROW nEndRow );
     ULONG		GetScaledRowHeight( SCROW nStartRow, SCROW nEndRow, double fScale );
     ULONG		GetColOffset( SCCOL nCol );
diff --git sc/source/core/data/document.cxx sc/source/core/data/document.cxx
index 7d29b2d..99b79f2 100644
--- sc/source/core/data/document.cxx
+++ sc/source/core/data/document.cxx
@@ -3177,10 +3177,10 @@ USHORT ScDocument::GetOriginalHeight( SCROW nRow, SCTAB nTab ) const
 }
 
 
-USHORT ScDocument::GetRowHeight( SCROW nRow, SCTAB nTab ) const
+USHORT ScDocument::GetRowHeight( SCROW nRow, SCTAB nTab, bool bHiddenAsZero ) const
 {
     if ( ValidTab(nTab) && pTab[nTab] )
-        return pTab[nTab]->GetRowHeight( nRow );
+        return pTab[nTab]->GetRowHeight( nRow, NULL, NULL, bHiddenAsZero );
     DBG_ERROR("Falsche Tabellennummer");
     return 0;
 }
diff --git sc/source/core/data/table2.cxx sc/source/core/data/table2.cxx
index 5e4fcd7..6a7f703 100644
--- sc/source/core/data/table2.cxx
+++ sc/source/core/data/table2.cxx
@@ -2283,13 +2283,13 @@ USHORT ScTable::GetCommonWidth( SCCOL nEndCol )
 }
 
 
-USHORT ScTable::GetRowHeight( SCROW nRow, SCROW* pStartRow, SCROW* pEndRow )
+USHORT ScTable::GetRowHeight( SCROW nRow, SCROW* pStartRow, SCROW* pEndRow, bool bHiddenAsZero )
 {
     DBG_ASSERT(VALIDROW(nRow),"Falsche Zeilennummer");
 
     if (VALIDROW(nRow) && mpRowHeights)
     {
-        if (RowHidden(nRow))
+        if (bHiddenAsZero && RowHidden(nRow))
             return 0;
         else
         {
diff --git sc/source/filter/excel/xetable.cxx sc/source/filter/excel/xetable.cxx
index 30f18e6..9644976 100644
--- sc/source/filter/excel/xetable.cxx
+++ sc/source/filter/excel/xetable.cxx
@@ -1832,17 +1832,11 @@ XclExpRow::XclExpRow( const XclExpRoot& rRoot, sal_uInt16 nXclRow,
 
     // *** Row height *** -----------------------------------------------------
 
-    USHORT nScHeight = GetDoc().GetRowHeight( nScRow, nScTab );
-    if( nScHeight == 0 )
-    {
-        ::set_flag( mnFlags, EXC_ROW_HIDDEN );
-        mnHeight = EXC_ROW_DEFAULTHEIGHT;
-    }
+    if (bUserHeight)
+        mnHeight = GetDoc().GetRowHeight(nScRow, nScTab, false);
     else
-    {
-        // Calc and Excel use twips
-        mnHeight = static_cast< sal_uInt16 >( nScHeight );
-    }
+        mnHeight = EXC_ROW_DEFAULTHEIGHT;
+
     // #76250# not usable in Applix
 //    ::set_flag( mnHeight, EXC_ROW_FLAGDEFHEIGHT, !bUserHeight );
 
-- 
1.7.0.1

