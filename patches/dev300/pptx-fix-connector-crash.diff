From f8e85e7adb3152e09397d89a145bcf72ee4ef307 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:05:49 +0200
Subject: [PATCH 690/878] pptx-fix-connector-crash.diff

---
 oox/source/export/drawingml.cxx |   18 ++++++++++--------
 oox/source/export/shapes.cxx    |    6 ++++++
 2 files changed, 16 insertions(+), 8 deletions(-)

diff --git a/oox/source/export/drawingml.cxx b/oox/source/export/drawingml.cxx
index 11d4fea..4c3b14f 100644
--- a/oox/source/export/drawingml.cxx
+++ b/oox/source/export/drawingml.cxx
@@ -1328,14 +1328,16 @@ void DrawingML::WritePolyPolygon( const PolyPolygon& rPolyPolygon )
 
 void DrawingML::WriteConnectorConnections( EscherConnectorListEntry& rConnectorEntry, sal_Int32 nStartID, sal_Int32 nEndID )
 {
-    mpFS->singleElementNS( XML_a, XML_stCxn,
-                           XML_id, I32S( nStartID ),
-                           XML_idx, I64S( rConnectorEntry.GetConnectorRule( TRUE ) ),
-                           FSEND );
-    mpFS->singleElementNS( XML_a, XML_endCxn,
-                           XML_id, I32S( nEndID ),
-                           XML_idx, I64S( rConnectorEntry.GetConnectorRule( FALSE ) ),
-                           FSEND );
+    if( nStartID != -1 )
+        mpFS->singleElementNS( XML_a, XML_stCxn,
+                               XML_id, I32S( nStartID ),
+                               XML_idx, I64S( rConnectorEntry.GetConnectorRule( TRUE ) ),
+                               FSEND );
+    if( nEndID != -1 )
+        mpFS->singleElementNS( XML_a, XML_endCxn,
+                               XML_id, I32S( nEndID ),
+                               XML_idx, I64S( rConnectorEntry.GetConnectorRule( FALSE ) ),
+                               FSEND );
 }
 
 // from sw/source/filter/ww8/wrtw8num.cxx for default bullets to export to MS intact
diff --git a/oox/source/export/shapes.cxx b/oox/source/export/shapes.cxx
index defbac6..f93f76c 100644
--- a/oox/source/export/shapes.cxx
+++ b/oox/source/export/shapes.cxx
@@ -981,6 +981,9 @@ sal_Int32 ShapeExport::GetNewShapeID( const Reference< XShape > rXShape )
 
 sal_Int32 ShapeExport::GetNewShapeID( const Reference< XShape > rXShape, XmlFilterBase* pFB )
 {
+    if( !rXShape.is() )
+        return -1;
+
     sal_Int32 nID = pFB->GetUniqueId();
 
     saShapeMap[ rXShape ] = nID;
@@ -990,6 +993,9 @@ sal_Int32 ShapeExport::GetNewShapeID( const Reference< XShape > rXShape, XmlFilt
 
 sal_Int32 ShapeExport::GetShapeID( const Reference< XShape > rXShape )
 {
+    if( !rXShape.is() )
+        return -1;
+
     ShapeHashMap::const_iterator aIter = saShapeMap.find( rXShape );
 
     if( aIter == saShapeMap.end() )
-- 
1.7.0.1

