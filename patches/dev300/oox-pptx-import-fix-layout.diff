From 27993a4a0b42f275413f47c8e6c34b3d266d18fb Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:00:47 +0200
Subject: [PATCH 366/768] oox-pptx-import-fix-layout.diff

---
 oox/inc/oox/ppt/pptshape.hxx       |    2 ++
 oox/source/ppt/pptshape.cxx        |   14 ++++++++++++++
 oox/source/ppt/pptshapecontext.cxx |    1 +
 3 files changed, 17 insertions(+), 0 deletions(-)

diff --git oox/inc/oox/ppt/pptshape.hxx oox/inc/oox/ppt/pptshape.hxx
index a3c1384..f001e03 100644
--- oox/inc/oox/ppt/pptshape.hxx
+++ oox/inc/oox/ppt/pptshape.hxx
@@ -61,10 +61,15 @@ public:
     ShapeLocation getShapeLocation() const { return meShapeLocation; };
     sal_Bool isReferenced() const { return mbReferenced; };
     void setReferenced( sal_Bool bReferenced ){ mbReferenced = bReferenced; };
+    void setPlaceholder( oox::drawingml::ShapePtr pPlaceholder ) { mpPlaceholder = pPlaceholder; }
 
     static oox::drawingml::ShapePtr findPlaceholder( const sal_Int32 nMasterPlaceholder, std::vector< oox::drawingml::ShapePtr >& rShapes );
     static oox::drawingml::ShapePtr findPlaceholderByIndex( const sal_Int32 nIdx, std::vector< oox::drawingml::ShapePtr >& rShapes );
     static oox::drawingml::ShapePtr findPlaceholder( sal_Int32 nFirstPlaceholder, sal_Int32 nSecondPlaceholder, std::vector< oox::drawingml::ShapePtr >& rShapes );
+
+protected: 
+
+    oox::drawingml::ShapePtr mpPlaceholder; 
 };
 
 } }
diff --git oox/source/ppt/pptshape.cxx oox/source/ppt/pptshape.cxx
index 61678d1..548562d 100644
--- oox/source/ppt/pptshape.cxx
+++ oox/source/ppt/pptshape.cxx
@@ -167,6 +169,18 @@ void PPTShape::addShape(
             // use style from master slide for placeholders only, otherwise use slide's style, which might be the default style from presentation
                 if ( !aMasterTextListStyle.get() )
                     aMasterTextListStyle = ( mnSubType && rSlidePersist.getMasterPersist().get() ) ? rSlidePersist.getMasterPersist()->getOtherTextStyle() : rSlidePersist.getOtherTextStyle();
+
+            if( aMasterTextListStyle.get() && getTextBody().get() ) {
+                TextListStylePtr aCombinedTextListStyle (new TextListStyle());
+
+                aCombinedTextListStyle->apply( *aMasterTextListStyle.get() );
+
+                if( mpPlaceholder.get() && mpPlaceholder->getTextBody().get() )
+                aCombinedTextListStyle->apply( mpPlaceholder->getTextBody()->getTextListStyle() );
+                aCombinedTextListStyle->apply( getTextBody()->getTextListStyle() );
+
+                setMasterTextListStyle( aCombinedTextListStyle );
+            } else
                 setMasterTextListStyle( aMasterTextListStyle );
  
                 Reference< XShape > xShape( createAndInsert( rFilterBase, sServiceName, pTheme, rxShapes, pShapeRect, bClearText ) );
diff --git oox/source/ppt/pptshapecontext.cxx oox/source/ppt/pptshapecontext.cxx
index f198fbd..5f7586b 100644
--- oox/source/ppt/pptshapecontext.cxx
+++ oox/source/ppt/pptshapecontext.cxx
@@ -207,6 +207,7 @@ Reference< XFastContextHandler > PPTShapeContext::createFastChildContext( sal_In
             PPTShape* pPPTShape = dynamic_cast< PPTShape* >( pPlaceholder.get() );
             if ( pPPTShape )
               pPPTShape->setReferenced( sal_True );
+                    pPPTShapePtr->setPlaceholder( pPlaceholder );
         }
             }
         }
-- 
1.7.0.1

