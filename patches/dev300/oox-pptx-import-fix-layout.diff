From 28899e5079c25c5d03a4e3e7af5581f0c5a38428 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:00:47 +0200
Subject: [PATCH 425/878] oox-pptx-import-fix-layout.diff

---
 oox/inc/oox/ppt/pptshape.hxx       |    2 ++
 oox/source/ppt/pptshape.cxx        |   14 ++++++++++++++
 oox/source/ppt/pptshapecontext.cxx |    1 +
 3 files changed, 17 insertions(+), 0 deletions(-)

diff --git a/oox/inc/oox/ppt/pptshape.hxx b/oox/inc/oox/ppt/pptshape.hxx
index 6cc4e29..31b2f14 100644
--- a/oox/inc/oox/ppt/pptshape.hxx
+++ b/oox/inc/oox/ppt/pptshape.hxx
@@ -61,9 +61,11 @@ public:
     ShapeLocation getShapeLocation() const { return meShapeLocation; };
     sal_Bool isReferenced() const { return mbReferenced; };
     void setReferenced( sal_Bool bReferenced ){ mbReferenced = bReferenced; };
+        void setPlaceholder( oox::drawingml::ShapePtr pPlaceholder ) { mpPlaceholder = pPlaceholder; }
 
 protected:
 
+        oox::drawingml::ShapePtr mpPlaceholder;
 };
 
 } }
diff --git a/oox/source/ppt/pptshape.cxx b/oox/source/ppt/pptshape.cxx
index 0eb6834..39dc495 100644
--- a/oox/source/ppt/pptshape.cxx
+++ b/oox/source/ppt/pptshape.cxx
@@ -28,6 +28,7 @@
 #include "oox/ppt/pptshape.hxx"
 #include "oox/core/namespaces.hxx"
 #include "oox/core/xmlfilterbase.hxx"
+#include "oox/drawingml/textbody.hxx"
 #include "tokens.hxx"
 
 #include <com/sun/star/container/XNamed.hpp>
@@ -40,6 +41,7 @@
 
 using rtl::OUString;
 using namespace ::oox::core;
+using namespace ::oox::drawingml;
 using namespace ::com::sun::star;
 using namespace ::com::sun::star::awt;
 using namespace ::com::sun::star::uno;
@@ -167,6 +169,18 @@ void PPTShape::addShape(
             // use style from master slide for placeholders only, otherwise use slide's style, which might be the default style from presentation
                 if ( !aMasterTextListStyle.get() )
                     aMasterTextListStyle = ( mnSubType && rSlidePersist.getMasterPersist().get() ) ? rSlidePersist.getMasterPersist()->getOtherTextStyle() : rSlidePersist.getOtherTextStyle();
+
+            if( aMasterTextListStyle.get() && getTextBody().get() ) {
+                TextListStylePtr aCombinedTextListStyle (new TextListStyle());
+
+                aCombinedTextListStyle->apply( *aMasterTextListStyle.get() );
+
+                if( mpPlaceholder.get() && mpPlaceholder->getTextBody().get() )
+                aCombinedTextListStyle->apply( mpPlaceholder->getTextBody()->getTextListStyle() );
+                aCombinedTextListStyle->apply( getTextBody()->getTextListStyle() );
+
+                setMasterTextListStyle( aCombinedTextListStyle );
+            } else
                 setMasterTextListStyle( aMasterTextListStyle );
 
                 Reference< XShape > xShape( createAndInsert( rFilterBase, sServiceName, rxTheme, rxShapes, pShapeRect, bClearText ) );
diff --git a/oox/source/ppt/pptshapecontext.cxx b/oox/source/ppt/pptshapecontext.cxx
index 2ed342a..ee57d85 100644
--- a/oox/source/ppt/pptshapecontext.cxx
+++ b/oox/source/ppt/pptshapecontext.cxx
@@ -207,6 +207,7 @@ Reference< XFastContextHandler > PPTShapeContext::createFastChildContext( sal_In
             PPTShape* pPPTShape = dynamic_cast< PPTShape* >( pPlaceholder.get() );
             if ( pPPTShape )
               pPPTShape->setReferenced( sal_True );
+                    pPPTShapePtr->setPlaceholder( pPlaceholder );
         }
             }
         }
-- 
1.7.0.1

