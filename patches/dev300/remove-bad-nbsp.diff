From fb73659b9a90a8455cc86d8fef520b62c5fd4d65 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:02:35 +0200
Subject: [PATCH 453/768] remove-bad-nbsp.diff

---
 editeng/inc/editeng/svxacorr.hxx   |    4 +++
 editeng/source/editeng/editeng.cxx |    5 +++-
 editeng/source/misc/svxacorr.cxx   |   51 ++++++++++++++++++++++++++++++-----
 sw/source/ui/docvw/edtwin.cxx      |   10 +++---
 4 files changed, 56 insertions(+), 14 deletions(-)

diff --git editeng/inc/editeng/svxacorr.hxx editeng/inc/editeng/svxacorr.hxx
index ab5b65a..9635c7e 100644
--- editeng/inc/editeng/svxacorr.hxx
+++ editeng/inc/editeng/svxacorr.hxx
@@ -211,6 +211,8 @@ class EDITENG_DLLPUBLIC SvxAutoCorrect
     SvxAutoCorrLastFileAskTable_Impl* pLastFileTable;
     CharClass* pCharClass;
 
+    bool bRunNext;
+
     LanguageType eCharClassLang;
 
     long nFlags;
@@ -380,6 +382,8 @@ public:
                             xub_StrLen nSttPos, xub_StrLen nEndPos,
                             LanguageType eLang  = LANGUAGE_SYSTEM );
 
+    bool                HasRunNext() { return bRunNext; }
+
     static long			GetDefaultFlags();
 
 // returns TRUE for charcters where the function
diff --git editeng/source/editeng/editeng.cxx editeng/source/editeng/editeng.cxx
index 0b3f5f5..fc1ace2 100644
--- editeng/source/editeng/editeng.cxx
+++ editeng/source/editeng/editeng.cxx
@@ -51,6 +51,7 @@
 #include <editeng.hrc>
 #include <editeng/flditem.hxx>
 #include <editeng/txtrange.hxx>
+#include <editeng/acorrcfg.hxx>
 #include <vcl/graph.hxx>
 
 #include <editeng/akrnitem.hxx>
@@ -1144,8 +1145,10 @@ sal_Bool EditEngine::PostKeyEvent( const KeyEvent& rKeyEvent, EditView* pEditVie
                     xub_Unicode nCharCode = rKeyEvent.GetCharCode();
                     pEditView->pImpEditView->DrawSelection();
                     // Autokorrektur ?
+                    SvxAutoCorrect*	pAutoCorrect = SvxAutoCorrCfg::Get()->GetAutoCorrect();
                     if ( ( pImpEditEngine->GetStatus().DoAutoCorrect() ) &&
-                        SvxAutoCorrect::IsAutoCorrectChar( nCharCode ) )
+                        ( SvxAutoCorrect::IsAutoCorrectChar( nCharCode ) ||
+                          pAutoCorrect->HasRunNext() ) )
                     {
                         aCurSel = pImpEditEngine->AutoCorrect(
                             aCurSel, nCharCode, !pEditView->IsInsertMode(), pFrameWin );
diff --git editeng/source/misc/svxacorr.cxx editeng/source/misc/svxacorr.cxx
index a2dfaca..c22d3aa 100644
--- editeng/source/misc/svxacorr.cxx
+++ editeng/source/misc/svxacorr.cxx
@@ -365,7 +365,7 @@ SvxAutoCorrect::SvxAutoCorrect( const String& rShareAutocorrFile,
     sUserAutoCorrFile( rUserAutocorrFile ),
     pLangTable( new SvxAutoCorrLanguageTable_Impl ),
     pLastFileTable( new SvxAutoCorrLastFileAskTable_Impl ),
-    pCharClass( 0 ),
+    pCharClass( 0 ), bRunNext( false ),
     cStartDQuote( 0 ), cEndDQuote( 0 ), cStartSQuote( 0 ), cEndSQuote( 0 )
 {
     nFlags = SvxAutoCorrect::GetDefaultFlags();
@@ -382,7 +382,7 @@ SvxAutoCorrect::SvxAutoCorrect( const SvxAutoCorrect& rCpy )
 
     pLangTable( new SvxAutoCorrLanguageTable_Impl ),
     pLastFileTable( new SvxAutoCorrLastFileAskTable_Impl ),
-    pCharClass( 0 ),
+    pCharClass( 0 ), bRunNext( false ),
 
     nFlags( rCpy.nFlags & ~(ChgWordLstLoad|CplSttLstLoad|WrdSttLstLoad)),
     cStartDQuote( rCpy.cStartDQuote ), cEndDQuote( rCpy.cEndDQuote ),
@@ -671,7 +671,7 @@ BOOL SvxAutoCorrect::FnAddNonBrkSpace(
             
             // Check the presence of "://" in the word
             xub_StrLen nStrPos = rTxt.Search( String::CreateFromAscii( "://" ), nSttWdPos + 1 );
-            if ( STRING_NOTFOUND == nStrPos )
+            if ( STRING_NOTFOUND == nStrPos && nEndPos > 0 )
             {
                 // Check the previous char
                 sal_Unicode cPrevChar = rTxt.GetChar( nEndPos - 1 );
@@ -695,9 +695,12 @@ BOOL SvxAutoCorrect::FnAddNonBrkSpace(
                         // Add the non-breaking space at the end pos
                         if ( bHasSpace )
                             rDoc.Insert( nPos, CHAR_HARDBLANK );
+                        bRunNext = true;
                         bRet = true;
                     }
                 }
+                else if ( chars.indexOf( sal_Unicode( cPrevChar ) ) != -1 )
+                    bRunNext = true;
             }
         }
         else if ( cChar == '/' )
@@ -1234,6 +1237,9 @@ ULONG SvxAutoCorrect::AutoCorrect( SvxAutoCorrDoc& rDoc, const String& rTxt,
                                     BOOL bInsert, Window* pFrameWin )
 {
     ULONG nRet = 0;
+    bool bIsNextRun = bRunNext;
+    bRunNext = false;  // if it was set, then it has to be turned off
+
     do{		                            // only for middle check loop !!
         if( cChar )
         {
@@ -1270,12 +1276,41 @@ ULONG SvxAutoCorrect::AutoCorrect( SvxAutoCorrDoc& rDoc, const String& rTxt,
                 rDoc.Insert( nInsPos, cChar );
             else
                 rDoc.Replace( nInsPos, cChar );
-    
-            // Hardspaces autocorrection    
-            if ( NeedsHardspaceAutocorr( cChar ) && IsAutoCorrFlag( AddNonBrkSpace ) &&
-                FnAddNonBrkSpace( rDoc, rTxt, 0, nInsPos, rDoc.GetLanguage( nInsPos, FALSE ) ) )
+
+            // Hardspaces autocorrection
+            if ( IsAutoCorrFlag( AddNonBrkSpace ) )
             {
-                nRet = AddNonBrkSpace;
+                if ( NeedsHardspaceAutocorr( cChar ) &&
+                    FnAddNonBrkSpace( rDoc, rTxt, 0, nInsPos, rDoc.GetLanguage( nInsPos, FALSE ) ) )
+                {
+                    nRet = AddNonBrkSpace;
+                }
+                else if ( bIsNextRun && !IsAutoCorrectChar( cChar ) )
+                {
+                    // Remove the NBSP if it wasn't an autocorrection
+                    if ( NeedsHardspaceAutocorr( rTxt.GetChar( nInsPos - 1 ) ) &&
+                            cChar != ' ' && cChar != '\t' && cChar != CHAR_HARDBLANK )
+                    {
+                        // Look for the last HARD_SPACE
+                        xub_StrLen nPos = nInsPos - 1;
+                        bool bFound = false;
+                        while ( nPos != STRING_NOTFOUND  && !bFound )
+                        {
+                            sal_Unicode cTmpChar = rTxt.GetChar( nPos );
+                            if ( cTmpChar == CHAR_HARDBLANK )
+                                bFound = true;
+                            else if ( !NeedsHardspaceAutocorr( cTmpChar ) )
+                                nPos = STRING_NOTFOUND;
+                            nPos--;
+                        }
+
+                        if ( bFound && nPos != STRING_NOTFOUND )
+                        {
+                            rDoc.Delete( nPos + 1, nPos + 2 );
+                            nRet = AddNonBrkSpace;
+                        }
+                    }
+                }
             }
         }
 
diff --git sw/source/ui/docvw/edtwin.cxx sw/source/ui/docvw/edtwin.cxx
index 7c10b18..a755fc1 100644
--- sw/source/ui/docvw/edtwin.cxx
+++ sw/source/ui/docvw/edtwin.cxx
@@ -2262,7 +2262,8 @@ KEYINPUT_CHECKTABLE_INSDEL:
 
 
                 BOOL bIsAutoCorrectChar =  SvxAutoCorrect::IsAutoCorrectChar( aCh );
-                if( !aKeyEvent.GetRepeat() && pACorr && bIsAutoCorrectChar &&
+                BOOL bRunNext = pACorr->HasRunNext();
+                if( !aKeyEvent.GetRepeat() && pACorr && ( bIsAutoCorrectChar || bRunNext ) &&
                         pACfg->IsAutoFmtByInput() &&
                     (( pACorr->IsAutoCorrFlag( ChgWeightUnderl ) &&
                         ( '*' == aCh || '_' == aCh ) ) ||
@@ -2274,14 +2275,13 @@ KEYINPUT_CHECKTABLE_INSDEL:
                     if( '\"' != aCh && '\'' != aCh )        // nur bei "*_" rufen!
                         rSh.UpdateAttr();
                 }
-                else if( !aKeyEvent.GetRepeat() && pACorr && bIsAutoCorrectChar &&
+                else if( !aKeyEvent.GetRepeat() && pACorr && ( bIsAutoCorrectChar || bRunNext ) &&
                         pACfg->IsAutoFmtByInput() &&
                     pACorr->IsAutoCorrFlag( CptlSttSntnc | CptlSttWrd |
-                                            ChgOrdinalNumber |
+                                            ChgOrdinalNumber | AddNonBrkSpace |
                                             ChgToEnEmDash | SetINetAttr |
                                             Autocorrect ) &&
-                    '\"' != aCh && '\'' != aCh && '*' != aCh && '_' != aCh &&
-                    !bIsNormalChar
+                    '\"' != aCh && '\'' != aCh && '*' != aCh && '_' != aCh
                     )
                 {
                     FlushInBuffer();
-- 
1.7.0.1

