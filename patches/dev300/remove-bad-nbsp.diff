From be5e77b7f36d232f2a6f1d0553471a272a75f61e Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:02:35 +0200
Subject: [PATCH 524/878] remove-bad-nbsp.diff

---
 svx/inc/svx/svxacorr.hxx        |    4 +++
 svx/source/editeng/editeng.cxx  |    5 +++-
 svx/source/editeng/svxacorr.cxx |   47 ++++++++++++++++++++++++++++++++++-----
 sw/source/ui/docvw/edtwin.cxx   |   10 ++++----
 4 files changed, 54 insertions(+), 12 deletions(-)

diff --git a/svx/inc/svx/svxacorr.hxx b/svx/inc/svx/svxacorr.hxx
index 14089bc..74a16de 100644
--- a/svx/inc/svx/svxacorr.hxx
+++ b/svx/inc/svx/svxacorr.hxx
@@ -211,6 +211,8 @@ class SVX_DLLPUBLIC SvxAutoCorrect
     SvxAutoCorrLastFileAskTable_Impl* pLastFileTable;
     CharClass* pCharClass;
 
+    bool bRunNext;
+
     LanguageType eCharClassLang;
 
     long nFlags;
@@ -380,6 +382,8 @@ public:
                             xub_StrLen nSttPos, xub_StrLen nEndPos,
                             LanguageType eLang  = LANGUAGE_SYSTEM );
 
+    bool                HasRunNext() { return bRunNext; }
+
     static long			GetDefaultFlags();
 
 // returns TRUE for charcters where the function
diff --git a/svx/source/editeng/editeng.cxx b/svx/source/editeng/editeng.cxx
index 337d1ee..263b56d 100644
--- a/svx/source/editeng/editeng.cxx
+++ b/svx/source/editeng/editeng.cxx
@@ -46,6 +46,7 @@
 #include <eerdll2.hxx>
 #include <eerdll.hxx>
 #include <editeng.hrc>
+#include <acorrcfg.hxx>
 #include <svx/flditem.hxx>
 #include <txtrange.hxx>
 #include <vcl/graph.hxx>
@@ -1142,8 +1143,10 @@ sal_Bool EditEngine::PostKeyEvent( const KeyEvent& rKeyEvent, EditView* pEditVie
                     xub_Unicode nCharCode = rKeyEvent.GetCharCode();
                     pEditView->pImpEditView->DrawSelection();
                     // Autokorrektur ?
+                    SvxAutoCorrect*	pAutoCorrect = SvxAutoCorrCfg::Get()->GetAutoCorrect();
                     if ( ( pImpEditEngine->GetStatus().DoAutoCorrect() ) &&
-                        SvxAutoCorrect::IsAutoCorrectChar( nCharCode ) )
+                        ( SvxAutoCorrect::IsAutoCorrectChar( nCharCode ) ||
+                          pAutoCorrect->HasRunNext() ) )
                     {
                         aCurSel = pImpEditEngine->AutoCorrect(
                             aCurSel, nCharCode, !pEditView->IsInsertMode(), pFrameWin );
diff --git a/svx/source/editeng/svxacorr.cxx b/svx/source/editeng/svxacorr.cxx
index 13d9268..9acabac 100644
--- a/svx/source/editeng/svxacorr.cxx
+++ b/svx/source/editeng/svxacorr.cxx
@@ -386,7 +386,7 @@ SvxAutoCorrect::SvxAutoCorrect( const String& rShareAutocorrFile,
     sUserAutoCorrFile( rUserAutocorrFile ),
     pLangTable( new SvxAutoCorrLanguageTable_Impl ),
     pLastFileTable( new SvxAutoCorrLastFileAskTable_Impl ),
-    pCharClass( 0 ),
+    pCharClass( 0 ), bRunNext( false ),
     cStartDQuote( 0 ), cEndDQuote( 0 ), cStartSQuote( 0 ), cEndSQuote( 0 )
 {
     nFlags = SvxAutoCorrect::GetDefaultFlags();
@@ -403,7 +403,7 @@ SvxAutoCorrect::SvxAutoCorrect( const SvxAutoCorrect& rCpy )
 
     pLangTable( new SvxAutoCorrLanguageTable_Impl ),
     pLastFileTable( new SvxAutoCorrLastFileAskTable_Impl ),
-    pCharClass( 0 ),
+    pCharClass( 0 ), bRunNext( false ),
 
     nFlags( rCpy.nFlags & ~(ChgWordLstLoad|CplSttLstLoad|WrdSttLstLoad)),
     cStartDQuote( rCpy.cStartDQuote ), cEndDQuote( rCpy.cEndDQuote ),
@@ -692,7 +692,7 @@ BOOL SvxAutoCorrect::FnAddNonBrkSpace(
 
             // Check the presence of "://" in the word
             xub_StrLen nStrPos = rTxt.Search( String::CreateFromAscii( "://" ), nSttWdPos + 1 );
-            if ( STRING_NOTFOUND == nStrPos )
+            if ( STRING_NOTFOUND == nStrPos && nEndPos > 0 )
             {
                 // Check the previous char
                 sal_Unicode cPrevChar = rTxt.GetChar( nEndPos - 1 );
@@ -716,9 +716,12 @@ BOOL SvxAutoCorrect::FnAddNonBrkSpace(
                         // Add the non-breaking space at the end pos
                         if ( bHasSpace )
                             rDoc.Insert( nPos, CHAR_HARDBLANK );
+                        bRunNext = true;
                         bRet = true;
                     }
                 }
+                else if ( chars.indexOf( sal_Unicode( cPrevChar ) ) != -1 )
+                    bRunNext = true;
             }
         }
         else if ( cChar == '/' )
@@ -1255,6 +1258,9 @@ ULONG SvxAutoCorrect::AutoCorrect( SvxAutoCorrDoc& rDoc, const String& rTxt,
                                     BOOL bInsert, Window* pFrameWin )
 {
     ULONG nRet = 0;
+    bool bIsNextRun = bRunNext;
+    bRunNext = false;  // if it was set, then it has to be turned off
+
     do{		                            // only for middle check loop !!
         if( cChar )
         {
@@ -1293,10 +1299,39 @@ ULONG SvxAutoCorrect::AutoCorrect( SvxAutoCorrDoc& rDoc, const String& rTxt,
                 rDoc.Replace( nInsPos, cChar );
 
             // Hardspaces autocorrection
-            if ( NeedsHardspaceAutocorr( cChar ) && IsAutoCorrFlag( AddNonBrkSpace ) &&
-                FnAddNonBrkSpace( rDoc, rTxt, 0, nInsPos, rDoc.GetLanguage( nInsPos, FALSE ) ) )
+            if ( IsAutoCorrFlag( AddNonBrkSpace ) )
             {
-                nRet = AddNonBrkSpace;
+                if ( NeedsHardspaceAutocorr( cChar ) &&
+                    FnAddNonBrkSpace( rDoc, rTxt, 0, nInsPos, rDoc.GetLanguage( nInsPos, FALSE ) ) )
+                {
+                    nRet = AddNonBrkSpace;
+                }
+                else if ( bIsNextRun && !IsAutoCorrectChar( cChar ) )
+                {
+                    // Remove the NBSP if it wasn't an autocorrection
+                    if ( NeedsHardspaceAutocorr( rTxt.GetChar( nInsPos - 1 ) ) &&
+                            cChar != ' ' && cChar != '\t' && cChar != CHAR_HARDBLANK )
+                    {
+                        // Look for the last HARD_SPACE
+                        xub_StrLen nPos = nInsPos - 1;
+                        bool bFound = false;
+                        while ( nPos != STRING_NOTFOUND  && !bFound )
+                        {
+                            sal_Unicode cTmpChar = rTxt.GetChar( nPos );
+                            if ( cTmpChar == CHAR_HARDBLANK )
+                                bFound = true;
+                            else if ( !NeedsHardspaceAutocorr( cTmpChar ) )
+                                nPos = STRING_NOTFOUND;
+                            nPos--;
+                        }
+
+                        if ( bFound && nPos != STRING_NOTFOUND )
+                        {
+                            rDoc.Delete( nPos + 1, nPos + 2 );
+                            nRet = AddNonBrkSpace;
+                        }
+                    }
+                }
             }
         }
 
diff --git a/sw/source/ui/docvw/edtwin.cxx b/sw/source/ui/docvw/edtwin.cxx
index 1cd6e6a..26024ba 100644
--- a/sw/source/ui/docvw/edtwin.cxx
+++ b/sw/source/ui/docvw/edtwin.cxx
@@ -2267,7 +2267,8 @@ KEYINPUT_CHECKTABLE_INSDEL:
 
 
                 BOOL bIsAutoCorrectChar =  SvxAutoCorrect::IsAutoCorrectChar( aCh );
-                if( !aKeyEvent.GetRepeat() && pACorr && bIsAutoCorrectChar &&
+                BOOL bRunNext = pACorr->HasRunNext();
+                if( !aKeyEvent.GetRepeat() && pACorr && ( bIsAutoCorrectChar || bRunNext ) &&
                         pACfg->IsAutoFmtByInput() &&
                     (( pACorr->IsAutoCorrFlag( ChgWeightUnderl ) &&
                         ( '*' == aCh || '_' == aCh ) ) ||
@@ -2279,14 +2280,13 @@ KEYINPUT_CHECKTABLE_INSDEL:
                     if( '\"' != aCh && '\'' != aCh )        // nur bei "*_" rufen!
                         rSh.UpdateAttr();
                 }
-                else if( !aKeyEvent.GetRepeat() && pACorr && bIsAutoCorrectChar &&
+                else if( !aKeyEvent.GetRepeat() && pACorr && ( bIsAutoCorrectChar || bRunNext ) &&
                         pACfg->IsAutoFmtByInput() &&
                     pACorr->IsAutoCorrFlag( CptlSttSntnc | CptlSttWrd |
-                                            ChgOrdinalNumber |
+                                            ChgOrdinalNumber | AddNonBrkSpace |
                                             ChgToEnEmDash | SetINetAttr |
                                             Autocorrect ) &&
-                    '\"' != aCh && '\'' != aCh && '*' != aCh && '_' != aCh &&
-                    !bIsNormalChar
+                    '\"' != aCh && '\'' != aCh && '*' != aCh && '_' != aCh
                     )
                 {
                     FlushInBuffer();
-- 
1.7.0.1

