From a90b33ba5a9885d971adf6797ecba883b81792f5 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:53:30 +0200
Subject: [PATCH 040/768] cjk-character-units-rulers-sync-with-pggrid-fix.diff

---
 svtools/inc/ruler.hxx            |    2 ++
 svtools/source/control/ruler.cxx |   12 ++++++++++--
 sw/source/ui/inc/pggrid.hxx      |    2 ++
 sw/source/ui/misc/pggrid.cxx     |   24 ++++++++++++++++++++----
 4 files changed, 34 insertions(+), 6 deletions(-)

diff --git svtools/inc/ruler.hxx svtools/inc/ruler.hxx
index a77a517..22eec9f 100644
--- svtools/inc/ruler.hxx
+++ svtools/inc/ruler.hxx
@@ -876,6 +876,8 @@ public:
 
     void                SetCharWidth( long nWidth ) { mnCharWidth = nWidth ; }
     void                SetLineHeight( long nHeight ) { mnLineHeight = nHeight ; }
+
+    void                DrawTicks();
 };
 
 #endif  // _RULER_HXX
diff --git svtools/source/control/ruler.cxx svtools/source/control/ruler.cxx
index df4b461..24092c3 100644
--- svtools/source/control/ruler.cxx
+++ svtools/source/control/ruler.cxx
@@ -476,14 +476,14 @@ void Ruler::ImplDrawTicks( long nMin, long nMax, long nStart, long nCenter )
     long    nTick2 ;
     if ( mnUnitIndex == RULER_UNIT_CHAR )
     {
-        nTick3 = mnCharWidth;
+        nTick3 = mnCharWidth*2;
         nTickCount = mnCharWidth;
         nTickUnit = mnCharWidth;
         nTick2 = mnCharWidth;
     }
     else if ( mnUnitIndex == RULER_UNIT_LINE )
     {
-        nTick3 = mnLineHeight;
+        nTick3 = mnLineHeight*2;
         nTickCount = mnLineHeight;
         nTickUnit = mnLineHeight;
         nTick2 = mnLineHeight;
@@ -3219,3 +3219,11 @@ const RulerBorder*  Ruler::GetBorders() const { return mpData->pBorders; }
 USHORT              Ruler::GetIndentCount() const { return mpData->nIndents; }
 const RulerIndent*  Ruler::GetIndents() const { return mpData->pIndents; }
 
+/* ---------------------------------------------------
+ *
+ * ---------------------------------------------------*/
+void Ruler::DrawTicks()
+{
+    mbFormat = TRUE;
+    ImplDraw();
+}
diff --git sw/source/ui/inc/pggrid.hxx sw/source/ui/inc/pggrid.hxx
index a05adbd..4a584a4 100644
--- sw/source/ui/inc/pggrid.hxx
+++ sw/source/ui/inc/pggrid.hxx
@@ -85,6 +85,8 @@ class SwTextGridPage: public SfxTabPage
     Size            m_aPageSize;
     sal_Bool        m_bVertical;
     sal_Bool		m_bSquaredMode;
+    sal_Bool        m_bHRulerChanged;
+    sal_Bool        m_bVRulerChanged;
 
     SwTextGridPage(Window *pParent, const SfxItemSet &rSet);
     ~SwTextGridPage();
diff --git sw/source/ui/misc/pggrid.cxx sw/source/ui/misc/pggrid.cxx
index 22e2472..ee7ac77 100644
--- sw/source/ui/misc/pggrid.cxx
+++ sw/source/ui/misc/pggrid.cxx
@@ -95,7 +95,9 @@ SwTextGridPage::SwTextGridPage(Window *pParent, const SfxItemSet &rSet) :
     m_bRubyUserValue(sal_False),
     m_aPageSize(MM50, MM50),
     m_bVertical(sal_False),
-    m_bSquaredMode(sal_False)
+    m_bSquaredMode(sal_False),
+    m_bHRulerChanged( sal_False ),
+    m_bVRulerChanged( sal_False )
 {
     FreeResource();
 
@@ -229,6 +231,12 @@ BOOL    SwTextGridPage::FillItemSet(SfxItemSet &rSet)
         bRet = TRUE;
     }
 
+    // draw ticks of ruler
+    SwView * pView = ::GetActiveView();
+    if ( m_bHRulerChanged )
+        pView->GetHLineal().DrawTicks();
+    if ( m_bVRulerChanged )
+        pView->GetVLineal().DrawTicks();
     return bRet;
 }
 /*-- 06.02.2002 15:25:40---------------------------------------------------
@@ -315,9 +323,17 @@ void SwTextGridPage::PutGridItem(SfxItemSet& rSet)
         aGridItem.SetColor(aColorLB.GetSelectEntryColor());
         rSet.Put(aGridItem);
 /// Amelia
-        SwView * pView = ::GetActiveView();
-        pView->GetHLineal().SetCharWidth((long)(aCharWidthMF.GetValue(FUNIT_TWIP)/56.7));
-        pView->GetVLineal().SetLineHeight((long)(aTextSizeMF.GetValue(FUNIT_TWIP)/56.7));
+        if ( aGridItem.GetGridType() != GRID_NONE )
+        {
+            SwView * pView = ::GetActiveView();
+            if ( aGridItem.GetGridType() == GRID_LINES_CHARS )
+            {
+                pView->GetHLineal().SetCharWidth((long)(aCharWidthMF.GetValue(FUNIT_TWIP)/56.7));
+                m_bHRulerChanged = sal_True;
+            }
+            pView->GetVLineal().SetLineHeight((long)(aTextSizeMF.GetValue(FUNIT_TWIP)/56.7));
+            m_bVRulerChanged = sal_True;
+        }
 }
 /* -----------------------------08.02.2002 10:54------------------------------
 
-- 
1.7.0.1

