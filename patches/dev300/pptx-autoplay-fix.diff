From 5bd67d658466634d85193019448451aaab6ec2ec Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:06:23 +0200
Subject: [PATCH 709/878] pptx-autoplay-fix.diff

---
 filter/source/config/cache/constant.hxx            |    2 +
 filter/source/config/cache/filtercache.cxx         |    6 +++
 filter/source/config/fragments/fcfg_impress.mk     |    4 ++
 .../filters/MS_PowerPoint_97_AutoPlay.xcu          |   13 +++++++
 .../impress_MS_PowerPoint_2007_XML_AutoPlay.xcu    |   10 ++++++
 .../types/MS_PowerPoint_2007_XML_AutoPlay.xcu      |   10 ++++++
 .../fragments/types/impress_MS_PowerPoint_97.xcu   |    2 +-
 .../types/impress_MS_PowerPoint_97_AutoPlay.xcu    |   12 +++++++
 framework/inc/filterflags.h                        |    3 ++
 framework/source/constant/filter.cxx               |    2 +
 framework/source/inc/constant/filter.hxx           |    2 +
 oox/source/core/filterdetect.cxx                   |    4 ++
 sd/inc/strmname.h                                  |    1 +
 sd/source/ui/docshell/docshel4.cxx                 |   35 +++++++++++++++++++-
 sd/source/ui/inc/DrawDocShell.hxx                  |    1 +
 sd/source/ui/slideshow/slideshow.cxx               |   25 ++++++++++++++
 sd/source/ui/slideshow/slideshowimpl.cxx           |    3 +-
 sd/source/ui/unoidl/sddetect.cxx                   |    8 +++--
 sd/source/ui/view/ViewShellBase.cxx                |    1 -
 sfx2/inc/sfx2/docfilt.hxx                          |    1 +
 sfx2/inc/sfx2/objsh.hxx                            |    2 +-
 sfx2/source/doc/objstor.cxx                        |    3 ++
 22 files changed, 142 insertions(+), 8 deletions(-)
 create mode 100644 filter/source/config/fragments/filters/MS_PowerPoint_97_AutoPlay.xcu
 create mode 100644 filter/source/config/fragments/filters/impress_MS_PowerPoint_2007_XML_AutoPlay.xcu
 create mode 100644 filter/source/config/fragments/types/MS_PowerPoint_2007_XML_AutoPlay.xcu
 create mode 100644 filter/source/config/fragments/types/impress_MS_PowerPoint_97_AutoPlay.xcu

diff --git a/filter/source/config/cache/constant.hxx b/filter/source/config/cache/constant.hxx
index 827682e..8f03158 100644
--- a/filter/source/config/cache/constant.hxx
+++ b/filter/source/config/cache/constant.hxx
@@ -130,6 +130,7 @@ extern rtl::OUString pFilterStrings[];
 #define  FLAGNAME_OWN               _FILTER_CONFIG_FROM_ASCII_("OWN"              )
 #define  FLAGNAME_PACKED            _FILTER_CONFIG_FROM_ASCII_("PACKED"           )
 #define  FLAGNAME_PREFERRED         _FILTER_CONFIG_FROM_ASCII_("PREFERRED"        )
+#define  FLAGNAME_STARTPRESENTATION _FILTER_CONFIG_FROM_ASCII_("STARTPRESENTATION")
 #define  FLAGNAME_READONLY          _FILTER_CONFIG_FROM_ASCII_("READONLY"         )
 #define  FLAGNAME_SILENTEXPORT      _FILTER_CONFIG_FROM_ASCII_("SILENTEXPORT"     )
 #define  FLAGNAME_SUPPORTSSELECTION _FILTER_CONFIG_FROM_ASCII_("SUPPORTSSELECTION")
@@ -155,6 +156,7 @@ extern rtl::OUString pFilterStrings[];
 #define  FLAGVAL_OWN               0x00000020 // 32
 #define  FLAGVAL_PACKED            0x00100000 // 1048576
 #define  FLAGVAL_PREFERRED         0x10000000 // 268435456
+#define  FLAGVAL_STARTPRESENTATION 0x20000000 // 268435456
 #define  FLAGVAL_READONLY          0x00010000 // 65536
 #define  FLAGVAL_SILENTEXPORT      0x00200000 // 2097152
 #define  FLAGVAL_SUPPORTSSELECTION 0x00000400 // 1024
diff --git a/filter/source/config/cache/filtercache.cxx b/filter/source/config/cache/filtercache.cxx
index ca9cd69..a035557 100644
--- a/filter/source/config/cache/filtercache.cxx
+++ b/filter/source/config/cache/filtercache.cxx
@@ -2204,6 +2204,7 @@ css::uno::Sequence< ::rtl::OUString > FilterCache::impl_convertFlagField2FlagNam
     if ((nFlags & FLAGVAL_OWN              ) == FLAGVAL_OWN              ) lFlagNames.push_back(FLAGNAME_OWN              );
     if ((nFlags & FLAGVAL_PACKED           ) == FLAGVAL_PACKED           ) lFlagNames.push_back(FLAGNAME_PACKED           );
     if ((nFlags & FLAGVAL_PREFERRED        ) == FLAGVAL_PREFERRED        ) lFlagNames.push_back(FLAGNAME_PREFERRED        );
+    if ((nFlags & FLAGVAL_STARTPRESENTATION) == FLAGVAL_STARTPRESENTATION) lFlagNames.push_back(FLAGNAME_STARTPRESENTATION);
     if ((nFlags & FLAGVAL_READONLY         ) == FLAGVAL_READONLY         ) lFlagNames.push_back(FLAGNAME_READONLY         );
     if ((nFlags & FLAGVAL_SILENTEXPORT     ) == FLAGVAL_SILENTEXPORT     ) lFlagNames.push_back(FLAGNAME_SILENTEXPORT     );
     if ((nFlags & FLAGVAL_SUPPORTSSELECTION) == FLAGVAL_SUPPORTSSELECTION) lFlagNames.push_back(FLAGNAME_SUPPORTSSELECTION);
@@ -2302,6 +2303,11 @@ sal_Int32 FilterCache::impl_convertFlagNames2FlagField(const css::uno::Sequence<
             nField |= FLAGVAL_PREFERRED;
             continue;
         }
+        if (pNames[i].equals(FLAGNAME_STARTPRESENTATION))
+        {
+            nField |= FLAGVAL_STARTPRESENTATION;
+            continue;
+        }
         if (pNames[i].equals(FLAGNAME_READONLY))
         {
             nField |= FLAGVAL_READONLY;
diff --git a/filter/source/config/fragments/fcfg_impress.mk b/filter/source/config/fragments/fcfg_impress.mk
index f5c1c7d..2e354c8 100644
--- a/filter/source/config/fragments/fcfg_impress.mk
+++ b/filter/source/config/fragments/fcfg_impress.mk
@@ -5,6 +5,7 @@ all_fragments+=impress
 T4_IMPRESS = \
     draw_StarOffice_XML_Draw \
     impress_MS_PowerPoint_97 \
+    impress_MS_PowerPoint_97_AutoPlay \
     impress_MS_PowerPoint_97_Vorlage \
     impress_StarOffice_XML_Impress \
     impress_StarOffice_XML_Impress_Template \
@@ -14,12 +15,14 @@ T4_IMPRESS = \
     impress8_template\
     draw8\
     MS_PowerPoint_2007_XML\
+    MS_PowerPoint_2007_XML_AutoPlay\
     MS_PowerPoint_2007_XML_Template
 
 # -----------------------------------------------
 # count = 20
 F4_IMPRESS = \
     MS_PowerPoint_97 \
+    MS_PowerPoint_97_AutoPlay \
     MS_PowerPoint_97_Vorlage \
     impress_StarOffice_XML_Draw \
     StarOffice_XML__Impress_ \
@@ -30,6 +33,7 @@ F4_IMPRESS = \
     impress8_template\
     impress8_draw\
     impress_MS_PowerPoint_2007_XML\
+    impress_MS_PowerPoint_2007_XML_AutoPlay\
     impress_MS_PowerPoint_2007_XML_Template
 
 # -----------------------------------------------
diff --git a/filter/source/config/fragments/filters/MS_PowerPoint_97_AutoPlay.xcu b/filter/source/config/fragments/filters/MS_PowerPoint_97_AutoPlay.xcu
new file mode 100644
index 0000000..c19eeb4
--- /dev/null
+++ b/filter/source/config/fragments/filters/MS_PowerPoint_97_AutoPlay.xcu
@@ -0,0 +1,13 @@
+    <node oor:name="MS PowerPoint 97 AutoPlay" oor:op="replace">
+        <prop oor:name="Flags"><value>IMPORT EXPORT ALIEN STARTPRESENTATION</value></prop>
+        <prop oor:name="UIComponent"/>
+        <prop oor:name="FilterService"/>
+        <prop oor:name="UserData"><value>sdfilt</value></prop>
+        <prop oor:name="UIName">
+            <value xml:lang="x-default">Microsoft PowerPoint 97/2000/XP</value>
+        </prop>
+        <prop oor:name="FileFormatVersion"><value>0</value></prop>
+        <prop oor:name="Type"><value>impress_MS_PowerPoint_97_AutoPlay</value></prop>
+        <prop oor:name="TemplateName"/>
+        <prop oor:name="DocumentService"><value>com.sun.star.presentation.PresentationDocument</value></prop>
+    </node>
diff --git a/filter/source/config/fragments/filters/impress_MS_PowerPoint_2007_XML_AutoPlay.xcu b/filter/source/config/fragments/filters/impress_MS_PowerPoint_2007_XML_AutoPlay.xcu
new file mode 100644
index 0000000..7a2e17f
--- /dev/null
+++ b/filter/source/config/fragments/filters/impress_MS_PowerPoint_2007_XML_AutoPlay.xcu
@@ -0,0 +1,10 @@
+<node oor:name="Impress MS PowerPoint 2007 XML AutoPlay" oor:op="replace">
+    <prop oor:name="Flags"><value>IMPORT EXPORT ALIEN 3RDPARTYFILTER PREFERRED STARTPRESENTATION</value></prop>
+    <prop oor:name="UIComponent"/>
+    <prop oor:name="FilterService"><value>com.sun.star.comp.Impress.oox.PowerPointImport</value></prop>
+    <prop oor:name="UserData"/>
+    <prop oor:name="FileFormatVersion"/>
+    <prop oor:name="Type"><value>MS PowerPoint 2007 XML AutoPlay</value></prop>
+    <prop oor:name="TemplateName"/>
+    <prop oor:name="DocumentService"><value>com.sun.star.presentation.PresentationDocument</value></prop>
+</node>
diff --git a/filter/source/config/fragments/types/MS_PowerPoint_2007_XML_AutoPlay.xcu b/filter/source/config/fragments/types/MS_PowerPoint_2007_XML_AutoPlay.xcu
new file mode 100644
index 0000000..681b7b5
--- /dev/null
+++ b/filter/source/config/fragments/types/MS_PowerPoint_2007_XML_AutoPlay.xcu
@@ -0,0 +1,10 @@
+<node oor:name="MS PowerPoint 2007 XML AutoPlay" oor:op="replace" >
+    <prop oor:name="DetectService"><value>com.sun.star.comp.oox.FormatDetector</value></prop>
+    <prop oor:name="URLPattern"/>
+    <prop oor:name="Extensions"><value>ppsx</value></prop>
+    <prop oor:name="MediaType"/>
+    <prop oor:name="Preferred"><value>true</value></prop>
+    <prop oor:name="PreferredFilter"><value>Impress MS PowerPoint 2007 XML AutoPlay</value></prop>
+    <prop oor:name="UIName"><value xml:lang="x-default">Microsoft PowerPoint 2007 XML</value></prop>
+    <prop oor:name="ClipboardFormat"/>
+</node>
diff --git a/filter/source/config/fragments/types/impress_MS_PowerPoint_97.xcu b/filter/source/config/fragments/types/impress_MS_PowerPoint_97.xcu
index 3584127..c7a17a9 100644
--- a/filter/source/config/fragments/types/impress_MS_PowerPoint_97.xcu
+++ b/filter/source/config/fragments/types/impress_MS_PowerPoint_97.xcu
@@ -1,7 +1,7 @@
     <node oor:name="impress_MS_PowerPoint_97" oor:op="replace" >
         <prop oor:name="DetectService"><value>com.sun.star.comp.draw.FormatDetector</value></prop>
         <prop oor:name="URLPattern"/>
-        <prop oor:name="Extensions"><value>ppt pps</value></prop>
+        <prop oor:name="Extensions"><value>ppt</value></prop>
         <prop oor:name="MediaType"><value>application/vnd.ms-powerpoint</value></prop>
         <prop oor:name="Preferred"><value>false</value></prop>
         <prop oor:name="PreferredFilter"><value>MS PowerPoint 97</value></prop>
diff --git a/filter/source/config/fragments/types/impress_MS_PowerPoint_97_AutoPlay.xcu b/filter/source/config/fragments/types/impress_MS_PowerPoint_97_AutoPlay.xcu
new file mode 100644
index 0000000..7cf518c
--- /dev/null
+++ b/filter/source/config/fragments/types/impress_MS_PowerPoint_97_AutoPlay.xcu
@@ -0,0 +1,12 @@
+    <node oor:name="impress_MS_PowerPoint_97_AutoPlay" oor:op="replace" >
+        <prop oor:name="DetectService"><value>com.sun.star.comp.draw.FormatDetector</value></prop>
+        <prop oor:name="URLPattern"/>
+        <prop oor:name="Extensions"><value>pps</value></prop>
+        <prop oor:name="MediaType"><value>application/vnd.ms-powerpoint</value></prop>
+        <prop oor:name="Preferred"><value>false</value></prop>
+        <prop oor:name="PreferredFilter"><value>MS PowerPoint 97 AutoPlay</value></prop>
+        <prop oor:name="UIName">
+            <value>Microsoft PowerPoint 97/2000/XP</value>
+        </prop>
+        <prop oor:name="ClipboardFormat"/>
+    </node>
diff --git a/framework/inc/filterflags.h b/framework/inc/filterflags.h
index 8893714..6a93815 100644
--- a/framework/inc/filterflags.h
+++ b/framework/inc/filterflags.h
@@ -60,6 +60,7 @@ namespace framework{
 #define FILTERFLAGNAME_SILENTEXPORT                         DECLARE_ASCII("SilentExport"     )  // x
 #define FILTERFLAGNAME_BROWSERPREFERED                      DECLARE_ASCII("BrowserPrefered"  )  // deprecated
 #define FILTERFLAGNAME_PREFERED                             DECLARE_ASCII("Prefered"         )  // x
+#define FILTERFLAGNAME_STARTPRESENTATION                    DECLARE_ASCII("StartPresentation")  // x
 
 #define	FILTERFLAG_IMPORT									0x00000001L		// 1
 #define	FILTERFLAG_EXPORT									0x00000002L		// 2
@@ -86,6 +87,7 @@ namespace framework{
 #define	FILTERFLAG_BROWSERPREFERED							0x00400000L		// 4194304
 //FREE! ... 0x00800000L
 #define	FILTERFLAG_PREFERED									0x10000000L		// 268435456
+#define FILTERFLAG_STARTPRESENTATION                        0x20000000L
 
 class FlagCheck
 {
@@ -143,6 +145,7 @@ class FlagCheck
         nCheck &= ~FILTERFLAG_SILENTEXPORT;
         nCheck &= ~FILTERFLAG_BROWSERPREFERED;
         nCheck &= ~FILTERFLAG_PREFERED;
+        nCheck &= ~FILTERFLAG_STARTPRESENTATION;
         return(nCheck == 0);
     }
 
diff --git a/framework/source/constant/filter.cxx b/framework/source/constant/filter.cxx
index 57d94d7..e3ba4b1 100644
--- a/framework/source/constant/filter.cxx
+++ b/framework/source/constant/filter.cxx
@@ -89,6 +89,7 @@ const ::rtl::OUString Filter::FLAGNAME_PACKED                            = ::rtl
 const ::rtl::OUString Filter::FLAGNAME_SILENTEXPORT                      = ::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("SilentExport"     ));
 const ::rtl::OUString Filter::FLAGNAME_BROWSERPREFERED                   = ::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("BrowserPrefered"  ));
 const ::rtl::OUString Filter::FLAGNAME_PREFERED                          = ::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("Prefered"         ));
+const ::rtl::OUString Filter::FLAGNAME_STARTPRESENTATION                 = ::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("StartPresentation"));
 
 const sal_Int32 Filter::FLAGVALUE_IMPORT                                 = 0x00000001L;     // 1
 const sal_Int32 Filter::FLAGVALUE_EXPORT                                 = 0x00000002L;     // 2
@@ -114,6 +115,7 @@ const sal_Int32 Filter::FLAGVALUE_PACKED                                 = 0x001
 const sal_Int32 Filter::FLAGVALUE_SILENTEXPORT                           = 0x00200000L;     // 2097152
 const sal_Int32 Filter::FLAGVALUE_BROWSERPREFERED                        = 0x00400000L;     // 4194304
 const sal_Int32 Filter::FLAGVALUE_PREFERED                               = 0x10000000L;     // 268435456
+const sal_Int32 Filter::FLAGVALUE_STARTPRESENTATION                      = 0x20000000L;
 
     } // namespace constant
 } // namespace framework
diff --git a/framework/source/inc/constant/filter.hxx b/framework/source/inc/constant/filter.hxx
index 141440a..430f782 100644
--- a/framework/source/inc/constant/filter.hxx
+++ b/framework/source/inc/constant/filter.hxx
@@ -91,6 +91,7 @@ struct Filter
         static const ::rtl::OUString FLAGNAME_SILENTEXPORT;
         static const ::rtl::OUString FLAGNAME_BROWSERPREFERED;
         static const ::rtl::OUString FLAGNAME_PREFERED;
+        static const ::rtl::OUString FLAGNAME_STARTPRESENTATION;
 
         static const sal_Int32       FLAGVALUE_IMPORT;
         static const sal_Int32       FLAGVALUE_EXPORT;
@@ -117,6 +118,7 @@ struct Filter
         static const sal_Int32       FLAGVALUE_BROWSERPREFERED;
         //FREE! ... 0x00800000L
         static const sal_Int32       FLAGVALUE_PREFERED;
+        static const sal_Int32       FLAGVALUE_STARTPRESENTATION;
 
 };
 
diff --git a/oox/source/core/filterdetect.cxx b/oox/source/core/filterdetect.cxx
index 3997d0b..428e1a6 100644
--- a/oox/source/core/filterdetect.cxx
+++ b/oox/source/core/filterdetect.cxx
@@ -203,6 +203,10 @@ OUString FilterDetectDocHandler::getFilterNameFromContentType( const OUString& r
         rContentType.equalsAscii( "application/vnd.ms-powerpoint.presentation.macroEnabled.main+xml" ) )
         return CREATE_OUSTRING( "MS PowerPoint 2007 XML" );
 
+    if( rContentType.equalsAscii( "application/vnd.openxmlformats-officedocument.presentationml.slideshow.main+xml" ) ||
+        rContentType.equalsAscii( "application/vnd.ms-powerpoint.slideshow.macroEnabled.main+xml" ) )
+        return CREATE_OUSTRING( "MS PowerPoint 2007 XML AutoPlay" );
+
     if( rContentType.equalsAscii( "application/vnd.openxmlformats-officedocument.presentationml.template.main+xml" ) ||
         rContentType.equalsAscii( "application/vnd.ms-powerpoint.template.macroEnabled.main+xml" ) )
         return CREATE_OUSTRING( "MS PowerPoint 2007 XML Template" );
diff --git a/sd/inc/strmname.h b/sd/inc/strmname.h
index 0d4823a..ebddf8e 100644
--- a/sd/inc/strmname.h
+++ b/sd/inc/strmname.h
@@ -42,6 +42,7 @@ static const String pPreviewName( RTL_CONSTASCII_USTRINGPARAM( "StarDrawTemplate
 // PowerPoint-Filter
 static const String pFilterPowerPoint97( RTL_CONSTASCII_USTRINGPARAM( "MS PowerPoint 97" ));
 static const String pFilterPowerPoint97Template( RTL_CONSTASCII_USTRINGPARAM( "MS PowerPoint 97 Vorlage" ));
+static const String pFilterPowerPoint97AutoPlay( RTL_CONSTASCII_USTRINGPARAM( "MS PowerPoint 97 AutoPlay" ));
 
 // XML content stream
 static const String pStarDrawXMLContent( RTL_CONSTASCII_USTRINGPARAM( "content.xml" ));
diff --git a/sd/source/ui/docshell/docshel4.cxx b/sd/source/ui/docshell/docshel4.cxx
index e8f73e7..a1f0147 100644
--- a/sd/source/ui/docshell/docshel4.cxx
+++ b/sd/source/ui/docshell/docshel4.cxx
@@ -466,6 +466,37 @@ BOOL DrawDocShell::LoadFrom( SfxMedium& rMedium )
 
 /*************************************************************************
 |*
+|* ImportFrom: load from 3rd party format
+|*
+\************************************************************************/
+
+sal_Bool DrawDocShell::ImportFrom( SfxMedium &rMedium )
+{
+    const sal_Bool bRet=SfxObjectShell::ImportFrom(rMedium);
+
+    SfxItemSet* pSet = rMedium.GetItemSet();
+    if( pSet )
+    {
+        if( SFX_ITEM_SET == pSet->GetItemState(SID_DOC_STARTPRESENTATION)&&
+            ( (SfxBoolItem&) ( pSet->Get( SID_DOC_STARTPRESENTATION ) ) ).GetValue() )
+        {
+            mpDoc->SetStartWithPresentation( true );
+
+            // tell SFX to change viewshell when in preview mode
+            if( IsPreview() )
+            {
+                SfxItemSet *pMediumSet = GetMedium()->GetItemSet();
+                if( pMediumSet )
+                    pMediumSet->Put( SfxUInt16Item( SID_VIEW_ID, 1 ) );
+            }
+        }
+    }
+
+    return bRet;
+}
+
+/*************************************************************************
+|*
 |* ConvertFrom: aus Fremdformat laden
 |*
 \************************************************************************/
@@ -496,7 +527,9 @@ BOOL DrawDocShell::ConvertFrom( SfxMedium& rMedium )
         }
     }
 
-    if( aFilterName == pFilterPowerPoint97 || aFilterName == pFilterPowerPoint97Template)
+    if( aFilterName == pFilterPowerPoint97
+        || aFilterName == pFilterPowerPoint97Template
+        || aFilterName == pFilterPowerPoint97AutoPlay)
     {
         mpDoc->StopWorkStartupDelay();
         bRet = SdPPTFilter( rMedium, *this, sal_True ).Import();
diff --git a/sd/source/ui/inc/DrawDocShell.hxx b/sd/source/ui/inc/DrawDocShell.hxx
index 1c869ce..28d3108 100644
--- a/sd/source/ui/inc/DrawDocShell.hxx
+++ b/sd/source/ui/inc/DrawDocShell.hxx
@@ -85,6 +85,7 @@ public:
     virtual void	        Activate( BOOL bMDI );
     virtual void	        Deactivate( BOOL bMDI );
     virtual BOOL            InitNew( const ::com::sun::star::uno::Reference< ::com::sun::star::embed::XStorage >& xStorage );
+    virtual sal_Bool        ImportFrom( SfxMedium &rMedium );
     virtual BOOL	        ConvertFrom( SfxMedium &rMedium );
     virtual BOOL	        Save();
     virtual BOOL            SaveAsOwnFormat( SfxMedium& rMedium );
diff --git a/sd/source/ui/slideshow/slideshow.cxx b/sd/source/ui/slideshow/slideshow.cxx
index 5a0270c..8431d3f 100644
--- a/sd/source/ui/slideshow/slideshow.cxx
+++ b/sd/source/ui/slideshow/slideshow.cxx
@@ -32,6 +32,8 @@
 #include <com/sun/star/beans/PropertyAttribute.hpp>
 #include <com/sun/star/drawing/framework/XControllerManager.hpp>
 #include <com/sun/star/container/XIndexAccess.hpp>
+#include <com/sun/star/frame/XDispatchProvider.hpp>
+#include <com/sun/star/util/URL.hpp>
 
 #include <cppuhelper/bootstrap.hxx>
 
@@ -69,6 +71,7 @@ using ::com::sun::star::awt::XWindow;
 using namespace ::sd;
 using namespace ::cppu;
 using namespace ::vos;
+using namespace ::com::sun::star;
 using namespace ::com::sun::star::uno;
 using namespace ::com::sun::star::presentation;
 using namespace ::com::sun::star::drawing;
@@ -775,6 +778,28 @@ void SAL_CALL SlideShow::end() throw(RuntimeException)
                     if( pDrawViewShell )
                         pDrawViewShell->SwitchPage( (USHORT)xController->getRestoreSlide() );
                 }
+
+                if( pViewShell->GetDoc()->IsStartWithPresentation() )
+                {
+                    pViewShell->GetDoc()->SetStartWithPresentation( false );
+
+                    Reference<frame::XDispatchProvider> xProvider(pViewShell->GetViewShellBase().GetController()->getFrame(),
+                                                                  UNO_QUERY);
+                    if( xProvider.is() )
+                    {
+                        util::URL aURL;
+                        aURL.Complete = ::rtl::OUString::createFromAscii(".uno:CloseFrame");
+
+                        uno::Reference< frame::XDispatch > xDispatch(
+                            xProvider->queryDispatch(
+                                aURL, ::rtl::OUString(), 0));
+                        if( xDispatch.is() )
+                        {
+                            xDispatch->dispatch(aURL,
+                                                uno::Sequence< beans::PropertyValue >());
+                        }
+                    }
+                }
             }
         }
         mpCurrentViewShellBase = 0;
diff --git a/sd/source/ui/slideshow/slideshowimpl.cxx b/sd/source/ui/slideshow/slideshowimpl.cxx
index da307c1..261d500 100644
--- a/sd/source/ui/slideshow/slideshowimpl.cxx
+++ b/sd/source/ui/slideshow/slideshowimpl.cxx
@@ -3236,7 +3236,8 @@ void SAL_CALL SlideshowImpl::gotoNextSlide(  ) throw (RuntimeException)
                     if( mpShowWindow )
                     {
                         mpShowWindow->SetEndMode();
-                        pause();
+                        if( !mpViewShell->GetDoc()->IsStartWithPresentation() )
+                            pause();
                     }
                 }
             }
diff --git a/sd/source/ui/unoidl/sddetect.cxx b/sd/source/ui/unoidl/sddetect.cxx
index f2c7d3a..d02504a 100644
--- a/sd/source/ui/unoidl/sddetect.cxx
+++ b/sd/source/ui/unoidl/sddetect.cxx
@@ -362,10 +362,12 @@ SdFilterDetect::~SdFilterDetect()
                                 String aFileName(aMedium.GetName());
                                 aFileName.ToUpperAscii();
 
-                                if( aFileName.SearchAscii( ".POT" ) == STRING_NOTFOUND )
-                                    pFilter = SfxFilter::GetFilterByName( pFilterPowerPoint97);
-                                else
+                                if( aFileName.SearchAscii( ".POT" ) != STRING_NOTFOUND )
                                     pFilter = SfxFilter::GetFilterByName( pFilterPowerPoint97Template );
+                                else if( aFileName.SearchAscii( ".PPS" ) != STRING_NOTFOUND )
+                                    pFilter = SfxFilter::GetFilterByName( pFilterPowerPoint97AutoPlay );
+                                else
+                                    pFilter = SfxFilter::GetFilterByName( pFilterPowerPoint97);
                             }
                         }
                         else
diff --git a/sd/source/ui/view/ViewShellBase.cxx b/sd/source/ui/view/ViewShellBase.cxx
index 8b9a7c8..e177cb3 100644
--- a/sd/source/ui/view/ViewShellBase.cxx
+++ b/sd/source/ui/view/ViewShellBase.cxx
@@ -489,7 +489,6 @@ void ViewShellBase::Notify(SfxBroadcaster& rBC, const SfxHint& rHint)
                 {
                     if( GetViewFrame() )
                     {
-                        GetDocument()->SetStartWithPresentation( false );
                         GetViewFrame()->GetDispatcher()->Execute(
                             SID_PRESENTATION, SFX_CALLMODE_ASYNCHRON );
                     }
diff --git a/sfx2/inc/sfx2/docfilt.hxx b/sfx2/inc/sfx2/docfilt.hxx
index 653ad1c..9ad036c 100644
--- a/sfx2/inc/sfx2/docfilt.hxx
+++ b/sfx2/inc/sfx2/docfilt.hxx
@@ -65,6 +65,7 @@
 
 #define SFX_FILTER_BROWSERPREFERED   0x00400000L
 #define SFX_FILTER_PREFERED          0x10000000L
+#define SFX_FILTER_STARTPRESENTATION 0x20000000L
 
 #define SFX_FILTER_VERSION_NONE      0
 #define SFX_FILTER_NOTINSTALLED		 SFX_FILTER_MUSTINSTALL | SFX_FILTER_CONSULTSERVICE
diff --git a/sfx2/inc/sfx2/objsh.hxx b/sfx2/inc/sfx2/objsh.hxx
index 922bbc1..c4c2cb2 100644
--- a/sfx2/inc/sfx2/objsh.hxx
+++ b/sfx2/inc/sfx2/objsh.hxx
@@ -360,7 +360,7 @@ public:
     sal_Bool                    SaveCompletedChildren( sal_Bool bSuccess );
 
     sal_Bool                    InsertFrom( SfxMedium &rMedium );
-    sal_Bool                    ImportFrom( SfxMedium &rMedium );
+    virtual sal_Bool            ImportFrom( SfxMedium &rMedium );
     sal_Bool                    ExportTo( SfxMedium &rMedium );
 
     // xmlsec05, check with SFX team
diff --git a/sfx2/source/doc/objstor.cxx b/sfx2/source/doc/objstor.cxx
index 38f9836..80a03e2 100644
--- a/sfx2/source/doc/objstor.cxx
+++ b/sfx2/source/doc/objstor.cxx
@@ -760,6 +760,9 @@ sal_Bool SfxObjectShell::DoLoad( SfxMedium *pMed )
         sal_uInt32 nError = HandleFilter( pMedium, this );
         if ( nError != ERRCODE_NONE )
             SetError( nError, ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( OSL_LOG_PREFIX ) ) );
+
+        if (pMedium->GetFilter()->GetFilterFlags() & SFX_FILTER_STARTPRESENTATION)
+            pSet->Put( SfxBoolItem( SID_DOC_STARTPRESENTATION, TRUE) );
     }
 
     EnableSetModified( sal_False );
-- 
1.7.0.1

