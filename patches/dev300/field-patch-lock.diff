From f67bae6b539747bb0ed94b4dda14482910984731 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:04:29 +0200
Subject: [PATCH 624/878] field-patch-lock.diff

---
 sw/source/core/crsr/pam.cxx |   36 +++++++++++++++++++++---------------
 1 files changed, 21 insertions(+), 15 deletions(-)

diff --git a/sw/source/core/crsr/pam.cxx b/sw/source/core/crsr/pam.cxx
index 5212c12..1e2dbe9 100644
--- a/sw/source/core/crsr/pam.cxx
+++ b/sw/source/core/crsr/pam.cxx
@@ -825,21 +825,27 @@ BOOL SwPaM::HasReadonlySel( bool bFormView ) const
     }
     //FIXME FieldBk
     // TODO: Form Protection when Enhanced Fields are enabled
-	if (!bRet) {
-	    const SwDoc *pDoc = GetDoc();
-        sw::mark::IMark* pA = NULL;
-        sw::mark::IMark* pB = NULL;
-        if ( pDoc )
-        {
-            const IDocumentMarkAccess* pMarksAccess = pDoc->getIDocumentMarkAccess( );
-	        pA = GetPoint() ? pMarksAccess->getFieldmarkFor( *GetPoint( ) ) : NULL;
-	        pB = GetMark( ) ? pMarksAccess->getFieldmarkFor( *GetMark( ) ) : pA;
-	    bRet = ( pA != pB );
-        }
-	    bool bProtectForm = pDoc->get( IDocumentSettingAccess::PROTECT_FORM );
-	    if ( bProtectForm )
-		bRet |= ( pA == NULL || pB == NULL );
-	}
+    const SwDoc *pDoc = GetDoc();
+    sw::mark::IMark* pA = NULL;
+    sw::mark::IMark* pB = NULL;
+    if ( pDoc )
+    {
+        const IDocumentMarkAccess* pMarksAccess = pDoc->getIDocumentMarkAccess( );
+        pA = GetPoint() ? pMarksAccess->getFieldmarkFor( *GetPoint( ) ) : NULL;
+        pB = GetMark( ) ? pMarksAccess->getFieldmarkFor( *GetMark( ) ) : pA;
+    }
+
+    if (!bRet)
+    {
+        bRet = ( pA != pB );
+        bool bProtectForm = pDoc->get( IDocumentSettingAccess::PROTECT_FORM );
+        if ( bProtectForm )
+            bRet |= ( pA == NULL || pB == NULL );
+    }
+    else
+    {
+        bRet = !( pA == pB && pA != NULL );
+    }
     return bRet;
 }
 
-- 
1.7.0.1

