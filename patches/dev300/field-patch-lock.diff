Fixes for field-patch document locking

From: CÃ©dric Bosdonnat <cedricbosdo@openoffice.org>


---

 sw/source/core/crsr/pam.cxx |   36 +++++++++++++++++++++---------------
 1 files changed, 21 insertions(+), 15 deletions(-)


diff --git sw/source/core/crsr/pam.cxx sw/source/core/crsr/pam.cxx
index 85a55a8..2e6e709 100644
--- sw/source/core/crsr/pam.cxx
+++ sw/source/core/crsr/pam.cxx
@@ -825,21 +825,27 @@ BOOL SwPaM::HasReadonlySel( bool bFormView ) const
     }
     //FIXME FieldBk
     // TODO: Form Protection when Enhanced Fields are enabled
- 	if (!bRet) {
- 	    const SwDoc *pDoc = GetDoc();
-        sw::mark::IMark* pA = NULL;
-        sw::mark::IMark* pB = NULL;
-        if ( pDoc )
-        {
-            const IDocumentMarkAccess* pMarksAccess = pDoc->getIDocumentMarkAccess( );
- 	        pA = GetPoint() ? pMarksAccess->getFieldmarkFor( *GetPoint( ) ) : NULL;
- 	        pB = GetMark( ) ? pMarksAccess->getFieldmarkFor( *GetMark( ) ) : pA;
-     	    bRet = ( pA != pB );
-        }
- 	    bool bProtectForm = pDoc->get( IDocumentSettingAccess::PROTECT_FORM );
- 	    if ( bProtectForm )
-     		bRet |= ( pA == NULL || pB == NULL );
- 	}
+    const SwDoc *pDoc = GetDoc();
+    sw::mark::IMark* pA = NULL;
+    sw::mark::IMark* pB = NULL;
+    if ( pDoc )
+    {
+        const IDocumentMarkAccess* pMarksAccess = pDoc->getIDocumentMarkAccess( );
+        pA = GetPoint() ? pMarksAccess->getFieldmarkFor( *GetPoint( ) ) : NULL;
+        pB = GetMark( ) ? pMarksAccess->getFieldmarkFor( *GetMark( ) ) : pA;
+    }
+    
+    if (!bRet)
+    {
+        bRet = ( pA != pB );
+        bool bProtectForm = pDoc->get( IDocumentSettingAccess::PROTECT_FORM );
+        if ( bProtectForm )
+            bRet |= ( pA == NULL || pB == NULL );
+    }
+    else
+    {
+        bRet = !( pA == pB && pA != NULL );
+    }
     return bRet;
 }
 
