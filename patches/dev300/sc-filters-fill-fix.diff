From 1337856ebb90beb02877482d44211e69f7cbea16 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:55:13 +0200
Subject: [PATCH 146/878] sc-filters-fill-fix.diff

---
 sc/inc/document.hxx            |   12 ++++++++++++
 sc/source/core/data/table4.cxx |    4 ++++
 2 files changed, 16 insertions(+), 0 deletions(-)

diff --git a/sc/inc/document.hxx b/sc/inc/document.hxx
index d7d5493..d7437e7 100644
--- a/sc/inc/document.hxx
+++ b/sc/inc/document.hxx
@@ -420,6 +420,8 @@ public:
     ULONG			GetWeightedCount() const;	// Formeln und Edit staerker gewichtet
     ULONG			GetCodeCount() const;		// RPN-Code in Formeln
     DECL_LINK( GetUserDefinedColor, USHORT * );
+    BOOL        RowFiltered( SCROW nRow, SCTAB nTab ) const;    // FillInfo
+    BOOL        ColFiltered( SCCOL nCol, SCTAB nTab ) const;    // FillInfo
                                                                 // Numberformatter
 
 public:
@@ -1819,6 +1821,16 @@ inline USHORT ScDocument::FastGetOriginalRowHeight( SCROW nRow, SCTAB nTab ) con
     return pTab[nTab]->pRowHeight->GetValue(nRow);
 }
 
+inline BOOL ScDocument::ColFiltered( SCCOL nCol, SCTAB nTab ) const
+{
+    return ( pTab[nTab]->pColFlags[nCol] & CR_FILTERED) != 0;
+}
+
+inline BOOL ScDocument::RowFiltered( SCROW nRow, SCTAB nTab ) const
+{
+    return pTab[nTab]->IsFiltered(nRow);
+}
+
 #endif
 
 
diff --git a/sc/source/core/data/table4.cxx b/sc/source/core/data/table4.cxx
index c85b4ec..057a7a8 100644
--- a/sc/source/core/data/table4.cxx
+++ b/sc/source/core/data/table4.cxx
@@ -1345,6 +1345,8 @@ void ScTable::FillSeries( SCCOL nCol1, SCROW nRow1, SCCOL nCol2, SCROW nRow2,
                 {
                     for (rInner = nIMin; rInner <= nIMax; rInner++)
                     {
+                        if (pDocument->RowFiltered( rInner, nTab))
+                            continue;
                         ULONG nInd = nActFormCnt;
                         FillFormula(nInd, bFirst, (ScFormulaCell*)pSrcCell,
                             static_cast<SCCOL>(nCol), nRow, (rInner == nIEnd) );
@@ -1356,6 +1358,8 @@ void ScTable::FillSeries( SCCOL nCol1, SCROW nRow1, SCCOL nCol2, SCROW nRow2,
                 {
                     for (rInner = nIMin; rInner <= nIMax; rInner++)
                     {
+                        if (pDocument->RowFiltered( rInner, nTab))
+                            continue;
                         ScAddress aDestPos( static_cast<SCCOL>(nCol), static_cast<SCROW>(nRow), nTab );
                         aCol[nCol].Insert( aDestPos.Row(), pSrcCell->CloneWithoutNote( *pDocument ) );
                     }
-- 
1.7.0.1

