From 2c8c5468fd35b94923e1b84613cf13362d5b0074 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:55:13 +0200
Subject: [PATCH 122/768] sc-filters-fill-fix.diff

---
 sc/inc/document.hxx            |   12 ++++++++++++
 sc/source/core/data/table4.cxx |    4 ++++
 2 files changed, 16 insertions(+), 0 deletions(-)

diff --git sc/inc/document.hxx sc/inc/document.hxx
index 2fcde19..d796790 100644
--- sc/inc/document.hxx
+++ sc/inc/document.hxx
@@ -436,6 +436,8 @@ public:
     ULONG			GetWeightedCount() const;	// Formeln und Edit staerker gewichtet
     ULONG			GetCodeCount() const;		// RPN-Code in Formeln
     DECL_LINK( GetUserDefinedColor, USHORT * );
+    BOOL        RowFiltered( SCROW nRow, SCTAB nTab ) const;    // FillInfo
+    BOOL        ColFiltered( SCCOL nCol, SCTAB nTab ) const;    // FillInfo
                                                                 // Numberformatter
 
 public:
@@ -1857,6 +1859,16 @@ inline USHORT ScDocument::FastGetOriginalRowHeight( SCROW nRow, SCTAB nTab ) con
     return pTab[nTab]->pRowHeight->GetValue(nRow);
 }
 
+inline BOOL ScDocument::ColFiltered( SCCOL nCol, SCTAB nTab ) const
+{
+    return ( pTab[nTab]->pColFlags[nCol] & CR_FILTERED) != 0;
+}
+
+inline BOOL ScDocument::RowFiltered( SCROW nRow, SCTAB nTab ) const
+{
+    return pTab[nTab]->IsFiltered(nRow);
+}
+
 #endif
 
 
diff --git sc/source/core/data/table4.cxx sc/source/core/data/table4.cxx
index 7493241..f8ee2ca 100644
--- sc/source/core/data/table4.cxx
+++ sc/source/core/data/table4.cxx
@@ -1345,6 +1345,8 @@ void ScTable::FillSeries( SCCOL nCol1, SCROW nRow1, SCCOL nCol2, SCROW nRow2,
                 {
                     for (rInner = nIMin; rInner <= nIMax; rInner++)
                     {
+                        if (pDocument->RowFiltered( rInner, nTab))
+                            continue;
                         ULONG nInd = nActFormCnt;
                         FillFormula(nInd, bFirst, (ScFormulaCell*)pSrcCell,
                             static_cast<SCCOL>(nCol), nRow, (rInner == nIEnd) );
@@ -1356,6 +1358,8 @@ void ScTable::FillSeries( SCCOL nCol1, SCROW nRow1, SCCOL nCol2, SCROW nRow2,
                 {
                     for (rInner = nIMin; rInner <= nIMax; rInner++)
                     {
+                        if (pDocument->RowFiltered( rInner, nTab))
+                            continue;
                         ScAddress aDestPos( static_cast<SCCOL>(nCol), static_cast<SCROW>(nRow), nTab );
                         aCol[nCol].Insert( aDestPos.Row(), pSrcCell->CloneWithoutNote( *pDocument ) );
                     }
-- 
1.7.0.1

