From 9f4958f49766c13d61ef02936e5bf5731da4190d Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:05:40 +0200
Subject: [PATCH 600/768] docx-export-enable.diff

---
 .../config/fragments/filters/MS_Word_2007_XML.xcu  |    2 +-
 oox/inc/oox/vml/vmldrawing.hxx                     |    3 +-
 oox/prj/build.lst                                  |    5 ++-
 oox/prj/d.lst                                      |    4 +++
 oox/source/export/drawingml.cxx                    |   16 ++++++-----
 oox/util/makefile.mk                               |   11 ++++++-
 scp2/source/ooo/file_library_ooo.scp               |    2 +-
 sw/source/filter/ww8/docxexport.cxx                |   29 +++++++++++++------
 sw/source/filter/ww8/docxexport.hxx                |    5 ++-
 sw/source/filter/ww8/docxexportfilter.cxx          |    2 +-
 sw/source/filter/ww8/docxexportfilter.hxx          |    4 +-
 sw/source/filter/ww8/makefile.mk                   |    4 +++
 sw/source/filter/ww8/wrtw8sty.cxx                  |    4 ---
 sw/source/filter/ww8/wrtww8.hxx                    |    4 ---
 sw/util/makefile.mk                                |    2 +
 sw/util/msword.map                                 |    5 +++
 16 files changed, 66 insertions(+), 36 deletions(-)

diff --git filter/source/config/fragments/filters/MS_Word_2007_XML.xcu filter/source/config/fragments/filters/MS_Word_2007_XML.xcu
index d8a3740..c8c9f00 100644
--- filter/source/config/fragments/filters/MS_Word_2007_XML.xcu
+++ filter/source/config/fragments/filters/MS_Word_2007_XML.xcu
@@ -1,5 +1,5 @@
     <node oor:name="MS Word 2007 XML" oor:op="replace">
-        <prop oor:name="Flags"><value>IMPORT ALIEN 3RDPARTYFILTER</value></prop>
+        <prop oor:name="Flags"><value>IMPORT EXPORT ALIEN 3RDPARTYFILTER</value></prop>
         <prop oor:name="UIComponent"/>
         <prop oor:name="FilterService"><value>com.sun.star.comp.Writer.WriterFilter</value></prop>
         <prop oor:name="UserData"><value>OXML</value></prop>
diff --git oox/inc/oox/vml/vmldrawing.hxx oox/inc/oox/vml/vmldrawing.hxx
index ae78df5..73c5800 100644
--- oox/inc/oox/vml/vmldrawing.hxx
+++ oox/inc/oox/vml/vmldrawing.hxx
@@ -30,7 +30,8 @@
 
 #include <map>
 #include <memory>
-#include "oox/ole/oleobjecthelper.hxx"
+
+#include <oox/ole/oleobjecthelper.hxx>
 
 namespace com { namespace sun { namespace star {
     namespace awt { struct Rectangle; }
diff --git oox/prj/build.lst oox/prj/build.lst
index d0e446f..89bf77d 100644
--- oox/prj/build.lst
+++ oox/prj/build.lst
@@ -1,4 +1,4 @@
-oox	oox : vos cppu cppuhelper comphelper sal offapi sax basegfx tools vcl unotools BOOST:boost OPENSSL:openssl NULL
+oox	oox : vos cppu cppuhelper comphelper sal offapi sax basegfx svx tools vcl unotools BOOST:boost OPENSSL:openssl NULL
 oox	oox				usr1	-   all	oox_mkout NULL
 oox	oox\prj				get	-   all	oox_prj NULL
 oox	oox\source\token		nmake	-   all	oox_token NULL
@@ -15,4 +15,5 @@ oox	oox\source\vml			nmake	-   all	oox_vml oox_token NULL
 oox	oox\source\xls			nmake	-   all	oox_xls oox_token NULL
 oox	oox\source\dump			nmake	-   all	oox_dump oox_token NULL
 oox	oox\source\shape		nmake   -   all oox_shape oox_token NULL
-oox	oox\util			nmake   -   all oox_util oox_token oox_helper oox_core oox_ole oox_vml oox_drawingml oox_diagram oox_chart oox_table oox_ppt oox_xls oox_dump oox_shape oox_docprop NULL
+oox	oox\source\export		nmake   -   all oox_export oox_token NULL
+oox	oox\util			nmake   -   all oox_util oox_token oox_helper oox_core oox_ole oox_vml oox_drawingml oox_diagram oox_chart oox_table oox_ppt oox_xls oox_dump oox_export oox_shape oox_docprop NULL
diff --git oox/prj/d.lst oox/prj/d.lst
index 2c9d8d5..04a526d 100644
--- oox/prj/d.lst
+++ oox/prj/d.lst
@@ -4,6 +4,8 @@ mkdir: %_DEST%\inc%_EXT%\oox\core
 mkdir: %_DEST%\inc%_EXT%\oox\drawingml
 mkdir: %_DEST%\inc%_EXT%\oox\drawingml\chart
 mkdir: %_DEST%\inc%_EXT%\oox\drawingml\table
+mkdir: %_DEST%\inc%_EXT%\oox\export
+mkdir: %_DEST%\inc%_EXT%\oox\ole
 mkdir: %_DEST%\inc%_EXT%\oox\vml
 
 ..\%__SRC%\misc\*.map %_DEST%\bin%_EXT%\*.map
@@ -30,8 +32,10 @@ mkdir: %_DEST%\inc%_EXT%\oox\vml
 ..\inc\oox\core\xmlfilterbase.hxx %_DEST%\inc%_EXT%\oox\core\xmlfilterbase.hxx
 ..\inc\oox\drawingml\chart\chartconverter.hxx %_DEST%\inc%_EXT%\oox\drawingml\chart\chartconverter.hxx
 ..\inc\oox\drawingml\table\tablestylelist.hxx %_DEST%\inc%_EXT%\oox\drawingml\table\tablestylelist.hxx
+..\inc\oox\ole\oleobjecthelper.hxx %_DEST%\inc%_EXT%\oox\ole\oleobjecthelper.hxx
 ..\inc\oox\vml\vmldrawing.hxx %_DEST%\inc%_EXT%\oox\vml\vmldrawing.hxx
 ..\inc\oox\vml\vmlshape.hxx %_DEST%\inc%_EXT%\oox\vml\vmlshape.hxx
+..\inc\oox\export\*.hxx %_DEST%\inc%_EXT%\oox\export\*.hxx
 
 dos: sh -c "if test %OS% = MACOSX; then create-bundle %_DEST%\lib%_EXT%\*.dylib; fi"
 
diff --git oox/source/export/drawingml.cxx oox/source/export/drawingml.cxx
index 399608e..8789b80 100644
--- oox/source/export/drawingml.cxx
+++ oox/source/export/drawingml.cxx
@@ -40,6 +40,7 @@
 #include <com/sun/star/beans/XPropertySet.hpp>
 #include <com/sun/star/beans/XPropertyState.hpp>
 #include <com/sun/star/container/XEnumerationAccess.hpp>
+#include <com/sun/star/container/XIndexAccess.hpp>
 #include <com/sun/star/drawing/BitmapMode.hpp>
 #include <com/sun/star/drawing/EnhancedCustomShapeAdjustmentValue.hpp>
 #include <com/sun/star/drawing/LineDash.hpp>
@@ -47,6 +48,7 @@
 #include <com/sun/star/drawing/LineStyle.hpp>
 #include <com/sun/star/drawing/TextHorizontalAdjust.hpp>
 #include <com/sun/star/drawing/TextVerticalAdjust.hpp>
+#include <com/sun/star/drawing/XShape.hpp>
 #include <com/sun/star/i18n/ScriptType.hpp>
 #include <com/sun/star/io/XOutputStream.hpp>
 #include <com/sun/star/style/ParagraphAdjust.hpp>
@@ -484,13 +486,13 @@ OUString DrawingML::WriteImage( const Graphic& rGraphic )
         case DOCUMENT_XLSX: pComponent = "xl"; break;
     }
 
-    Reference< XOutputStream > xOutStream = mpFB->openOutputStream( OUStringBuffer()
-                                                                    .appendAscii( pComponent )
-                                                                    .appendAscii( "/media/image" )
-                                                                    .append( (sal_Int32) mnImageCounter )
-                                                                    .appendAscii( sExtension )
-                                                                    .makeStringAndClear(),
-                                                                    sMediaType );
+    Reference< XOutputStream > xOutStream = mpFB->openFragmentStream( OUStringBuffer()
+                                                                      .appendAscii( pComponent )
+                                                                      .appendAscii( "/media/image" )
+                                                                      .append( (sal_Int32) mnImageCounter )
+                                                                      .appendAscii( sExtension )
+                                                                      .makeStringAndClear(),
+                                                                      sMediaType );
     xOutStream->writeBytes( Sequence< sal_Int8 >( (const sal_Int8*) aData, nDataSize ) );
     xOutStream->closeOutput();
 
diff --git oox/util/makefile.mk oox/util/makefile.mk
index 3d3aba1..33c53d1 100644
--- oox/util/makefile.mk
+++ oox/util/makefile.mk
@@ -53,7 +53,8 @@ LIB1FILES=	\
     $(SLB)$/table.lib\
     $(SLB)$/shape.lib\
     $(SLB)$/dump.lib\
-    $(SLB)$/docprop.lib
+    $(SLB)$/docprop.lib\
+    $(SLB)$/export.lib
 
 # --- Shared-Library -----------------------------------------------
 
@@ -68,7 +69,13 @@ SHL1STDLIBS= \
         $(RTLLIB)		\
         $(SALLIB)		\
         $(BASEGFXLIB)	\
-        $(SAXLIB)
+        $(SAXLIB)		\
+        $(VCLLIB)		\
+        $(GOODIESLIB)		\
+        $(SVTOOLLIB)		\
+        $(SVXCORELIB)		\
+        $(SVXMSFILTERLIB)	\
+        $(TOOLSLIB)
 
 # link openssl, copied this bit from ucb/source/ucp/webdav/makefile.mk
 .IF "$(GUI)"=="WNT"
diff --git scp2/source/ooo/file_library_ooo.scp scp2/source/ooo/file_library_ooo.scp
index 1b3bdb1..5bce9a8 100644
--- scp2/source/ooo/file_library_ooo.scp
+++ scp2/source/ooo/file_library_ooo.scp
@@ -1446,7 +1446,7 @@ STD_LIB_FILE( gid_File_Lib_Msfilter, msfilter)
 STD_UNO_LIB_FILE_PATCH( gid_File_Lib_Sw , sw)
 STD_LIB_FILE_PATCH( gid_File_Lib_Swui, swui)
 
-STD_LIB_FILE_PATCH( gid_File_Lib_Msword, msword )
+STD_UNO_LIB_FILE_PATCH( gid_File_Lib_Msword, msword )
 
 #if ! defined UNX
 File gid_File_Lib_Sysdtrans
diff --git sw/source/filter/ww8/docxexport.cxx sw/source/filter/ww8/docxexport.cxx
index 195dd04..738d57e 100644
--- sw/source/filter/ww8/docxexport.cxx
+++ sw/source/filter/ww8/docxexport.cxx
@@ -312,7 +312,7 @@ bool DocxExport::DisallowInheritingOutlineNumbering( const SwFmt& rFmt )
 }
 
 void DocxExport::WriteHeadersFooters( BYTE nHeadFootFlags,
-        const SwFrmFmt& rFmt, const SwFrmFmt& rLeftFmt, const SwFrmFmt& rFirstPageFmt )
+        const SwFrmFmt& rFmt, const SwFrmFmt& rLeftFmt, const SwFrmFmt& rFirstPageFmt, BYTE /*nBreakCode*/ )
 {
     // headers
     if ( nHeadFootFlags & nsHdFtFlags::WW8_HEADER_EVEN )
@@ -333,6 +333,10 @@ void DocxExport::WriteHeadersFooters( BYTE nHeadFootFlags,
 
     if ( nHeadFootFlags & nsHdFtFlags::WW8_FOOTER_FIRST )
         WriteHeaderFooter( rFirstPageFmt, false, "first" );
+
+#if OSL_DEBUG_LEVEL > 0
+    fprintf( stderr, "DocxExport::WriteHeadersFooters() - nBreakCode introduced, but ignored\n" );
+#endif
 }
 
 void DocxExport::OutputField( const SwField* pFld, ww::eField eFldType, const String& rFldCmd, BYTE nMode )
@@ -347,6 +351,13 @@ void DocxExport::WriteFormData( const ::sw::mark::IFieldmark& /*rFieldmark*/ )
 #endif
 }
 
+void DocxExport::WriteHyperlinkData( const ::sw::mark::IFieldmark& /*rFieldmark*/ )
+{
+#if OSL_DEBUG_LEVEL > 0
+    fprintf( stderr, "TODO DocxExport::WriteHyperlinkData()\n" );
+#endif
+}
+
 void DocxExport::DoComboBox(const rtl::OUString& rName,
                              const rtl::OUString& rHelp,
                              const rtl::OUString& rToolTip,
@@ -540,7 +551,7 @@ void DocxExport::InitStyles()
             S( "styles.xml" ) );
 
     ::sax_fastparser::FSHelperPtr pStylesFS =
-        m_pFilter->openOutputStreamWithSerializer( S( "word/styles.xml" ),
+        m_pFilter->openFragmentStreamWithSerializer( S( "word/styles.xml" ),
             S( "application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml" ) );
 
     // switch the serializer to redirect the output to word/styles.xml
@@ -563,7 +574,7 @@ void DocxExport::WriteFootnotesEndnotes()
                 S( "footnotes.xml" ) );
 
         ::sax_fastparser::FSHelperPtr pFootnotesFS =
-            m_pFilter->openOutputStreamWithSerializer( S( "word/footnotes.xml" ),
+            m_pFilter->openFragmentStreamWithSerializer( S( "word/footnotes.xml" ),
                     S( "application/vnd.openxmlformats-officedocument.wordprocessingml.footnotes+xml" ) );
 
         // switch the serializer to redirect the output to word/footnotes.xml
@@ -584,7 +595,7 @@ void DocxExport::WriteFootnotesEndnotes()
                 S( "endnotes.xml" ) );
 
         ::sax_fastparser::FSHelperPtr pEndnotesFS =
-            m_pFilter->openOutputStreamWithSerializer( S( "word/endnotes.xml" ),
+            m_pFilter->openFragmentStreamWithSerializer( S( "word/endnotes.xml" ),
                     S( "application/vnd.openxmlformats-officedocument.wordprocessingml.endnotes+xml" ) );
 
         // switch the serializer to redirect the output to word/endnotes.xml
@@ -607,7 +618,7 @@ void DocxExport::WriteNumbering()
         S( "http://schemas.openxmlformats.org/officeDocument/2006/relationships/numbering" ),
         S( "numbering.xml" ) );
 
-    ::sax_fastparser::FSHelperPtr pNumberingFS = m_pFilter->openOutputStreamWithSerializer( S( "word/numbering.xml" ),
+    ::sax_fastparser::FSHelperPtr pNumberingFS = m_pFilter->openFragmentStreamWithSerializer( S( "word/numbering.xml" ),
         S( "application/vnd.openxmlformats-officedocument.wordprocessingml.numbering+xml" ) );
 
     // switch the serializer to redirect the output to word/nubering.xml
@@ -640,7 +651,7 @@ void DocxExport::WriteHeaderFooter( const SwFmt& rFmt, bool bHeader, const char*
                 S( "http://schemas.openxmlformats.org/officeDocument/2006/relationships/header" ),
                 aName );
         
-        pFS = m_pFilter->openOutputStreamWithSerializer( OUStringBuffer().appendAscii( "word/" ).append( aName ).makeStringAndClear(),
+        pFS = m_pFilter->openFragmentStreamWithSerializer( OUStringBuffer().appendAscii( "word/" ).append( aName ).makeStringAndClear(),
                     S( "application/vnd.openxmlformats-officedocument.wordprocessingml.header+xml" ) );
 
         pFS->startElementNS( XML_w, XML_hdr,
@@ -655,7 +666,7 @@ void DocxExport::WriteHeaderFooter( const SwFmt& rFmt, bool bHeader, const char*
                 S( "http://schemas.openxmlformats.org/officeDocument/2006/relationships/footer" ),
                 aName );
         
-        pFS = m_pFilter->openOutputStreamWithSerializer( OUStringBuffer().appendAscii( "word/" ).append( aName ).makeStringAndClear(),
+        pFS = m_pFilter->openFragmentStreamWithSerializer( OUStringBuffer().appendAscii( "word/" ).append( aName ).makeStringAndClear(),
                     S( "application/vnd.openxmlformats-officedocument.wordprocessingml.footer+xml" ) );
 
         pFS->startElementNS( XML_w, XML_ftr,
@@ -698,7 +709,7 @@ void DocxExport::WriteFonts()
             S( "http://schemas.openxmlformats.org/officeDocument/2006/relationships/fontTable" ),
             S( "fontTable.xml" ) );
 
-    ::sax_fastparser::FSHelperPtr pFS = m_pFilter->openOutputStreamWithSerializer(
+    ::sax_fastparser::FSHelperPtr pFS = m_pFilter->openFragmentStreamWithSerializer(
             S( "word/fontTable.xml" ),
             S( "application/vnd.openxmlformats-officedocument.wordprocessingml.fontTable+xml" ) );
 
@@ -786,7 +797,7 @@ DocxExport::DocxExport( DocxExportFilter *pFilter, SwDoc *pDocument, SwPaM *pCur
             S( "word/document.xml" ) );
 
     // the actual document
-    m_pDocumentFS = m_pFilter->openOutputStreamWithSerializer( S( "word/document.xml" ),
+    m_pDocumentFS = m_pFilter->openFragmentStreamWithSerializer( S( "word/document.xml" ),
             S( "application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml" ) );
 
     // the DrawingML access
diff --git sw/source/filter/ww8/docxexport.hxx sw/source/filter/ww8/docxexport.hxx
index 06d39a6..5873f95 100644
--- sw/source/filter/ww8/docxexport.hxx
+++ sw/source/filter/ww8/docxexport.hxx
@@ -113,7 +113,7 @@ public:
 
     /// Output the actual headers and footers.
     virtual void WriteHeadersFooters( BYTE nHeadFootFlags,
-            const SwFrmFmt& rFmt, const SwFrmFmt& rLeftFmt, const SwFrmFmt& rFirstPageFmt );
+            const SwFrmFmt& rFmt, const SwFrmFmt& rLeftFmt, const SwFrmFmt& rFirstPageFmt, BYTE nBreakCode );
 
     /// Write the field
     virtual void OutputField( const SwField* pFld, ww::eField eFldType,
@@ -121,6 +121,7 @@ public:
 
     /// Write the data of the form field
     virtual void WriteFormData( const ::sw::mark::IFieldmark& rFieldmark );
+    virtual void WriteHyperlinkData( const ::sw::mark::IFieldmark& rFieldmark );
     
     virtual void DoComboBox(const rtl::OUString &rName,
                     const rtl::OUString &rHelp,
@@ -154,7 +155,7 @@ protected:
 
     virtual void AppendSection( const SwPageDesc *pPageDesc, const SwSectionFmt* pFmt, ULONG nLnNum );
 
-    virtual void SectionBreaksAndFrames( const SwTxtNode& rNode ) {}
+    virtual void SectionBreaksAndFrames( const SwTxtNode& /*rNode*/ ) {}
 
     /// Get ready for a new section.
     virtual void PrepareNewPageDesc( const SfxItemSet* pSet,
diff --git sw/source/filter/ww8/docxexportfilter.cxx sw/source/filter/ww8/docxexportfilter.cxx
index ac01fab..18ce22b 100644
--- sw/source/filter/ww8/docxexportfilter.cxx
+++ sw/source/filter/ww8/docxexportfilter.cxx
@@ -76,7 +76,7 @@ bool DocxExportFilter::exportDocument()
         aExport.ExportDocument( true ); // FIXME support exporting selection only
     }
 
-    commit();
+    commitStorage();
 
     // delete the pCurPam
     if ( pCurPam )
diff --git sw/source/filter/ww8/docxexportfilter.hxx sw/source/filter/ww8/docxexportfilter.hxx
index e1d0b3d..cf5d5e2 100644
--- sw/source/filter/ww8/docxexportfilter.hxx
+++ sw/source/filter/ww8/docxexportfilter.hxx
@@ -30,7 +30,7 @@
 
 #include <oox/core/xmlfilterbase.hxx>
 #include <oox/drawingml/chart/chartconverter.hxx>
-#include <oox/vml/drawing.hxx>
+#include <oox/vml/vmldrawing.hxx>
 
 #include <com/sun/star/beans/PropertyValue.hpp>
 
@@ -45,7 +45,7 @@ public:
     virtual bool        importDocument() { return false; }
     virtual const ::oox::drawingml::Theme* getCurrentTheme() const { return NULL; }
     virtual sal_Int32   getSchemeClr( sal_Int32 ) const { return 0; }
-    virtual const ::oox::vml::DrawingPtr getDrawings() { return ::oox::vml::DrawingPtr(); }
+    virtual ::oox::vml::Drawing* getVmlDrawing() { return NULL; }
     virtual ::oox::drawingml::chart::ChartConverter& getChartConverter() { static ::oox::drawingml::chart::ChartConverter aConverter; return aConverter; }
     virtual const ::oox::drawingml::table::TableStyleListPtr getTableStyles() { return ::oox::drawingml::table::TableStyleListPtr(); }
 
diff --git sw/source/filter/ww8/makefile.mk sw/source/filter/ww8/makefile.mk
index b25887e..653c36f 100644
--- sw/source/filter/ww8/makefile.mk
+++ sw/source/filter/ww8/makefile.mk
@@ -58,6 +58,7 @@ EXCEPTIONSFILES = \
         $(SLO)$/wrtw8num.obj \
         $(SLO)$/wrtw8sty.obj \
         $(SLO)$/wrtww8.obj \
+        $(SLO)$/docxexportfilter.obj \
         $(SLO)$/ww8atr.obj \
         $(SLO)$/ww8par.obj \
         $(SLO)$/ww8par6.obj \
@@ -77,6 +78,9 @@ SLOFILES =	\
         $(SLO)$/wrtw8sty.obj \
         $(SLO)$/wrtww8.obj \
         $(SLO)$/wrtww8gr.obj \
+        $(SLO)$/docxattributeoutput.obj \
+        $(SLO)$/docxexportfilter.obj \
+        $(SLO)$/docxexport.obj \
         $(SLO)$/ww8atr.obj \
         $(SLO)$/ww8graf.obj \
         $(SLO)$/ww8graf2.obj \
diff --git sw/source/filter/ww8/wrtw8sty.cxx sw/source/filter/ww8/wrtw8sty.cxx
index 8f39cb6..a9478be 100644
--- sw/source/filter/ww8/wrtw8sty.cxx
+++ sw/source/filter/ww8/wrtw8sty.cxx
@@ -695,7 +695,6 @@ bool wwFont::Write(SvStream *pTableStrm) const
     return true;
 }
 
-#ifdef DOCX
 void wwFont::WriteDocx( const DocxAttributeOutput* rAttrOutput ) const
 {
     // no font embedding, panose id, subsetting, ... implemented
@@ -710,7 +709,6 @@ void wwFont::WriteDocx( const DocxAttributeOutput* rAttrOutput ) const
 
     rAttrOutput->EndFont();
 }
-#endif
 
 bool operator<(const wwFont &r1, const wwFont &r2)
 {
@@ -828,7 +826,6 @@ void wwFontHelper::WriteFontTable(SvStream *pTableStream, WW8Fib& rFib)
     }
 }
 
-#ifdef DOCX
 void wwFontHelper::WriteFontTable( const DocxAttributeOutput& rAttrOutput )
 {
     ::std::vector<const wwFont *> aFontList( AsVector() );
@@ -836,7 +833,6 @@ void wwFontHelper::WriteFontTable( const DocxAttributeOutput& rAttrOutput )
     ::std::for_each( aFontList.begin(), aFontList.end(),
         ::std::bind2nd( ::std::mem_fun( &wwFont::WriteDocx ), &rAttrOutput ) );
 }
-#endif
 
 /*  */
 
diff --git sw/source/filter/ww8/wrtww8.hxx sw/source/filter/ww8/wrtww8.hxx
index e513db1..fafe06b 100644
--- sw/source/filter/ww8/wrtww8.hxx
+++ sw/source/filter/ww8/wrtww8.hxx
@@ -293,9 +293,7 @@ public:
     wwFont( const String &rFamilyName, FontPitch ePitch, FontFamily eFamily,
         rtl_TextEncoding eChrSet, bool bWrtWW8 );
     bool Write( SvStream *pTableStram ) const;
-#ifdef DOCX
     void WriteDocx( const DocxAttributeOutput* rAttrOutput ) const;
-#endif
     rtl::OUString GetFamilyName() const { return rtl::OUString( msFamilyNm ); }
     friend bool operator < (const wwFont &r1, const wwFont &r2);
 };
@@ -318,9 +316,7 @@ public:
     USHORT GetId(const SvxFontItem& rFont);
     USHORT GetId(const wwFont& rFont);
     void WriteFontTable( SvStream *pTableStream, WW8Fib& pFib );
-#ifdef DOCX
     void WriteFontTable( const DocxAttributeOutput& rAttrOutput );
-#endif
 };
 
 class DrawObj
diff --git sw/util/makefile.mk sw/util/makefile.mk
index 557e871..f041898 100644
--- sw/util/makefile.mk
+++ sw/util/makefile.mk
@@ -315,6 +315,8 @@ DEF4NAME=$(SHL4TARGET)
 
 SHL4STDLIBS= \
     $(ISWLIB) \
+    $(OOXLIB) \
+    $(SAXLIB) \
     $(SVXCORELIB) \
        $(EDITENGLIB) \
     $(MSFILTERLIB) \
diff --git sw/util/msword.map sw/util/msword.map
index 16b9d25..df7ae0b 100755
--- sw/util/msword.map
+++ sw/util/msword.map
@@ -6,6 +6,11 @@ UDK_3_0_0 {
                 ExportDOC;
                                 SaveOrDelMSVBAStorage_ww8;
                                 GetSaveWarningOfMSVBAStorage_ww8;
+
+                component_getImplementationEnvironment;
+                component_writeInfo;
+                component_getFactory;
+
         local:
                 *;
 };
-- 
1.7.0.1

