From 5cdd5671f66cb00335b543d3e2c883c22e1bd84e Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:07:55 +0200
Subject: [PATCH 788/878] calc-perf-print-calc-pages.diff

---
 sc/inc/dociter.hxx               |   17 +++++++++++++++++
 sc/inc/document.hxx              |    3 +++
 sc/source/core/data/dociter.cxx  |   23 +++++++++++++++++++++++
 sc/source/core/data/document.cxx |    7 +++++++
 sc/source/ui/view/printfun.cxx   |   35 ++++++++++++++++++++++++++++++-----
 5 files changed, 80 insertions(+), 5 deletions(-)

diff --git a/sc/inc/dociter.hxx b/sc/inc/dociter.hxx
index 96a4707..b95ad34 100644
--- a/sc/inc/dociter.hxx
+++ b/sc/inc/dociter.hxx
@@ -36,6 +36,7 @@
 
 #include <memory>
 #include <vector>
+#include <set>
 #include <boost/shared_ptr.hpp>
 
 class ScDocument;
@@ -546,6 +547,22 @@ private:
     const ::std::vector<TabRanges>* mpTabRangesArray;
 };
 
+// ============================================================================
+
+class ScRowBreakIterator
+{
+public:
+    static SCROW NOT_FOUND;
+
+    explicit ScRowBreakIterator(::std::set<SCROW>& rBreaks);
+    SCROW first();
+    SCROW next();
+
+private:
+    ::std::set<SCROW>& mrBreaks;
+    ::std::set<SCROW>::const_iterator maItr;
+    ::std::set<SCROW>::const_iterator maEnd;
+};
 
 #endif
 
diff --git a/sc/inc/document.hxx b/sc/inc/document.hxx
index 00d4d6d..6a9a1b7 100644
--- a/sc/inc/document.hxx
+++ b/sc/inc/document.hxx
@@ -141,6 +141,7 @@ struct ScClipRangeNameData;
 struct ScSetStringParam;
 class ScDocRowHeightUpdater;
 struct ScColWidthParam;
+class ScRowBreakIterator;
 
 namespace com { namespace sun { namespace star {
     namespace lang {
@@ -1800,6 +1801,8 @@ public:
     void RemoveSubTotalCell(ScFormulaCell* pCell);
     void SetSubTotalCellsDirty(const ScRange& rDirtyRange);
 
+    ScRowBreakIterator* GetRowBreakIterator(SCTAB nTab) const;
+
 private: // CLOOK-Impl-Methoden
 
     /** 
diff --git a/sc/source/core/data/dociter.cxx b/sc/source/core/data/dociter.cxx
index 3dbe8e1..dad4b0b 100644
--- a/sc/source/core/data/dociter.cxx
+++ b/sc/source/core/data/dociter.cxx
@@ -52,6 +52,7 @@
 
 using ::rtl::math::approxEqual;
 using ::std::vector;
+using ::std::set;
 using ::rtl::OUString;
 
 // STATIC DATA -----------------------------------------------------------
@@ -2204,3 +2205,25 @@ void ScDocRowHeightUpdater::updateAll()
         nProgressStart += mrDoc.pTab[nTab]->GetWeightedCount();
     }
 }
+
+// ============================================================================
+
+SCROW ScRowBreakIterator::NOT_FOUND = -1;
+
+ScRowBreakIterator::ScRowBreakIterator(set<SCROW>& rBreaks) :
+    mrBreaks(rBreaks),
+    maItr(rBreaks.begin()), maEnd(rBreaks.end())
+{
+}
+
+SCROW ScRowBreakIterator::first()
+{
+    maItr = mrBreaks.begin();
+    return maItr == maEnd ? NOT_FOUND : *maItr;
+}
+
+SCROW ScRowBreakIterator::next()
+{
+    ++maItr;
+    return maItr == maEnd ? NOT_FOUND : *maItr;
+}
diff --git a/sc/source/core/data/document.cxx b/sc/source/core/data/document.cxx
index 5b41066..8189d9e 100644
--- a/sc/source/core/data/document.cxx
+++ b/sc/source/core/data/document.cxx
@@ -5297,6 +5297,13 @@ void ScDocument::SetSubTotalCellsDirty(const ScRange& rDirtyRange)
     maSubTotalCells.swap(aNewSet); // update the list.
 }
 
+ScRowBreakIterator* ScDocument::GetRowBreakIterator(SCTAB nTab) const
+{
+    if (ValidTab(nTab) && pTab[nTab])
+        return new ScRowBreakIterator(pTab[nTab]->maRowPageBreaks);
+    return NULL;
+}
+
 void ScDocument::EnableUndo( bool bVal )
 {
     GetUndoManager()->EnableUndo(bVal);
diff --git a/sc/source/ui/view/printfun.cxx b/sc/source/ui/view/printfun.cxx
index 3d4b261..fb31444 100644
--- a/sc/source/ui/view/printfun.cxx
+++ b/sc/source/ui/view/printfun.cxx
@@ -85,6 +85,8 @@
 #include <vcl/lineinfo.hxx>
 #include <tools/pstm.hxx>
 
+#include <boost/scoped_ptr.hpp>
+
 #define ZOOM_MIN	10
 
 #define GET_BOOL(set,which)   ((const SfxBoolItem&)(set)->Get((which))).GetValue()
@@ -3090,11 +3092,22 @@ void ScPrintFunc::CalcPages()				// berechnet aPageRect und Seiten aus nZoom
         ++nPagesX;
     }
 
-    BOOL bVisRow = FALSE;
+    bool bVisRow = false;
     SCROW nPageStartRow = nStartRow;
+    SCROW nLastVisibleRow = -1;
+
+    ::boost::scoped_ptr<ScRowBreakIterator> pRowBreakIter(pDoc->GetRowBreakIterator(nPrintTab));
+    SCROW nNextPageBreak = pRowBreakIter->first();
+    while (nNextPageBreak != ScRowBreakIterator::NOT_FOUND && nNextPageBreak < nStartRow)
+        // Skip until the page break position is at the start row or greater.
+        nNextPageBreak = pRowBreakIter->next();
+
     for (SCROW nRow = nStartRow; nRow <= nEndRow; ++nRow)
     {
-        bool bPageBreak = (pDoc->HasRowBreak(nRow, nPrintTab) & BREAK_PAGE);
+        bool bPageBreak = (nNextPageBreak == nRow);
+        if (bPageBreak)
+            nNextPageBreak = pRowBreakIter->next();
+
         if (nRow > nStartRow && bVisRow && bPageBreak )
         {
             pPageEndY[nTotalY] = nRow-1;
@@ -3112,11 +3125,23 @@ void ScPrintFunc::CalcPages()				// berechnet aPageRect und Seiten aus nZoom
             }
 
             nPageStartRow = nRow;
-            bVisRow = FALSE;
+            bVisRow = false;
+        }
+
+        if (nRow <= nLastVisibleRow)
+        {
+            // This row is still visible.  Don't bother calling RowHidden() to
+            // find out, for speed optimization.
+            bVisRow = true;
+            continue;
         }
+
         SCROW nLastRow = -1;
-        if (!pDoc->RowHidden(nRow, nPrintTab, nLastRow))
-            bVisRow = TRUE;
+        if (!pDoc->RowHidden(nRow, nPrintTab, NULL, &nLastRow))
+        {
+            bVisRow = true;
+            nLastVisibleRow = nLastRow;
+        }
         else
             // skip all hidden rows.
             nRow = nLastRow;
-- 
1.7.0.1

