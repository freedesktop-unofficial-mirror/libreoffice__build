From 87bd20f61b2f0a85ff3d4f2b34c53bc5f03001d8 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:04:26 +0200
Subject: [PATCH 621/878] sw-allow-negative-spacing.diff

---
 sw/source/core/text/itrform2.cxx |   22 ++++++++++++++++++++++
 1 files changed, 22 insertions(+), 0 deletions(-)

diff --git a/sw/source/core/text/itrform2.cxx b/sw/source/core/text/itrform2.cxx
index 600ba83..2bcdbdc 100644
--- a/sw/source/core/text/itrform2.cxx
+++ b/sw/source/core/text/itrform2.cxx
@@ -1739,6 +1739,28 @@ void SwTxtFormatter::CalcRealHeight( sal_Bool bNewLine )
             switch( pSpace->GetLineSpaceRule() )
             {
                 case SVX_LINE_SPACE_AUTO:
+            if (pSpace->GetInterLineSpaceRule()==SVX_INTER_LINE_SPACE_PROP) {
+                        long nTmp = pSpace->GetPropLineSpace();
+                        if (nTmp<100) { // code adaped from fixed line height
+                            nTmp *= nLineHeight;
+                            nTmp /= 100;
+                            if( !nTmp )
+                                ++nTmp;
+                            nLineHeight = (KSHORT)nTmp;
+/*
+                            //@TODO figure out how WW maps ascent and descent
+                            //in case of prop  line spacing <100%
+                            KSHORT nAsc = ( 4 * nLineHeight ) / 5;  // 80%
+                            if( nAsc < pCurr->GetAscent() ||
+                                nLineHeight - nAsc < pCurr->Height() -
+pCurr->GetAscent() )
+                                pCurr->SetClipping( sal_True );
+                            pCurr->SetAscent( nAsc );
+*/
+                            pCurr->Height( nLineHeight );
+                            pInf->GetParaPortion()->SetFixLineHeight();
+                        }
+                    }
                 break;
                 case SVX_LINE_SPACE_MIN:
                 {
-- 
1.7.0.1

