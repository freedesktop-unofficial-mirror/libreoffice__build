--- config_office/configure.in.BAK	2008-04-25 16:23:00.234375000 +0300
+++ config_office/configure.in	2008-04-25 17:01:03.187500000 +0300
@@ -549,9 +549,9 @@
 ],,)
 AC_ARG_WITH(mspdb-path,
 [  --with-mspdb-path       For Microsoft C/C++ compiler users, please supply the
-                          path pointing to the mspdb71.dll (.NET 2003).
+                          path pointing to the mspdb71.dll (.NET 2003) or mspdb80.dll.
  
-                          Usage: --with-mspdb-path=<absolute path to mspdb71.dll>
+                          Usage: --with-mspdb-path=<absolute path to mspdb*.dll>
 ],,)
 AC_ARG_WITH(midl-path,
 [  --with-midl-path        For Microsoft C/C++ .NET compiler users, please supply
@@ -1587,7 +1587,7 @@
 		AC_MSG_RESULT([done])
 
 		dnl ===========================================================
-		dnl  Check for mspdb71.dll
+		dnl  Check for mspdb71.dll/mspdb80.dll
 		dnl ===========================================================
 		dnl  .NET 2003 Compiler
 		if test -n "$MSPDB_PATH";then
@@ -1643,7 +1643,10 @@
 							}
 							}"`
 			AC_MSG_RESULT([found Compiler version $CCNUMVER.])
-			if test "$CCNUMVER" -ge "001400000000"; then
+			if test "$CCNUMVER" -ge "001500000000"; then
+				COMEX=12
+				AC_MSG_RESULT([found .NET 2008 / VS 9.0.])
+			elif test "$CCNUMVER" -ge "001400000000"; then
 				COMEX=11
 				AC_MSG_RESULT([found .NET 2005.])
 			elif test "$CCNUMVER" -ge "001300102240"; then
@@ -1676,7 +1679,8 @@
 dnl ===================================================================
 dnl  .NET needs special treatment
 dnl ===================================================================
-if test "$COMEX" = "10" -o "$COMEX" = "11"; then
+if test "$_os" = "WINNT"; then
+if test "$COMEX" -ge "10"; then
 	dnl Check midl.exe
 	if test -n "$MIDL_PATH";then
 		MIDL_PATH=`dirname "$MIDL_PATH"`
@@ -1692,6 +1696,10 @@
       if test -x "$vstest/Common7/Tools/Bin/midl.exe" ; then
 		  MIDL_PATH="$vstest/Common7/Tools/Bin"
       fi
+	  psdktest=`./oowintool --psdk-home`
+      if test -x "$psdktest/Bin/midl.exe" ; then
+		  MIDL_PATH="$psdktest/Bin"
+	  fi
 	fi
 	if test ! -x "$MIDL_PATH/midl.exe"; then
 		AC_MSG_ERROR([midl.exe not found. Make sure it's in the path or use --with-midl-path])
@@ -1732,7 +1740,7 @@
 	    fi
 	    if test -z "$FRAME_HOME" ; then
           frametest=`./oowintool --dotnetsdk-dir`
-          if test -x "$frametest/lib/mscoree.lib"; then
+          if test -f "$frametest/lib/mscoree.lib"; then
              FRAME_HOME="$frametest"
           fi
 	    fi
@@ -1747,6 +1755,7 @@
 AC_SUBST(MIDL_PATH)
 AC_SUBST(CSC_PATH)
 AC_SUBST(FRAME_HOME)
+fi
 
 dnl ===================================================================
 dnl Check if stdc headers are available excluding windows.
--- config_office/oowintool.BAK	2008-04-25 13:12:44.546875000 +0300
+++ config_office/oowintool	2008-04-25 16:45:16.093750000 +0300
@@ -95,12 +95,16 @@
 sub print_psdk_home()
 {
     my $value;
-    $value = reg_get_value ('HKEY_LOCAL_MACHINE/SOFTWARE/Microsoft/MicrosoftSDK/Directories/Install Dir');
+    $value = reg_get_value ('HKEY_LOCAL_MACHINE/SOFTWARE/Microsoft/Microsoft SDKs/Windows/v6.1/InstallationFolder');
     if (!defined $value)
     {
-        $key = reg_find_key ('HKEY_LOCAL_MACHINE/SOFTWARE/Microsoft/MicrosoftSDK/InstalledSDKs/*/Install Dir');
-        $value = reg_get_value ($key);
-    }
+		$value = reg_get_value ('HKEY_LOCAL_MACHINE/SOFTWARE/Microsoft/MicrosoftSDK/Directories/Install Dir');
+		if (!defined $value)
+		{
+			$key = reg_find_key ('HKEY_LOCAL_MACHINE/SOFTWARE/Microsoft/MicrosoftSDK/InstalledSDKs/*/Install Dir');
+			$value = reg_get_value ($key);
+		}
+	}
     defined $value || die "psdk not found";
 
     print cygpath ($value, 'w', $output_format);
@@ -128,14 +132,14 @@
     'ver' => '7.1',
     'key' => 'Microsoft/VisualStudio/7.1/Setup/VC/ProductDir',
     'instmsi_path' => '../Common7/Tools/Deployment/MsiRedist',
-    'dll_path' => '../SDK/v1.1/Bin',
+    'dll_path' => '../Visual Studio .NET Professional 2003 - English',
     'dll_suffix' => '71'
 );
 my %msvs_net_2003 = (
     'ver' => '7.1',
     'key' => 'Microsoft/VisualStudio/7.1/Setup/VS/ProductDir',
     'instmsi_path' => 'Common7/Tools/Deployment/MsiRedist',
-    'dll_path' => 'Visual Studio .NET Professional 2003 - English', # testme ...
+    'dll_path' => 'Visual Studio .NET Professional 2003 - English',
     'dll_suffix' => '71'
 );
 my %msvs_net_2003_ea = (
@@ -159,10 +163,24 @@
     'dll_path' => '../SDK/v2.0/Bin',
     'dll_suffix' => '80'
 );
+my %msvs_2008 = (
+    'ver' => '9.0',
+    'key' => 'Microsoft/VisualStudio/9.0/Setup/VS/ProductDir',
+    'instmsi_path' => '?',
+    'dll_path' => 'VC/redist/x86/Microsoft.VC90.CRT',
+    'dll_suffix' => '90'
+);
+my %msvc_2008 = (
+    'ver' => '9.0',
+    'key' => 'Microsoft/VisualStudio/9.0/Setup/VC/ProductDir',
+    'instmsi_path' => '?',
+    'dll_path' => 'redist/x86/Microsoft.VC90.CRT',
+    'dll_suffix' => '90'
+);
 
 sub find_msvs()
 {
-    my @ms_versions = ( \%msvs_express_2005, \%msvs_net_2003_ea, \%msvs_net_2003, \%msvs_net_2002, \%msvc6 );
+    my @ms_versions = ( \%msvs_2008, \%msvs_express_2005, \%msvs_net_2003_ea, \%msvs_net_2003, \%msvs_net_2002, \%msvc6 );
 
     for $ver (@ms_versions)
     {
@@ -177,7 +195,7 @@
 
 sub find_msvc()
 {
-    my @ms_versions = ( \%msvc_express_2005, \%msvc_net_2003, \%msvc_net_2002, \%msvc6 );
+    my @ms_versions = ( \%msvc_2008, \%msvc_express_2005, \%msvc_net_2003, \%msvc_net_2002, \%msvc6 );
 
     for $ver (@ms_versions)
     {
@@ -242,6 +260,7 @@
     -f "$src/$fname" || die "can't find $src";
     -d $dest || die "no directory $dest";
 
+	print STDERR "Copying $src/$fname to $dest\n";
     copy ("$src/$fname", $dest) || die "copy failed: $!";
     chmod (0755, "$dest/$fname") || die "failed to set dll executable: $!";
 }
@@ -257,7 +276,7 @@
     $srcdir = (cygpath ($ver->{'product_dir'}, 'w', 'u') . '/' . 
 		  $ver->{$checkpath});
     -d $srcdir && return $ver;
-    return "";
+    return undef;
 }
 
 sub msvc_copy_dlls($)
--- config_office/set_soenv.in.BAK	2008-04-25 17:32:53.859375000 +0300
+++ config_office/set_soenv.in	2008-04-25 20:06:49.687500000 +0300
@@ -664,8 +664,14 @@
           $ATL_INCLUDE = $COMPATH.$ds."atlmfc".$ds."include";
           $MFC_LIB     = "";
           $MFC_INCLUDE = "";
-      } elsif ( "@COMEX@" eq "11" ) { # .NET 2005 needs M1400
-          $CVER        = "M1400";
+      } elsif ( "@COMEX@" ge "11" ) { # .NET 2005 needs M1400
+		  if ( "@COMEX@" eq "11" ) {
+			  $CVER        = "M1400";
+		  } elsif ( "@COMEX@" eq "12" ) {
+			  $CVER        = "M1500";
+		  } else {                   # Unsupported
+			  die "Unsupported value for COMEX variable.\n";
+		  }
           if ( "@DISABLE_ACTIVEX@" ) {
               $ATL_LIB     = $PSDK_HOME.$ds."lib"; # Doesn't exist for VSE
               $ATL_INCLUDE = $PSDK_HOME.$ds."include".$ds."atl";
@@ -1225,7 +1231,7 @@
 	   if ( $PATH !~ /(?:[:]|\A)(?:$tmppath)(?:[:]|\Z)/ ) {
 		   $PATH .= $ps.$tmppath;
 	   }
-	   if ( ( $COMEX eq "10" ) || ( $COMEX eq "11" ) ) {
+	   if ( ( $COMEX ge "10" ) ) {
 		   # .NET needs midl.exe
                $tmppath = CygFormat($MIDL_PATH);
 		   if ( $PATH !~ /(?:[:]|\A)(?:$tmppath)(?:[:]|\Z)/ ) {
