From 4be97b111de0d632acb187d43d222600ea89ecbe Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:58:30 +0200
Subject: [PATCH 320/878] link-as-needed.diff

---
 configure.in                                 |   20 ++++++++++++++++++++
 set_soenv.in                                 |    2 ++
 solenv/inc/unxbsdi.mk                        |    3 +++
 solenv/inc/unxbsdi2.mk                       |    3 +++
 solenv/inc/unxfbsd.mk                        |    3 +++
 solenv/inc/unxirgm.mk                        |    3 +++
 solenv/inc/unxirxm3.mk                       |    3 +++
 solenv/inc/unxlng.mk                         |    3 +++
 solenv/inc/unxmacx.mk                        |    4 ++++
 solenv/inc/unxsogi.mk                        |    4 ++++
 solenv/inc/unxsoli4.mk                       |    3 +++
 solenv/inc/unxsols4.mk                       |    3 +++
 solenv/inc/unxsolu4.mk                       |    3 +++
 svx/util/makefile.mk                         |    2 +-
 unodevtools/source/skeletonmaker/makefile.mk |    5 +++--
 15 files changed, 61 insertions(+), 3 deletions(-)

diff --git a/configure.in b/configure.in
index 5030b4a..806bb4d 100644
--- a/configure.in
+++ b/configure.in
@@ -1673,6 +1673,26 @@ AC_SUBST(HAVE_LD_HASH_STYLE)
 AC_SUBST(WITH_LINKER_HASH_STYLE)
 
 dnl ===================================================================
+dnl  Check for -Wl,--as-needed linker support
+dnl ===================================================================
+HAVE_WORKING_LD_AS_NEEDED=
+if test \( "$_os" != "WINNT" -o "$WITH_MINGWIN" = "yes" \) -a "$GCC" = "yes"; then
+   AC_MSG_CHECKING([for working -Wl,--as-needed linker support])
+   _ld_version=`$CC -Wl,--version 2>&1 | head -n 1 | $SED -e "s|(.*)||" -e "s|^[[^0-9]]*||"`
+   _ld_major=`echo $_ld_version | cut -d"." -f 1`
+   _ld_minor=`echo $_ld_version | cut -d"." -f 2`
+   if test "$_ld_major" -gt 2 || \
+      test "$_ld_major" -eq 2 -a "$_ld_minor" -gt 17 ; then
+      # there are problems with ld <= 2.17, see also http://www.gentoo.org/proj/en/qa/asneeded.xml
+      HAVE_WORKING_LD_AS_NEEDED=TRUE
+      AC_MSG_RESULT([yes])
+   else
+      AC_MSG_RESULT([no])
+   fi
+fi
+AC_SUBST(HAVE_WORKING_LD_AS_NEEDED)
+
+dnl ===================================================================
 dnl  Test the IRIX SGI Mips pro compiler
 dnl ===================================================================
 if test "$_os" = "IRIX" -o "$_os" = "IRIX64"; then
diff --git a/set_soenv.in b/set_soenv.in
index c4e8e13..384267c 100644
--- a/set_soenv.in
+++ b/set_soenv.in
@@ -1805,6 +1805,8 @@ ToFile( "HAVE_LD_HASH_STYLE","@HAVE_LD_HASH_STYLE@","e" );
 ToFile( "WITH_LINKER_HASH_STYLE","@WITH_LINKER_HASH_STYLE@","e" );
 ToFile( "HAVE_LD_BSYMBOLIC_FUNCTIONS",
 		"@HAVE_LD_BSYMBOLIC_FUNCTIONS@","e" );
+ToFile( "HAVE_WORKING_LD_AS_NEEDED",
+        "@HAVE_WORKING_LD_AS_NEEDED@","e" );
 ToFile( "CXX",               $CXX,               "e" );
 ToFile( "USE_CCACHE",        "@USE_CCACHE@",     "e" );
 ToFile( "MINGWCXX",          "@MINGWCXX@",       "e" );
diff --git a/solenv/inc/unxbsdi.mk b/solenv/inc/unxbsdi.mk
index 835cb9d..7d8b66f 100644
--- a/solenv/inc/unxbsdi.mk
+++ b/solenv/inc/unxbsdi.mk
@@ -104,6 +104,9 @@ DYNAMIC		= -Wl,-Bdynamic
 LINK*=gcc
 # default linker flags
 LINKFLAGS=
+.IF "$(HAVE_WORKING_LD_AS_NEEDED)" == "TRUE"
+LINKFLAGS += -Wl,--as-needed
+.ENDIF
 
 # linker flags for linking applications
 LINKFLAGSAPPGUI= -Wl,-export-dynamic 
diff --git a/solenv/inc/unxbsdi2.mk b/solenv/inc/unxbsdi2.mk
index 0e8c3b3..a3429cb 100644
--- a/solenv/inc/unxbsdi2.mk
+++ b/solenv/inc/unxbsdi2.mk
@@ -124,6 +124,9 @@ LINKFLAGSRUNPATH_BRAND=-Wl,-rpath,\''$$ORIGIN:$$ORIGIN/../basis-link/program:$$O
 LINKFLAGSRUNPATH_OXT=
 LINKFLAGSRUNPATH_NONE=
 LINKFLAGS=-z combreloc $(LINKFLAGSDEFS)
+.IF "$(HAVE_WORKING_LD_AS_NEEDED)" == "TRUE"
+LINKFLAGS += -Wl,--as-needed
+.ENDIF
 
 # linker flags for linking applications
 LINKFLAGSAPPGUI= -Wl,-export-dynamic 
diff --git a/solenv/inc/unxfbsd.mk b/solenv/inc/unxfbsd.mk
index 93df452..7f29ffc 100644
--- a/solenv/inc/unxfbsd.mk
+++ b/solenv/inc/unxfbsd.mk
@@ -146,6 +146,9 @@ LINKFLAGSRUNPATH_BRAND=-Wl,-rpath,\''$$ORIGIN:$$ORIGIN/../basis-link/program:$$O
 LINKFLAGSRUNPATH_OXT=
 LINKFLAGSRUNPATH_NONE=
 LINKFLAGS=-Wl,-z,combreloc $(LINKFLAGSDEFS)
+.IF "$(HAVE_WORKING_LD_AS_NEEDED)" == "TRUE"
+LINKFLAGS += -Wl,--as-needed
+.ENDIF
 
 # linker flags for linking applications
 LINKFLAGSAPPGUI= -Wl,-export-dynamic -Wl,--noinhibit-exec
diff --git a/solenv/inc/unxirgm.mk b/solenv/inc/unxirgm.mk
index 223a5f6..6f6e9d7 100644
--- a/solenv/inc/unxirgm.mk
+++ b/solenv/inc/unxirgm.mk
@@ -92,6 +92,9 @@ DYNAMIC=		-Wl,-Bdynamic
 #
 LINK= g++
 LINKFLAGS=	-L/usr/lib32 -Wl,-no_unresolved
+.IF "$(HAVE_WORKING_LD_AS_NEEDED)" == "TRUE"
+LINKFLAGS += -Wl,--as-needed
+.ENDIF
 LINKVERSIONMAPFLAG= -Wl,-exports_file
 
 LINKFLAGSAPPGUI= $(THREADLIB)
diff --git a/solenv/inc/unxirxm3.mk b/solenv/inc/unxirxm3.mk
index 2b2ba56..ac5247c 100644
--- a/solenv/inc/unxirxm3.mk
+++ b/solenv/inc/unxirxm3.mk
@@ -92,6 +92,9 @@ DYNAMIC=                -Wl,-Bdynamic
 #
 LINK= CC
 LINKFLAGS=      -L/usr/lib32 -Wl,-no_unresolved
+.IF "$(HAVE_WORKING_LD_AS_NEEDED)" == "TRUE"
+LINKFLAGS += -Wl,--as-needed
+.ENDIF
 LINKVERSIONMAPFLAG= -Wl,-exports_file
 
 LINKFLAGSAPPGUI= $(THREADLIB)
diff --git a/solenv/inc/unxlng.mk b/solenv/inc/unxlng.mk
index 2c8855b..52cda56 100644
--- a/solenv/inc/unxlng.mk
+++ b/solenv/inc/unxlng.mk
@@ -157,6 +157,9 @@ LINKFLAGS=-Wl,-z,noexecstack -Wl,-z,combreloc $(LINKFLAGSDEFS)
 .IF "$(HAVE_LD_BSYMBOLIC_FUNCTIONS)"  == "TRUE"
 LINKFLAGS += -Wl,-Bsymbolic-functions -Wl,--dynamic-list-cpp-new -Wl,--dynamic-list-cpp-typeinfo
 .ENDIF
+.IF "$(HAVE_WORKING_LD_AS_NEEDED)" == "TRUE"
+LINKFLAGS += -Wl,--as-needed
+.ENDIF
 
 # linker flags for linking applications
 LINKFLAGSAPPGUI= -Wl,-export-dynamic -Wl,--noinhibit-exec \
diff --git a/solenv/inc/unxmacx.mk b/solenv/inc/unxmacx.mk
index 91fcfa7..d54943f 100644
--- a/solenv/inc/unxmacx.mk
+++ b/solenv/inc/unxmacx.mk
@@ -209,6 +209,10 @@ LINKFLAGSRUNPATH_OXT=
 LINKFLAGSRUNPATH_NONE=
 LINKFLAGS=$(LINKFLAGSDEFS)
 
+.IF "$(HAVE_WORKING_LD_AS_NEEDED)" == "TRUE"
+LINKFLAGS += -Wl,--as-needed
+.ENDIF
+
 # [ed] 5/14/02 If we're building for aqua, add in the objc runtime library into our link line
 .IF "$(GUIBASE)" == "aqua"
     LINKFLAGS+=-lobjc
diff --git a/solenv/inc/unxsogi.mk b/solenv/inc/unxsogi.mk
index 4b6b320..a89d1ef 100644
--- a/solenv/inc/unxsogi.mk
+++ b/solenv/inc/unxsogi.mk
@@ -78,6 +78,10 @@ LINK*=$(CXX)
 LINKC*=$(CC)
 
 LINKFLAGS=
+.IF "$(HAVE_WORKING_LD_AS_NEEDED)" == "TRUE"
+LINKFLAGS += -Wl,--as-needed
+.ENDIF
+
 LINKFLAGSAPPGUI=-Wl,-export-dynamic
 LINKFLAGSSHLGUI=-shared
 LINKFLAGSAPPCUI=-Wl,-export-dynamic
diff --git a/solenv/inc/unxsoli4.mk b/solenv/inc/unxsoli4.mk
index d3d9ae9..bc79ade 100644
--- a/solenv/inc/unxsoli4.mk
+++ b/solenv/inc/unxsoli4.mk
@@ -139,6 +139,9 @@ LINKFLAGSRUNPATH_BRAND=-R\''$$ORIGIN:$$ORIGIN/../basis-link/program:$$ORIGIN/../
 LINKFLAGSRUNPATH_OXT=
 LINKFLAGSRUNPATH_NONE=
 LINKFLAGS=-w -mt -z combreloc -PIC -temp=/tmp -norunpath -library=no%Cstd
+.IF "$(HAVE_WORKING_LD_AS_NEEDED)" == "TRUE"
+LINKFLAGS += -Wl,--as-needed
+.ENDIF
 LINKCFLAGS=-w -mt -z combreloc -norunpath
 
 # -z text force fatal error if non PIC code is linked into shared library. Such code
diff --git a/solenv/inc/unxsols4.mk b/solenv/inc/unxsols4.mk
index 0cba732..a42e8eb 100644
--- a/solenv/inc/unxsols4.mk
+++ b/solenv/inc/unxsols4.mk
@@ -145,6 +145,9 @@ LINKFLAGSRUNPATH_BRAND=-R\''$$ORIGIN:$$ORIGIN/../basis-link/program:$$ORIGIN/../
 LINKFLAGSRUNPATH_OXT=
 LINKFLAGSRUNPATH_NONE=
 LINKFLAGS=-w -mt -z combreloc -PIC -temp=/tmp -norunpath -library=no%Cstd
+.IF "$(HAVE_WORKING_LD_AS_NEEDED)" == "TRUE"
+LINKFLAGS += -Wl,--as-needed
+.ENDIF
 LINKCFLAGS=-w -mt -z combreloc -norunpath
 
 # -z text force fatal error if non PIC code is linked into shared library. Such code
diff --git a/solenv/inc/unxsolu4.mk b/solenv/inc/unxsolu4.mk
index 6839547..d057e4d 100644
--- a/solenv/inc/unxsolu4.mk
+++ b/solenv/inc/unxsolu4.mk
@@ -139,6 +139,9 @@ LINKFLAGSRUNPATH_BRAND=-R\''$$ORIGIN:$$ORIGIN/../basis-link/program:$$ORIGIN/../
 LINKFLAGSRUNPATH_OXT=
 LINKFLAGS=-m64 -w -mt -z combreloc -PIC -temp=/tmp -norunpath -library=stlport4
 LINKCFLAGS=-m64 -w -mt -z combreloc -norunpath
+.IF "$(HAVE_WORKING_LD_AS_NEEDED)" == "TRUE"
+LINKFLAGS += -Wl,--as-needed
+.ENDIF
 
 # -z text force fatal error if non PIC code is linked into shared library. Such code
 #    would be expensive on startup
diff --git a/svx/util/makefile.mk b/svx/util/makefile.mk
index 490036c..ab964d3 100644
--- a/svx/util/makefile.mk
+++ b/svx/util/makefile.mk
@@ -230,7 +230,6 @@ SHL3STDLIBS= \
             $(I18NISOLANGLIB) \
             $(COMPHELPERLIB) \
             $(UCBHELPERLIB) \
-            $(CPPUHELPERLIB)        \
             $(CPPULIB) \
             $(VOSLIB) \
             $(SALLIB) \
@@ -244,6 +243,7 @@ SHL2STDLIBS += $(CPPUHELPERLIB)
 .IF "$(GUI)"=="WNT"
 SHL3STDLIBS+= \
              $(SHLWAPILIB) \
+             $(CPPUHELPERLIB) \
              $(ADVAPI32LIB)
 .ENDIF # WNT
 
diff --git a/unodevtools/source/skeletonmaker/makefile.mk b/unodevtools/source/skeletonmaker/makefile.mk
index 30a22d6..4b0de20 100644
--- a/unodevtools/source/skeletonmaker/makefile.mk
+++ b/unodevtools/source/skeletonmaker/makefile.mk
@@ -49,8 +49,9 @@ APP1OBJS = $(OBJ)$/skeletonmaker.obj \
 
 APP1DEPN= $(OUT)$/lib$/$(UNODEVTOOLSLIBDEPN) $(SOLARLIBDIR)$/$(CODEMAKERLIBDEPN) \
     $(SOLARLIBDIR)$/$(COMMONCPPLIBDEPN) $(SOLARLIBDIR)$/$(COMMONJAVALIBDEPN)
-APP1STDLIBS = $(REGLIB) $(SALLIB) $(SALHELPERLIB) $(CPPULIB) $(CPPUHELPERLIB) \
-    $(UNODEVTOOLSLIBST) $(CODEMAKERLIBST) $(COMMONCPPLIBST) $(COMMONJAVALIBST)
+APP1STDLIBS =\
+    $(UNODEVTOOLSLIBST) $(CODEMAKERLIBST) $(COMMONCPPLIBST) $(COMMONJAVALIBST)\
+    $(REGLIB) $(CPPULIB) $(CPPUHELPERLIB) $(SALHELPERLIB) $(SALLIB)
 
 OBJFILES = $(APP1OBJS)
 
-- 
1.7.0.1

