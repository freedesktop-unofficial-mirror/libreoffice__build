From c450a9106abd3152adb92bd4741038a6687f1f1c Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:55:34 +0200
Subject: [PATCH 164/878] sc-print-selected-sheets.diff

---
 sc/source/ui/inc/preview.hxx   |    2 ++
 sc/source/ui/view/preview.cxx  |   10 ++++++++++
 sc/source/ui/view/tabvwsh4.cxx |    5 +++++
 3 files changed, 17 insertions(+), 0 deletions(-)

diff --git a/sc/source/ui/inc/preview.hxx b/sc/source/ui/inc/preview.hxx
index a0bf3ee..bc0d9ae 100644
--- a/sc/source/ui/inc/preview.hxx
+++ b/sc/source/ui/inc/preview.hxx
@@ -63,6 +63,8 @@ private:
     ScPreviewLocationData* pLocationData;	// stores table layout for accessibility API
     FmFormView*		pDrawView;
 
+    SCTAB           nCurTab;
+
                                         // intern:
     BOOL			bInPaint;
     BOOL			bInGetState;
diff --git a/sc/source/ui/view/preview.cxx b/sc/source/ui/view/preview.cxx
index eda8e32..632817b 100644
--- a/sc/source/ui/view/preview.cxx
+++ b/sc/source/ui/view/preview.cxx
@@ -109,6 +109,7 @@ ScPreview::ScPreview( Window* pParent, ScDocShell* pDocSh, ScPreviewShell* pView
     bLocationValid( FALSE ),
     pLocationData( NULL ),
     pDrawView( NULL ),
+    nCurTab ( ScDocShell::GetCurTab() ),
     bInPaint( FALSE ),
     bInGetState( FALSE ),
     pDocShell( pDocSh ),
@@ -249,8 +250,17 @@ void ScPreview::CalcPages( SCTAB /*nToWhichTab*/ )
     //	but always all sheets are used (there is no selected sheet)
     ScPrintOptions aOptions = SC_MOD()->GetPrintOptions();
 
+    ScMarkData aMarkData;
+    aMarkData.SelectTable( nCurTab, TRUE );
+
     for (SCTAB i=nStart; i<nAnz; i++)
     {
+        if (!aOptions.GetAllSheets() && !aMarkData.GetTableSelect( i )) {
+            nPages[i] = 0;
+            nFirstAttr[i] = 0;
+            continue;
+        }
+
         long nAttrPage = i > 0 ? nFirstAttr[i-1] : 1;
 
         long nThisStart = nTotalPages;
diff --git a/sc/source/ui/view/tabvwsh4.cxx b/sc/source/ui/view/tabvwsh4.cxx
index 78ec931..df89404 100644
--- a/sc/source/ui/view/tabvwsh4.cxx
+++ b/sc/source/ui/view/tabvwsh4.cxx
@@ -1191,8 +1191,13 @@ PrintDialog* __EXPORT ScTabViewShell::CreatePrintDialog( Window *pParent )
     // instead of a separate progress for each sheet from ScPrintFunc
     pDocShell->UpdatePendingRowHeights( MAXTAB, true );
 
+    ScMarkData aMarkData;
+    aMarkData.SelectTable( GetViewData()->GetTabNo(), TRUE );
+
     for ( SCTAB i=0; i<nTabCount; i++ )
     {
+        if ( !bAllTabs && !aMarkData.GetTableSelect( i ) )
+            continue;
         ScPrintFunc aPrintFunc( pDocShell, pPrinter, i );
         nDocPageMax += aPrintFunc.GetTotalPages();
     }
-- 
1.7.0.1

