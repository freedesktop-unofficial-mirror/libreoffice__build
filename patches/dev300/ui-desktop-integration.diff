From dcfd76ac0c5df6d1bf89270a599a5ec1728deaa4 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:04:50 +0200
Subject: [PATCH 640/878] ui-desktop-integration.diff

---
 framework/source/uielement/toolbarmanager.cxx      |   21 +++++++++++-
 .../source/uielement/toolbarsmenucontroller.cxx    |    4 ++
 .../schema/org/openoffice/Office/Common.xcs        |    7 ++++
 sfx2/sdi/appslots.sdi                              |    1 +
 sfx2/source/appl/appserv.cxx                       |   13 +++++++
 svtools/inc/svtools/miscopt.hxx                    |    2 +
 svtools/source/config/miscopt.cxx                  |   34 ++++++++++++++++++-
 7 files changed, 79 insertions(+), 3 deletions(-)

diff --git a/framework/source/uielement/toolbarmanager.cxx b/framework/source/uielement/toolbarmanager.cxx
index 514eea7..0842be0 100644
--- a/framework/source/uielement/toolbarmanager.cxx
+++ b/framework/source/uielement/toolbarmanager.cxx
@@ -250,7 +250,7 @@ ToolBarManager::ToolBarManager( const Reference< XMultiServiceFactory >& rServic
     m_bUpdateControllers( sal_False ),
     m_bImageOrientationRegistered( sal_False ),
     m_bImageMirrored( sal_False ),
-    m_bCanBeCustomized( sal_True ),
+    m_bCanBeCustomized( !SvtMiscOptions().DisableUICustomization() ),
     m_lImageRotation( 0 ),
     m_pToolBar( pToolBar ),
     m_aResourceName( rResourceName ),
@@ -489,6 +489,24 @@ void ToolBarManager::UpdateControllers()
 {
     RTL_LOGFILE_CONTEXT( aLog, "framework (cd100003) ::ToolBarManager::UpdateControllers" );
 
+    if( !m_bCanBeCustomized )
+    {
+        Any a;
+        Reference< XLayoutManager > xLayoutManager;
+        Reference< XPropertySet > xFramePropSet( m_xFrame, UNO_QUERY );
+        if ( xFramePropSet.is() )
+            a = xFramePropSet->getPropertyValue( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( "LayoutManager" )));
+        a >>= xLayoutManager;
+        Reference< XDockableWindow > xDockable( VCLUnoHelper::GetInterface( m_pToolBar ), UNO_QUERY );
+        if ( xLayoutManager.is() && xDockable.is() )
+        {
+            ::com::sun::star::awt::Point aPoint;
+            aPoint.X = aPoint.Y = LONG_MAX;
+            xLayoutManager->dockWindow( m_aResourceName, DockingArea_DOCKINGAREA_DEFAULT, aPoint );
+            xLayoutManager->lockWindow( m_aResourceName );
+        }
+    }
+
     if ( !m_bUpdateControllers )
     {
         m_bUpdateControllers = sal_True;
@@ -1670,6 +1688,7 @@ PopupMenu * ToolBarManager::GetToolBarCustomMeun(ToolBox* pToolBar)
             // Non-configurable toolbars should disable configuration menu items
             aPopupMenu.EnableItem( MENUITEM_TOOLBAR_VISIBLEBUTTON, sal_False );
             aPopupMenu.EnableItem( MENUITEM_TOOLBAR_CUSTOMIZETOOLBAR, sal_False );
+            aPopupMenu.EnableItem( MENUITEM_TOOLBAR_LOCKTOOLBARPOSITION, sal_False );
         }
 
         // Disable menu item CLOSE if the toolbar has no closer
diff --git a/framework/source/uielement/toolbarsmenucontroller.cxx b/framework/source/uielement/toolbarsmenucontroller.cxx
index c438523..cb87cc5 100644
--- a/framework/source/uielement/toolbarsmenucontroller.cxx
+++ b/framework/source/uielement/toolbarsmenucontroller.cxx
@@ -80,6 +80,7 @@
 #include <svtools/cmdoptions.hxx>
 #include <dispatch/uieventloghelper.hxx>
 #include <rtl/logfile.hxx>
+#include <svtools/miscopt.hxx>
 
 //_________________________________________________________________________________________________________________
 //	Defines
@@ -377,6 +378,9 @@ sal_Bool ToolbarsMenuController::isContextSensitiveToolbarNonVisible()
 
 void ToolbarsMenuController::fillPopupMenu( Reference< css::awt::XPopupMenu >& rPopupMenu )
 {
+    if( SvtMiscOptions().DisableUICustomization() )
+        return;
+
     vos::OGuard aSolarMutexGuard( Application::GetSolarMutex() );
     resetPopupMenu( rPopupMenu );
 
diff --git a/officecfg/registry/schema/org/openoffice/Office/Common.xcs b/officecfg/registry/schema/org/openoffice/Office/Common.xcs
index 7a1f150..8cacadb 100644
--- a/officecfg/registry/schema/org/openoffice/Office/Common.xcs
+++ b/officecfg/registry/schema/org/openoffice/Office/Common.xcs
@@ -5750,6 +5750,13 @@ Dymamic border coloring means that when the mouse is hovered over a control, and
                 </info>
                 <value>false</value>
             </prop>
+            <prop oor:name="DisableUICustomization" oor:type="xs:boolean">
+                <info>
+                    <author>RSiddhartha</author>
+                    <desc>Disables the customization of the UI elements.</desc>
+                </info>
+                <value>false</value>
+            </prop>
 			<prop oor:name="SymbolSet" oor:type="xs:short">
 				<!-- UIHints: Tools  Options General View -->
 				<info>
diff --git a/sfx2/sdi/appslots.sdi b/sfx2/sdi/appslots.sdi
index 59b29e0..05f7e2f 100644
--- a/sfx2/sdi/appslots.sdi
+++ b/sfx2/sdi/appslots.sdi
@@ -181,6 +181,7 @@ interface Application
     SID_AVAILABLE_TOOLBARS
     [
         ExecMethod = MiscExec_Impl ;
+        StateMethod = MiscState_Impl ;
     ]
     SID_HELP_TUTORIALS
     [
diff --git a/sfx2/source/appl/appserv.cxx b/sfx2/source/appl/appserv.cxx
index 752d3d1..d204df3 100644
--- a/sfx2/source/appl/appserv.cxx
+++ b/sfx2/source/appl/appserv.cxx
@@ -87,6 +87,7 @@
 #include <svtools/moduleoptions.hxx>
 #include <svtools/regoptions.hxx>
 #include <svtools/helpopt.hxx>
+#include <svtools/miscopt.hxx>
 #include <toolkit/helper/vclunohelper.hxx>
 #include <tools/shl.hxx>
 #include <unotools/bootstrap.hxx>
@@ -694,6 +695,18 @@ void SfxApplication::MiscState_Impl(SfxItemSet &rSet)
                     break;
                 }
 
+                case SID_CONFIG:
+                case SID_TOOLBOXOPTIONS:
+                case SID_CONFIGSTATUSBAR:
+                case SID_CONFIGMENU:
+                case SID_CONFIGACCEL:
+                case SID_CONFIGEVENT:
+                {
+                    if( SvtMiscOptions().DisableUICustomization() )
+                        rSet.DisableItem(nWhich);
+                    break;
+                }
+
                 case SID_BASICSTOP:
                     if ( !StarBASIC::IsRunning() )
                         rSet.DisableItem(nWhich);
diff --git a/svtools/inc/svtools/miscopt.hxx b/svtools/inc/svtools/miscopt.hxx
index ed84a2d..2c4dafb 100644
--- a/svtools/inc/svtools/miscopt.hxx
+++ b/svtools/inc/svtools/miscopt.hxx
@@ -114,6 +114,8 @@ class SVT_DLLPUBLIC SvtMiscOptions: public svt::detail::Options
         void        SetTryODMADialog( sal_Bool bSet );
         sal_Bool    IsTryUseODMADialogReadOnly() const;
 
+        sal_Bool    DisableUICustomization() const;
+
         sal_Bool    IsPluginsEnabled() const;
         void        SetPluginsEnabled( sal_Bool bEnable );
         sal_Bool    IsPluginsEnabledReadOnly() const;
diff --git a/svtools/source/config/miscopt.cxx b/svtools/source/config/miscopt.cxx
index 784461c..c6cb486 100644
--- a/svtools/source/config/miscopt.cxx
+++ b/svtools/source/config/miscopt.cxx
@@ -86,8 +86,10 @@ using namespace ::com::sun::star;
 #define PROPERTYHANDLE_TRYODMADIALOG	6
 #define PROPERTYNAME_SHOWLINKWARNINGDIALOG	ASCII_STR("ShowLinkWarningDialog")
 #define PROPERTYHANDLE_SHOWLINKWARNINGDIALOG 7
+#define PROPERTYNAME_DISABLEUICUSTOMIZATION	ASCII_STR("DisableUICustomization")
+#define PROPERTYHANDLE_DISABLEUICUSTOMIZATION			8
 
-#define PROPERTYCOUNT						8
+#define PROPERTYCOUNT						9
 
 #define VCL_TOOLBOX_STYLE_FLAT				((USHORT)0x0004) // from <vcl/toolbox.hxx>
 
@@ -120,6 +122,7 @@ class SvtMiscOptions_Impl : public ConfigItem
     sal_Bool    m_bIsUseSystemPrintDialogRO;
     sal_Bool    m_bShowLinkWarningDialog;
     sal_Bool    m_bIsShowLinkWarningDialogRO;
+    sal_Bool    m_bDisableUICustomization;
 
     //-------------------------------------------------------------------------------------------------------------
     //	public methods
@@ -197,6 +200,9 @@ class SvtMiscOptions_Impl : public ConfigItem
         inline sal_Bool IsTryUseODMADialogReadOnly() const
         { return m_bIsTryODMADialogRO; }
 
+        inline sal_Bool DisableUICustomization() const
+        { return m_bDisableUICustomization; }
+
         inline sal_Bool IsPluginsEnabled() const
         { return m_bPluginsEnabled; }
 
@@ -447,6 +453,13 @@ SvtMiscOptions_Impl::SvtMiscOptions_Impl()
                 m_bIsSymbolsStyleRO = seqRO[nProperty];
                 break;
             }
+
+            case PROPERTYHANDLE_DISABLEUICUSTOMIZATION :
+            {
+                if( !(seqValues[nProperty] >>= m_bDisableUICustomization) )
+                    DBG_ERROR("Wrong type of \"Misc\\DisableUICustomization\"!" );
+                    break;
+            }
         }
     }
 
@@ -562,6 +575,11 @@ void SvtMiscOptions_Impl::Load( const Sequence< OUString >& rPropertyNames )
                                                             }
                                                         }
                                                     break;
+            case PROPERTYHANDLE_DISABLEUICUSTOMIZATION      :   {
+                                                            if( !(seqValues[nProperty] >>= m_bDisableUICustomization) )
+                                                                DBG_ERROR("Wrong type of \"Misc\\DisableUICustomization\"!" );
+                                                        }
+                                                    break;
         }
     }
 }
@@ -725,6 +743,12 @@ void SvtMiscOptions_Impl::Commit()
                     seqValues[nProperty] <<= m_bShowLinkWarningDialog;
                 break;
             }
+
+            case PROPERTYHANDLE_DISABLEUICUSTOMIZATION :
+            {
+                seqValues[nProperty] <<= m_bDisableUICustomization;
+                break;
+            }
         }
     }
     // Set properties in configuration.
@@ -746,7 +770,8 @@ Sequence< OUString > SvtMiscOptions_Impl::GetPropertyNames()
         PROPERTYNAME_SYMBOLSTYLE,
         PROPERTYNAME_USESYSTEMPRINTDIALOG,
         PROPERTYNAME_TRYODMADIALOG,
-        PROPERTYNAME_SHOWLINKWARNINGDIALOG
+        PROPERTYNAME_SHOWLINKWARNINGDIALOG,
+        PROPERTYNAME_DISABLEUICUSTOMIZATION
     };
 
     // Initialize return sequence with these list ...
@@ -907,6 +932,11 @@ sal_Bool SvtMiscOptions::IsGetSymbolsStyleReadOnly() const
     return m_pDataContainer->IsGetSymbolsStyleReadOnly();
 }
 
+sal_Bool SvtMiscOptions::DisableUICustomization() const
+{
+    return m_pDataContainer->DisableUICustomization();
+}
+
 sal_Int16 SvtMiscOptions::GetToolboxStyle() const
 {
     return m_pDataContainer->GetToolboxStyle();
-- 
1.7.0.1

