From e27deccf5f95b512c53f52d4859a6f89b3ddc82e Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:08:17 +0200
Subject: [PATCH 711/768] calc-insert-current-time-sc.diff

---
 sc/inc/globstr.hrc             |    5 +++-
 sc/inc/sc.hrc                  |    3 ++
 sc/sdi/cellsh.sdi              |    2 +
 sc/sdi/scalc.sdi               |   51 ++++++++++++++++++++++++++++++++++++++++
 sc/source/ui/inc/viewfunc.hxx  |    2 +
 sc/source/ui/src/globstr.src   |    8 ++++++
 sc/source/ui/view/cellsh1.cxx  |    8 ++++++
 sc/source/ui/view/viewfun6.cxx |   26 ++++++++++++++++++++
 8 files changed, 104 insertions(+), 1 deletions(-)

diff --git sc/inc/globstr.hrc sc/inc/globstr.hrc
index 339eed3..f478f10 100644
--- sc/inc/globstr.hrc
+++ sc/inc/globstr.hrc
@@ -579,7 +579,10 @@
 
 #define STR_OPTIONS_WARN_SEPARATORS 440
 
-#define STR_COUNT                   441
+#define STR_UNDO_INSERT_CURRENT_DATE 441
+#define STR_UNDO_INSERT_CURRENT_TIME 442
+
+#define STR_COUNT                   443
 
 #endif
 
diff --git sc/inc/sc.hrc sc/inc/sc.hrc
index 3f6eab6..dc3c0b8 100644
--- sc/inc/sc.hrc
+++ sc/inc/sc.hrc
@@ -1678,6 +1678,9 @@
 #define RID_SCPAGE_FORMULA          (SC_OOO_BUILD_START + 3)
 #define HID_SCPAGE_FORMULA          (SC_OOO_BUILD_START + 4)
 
+#define SID_INSERT_CURRENT_DATE     (SC_OOO_BUILD_START + 5)
+#define SID_INSERT_CURRENT_TIME     (SC_OOO_BUILD_START + 6)
+
 #endif
 
 
diff --git sc/sdi/cellsh.sdi sc/sdi/cellsh.sdi
index 9b9efea..926636a 100644
--- sc/sdi/cellsh.sdi
+++ sc/sdi/cellsh.sdi
@@ -114,6 +114,8 @@ interface CellSelection
     SID_DETECTIVE_REFRESH	[ ExecMethod = ExecuteEdit; StateMethod = GetState; ]
     SID_DETECTIVE_MARK_PRED	[ ExecMethod = ExecuteEdit; StateMethod = GetState; ]
     SID_DETECTIVE_MARK_SUCC	[ ExecMethod = ExecuteEdit; StateMethod = GetState; ]
+    SID_INSERT_CURRENT_DATE     [ ExecMethod = ExecuteEdit; StateMethod = GetState; ]
+    SID_INSERT_CURRENT_TIME     [ ExecMethod = ExecuteEdit; StateMethod = GetState; ]
     FID_INS_ROW				[ ExecMethod = ExecuteEdit; StateMethod = GetBlockState; ]
     FID_INS_COLUMN			[ ExecMethod = ExecuteEdit; StateMethod = GetBlockState; ]
     FID_INS_CELLSDOWN		[ ExecMethod = ExecuteEdit; StateMethod = GetBlockState; ]
diff --git sc/sdi/scalc.sdi sc/sdi/scalc.sdi
index 75251bb..11589b6 100644
--- sc/sdi/scalc.sdi
+++ sc/sdi/scalc.sdi
@@ -7926,6 +7926,57 @@ SfxVoidItem MarkDependents SID_DETECTIVE_MARK_SUCC
     ToolBoxConfig = FALSE,
     GroupId = GID_OPTIONS;
 ]
+
+//--------------------------------------------------------------------------
+SfxVoidItem InsertCurrentDate SID_INSERT_CURRENT_DATE
+()
+[
+    /* flags: */
+    AutoUpdate = FALSE,
+    Cachable = Cachable,
+    FastCall = FALSE,
+    HasCoreId = FALSE,
+    HasDialog = FALSE,
+    ReadOnlyDoc = TRUE,
+    Toggle = FALSE,
+    Container = FALSE,
+    RecordAbsolute = FALSE,
+    RecordPerSet;
+    Synchron;
+
+    /* config: */
+    AccelConfig = TRUE,
+    MenuConfig = TRUE,
+    StatusBarConfig = FALSE,
+    ToolBoxConfig = FALSE,
+    GroupId = GID_OPTIONS;
+]
+
+//--------------------------------------------------------------------------
+SfxVoidItem InsertCurrentTime SID_INSERT_CURRENT_TIME
+()
+[
+    /* flags: */
+    AutoUpdate = FALSE,
+    Cachable = Cachable,
+    FastCall = FALSE,
+    HasCoreId = FALSE,
+    HasDialog = FALSE,
+    ReadOnlyDoc = TRUE,
+    Toggle = FALSE,
+    Container = FALSE,
+    RecordAbsolute = FALSE,
+    RecordPerSet;
+    Synchron;
+
+    /* config: */
+    AccelConfig = TRUE,
+    MenuConfig = TRUE,
+    StatusBarConfig = FALSE,
+    ToolBoxConfig = FALSE,
+    GroupId = GID_OPTIONS;
+]
+
 //--------------------------------------------------------------------------
 SfxVoidItem SetTabBgColor FID_TAB_MENU_SET_TAB_BG_COLOR
 (SvxColorItem TabBgColor FID_TAB_SET_TAB_BG_COLOR)
diff --git sc/source/ui/inc/viewfunc.hxx sc/source/ui/inc/viewfunc.hxx
index 03fbf1b..4b4103b 100644
--- sc/source/ui/inc/viewfunc.hxx
+++ sc/source/ui/inc/viewfunc.hxx
@@ -331,6 +331,8 @@ public:
     void            DetectiveMarkPred();
     void            DetectiveMarkSucc();
 
+    void            InsertCurrentTime(short nCellFmt, const ::rtl::OUString& rUndoStr);
+
     void			ShowNote( bool bShow = true );
     inline void		HideNote() { ShowNote( false ); }
     void			EditNote();
diff --git sc/source/ui/src/globstr.src sc/source/ui/src/globstr.src
index 8fdad4f..7ce35ae 100644
--- sc/source/ui/src/globstr.src
+++ sc/source/ui/src/globstr.src
@@ -1746,5 +1746,13 @@ Resource RID_GLOBSTR
     {
         Text [ en-US ] = "Because the current formula separator settings conflict with the locale, the formula separators have been reset to their default values.";
     };
+    String STR_UNDO_INSERT_CURRENT_DATE
+    {
+        Text [ en-US ] = "Insert Current Date";
+    };
+    String STR_UNDO_INSERT_CURRENT_TIME
+    {
+        Text [ en-US ] = "Insert Current Time";
+    };
 };
 
diff --git sc/source/ui/view/cellsh1.cxx sc/source/ui/view/cellsh1.cxx
index 4282c14..7da17ef 100644
--- sc/source/ui/view/cellsh1.cxx
+++ sc/source/ui/view/cellsh1.cxx
@@ -1554,6 +1554,14 @@ void ScCellShell::ExecuteEdit( SfxRequest& rReq )
         case SID_DETECTIVE_MARK_SUCC:
             pTabViewShell->DetectiveMarkSucc();
             break;
+        case SID_INSERT_CURRENT_DATE:
+            pTabViewShell->InsertCurrentTime(
+                NUMBERFORMAT_DATE, ScGlobal::GetRscString(STR_UNDO_INSERT_CURRENT_DATE));
+            break;
+        case SID_INSERT_CURRENT_TIME:
+            pTabViewShell->InsertCurrentTime(
+                NUMBERFORMAT_TIME, ScGlobal::GetRscString(STR_UNDO_INSERT_CURRENT_TIME));
+            break;
 
         case SID_SPELL_DIALOG:
 //           pTabViewShell->DoSpellingChecker();
diff --git sc/source/ui/view/viewfun6.cxx sc/source/ui/view/viewfun6.cxx
index ce62dd0..736f363 100644
--- sc/source/ui/view/viewfun6.cxx
+++ sc/source/ui/view/viewfun6.cxx
@@ -34,6 +34,7 @@
 #include <sfx2/dispatch.hxx>
 #include <vcl/msgbox.hxx>
 #include <vcl/sound.hxx>
+#include "svl/zforlist.hxx"
 
 #include "viewfunc.hxx"
 #include "detfunc.hxx"
@@ -49,12 +50,16 @@
 #include "fusel.hxx"
 #include "reftokenhelper.hxx"
 #include "externalrefmgr.hxx"
+#include "cell.hxx"
 
 #include <vector>
 
+using ::rtl::OUString;
 using ::rtl::OUStringBuffer;
 using ::std::vector;
 
+#define D_TIMEFACTOR              86400.0
+
 //==================================================================
 
 void ScViewFunc::DetectiveAddPred()
@@ -274,6 +279,27 @@ void ScViewFunc::DetectiveMarkSucc()
     MarkAndJumpToRanges(aDestRanges);
 }
 
+void ScViewFunc::InsertCurrentTime(short nCellFmt, const OUString& rUndoStr)
+{
+    ScViewData* pViewData = GetViewData();
+    ScAddress aCurPos = pViewData->GetCurPos();
+    ScDocShell* pDocSh = pViewData->GetDocShell();
+    ScDocument* pDoc = pDocSh->GetDocument();
+    SfxUndoManager* pUndoMgr = pDocSh->GetUndoManager();
+    SvNumberFormatter* pFormatter = pDoc->GetFormatTable();
+    Date aActDate;
+    double fDate = aActDate - *pFormatter->GetNullDate();
+    Time aActTime;
+    double fTime =
+        aActTime.Get100Sec() / 100.0 + aActTime.GetSec() +
+        (aActTime.GetMin() * 60.0) + (aActTime.GetHour() * 3600.0);
+    fTime /= D_TIMEFACTOR;
+    pUndoMgr->EnterListAction(rUndoStr, rUndoStr);
+    pDocSh->GetDocFunc().PutCell(aCurPos, new ScValueCell(fDate+fTime), false);
+    SetNumberFormat(nCellFmt);
+    pUndoMgr->LeaveListAction();
+}
+
 //---------------------------------------------------------------------------
 
 void ScViewFunc::ShowNote( bool bShow )
-- 
1.7.0.1

