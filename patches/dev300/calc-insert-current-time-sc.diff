From e6d7fd8b51faa0091fb4cdf44b304ce430d699a3 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:08:17 +0200
Subject: [PATCH 807/878] calc-insert-current-time-sc.diff

---
 sc/inc/globstr.hrc             |    5 +++-
 sc/inc/sc.hrc                  |    3 ++
 sc/sdi/cellsh.sdi              |    2 +
 sc/sdi/scalc.sdi               |   51 ++++++++++++++++++++++++++++++++++++++++
 sc/source/ui/inc/viewfunc.hxx  |    2 +
 sc/source/ui/src/globstr.src   |    8 ++++++
 sc/source/ui/view/cellsh1.cxx  |    8 ++++++
 sc/source/ui/view/viewfun6.cxx |   26 ++++++++++++++++++++
 8 files changed, 104 insertions(+), 1 deletions(-)

diff --git a/sc/inc/globstr.hrc b/sc/inc/globstr.hrc
index 440195b..ce83885 100644
--- a/sc/inc/globstr.hrc
+++ b/sc/inc/globstr.hrc
@@ -591,7 +591,10 @@
 
 #define STR_OPTIONS_WARN_SEPARATORS 451
 
-#define STR_COUNT                   452
+#define STR_UNDO_INSERT_CURRENT_DATE 452
+#define STR_UNDO_INSERT_CURRENT_TIME 453
+
+#define STR_COUNT                   454
 
 #endif
 
diff --git a/sc/inc/sc.hrc b/sc/inc/sc.hrc
index 4543282..1003057 100644
--- a/sc/inc/sc.hrc
+++ b/sc/inc/sc.hrc
@@ -1675,6 +1675,9 @@
 #define SID_DATA_FORM               (SC_OOO_BUILD_START + 6) // menu (in Data menu)
 #define RID_SCDLG_DATAFORM          (SC_OOO_BUILD_START + 7) // dialog
 
+#define SID_INSERT_CURRENT_DATE     (SC_OOO_BUILD_START + 8)
+#define SID_INSERT_CURRENT_TIME     (SC_OOO_BUILD_START + 9)
+
 #endif
 
 
diff --git a/sc/sdi/cellsh.sdi b/sc/sdi/cellsh.sdi
index 7e6813b..c06d238 100644
--- a/sc/sdi/cellsh.sdi
+++ b/sc/sdi/cellsh.sdi
@@ -112,6 +112,8 @@ interface CellSelection
     SID_DETECTIVE_REFRESH	[ ExecMethod = ExecuteEdit; StateMethod = GetState; ]
     SID_DETECTIVE_MARK_PRED	[ ExecMethod = ExecuteEdit; StateMethod = GetState; ]
     SID_DETECTIVE_MARK_SUCC	[ ExecMethod = ExecuteEdit; StateMethod = GetState; ]
+    SID_INSERT_CURRENT_DATE     [ ExecMethod = ExecuteEdit; StateMethod = GetState; ]
+    SID_INSERT_CURRENT_TIME     [ ExecMethod = ExecuteEdit; StateMethod = GetState; ]
     FID_INS_ROW				[ ExecMethod = ExecuteEdit; StateMethod = GetBlockState; ]
     FID_INS_COLUMN			[ ExecMethod = ExecuteEdit; StateMethod = GetBlockState; ]
     FID_INS_CELLSDOWN		[ ExecMethod = ExecuteEdit; StateMethod = GetBlockState; ]
diff --git a/sc/sdi/scalc.sdi b/sc/sdi/scalc.sdi
index 5b6f236..9bcd362 100644
--- a/sc/sdi/scalc.sdi
+++ b/sc/sdi/scalc.sdi
@@ -7924,6 +7924,57 @@ SfxVoidItem MarkDependents SID_DETECTIVE_MARK_SUCC
     ToolBoxConfig = FALSE,
     GroupId = GID_OPTIONS;
 ]
+
+//--------------------------------------------------------------------------
+SfxVoidItem InsertCurrentDate SID_INSERT_CURRENT_DATE
+()
+[
+    /* flags: */
+    AutoUpdate = FALSE,
+    Cachable = Cachable,
+    FastCall = FALSE,
+    HasCoreId = FALSE,
+    HasDialog = FALSE,
+    ReadOnlyDoc = TRUE,
+    Toggle = FALSE,
+    Container = FALSE,
+    RecordAbsolute = FALSE,
+    RecordPerSet;
+    Synchron;
+
+    /* config: */
+    AccelConfig = TRUE,
+    MenuConfig = TRUE,
+    StatusBarConfig = FALSE,
+    ToolBoxConfig = FALSE,
+    GroupId = GID_OPTIONS;
+]
+
+//--------------------------------------------------------------------------
+SfxVoidItem InsertCurrentTime SID_INSERT_CURRENT_TIME
+()
+[
+    /* flags: */
+    AutoUpdate = FALSE,
+    Cachable = Cachable,
+    FastCall = FALSE,
+    HasCoreId = FALSE,
+    HasDialog = FALSE,
+    ReadOnlyDoc = TRUE,
+    Toggle = FALSE,
+    Container = FALSE,
+    RecordAbsolute = FALSE,
+    RecordPerSet;
+    Synchron;
+
+    /* config: */
+    AccelConfig = TRUE,
+    MenuConfig = TRUE,
+    StatusBarConfig = FALSE,
+    ToolBoxConfig = FALSE,
+    GroupId = GID_OPTIONS;
+]
+
 //--------------------------------------------------------------------------
 SfxVoidItem SetTabBgColor FID_TAB_MENU_SET_TAB_BG_COLOR
 (SvxColorItem TabBgColor FID_TAB_SET_TAB_BG_COLOR)
diff --git a/sc/source/ui/inc/viewfunc.hxx b/sc/source/ui/inc/viewfunc.hxx
index bf62924..6192493 100644
--- a/sc/source/ui/inc/viewfunc.hxx
+++ b/sc/source/ui/inc/viewfunc.hxx
@@ -331,6 +331,8 @@ public:
     void            DetectiveMarkPred();
     void            DetectiveMarkSucc();
 
+    void            InsertCurrentTime(short nCellFmt, const ::rtl::OUString& rUndoStr);
+
     void			ShowNote( bool bShow = true );
     inline void		HideNote() { ShowNote( false ); }
     void			EditNote();
diff --git a/sc/source/ui/src/globstr.src b/sc/source/ui/src/globstr.src
index 936b020..ff82042 100644
--- a/sc/source/ui/src/globstr.src
+++ b/sc/source/ui/src/globstr.src
@@ -1805,5 +1805,13 @@ Resource RID_GLOBSTR
     {
         Text [ en-US ] = "Because the current formula separator settings conflict with the locale, the formula separators have been reset to their default values.";
     };
+    String STR_UNDO_INSERT_CURRENT_DATE
+    {
+        Text [ en-US ] = "Insert Current Date";
+    };
+    String STR_UNDO_INSERT_CURRENT_TIME
+    {
+        Text [ en-US ] = "Insert Current Time";
+    };
 };
 
diff --git a/sc/source/ui/view/cellsh1.cxx b/sc/source/ui/view/cellsh1.cxx
index b181384..67c7519 100644
--- a/sc/source/ui/view/cellsh1.cxx
+++ b/sc/source/ui/view/cellsh1.cxx
@@ -1554,6 +1554,14 @@ void ScCellShell::ExecuteEdit( SfxRequest& rReq )
         case SID_DETECTIVE_MARK_SUCC:
             pTabViewShell->DetectiveMarkSucc();
             break;
+        case SID_INSERT_CURRENT_DATE:
+            pTabViewShell->InsertCurrentTime(
+                NUMBERFORMAT_DATE, ScGlobal::GetRscString(STR_UNDO_INSERT_CURRENT_DATE));
+            break;
+        case SID_INSERT_CURRENT_TIME:
+            pTabViewShell->InsertCurrentTime(
+                NUMBERFORMAT_TIME, ScGlobal::GetRscString(STR_UNDO_INSERT_CURRENT_TIME));
+            break;
 
         case SID_SPELL_DIALOG:
 //           pTabViewShell->DoSpellingChecker();
diff --git a/sc/source/ui/view/viewfun6.cxx b/sc/source/ui/view/viewfun6.cxx
index b23f4d4..ab7225b 100644
--- a/sc/source/ui/view/viewfun6.cxx
+++ b/sc/source/ui/view/viewfun6.cxx
@@ -34,6 +34,7 @@
 #include <sfx2/dispatch.hxx>
 #include <vcl/msgbox.hxx>
 #include <vcl/sound.hxx>
+#include "svtools/zforlist.hxx"
 
 #include "viewfunc.hxx"
 #include "detfunc.hxx"
@@ -49,12 +50,16 @@
 #include "fusel.hxx"
 #include "reftokenhelper.hxx"
 #include "externalrefmgr.hxx"
+#include "cell.hxx"
 
 #include <vector>
 
+using ::rtl::OUString;
 using ::rtl::OUStringBuffer;
 using ::std::vector;
 
+#define D_TIMEFACTOR              86400.0
+
 //==================================================================
 
 void ScViewFunc::DetectiveAddPred()
@@ -274,6 +279,27 @@ void ScViewFunc::DetectiveMarkSucc()
     MarkAndJumpToRanges(aDestRanges);
 }
 
+void ScViewFunc::InsertCurrentTime(short nCellFmt, const OUString& rUndoStr)
+{
+    ScViewData* pViewData = GetViewData();
+    ScAddress aCurPos = pViewData->GetCurPos();
+    ScDocShell* pDocSh = pViewData->GetDocShell();
+    ScDocument* pDoc = pDocSh->GetDocument();
+    SfxUndoManager* pUndoMgr = pDocSh->GetUndoManager();
+    SvNumberFormatter* pFormatter = pDoc->GetFormatTable();
+    Date aActDate;
+    double fDate = aActDate - *pFormatter->GetNullDate();
+    Time aActTime;
+    double fTime =
+        aActTime.Get100Sec() / 100.0 + aActTime.GetSec() +
+        (aActTime.GetMin() * 60.0) + (aActTime.GetHour() * 3600.0);
+    fTime /= D_TIMEFACTOR;
+    pUndoMgr->EnterListAction(rUndoStr, rUndoStr);
+    pDocSh->GetDocFunc().PutCell(aCurPos, new ScValueCell(fDate+fTime), false);
+    SetNumberFormat(nCellFmt);
+    pUndoMgr->LeaveListAction();
+}
+
 //---------------------------------------------------------------------------
 
 void ScViewFunc::ShowNote( bool bShow )
-- 
1.7.0.1

