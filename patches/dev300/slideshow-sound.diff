---
 slideshow/source/engine/shapes/mediashape.cxx  |   26 ++++++++--
 slideshow/source/engine/slide/layermanager.cxx |   22 +++++++++
 slideshow/source/engine/slide/layermanager.hxx |    4 ++
 slideshow/source/engine/slide/slideimpl.cxx    |   23 +++++++++
 slideshow/source/engine/slideshowimpl.cxx      |   61 ++++++++++++++++++++++-
 slideshow/source/inc/shape.hxx                 |   10 ++++
 slideshow/source/inc/slide.hxx                 |    3 +
 7 files changed, 141 insertions(+), 8 deletions(-)

diff --git slideshow/source/engine/shapes/mediashape.cxx slideshow/source/engine/shapes/mediashape.cxx
index e98c4ed..9268d9c 100644
--- slideshow/source/engine/shapes/mediashape.cxx
+++ slideshow/source/engine/shapes/mediashape.cxx
@@ -98,6 +98,8 @@ namespace slideshow
             virtual bool implIsIntrinsicAnimationPlaying() const;
             virtual void implSetIntrinsicAnimationTime(double);
 
+        sal_uInt16 getSlidesNumber();
+
             /// the list of active view shapes (one for each registered view layer)
             typedef ::std::vector< ViewMediaShapeSharedPtr > ViewMediaShapeVector;
             ViewMediaShapeVector                             maViewMediaShapes;
@@ -114,6 +116,17 @@ namespace slideshow
         {
         }
 
+    sal_uInt16 MediaShape::getSlidesNumber()
+    {
+        uno::Reference< beans::XPropertySet > xPropSet( getXShape(), uno::UNO_QUERY );
+        sal_uInt16 nSlidesNumber = 1;
+
+        if( xPropSet.is() )
+        xPropSet->getPropertyValue( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( "MediaSlidesNumber" ) ) ) >>= nSlidesNumber;
+
+        return nSlidesNumber;
+    }
+
         // ---------------------------------------------------------------------		
 
         void MediaShape::implViewChanged( const UnoViewSharedPtr& rView )
@@ -199,7 +212,8 @@ namespace slideshow
         
         bool MediaShape::clearAllViewLayers()
         {
-            maViewMediaShapes.clear();
+        if( getSlidesNumber() <= 1 )
+        maViewMediaShapes.clear();
             return true;
         }
 
@@ -241,11 +255,13 @@ namespace slideshow
         
         bool MediaShape::implEndIntrinsicAnimation()
         {
-            ::std::for_each( maViewMediaShapes.begin(),
-                             maViewMediaShapes.end(),
-                             ::boost::mem_fn( &ViewMediaShape::endMedia ) );
+        if( getSlidesNumber() <= 1 ) {
+        ::std::for_each( maViewMediaShapes.begin(),
+                 maViewMediaShapes.end(),
+                 ::boost::mem_fn( &ViewMediaShape::endMedia ) );
 
-            mbIsPlaying = false;
+        mbIsPlaying = false;
+        }
 
             return true;
         }
diff --git slideshow/source/engine/slide/layermanager.cxx slideshow/source/engine/slide/layermanager.cxx
index 85fc047..8b739c1 100644
--- slideshow/source/engine/slide/layermanager.cxx
+++ slideshow/source/engine/slide/layermanager.cxx
@@ -292,6 +292,28 @@ namespace slideshow
             implAddShape( rShape );
         }
 
+    void LayerManager::findPersistentMediaShapes( ShapeList& rList )
+    {
+        for( XShapeHash::iterator it = maXShapeHash.begin(); it != maXShapeHash.end(); it ++) {
+        uno::Reference< beans::XPropertySet > xPropSet( (*it).first, uno::UNO_QUERY );
+        if( xPropSet.is() ) {
+            sal_uInt16 nSlidesNumber = 1;
+
+            try {
+            xPropSet->getPropertyValue( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( "MediaSlidesNumber" ) ) ) >>= nSlidesNumber;
+
+            if( nSlidesNumber > 1 ) {
+                ShapeRefSharedPtr pShapeRef( new ShapeRef() );
+
+                pShapeRef->pShape = (*it).second;
+                pShapeRef->nSlidesNumber = nSlidesNumber;
+                rList.push_back( pShapeRef );
+            }
+            } catch( uno::Exception& ) {}
+        }
+        }
+    }
+
         void LayerManager::putShape2BackgroundLayer( LayerShapeMap::value_type& rShapeEntry )
         {
             LayerSharedPtr& rBgLayer( maLayers.front() );
diff --git slideshow/source/engine/slide/layermanager.hxx slideshow/source/engine/slide/layermanager.hxx
index 90c5413..5da40b9 100644
--- slideshow/source/engine/slide/layermanager.hxx
+++ slideshow/source/engine/slide/layermanager.hxx
@@ -144,6 +144,10 @@ namespace slideshow
             ShapeSharedPtr lookupShape( const ::com::sun::star::uno::Reference< 
                                            ::com::sun::star::drawing::XShape >& xShape ) const;
 
+        /** lookup persistent media shapes
+         */
+        void findPersistentMediaShapes( ShapeList& rList );
+
             /** Query a subset of the given original shape
 
                 This method queries a new (but not necessarily unique)
diff --git slideshow/source/engine/slide/slideimpl.cxx slideshow/source/engine/slide/slideimpl.cxx
index eb8ce0c..b2bf3da 100644
--- slideshow/source/engine/slide/slideimpl.cxx
+++ slideshow/source/engine/slide/slideimpl.cxx
@@ -144,6 +144,7 @@ public:
     // but on canvas-independent basegfx bitmaps
     virtual SlideBitmapSharedPtr getCurrentSlideBitmap( const UnoViewSharedPtr& rView ) const;
 
+    virtual void findPersistentMediaShapes( ShapeList& rList );
 
 private:
     // ViewEventHandler
@@ -1279,6 +1280,28 @@ SlideSharedPtr createSlide( const uno::Reference< drawing::XDrawPage >&			xDrawP
     return pRet;
 }
 
+void SlideImpl::findPersistentMediaShapes( ShapeList& rList )
+{
+    if( mpLayerManager ) {
+    ShapeList aList;
+    mpLayerManager->findPersistentMediaShapes( aList );
+
+    uno::Reference< beans::XPropertySet > xPropSet( mxDrawPage, uno::UNO_QUERY_THROW );
+    sal_Int16 nPageNumber = 0;
+    if( xPropSet.is() ) {
+        xPropSet->getPropertyValue( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( "Number" ) ) ) >>= nPageNumber;
+    }
+
+    for( ShapeList::iterator it = aList.begin(); it != aList.end(); it++ ) {
+        ShapeRefSharedPtr pShapeRef = *it;
+
+        pShapeRef->nPageNumber = nPageNumber;
+    }
+
+    rList.merge( aList );
+    }
+}
+
 } // namespace internal
 } // namespace slideshow
 
diff --git slideshow/source/engine/slideshowimpl.cxx slideshow/source/engine/slideshowimpl.cxx
index e84f143..533e294 100644
--- slideshow/source/engine/slideshowimpl.cxx
+++ slideshow/source/engine/slideshowimpl.cxx
@@ -344,6 +344,9 @@ private:
         uno::Reference<drawing::XShape> const& xShape, sal_Int16 nPointerShape )
         throw (uno::RuntimeException);
 
+    // update persistent media shapes after current slide changes
+    void updateMediaShapes();
+ 
     // CursorManager
     // -----------------------------------------------------------
 
@@ -468,6 +470,7 @@ private:
     //end changed
     
     boost::shared_ptr<canvas::tools::ElapsedTime> mpPresTimer;
+    boost::shared_ptr<canvas::tools::ElapsedTime> mpAdvanceTimer;
     ScreenUpdater                           maScreenUpdater;
     EventQueue                              maEventQueue;
     EventMultiplexer                        maEventMultiplexer;
@@ -514,6 +517,9 @@ private:
 
     EffectRewinder                          maEffectRewinder;
     FrameSynchronization                    maFrameSynchronization;
+
+    // list of persisten media shapes
+    ShapeList maMediaShapes;
 };
 
 /** Separate event listener for animation, view and hyperlink events.
@@ -590,6 +596,7 @@ SlideShowImpl::SlideShowImpl(
       maUserPaintColor(),
       maUserPaintStrokeWidth(4.0),
       mpPresTimer( new canvas::tools::ElapsedTime ),
+      mpAdvanceTimer( new canvas::tools::ElapsedTime ),
       maScreenUpdater(maViewContainer),
       maEventQueue( mpPresTimer ),
       maEventMultiplexer( maEventQueue,
@@ -664,6 +671,9 @@ void SlideShowImpl::disposing()
 
     maEffectRewinder.dispose();
     
+    // drop all references to persistent media shapes
+    maMediaShapes.clear();
+
     // stop slide transition sound, if any:
     stopSlideTransitionSound();
 
@@ -1095,6 +1105,33 @@ private:
     bool& mrbSkipSlideTransition;
 };
 
+class media_shape_ptr_is_empty
+{
+public:
+    bool operator() (const ShapeRefSharedPtr& value) { return !value->pShape.get(); }
+};
+
+void SlideShowImpl::updateMediaShapes()
+{
+    mpCurrentSlide->findPersistentMediaShapes( maMediaShapes );
+
+    uno::Reference<beans::XPropertySet> xPropSet( mpCurrentSlide->getXDrawPage(), uno::UNO_QUERY );
+    if( xPropSet.is() ) {
+    sal_Int16 nPageNumber;
+    xPropSet->getPropertyValue( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( "Number" ) ) ) >>= nPageNumber;
+
+    for( ShapeList::iterator it = maMediaShapes.begin(); it != maMediaShapes.end(); it++ ) {
+        ShapeRefSharedPtr pShapeRef = *it;
+
+        if( nPageNumber >= pShapeRef->nPageNumber + pShapeRef->nSlidesNumber )
+        pShapeRef->pShape.reset();
+    }
+
+
+    maMediaShapes.remove_if( media_shape_ptr_is_empty() );
+    }
+}
+
 void SlideShowImpl::displaySlide(
     uno::Reference<drawing::XDrawPage> const& xSlide,
     uno::Reference<drawing::XDrawPagesSupplier> const& xDrawPages,
@@ -1144,6 +1181,8 @@ void SlideShowImpl::displaySlide(
         mpPreviousSlide = mpCurrentSlide;
         mpCurrentSlide.reset();
 
+    mpAdvanceTimer->reset();
+
         if (matches( mpPrefetchSlide, xSlide, xRootNode )) 
         {
             // prefetched slide matches:
@@ -1155,6 +1194,8 @@ void SlideShowImpl::displaySlide(
         OSL_ASSERT( mpCurrentSlide );
         if (mpCurrentSlide) 
         {
+        updateMediaShapes();
+
             basegfx::B2DSize oldSlideSize;
             if( mpPreviousSlide )
                 oldSlideSize = mpPreviousSlide->getSlideSize();
@@ -2214,6 +2255,8 @@ void SlideShowImpl::notifySlideTransitionEnded( bool bPaintSlide )
                 "notifySlideTransitionEnded(): Invalid current slide" );
     if (mpCurrentSlide) 
     {
+    mpAdvanceTimer->adjustTimer( -mpAdvanceTimer->getElapsedTime() / 2 );
+
         // first init show, to give the animations
         // the chance to register SlideStartEvents
         const bool bBackgroundLayerRendered( !bPaintSlide );
@@ -2224,7 +2267,8 @@ void SlideShowImpl::notifySlideTransitionEnded( bool bPaintSlide )
 
 void queryAutomaticSlideTransition( uno::Reference<drawing::XDrawPage> const& xDrawPage,
                                     double&                                   nAutomaticNextSlideTimeout,
-                                    bool&                                     bHasAutomaticNextSlide )
+                                    bool&                                     bHasAutomaticNextSlide,
+                                    bool&                                     bFromStart )
 {
     // retrieve slide change parameters from XDrawPage
     // ===============================================
@@ -2244,7 +2288,8 @@ void queryAutomaticSlideTransition( uno::Reference<drawing::XDrawPage> const& xD
             "Could not extract slide change mode from XDrawPage - assuming <none>\n" );
     }
             
-    bHasAutomaticNextSlide = nChange == 1;
+    bHasAutomaticNextSlide = nChange == 1 || nChange == 3;
+    bFromStart = nChange == 3;
 
     if( !xPropSet.is() ||
         !getPropertyValue( nAutomaticNextSlideTimeout,
@@ -2289,10 +2334,12 @@ void SlideShowImpl::notifySlideAnimationsEnded()
                     "notifySlideAnimationsEnded(): Invalid current slide!" );
         
         bool   bHasAutomaticNextSlide=false;
+    bool   bFromStart=false;
         double nAutomaticNextSlideTimeout=0.0;
         queryAutomaticSlideTransition(mpCurrentSlide->getXDrawPage(),
                                       nAutomaticNextSlideTimeout,
-                                      bHasAutomaticNextSlide);
+                                      bHasAutomaticNextSlide,
+                      bFromStart);
 
         // check whether slide transition should happen
         // 'automatically'. If yes, simply schedule the
@@ -2304,6 +2351,14 @@ void SlideShowImpl::notifySlideAnimationsEnded()
             !mpRehearseTimingsActivity &&
             bHasAutomaticNextSlide )
         {
+        if( bFromStart ) {
+        double nCurrentTime = mpAdvanceTimer->getElapsedTime();
+        if( nAutomaticNextSlideTimeout > nCurrentTime )
+            nAutomaticNextSlideTimeout -= nCurrentTime;
+        else
+            nAutomaticNextSlideTimeout = 0;
+        }
+
             aNotificationEvents = makeInterruptableDelay(
                 boost::bind<void>( boost::mem_fn(&SlideShowImpl::notifySlideEnded), this, false ),
                 nAutomaticNextSlideTimeout);
diff --git slideshow/source/inc/shape.hxx slideshow/source/inc/shape.hxx
index 3bfec3f..4f168d2 100644
--- slideshow/source/inc/shape.hxx
+++ slideshow/source/inc/shape.hxx
@@ -38,6 +38,7 @@
 
 #include <boost/shared_ptr.hpp>
 #include <boost/noncopyable.hpp>
+#include <list>
 #include <set>
 #include <vector>
 
@@ -54,6 +55,15 @@ namespace slideshow
 
         typedef ::boost::shared_ptr< Shape > ShapeSharedPtr;
 
+    struct ShapeRef
+    {
+        ShapeSharedPtr pShape;
+        sal_Int16 nPageNumber;
+        sal_uInt16 nSlidesNumber;
+    };
+        typedef ::boost::shared_ptr< ShapeRef > ShapeRefSharedPtr;
+    typedef ::std::list< ShapeRefSharedPtr > ShapeList;
+
         /** Represents a slide's shape object.
 
             This interface represents the view-independent aspects of a
diff --git slideshow/source/inc/slide.hxx slideshow/source/inc/slide.hxx
index 3c3bdfd..5d200d3 100644
--- slideshow/source/inc/slide.hxx
+++ slideshow/source/inc/slide.hxx
@@ -32,6 +32,7 @@
 #include "subsettableshapemanager.hxx"
 #include "unoviewcontainer.hxx"
 #include "slidebitmap.hxx"
+#include "shape.hxx"
 #include "shapemaps.hxx"
 
 #include <boost/shared_ptr.hpp>
@@ -97,6 +98,8 @@ namespace slideshow
              */
             virtual void hide() = 0;
 
+        // get persistent media shapes
+        virtual void findPersistentMediaShapes( ShapeList& rList ) = 0;
 
             // Queries
             // -------------------------------------------------------------------
-- 
1.7.0.1

