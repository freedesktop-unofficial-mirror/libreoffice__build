From 6596c230e775949cc8d787c9115979d1948fd993 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:02:31 +0200
Subject: [PATCH 521/878] autocorrect-accidental-caps-lock-svx.diff

---
 svx/inc/svx/editeng.hxx         |    3 +-
 svx/inc/svx/editview.hxx        |    4 +-
 svx/inc/svx/outliner.hxx        |    2 +-
 svx/inc/svx/svxacorr.hxx        |    8 ++++-
 svx/source/cui/autocdlg.cxx     |   13 +++++++-
 svx/source/cui/autocdlg.hrc     |    1 +
 svx/source/cui/autocdlg.hxx     |    2 +
 svx/source/cui/autocdlg.src     |    4 ++
 svx/source/editeng/acorrcfg.cxx |   13 +++++++-
 svx/source/editeng/editeng.cxx  |   11 ++++---
 svx/source/editeng/editview.cxx |    9 +++--
 svx/source/editeng/impedit.cxx  |    4 +-
 svx/source/editeng/impedit.hxx  |    6 ++-
 svx/source/editeng/impedit2.cxx |    5 ++-
 svx/source/editeng/svxacorr.cxx |   61 +++++++++++++++++++++++++++++++++++++-
 svx/source/outliner/outlvw.cxx  |    4 +-
 svx/source/svdraw/svdedxv.cxx   |    2 +-
 17 files changed, 124 insertions(+), 28 deletions(-)

diff --git a/svx/inc/svx/editeng.hxx b/svx/inc/svx/editeng.hxx
index 6b02ccc..dbd1cac 100644
--- a/svx/inc/svx/editeng.hxx
+++ b/svx/inc/svx/editeng.hxx
@@ -53,6 +53,7 @@ class Rectangle;
 class SvStream;
 class Link;
 class OutputDevice;
+class Window;
 class SvUShorts;
 class SfxPoolItem;
 class SvxNumBulletItem;
@@ -124,7 +125,7 @@ private:
     SVX_DLLPRIVATE EditEngine&		operator=( const EditEngine& );
 
 //#if 0 // _SOLAR__PRIVATE
-    SVX_DLLPRIVATE BOOL				PostKeyEvent( const KeyEvent& rKeyEvent, EditView* pView );
+    SVX_DLLPRIVATE BOOL				PostKeyEvent( const KeyEvent& rKeyEvent, EditView* pView, Window* pFrameWin = NULL );
 //#endif
 
 protected:
diff --git a/svx/inc/svx/editview.hxx b/svx/inc/svx/editview.hxx
index 96c8e5b..54c7ca5 100644
--- a/svx/inc/svx/editview.hxx
+++ b/svx/inc/svx/editview.hxx
@@ -143,7 +143,7 @@ public:
 
     void			InsertText( const String& rNew, BOOL bSelect = FALSE );
 
-    BOOL			PostKeyEvent( const KeyEvent& rKeyEvent );
+    BOOL			PostKeyEvent( const KeyEvent& rKeyEvent, Window* pFrameWin = NULL );
 
     BOOL			MouseButtonUp( const MouseEvent& rMouseEvent );
     BOOL			MouseButtonDown( const MouseEvent& rMouseEvent );
@@ -206,7 +206,7 @@ public:
 
     BOOL			MatchGroup();
 
-    void			CompleteAutoCorrect();
+    void			CompleteAutoCorrect( Window* pFrameWin = NULL );
 
     EESpellState	StartSpeller( BOOL bMultipleDoc = FALSE );
     EESpellState	StartThesaurus();
diff --git a/svx/inc/svx/outliner.hxx b/svx/inc/svx/outliner.hxx
index 5a8f35f..6311ede 100644
--- a/svx/inc/svx/outliner.hxx
+++ b/svx/inc/svx/outliner.hxx
@@ -259,7 +259,7 @@ public:
     void        Scroll( long nHorzScroll, long nVertScroll );
 
     void        Paint( const Rectangle& rRect );
-    BOOL        PostKeyEvent( const KeyEvent& rKEvt );
+    BOOL        PostKeyEvent( const KeyEvent& rKEvt, Window* pFrameWin = NULL );
     BOOL        MouseButtonDown( const MouseEvent& );
     BOOL        MouseButtonUp( const MouseEvent& );
     BOOL        MouseMove( const MouseEvent& );
diff --git a/svx/inc/svx/svxacorr.hxx b/svx/inc/svx/svxacorr.hxx
index a17dc08..b222876 100644
--- a/svx/inc/svx/svxacorr.hxx
+++ b/svx/inc/svx/svxacorr.hxx
@@ -47,6 +47,7 @@ class SvxAutoCorrLanguageTable_Impl;
 class SvxAutoCorrLastFileAskTable_Impl;
 class SotStorageRef;
 class SotStorage;
+class Window;
 
 // Flags fuer die AutoKorrekt-Flags
 const long CptlSttSntnc		= 0x00000001;	// Gross-Buchstaben am SatzAnfang
@@ -62,6 +63,7 @@ const long SaveWordCplSttLst= 0x00000200;	// GrB. am SatzAnf. auto. aufnehmen
 const long SaveWordWrdSttLst= 0x00000400;	// 2 GrB. am WortAnf. auto. aufnehmen
 const long IngnoreDoubleSpace= 0x00000800;	// 2 Spaces ignorieren
 const long ChgSglQuotes		= 0x00001000;	// einfache Quotes ersetzen
+const long CorrectCapsLock  = 0x00002000;   // Correct accidental use of cAPS LOCK key
 
 const long ChgWordLstLoad	= 0x20000000;	// Ersetzungsliste geladen
 const long CplSttLstLoad	= 0x40000000;	// Exceptionlist fuer CplStart geladen
@@ -249,7 +251,7 @@ public:
     // fuehre eine AutoKorrektur aus.
     // returnt was ausgefuehrt wurde; entsprechend den obigen Flags
     ULONG AutoCorrect( SvxAutoCorrDoc& rDoc, const String& rTxt,
-                        xub_StrLen nPos, sal_Unicode cInsChar, BOOL bInsert );
+                        xub_StrLen nPos, sal_Unicode cInsChar, BOOL bInsert, Window* pFrameWin = NULL );
 
     // return fuer die Autotext Expandierung das vorherige Wort, was dem
     // AutoCorrect - Algorythmus entspricht.
@@ -374,6 +376,10 @@ public:
                                 xub_StrLen nSttPos, xub_StrLen nEndPos,
                                 LanguageType eLang  = LANGUAGE_SYSTEM);
 
+    bool FnCorrectCapsLock( SvxAutoCorrDoc&, const String&,
+                            xub_StrLen nSttPos, xub_StrLen nEndPos,
+                            LanguageType eLang  = LANGUAGE_SYSTEM );
+
     static long			GetDefaultFlags();
 
 // returns TRUE for charcters where the function
diff --git a/svx/source/cui/autocdlg.cxx b/svx/source/cui/autocdlg.cxx
index 86675f5..f143570 100644
--- a/svx/source/cui/autocdlg.cxx
+++ b/svx/source/cui/autocdlg.cxx
@@ -230,7 +230,8 @@ OfaAutocorrOptionsPage::OfaAutocorrOptionsPage( Window* pParent,
     sNoDblSpaces        (SVX_RES(STR_NO_DBL_SPACES    )),
     sHalf               (SVX_RES(ST_FRACTION          )),
     sDash    			(SVX_RES(ST_DASH	         	)),
-    sFirst              (SVX_RES(ST_ORDINAL           ))
+    sFirst              (SVX_RES(ST_ORDINAL           )),
+    sAccidentalCaps     (SVX_RES(ST_CORRECT_ACCIDENTAL_CAPS_LOCK))
 {
     FreeResource();
 
@@ -276,6 +277,7 @@ BOOL OfaAutocorrOptionsPage::FillItemSet( SfxItemSet& )
     pAutoCorrect->SetAutoCorrFlag(ChgFractionSymbol,	aCheckLB.IsChecked(nPos++));
     pAutoCorrect->SetAutoCorrFlag(ChgToEnEmDash,		aCheckLB.IsChecked(nPos++));
     pAutoCorrect->SetAutoCorrFlag(IngnoreDoubleSpace,	aCheckLB.IsChecked(nPos++));
+    pAutoCorrect->SetAutoCorrFlag(CorrectCapsLock,      aCheckLB.IsChecked(nPos++));
 
     BOOL bReturn = nFlags != pAutoCorrect->GetFlags();
     if(bReturn )
@@ -317,6 +319,7 @@ void OfaAutocorrOptionsPage::Reset( const SfxItemSet& )
     aCheckLB.InsertEntry(sHalf);
     aCheckLB.InsertEntry(sDash);
     aCheckLB.InsertEntry(sNoDblSpaces);
+    aCheckLB.InsertEntry(sAccidentalCaps);
 
     USHORT nPos = 0;
     aCheckLB.CheckEntryPos( nPos++, 0 != (nFlags & Autocorrect) );
@@ -328,6 +331,7 @@ void OfaAutocorrOptionsPage::Reset( const SfxItemSet& )
     aCheckLB.CheckEntryPos( nPos++, 0 != (nFlags & ChgFractionSymbol) );
     aCheckLB.CheckEntryPos( nPos++, 0 != (nFlags & ChgToEnEmDash) );
     aCheckLB.CheckEntryPos( nPos++, 0 != (nFlags & IngnoreDoubleSpace) );
+    aCheckLB.CheckEntryPos( nPos++, 0 != (nFlags & CorrectCapsLock) );
 
     aCheckLB.SetUpdateMode(TRUE);
 }
@@ -460,6 +464,7 @@ enum OfaAutoFmtOptions
     DEL_SPACES_AT_STT_END,
     DEL_SPACES_BETWEEN_LINES,
     IGNORE_DBLSPACE,
+    CORRECT_CAPS_LOCK,
     APPLY_NUMBERING,
     INSERT_BORDER,
     CREATE_TABLE,
@@ -489,6 +494,7 @@ OfaSwAutoFmtOptionsPage::OfaSwAutoFmtOptionsPage( Window* pParent,
     sBullet				(SVX_RES(	ST_BULLET       )),
     sBoldUnder			(SVX_RES(	ST_BOLD_UNDER   )),
     sNoDblSpaces		(SVX_RES(	STR_NO_DBL_SPACES)),
+    sCorrectCapsLock    (SVX_RES(   ST_CORRECT_ACCIDENTAL_CAPS_LOCK)),
     sFraction			(SVX_RES(	ST_FRACTION     )),
     sDetectURL			(SVX_RES(	ST_DETECT_URL   )),
     sDash				(SVX_RES(	ST_DASH         )),
@@ -629,6 +635,9 @@ BOOL OfaSwAutoFmtOptionsPage::FillItemSet( SfxItemSet&  )
     pAutoCorrect->SetAutoCorrFlag(IngnoreDoubleSpace,
                         aCheckLB.IsChecked(IGNORE_DBLSPACE, CBCOL_SECOND));
 
+    pAutoCorrect->SetAutoCorrFlag(CorrectCapsLock,
+                        aCheckLB.IsChecked(CORRECT_CAPS_LOCK, CBCOL_SECOND));
+
     bCheck = aCheckLB.IsChecked(DETECT_URL, CBCOL_FIRST);
     bModified |= pOpt->bSetINetAttr != bCheck;
     pOpt->bSetINetAttr = bCheck;
@@ -760,6 +769,7 @@ void OfaSwAutoFmtOptionsPage::Reset( const SfxItemSet& )
     aCheckLB.GetModel()->Insert(CreateEntry(sDelSpaceBetweenLines, CBCOL_BOTH  ));
 
     aCheckLB.GetModel()->Insert(CreateEntry(sNoDblSpaces,		CBCOL_SECOND));
+    aCheckLB.GetModel()->Insert(CreateEntry(sCorrectCapsLock,   CBCOL_SECOND));
     aCheckLB.GetModel()->Insert(CreateEntry(sNum,				CBCOL_SECOND));
     aCheckLB.GetModel()->Insert(CreateEntry(sBorder,			CBCOL_SECOND));
     aCheckLB.GetModel()->Insert(CreateEntry(sTable,				CBCOL_SECOND));
@@ -779,6 +789,7 @@ void OfaSwAutoFmtOptionsPage::Reset( const SfxItemSet& )
     aCheckLB.CheckEntryPos( BOLD_UNDERLINE,		CBCOL_FIRST,	pOpt->bChgWeightUnderl );
     aCheckLB.CheckEntryPos( BOLD_UNDERLINE,		CBCOL_SECOND,	0 != (nFlags & ChgWeightUnderl) );
     aCheckLB.CheckEntryPos( IGNORE_DBLSPACE,	CBCOL_SECOND,	0 != (nFlags & IngnoreDoubleSpace) );
+    aCheckLB.CheckEntryPos( CORRECT_CAPS_LOCK,  CBCOL_SECOND,   0 != (nFlags & CorrectCapsLock) );
     aCheckLB.CheckEntryPos( DETECT_URL,			CBCOL_FIRST,	pOpt->bSetINetAttr );
     aCheckLB.CheckEntryPos( DETECT_URL,			CBCOL_SECOND,	0 != (nFlags & SetINetAttr) );
     aCheckLB.CheckEntryPos( REPLACE_1ST,		CBCOL_FIRST,	pOpt->bChgOrdinalNumber );
diff --git a/svx/source/cui/autocdlg.hrc b/svx/source/cui/autocdlg.hrc
index 14bdd5c..1054f2f 100644
--- a/svx/source/cui/autocdlg.hrc
+++ b/svx/source/cui/autocdlg.hrc
@@ -149,6 +149,7 @@
 #define ST_DASH                         208
 #define FT_LANG                         209
 #define LB_LANG                         210
+#define ST_CORRECT_ACCIDENTAL_CAPS_LOCK 211
 
 #define CB_SMARTTAGS                    220
 #define FT_SMARTTAGS                    221
diff --git a/svx/source/cui/autocdlg.hxx b/svx/source/cui/autocdlg.hxx
index 867853a..33412d9 100644
--- a/svx/source/cui/autocdlg.hxx
+++ b/svx/source/cui/autocdlg.hxx
@@ -116,6 +116,7 @@ private:
     String		sHalf;
     String		sDash;
     String		sFirst;
+    String      sAccidentalCaps;
 
 public:
                         OfaAutocorrOptionsPage( Window* pParent, const SfxItemSet& rSet );
@@ -154,6 +155,7 @@ class OfaSwAutoFmtOptionsPage : public SfxTabPage
     String			sByInputBullet;
     String			sBoldUnder;
     String			sNoDblSpaces;
+    String          sCorrectCapsLock;
     String			sFraction;
     String			sDetectURL;
     String          sDash;
diff --git a/svx/source/cui/autocdlg.src b/svx/source/cui/autocdlg.src
index 2a54a1b..ca5be01 100644
--- a/svx/source/cui/autocdlg.src
+++ b/svx/source/cui/autocdlg.src
@@ -137,6 +137,10 @@ TabDialog RID_OFA_AUTOCORR_DLG
     String ST_DASH \
     { \
         Text [ en-US ] = "Replace dashes" ; \
+    }; \
+    String ST_CORRECT_ACCIDENTAL_CAPS_LOCK \
+    { \
+        Text [ en-US ] = "Correct accidental use of cAPS LOCK key" ; \
     };
 
 /**************************************************************************/
diff --git a/svx/source/editeng/acorrcfg.cxx b/svx/source/editeng/acorrcfg.cxx
index 3662f81..8b3008f 100644
--- a/svx/source/editeng/acorrcfg.cxx
+++ b/svx/source/editeng/acorrcfg.cxx
@@ -124,9 +124,10 @@ Sequence<OUString> 	SvxBaseAutoCorrCfg::GetPropertyNames()
         "SingleQuoteAtEnd",						// 13
         "ReplaceDoubleQuote",					// 14
         "DoubleQuoteAtStart",					// 15
-        "DoubleQuoteAtEnd"						// 16
+        "DoubleQuoteAtEnd",						// 16
+        "CorrectAccidentalCapsLock"             // 17
     };
-    const int nCount = 17;
+    const int nCount = 18;
     Sequence<OUString> aNames(nCount);
     OUString* pNames = aNames.getArray();
     for(int i = 0; i < nCount; i++)
@@ -226,6 +227,10 @@ void SvxBaseAutoCorrCfg::Load(sal_Bool bInit)
                         rParent.pAutoCorrect->SetEndDoubleQuote(
                             sal::static_int_cast< sal_Unicode >( nTemp ) );
                     break;//"DoubleQuoteAtEnd"
+                    case 17:
+                        if(*(sal_Bool*)pValues[nProp].getValue())
+                            nFlags |= CorrectCapsLock;
+                    break;//"CorrectAccidentalCapsLock"
                 }
             }
         }
@@ -330,6 +335,10 @@ void SvxBaseAutoCorrCfg::Commit()
             case 16:
                 pValues[nProp] <<= (sal_Int32) rParent.pAutoCorrect->GetEndDoubleQuote();
             break;//"DoubleQuoteAtEnd"
+            case 17:
+                bVal = 0 != (nFlags & CorrectCapsLock);
+                pValues[nProp].setValue(&bVal, rType);
+            break;//"CorrectAccidentalCapsLock"
         }
     }
     PutProperties(aNames, aValues);
diff --git a/svx/source/editeng/editeng.cxx b/svx/source/editeng/editeng.cxx
index b3087e0..9ac3067 100644
--- a/svx/source/editeng/editeng.cxx
+++ b/svx/source/editeng/editeng.cxx
@@ -810,7 +810,7 @@ ESelection EditEngine::CursorRight( const ESelection& rSelection, USHORT nCharac
     return pE->pImpEditEngine->CreateESel( aSel );
 }
 
-sal_Bool EditEngine::PostKeyEvent( const KeyEvent& rKeyEvent, EditView* pEditView )
+sal_Bool EditEngine::PostKeyEvent( const KeyEvent& rKeyEvent, EditView* pEditView, Window* pFrameWin )
 {
     DBG_CHKTHIS( EditEngine, 0 );
     DBG_CHKOBJ( pEditView, EditView, 0 );
@@ -1070,7 +1070,7 @@ sal_Bool EditEngine::PostKeyEvent( const KeyEvent& rKeyEvent, EditView* pEditVie
                         if ( bSel )
                             pImpEditEngine->UndoActionStart( EDITUNDO_INSERT );
                         if ( pImpEditEngine->GetStatus().DoAutoCorrect() )
-                            aCurSel = pImpEditEngine->AutoCorrect( aCurSel, 0, !pEditView->IsInsertMode() );
+                            aCurSel = pImpEditEngine->AutoCorrect( aCurSel, 0, !pEditView->IsInsertMode(), pFrameWin );
                         aCurSel = pImpEditEngine->InsertTab( aCurSel );
                         if ( bSel )
                             pImpEditEngine->UndoActionEnd( EDITUNDO_INSERT );
@@ -1091,7 +1091,7 @@ sal_Bool EditEngine::PostKeyEvent( const KeyEvent& rKeyEvent, EditView* pEditVie
                         pImpEditEngine->UndoActionStart( EDITUNDO_INSERT );
                         if ( rKeyEvent.GetKeyCode().IsShift() )
                         {
-                            aCurSel = pImpEditEngine->AutoCorrect( aCurSel, 0, !pEditView->IsInsertMode() );
+                            aCurSel = pImpEditEngine->AutoCorrect( aCurSel, 0, !pEditView->IsInsertMode(), pFrameWin );
                             aCurSel = pImpEditEngine->InsertLineBreak( aCurSel );
                         }
                         else
@@ -1099,7 +1099,7 @@ sal_Bool EditEngine::PostKeyEvent( const KeyEvent& rKeyEvent, EditView* pEditVie
                             if ( !aAutoText.Len() )
                             {
                                 if ( pImpEditEngine->GetStatus().DoAutoCorrect() )
-                                    aCurSel = pImpEditEngine->AutoCorrect( aCurSel, 0, !pEditView->IsInsertMode() );
+                                    aCurSel = pImpEditEngine->AutoCorrect( aCurSel, 0, !pEditView->IsInsertMode(), pFrameWin );
                                 aCurSel = pImpEditEngine->InsertParaBreak( aCurSel );
                             }
                             else
@@ -1147,7 +1147,8 @@ sal_Bool EditEngine::PostKeyEvent( const KeyEvent& rKeyEvent, EditView* pEditVie
                              ( nCharCode == '\"' ) || ( nCharCode == '\'' ) ||
                             ( nCharCode == '_' )  ))
                     {
-                        aCurSel = pImpEditEngine->AutoCorrect( aCurSel, nCharCode, !pEditView->IsInsertMode() );
+                        aCurSel = pImpEditEngine->AutoCorrect(
+                            aCurSel, nCharCode, !pEditView->IsInsertMode(), pFrameWin );
                     }
                     else
                     {
diff --git a/svx/source/editeng/editview.cxx b/svx/source/editeng/editview.cxx
index a9e10e1..5c98844 100644
--- a/svx/source/editeng/editview.cxx
+++ b/svx/source/editeng/editview.cxx
@@ -57,6 +57,7 @@
 #include <helpid.hrc>
 #include <i18npool/lang.h>
 #include <vcl/menu.hxx>
+#include <vcl/window.hxx>
 #include <acorrcfg.hxx>
 #include <unolingu.hxx>
 #include <fontitem.hxx>
@@ -415,11 +416,11 @@ void EditView::InsertText( const XubString& rStr, sal_Bool bSelect )
     pImpEE->FormatAndUpdate( this );
 }
 
-sal_Bool EditView::PostKeyEvent( const KeyEvent& rKeyEvent )
+sal_Bool EditView::PostKeyEvent( const KeyEvent& rKeyEvent, Window* pFrameWin )
 {
     DBG_CHKTHIS( EditView, 0 );
     DBG_CHKOBJ( pImpEditView->pEditEngine, EditEngine, 0 );
-    return pImpEditView->PostKeyEvent( rKeyEvent );
+    return pImpEditView->PostKeyEvent( rKeyEvent, pFrameWin );
 }
 
 sal_Bool EditView::MouseButtonUp( const MouseEvent& rMouseEvent )
@@ -916,7 +917,7 @@ sal_Bool EditView::MatchGroup()
     return sal_False;
 }
 
-void EditView::CompleteAutoCorrect()
+void EditView::CompleteAutoCorrect( Window* pFrameWin )
 {
     DBG_CHKTHIS( EditView, 0 );
     DBG_CHKOBJ( pImpEditView->pEditEngine, EditEngine, 0 );
@@ -926,7 +927,7 @@ void EditView::CompleteAutoCorrect()
         EditSelection aSel = pImpEditView->GetEditSelection();
         aSel = PIMPEE->EndOfWord( aSel.Max() );
         // MT 06/00: Why pass EditSelection to AutoCorrect, not EditPaM?!
-        aSel = PIMPEE->AutoCorrect( aSel, 0, !IsInsertMode() );
+        aSel = PIMPEE->AutoCorrect( aSel, 0, !IsInsertMode(), pFrameWin );
         pImpEditView->SetEditSelection( aSel );
         if ( PIMPEE->IsModified() )
             PIMPEE->FormatAndUpdate( this );
diff --git a/svx/source/editeng/impedit.cxx b/svx/source/editeng/impedit.cxx
index c5e3ab5..d1e795c 100644
--- a/svx/source/editeng/impedit.cxx
+++ b/svx/source/editeng/impedit.cxx
@@ -1000,7 +1000,7 @@ Pair ImpEditView::Scroll( long ndX, long ndY, BYTE nRangeCheck )
     return Pair( nRealDiffX, nRealDiffY );
 }
 
-sal_Bool ImpEditView::PostKeyEvent( const KeyEvent& rKeyEvent )
+sal_Bool ImpEditView::PostKeyEvent( const KeyEvent& rKeyEvent, Window* pFrameWin )
 {
     BOOL bDone = FALSE;
 
@@ -1044,7 +1044,7 @@ sal_Bool ImpEditView::PostKeyEvent( const KeyEvent& rKeyEvent )
     }
 
     if( !bDone )
-        bDone = pEditEngine->PostKeyEvent( rKeyEvent, GetEditViewPtr() );
+        bDone = pEditEngine->PostKeyEvent( rKeyEvent, GetEditViewPtr(), pFrameWin );
 
     return bDone;
 }
diff --git a/svx/source/editeng/impedit.hxx b/svx/source/editeng/impedit.hxx
index 7a718bc..27d8a91 100644
--- a/svx/source/editeng/impedit.hxx
+++ b/svx/source/editeng/impedit.hxx
@@ -98,6 +98,8 @@ class TextRanger;
 class SvKeyValueIterator;
 class SvxForbiddenCharactersTable;
 class SvtCTLOptions;
+class Window;
+
 #include <svx/SpellPortions.hxx>
 
 #include <svx/eedata.hxx>
@@ -294,7 +296,7 @@ public:
 
     BOOL			IsVertical() const;
 
-    BOOL			PostKeyEvent( const KeyEvent& rKeyEvent );
+    BOOL			PostKeyEvent( const KeyEvent& rKeyEvent, Window* pFrameWin = NULL );
 
     BOOL			MouseButtonUp( const MouseEvent& rMouseEvent );
     BOOL			MouseButtonDown( const MouseEvent& rMouseEvent );
@@ -784,7 +786,7 @@ public:
     EditPaM			DeleteSelected( EditSelection aEditSelection);
     EditPaM         InsertText( const EditSelection& rCurEditSelection, sal_Unicode c, sal_Bool bOverwrite, sal_Bool bIsUserInput = sal_False );
     EditPaM			InsertText( EditSelection aCurEditSelection, const String& rStr );
-    EditPaM			AutoCorrect( const EditSelection& rCurEditSelection, sal_Unicode c, sal_Bool bOverwrite );
+    EditPaM			AutoCorrect( const EditSelection& rCurEditSelection, sal_Unicode c, bool bOverwrite, Window* pFrameWin = NULL );
     EditPaM			DeleteLeftOrRight( const EditSelection& rEditSelection, BYTE nMode, BYTE nDelMode = DELMODE_SIMPLE );
     EditPaM			InsertParaBreak( EditSelection aEditSelection );
     EditPaM			InsertLineBreak( EditSelection aEditSelection );
diff --git a/svx/source/editeng/impedit2.cxx b/svx/source/editeng/impedit2.cxx
index 63280a3..e7c2e84 100644
--- a/svx/source/editeng/impedit2.cxx
+++ b/svx/source/editeng/impedit2.cxx
@@ -2582,7 +2582,8 @@ void ImpEditEngine::ImpRemoveParagraph( USHORT nPara )
     }
 }
 
-EditPaM ImpEditEngine::AutoCorrect( const EditSelection& rCurSel, xub_Unicode c, BOOL bOverwrite )
+EditPaM ImpEditEngine::AutoCorrect( const EditSelection& rCurSel, xub_Unicode c,
+                                    bool bOverwrite, Window* pFrameWin )
 {
     EditSelection aSel( rCurSel );
 #ifndef SVX_LIGHT
@@ -2632,7 +2633,7 @@ EditPaM ImpEditEngine::AutoCorrect( const EditSelection& rCurSel, xub_Unicode c,
         ContentNode* pNode = aSel.Max().GetNode();
         USHORT nIndex = aSel.Max().GetIndex();
         EdtAutoCorrDoc aAuto( this, pNode, nIndex, c );
-        pAutoCorrect->AutoCorrect( aAuto, *pNode, nIndex, c, !bOverwrite );
+        pAutoCorrect->AutoCorrect( aAuto, *pNode, nIndex, c, !bOverwrite, pFrameWin );
         aSel.Max().SetIndex( aAuto.GetCursor() );
 
         // #i78661 since the SvxAutoCorrect object used here is
diff --git a/svx/source/editeng/svxacorr.cxx b/svx/source/editeng/svxacorr.cxx
index 91248e3..4f00b1b 100644
--- a/svx/source/editeng/svxacorr.cxx
+++ b/svx/source/editeng/svxacorr.cxx
@@ -78,6 +78,7 @@
 #include <svx/escpitem.hxx>
 #include <svx/svxacorr.hxx>
 #include "unolingu.hxx"
+#include "vcl/window.hxx"
 
 #ifndef _SVX_HELPID_HRC
 #include <helpid.hrc>
@@ -348,7 +349,8 @@ long SvxAutoCorrect::GetDefaultFlags()
                     | SetINetAttr
                     | ChgQuotes
                     | SaveWordCplSttLst
-                    | SaveWordWrdSttLst;
+                    | SaveWordWrdSttLst
+                    | CorrectCapsLock;
     LanguageType eLang = GetAppLang();
     switch( eLang )
     {
@@ -1049,6 +1051,49 @@ BOOL SvxAutoCorrect::FnCptlSttSntnc( SvxAutoCorrDoc& rDoc,
 
     return bRet;
 }
+
+bool SvxAutoCorrect::FnCorrectCapsLock( SvxAutoCorrDoc& rDoc, const String& rTxt,
+                                        xub_StrLen nSttPos, xub_StrLen nEndPos,
+                                        LanguageType eLang )
+{
+    if (nEndPos - nSttPos < 2)
+        // string must be at least 2-character long.
+        return false;
+
+    CharClass& rCC = GetCharClass( eLang );
+
+    // Check the first 2 letters.
+    if ( !IsLowerLetter(rCC.getCharacterType(rTxt, nSttPos)) )
+        return false;
+
+    if ( !IsUpperLetter(rCC.getCharacterType(rTxt, nSttPos+1)) )
+        return false;
+
+    String aConverted;
+    aConverted.Append( rCC.upper(rTxt.GetChar(nSttPos)) );
+    aConverted.Append( rCC.lower(rTxt.GetChar(nSttPos+1)) );
+
+    for (xub_StrLen i = nSttPos+2; i < nEndPos; ++i)
+    {
+        if ( IsLowerLetter(rCC.getCharacterType(rTxt, i)) )
+            // A lowercase letter disqualifies the whole text.
+            return false;
+
+        if ( IsUpperLetter(rCC.getCharacterType(rTxt, i)) )
+            // Another uppercase letter.  Convert it.
+            aConverted.Append( rCC.lower(rTxt.GetChar(i)) );
+        else
+            // This is not an alphabetic letter.  Leave it as-is.
+            aConverted.Append(rTxt.GetChar(i));
+    }
+
+    // Replace the word.
+    rDoc.Delete(nSttPos, nEndPos);
+    rDoc.Insert(nSttPos, aConverted);
+
+    return true;
+}
+
 //The method below is renamed from _GetQuote to GetQuote by BerryJia for Bug95846 Time:2002-8-13 15:50
 sal_Unicode SvxAutoCorrect::GetQuote( sal_Unicode cInsChar, BOOL bSttQuote,
                                         LanguageType eLang ) const
@@ -1162,7 +1207,7 @@ String SvxAutoCorrect::GetQuote( SvxAutoCorrDoc& rDoc, xub_StrLen nInsPos,
 
 ULONG SvxAutoCorrect::AutoCorrect( SvxAutoCorrDoc& rDoc, const String& rTxt,
                                     xub_StrLen nInsPos, sal_Unicode cChar,
-                                    BOOL bInsert )
+                                    BOOL bInsert, Window* pFrameWin )
 {
     ULONG nRet = 0;
     do{		                            // only for middle check loop !!
@@ -1305,7 +1350,19 @@ ULONG SvxAutoCorrect::AutoCorrect( SvxAutoCorrDoc& rDoc, const String& rTxt,
             ;
         else
         {
+            bool bLockKeyOn = pFrameWin && (pFrameWin->GetIndicatorState() & INDICATOR_CAPSLOCK);
+
             nRet = 0;
+            if ( bLockKeyOn && IsAutoCorrFlag( CorrectCapsLock ) &&
+                 FnCorrectCapsLock( rDoc, rTxt, nCapLttrPos, nInsPos, eLang ) )
+            {
+                // Correct accidental use of cAPS LOCK key (do this only when
+                // the caps or shift lock key is pressed).  Turn off the caps
+                // lock afterwords.
+                nRet |= CorrectCapsLock;
+                pFrameWin->SimulateKeyPress( KEY_CAPSLOCK );
+            }
+
             // Grossbuchstabe am Satz-Anfang ??
             if( IsAutoCorrFlag( CptlSttSntnc ) &&
                 FnCptlSttSntnc( rDoc, rTxt, TRUE, nCapLttrPos, nInsPos, eLang ) )
diff --git a/svx/source/outliner/outlvw.cxx b/svx/source/outliner/outlvw.cxx
index 5b412be..24c162a 100644
--- a/svx/source/outliner/outlvw.cxx
+++ b/svx/source/outliner/outlvw.cxx
@@ -89,7 +89,7 @@ void OutlinerView::Paint( const Rectangle& rRect )
     pEditView->Paint( rRect );
 }
 
-BOOL OutlinerView::PostKeyEvent( const KeyEvent& rKEvt )
+BOOL OutlinerView::PostKeyEvent( const KeyEvent& rKEvt, Window* pFrameWin )
 {
     DBG_CHKTHIS( OutlinerView, 0 );
 
@@ -254,7 +254,7 @@ BOOL OutlinerView::PostKeyEvent( const KeyEvent& rKEvt )
         }
     }
 
-    return bKeyProcessed ? TRUE : pEditView->PostKeyEvent( rKEvt );
+    return bKeyProcessed ? TRUE : pEditView->PostKeyEvent( rKEvt, pFrameWin );
 }
 
 
diff --git a/svx/source/svdraw/svdedxv.cxx b/svx/source/svdraw/svdedxv.cxx
index 59a3e40..53936c6 100644
--- a/svx/source/svdraw/svdedxv.cxx
+++ b/svx/source/svdraw/svdedxv.cxx
@@ -1158,7 +1158,7 @@ BOOL SdrObjEditView::KeyInput(const KeyEvent& rKEvt, Window* pWin)
                 ShowItemBrowser();
         }
 #endif
-        if (pTextEditOutlinerView->PostKeyEvent(rKEvt))
+        if (pTextEditOutlinerView->PostKeyEvent(rKEvt, pWin))
         {
             if( pMod && !pMod->IsChanged() )
             {
-- 
1.7.0.1

