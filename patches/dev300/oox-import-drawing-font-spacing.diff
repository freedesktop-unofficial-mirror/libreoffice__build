From b491f054b5361a49585986f15d31af761fc7247b Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:00:45 +0200
Subject: [PATCH 364/768] oox-import-drawing-font-spacing.diff

---
 oox/inc/oox/drawingml/drawingmltypes.hxx           |    1 +
 oox/inc/oox/drawingml/textcharacterproperties.hxx  |    1 +
 oox/source/drawingml/drawingmltypes.cxx            |    6 +++++-
 oox/source/drawingml/textcharacterproperties.cxx   |    3 +++
 .../drawingml/textcharacterpropertiescontext.cxx   |    2 ++
 oox/source/token/properties.txt                    |    1 +
 6 files changed, 13 insertions(+), 1 deletions(-)

diff --git oox/inc/oox/drawingml/drawingmltypes.hxx oox/inc/oox/drawingml/drawingmltypes.hxx
index 2c71030..c15baec 100644
--- oox/inc/oox/drawingml/drawingmltypes.hxx
+++ oox/inc/oox/drawingml/drawingmltypes.hxx
@@ -118,6 +118,7 @@ float GetTextSize( const ::rtl::OUString& rValue );
 
 /** converts the ST_TextSpacingPoint to 1/100mm */
 sal_Int32 GetTextSpacingPoint(  const ::rtl::OUString& sValue );
+sal_Int32 GetTextSpacingPoint(  const sal_Int32 nValue );
 
 /** */
 ::com::sun::star::style::TabAlign GetTabAlign( ::sal_Int32 aToken );
diff --git oox/inc/oox/drawingml/textcharacterproperties.hxx oox/inc/oox/drawingml/textcharacterproperties.hxx
index 165ddae..1520282 100644
--- oox/inc/oox/drawingml/textcharacterproperties.hxx
+++ oox/inc/oox/drawingml/textcharacterproperties.hxx
@@ -52,6 +52,7 @@ struct TextCharacterProperties
     Color               maHighlightColor;
     OptValue< ::rtl::OUString > moLang;
     OptValue< sal_Int32 > moHeight;
+    OptValue< sal_Int32 > moSpacing;
     OptValue< sal_Int32 > moUnderline;
     OptValue< sal_Int32 > moStrikeout;
     OptValue< sal_Int32 > moCaseMap;
diff --git oox/source/drawingml/drawingmltypes.cxx oox/source/drawingml/drawingmltypes.cxx
index 705eff1..ad21c1d 100644
--- oox/source/drawingml/drawingmltypes.cxx
+++ oox/source/drawingml/drawingmltypes.cxx
@@ -125,10 +125,14 @@ sal_Int32 GetTextSpacingPoint( const OUString& sValue )
 {
     sal_Int32 nRet;
     if( ::sax::Converter::convertNumber( nRet, sValue ) )
-        nRet = ( nRet * 254 + 360 ) / 720;
+        nRet = GetTextSpacingPoint( nRet );
     return nRet;
 }
 
+sal_Int32 GetTextSpacingPoint( const sal_Int32 nValue )
+{
+    return ( nValue * 254 + 360 ) / 720;
+}
 
 float GetFontHeight( sal_Int32 nHeight )
 {
diff --git oox/source/drawingml/textcharacterproperties.cxx oox/source/drawingml/textcharacterproperties.cxx
index edf5012..51e023d 100644
--- oox/source/drawingml/textcharacterproperties.cxx
+++ oox/source/drawingml/textcharacterproperties.cxx
@@ -59,6 +59,7 @@ void TextCharacterProperties::assignUsed( const TextCharacterProperties& rSource
     maHighlightColor.assignIfUsed( rSourceProps.maHighlightColor );
     maUnderlineColor.assignIfUsed( rSourceProps.maUnderlineColor );
     moHeight.assignIfUsed( rSourceProps.moHeight );
+    moSpacing.assignIfUsed( rSourceProps.moSpacing );
     moUnderline.assignIfUsed( rSourceProps.moUnderline );
     moStrikeout.assignIfUsed( rSourceProps.moStrikeout );
     moCaseMap.assignIfUsed( rSourceProps.moCaseMap );
@@ -126,6 +127,8 @@ void TextCharacterProperties::pushToPropMap( PropertyMap& rPropMap, const XmlFil
         rPropMap[ PROP_CharHeightComplex ] <<= fHeight;
     }
 
+    rPropMap[ PROP_CharKerning ] <<= (sal_Int16) GetTextSpacingPoint( moSpacing.get( 0 ) );
+
     rPropMap[ PROP_CharUnderline ] <<= GetFontUnderline( moUnderline.get( XML_none ) );
     rPropMap[ PROP_CharStrikeout ] <<= GetFontStrikeout( moStrikeout.get( XML_noStrike ) );
     rPropMap[ PROP_CharCaseMap ] <<= GetCaseMap( moCaseMap.get( XML_none ) );
diff --git oox/source/drawingml/textcharacterpropertiescontext.cxx oox/source/drawingml/textcharacterpropertiescontext.cxx
index c74dba5..9fa4851 100644
--- oox/source/drawingml/textcharacterpropertiescontext.cxx
+++ oox/source/drawingml/textcharacterpropertiescontext.cxx
@@ -60,6 +60,8 @@ TextCharacterPropertiesContext::TextCharacterPropertiesContext(
         mrTextCharacterProperties.moLang = aAttribs.getString( XML_lang );
     if ( aAttribs.hasAttribute( XML_sz ) )
         mrTextCharacterProperties.moHeight = aAttribs.getInteger( XML_sz );
+    if ( aAttribs.hasAttribute( XML_spc ) )
+    mrTextCharacterProperties.moSpacing     = aAttribs.getInteger( XML_spc );
     if ( aAttribs.hasAttribute( XML_u ) )
         mrTextCharacterProperties.moUnderline = aAttribs.getToken( XML_u );
     if ( aAttribs.hasAttribute( XML_strike ) )
diff --git oox/source/token/properties.txt oox/source/token/properties.txt
index 3100d8e..88efd3f 100644
--- oox/source/token/properties.txt
+++ oox/source/token/properties.txt
@@ -57,6 +57,7 @@ CharFontPitchComplex
 CharHeight
 CharHeightAsian
 CharHeightComplex
+CharKerning
 CharLocale
 CharLocaleAsian
 CharLocaleComplex
-- 
1.7.0.1

