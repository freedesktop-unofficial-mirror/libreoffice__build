From 2602c2c2ab3882a882ce8871d81973e5d5b524b4 Mon Sep 17 00:00:00 2001
From: Jan Nieuwenhuizen <janneke@gnu.org>
Date: Mon, 27 Jul 2009 11:27:36 +0200
Subject: [PATCH] OOXML: Disable pivot cache export.  Fixes content-bit of n#505917.

   * Modified     sc/source/filter/xlsx/xlsx-xepivot.cxx
---
 sc/source/filter/xlsx/xlsx-xepivot.cxx |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git sc/source/filter/xlsx/xlsx-xepivot.cxx sc/source/filter/xlsx/xlsx-xepivot.cxx
index 57409c1..217e01d 100644
--- sc/source/filter/xlsx/xlsx-xepivot.cxx
+++ sc/source/filter/xlsx/xlsx-xepivot.cxx
@@ -740,6 +740,8 @@ void XclExpPivotCache::Save( XclExpStream& rStrm )
 void XclExpPivotCache::SaveXml( XclExpXmlStream& rStrm )
 {
     DBG_ASSERT( mbValid, "XclExpPivotCache::Save - invalid pivot cache" );
+#ifdef XLSX_PIVOT_CACHE /* <pivotCache> without xl/pivotCaches/ cacheStream
+                           results in a broken .xlsx */
     sax_fastparser::FSHelperPtr& rWorkbook = rStrm.GetCurrentStream();
     OUString sId = OUStringBuffer()
         .appendAscii("rId")
@@ -758,6 +760,7 @@ void XclExpPivotCache::SaveXml( XclExpXmlStream& rStrm )
     // create the pivot cache storage stream
     // OOXTODO: WriteCacheStream();
     rWorkbook->endElement( XML_pivotCache );
+#endif /* XLSX_PIVOT_CACHE */
 }
 
 // private --------------------------------------------------------------------
@@ -1844,12 +1847,15 @@ void XclExpPivotTableManager::WritePivotCaches( XclExpStream& rStrm )
 
 void XclExpPivotTableManager::WritePivotCachesXml( XclExpXmlStream& rStrm )
 {
+#ifdef XLSX_PIVOT_CACHE /* <pivotCache> without xl/pivotCaches/ cacheStream
+                           results in a broken .xlsx */
     if( maPCacheList.IsEmpty() )
         return;
     sax_fastparser::FSHelperPtr& rWorkbook = rStrm.GetCurrentStream();
     rWorkbook->startElement( XML_pivotCaches, FSEND );
     maPCacheList.SaveXml( rStrm );
     rWorkbook->endElement( XML_pivotCaches );
+#endif /* XLSX_PIVOT_CACHE */
 }
 
 void XclExpPivotTableManager::WritePivotTables( XclExpStream& rStrm, SCTAB nScTab )
-- 
1.6.0.rc1.49.g98a8

