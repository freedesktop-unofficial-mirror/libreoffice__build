From 3a356f949c2dbfa0f32b0e47c6a5a8313c543495 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:53:32 +0200
Subject: [PATCH 041/768] cjk-character-units-fix.diff

---
 .../schema/org/openoffice/Office/Writer.xcs        |   24 ++++++++++----------
 sw/source/ui/app/appopt.cxx                        |    1 +
 sw/source/ui/app/swmodul1.cxx                      |    6 +++-
 sw/source/ui/config/optload.cxx                    |    3 ++
 sw/source/ui/config/optload.src                    |    3 +-
 sw/source/ui/config/usrpref.cxx                    |    3 +-
 sw/source/ui/misc/pggrid.cxx                       |    6 ++--
 sw/source/ui/uiview/view.cxx                       |    8 +++++-
 8 files changed, 32 insertions(+), 22 deletions(-)

diff --git officecfg/registry/schema/org/openoffice/Office/Writer.xcs officecfg/registry/schema/org/openoffice/Office/Writer.xcs
index 7dc2ee5..9abada4 100644
--- officecfg/registry/schema/org/openoffice/Office/Writer.xcs
+++ officecfg/registry/schema/org/openoffice/Office/Writer.xcs
@@ -1588,6 +1588,18 @@
 					</info>
 					<value>true</value>
 				</prop>
+                <!-- added for apply char unit 2006-12-1 -->
+                <prop oor:name="ApplyCharUnit" oor:type="xs:boolean">
+                    <!-- OldPath: Writer/Layout -->
+                    <!-- OldLocation: Soffice.cfg -->
+                    <!-- UIHints: Tools - Options - Text document - Layout - [Section] Apply char unit -->
+                    <info>
+                        <author>OS</author>
+                        <desc>apply char unit to calculate the paragraph's indent</desc>
+                        <label>apply char unit</label>
+                    </info>
+                    <value>true</value>
+                </prop>
 			</group>
 			<group oor:name="Zoom">
 				<info>
@@ -1651,18 +1663,6 @@
 					</info>
 					<value>false</value>
 				</prop>
-                <!-- added for apply char unit 2006-12-1 -->
-                <prop oor:name="ApplyCharUnit" oor:type="xs:boolean">
-                    <!-- OldPath: Writer/Layout -->
-                    <!-- OldLocation: Soffice.cfg -->
-                    <!-- UIHints: Tools - Options - Text document - Layout - [Section] Apply char unit -->
-                    <info>
-                        <author>OS</author>
-                        <desc>apply char unit to calculate the paragraph's indent</desc>
-                        <label>apply char unit</label>
-                    </info>
-                    <value>true</value>
-                </prop>
 			</group>
 		</group>
 		<group oor:name="Grid">
diff --git sw/source/ui/app/appopt.cxx sw/source/ui/app/appopt.cxx
index 28d0163..9f3008c 100644
--- sw/source/ui/app/appopt.cxx
+++ sw/source/ui/app/appopt.cxx
@@ -230,6 +230,7 @@ SfxItemSet*	 SwModule::CreateItemSet( USHORT nId )
         pAppView->GetVLinealMetric(eUnit);
     pRet->Put(SfxUInt16Item( FN_VSCROLL_METRIC, static_cast< UINT16 >(eUnit) ));
     pRet->Put(SfxUInt16Item( SID_ATTR_METRIC, static_cast< UINT16 >(pPref->GetMetric()) ));
+    pRet->Put(SfxBoolItem(SID_ATTR_APPLYCHARUNIT, pPref->IsApplyCharUnit()));
     if(bTextDialog)
     {
         if(pAppView)
diff --git sw/source/ui/app/swmodul1.cxx sw/source/ui/app/swmodul1.cxx
index 3cb1d4f..07430ed 100644
--- sw/source/ui/app/swmodul1.cxx
+++ sw/source/ui/app/swmodul1.cxx
@@ -348,8 +348,10 @@ void SwModule::ApplyUserCharUnit(BOOL bApplyChar, BOOL bWeb)
     }
     else
     {
-        eHScrollMetric = FUNIT_CM;
-        eVScrollMetric = FUNIT_CM;
+        if ( eHScrollMetric == FUNIT_CHAR )
+            eHScrollMetric == FUNIT_CM;
+        if ( eVScrollMetric == FUNIT_LINE )
+            eVScrollMetric == FUNIT_CM;
     }
     SwView* pTmpView = SwModule::GetFirstView();
     // fuer alle MDI-Fenster das Lineal umschalten
diff --git sw/source/ui/config/optload.cxx sw/source/ui/config/optload.cxx
index 3d2419a..a03f492 100644
--- sw/source/ui/config/optload.cxx
+++ sw/source/ui/config/optload.cxx
@@ -148,7 +148,10 @@ SwLoadOptPage::SwLoadOptPage( Window* pParent, const SfxItemSet& rSet ) :
     
     SvtCJKOptions aCJKOptions;
     if(!aCJKOptions.IsAsianTypographyEnabled())
+        {
         aUseSquaredPageMode.Hide();
+                aUseCharUnit.Hide();
+        }
 }
 
 /*-----------------18.01.97 12.43-------------------
diff --git sw/source/ui/config/optload.src sw/source/ui/config/optload.src
index 5e0c8c7..a20d578 100644
--- sw/source/ui/config/optload.src
+++ sw/source/ui/config/optload.src
@@ -144,8 +144,7 @@ TabPage TP_OPTLOAD_PAGE
     {
         Pos = MAP_APPFONT ( 12 , 130) ;
         Size = MAP_APPFONT ( 109 , 10 ) ;
-        Text [ de ] = "appy char unit" ;
-        Text [ en-US ] = "apply char unit";
+        Text [ en-US ] = "Enable char unit";
         Text [ x-comment ] = " ";
     };
 
diff --git sw/source/ui/config/usrpref.cxx sw/source/ui/config/usrpref.cxx
index 22b2d37..c6be3b6 100644
--- sw/source/ui/config/usrpref.cxx
+++ sw/source/ui/config/usrpref.cxx
@@ -63,6 +63,7 @@ SwMasterUsrPref::SwMasterUsrPref(BOOL bWeb) :
     bIsVScrollMetricSet(sal_False),
     nDefTab( MM50 * 4 ),
     bIsSquaredPageMode(sal_False),
+    bApplyCharUnit(sal_False),
     aContentConfig(bWeb, *this),
     aLayoutConfig(bWeb, *this),
     aGridConfig(bWeb, *this),
@@ -333,7 +334,7 @@ void SwLayoutViewConfig::Commit()
             case 16: pValues[nProp] <<= (sal_Int32)rParent.GetViewLayoutColumns(); break;// "ViewLayout/Columns",
             case 17: bSet = rParent.IsViewLayoutBookMode(); break;// "ViewLayout/BookMode",
             case 18: bSet = rParent.IsSquaredPageMode(); break;// "Other/IsSquaredPageMode",
-            case 19: bSet = rParent.IsApplyCharUnit(); break;// "Other/IsApplyCharUnit",
+            case 19: bSet = rParent.IsApplyCharUnit(); break;// "Other/ApplyCharUnit",
         }
         if(nProp < 8 || nProp == 10 || nProp == 15 || nProp == 17 || nProp == 18 || nProp == 19 )
             pValues[nProp].setValue(&bSet, ::getBooleanCppuType());
diff --git sw/source/ui/misc/pggrid.cxx sw/source/ui/misc/pggrid.cxx
index ee7ac77..bcfc76d 100644
--- sw/source/ui/misc/pggrid.cxx
+++ sw/source/ui/misc/pggrid.cxx
@@ -323,17 +323,17 @@ void SwTextGridPage::PutGridItem(SfxItemSet& rSet)
         aGridItem.SetColor(aColorLB.GetSelectEntryColor());
         rSet.Put(aGridItem);
 /// Amelia
+            SwView * pView = ::GetActiveView();
         if ( aGridItem.GetGridType() != GRID_NONE )
         {
-            SwView * pView = ::GetActiveView();
             if ( aGridItem.GetGridType() == GRID_LINES_CHARS )
             {
-                pView->GetHLineal().SetCharWidth((long)(aCharWidthMF.GetValue(FUNIT_TWIP)/56.7));
                 m_bHRulerChanged = sal_True;
             }
-            pView->GetVLineal().SetLineHeight((long)(aTextSizeMF.GetValue(FUNIT_TWIP)/56.7));
             m_bVRulerChanged = sal_True;
         }
+        pView->GetHLineal().SetCharWidth((long)(aCharWidthMF.GetValue(FUNIT_TWIP)/56.7));
+        pView->GetVLineal().SetLineHeight((long)(aTextSizeMF.GetValue(FUNIT_TWIP)/56.7));
 }
 /* -----------------------------08.02.2002 10:54------------------------------
 
diff --git sw/source/ui/uiview/view.cxx sw/source/ui/uiview/view.cxx
index 8a88254..58efc39 100644
--- sw/source/ui/uiview/view.cxx
+++ sw/source/ui/uiview/view.cxx
@@ -116,6 +116,9 @@
 #include <com/sun/star/document/XDocumentProperties.hpp>
 #include <com/sun/star/document/XDocumentPropertiesSupplier.hpp>
 
+#ifndef _SVTOOLS_CJKOPTIONS_HXX
+#include <svtools/cjkoptions.hxx>
+#endif
 
 
 using namespace ::com::sun::star;
@@ -953,13 +956,14 @@ SwView::SwView( SfxViewFrame *_pFrame, SfxViewShell* pOldSh )
     FieldUnit eMetric = pUsrPref->GetHScrollMetric();
 
     BOOL bApplyCharUnit = pUsrPref->IsApplyCharUnit();
-    if ( bApplyCharUnit )
+    SvtCJKOptions aCJKOptions;
+    if ( aCJKOptions.IsAsianTypographyEnabled() && bApplyCharUnit )
         pHRuler->SetUnit( FUNIT_CHAR );
     else
         pHRuler->SetUnit( eMetric );
 
     eMetric = pUsrPref->GetVScrollMetric();
-    if ( bApplyCharUnit )
+    if ( aCJKOptions.IsAsianTypographyEnabled() && bApplyCharUnit )
         pVRuler->SetUnit(FUNIT_LINE);
     else
         pVRuler->SetUnit( eMetric );
-- 
1.7.0.1

