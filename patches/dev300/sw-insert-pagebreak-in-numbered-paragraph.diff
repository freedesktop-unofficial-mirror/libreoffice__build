From 7680b766f8703251bda8d12e9eeae33ff8bc5f63 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:05:22 +0200
Subject: [PATCH 667/878] sw-insert-pagebreak-in-numbered-paragraph.diff

---
 sw/inc/doc.hxx                   |    1 +
 sw/source/core/docnode/ndtbl.cxx |   43 ++++++++++++++++++++++++++++++++++++++
 sw/source/ui/wrtsh/wrtsh1.cxx    |    2 +
 3 files changed, 46 insertions(+), 0 deletions(-)

diff --git a/sw/inc/doc.hxx b/sw/inc/doc.hxx
index cd41d07..ba00f80 100644
--- a/sw/inc/doc.hxx
+++ b/sw/inc/doc.hxx
@@ -1732,6 +1732,7 @@ public:
     void ChkBoxNumFmt( SwTableBox& rAktBox, sal_Bool bCallUpdate );
     void SetTblBoxFormulaAttrs( SwTableBox& rBox, const SfxItemSet& rSet );
     void ClearBoxNumAttrs( const SwNodeIndex& rNode );
+    void ClearLineNumAttrs( SwPosition & rPos );
 
     sal_Bool InsCopyOfTbl( SwPosition& rInsPos, const SwSelBoxes& rBoxes,
                         const SwTable* pCpyTbl = 0, sal_Bool bCpyName = sal_False,
diff --git a/sw/source/core/docnode/ndtbl.cxx b/sw/source/core/docnode/ndtbl.cxx
index 47a286d..21a992e 100644
--- a/sw/source/core/docnode/ndtbl.cxx
+++ b/sw/source/core/docnode/ndtbl.cxx
@@ -40,6 +40,7 @@
 #include <svx/brkitem.hxx>
 #include <svx/protitem.hxx>
 #include <svx/boxitem.hxx>
+#include <svtools/stritem.hxx>
 // OD 06.08.2003 #i17174#
 #include <svx/shaditem.hxx>
 #include <fmtfsize.hxx>
@@ -4204,6 +4205,48 @@ void SwDoc::SetTblBoxFormulaAttrs( SwTableBox& rBox, const SfxItemSet& rSet )
     SetModified();
 }
 
+void SwDoc::ClearLineNumAttrs( SwPosition & rPos )
+{
+    SwPaM aPam(rPos);
+    aPam.Move(fnMoveBackward);
+    SwCntntNode *pNode = aPam.GetCntntNode();
+    if ( 0 == pNode )
+        return ;
+    if( pNode->IsTxtNode() )
+    {
+        SwTxtNode * pTxtNode = pNode->GetTxtNode();
+        if ( pTxtNode && pTxtNode->IsNumbered() && pTxtNode->GetTxt().Len()==0 )
+        {
+            const SfxPoolItem* pFmtItem = 0;
+            SfxItemSet rSet( const_cast<SwAttrPool&>(pTxtNode->GetDoc()->GetAttrPool()),
+                        RES_PARATR_BEGIN, RES_PARATR_END - 1,
+                        0);
+            pTxtNode->SwCntntNode::GetAttr( rSet );
+            if ( SFX_ITEM_SET == rSet.GetItemState( RES_PARATR_NUMRULE , FALSE , &pFmtItem ) )
+            {
+                SwUndoDelNum * pUndo;
+                if( DoesUndo() )
+                {
+                    ClearRedo();
+                    AppendUndo( pUndo = new SwUndoDelNum( aPam ) );
+                }
+                else
+                    pUndo = 0;
+                SwRegHistory aRegH( pUndo ? pUndo->GetHistory() : 0 );
+                aRegH.RegisterInModify( pTxtNode , *pTxtNode );
+                if ( pUndo )
+                    pUndo->AddNode( *pTxtNode , FALSE );
+                String aStyle = String::CreateFromAscii("");
+                SfxStringItem * pNewItem = (SfxStringItem*)pFmtItem->Clone();
+                pNewItem->SetValue( aStyle );
+                rSet.Put( *pNewItem );
+                pTxtNode->SetAttr( rSet );
+                delete pNewItem;
+            }
+        }
+    }
+}
+
 void SwDoc::ClearBoxNumAttrs( const SwNodeIndex& rNode )
 {
     SwStartNode* pSttNd;
diff --git a/sw/source/ui/wrtsh/wrtsh1.cxx b/sw/source/ui/wrtsh/wrtsh1.cxx
index d793d6c..2f9f11a 100644
--- a/sw/source/ui/wrtsh/wrtsh1.cxx
+++ b/sw/source/ui/wrtsh/wrtsh1.cxx
@@ -928,6 +928,8 @@ void SwWrtShell::InsertPageBreak(const String *pPageDesc, USHORT nPgNum )
             if(HasSelection())
                 DelRight();
             SwFEShell::SplitNode();
+            // delete the numbered attribute of the last line if the last line is empty
+            GetDoc()->ClearLineNumAttrs( *GetCrsr()->GetPoint() );
         }
 
         const SwPageDesc *pDesc = pPageDesc
-- 
1.7.0.1

