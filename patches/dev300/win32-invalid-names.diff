From 2432d3abb6312fa3c7a35d53726d68fcbab8ef4c Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:54:40 +0200
Subject: [PATCH 118/878] win32-invalid-names.diff

---
 sal/osl/w32/file_url.cxx |   16 +++++++++++-----
 sal/osl/w32/file_url.h   |    1 +
 2 files changed, 12 insertions(+), 5 deletions(-)

diff --git a/sal/osl/w32/file_url.cxx b/sal/osl/w32/file_url.cxx
index 7020da4..f55cb85 100644
--- a/sal/osl/w32/file_url.cxx
+++ b/sal/osl/w32/file_url.cxx
@@ -82,9 +82,10 @@ static BOOL IsValidFilePathComponent(
                 case '.':
                     if ( dwFlags & VALIDATEPATH_ALLOW_ELLIPSE )
                     {
-                        if ( 1 == lpCurrent - lpComponent )
+                        if ( (dwFlags & VALIDATEPATH_ALLOW_INVALID_SPACE_AND_PERIOD) ||
+                             1 == lpCurrent - lpComponent )
                         {
-                            /* Current directory is O.K. */
+                            /* Either do allow periods anywhere, or current directory */
                             lpComponentEnd = lpCurrent;
                             break;
                         }
@@ -97,8 +98,13 @@ static BOOL IsValidFilePathComponent(
                     }
                 case 0:
                 case ' ':
-                    lpComponentEnd = lpCurrent - 1;
-                    fValid = FALSE;
+                    if ( dwFlags & VALIDATEPATH_ALLOW_INVALID_SPACE_AND_PERIOD )
+                        lpComponentEnd = lpCurrent;
+                    else
+                    {
+                        lpComponentEnd = lpCurrent - 1;
+                        fValid = FALSE;
+                    }
                     break;
                 default:
                     lpComponentEnd = lpCurrent;
@@ -351,7 +357,7 @@ DWORD IsValidFilePath(rtl_uString *path, LPCTSTR *lppError, DWORD dwFlags, rtl_u
                 lpComponent = lpszPath + i;
             }
 
-            fValid = IsValidFilePathComponent( lpComponent, &lpComponent, dwFlags );
+            fValid = IsValidFilePathComponent( lpComponent, &lpComponent, dwFlags | VALIDATEPATH_ALLOW_INVALID_SPACE_AND_PERIOD);
 
             if ( fValid && lpComponent )
             {
diff --git a/sal/osl/w32/file_url.h b/sal/osl/w32/file_url.h
index 3fb1364..384dc25 100644
--- a/sal/osl/w32/file_url.h
+++ b/sal/osl/w32/file_url.h
@@ -60,6 +60,7 @@ extern "C" {
 #define VALIDATEPATH_ALLOW_ELLIPSE			0x0002
 #define VALIDATEPATH_ALLOW_RELATIVE			0x0004
 #define VALIDATEPATH_ALLOW_UNC				0x0008
+#define VALIDATEPATH_ALLOW_INVALID_SPACE_AND_PERIOD 0x0010
 
 DWORD IsValidFilePath (
     rtl_uString *  path,
-- 
1.7.0.1

