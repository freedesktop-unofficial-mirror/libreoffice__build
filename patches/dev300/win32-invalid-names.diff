From 02bb85f78ca1836bbcfae6cdbfe79e9b3074de3b Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:54:40 +0200
Subject: [PATCH 097/768] win32-invalid-names.diff

---
 sal/osl/w32/file_url.cxx |   16 +++++++++++-----
 sal/osl/w32/file_url.h   |    1 +
 2 files changed, 12 insertions(+), 5 deletions(-)

diff --git sal/osl/w32/file_url.cxx sal/osl/w32/file_url.cxx
index 246874a..7f2e6ca 100644
--- sal/osl/w32/file_url.cxx
+++ sal/osl/w32/file_url.cxx
@@ -89,9 +89,10 @@ static BOOL IsValidFilePathComponent(
                 case '.':
                     if ( dwFlags & VALIDATEPATH_ALLOW_ELLIPSE )
                     {
-                        if ( 1 == lpCurrent - lpComponent )
+                        if ( (dwFlags & VALIDATEPATH_ALLOW_INVALID_SPACE_AND_PERIOD) ||
+                             1 == lpCurrent - lpComponent )
                         {
-                            /* Current directory is O.K. */
+                            /* Either do allow periods anywhere, or current directory */
                             lpComponentEnd = lpCurrent;
                             break;
                         }
@@ -104,8 +105,13 @@ static BOOL IsValidFilePathComponent(
                     }
                 case 0:
                 case ' ':
-                    lpComponentEnd = lpCurrent - 1;
-                    fValid = FALSE;
+                    if ( dwFlags & VALIDATEPATH_ALLOW_INVALID_SPACE_AND_PERIOD )
+                        lpComponentEnd = lpCurrent;
+                    else
+                    {
+                        lpComponentEnd = lpCurrent - 1;
+                        fValid = FALSE;
+                    }
                     break;
                 default:
                     lpComponentEnd = lpCurrent;
@@ -375,7 +381,7 @@ DWORD IsValidFilePath(rtl_uString *path, LPCTSTR *lppError, DWORD dwFlags, rtl_u
                 lpComponent = lpszPath + i;
             }
 
-            fValid = IsValidFilePathComponent( lpComponent, &lpComponent, dwFlags );
+            fValid = IsValidFilePathComponent( lpComponent, &lpComponent, dwFlags | VALIDATEPATH_ALLOW_INVALID_SPACE_AND_PERIOD);
 
             if ( fValid && lpComponent )
             {
diff --git sal/osl/w32/file_url.h sal/osl/w32/file_url.h
index 8af4b8a..7806eab 100644
--- sal/osl/w32/file_url.h
+++ sal/osl/w32/file_url.h
@@ -61,6 +61,7 @@ extern "C" {
 #define VALIDATEPATH_ALLOW_ELLIPSE			0x0002
 #define VALIDATEPATH_ALLOW_RELATIVE			0x0004
 #define VALIDATEPATH_ALLOW_UNC				0x0008
+#define VALIDATEPATH_ALLOW_INVALID_SPACE_AND_PERIOD 0x0010
 
 #define MAX_LONG_PATH 32767
 
-- 
1.7.0.1

