From 4a0c617948697c9b458ade7dffcf02378afae1d9 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:55:05 +0200
Subject: [PATCH 115/768] sfx2-qstartfixes.diff

---
 sfx2/source/appl/shutdownicon.cxx    |    2 +-
 sfx2/source/appl/shutdowniconunx.cxx |    9 +++++++--
 2 files changed, 8 insertions(+), 3 deletions(-)

diff --git sfx2/source/appl/shutdownicon.cxx sfx2/source/appl/shutdownicon.cxx
index c65393b..71ab5e2 100644
--- sfx2/source/appl/shutdownicon.cxx
+++ sfx2/source/appl/shutdownicon.cxx
@@ -571,8 +571,8 @@ void ShutdownIcon::terminateDesktop()
         return;
         
     // always remove ourselves as listener
-    xDesktop->removeTerminateListener( pInst );
     pInst->m_bListenForTermination = true;
+    xDesktop->removeTerminateListener( pInst );
 
     // terminate desktop only if no tasks exist
     Reference< XFramesSupplier > xSupplier( xDesktop, UNO_QUERY );
diff --git sfx2/source/appl/shutdowniconunx.cxx sfx2/source/appl/shutdowniconunx.cxx
index b9799f5..22cedda 100644
--- sfx2/source/appl/shutdowniconunx.cxx
+++ sfx2/source/appl/shutdowniconunx.cxx
@@ -39,6 +39,7 @@ static ResMgr *pVCLResMgr;
 static EggTrayIcon *pTrayIcon;
 static GtkWidget *pExitMenuItem = NULL;
 static GtkWidget *pOpenMenuItem = NULL;
+static GtkWidget *pDisableMenuItem = NULL;
 
 static void open_url_cb( GtkWidget *, gpointer data )
 {
@@ -67,8 +68,10 @@ static void systray_disable_cb()
 static void exit_quickstarter_cb( GtkWidget * )
 {
     egg_tray_icon_cancel_message (pTrayIcon, 1 );
-    ShutdownIcon::getInstance()->terminateDesktop();
     plugin_shutdown_sys_tray();
+    //terminate may cause this .so to be unloaded. So we must be hands off
+    //all calls into this .so after this call
+    ShutdownIcon::terminateDesktop();
 }
 
 static void menu_deactivate_cb( GtkWidget *pMenu )
@@ -265,7 +268,7 @@ static void populate_menu( GtkWidget *pMenu )
     pMenuItem = gtk_separator_menu_item_new();
     gtk_menu_shell_append( pMenuShell, pMenuItem );
 
-    (void) add_image_menu_item
+    pDisableMenuItem = add_image_menu_item
         ( pMenuShell, GTK_STOCK_CLOSE,
           pShutdownIcon->GetResString( STR_QUICKSTART_PRELAUNCH_UNX ),
           G_CALLBACK( systray_disable_cb ) );
@@ -289,6 +292,7 @@ static void refresh_menu( GtkWidget *pMenu )
     bool bModal = ShutdownIcon::bModalMode;
     gtk_widget_set_sensitive( pExitMenuItem, !bModal);
     gtk_widget_set_sensitive( pOpenMenuItem, !bModal);
+    gtk_widget_set_sensitive( pDisableMenuItem, !bModal);
 }
 
 extern "C" {
@@ -404,6 +408,7 @@ void SAL_DLLPUBLIC_EXPORT plugin_shutdown_sys_tray()
     pTrayIcon = NULL;
     pExitMenuItem = NULL;
     pOpenMenuItem = NULL;
+    pDisableMenuItem = NULL;
 }
 
 #endif // ENABLE_QUICKSTART_APPLET
-- 
1.7.0.1

