From 5537e709305744452672ff952364bf4f9306af5a Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:59:02 +0200
Subject: [PATCH 313/768] fpicker-kde-local-media2.diff

---
 fpicker/source/unx/kde/kdefilepicker.cxx |   33 ++++++++++++++++++++++-------
 fpicker/source/unx/kde/kdefilepicker.hxx |    1 +
 2 files changed, 26 insertions(+), 8 deletions(-)

diff --git fpicker/source/unx/kde/kdefilepicker.cxx fpicker/source/unx/kde/kdefilepicker.cxx
index c3014c6..7953d40 100644
--- fpicker/source/unx/kde/kdefilepicker.cxx
+++ fpicker/source/unx/kde/kdefilepicker.cxx
@@ -345,11 +345,8 @@ void FileDialog::customEvent( QCustomEvent *pEvent )
                         setCanNotifySelection( true );
                         exec();
 
-#if KDE_IS_VERSION(3,5,0)
-                        KURL qLocalSelectedURL = KIO::NetAccess::mostLocalURL( selectedURL(), this );
-#else
-                        KURL qLocalSelectedURL( selectedURL() );
-#endif
+                        KURL qLocalSelectedURL = mostLocalURL( selectedURL() );
+
                         qSelectedURL = addExtension( qLocalSelectedURL.url() );
                         QString qProtocol( qLocalSelectedURL.protocol() );
 
@@ -637,13 +634,33 @@ bool FileDialog::isSupportedProtocol( const QString &rProtocol ) const
     return false;
 }
 
-QString FileDialog::localCopy( const QString &rFileName ) const
+KURL FileDialog::mostLocalURL( const KURL &rURL ) const
 {
 #if KDE_IS_VERSION(3,5,0)
-    KURL qLocalURL = KIO::NetAccess::mostLocalURL( KURL( rFileName ), const_cast<FileDialog*>( this ) );
+    KURL qMostLocalURL( KIO::NetAccess::mostLocalURL( rURL, const_cast<FileDialog*>( this ) ) );
+    if ( qMostLocalURL.isLocalFile() )
+        return qMostLocalURL;
+    else
+    {
+        // Terrible hack to get even non-existing media:// files right
+        qMostLocalURL.cd( ".." );
+        KURL qMostLocalPath( KIO::NetAccess::mostLocalURL( qMostLocalURL, const_cast<FileDialog*>( this ) ) );
+        if ( qMostLocalPath.isLocalFile() )
+        {
+            qMostLocalPath.addPath( rURL.fileName() );
+            return qMostLocalPath;
+        }
+    }
+#endif
+
+    return rURL;
+}
+
+QString FileDialog::localCopy( const QString &rFileName ) const
+{
+    KURL qLocalURL = mostLocalURL( KURL( rFileName ) );
     if ( qLocalURL.isLocalFile() )
         return qLocalURL.url();
-#endif
 
     int nExtensionPos = rFileName.findRev( '/' );
     if ( nExtensionPos >= 0 )
diff --git fpicker/source/unx/kde/kdefilepicker.hxx fpicker/source/unx/kde/kdefilepicker.hxx
index 210a805..ba94d40 100644
--- fpicker/source/unx/kde/kdefilepicker.hxx
+++ fpicker/source/unx/kde/kdefilepicker.hxx
@@ -130,6 +130,7 @@ protected:
     bool                        isExecuting( void ) const { return m_bIsExecuting; }
 
     bool                        isSupportedProtocol( const QString &rProtocol ) const;
+    KURL                        mostLocalURL( const KURL &rURL ) const;
     QString                     localCopy( const QString &rFileName ) const;
 
     void                        setCanNotifySelection( bool bCanNotifySelection ) { m_bCanNotifySelection = bCanNotifySelection; }
-- 
1.7.0.1

