From b2edea4ddbf299c5d27bc38592d4b6dc322a61d3 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:54:38 +0200
Subject: [PATCH 116/878] xmlhelp-work-with-symlinks.diff

---
 xmlhelp/source/cxxhelp/provider/databases.cxx |   21 +++++++++++++--------
 xmlhelp/source/treeview/tvread.cxx            |   12 +++++++++---
 2 files changed, 22 insertions(+), 11 deletions(-)

diff --git a/xmlhelp/source/cxxhelp/provider/databases.cxx b/xmlhelp/source/cxxhelp/provider/databases.cxx
index e68bb22..7c901c5 100644
--- a/xmlhelp/source/cxxhelp/provider/databases.cxx
+++ b/xmlhelp/source/cxxhelp/provider/databases.cxx
@@ -28,10 +28,9 @@
 // MARKER(update_precomp.py): autogen include statement, do not remove
 #include "precompiled_xmlhelp.hxx"
 #include "db.hxx"
-#ifndef _VOS_DIAGNOSE_HXX_
 #include <vos/diagnose.hxx>
-#endif
 #include <osl/thread.h>
+#include <osl/process.h>
 #include <rtl/uri.hxx>
 #include <osl/file.hxx>
 #include <rtl/memory.h>
@@ -255,17 +254,21 @@ static bool impl_getZipFile(
         const rtl::OUString & rZipName,
         rtl::OUString & rFileName )
 {
+    rtl::OUString aWorkingDir;
+    osl_getProcessWorkingDir( &aWorkingDir.pData );
     const rtl::OUString *pPathArray = rImagesZipPaths.getArray();
     for ( int i = 0; i < rImagesZipPaths.getLength(); ++i )
     {
-        rFileName = pPathArray[ i ];
-        if ( rFileName.getLength() )
+        rtl::OUString aFileName = pPathArray[ i ];
+        if ( aFileName.getLength() )
         {
-            if ( 1 + rFileName.lastIndexOf( '/' ) != rFileName.getLength() )
+            if ( 1 + aFileName.lastIndexOf( '/' ) != aFileName.getLength() )
             {
-                rFileName += rtl::OUString::createFromAscii( "/" );
+                aFileName += rtl::OUString::createFromAscii( "/" );
             }
-            rFileName += rZipName;
+            aFileName += rZipName;
+            // the icons are not read when the URL is a symlink
+            osl::File::getAbsoluteFileURL( aWorkingDir, aFileName, rFileName );
 
             // test existence
             osl::DirectoryItem aDirItem;
@@ -1290,7 +1293,9 @@ void Databases::cascadingStylesheet( const rtl::OUString& Language,
                 osl::FileBase::E_None == aFile.open( OpenFlag_Read )                 &&
                 osl::FileBase::E_None == aDirItem.getFileStatus( aStatus ) )
             {
-                m_nCustomCSSDocLength = int( aStatus.getFileSize() );
+                sal_uInt64 nSize;
+                aFile.getSize( nSize );
+                m_nCustomCSSDocLength = (int)nSize;
                 m_pCustomCSSDoc = new char[ 1 + m_nCustomCSSDocLength ];
                 m_pCustomCSSDoc[ m_nCustomCSSDocLength ] = 0;
                 sal_uInt64 a = m_nCustomCSSDocLength,b = m_nCustomCSSDocLength;
diff --git a/xmlhelp/source/treeview/tvread.cxx b/xmlhelp/source/treeview/tvread.cxx
index 8f8320a..8737b3e 100644
--- a/xmlhelp/source/treeview/tvread.cxx
+++ b/xmlhelp/source/treeview/tvread.cxx
@@ -778,9 +778,15 @@ ConfigData TVChildTarget::init( const Reference< XMultiServiceFactory >& xSMgr )
                 rtl::OUString baseName = aFileName.copy(0,idx_).toAsciiLowerCase();
                 if(! showBasic && baseName.compareToAscii("sbasic") == 0 )
                   continue;
-                
-                configData.vFileLen.push_back( aFileStatus.getFileSize() );
-                configData.vFileURL.push_back( aFileUrl );
+                osl::File aFile( aFileUrl );
+                if( osl::FileBase::E_None == aFile.open( OpenFlag_Read ) )
+                {
+                    sal_uInt64 nSize;
+                    aFile.getSize( nSize );
+                    configData.vFileLen.push_back( aFileStatus.getFileSize() );
+                    configData.vFileURL.push_back( aFileUrl );
+                    aFile.close();
+                }
               }
           }
         aDirectory.close();
-- 
1.7.0.1

