From c58521711b3f1b5f495d5c59e6d6de5ad430b15e Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:59:05 +0200
Subject: [PATCH 316/768] fpicker-kde-non-utf8.diff

---
 fpicker/source/unx/kde/kdefilepicker.cxx |   53 ++++++++++++++---------------
 fpicker/source/unx/kde/kdefilepicker.hxx |    1 +
 2 files changed, 27 insertions(+), 27 deletions(-)

diff --git fpicker/source/unx/kde/kdefilepicker.cxx fpicker/source/unx/kde/kdefilepicker.cxx
index bda3117..3aa5ebc 100644
--- fpicker/source/unx/kde/kdefilepicker.cxx
+++ fpicker/source/unx/kde/kdefilepicker.cxx
@@ -260,38 +260,14 @@ void FileDialog::customEvent( QCustomEvent *pEvent )
                     {
                         KURL::List qList( selectedURLs() );
                         for ( KURL::List::const_iterator it = qList.begin(); it != qList.end(); ++it )
-                        {
-                            qString.append( " " );
-                            QString qUrlStr = addExtension( (*it).url() );
-
-                            if ( !isExecuting() && !isSupportedProtocol( KURL( qUrlStr ).protocol() ) )
-                                qUrlStr = localCopy( qUrlStr );
-
-                            if ( qUrlStr.startsWith( "file:/" ) && qUrlStr.mid( 6, 1 ) != "/" )
-                                qUrlStr.replace( "file:/", "file:///" );
-
-                            if ( !qUrlStr.isEmpty() )
-                                appendEscaped( qString, qUrlStr );
-                        }
+                            appendURL( qString, (*it) );
                     }
                     else
                     {
                         // we have to return the selected files anyway
                         const KFileItemList *pItems = ops->selectedItems();
                         for ( KFileItemListIterator it( *pItems ); it.current(); ++it )
-                        {
-                            qString.append( " " );
-                            QString qUrlStr = addExtension( (*it)->url().url() );
-
-                            if ( !isExecuting() && !isSupportedProtocol( KURL( qUrlStr ).protocol() ) )
-                                qUrlStr = localCopy( qUrlStr );
-
-                            if ( qUrlStr.startsWith( "file:/" ) && qUrlStr.mid( 6, 1 ) != "/" )
-                                qUrlStr.replace( "file:/", "file:///" );
-
-                            if ( !qUrlStr.isEmpty() )
-                                appendEscaped( qString, qUrlStr );
-                        }
+                            appendURL( qString, (*it)->url() );
                     }
 
                     sendCommand( qString );
@@ -661,7 +637,8 @@ KURL FileDialog::mostLocalURL( const KURL &rURL ) const
 
 QString FileDialog::localCopy( const QString &rFileName ) const
 {
-    KURL qLocalURL = mostLocalURL( KURL( rFileName ) );
+    // 106 == MIB enum for UTF-8
+    KURL qLocalURL = mostLocalURL( KURL( rFileName, 106 ) );
     if ( qLocalURL.isLocalFile() )
         return qLocalURL.url();
 
@@ -712,6 +689,28 @@ void FileDialog::sendCommand( const QString &rCommand )
     ::std::cout << rCommand.utf8() << ::std::endl;
 }
 
+void FileDialog::appendURL( QString &rBuffer, const KURL &rURL )
+{
+    // From Martin Kretzschmar:
+    // file:///path/to/test%E0.odt is not a valid URL from OOo's point of
+    // view. (?Most modern parts of?) OOo assume(s) that the URL contains only
+    // ASCII characters (which test%E0.odt does) and is UTF-8 after unescaping
+    // (which file:///path/test%E0.odt is not).
+    // Cf. the comment in sal/inc/osl/file.h.
+    // 106 == MIB enum for UTF-8
+    QString qUrlStr = addExtension( rURL.url( 0, 106 ) );
+
+    if ( !isExecuting() && !isSupportedProtocol( rURL.protocol() ) )
+        qUrlStr = localCopy( qUrlStr );
+
+    if ( qUrlStr.startsWith( "file:/" ) && qUrlStr.mid( 6, 1 ) != "/" )
+        qUrlStr.replace( "file:/", "file:///" );
+
+    rBuffer.append( " " );
+    if ( !qUrlStr.isEmpty() )
+        appendEscaped( rBuffer, qUrlStr );
+}
+
 void FileDialog::appendEscaped( QString &rBuffer, const QString &rString )
 {
     const QChar *pUnicode = rString.unicode();
diff --git fpicker/source/unx/kde/kdefilepicker.hxx fpicker/source/unx/kde/kdefilepicker.hxx
index ba94d40..b17b48f 100644
--- fpicker/source/unx/kde/kdefilepicker.hxx
+++ fpicker/source/unx/kde/kdefilepicker.hxx
@@ -142,6 +142,7 @@ protected slots:
 
 protected:
     void                        sendCommand( const QString &rCommand );
+    void                        appendURL( QString &rBuffer, const KURL &rURL );
     void                        appendEscaped( QString &rBuffer, const QString &rString );
     QString                     escapeString( const QString &rString );
 };
-- 
1.7.0.1

