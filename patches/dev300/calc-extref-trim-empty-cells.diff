From fc8ca227ba8e7b6caf497ef8bca963cac62d5b8c Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:08:28 +0200
Subject: [PATCH 817/878] calc-extref-trim-empty-cells.diff

---
 sc/source/ui/docshell/externalrefmgr.cxx |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/sc/source/ui/docshell/externalrefmgr.cxx b/sc/source/ui/docshell/externalrefmgr.cxx
index 001137a..7b1e469 100644
--- a/sc/source/ui/docshell/externalrefmgr.cxx
+++ b/sc/source/ui/docshell/externalrefmgr.cxx
@@ -574,6 +574,15 @@ ScExternalRefCache::TokenArrayRef ScExternalRefCache::getCellRangeData(
             }
         }
 #else
+        vector<SCROW> aRows;
+        pTab->getAllRows(aRows, nDataRow1, nDataRow2);
+        if (aRows.empty())
+            // Cache is empty.
+            return TokenArrayRef();
+        else
+            // Trim the column below the last non-empty row.
+            nDataRow2 = aRows.back();
+
         // Empty all matrix elements first, and fill only non-empty elements.
         for (SCROW nRow = nDataRow1; nRow <= nDataRow2; ++nRow)
         {
-- 
1.7.0.1

