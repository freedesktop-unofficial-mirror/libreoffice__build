From 97cd663f3f42dc30010f905143bb220531e3e35a Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:08:28 +0200
Subject: [PATCH 721/768] calc-extref-trim-empty-cells.diff

---
 sc/source/ui/docshell/externalrefmgr.cxx |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git sc/source/ui/docshell/externalrefmgr.cxx sc/source/ui/docshell/externalrefmgr.cxx
index db275cd..c4e2ea1 100644
--- sc/source/ui/docshell/externalrefmgr.cxx
+++ sc/source/ui/docshell/externalrefmgr.cxx
@@ -621,6 +621,15 @@ ScExternalRefCache::TokenArrayRef ScExternalRefCache::getCellRangeData(
             }
         }
 #else
+        vector<SCROW> aRows;
+        pTab->getAllRows(aRows, nDataRow1, nDataRow2);
+        if (aRows.empty())
+            // Cache is empty.
+            return TokenArrayRef();
+        else
+            // Trim the column below the last non-empty row.
+            nDataRow2 = aRows.back();
+
         // Empty all matrix elements first, and fill only non-empty elements.
         for (SCROW nRow = nDataRow1; nRow <= nDataRow2; ++nRow)
         {
-- 
1.7.0.1

