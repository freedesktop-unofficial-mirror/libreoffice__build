From 5e5469aeed30575a701df8d09b9841670679eda8 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:59:01 +0200
Subject: [PATCH 349/878] fpicker-kde-local-media.diff

---
 fpicker/source/unx/kde/kdefilepicker.cxx |   16 ++++++++++++++--
 1 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/fpicker/source/unx/kde/kdefilepicker.cxx b/fpicker/source/unx/kde/kdefilepicker.cxx
index ea16051..c3014c6 100644
--- a/fpicker/source/unx/kde/kdefilepicker.cxx
+++ b/fpicker/source/unx/kde/kdefilepicker.cxx
@@ -76,6 +76,7 @@
 #define emit
 #endif
 
+#include <kdeversion.h>
 #include <kdiroperator.h>
 #include <kfiledialog.h>
 #include <kfilefiltercombo.h>
@@ -344,8 +345,13 @@ void FileDialog::customEvent( QCustomEvent *pEvent )
                         setCanNotifySelection( true );
                         exec();
 
-                        qSelectedURL = addExtension( selectedURL().url() );
-                        QString qProtocol( selectedURL().protocol() );
+#if KDE_IS_VERSION(3,5,0)
+                        KURL qLocalSelectedURL = KIO::NetAccess::mostLocalURL( selectedURL(), this );
+#else
+                        KURL qLocalSelectedURL( selectedURL() );
+#endif
+                        qSelectedURL = addExtension( qLocalSelectedURL.url() );
+                        QString qProtocol( qLocalSelectedURL.protocol() );
 
                         if ( isSave() && result() == QDialog::Accepted )
                         {
@@ -633,6 +639,12 @@ bool FileDialog::isSupportedProtocol( const QString &rProtocol ) const
 
 QString FileDialog::localCopy( const QString &rFileName ) const
 {
+#if KDE_IS_VERSION(3,5,0)
+    KURL qLocalURL = KIO::NetAccess::mostLocalURL( KURL( rFileName ), const_cast<FileDialog*>( this ) );
+    if ( qLocalURL.isLocalFile() )
+        return qLocalURL.url();
+#endif
+
     int nExtensionPos = rFileName.findRev( '/' );
     if ( nExtensionPos >= 0 )
         nExtensionPos = rFileName.find( '.', nExtensionPos );
-- 
1.7.0.1

