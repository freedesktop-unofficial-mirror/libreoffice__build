From 55caad4e9ad4c8e4eb904da61cc1f4c4f9307da9 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:57:39 +0200
Subject: [PATCH 273/878] build-java-target.diff

---
 configure.in              |   62 +++++++++++++++++++++++++++++++++++++++++++++
 hsqldb/makefile.mk        |    2 +-
 qadevOOo/makefile.mk      |    2 +-
 rhino/makefile.mk         |    2 +-
 set_soenv.in              |    3 ++
 solenv/inc/antsettings.mk |   29 +++++++++++---------
 solenv/inc/settings.mk    |    3 ++
 7 files changed, 87 insertions(+), 16 deletions(-)

diff --git a/configure.in b/configure.in
index 8d5e7e8..b49687d 100644
--- a/configure.in
+++ b/configure.in
@@ -591,6 +591,17 @@ AC_ARG_WITH(java,
                           no support for Java components, applets, accessibility
                           or XML filters. 
 ], if test "$withval" = "yes"; then WITH_JAVA=java; else WITH_JAVA=$withval; fi, WITH_JAVA=java)
+AC_ARG_WITH(java_target_version,
+[  --with-java-target-version   Generate class files that will work on JVMs with
+              the specified version. For example, use
+              --with-java-target-version=1.4 to make sure that the
+              application will work with JVM 1.4 even when compiled
+              with JDK 1.5.
+
+              This option is ignored when you compile with gcj/gij.
+
+                          Usage: --with-java-target-version=<jvm version>
+],,)
 AC_ARG_ENABLE(gcjaot,
 [  --enable-gcjaot         Build with[[out]] using Ahead of Time java compilation
                           support to speed up buildsi by compiling the jars also
@@ -2958,6 +2969,44 @@ else
    JAVA_HOME=NO_JAVA_HOME ; export JAVA_HOME
 fi
 
+_java_target_ver="1.5"
+dnl ===================================================================
+dnl Check for target java bytecode version
+dnl ===================================================================
+if test "$SOLAR_JAVA" != ""; then
+    AC_MSG_CHECKING([for target java bytecode version])
+    if test "$JDK" = "gcj" -o "$JDK" = "kaffe"; then
+    AC_MSG_RESULT([default by $JDK])
+    if test -n "$with_java_target_version" -a "$with_java_target_version" != "no" ; then
+        AC_MSG_WARN([Value defined by --with-java-target-version is ignored!])
+    fi
+    else
+    if test -n "$with_java_target_version" -a "$with_java_target_version" != "no" ; then
+        _java_target_ver="$with_java_target_version"
+        AC_MSG_RESULT([$_java_target_ver])
+    elif test $_jdk_ver -gt 10000 ; then
+        _java_target_ver=`echo "$_jdk_ver" | $AWK '{ maj=substr($0,1,1); min=substr($0,2,2); print int(maj)"."int(min) }'`
+        AC_MSG_RESULT([$_java_target_ver])
+    else
+            AC_MSG_ERROR([Unable to guess java bytecode version from java version!])
+    fi
+    fi
+
+    if ! test -z "$_java_target_ver" -o \
+        "$_java_target_ver" = "1.1" -o \
+            "$_java_target_ver" = "1.2" -o \
+        "$_java_target_ver" = "1.3" -o \
+        "$_java_target_ver" = "1.4" -o \
+        "$_java_target_ver" = "1.5" -o \
+        "$_java_target_ver" = "1.6" -o \
+        "$_java_target_ver" = "5" ; then
+        AC_MSG_ERROR([$_java_target_ver is not supported java bytecode version!])
+    fi
+
+    JAVA_SOURCE_VER="$_java_target_ver"
+    JAVA_TARGET_VER="$_java_target_ver"
+fi
+
 dnl ===================================================================
 dnl Checks for javac
 dnl ===================================================================
@@ -3018,6 +3067,17 @@ if test "$SOLAR_JAVA" != ""; then
 fi
 AC_SUBST(JAVACISGCJ)
 
+JAVACISKAFFE=""
+dnl ===================================================================
+dnl Checks that javac is kaffe
+dnl ===================================================================
+if test "$SOLAR_JAVA" != ""; then
+    if test `$JAVACOMPILER -version 2>&1 | grep -c "Kaffe"` -gt 0; then
+        JAVACISKAFFE="yes"
+    fi
+fi
+AC_SUBST(JAVACISKAFFE)
+
 dnl ===================================================================
 dnl Checks for javadoc
 dnl ===================================================================
@@ -3232,6 +3292,8 @@ fi
 AC_SUBST(JAVA_HOME)
 AC_SUBST(JDK)
 AC_SUBST(JAVAFLAGS)
+AC_SUBST(JAVA_SOURCE_VER)
+AC_SUBST(JAVA_TARGET_VER)
 AC_SUBST(JAVAINTERPRETER)
 AC_SUBST(JAVACOMPILER)
 AC_SUBST(JAVAAOTCOMPILER)
diff --git a/hsqldb/makefile.mk b/hsqldb/makefile.mk
index fa56888..ba00f3f 100644
--- a/hsqldb/makefile.mk
+++ b/hsqldb/makefile.mk
@@ -65,7 +65,7 @@ BUILD_ACTION=$(ANT) -Dbuild.label="build-$(RSCREVISION)" -Dbuild.compiler=gcj -f
 .IF "$(debug)"!=""
 BUILD_ACTION=$(ANT) -Dbuild.label="build-$(RSCREVISION)" -Dbuild.debug="on" -f $(ANT_BUILDFILE) jar
 .ELSE
-BUILD_ACTION=$(ANT) -Dbuild.label="build-$(RSCREVISION)" -f $(ANT_BUILDFILE) jar
+BUILD_ACTION=$(ANT) -Dbuild.label="build-$(RSCREVISION)" -Dant.build.javac.source=$(JAVA_SOURCE_VER) -Dant.build.javac.target=$(JAVA_TARGET_VER) -f $(ANT_BUILDFILE) jar
 .ENDIF
 .ENDIF
 
diff --git a/qadevOOo/makefile.mk b/qadevOOo/makefile.mk
index 1562660..1a753ac 100644
--- a/qadevOOo/makefile.mk
+++ b/qadevOOo/makefile.mk
@@ -43,7 +43,7 @@ TST:
 
 .IF "$(SOLAR_JAVA)"=="TRUE"	
 .IF "$(ANT_HOME)"!="NO_ANT_HOME"
-ANT_FLAGS+=-Dbuild.source=1.5
+ANT_FLAGS+=-Dbuild.source=$(JAVA_SOURCE_VER)
 .IF "$(L10N_framework)"==""
 ALLTAR: ANTBUILD
 .ENDIF
diff --git a/rhino/makefile.mk b/rhino/makefile.mk
index f35367b..739d592 100644
--- a/rhino/makefile.mk
+++ b/rhino/makefile.mk
@@ -51,7 +51,7 @@ JAVA_HOME=
 .EXPORT : JAVA_HOME
 BUILD_ACTION=$(ANT) -Dbuild.label="build-$(RSCREVISION)" -Dbuild.compiler=gcj jar
 .ELSE
-BUILD_ACTION=$(ANT) -Dbuild.label="build-$(RSCREVISION)" jar
+BUILD_ACTION=$(ANT) -Dbuild.label="build-$(RSCREVISION)" -Dant.build.javac.source=$(JAVA_SOURCE_VER) -Dant.build.javac.target=$(JAVA_TARGET_VER) jar
 .ENDIF
 
 # --- Targets ------------------------------------------------------
diff --git a/set_soenv.in b/set_soenv.in
index ebf5784..4c330ab 100644
--- a/set_soenv.in
+++ b/set_soenv.in
@@ -1769,6 +1769,7 @@ ToFile( "DMAKEROOT",         $DMAKEROOT,         "e" );
 if ( $JDK ne "gcj" ) {
    ToFile( "CLASSPATH",         $CLASSPATH,         "e" );
    ToFile( "XCLASSPATH",        $XCLASSPATH,        "e" );
+   ToFile( "JAVACISKAFFE",     '@JAVACISKAFFE@',    "e" );
 }
 else {
    ToFile( "JAVACISGCJ",       '@JAVACISGCJ@',      "e" );
@@ -1780,6 +1781,8 @@ if ( '@JDK@' ne '' )
 { 
    ToFile( "JDK",             "@JDK@",           "e" );
    ToFile( "JAVAFLAGS",             "@JAVAFLAGS@",           "e" );
+   ToFile( "JAVA_SOURCE_VER", "@JAVA_SOURCE_VER@","e" );
+   ToFile( "JAVA_TARGET_VER", "@JAVA_TARGET_VER@","e" );
    ToFile( "JAVAINTERPRETER", PathFormat("@JAVAINTERPRETER@"), "e" );
    ToFile( "JAVACOMPILER",    PathFormat("@JAVACOMPILER@"), "e" );
    ToFile( "JAVAAOTCOMPILER", PathFormat("@JAVAAOTCOMPILER@"), "e" );
diff --git a/solenv/inc/antsettings.mk b/solenv/inc/antsettings.mk
index 3d8bff2..ec2715b 100644
--- a/solenv/inc/antsettings.mk
+++ b/solenv/inc/antsettings.mk
@@ -44,6 +44,18 @@ PATH!:=$(ANT_HOME)/bin:$(PATH)
 ANT*:=$(ANT_HOME)/bin/ant
 ANT_BUILDFILE*=build.xml
 
+.IF "$(ANT_COMPILER_FLAGS)"==""
+.IF "$(JAVACISGCJ)" == "yes"
+ANT_COMPILER_FLAGS=-Dbuild.compiler=gcj
+.ENDIF
+.ENDIF
+
+.IF "$(ANT_JAVA_VER_FLAGS)"==""
+.IF "$(JDK)" != "gcj" && $(JAVACISKAFFE) != "yes"
+ANT_JAVA_VER_FLAGS=-Dant.build.javac.source=$(JAVA_SOURCE_VER) -Dant.build.javac.target=$(JAVA_TARGET_VER)
+.ENDIF
+.ENDIF
+
 .IF "$(ANT_DEBUG)"==""
 .IF "$(debug)"==""
 ANT_DEBUG=off
@@ -65,21 +77,12 @@ JAVA_HOME=
 .EXPORT : JAVA_HOME
 .ENDIF
 
-.IF "$(JAVACISGCJ)" == "yes"
-ANT_FLAGS!:=-Dbuild.compiler=gcj -Dprj=$(PRJ) -Dprjname=$(PRJNAME) -Ddebug=$(ANT_DEBUG) \
- -Doptimize=$(ANT_OPT) -Dtarget=$(TARGET) -Dsolar.update=on -Dout=$(OUT) -Dinpath=$(INPATH) \
- -Dproext="$(PROEXT)" -Dsolar.bin=$(SOLARBINDIR) -Dsolar.jar=$(SOLARBINDIR) \
- -Dsolar.doc=$(SOLARDOCDIR) -Dcommon.jar=$(SOLARCOMMONBINDIR) \
+ANT_FLAGS!:=$(ANT_COMPILER_FLAGS) -Dprj=$(PRJ) -Dprjname=$(PRJNAME) $(ANT_JAVA_VER_FLAGS) \
+ -Ddebug=$(ANT_DEBUG) -Doptimize=$(ANT_OPT) -Dtarget=$(TARGET) -Dsolar.update=on \
+ -Dout=$(OUT) -Dinpath=$(INPATH) -Dproext="$(PROEXT)" -Dsolar.bin=$(SOLARBINDIR) \
+ -Dsolar.jar=$(SOLARBINDIR) -Dsolar.doc=$(SOLARDOCDIR) -Dcommon.jar=$(SOLARCOMMONBINDIR) \
  -Dcommon.doc=$(SOLARCOMMONDOCDIR) -Dsolar.sourceversion=$(SOURCEVERSION) \
  -Dsolar.lastminor=$(LAST_MINOR) -Dsolar.build=$(BUILD) -f $(ANT_BUILDFILE) $(ANT_FLAGS) -emacs
-.ELSE
-ANT_FLAGS!:=-Dprj=$(PRJ) -Dprjname=$(PRJNAME) -Ddebug=$(ANT_DEBUG) -Doptimize=$(ANT_OPT) \
- -Dtarget=$(TARGET) -Dsolar.update=on -Dout=$(OUT) -Dinpath=$(INPATH) -Dproext="$(PROEXT)" \
- -Dsolar.bin=$(SOLARBINDIR) -Dsolar.jar=$(SOLARBINDIR) -Dsolar.doc=$(SOLARDOCDIR) \
- -Dcommon.jar=$(SOLARCOMMONBINDIR) -Dcommon.doc=$(SOLARCOMMONDOCDIR) \
- -Dsolar.sourceversion=$(SOURCEVERSION) -Dsolar.lastminor=$(LAST_MINOR) \
- -Dsolar.build=$(BUILD) -f $(ANT_BUILDFILE) $(ANT_FLAGS) -emacs
-.ENDIF
 .ELSE # No java
 ANT=
 ANT_FLAGS=
diff --git a/solenv/inc/settings.mk b/solenv/inc/settings.mk
index 724eea3..d21f3a8 100644
--- a/solenv/inc/settings.mk
+++ b/solenv/inc/settings.mk
@@ -159,6 +159,9 @@ JAVAI:=$(JAVAINTERPRETER)
 .IF "$(JAVACISGCJ)" == "yes"
 JAVAC+=--encoding=UTF-8 -O2 -fno-assert -Wno-deprecated -C
 .ENDIF
+.IF "$(JDK)" != "gcj" && $(JAVACISKAFFE) != "yes"
+JAVAC+=-source $(JAVA_SOURCE_VER) -target $(JAVA_TARGET_VER)
+.ENDIF
 
 #classpath and response
 .IF "$(JDK)" == "J++"
-- 
1.7.0.1

