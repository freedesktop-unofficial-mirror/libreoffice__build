From 7ca21f34959300dd90077283806b20ddd6c0b036 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:53:33 +0200
Subject: [PATCH 042/768] cjk-character-units-fix-376788.diff

---
 cui/source/tabpages/paragrph.cxx |   32 +++++++++++++++++++++++---------
 svtools/source/control/ruler.cxx |    6 ++++++
 sw/source/ui/app/swmodul1.cxx    |   14 ++++++++++----
 sw/source/ui/config/optload.cxx  |    8 +++++---
 sw/source/ui/misc/pggrid.cxx     |    4 ++--
 sw/source/ui/uiview/view.cxx     |   36 ++++++++++++++++++++++++++++++------
 6 files changed, 76 insertions(+), 24 deletions(-)

diff --git cui/source/tabpages/paragrph.cxx cui/source/tabpages/paragrph.cxx
index 14128e6..18fa66d 100644
--- cui/source/tabpages/paragrph.cxx
+++ cui/source/tabpages/paragrph.cxx
@@ -441,17 +441,25 @@ void SvxStdParagraphTabPage::Reset( const SfxItemSet& rSet )
 
     BOOL bApplyCharUnit = GetApplyCharUnit( &rSet );
 
-    if ( bApplyCharUnit )
+    SvtCJKOptions aCJKOptions;
+    if(aCJKOptions.IsAsianTypographyEnabled() && bApplyCharUnit )
         eFUnit = FUNIT_CHAR;
+
     SetFieldUnit( aLeftIndent, eFUnit );
     SetFieldUnit( aRightIndent, eFUnit );
     SetFieldUnit( aFLineIndent, eFUnit );
-    if ( bApplyCharUnit )
-        eFUnit = FUNIT_LINE;
-    SetFieldUnit( aTopDist, eFUnit );
-    SetFieldUnit( aBottomDist, eFUnit );
-    eFUnit = FUNIT_POINT;
-    SetFieldUnit( aLineDistAtMetricBox, eFUnit );
+    if ( eFUnit == FUNIT_CHAR )
+    {
+        SetFieldUnit( aTopDist, FUNIT_LINE );
+        SetFieldUnit( aBottomDist, FUNIT_LINE );
+        SetFieldUnit( aLineDistAtMetricBox, FUNIT_POINT );
+    }
+    else
+    {
+        SetFieldUnit( aTopDist, eFUnit );
+        SetFieldUnit( aBottomDist, eFUnit );
+        SetFieldUnit( aLineDistAtMetricBox, eFUnit );
+    }
 
     USHORT _nWhich = GetWhich( SID_ATTR_LRSPACE );
     SfxItemState eItemState = rSet.GetItemState( _nWhich );
@@ -543,7 +551,10 @@ void SvxStdParagraphTabPage::Reset( const SfxItemSet& rSet )
             else
             {
                 aTopDist.SetRelative();
-                SetFieldUnit( aTopDist, eFUnit );
+                if ( eFUnit == FUNIT_CHAR )
+                    SetFieldUnit( aTopDist, FUNIT_LINE );
+                else
+                    SetFieldUnit( aTopDist, eFUnit );
                 SetMetricValue( aTopDist, rOldItem.GetUpper(), eUnit );
             }
 
@@ -555,7 +566,10 @@ void SvxStdParagraphTabPage::Reset( const SfxItemSet& rSet )
             else
             {
                 aBottomDist.SetRelative();
-                SetFieldUnit( aBottomDist, eFUnit );
+                if ( eFUnit == FUNIT_CHAR )
+                    SetFieldUnit( aBottomDist, FUNIT_LINE );
+                else
+                    SetFieldUnit( aBottomDist, eFUnit );
                 SetMetricValue( aBottomDist, rOldItem.GetLower(), eUnit );
             }
         }
diff --git svtools/source/control/ruler.cxx svtools/source/control/ruler.cxx
index 24092c3..ba56da2 100644
--- svtools/source/control/ruler.cxx
+++ svtools/source/control/ruler.cxx
@@ -268,6 +268,8 @@ void Ruler::ImplInit( WinBits nWinBits )
     mnExtraStyle    = 0;                    // Style des Extra-Feldes
     mnExtraClicks   = 0;                    // Click-Anzahl fuer Extra-Feld
     mnExtraModifier = 0;                    // Modifier-Tasten beim Click im Extrafeld
+    mnCharWidth     = 371;
+    mnLineHeight    = 551;
     mbCalc          = TRUE;                 // Muessen Pagebreiten neu berechnet werden
     mbFormat        = TRUE;                 // Muss neu ausgegeben werden
     mbDrag          = FALSE;                // Sind wir im Drag-Modus
@@ -476,6 +478,8 @@ void Ruler::ImplDrawTicks( long nMin, long nMax, long nStart, long nCenter )
     long    nTick2 ;
     if ( mnUnitIndex == RULER_UNIT_CHAR )
     {
+        if ( mnCharWidth == 0 )
+            mnCharWidth = 371;
         nTick3 = mnCharWidth*2;
         nTickCount = mnCharWidth;
         nTickUnit = mnCharWidth;
@@ -483,6 +487,8 @@ void Ruler::ImplDrawTicks( long nMin, long nMax, long nStart, long nCenter )
     }
     else if ( mnUnitIndex == RULER_UNIT_LINE )
     {
+        if ( mnLineHeight == 0 )
+            mnLineHeight = 551;
         nTick3 = mnLineHeight*2;
         nTickCount = mnLineHeight;
         nTickUnit = mnLineHeight;
diff --git sw/source/ui/app/swmodul1.cxx sw/source/ui/app/swmodul1.cxx
index 07430ed..ee34a77 100644
--- sw/source/ui/app/swmodul1.cxx
+++ sw/source/ui/app/swmodul1.cxx
@@ -47,6 +47,7 @@
 #include <editeng/colritem.hxx>
 #include <editeng/brshitem.hxx>
 #include <vcl/msgbox.hxx>
+#include <svtools/cjkoptions.hxx>
 #include <swmodule.hxx>
 #include <swtypes.hxx>
 #include <usrpref.hxx>
@@ -348,10 +349,15 @@ void SwModule::ApplyUserCharUnit(BOOL bApplyChar, BOOL bWeb)
     }
     else
     {
-        if ( eHScrollMetric == FUNIT_CHAR )
-            eHScrollMetric == FUNIT_CM;
-        if ( eVScrollMetric == FUNIT_LINE )
-            eVScrollMetric == FUNIT_CM;
+        SvtCJKOptions aCJKOptions;
+        if ( !aCJKOptions.IsAsianTypographyEnabled() && ( eHScrollMetric == FUNIT_CHAR ))
+            eHScrollMetric = FUNIT_INCH;
+        else if ( eHScrollMetric == FUNIT_CHAR )
+            eHScrollMetric = FUNIT_CM;
+        if ( !aCJKOptions.IsAsianTypographyEnabled() && ( eVScrollMetric == FUNIT_LINE ))
+            eVScrollMetric = FUNIT_INCH;
+        else if ( eVScrollMetric == FUNIT_LINE )
+            eVScrollMetric = FUNIT_CM;
     }
     SwView* pTmpView = SwModule::GetFirstView();
     // fuer alle MDI-Fenster das Lineal umschalten
diff --git sw/source/ui/config/optload.cxx sw/source/ui/config/optload.cxx
index a03f492..31f1964 100644
--- sw/source/ui/config/optload.cxx
+++ sw/source/ui/config/optload.cxx
@@ -127,7 +127,6 @@ SwLoadOptPage::SwLoadOptPage( Window* pParent, const SfxItemSet& rSet ) :
             case FUNIT_POINT:
             case FUNIT_PICA:
             case FUNIT_INCH:
-            case FUNIT_CHAR:
             {
                 // nur diese Metriken benutzen
                 USHORT nPos = aMetricLB.InsertEntry( sMetric );
@@ -229,9 +228,12 @@ BOOL __EXPORT SwLoadOptPage::FillItemSet( SfxItemSet& rSet )
         bRet = TRUE;
     }
 
-    if(aUseCharUnit.IsChecked() != aUseCharUnit.GetSavedValue())
+    sal_Bool bIsUseCharUnitFlag = aUseCharUnit.IsChecked();
+    SvtCJKOptions aCJKOptions;
+        bIsUseCharUnitFlag = bIsUseCharUnitFlag && aCJKOptions.IsAsianTypographyEnabled();
+    if( bIsUseCharUnitFlag != aUseCharUnit.GetSavedValue())
     {
-        rSet.Put(SfxBoolItem(SID_ATTR_APPLYCHARUNIT, aUseCharUnit.IsChecked()));
+        rSet.Put(SfxBoolItem(SID_ATTR_APPLYCHARUNIT, bIsUseCharUnitFlag ));
         bRet = TRUE;
     }
     
diff --git sw/source/ui/misc/pggrid.cxx sw/source/ui/misc/pggrid.cxx
index bcfc76d..17d2148 100644
--- sw/source/ui/misc/pggrid.cxx
+++ sw/source/ui/misc/pggrid.cxx
@@ -331,9 +331,9 @@ void SwTextGridPage::PutGridItem(SfxItemSet& rSet)
                 m_bHRulerChanged = sal_True;
             }
             m_bVRulerChanged = sal_True;
+            pView->GetHLineal().SetCharWidth((long)(aCharWidthMF.GetValue(FUNIT_TWIP)/56.7));
+            pView->GetVLineal().SetLineHeight((long)(aTextSizeMF.GetValue(FUNIT_TWIP)/56.7));
         }
-        pView->GetHLineal().SetCharWidth((long)(aCharWidthMF.GetValue(FUNIT_TWIP)/56.7));
-        pView->GetVLineal().SetLineHeight((long)(aTextSizeMF.GetValue(FUNIT_TWIP)/56.7));
 }
 /* -----------------------------08.02.2002 10:54------------------------------
 
diff --git sw/source/ui/uiview/view.cxx sw/source/ui/uiview/view.cxx
index 58efc39..691b075 100644
--- sw/source/ui/uiview/view.cxx
+++ sw/source/ui/uiview/view.cxx
@@ -957,16 +957,40 @@ SwView::SwView( SfxViewFrame *_pFrame, SfxViewShell* pOldSh )
 
     BOOL bApplyCharUnit = pUsrPref->IsApplyCharUnit();
     SvtCJKOptions aCJKOptions;
-    if ( aCJKOptions.IsAsianTypographyEnabled() && bApplyCharUnit )
-        pHRuler->SetUnit( FUNIT_CHAR );
+    if ( aCJKOptions.IsAsianTypographyEnabled() )
+    {
+        if ( bApplyCharUnit )
+            eMetric = FUNIT_CHAR;
+        else
+        {
+            if ( eMetric == FUNIT_CHAR )
+                eMetric = FUNIT_CM;
+        }
+    }
     else
-        pHRuler->SetUnit( eMetric );
+    {
+        if ( eMetric == FUNIT_CHAR )
+            eMetric = FUNIT_INCH;
+    }
+    pHRuler->SetUnit( eMetric );
 
     eMetric = pUsrPref->GetVScrollMetric();
-    if ( aCJKOptions.IsAsianTypographyEnabled() && bApplyCharUnit )
-        pVRuler->SetUnit(FUNIT_LINE);
+    if ( aCJKOptions.IsAsianTypographyEnabled() )
+    {
+        if ( bApplyCharUnit )
+            eMetric = FUNIT_LINE;
+        else
+        {
+            if ( eMetric == FUNIT_LINE )
+                eMetric = FUNIT_CM;
+        }
+    }
     else
-        pVRuler->SetUnit( eMetric );
+    {
+        if ( eMetric == FUNIT_LINE )
+            eMetric = FUNIT_INCH;
+    }
+    pVRuler->SetUnit( eMetric );
 
         pHRuler->SetCharWidth( 371 );  // default character width
         pVRuler->SetLineHeight( 551 );  // default line height
-- 
1.7.0.1

