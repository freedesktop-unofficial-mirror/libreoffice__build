From 0ad230adff86da1d73049dfefbdc4cefb9ef5f09 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:53:33 +0200
Subject: [PATCH 058/878] cjk-character-units-fix-376788.diff

---
 svtools/source/control/ruler.cxx |    6 ++++++
 svx/source/cui/paragrph.cxx      |   37 +++++++++++++++++++++++++++----------
 sw/source/ui/app/swmodul1.cxx    |   14 ++++++++++----
 sw/source/ui/config/optload.cxx  |    8 +++++---
 sw/source/ui/misc/pggrid.cxx     |    4 ++--
 sw/source/ui/uiview/view.cxx     |   36 ++++++++++++++++++++++++++++++------
 6 files changed, 80 insertions(+), 25 deletions(-)

diff --git a/svtools/source/control/ruler.cxx b/svtools/source/control/ruler.cxx
index 80eafab..ba081dc 100644
--- a/svtools/source/control/ruler.cxx
+++ b/svtools/source/control/ruler.cxx
@@ -268,6 +268,8 @@ void Ruler::ImplInit( WinBits nWinBits )
     mnExtraStyle    = 0;                    // Style des Extra-Feldes
     mnExtraClicks   = 0;                    // Click-Anzahl fuer Extra-Feld
     mnExtraModifier = 0;                    // Modifier-Tasten beim Click im Extrafeld
+    mnCharWidth     = 371;
+    mnLineHeight    = 551;
     mbCalc          = TRUE;                 // Muessen Pagebreiten neu berechnet werden
     mbFormat        = TRUE;                 // Muss neu ausgegeben werden
     mbDrag          = FALSE;                // Sind wir im Drag-Modus
@@ -476,6 +478,8 @@ void Ruler::ImplDrawTicks( long nMin, long nMax, long nStart, long nCenter )
     long    nTick2 ;
     if ( mnUnitIndex == RULER_UNIT_CHAR )
     {
+        if ( mnCharWidth == 0 )
+            mnCharWidth = 371;
         nTick3 = mnCharWidth*2;
         nTickCount = mnCharWidth;
         nTickUnit = mnCharWidth;
@@ -483,6 +487,8 @@ void Ruler::ImplDrawTicks( long nMin, long nMax, long nStart, long nCenter )
     }
     else if ( mnUnitIndex == RULER_UNIT_LINE )
     {
+        if ( mnLineHeight == 0 )
+            mnLineHeight = 551;
         nTick3 = mnLineHeight*2;
         nTickCount = mnLineHeight;
         nTickUnit = mnLineHeight;
diff --git a/svx/source/cui/paragrph.cxx b/svx/source/cui/paragrph.cxx
index 337d133..053d641 100644
--- a/svx/source/cui/paragrph.cxx
+++ b/svx/source/cui/paragrph.cxx
@@ -81,6 +81,9 @@
 #include <svtools/eitem.hxx> //add CHINA001
 #include <sfx2/request.hxx> //add CHINA001
 #include <svtools/intitem.hxx> //add CHINA001
+#ifndef _SVTOOLS_CJKOPTIONS_HXX
+#include <svtools/cjkoptions.hxx>
+#endif
 
 // static ----------------------------------------------------------------
 
@@ -461,17 +464,25 @@ void SvxStdParagraphTabPage::Reset( const SfxItemSet& rSet )
     BOOL bApplyCharUnit = sal_False ;
     bApplyCharUnit = GetApplyCharUnit( &rSet );
 
-    if ( bApplyCharUnit )
-        eFUnit = FUNIT_CHAR;  // Amelia
+    SvtCJKOptions aCJKOptions;
+    if(aCJKOptions.IsAsianTypographyEnabled() && bApplyCharUnit )
+        eFUnit = FUNIT_CHAR;
+
     SetFieldUnit( aLeftIndent, eFUnit );
     SetFieldUnit( aRightIndent, eFUnit );
     SetFieldUnit( aFLineIndent, eFUnit );
-    if ( bApplyCharUnit )
-        eFUnit = FUNIT_LINE;   // Amelia
-    SetFieldUnit( aTopDist, eFUnit );
-    SetFieldUnit( aBottomDist, eFUnit );
-    eFUnit = FUNIT_POINT;
-    SetFieldUnit( aLineDistAtMetricBox, eFUnit );
+    if ( eFUnit == FUNIT_CHAR )
+    {
+        SetFieldUnit( aTopDist, FUNIT_LINE );
+        SetFieldUnit( aBottomDist, FUNIT_LINE );
+        SetFieldUnit( aLineDistAtMetricBox, FUNIT_POINT );
+    }
+    else
+    {
+        SetFieldUnit( aTopDist, eFUnit );
+        SetFieldUnit( aBottomDist, eFUnit );
+        SetFieldUnit( aLineDistAtMetricBox, eFUnit );
+    }
 
     USHORT _nWhich = GetWhich( SID_ATTR_LRSPACE );
     SfxItemState eItemState = rSet.GetItemState( _nWhich );
@@ -563,7 +574,10 @@ void SvxStdParagraphTabPage::Reset( const SfxItemSet& rSet )
             else
             {
                 aTopDist.SetRelative();
-                SetFieldUnit( aTopDist, eFUnit );
+                if ( eFUnit == FUNIT_CHAR )
+                    SetFieldUnit( aTopDist, FUNIT_LINE );
+                else
+                    SetFieldUnit( aTopDist, eFUnit );
                 SetMetricValue( aTopDist, rOldItem.GetUpper(), eUnit );
             }
 
@@ -575,7 +589,10 @@ void SvxStdParagraphTabPage::Reset( const SfxItemSet& rSet )
             else
             {
                 aBottomDist.SetRelative();
-                SetFieldUnit( aBottomDist, eFUnit );
+                if ( eFUnit == FUNIT_CHAR )
+                    SetFieldUnit( aBottomDist, FUNIT_LINE );
+                else
+                    SetFieldUnit( aBottomDist, eFUnit );
                 SetMetricValue( aBottomDist, rOldItem.GetLower(), eUnit );
             }
         }
diff --git a/sw/source/ui/app/swmodul1.cxx b/sw/source/ui/app/swmodul1.cxx
index d144d71..7ed1e93 100644
--- a/sw/source/ui/app/swmodul1.cxx
+++ b/sw/source/ui/app/swmodul1.cxx
@@ -47,6 +47,7 @@
 #include <svx/colritem.hxx>
 #include <svx/brshitem.hxx>
 #include <vcl/msgbox.hxx>
+#include <svtools/cjkoptions.hxx>
 #include <swmodule.hxx>
 #include <swtypes.hxx>
 #include <usrpref.hxx>
@@ -348,10 +349,15 @@ void SwModule::ApplyUserCharUnit(BOOL bApplyChar, BOOL bWeb)
     }
     else
     {
-        if ( eHScrollMetric == FUNIT_CHAR )
-            eHScrollMetric == FUNIT_CM;
-        if ( eVScrollMetric == FUNIT_LINE )
-            eVScrollMetric == FUNIT_CM;
+        SvtCJKOptions aCJKOptions;
+        if ( !aCJKOptions.IsAsianTypographyEnabled() && ( eHScrollMetric == FUNIT_CHAR ))
+            eHScrollMetric = FUNIT_INCH;
+        else if ( eHScrollMetric == FUNIT_CHAR )
+            eHScrollMetric = FUNIT_CM;
+        if ( !aCJKOptions.IsAsianTypographyEnabled() && ( eVScrollMetric == FUNIT_LINE ))
+            eVScrollMetric = FUNIT_INCH;
+        else if ( eVScrollMetric == FUNIT_LINE )
+            eVScrollMetric = FUNIT_CM;
     }
     SwView* pTmpView = SwModule::GetFirstView();
     // fuer alle MDI-Fenster das Lineal umschalten
diff --git a/sw/source/ui/config/optload.cxx b/sw/source/ui/config/optload.cxx
index a6c97ef..6d2fc21 100644
--- a/sw/source/ui/config/optload.cxx
+++ b/sw/source/ui/config/optload.cxx
@@ -127,7 +127,6 @@ SwLoadOptPage::SwLoadOptPage( Window* pParent, const SfxItemSet& rSet ) :
             case FUNIT_POINT:
             case FUNIT_PICA:
             case FUNIT_INCH:
-            case FUNIT_CHAR:
             {
                 // nur diese Metriken benutzen
                 USHORT nPos = aMetricLB.InsertEntry( sMetric );
@@ -229,9 +228,12 @@ BOOL __EXPORT SwLoadOptPage::FillItemSet( SfxItemSet& rSet )
         bRet = TRUE;
     }
 
-    if(aUseCharUnit.IsChecked() != aUseCharUnit.GetSavedValue())
+    sal_Bool bIsUseCharUnitFlag = aUseCharUnit.IsChecked();
+    SvtCJKOptions aCJKOptions;
+        bIsUseCharUnitFlag = bIsUseCharUnitFlag && aCJKOptions.IsAsianTypographyEnabled();
+    if( bIsUseCharUnitFlag != aUseCharUnit.GetSavedValue())
     {
-        rSet.Put(SfxBoolItem(SID_ATTR_APPLYCHARUNIT, aUseCharUnit.IsChecked()));
+        rSet.Put(SfxBoolItem(SID_ATTR_APPLYCHARUNIT, bIsUseCharUnitFlag ));
         bRet = TRUE;
     }
     
diff --git a/sw/source/ui/misc/pggrid.cxx b/sw/source/ui/misc/pggrid.cxx
index e2ed67c..01a6fbf 100644
--- a/sw/source/ui/misc/pggrid.cxx
+++ b/sw/source/ui/misc/pggrid.cxx
@@ -331,9 +331,9 @@ void SwTextGridPage::PutGridItem(SfxItemSet& rSet)
                 m_bHRulerChanged = sal_True;
             }
             m_bVRulerChanged = sal_True;
+            pView->GetHLineal().SetCharWidth((long)(aCharWidthMF.GetValue(FUNIT_TWIP)/56.7));
+            pView->GetVLineal().SetLineHeight((long)(aTextSizeMF.GetValue(FUNIT_TWIP)/56.7));
         }
-        pView->GetHLineal().SetCharWidth((long)(aCharWidthMF.GetValue(FUNIT_TWIP)/56.7));
-        pView->GetVLineal().SetLineHeight((long)(aTextSizeMF.GetValue(FUNIT_TWIP)/56.7));
 }
 /* -----------------------------08.02.2002 10:54------------------------------
 
diff --git a/sw/source/ui/uiview/view.cxx b/sw/source/ui/uiview/view.cxx
index abc352e..1741e1a 100644
--- a/sw/source/ui/uiview/view.cxx
+++ b/sw/source/ui/uiview/view.cxx
@@ -966,16 +966,40 @@ SwView::SwView( SfxViewFrame *_pFrame, SfxViewShell* pOldSh )
 
     BOOL bApplyCharUnit = pUsrPref->IsApplyCharUnit();
     SvtCJKOptions aCJKOptions;
-    if ( aCJKOptions.IsAsianTypographyEnabled() && bApplyCharUnit )
-        pHRuler->SetUnit( FUNIT_CHAR );
+    if ( aCJKOptions.IsAsianTypographyEnabled() )
+    {
+        if ( bApplyCharUnit )
+            eMetric = FUNIT_CHAR;
+        else
+        {
+            if ( eMetric == FUNIT_CHAR )
+                eMetric = FUNIT_CM;
+        }
+    }
     else
-        pHRuler->SetUnit( eMetric );
+    {
+        if ( eMetric == FUNIT_CHAR )
+            eMetric = FUNIT_INCH;
+    }
+    pHRuler->SetUnit( eMetric );
 
     eMetric = pUsrPref->GetVScrollMetric();
-    if ( aCJKOptions.IsAsianTypographyEnabled() && bApplyCharUnit )
-        pVRuler->SetUnit(FUNIT_LINE);
+    if ( aCJKOptions.IsAsianTypographyEnabled() )
+    {
+        if ( bApplyCharUnit )
+            eMetric = FUNIT_LINE;
+        else
+        {
+            if ( eMetric == FUNIT_LINE )
+                eMetric = FUNIT_CM;
+        }
+    }
     else
-        pVRuler->SetUnit( eMetric );
+    {
+        if ( eMetric == FUNIT_LINE )
+            eMetric = FUNIT_INCH;
+    }
+    pVRuler->SetUnit( eMetric );
 
         pHRuler->SetCharWidth( 371 );  // default character width
         pVRuler->SetLineHeight( 551 );  // default line height
-- 
1.7.0.1

