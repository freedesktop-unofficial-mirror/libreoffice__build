From c65bca475db1050a397d19e4fe69fbaddec5e637 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:07:56 +0200
Subject: [PATCH 693/768] calc-formula-variable-sep-config-check-sfx2.diff

---
 sfx2/inc/sfx2/objsh.hxx      |    7 +++++++
 sfx2/source/appl/appserv.cxx |    8 +++++++-
 sfx2/source/doc/objstor.cxx  |   16 ++++++++++++++++
 sfx2/source/doc/objxtor.cxx  |    1 +
 sfx2/source/inc/objshimp.hxx |    3 ++-
 5 files changed, 33 insertions(+), 2 deletions(-)

diff --git sfx2/inc/sfx2/objsh.hxx sfx2/inc/sfx2/objsh.hxx
index 39ffcc2..8435f2c 100644
--- sfx2/inc/sfx2/objsh.hxx
+++ sfx2/inc/sfx2/objsh.hxx
@@ -344,6 +344,13 @@ public:
     virtual sal_Bool            SwitchPersistance(
                                     const ::com::sun::star::uno::Reference< ::com::sun::star::embed::XStorage >& xStorage );
     virtual void                UpdateLinks();
+    /**
+     * Called when the Options dialog is dismissed with the OK button, to
+     * handle potentially conflicting option settings.
+     */
+    virtual void                CheckConfigOptions();
+    sal_Bool                    IsConfigOptionsChecked() const;
+    void                        SetConfigOptionsChecked( sal_Bool bChecked );
 
     sal_Bool                    SaveChildren(BOOL bObjectsOnly=FALSE);
     sal_Bool                    SaveAsChildren( SfxMedium &rMedium );
diff --git sfx2/source/appl/appserv.cxx sfx2/source/appl/appserv.cxx
index e00f704..e1175c4 100644
--- sfx2/source/appl/appserv.cxx
+++ sfx2/source/appl/appserv.cxx
@@ -950,11 +950,17 @@ void SfxApplication::OfaExec_Impl( SfxRequest& rReq )
             {
                 VclAbstractDialog* pDlg =
                     pFact->CreateFrameDialog( NULL, xFrame, rReq.GetSlot(), sPageURL );
-                  pDlg->Execute();
+                  short nRet = pDlg->Execute();
                   delete pDlg;
                 SfxViewFrame* pView = SfxViewFrame::GetFirst();
                 while ( pView )
                 {
+                    if (nRet == RET_OK)
+                    {
+                        SfxObjectShell* pObjSh = pView->GetObjectShell();
+                        if (pObjSh)
+                            pObjSh->SetConfigOptionsChecked(false);
+                    }
                     pView->GetBindings().InvalidateAll(FALSE);
                     pView = SfxViewFrame::GetNext( *pView );
                 }
diff --git sfx2/source/doc/objstor.cxx sfx2/source/doc/objstor.cxx
index 3e0ed06..6128852 100644
--- sfx2/source/doc/objstor.cxx
+++ sfx2/source/doc/objstor.cxx
@@ -3966,6 +3966,22 @@ void SfxObjectShell::UpdateLinks()
 {
 }
 
+void SfxObjectShell::CheckConfigOptions()
+{
+    // not handled.  Each app's shell needs to overwrite this method to add handler.
+    SetConfigOptionsChecked(true);
+}
+
+sal_Bool SfxObjectShell::IsConfigOptionsChecked() const
+{
+    return pImp->m_bConfigOptionsChecked;
+}
+
+void SfxObjectShell::SetConfigOptionsChecked( sal_Bool bChecked )
+{
+    pImp->m_bConfigOptionsChecked = bChecked;
+}
+
 sal_Bool SfxObjectShell::QuerySaveSizeExceededModules_Impl( const uno::Reference< task::XInteractionHandler >& xHandler )
 {
     if ( !HasBasic() )
diff --git sfx2/source/doc/objxtor.cxx sfx2/source/doc/objxtor.cxx
index 8684942..980b224 100644
--- sfx2/source/doc/objxtor.cxx
+++ sfx2/source/doc/objxtor.cxx
@@ -225,6 +225,7 @@ SfxObjectShell_Impl::SfxObjectShell_Impl( SfxObjectShell& _rDocShell )
     ,bSaveVersionOnClose( sal_False )
     ,m_bSharedXMLFlag( sal_False )
     ,m_bAllowShareControlFileClean( sal_True )
+    ,m_bConfigOptionsChecked( sal_False )
     ,lErr(ERRCODE_NONE)
     ,nEventId ( 0)
     ,pReloadTimer ( 0)
diff --git sfx2/source/inc/objshimp.hxx sfx2/source/inc/objshimp.hxx
index e022031..93cddc6 100644
--- sfx2/source/inc/objshimp.hxx
+++ sfx2/source/inc/objshimp.hxx
@@ -108,7 +108,8 @@ struct SfxObjectShell_Impl : public ::sfx2::IMacroDocumentAccess
                         bUseUserData:1,
                         bSaveVersionOnClose:1,
                         m_bSharedXMLFlag:1, // whether the flag should be stored in xml file
-                        m_bAllowShareControlFileClean:1; // whether the flag should be stored in xml file
+                        m_bAllowShareControlFileClean:1, // whether the flag should be stored in xml file
+                        m_bConfigOptionsChecked:1; // whether or not the user options are checked after the Options dialog is closed.
 
     IndexBitSet         aBitSet;
     sal_uInt32               lErr;
-- 
1.7.0.1

