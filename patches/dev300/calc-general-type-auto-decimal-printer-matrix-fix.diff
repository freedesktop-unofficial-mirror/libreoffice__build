From a84694bf09ef2a953636e48241f23f15b7dee6cc Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:56:29 +0200
Subject: [PATCH 211/878] calc-general-type-auto-decimal-printer-matrix-fix.diff

---
 sc/source/ui/view/output2.cxx |   22 +++++++++++++++++++++-
 1 files changed, 21 insertions(+), 1 deletions(-)

diff --git a/sc/source/ui/view/output2.cxx b/sc/source/ui/view/output2.cxx
index 378a8ae..066aaf4 100644
--- a/sc/source/ui/view/output2.cxx
+++ b/sc/source/ui/view/output2.cxx
@@ -174,6 +174,7 @@ private:
     long        GetSignWidth();
     long        GetDotWidth();
     void        TextChanged();
+    long        ConvertWidthLogicToPixel( long nWidth ) const;
 };
 
 //==================================================================
@@ -571,7 +572,12 @@ void ScDrawStringsVars::SetTextToWidthOrHash( ScBaseCell* pCell, long nWidth )
             return;
     }
 
-    if (pOutput->pFmtDevice->GetTextWidth(aString) > nWidth)
+    long nActualTextWidth = pOutput->pFmtDevice->GetTextWidth(aString);
+
+    if (bPixelToLogic)
+        nActualTextWidth = ConvertWidthLogicToPixel(nActualTextWidth);
+
+    if (nActualTextWidth > nWidth)
     {
         // Even after the decimal adjustment the text doesn't fit.  Give up.
         SetHashText();
@@ -623,6 +629,9 @@ long ScDrawStringsVars::GetMaxDigitWidth()
         long n = pOutput->pFmtDevice->GetTextWidth(String(cDigit));
         nMaxDigitWidth = ::std::max(nMaxDigitWidth, n);
     }
+
+    if (bPixelToLogic)
+        nMaxDigitWidth = ConvertWidthLogicToPixel(nMaxDigitWidth);
     return nMaxDigitWidth;
 }
 
@@ -632,6 +641,8 @@ long ScDrawStringsVars::GetSignWidth()
         return nSignWidth;
 
     nSignWidth = pOutput->pFmtDevice->GetTextWidth(String('-'));
+    if (bPixelToLogic)
+        nSignWidth = ConvertWidthLogicToPixel(nSignWidth);
     return nSignWidth;
 }
 
@@ -642,6 +653,8 @@ long ScDrawStringsVars::GetDotWidth()
 
     const ::rtl::OUString& sep = ScGlobal::GetpLocaleData()->getLocaleItem().decimalSeparator;
     nDotWidth = pOutput->pFmtDevice->GetTextWidth(sep);
+    if (bPixelToLogic)
+        nDotWidth = ConvertWidthLogicToPixel(nDotWidth);
     return nDotWidth;
 }
 
@@ -671,6 +684,13 @@ void ScDrawStringsVars::TextChanged()
         aTextSize = pRefDevice->LogicToPixel( aTextSize );
 }
 
+long ScDrawStringsVars::ConvertWidthLogicToPixel( long nWidth ) const
+{
+    Size aSize(nWidth, pOutput->pFmtDevice->GetTextHeight());
+    aSize = pOutput->pRefDevice->LogicToPixel(aSize);
+    return aSize.Width();
+}
+
 BOOL ScDrawStringsVars::HasEditCharacters() const
 {
     static const sal_Unicode pChars[] =
-- 
1.7.0.1

