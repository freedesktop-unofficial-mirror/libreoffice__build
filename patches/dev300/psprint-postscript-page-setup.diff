From 2c3e80c6f885953e028d7d4fbba194279f9d55ba Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:58:46 +0200
Subject: [PATCH 335/878] psprint-postscript-page-setup.diff

---
 vcl/inc/vcl/printerjob.hxx               |    2 +-
 vcl/unx/source/printergfx/printerjob.cxx |   45 +++++++++++++++--------------
 2 files changed, 24 insertions(+), 23 deletions(-)

diff --git a/vcl/inc/vcl/printerjob.hxx b/vcl/inc/vcl/printerjob.hxx
index 31d08d6..e229459 100644
--- a/vcl/inc/vcl/printerjob.hxx
+++ b/vcl/inc/vcl/printerjob.hxx
@@ -88,7 +88,7 @@ private:            // private methods
 
     bool			writeFeatureList( osl::File* pFile, const JobData&, bool bDocumentSetup );
     bool            writeSetup( osl::File* pFile, const JobData& );
-    bool            writePageSetup( osl::File* pFile, const JobData& );
+    bool            writePageSetup( osl::File* pFile, const JobData&, bool bWriteFeatures = true );
     void			writeJobPatch( osl::File* File, const JobData& );
     bool            writeProlog (osl::File* pFile, const JobData& );
 
diff --git a/vcl/unx/source/printergfx/printerjob.cxx b/vcl/unx/source/printergfx/printerjob.cxx
index ebcb7c1..fa15281 100644
--- a/vcl/unx/source/printergfx/printerjob.cxx
+++ b/vcl/unx/source/printergfx/printerjob.cxx
@@ -678,14 +678,6 @@ PrinterJob::StartPage (const JobData& rJobSetup)
     if( ! (pPageHeader && pPageBody) )
         return sal_False;
 
-    /* #i7262# write setup only before first page
-     *  don't do this in StartJob since the jobsetup there may be
-     *  different.
-     */ 
-    bool bSuccess =  true;
-    if( 1 == maPageList.size() )
-        m_aDocumentJobData = rJobSetup;
-
     // write page header according to Document Structuring Conventions (DSC)
     WritePS (pPageHeader, "%%Page: ");
     WritePS (pPageHeader, aPageNo); 
@@ -719,13 +711,25 @@ PrinterJob::StartPage (const JobData& rJobSetup)
 
     WritePS (pPageHeader, pBBox);
 
-    if (bSuccess)
-        bSuccess = writePageSetup ( pPageHeader, rJobSetup );
-    if(bSuccess)
-        m_aLastJobData = rJobSetup;
+    /* #i7262# #i65491# write setup only before first page
+     *  (to %%Begin(End)Setup, instead of %%Begin(End)PageSetup)
+     *  don't do this in StartJob since the jobsetup there may be
+     *  different.
+     */
+    bool bWriteFeatures = true;
+    if( 1 == maPageList.size() )
+    {
+        m_aDocumentJobData = rJobSetup;
+        bWriteFeatures = false;
+    }
 
+    if ( writePageSetup( pPageHeader, rJobSetup, bWriteFeatures ) )
+    {
+        m_aLastJobData = rJobSetup;
+        return true;
+    }
         
-    return bSuccess;
+    return false;
 }
 
 sal_Bool
@@ -825,12 +829,9 @@ bool PrinterJob::writeFeatureList( osl::File* pFile, const JobData& rJob, bool b
                 if( pKey->getSetupType()    == PPDKey::DocumentSetup )
                     bEmit = true;
             }
-            else
-            {
-                if( pKey->getSetupType()    == PPDKey::PageSetup        ||
-                    pKey->getSetupType()    == PPDKey::AnySetup )
-                    bEmit = true;
-            }
+            if( pKey->getSetupType()    == PPDKey::PageSetup        ||
+                pKey->getSetupType()    == PPDKey::AnySetup )
+                bEmit = true;
             if( bEmit )
             {
                 const PPDValue* pValue = rJob.m_aContext.getValue( pKey );
@@ -863,13 +864,13 @@ bool PrinterJob::writeFeatureList( osl::File* pFile, const JobData& rJob, bool b
     return bSuccess;
 }
 
-bool PrinterJob::writePageSetup( osl::File* pFile, const JobData& rJob )
+bool PrinterJob::writePageSetup( osl::File* pFile, const JobData& rJob, bool bWriteFeatures )
 {
     bool bSuccess = true;
 
     WritePS (pFile, "%%BeginPageSetup\n%\n");
-
-    bSuccess = writeFeatureList( pFile, rJob, false );
+    if ( bWriteFeatures )
+        bSuccess = writeFeatureList( pFile, rJob, false );
     WritePS (pFile, "%%EndPageSetup\n");
 
     sal_Char  pTranslate [128];
-- 
1.7.0.1

