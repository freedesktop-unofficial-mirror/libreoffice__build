From 700a41e635aab6afec30a2bfe2e08374ed0f4e96 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:08:47 +0200
Subject: [PATCH 834/878] sw-auto-scrollbars.diff

---
 sw/source/ui/inc/view.hxx        |    1 +
 sw/source/ui/uiview/viewmdi.cxx  |   33 +++++++++++++++++++++++++++++++++
 sw/source/ui/uiview/viewport.cxx |    5 +++--
 3 files changed, 37 insertions(+), 2 deletions(-)

diff --git a/sw/source/ui/inc/view.hxx b/sw/source/ui/inc/view.hxx
index 9a80435..77fea96 100644
--- a/sw/source/ui/inc/view.hxx
+++ b/sw/source/ui/inc/view.hxx
@@ -327,6 +327,7 @@ class SW_DLLPUBLIC SwView: public SfxViewShell
     SW_DLLPRIVATE int               _CreateScrollbar( BOOL bHori );
     SW_DLLPRIVATE DECL_LINK( ScrollHdl, SwScrollbar * );
     SW_DLLPRIVATE DECL_LINK( EndScrollHdl, SwScrollbar * );
+    SW_DLLPRIVATE DECL_LINK( WindowChildEventListener, VclSimpleEvent* );
     SW_DLLPRIVATE BOOL			UpdateScrollbars();
     SW_DLLPRIVATE void			CalcVisArea( const Size &rPixelSz );
 
diff --git a/sw/source/ui/uiview/viewmdi.cxx b/sw/source/ui/uiview/viewmdi.cxx
index ad08192..34de40e 100644
--- a/sw/source/ui/uiview/viewmdi.cxx
+++ b/sw/source/ui/uiview/viewmdi.cxx
@@ -309,6 +309,35 @@ void SwView::SetViewLayout( USHORT nColumns, bool bBookMode, BOOL bViewOnly )
  * Scrollbar - Handler
  */
 
+IMPL_LINK( SwView, WindowChildEventListener, VclSimpleEvent*, pEvent )
+{
+    DBG_ASSERT( pEvent && pEvent->ISA( VclWindowEvent ), "Unknown WindowEvent!" );
+    if ( pEvent && pEvent->ISA( VclWindowEvent ) )
+    {
+        VclWindowEvent *pVclEvent = static_cast< VclWindowEvent * >( pEvent );
+        DBG_ASSERT( pVclEvent->GetWindow(), "Window???" );
+    Window* pChildWin = static_cast< Window* >( pVclEvent->GetData() );
+
+        switch ( pVclEvent->GetId() )
+        {
+        case VCLEVENT_WINDOW_HIDE:
+      if( pChildWin == pHScrollbar )
+        ShowHScrollbar( FALSE );
+      else if( pChildWin == pVScrollbar )
+        ShowVScrollbar( FALSE );
+      break;
+        case VCLEVENT_WINDOW_SHOW:
+      if( pChildWin == pHScrollbar )
+        ShowHScrollbar( TRUE );
+      else if( pChildWin == pVScrollbar )
+        ShowVScrollbar( TRUE );
+      break;
+    }
+    }
+
+    return 0;
+}
+
 int SwView::_CreateScrollbar( BOOL bHori )
 {
     Window *pMDI = &GetViewFrame()->GetWindow();
@@ -329,6 +358,10 @@ int SwView::_CreateScrollbar( BOOL bHori )
 
     (*ppScrollbar)->EnableDrag( TRUE );
 
+    (*ppScrollbar)->SetAuto( TRUE );
+
+    pMDI->AddChildEventListener( LINK( this, SwView, WindowChildEventListener ));
+
     if(GetWindow())
         InvalidateBorder();
 
diff --git a/sw/source/ui/uiview/viewport.cxx b/sw/source/ui/uiview/viewport.cxx
index 5522e75..790c491 100644
--- a/sw/source/ui/uiview/viewport.cxx
+++ b/sw/source/ui/uiview/viewport.cxx
@@ -1136,6 +1136,7 @@ void SwView::OuterResizePixel( const Point &rOfst, const Size &rSize )
             {
                 bShowH = pVOpt->IsViewHScrollBar();
                 bShowV = pVOpt->IsViewVScrollBar();
+        bAuto = bHAuto = TRUE;
                 break;
             }
         }
@@ -1157,10 +1158,10 @@ void SwView::OuterResizePixel( const Point &rOfst, const Size &rSize )
     {
         bShowH = bShowV = bHAuto = bAuto = FALSE;
     }
-    if(pHScrollbar->IsVisible(FALSE) != bShowH)
+    if(pHScrollbar->IsVisible(FALSE) != bShowH && !bHAuto)
         ShowHScrollbar(bShowH);
     pHScrollbar->SetAuto( bHAuto );
-    if(pVScrollbar->IsVisible(FALSE) != bShowV)
+    if(pVScrollbar->IsVisible(FALSE) != bShowV && !bAuto)
         ShowVScrollbar(bShowV);
     pVScrollbar->SetAuto(bAuto);
 
-- 
1.7.0.1

