Fix RenderBadPicture crash

From: Thorsten Behrens <thb@openoffice.org>


---

 vcl/unx/gtk/window/gtkframe.cxx    |    5 +++++
 vcl/unx/inc/salframe.h             |    2 +-
 vcl/unx/source/window/salframe.cxx |    9 +++++----
 3 files changed, 11 insertions(+), 5 deletions(-)


diff --git vcl/unx/gtk/window/gtkframe.cxx vcl/unx/gtk/window/gtkframe.cxx
index e3e58b5..75cd135 100644
--- vcl/unx/gtk/window/gtkframe.cxx
+++ vcl/unx/gtk/window/gtkframe.cxx
@@ -2394,6 +2394,11 @@ void GtkSalFrame::createNewWindow( XLIB_Window aNewParent, bool bXEmbed, int nSc
         }
     }
 
+    // free xrender resources
+    for( unsigned int i = 0; i < sizeof(m_aGraphics)/sizeof(m_aGraphics[0]); i++ )
+        if( m_aGraphics[i].bInUse )
+            m_aGraphics[i].pGraphics->SetDrawable( None, m_nScreen );
+
     // first deinit frame
     if( m_pIMHandler )
     {
diff --git vcl/unx/inc/salframe.h vcl/unx/inc/salframe.h
index 56eda2c..0a0e201 100644
--- vcl/unx/inc/salframe.h
+++ vcl/unx/inc/salframe.h
@@ -212,7 +212,7 @@ public:
     virtual SalGraphics*		GetGraphics();
     virtual void				ReleaseGraphics( SalGraphics* pGraphics );
     
-    virtual void                updateGraphics();
+    virtual void                updateGraphics( Drawable drawable );
 
     virtual BOOL				PostEvent( void* pData );
 
diff --git vcl/unx/source/window/salframe.cxx vcl/unx/source/window/salframe.cxx
index 5d0d6f9..cc09809 100644
--- vcl/unx/source/window/salframe.cxx
+++ vcl/unx/source/window/salframe.cxx
@@ -930,12 +930,12 @@ void X11SalFrame::ReleaseGraphics( SalGraphics *pGraphics )
     pGraphics_		= NULL;
 }
 
-void X11SalFrame::updateGraphics()
+void X11SalFrame::updateGraphics( Drawable drawable )
 {
     if( pGraphics_ )
-        pGraphics_->SetDrawable( GetWindow(), m_nScreen );
+        pGraphics_->SetDrawable( drawable, m_nScreen );
     if( pFreeGraphics_ )
-        pFreeGraphics_->SetDrawable( GetWindow(), m_nScreen );
+        pFreeGraphics_->SetDrawable( drawable, m_nScreen );
 }
 
 // -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
@@ -2726,6 +2726,7 @@ void X11SalFrame::createNewWindow( XLIB_Window aNewParent, int nScreen )
     }
 
     // first deinit frame
+    updateGraphics(None);
     if( mpInputContext )
     {
         mpInputContext->UnsetICFocus( this );
@@ -2748,7 +2749,7 @@ void X11SalFrame::createNewWindow( XLIB_Window aNewParent, int nScreen )
         Init( nStyle_ & ~SAL_FRAME_STYLE_PLUG, nScreen, NULL, true );
 
     // update graphics if necessary
-    updateGraphics();
+    updateGraphics(GetWindow());
     
     if( m_aTitle.Len() )
         SetTitle( m_aTitle );
