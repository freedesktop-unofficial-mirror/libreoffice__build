From d026ace0e37716edeb35efaccdb3aa3c1d1f4831 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:55:16 +0200
Subject: [PATCH 125/768] sc-change-record-dnd.diff

---
 sc/source/ui/docshell/dbdocimp.cxx |   14 +++++++++-----
 1 files changed, 9 insertions(+), 5 deletions(-)

diff --git sc/source/ui/docshell/dbdocimp.cxx sc/source/ui/docshell/dbdocimp.cxx
index 6a91431..60abe62 100644
--- sc/source/ui/docshell/dbdocimp.cxx
+++ sc/source/ui/docshell/dbdocimp.cxx
@@ -65,6 +65,7 @@
 #include "dbdocutl.hxx"
 #include "editable.hxx"
 #include "hints.hxx"
+#include "chgtrack.hxx"
 
 using namespace com::sun::star;
 
@@ -216,6 +217,8 @@ BOOL ScDBDocFunc::DoImport( SCTAB nTab, const ScImportParam& rParam,
         const SbaSelectionList* pSelection, BOOL bRecord, BOOL bAddrInsert )
 {
     ScDocument* pDoc = rDocShell.GetDocument();
+    ScChangeTrack *pChangeTrack = NULL;
+    ScRange aChangedRange;
 
     if (bRecord && !pDoc->IsUndoEnabled())
         bRecord = FALSE;
@@ -490,11 +493,9 @@ BOOL ScDBDocFunc::DoImport( SCTAB nTab, const ScImportParam& rParam,
             nErrStringId = aTester.GetMessageId();
             bSuccess = FALSE;
         }
-        else if ( pDoc->GetChangeTrack() != NULL )
-        {
-            nErrStringId = STR_PROTECTIONERR;
-            bSuccess = FALSE;
-        }
+        else if ( (pChangeTrack = pDoc->GetChangeTrack()) != NULL )
+            aChangedRange = ScRange(rParam.nCol1, rParam.nRow1, nTab,
+                        nEndCol+nFormulaCols, nEndRow, nTab );
     }
 
     if ( bSuccess && bMoveCells )
@@ -712,6 +713,9 @@ BOOL ScDBDocFunc::DoImport( SCTAB nTab, const ScImportParam& rParam,
 
     delete pImportDoc;
 
+    if (bSuccess && pChangeTrack)
+        pChangeTrack->AppendInsert ( aChangedRange );
+
     return bSuccess;
 }
 
-- 
1.7.0.1

