From 4e84dfa7f26e1377673ae84466d58cf08c39a3b8 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:56:47 +0200
Subject: [PATCH 199/768] calc-perf-ods-import-properties.diff

---
 sc/inc/attarray.hxx              |    3 +-
 sc/inc/column.hxx                |    4 +-
 sc/source/core/data/attarray.cxx |    6 ++--
 sc/source/core/data/column.cxx   |    6 +---
 sc/source/core/data/table2.cxx   |   43 ++++++++++++++-----------------------
 5 files changed, 25 insertions(+), 37 deletions(-)

diff --git sc/inc/attarray.hxx sc/inc/attarray.hxx
index 7d26451..cbf4d26 100644
--- sc/inc/attarray.hxx
+++ sc/inc/attarray.hxx
@@ -36,6 +36,7 @@ class ScEditDataArray;
 class ScMarkArray;
 class ScPatternAttr;
 class ScStyleSheet;
+class ScFlatBoolRowSegments;
 
 class Rectangle;
 class SfxItemPoolCache;
@@ -160,7 +161,7 @@ public:
                                 BOOL bRefresh, BOOL bAttrs );
     BOOL	RemoveAreaMerge( SCROW nStartRow, SCROW nEndRow );
 
-    void	FindStyleSheet( const SfxStyleSheetBase* pStyleSheet, BOOL* pUsed, BOOL bReset );
+    void	FindStyleSheet( const SfxStyleSheetBase* pStyleSheet, ScFlatBoolRowSegments& rUsedRows, bool bReset );
     BOOL	IsStyleSheetUsed( const ScStyleSheet& rStyle, BOOL bGatherAllStyles ) const;
 
     void	DeleteAreaSafe(SCROW nStartRow, SCROW nEndRow);
diff --git sc/inc/column.hxx sc/inc/column.hxx
index f900fbf..2ef9e90 100644
--- sc/inc/column.hxx
+++ sc/inc/column.hxx
@@ -67,7 +67,7 @@ struct ScFunctionData;
 struct ScLineFlags;
 struct ScMergePatternState;
 struct ScSetStringParam;
-
+class ScFlatBoolRowSegments;
 
 #define COLUMN_DELTA	4
 
@@ -332,7 +332,7 @@ public:
     const ScStyleSheet*	GetSelectionStyle( const ScMarkData& rMark, BOOL& rFound ) const;
     const ScStyleSheet*	GetAreaStyle( BOOL& rFound, SCROW nRow1, SCROW nRow2 ) const;
 
-    void		FindStyleSheet( const SfxStyleSheetBase* pStyleSheet, BOOL* pUsed, BOOL bReset );
+    void		FindStyleSheet( const SfxStyleSheetBase* pStyleSheet, ScFlatBoolRowSegments& rUsedRows, bool bReset );
     BOOL		IsStyleSheetUsed( const ScStyleSheet& rStyle, BOOL bGatherAllStyles ) const;
 
                 /// May return -1 if not found
diff --git sc/source/core/data/attarray.cxx sc/source/core/data/attarray.cxx
index 92a7f73..56185d5 100644
--- sc/source/core/data/attarray.cxx
+++ sc/source/core/data/attarray.cxx
@@ -54,6 +54,7 @@
 #include "rechead.hxx"
 #include "globstr.hrc"
 #include "cell.hxx"
+#include "segmenttree.hxx"
 
 #undef DBG_INVALIDATE
 #define DBGOUTPUT(s) \
@@ -1757,8 +1758,7 @@ SCsROW ScAttrArray::GetNextUnprotected( SCsROW nRow, BOOL bUp ) const
     return nRet;
 }
 
-
-void ScAttrArray::FindStyleSheet( const SfxStyleSheetBase* pStyleSheet, BOOL* pUsed, BOOL bReset )
+void ScAttrArray::FindStyleSheet( const SfxStyleSheetBase* pStyleSheet, ScFlatBoolRowSegments& rUsedRows, bool bReset )
 {
     SCROW nStart = 0;
     SCSIZE nPos = 0;
@@ -1770,7 +1770,7 @@ void ScAttrArray::FindStyleSheet( const SfxStyleSheetBase* pStyleSheet, BOOL* pU
 //			for (SCROW nRow = nStart; nRow <= nEnd; nRow++)
 //				pUsed[nRow] = TRUE;
 
-            memset( &pUsed[nStart], TRUE, nEnd-nStart+1 );
+            rUsedRows.setTrue(nStart, nEnd);
 
             if (bReset)
             {
diff --git sc/source/core/data/column.cxx sc/source/core/data/column.cxx
index c4eceb1..49435ca 100644
--- sc/source/core/data/column.cxx
+++ sc/source/core/data/column.cxx
@@ -617,13 +617,11 @@ const ScStyleSheet*	ScColumn::GetAreaStyle( BOOL& rFound, SCROW nRow1, SCROW nRo
     return bEqual ? pStyle : NULL;
 }
 
-
-void ScColumn::FindStyleSheet( const SfxStyleSheetBase* pStyleSheet, BOOL* pUsed, BOOL bReset )
+void ScColumn::FindStyleSheet( const SfxStyleSheetBase* pStyleSheet, ScFlatBoolRowSegments& rUsedRows, bool bReset )
 {
-    pAttrArray->FindStyleSheet( pStyleSheet, pUsed, bReset );
+    pAttrArray->FindStyleSheet( pStyleSheet, rUsedRows, bReset );
 }
 
-
 BOOL ScColumn::IsStyleSheetUsed( const ScStyleSheet& rStyle, BOOL bGatherAllStyles ) const
 {
     return pAttrArray->IsStyleSheetUsed( rStyle, bGatherAllStyles );
diff --git sc/source/core/data/table2.cxx sc/source/core/data/table2.cxx
index 53877f9..b710be8 100644
--- sc/source/core/data/table2.cxx
+++ sc/source/core/data/table2.cxx
@@ -57,6 +57,7 @@
 #include "bcaslot.hxx"
 #include "postit.hxx"
 #include "globstr.hrc"
+#include "segmenttree.hxx"
 
 #include <math.h>
 
@@ -1846,36 +1847,24 @@ void ScTable::StyleSheetChanged( const SfxStyleSheetBase* pStyleSheet, BOOL bRem
                                 double nPPTX, double nPPTY,
                                 const Fraction& rZoomX, const Fraction& rZoomY )
 {
-    BOOL* pUsed = new BOOL[MAXROWCOUNT];
-    memset( pUsed, 0, sizeof(BOOL) * (MAXROWCOUNT) );
+    ScFlatBoolRowSegments aUsedRows;
+    for (SCCOL i = 0; i <= MAXCOL; ++i)
+        aCol[i].FindStyleSheet(pStyleSheet, aUsedRows, bRemoved);
 
-    SCCOL nCol;
-    for (nCol=0; nCol<=MAXCOL; nCol++)
-        aCol[nCol].FindStyleSheet( pStyleSheet, pUsed, bRemoved );
-
-    BOOL bFound = FALSE;
-    SCROW nStart = 0, nEnd = 0;
-    for (SCROW i=0; i<=MAXROW; i++)
+    SCROW nRow = 0;
+    while (nRow <= MAXROW)
     {
-        if (pUsed[i])
-        {
-            if (!bFound)
-            {
-                nStart = i;
-                bFound = TRUE;
-            }
-            nEnd = i;
-        }
-        else if (bFound)
-        {
-            SetOptimalHeight( nStart, nEnd, 0, pDev, nPPTX, nPPTY, rZoomX, rZoomY, FALSE );
-            bFound = FALSE;
-        }
-    }
-    if (bFound)
-        SetOptimalHeight( nStart, nEnd, 0, pDev, nPPTX, nPPTY, rZoomX, rZoomY, FALSE );
+        ScFlatBoolRowSegments::RangeData aData;
+        if (!aUsedRows.getRangeData(nRow, aData))
+            // search failed!
+            return;
 
-    delete[] pUsed;
+        SCROW nEndRow = aData.mnRow2;
+        if (aData.mbValue)
+            SetOptimalHeight(nRow, nEndRow, 0, pDev, nPPTX, nPPTY, rZoomX, rZoomY, FALSE);
+
+        nRow = nEndRow + 1;
+    }
 }
 
 
-- 
1.7.0.1

