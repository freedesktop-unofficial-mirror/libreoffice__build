From a433066ecf0e4e601d7a9b979782931e1579ee32 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:06:20 +0200
Subject: [PATCH 623/768] wmf-mm-text-1.diff

---
 svtools/source/filter.vcl/wmf/winmtf.cxx |   14 ++++++++++++--
 1 files changed, 12 insertions(+), 2 deletions(-)

diff --git svtools/source/filter.vcl/wmf/winmtf.cxx svtools/source/filter.vcl/wmf/winmtf.cxx
index c7a35ff..f1dcbfc 100644
--- svtools/source/filter.vcl/wmf/winmtf.cxx
+++ svtools/source/filter.vcl/wmf/winmtf.cxx
@@ -419,10 +419,15 @@ Point WinMtfOutput::ImplMap( const Point& rPt )
                 case MM_TEXT:
                     fX2 -= mnWinOrgX;
                     fY2 -= mnWinOrgY;
-                    fX2 *= 2540.0/mnUnitsPerInch;
-                    fY2 *= 2540.0/mnUnitsPerInch;
+                    if( mnDevWidth != 1 || mnDevHeight != 1 ) {
+                        fX2 *= 2540.0/mnUnitsPerInch;
+                        fY2 *= 2540.0/mnUnitsPerInch;
+                    }
                     fX2 += mnDevOrgX;
                     fY2 += mnDevOrgY;
+                    fX2 *= (double)mnMillX * 100.0 / (double)mnPixX;
+                    fY2 *= (double)mnMillY * 100.0 / (double)mnPixY;
+
                     break;
                 case MM_LOENGLISH :
                 {
@@ -500,8 +505,13 @@ Size WinMtfOutput::ImplMap( const Size& rSz )
             switch( mnMapMode )
             {
                 case MM_TEXT:
+                if( mnDevWidth != 1 && mnDevHeight != 1 ) {
                     fWidth *= 2540.0/mnUnitsPerInch;
                     fHeight*= 2540.0/mnUnitsPerInch;
+                } else {
+                    fWidth *= (double)mnMillX * 100 / (double)mnPixX;
+                    fHeight *= (double)mnMillY * 100 / (double)mnPixY;
+                }
                 break;
                 case MM_LOENGLISH :
                 {
-- 
1.7.0.1

