From 2a72479576bad3d605a7b4aef67145ddc8878cad Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:09:16 +0200
Subject: [PATCH 751/768] filled-tab-editeng.diff

---
 .../drawinglayer/primitive2d/textprimitive2d.hxx   |    8 +++-
 .../source/primitive2d/textprimitive2d.cxx         |   12 ++++-
 drawinglayer/source/processor2d/vclprocessor2d.cxx |   41 ++++++++++++++++---
 editeng/inc/editeng/editeng.hxx                    |    8 ++++
 editeng/inc/editeng/outliner.hxx                   |   15 +++++++
 editeng/source/editeng/editeng.cxx                 |    8 ++++
 editeng/source/editeng/impedit3.cxx                |   19 +++++++++
 editeng/source/outliner/outleeng.cxx               |    9 ++++
 editeng/source/outliner/outleeng.hxx               |    8 ++++
 editeng/source/outliner/outliner.cxx               |   15 +++++++-
 svx/source/svdraw/svdotextdecomposition.cxx        |    4 +-
 11 files changed, 134 insertions(+), 13 deletions(-)

diff --git drawinglayer/inc/drawinglayer/primitive2d/textprimitive2d.hxx drawinglayer/inc/drawinglayer/primitive2d/textprimitive2d.hxx
index c1ea62e..cfebb74 100644
--- drawinglayer/inc/drawinglayer/primitive2d/textprimitive2d.hxx
+++ drawinglayer/inc/drawinglayer/primitive2d/textprimitive2d.hxx
@@ -92,6 +92,8 @@ namespace drawinglayer
 
             /// #i96669# add simple range buffering for this primitive
             basegfx::B2DRange						maB2DRange;
+            bool                                    mbFilled;           // Whether to fill a given width with the text
+            long                                    mnWidthToFill;      // the width to fill
 
         protected:
             /// local decomposition.
@@ -107,7 +109,9 @@ namespace drawinglayer
                 const ::std::vector< double >& rDXArray,
                 const attribute::FontAttribute& rFontAttribute,
                 const ::com::sun::star::lang::Locale& rLocale,
-                const basegfx::BColor& rFontColor);
+                const basegfx::BColor& rFontColor,
+                bool bFilled = false,
+                long nWidthToFill = 0);
 
             /// helpers
             /** get text outlines as polygons and their according ObjectTransformation. Handles all
@@ -124,6 +128,8 @@ namespace drawinglayer
             const attribute::FontAttribute& getFontAttribute() const { return maFontAttribute; }
             const ::com::sun::star::lang::Locale& getLocale() const { return  maLocale; }
             const basegfx::BColor& getFontColor() const { return maFontColor; }
+            bool isFilled() const { return mbFilled; }
+            long getWidthToFill() const { return mnWidthToFill; }
 
             /// compare operator
             virtual bool operator==( const BasePrimitive2D& rPrimitive ) const;
diff --git drawinglayer/source/primitive2d/textprimitive2d.cxx drawinglayer/source/primitive2d/textprimitive2d.cxx
index 992d4dc..d97883d 100644
--- drawinglayer/source/primitive2d/textprimitive2d.cxx
+++ drawinglayer/source/primitive2d/textprimitive2d.cxx
@@ -237,7 +237,9 @@ namespace drawinglayer
             const ::std::vector< double >& rDXArray,
             const attribute::FontAttribute& rFontAttribute,
             const ::com::sun::star::lang::Locale& rLocale,
-            const basegfx::BColor& rFontColor)
+            const basegfx::BColor& rFontColor,
+            bool bFilled,
+            long nWidthToFill)
         :	BufferedDecompositionPrimitive2D(),
             maTextTransform(rNewTransform),
             maText(rText),
@@ -247,7 +249,9 @@ namespace drawinglayer
             maFontAttribute(rFontAttribute),
             maLocale(rLocale),
             maFontColor(rFontColor),
-            maB2DRange()
+            maB2DRange(),
+            mbFilled(bFilled),
+            mnWidthToFill(nWidthToFill)
         {
 #ifdef DBG_UTIL
             const xub_StrLen aStringLength(getText().Len());
@@ -276,7 +280,9 @@ namespace drawinglayer
                     && getDXArray() == rCompare.getDXArray()
                     && getFontAttribute() == rCompare.getFontAttribute()
                     && LocalesAreEqual(getLocale(), rCompare.getLocale())
-                    && getFontColor() == rCompare.getFontColor());
+                    && getFontColor() == rCompare.getFontColor()
+                    && mbFilled == rCompare.mbFilled
+                    && mnWidthToFill == rCompare.mnWidthToFill);
             }
 
             return false;
diff --git drawinglayer/source/processor2d/vclprocessor2d.cxx drawinglayer/source/processor2d/vclprocessor2d.cxx
index 71bb587..678bbf4 100644
--- drawinglayer/source/processor2d/vclprocessor2d.cxx
+++ drawinglayer/source/processor2d/vclprocessor2d.cxx
@@ -250,22 +250,49 @@ namespace drawinglayer
                     mpOutputDevice->SetFont(aFont);
                     mpOutputDevice->SetTextColor(Color(aRGBFontColor));
 
+                    String aText( rTextCandidate.getText() );
+                    xub_StrLen nPos = rTextCandidate.getTextPosition();
+                    xub_StrLen nLen = rTextCandidate.getTextLength();
+
+                    sal_Int32* pDXArray = aTransformedDXArray.size() ? &(aTransformedDXArray[0]) : NULL ;
+
+                    if ( rTextCandidate.isFilled() )
+                    {
+                        basegfx::B2DVector aOldFontScaling, aOldTranslate;
+                        double fOldRotate, fOldShearX;
+                        rTextCandidate.getTextTransform().decompose(aOldFontScaling, aOldTranslate, fOldRotate, fOldShearX);
+
+                        long nWidthToFill = rTextCandidate.getWidthToFill( ) * aFontScaling.getX() / aOldFontScaling.getX();
+
+                        long nWidth = mpOutputDevice->GetTextArray(
+                            rTextCandidate.getText(), pDXArray, 0, 1 );
+                        long nChars = 2;
+                        if ( nWidth )
+                            nChars = nWidthToFill / nWidth;
+
+                        String aFilled;
+                        aFilled.Fill( (USHORT)nChars, aText.GetChar( 0 ) );
+                        aText = aFilled;
+                        nPos = 0;
+                        nLen = nChars;
+                    }
+
                     if(aTransformedDXArray.size())
                     {
                         mpOutputDevice->DrawTextArray(
                             aStartPoint, 
-                            rTextCandidate.getText(), 
-                            &(aTransformedDXArray[0]),
-                            rTextCandidate.getTextPosition(),
-                            rTextCandidate.getTextLength());
+                            aText,
+                            pDXArray,
+                            nPos,
+                            nLen);
                     }
                     else
                     {
                         mpOutputDevice->DrawText(
                             aStartPoint, 
-                            rTextCandidate.getText(), 
-                            rTextCandidate.getTextPosition(),
-                            rTextCandidate.getTextLength());
+                            aText,
+                            nPos,
+                            nLen);
                     }
 
                     if(rTextCandidate.getFontAttribute().getRTL())
diff --git editeng/inc/editeng/editeng.hxx editeng/inc/editeng/editeng.hxx
index b1af8c9..bd7a520 100644
--- editeng/inc/editeng/editeng.hxx
+++ editeng/inc/editeng/editeng.hxx
@@ -443,6 +443,14 @@ public:
         const Color& rOverlineColor,
         const Color& rTextLineColor);
 
+    virtual void DrawingTab(
+        const Point& rStartPos, long nWidth, const String& rChar,
+        const SvxFont& rFont, USHORT nPara, xub_StrLen nIndex, BYTE nRightToLeft,
+        bool bEndOfLine,
+        bool bEndOfParagraph,
+        const Color& rOverlineColor,
+        const Color& rTextLineColor);
+
     virtual String	GetUndoComment( USHORT nUndoId ) const;
     virtual BOOL	FormattingParagraph( USHORT nPara );
     virtual BOOL	SpellNextDocument();
diff --git editeng/inc/editeng/outliner.hxx editeng/inc/editeng/outliner.hxx
index f54c187..d0e9833 100644
--- editeng/inc/editeng/outliner.hxx
+++ editeng/inc/editeng/outliner.hxx
@@ -416,6 +416,9 @@ public:
     // #101498# BiDi level needs to be transported, too.
     BYTE			    mnBiDiLevel;
 
+    bool                mbFilled;
+    long                mnWidthToFill;
+
     // bitfield
     unsigned            mbEndOfLine : 1;
     unsigned            mbEndOfParagraph : 1;
@@ -439,6 +442,8 @@ public:
         const Color& rOverlineColor,
         const Color& rTextLineColor,
         BYTE nBiDiLevel,
+        bool bFilled,
+        long nWidthToFill,
         bool bEndOfLine,
         bool bEndOfParagraph,
         bool bEndOfBullet)
@@ -456,6 +461,8 @@ public:
         maOverlineColor(rOverlineColor),
         maTextLineColor(rTextLineColor),
         mnBiDiLevel(nBiDiLevel),
+        mbFilled( bFilled ),
+        mnWidthToFill( nWidthToFill ),
         mbEndOfLine(bEndOfLine),
         mbEndOfParagraph(bEndOfParagraph),
         mbEndOfBullet(bEndOfBullet)
@@ -889,6 +896,14 @@ public:
         const Color& rOverlineColor,
         const Color& rTextLineColor);
 
+    virtual void DrawingTab(
+        const Point& rStartPos, long nWidth, const String& rChar,
+        const SvxFont& rFont, USHORT nPara, xub_StrLen nIndex, BYTE nRightToLeft,
+        bool bEndOfLine,
+        bool bEndOfParagraph,
+        const Color& rOverlineColor,
+        const Color& rTextLineColor);
+
     Size            CalcTextSize();
 
     Point           GetDocPos( Paragraph* pPara );
diff --git editeng/source/editeng/editeng.cxx editeng/source/editeng/editeng.cxx
index fc1ace2..a428912 100644
--- editeng/source/editeng/editeng.cxx
+++ editeng/source/editeng/editeng.cxx
@@ -2473,6 +2473,14 @@ void __EXPORT EditEngine::DrawingText( const Point&, const XubString&, USHORT, U
     DBG_CHKTHIS( EditEngine, 0 );
 }
 
+void __EXPORT EditEngine::DrawingTab( const Point& rStartPos, long nWidth, const String& rChar,
+    const SvxFont& rFont, USHORT nPara, xub_StrLen nIndex, BYTE nRightToLeft,
+    bool bEndOfLine, bool bEndOfParagraph,
+    const Color& rOverlineColor, const Color& rTextLineColor)
+{
+    DBG_CHKTHIS( EditEngine, 0 );
+}
+
 void __EXPORT EditEngine::PaintingFirstLine( sal_uInt16, const Point&, long, const Point&, short, OutputDevice* )
 {
     DBG_CHKTHIS( EditEngine, 0 );
diff --git editeng/source/editeng/impedit3.cxx editeng/source/editeng/impedit3.cxx
index 77f60e9..42f0e76 100644
--- editeng/source/editeng/impedit3.cxx
+++ editeng/source/editeng/impedit3.cxx
@@ -3561,7 +3561,26 @@ void ImpEditEngine::Paint( OutputDevice* pOutDev, Rectangle aClipRec, Point aSta
 
                                     String aText;
                                     aText.Fill( (USHORT)nChars, pTextPortion->GetExtraValue() );
+                                    aTmpFont.QuickDrawText( pOutDev, aTmpPos, aText, 0, aText.Len(), NULL );
                                     pOutDev->DrawStretchText( aTmpPos, pTextPortion->GetSize().Width(), aText );
+
+                                    if ( bStripOnly )
+                                    {
+                                        // create EOL and EOP bools
+                                        const bool bEndOfLine(y == pLine->GetEndPortion());
+                                        const bool bEndOfParagraph(bEndOfLine && nLine + 1 == nLines);
+
+                                        const Color aOverlineColor(pOutDev->GetOverlineColor());
+                                        const Color aTextLineColor(pOutDev->GetTextLineColor());
+
+                                        // StripPortions() data callback
+                                        GetEditEnginePtr()->DrawingTab( aTmpPos,
+                                            pTextPortion->GetSize().Width(),
+                                            pTextPortion->GetExtraValue(),
+                                            aTmpFont, n, nIndex, pTextPortion->GetRightToLeft(),
+                                            bEndOfLine, bEndOfParagraph,
+                                            aOverlineColor, aTextLineColor);
+                                    }
                                 }
                             }
                             break;
diff --git editeng/source/outliner/outleeng.cxx editeng/source/outliner/outleeng.cxx
index f8d4b9a..820492f 100644
--- editeng/source/outliner/outleeng.cxx
+++ editeng/source/outliner/outleeng.cxx
@@ -204,6 +204,15 @@ void OutlinerEditEng::DrawingText( const Point& rStartPos, const XubString& rTex
         pWrongSpellVector, pFieldData, bEndOfLine, bEndOfParagraph, bEndOfBullet, pLocale, rOverlineColor, rTextLineColor);
 }
 
+void OutlinerEditEng::DrawingTab( const Point& rStartPos, long nWidth, const String& rChar,
+    const SvxFont& rFont, USHORT nPara, xub_StrLen nIndex, BYTE nRightToLeft,
+    bool bEndOfLine, bool bEndOfParagraph,
+    const Color& rOverlineColor, const Color& rTextLineColor)
+{
+    pOwner->DrawingTab(rStartPos, nWidth, rChar, rFont, nPara, nIndex, nRightToLeft,
+            bEndOfLine, bEndOfParagraph, rOverlineColor, rTextLineColor );
+}
+
 void OutlinerEditEng::FieldClicked( const SvxFieldItem& rField, USHORT nPara, USHORT nPos )
 {
     EditEngine::FieldClicked( rField, nPara, nPos );	// Falls URL
diff --git editeng/source/outliner/outleeng.hxx editeng/source/outliner/outleeng.hxx
index 96cafc8..536af8b 100644
--- editeng/source/outliner/outleeng.hxx
+++ editeng/source/outliner/outleeng.hxx
@@ -68,6 +68,14 @@ public:
         const Color& rOverlineColor,
         const Color& rTextLineColor);
 
+    virtual void DrawingTab(
+        const Point& rStartPos, long nWidth, const String& rChar,
+        const SvxFont& rFont, USHORT nPara, xub_StrLen nIndex, BYTE nRightToLeft,
+        bool bEndOfLine,
+        bool bEndOfParagraph,
+        const Color& rOverlineColor,
+        const Color& rTextLineColor);
+
     virtual	void 		StyleSheetChanged( SfxStyleSheet* pStyle );
     virtual void 		ParaAttribsChanged( USHORT nPara );
     virtual BOOL 		SpellNextDocument();
diff --git editeng/source/outliner/outliner.cxx editeng/source/outliner/outliner.cxx
index e0a89aa..e8aa629 100644
--- editeng/source/outliner/outliner.cxx
+++ editeng/source/outliner/outliner.cxx
@@ -1790,7 +1790,20 @@ void Outliner::DrawingText( const Point& rStartPos, const XubString& rText, USHO
     {
         // #101498#
         DrawPortionInfo aInfo( rStartPos, rText, nTextStart, nTextLen, rFont, nPara, nIndex, pDXArray, pWrongSpellVector,
-            pFieldData, pLocale, rOverlineColor, rTextLineColor, nRightToLeft, bEndOfLine, bEndOfParagraph, bEndOfBullet);
+            pFieldData, pLocale, rOverlineColor, rTextLineColor, nRightToLeft, false, 0, bEndOfLine, bEndOfParagraph, bEndOfBullet);
+
+        aDrawPortionHdl.Call( &aInfo );
+    }
+}
+
+void Outliner::DrawingTab( const Point& rStartPos, long nWidth, const String& rChar, const SvxFont& rFont,
+    USHORT nPara, xub_StrLen nIndex, BYTE nRightToLeft, bool bEndOfLine, bool bEndOfParagraph,
+    const Color& rOverlineColor, const Color& rTextLineColor)
+{
+    if(aDrawPortionHdl.IsSet())
+    {
+        DrawPortionInfo aInfo( rStartPos, rChar, 0, rChar.Len(), rFont, nPara, nIndex, NULL, NULL,
+            NULL, NULL, rOverlineColor, rTextLineColor, nRightToLeft, true, nWidth, bEndOfLine, bEndOfParagraph, false);
 
         aDrawPortionHdl.Call( &aInfo );
     }
diff --git svx/source/svdraw/svdotextdecomposition.cxx svx/source/svdraw/svdotextdecomposition.cxx
index 760287a..1bb2001 100644
--- svx/source/svdraw/svdotextdecomposition.cxx
+++ svx/source/svdraw/svdotextdecomposition.cxx
@@ -370,7 +370,9 @@ namespace
                     aDXArray,
                     aFontAttribute,
                     rInfo.mpLocale ? *rInfo.mpLocale : ::com::sun::star::lang::Locale(),
-                    aBFontColor);
+                    aBFontColor,
+                    rInfo.mbFilled,
+                    rInfo.mnWidthToFill);
             }
 
             if(rInfo.mbEndOfBullet)
-- 
1.7.0.1

