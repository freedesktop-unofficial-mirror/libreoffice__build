From 14ed849be53bdb7122d0b75d6d5515b8359d2e47 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:08:50 +0200
Subject: [PATCH 837/878] cws-impressmedia01-backport.diff

---
 avmedia/inc/avmedia/mediawindow.hxx                |   23 +-
 avmedia/source/framework/mediacontrol.cxx          |    2 +-
 avmedia/source/viewer/mediawindow.cxx              |  120 +++++-
 fpicker/source/aqua/ControlHelper.cxx              |    3 +
 fpicker/source/aqua/SalAquaFilePicker.cxx          |    4 +
 fpicker/source/office/OfficeFilePicker.cxx         |    5 +
 fpicker/source/unx/gnome/SalGtkFilePicker.cxx      |    6 +
 fpicker/source/unx/kde4/KDE4FilePicker.cxx         |    4 +
 fpicker/source/win32/filepicker/FPServiceInfo.hxx  |    3 +
 fpicker/source/win32/filepicker/FilePicker.cxx     |    9 +-
 fpicker/source/win32/filepicker/Fps.rc             |   17 +
 .../source/win32/filepicker/VistaFilePicker.cxx    |    7 +
 .../win32/filepicker/VistaFilePickerImpl.cxx       |    4 +
 .../sun/star/ui/dialogs/TemplateDescription.idl    |    8 +
 sc/source/ui/drawfunc/fuins1.cxx                   |   16 +-
 sd/source/core/drawdoc.cxx                         |    4 +
 sd/source/ui/func/fuinsert.cxx                     |   11 +-
 sd/source/ui/view/sdview4.cxx                      |   45 ++-
 sfx2/inc/sfx2/lnkbase.hxx                          |    1 +
 sfx2/sdi/sfx.sdi                                   |    2 +-
 sfx2/source/dialog/filedlghelper.cxx               |   11 +-
 sot/inc/sot/formats.hxx                            |    3 +-
 sot/source/base/exchange.cxx                       |    1 +
 svx/inc/svx/dialogs.hrc                            |    7 +-
 svx/inc/svx/sdr/media/medialink.hxx                |   81 ++++
 svx/inc/svx/sdr/media/mediamanager.hxx             |   90 ++++
 svx/inc/svx/svdmodel.hxx                           |    9 +
 svx/inc/svx/svdomedia.hxx                          |   18 +
 svx/prj/build.lst                                  |    3 +-
 svx/prj/d.lst                                      |    4 +
 svx/source/cui/cuigaldlg.cxx                       |    6 +-
 svx/source/cui/linkdlg.cxx                         |   13 +-
 .../sdr/contact/viewcontactofsdrmediaobj.cxx       |   20 +-
 svx/source/sdr/media/makefile.mk                   |   48 +++
 svx/source/sdr/media/mediamanager.cxx              |  445 ++++++++++++++++++++
 svx/source/svdraw/svdmodel.cxx                     |   30 ++
 svx/source/svdraw/svdomedia.cxx                    |  257 +++++++++++-
 svx/source/svxlink/fileobj.cxx                     |   23 +
 svx/source/svxlink/linkmgr.cxx                     |   17 +-
 svx/source/svxlink/linkmgr.src                     |    5 +
 svx/util/makefile.mk                               |    3 +-
 sw/source/ui/shells/grfshex.cxx                    |   12 +-
 unotools/source/ucbhelper/XTempFile.hxx            |   10 +-
 unotools/source/ucbhelper/xtempfile.cxx            |   73 +++-
 xmloff/source/draw/ximpshap.cxx                    |   21 +-
 45 files changed, 1414 insertions(+), 90 deletions(-)
 create mode 100644 svx/inc/svx/sdr/media/medialink.hxx
 create mode 100644 svx/inc/svx/sdr/media/mediamanager.hxx
 create mode 100644 svx/source/sdr/media/makefile.mk
 create mode 100644 svx/source/sdr/media/mediamanager.cxx

diff --git a/avmedia/inc/avmedia/mediawindow.hxx b/avmedia/inc/avmedia/mediawindow.hxx
index 4e49f0a..d1c3888 100644
--- a/avmedia/inc/avmedia/mediawindow.hxx
+++ b/avmedia/inc/avmedia/mediawindow.hxx
@@ -61,7 +61,20 @@ namespace rtl { class OUString; }
 
 namespace avmedia
 {
-    typedef ::std::vector< ::std::pair< ::rtl::OUString, ::rtl::OUString > > FilterNameVector;
+    struct FilterInfo
+    {
+        ::rtl::OUString msFilterName;
+        ::rtl::OUString msExtensions;
+        ::rtl::OUString msMimeType;
+
+        FilterInfo() {}
+        FilterInfo( const ::rtl::OUString& sFilterName, const ::rtl::OUString& sExtensions, const ::rtl::OUString& sMimeType ) : msFilterName( sFilterName ), msExtensions( sExtensions ), msMimeType( sMimeType ) {}
+        FilterInfo( const FilterInfo& r ) : msFilterName( r.msFilterName ), msExtensions( r.msExtensions ), msMimeType( r.msMimeType ) {}
+        FilterInfo( const sal_Char* psFilterName, const sal_Char* psExtensions, const sal_Char* psMimeType )
+            : msFilterName( ::rtl::OUString::createFromAscii( psFilterName ) ), msExtensions( ::rtl::OUString::createFromAscii( psExtensions ) ), msMimeType( ::rtl::OUString::createFromAscii( psMimeType ) ) {}
+    };
+
+    typedef ::std::vector< FilterInfo > FilterNameVector;
 
     class MediaItem;
 
@@ -146,7 +159,12 @@ namespace avmedia
     public:
 
         static void         getMediaFilters( FilterNameVector& rFilterNameVector );
-        static bool         executeMediaURLDialog( Window* pParent, ::rtl::OUString& rURL, bool bInsertDialog = true );
+        static bool			getMediaFilterForURL( const ::rtl::OUString& rURL, FilterInfo& rFilterInfo );
+
+        static bool         executeInsertMediaURLDialog( Window* pParent, ::rtl::OUString& rURL, sal_Bool& rLink );
+        static bool         executeOpenMediaURLDialog( Window* pParent, ::rtl::OUString& rURL );
+
+
         static void         executeFormatErrorBox( Window* pParent );
         static bool         isMediaURL( const ::rtl::OUString& rURL, bool bDeep = false, Size* pPreferredSizePixel = NULL );
 
@@ -157,6 +175,7 @@ namespace avmedia
                                                                                                   double fMediaTime = AVMEDIA_FRAMEGRABBER_DEFAULTFRAME );
 
     private:
+        static bool         executeMediaURLDialogImpl( Window* pParent, ::rtl::OUString& rURL, sal_Bool& rLink, bool bInsertDialog );
 
                     // default: disabled copy/assignment
         MediaWindow(const MediaWindow&);
diff --git a/avmedia/source/framework/mediacontrol.cxx b/avmedia/source/framework/mediacontrol.cxx
index 8583af6..9a1780e 100644
--- a/avmedia/source/framework/mediacontrol.cxx
+++ b/avmedia/source/framework/mediacontrol.cxx
@@ -521,7 +521,7 @@ IMPL_LINK( MediaControl, implSelectHdl, ToolBox*, p )
             {
                 ::rtl::OUString aURL;
             
-                 if( ::avmedia::MediaWindow::executeMediaURLDialog( GetParent(), aURL, false ) )
+                 if( ::avmedia::MediaWindow::executeOpenMediaURLDialog( GetParent(), aURL ) )
                  {
                      if( !::avmedia::MediaWindow::isMediaURL( aURL, true ) )
                         ::avmedia::MediaWindow::executeFormatErrorBox( this );
diff --git a/avmedia/source/viewer/mediawindow.cxx b/avmedia/source/viewer/mediawindow.cxx
index 748a9b0..30476a8 100644
--- a/avmedia/source/viewer/mediawindow.cxx
+++ b/avmedia/source/viewer/mediawindow.cxx
@@ -39,6 +39,8 @@
 #include <com/sun/star/lang/XMultiServiceFactory.hpp>
 #include <com/sun/star/media/XManager.hpp>
 #include "com/sun/star/ui/dialogs/TemplateDescription.hpp"
+#include <com/sun/star/ui/dialogs/XFilePickerControlAccess.hpp>
+#include <com/sun/star/ui/dialogs/ExtendedFilePickerElementIds.hpp>
 
 #define AVMEDIA_FRAMEGRABBER_DEFAULTFRAME_MEDIATIME 3.0
 
@@ -362,35 +364,95 @@ Window* MediaWindow::getWindow() const
 
 // -------------------------------------------------------------------------
 
+static const char** GetFiltersImpl()
+{
+    static const char* aFilters[] = {   "AIF Audio",			"aif;aiff",								"audio/aiff",
+                                        "AU Audio",				"au",									"audio/basic",
+                                        "AVI",					"avi",									"video/avi",
+                                        "CD Audio",				"cda",									"application/x-cda",
+                                        "FLAC Audio",           "flac",                                 "audio/x-flac",
+                                        "MIDI Audio",			"mid;midi;kar",							"audio/midi",
+                                        "MPEG Audio",			"mp2;mp3;mpa",							"audio/mpeg",
+                                        "MPEG Video",			"mpg;mpeg;mpv;mp4;mpe;mpa;m1v;m2v;mpe",	"video/mpeg",
+                                        "Ogg Audio",			"oga;ogg",								"audio/ogg",
+                                        "Ogg Video",			"ogv",									"video/ogg",
+                                        "Matroska Audio",		"mka",									"audio/x-matroska",
+                                        "Matroska Video",		"mkv",									"video/x-matroska",
+                                        "Quicktime Video",		"mov;moov",								"video/quicktime",
+                                        "Vivo Video",			"viv;vivo",								"video/vivo",
+                                        "WAVE Audio",			"wav",									"audio/wav",
+                                        0, };
+    return &aFilters[0];
+}
+
 void MediaWindow::getMediaFilters( FilterNameVector& rFilterNameVector )
 {
-    static const char* pFilters[] = {   "AIF Audio", "aif;aiff",
-                                        "AU Audio", "au",
-                                        "AVI", "avi",
-                                        "CD Audio", "cda",
-                                        "FLAC Audio", "flac",
-                                        "MIDI Audio", "mid;midi",
-                                        "MPEG Audio", "mp2;mp3;mpa",
-                                        "MPEG Video", "mpg;mpeg;mpv;mp4",
-                                        "Ogg bitstream", "ogg",
-                                        "Quicktime Video", "mov",
-                                        "Vivo Video", "viv",
-                                        "WAVE Audio", "wav" };
+    const char** pFilters = GetFiltersImpl();
     
-    unsigned int i;
-    for( i = 0; i < ( sizeof( pFilters ) / sizeof( char* ) ); i += 2 )
+    while( *pFilters )
+    {
+        rFilterNameVector.push_back( FilterInfo( ::rtl::OUString::createFromAscii( pFilters[0] ),
+                                                 ::rtl::OUString::createFromAscii( pFilters[1] ),
+                                                 ::rtl::OUString::createFromAscii( pFilters[2] ) ) );
+        pFilters += 3;
+    }
+}
+
+// -------------------------------------------------------------------------
+
+bool MediaWindow::getMediaFilterForURL( const ::rtl::OUString& rURL, FilterInfo& rFilterInfo )
+{
+    const INetURLObject aURL( rURL );
+
+    String aExtension( aURL.getExtension() );
+    if( aExtension.Len() != 0 )
     {
-        rFilterNameVector.push_back( ::std::make_pair< ::rtl::OUString, ::rtl::OUString >( 
-                                        ::rtl::OUString::createFromAscii( pFilters[ i ] ),
-                                        ::rtl::OUString::createFromAscii( pFilters[ i + 1 ] ) ) );
+        const char** pFilters = GetFiltersImpl();
+
+        while( *pFilters )
+        {
+
+            USHORT nPos = 0;
+            do
+            {
+                String sFilterExtensions( String::CreateFromAscii( pFilters[1] ) );
+                String sFilterExt = sFilterExtensions.GetToken( 0, ';', nPos );
+                if( sFilterExt.EqualsIgnoreCaseAscii( aExtension ) )
+                {
+                    rFilterInfo = FilterInfo( ::rtl::OUString::createFromAscii( pFilters[0] ), sFilterExtensions, ::rtl::OUString::createFromAscii( pFilters[2]) );
+
+                    return true;
+                }
+            }
+            while( nPos != STRING_NOTFOUND );
+
+            pFilters += 3;
+        }
     }
+
+    return false;
+}
+
+// -------------------------------------------------------------------------
+
+bool MediaWindow::executeInsertMediaURLDialog( Window* pParent, ::rtl::OUString& rURL, sal_Bool& rLink )
+{
+    return executeMediaURLDialogImpl( pParent, rURL, rLink, true );
+}
+
+// -------------------------------------------------------------------------
+
+bool MediaWindow::executeOpenMediaURLDialog( Window* pParent, ::rtl::OUString& rURL )
+{
+    sal_Bool aLink = sal_True;
+    return executeMediaURLDialogImpl( pParent, rURL, aLink, false );
 }
 
 // -------------------------------------------------------------------------
 
-bool MediaWindow::executeMediaURLDialog( Window* /* pParent */, ::rtl::OUString& rURL, bool bInsertDialog )
+bool MediaWindow::executeMediaURLDialogImpl( Window* /* pParent */, ::rtl::OUString& rURL, sal_Bool& rLink, bool bInsertDialog )
 {
-    ::sfx2::FileDialogHelper        aDlg( com::sun::star::ui::dialogs::TemplateDescription::FILEOPEN_SIMPLE, 0 );
+    ::sfx2::FileDialogHelper        aDlg( bInsertDialog ? ui::dialogs::TemplateDescription::FILEOPEN_LINK : ui::dialogs::TemplateDescription::FILEOPEN_SIMPLE, 0 );
     static const ::rtl::OUString    aWildcard( RTL_CONSTASCII_USTRINGPARAM( "*." ) );
     FilterNameVector                aFilters;
     const ::rtl::OUString           aSeparator( RTL_CONSTASCII_USTRINGPARAM( ";" ) );
@@ -408,7 +470,7 @@ bool MediaWindow::executeMediaURLDialog( Window* /* pParent */, ::rtl::OUString&
             if( aAllTypes.getLength() )
                 aAllTypes += aSeparator;
         
-            ( aAllTypes += aWildcard ) += aFilters[ i ].second.getToken( 0, ';', nIndex );
+            ( aAllTypes += aWildcard ) += aFilters[ i ].msExtensions.getToken( 0, ';', nIndex );
         }
     }
     
@@ -424,20 +486,30 @@ bool MediaWindow::executeMediaURLDialog( Window* /* pParent */, ::rtl::OUString&
             if( aTypes.getLength() )
                 aTypes += aSeparator;
         
-            ( aTypes += aWildcard ) += aFilters[ i ].second.getToken( 0, ';', nIndex );
+            ( aTypes += aWildcard ) += aFilters[ i ].msExtensions.getToken( 0, ';', nIndex );
         }
         
         // add single filters
-        aDlg.AddFilter( aFilters[ i ].first, aTypes );
+        aDlg.AddFilter( aFilters[ i ].msFilterName, aTypes );
     }
 
     // add filter for all types
     aDlg.AddFilter( AVMEDIA_RESID( AVMEDIA_STR_ALL_FILES ), String( RTL_CONSTASCII_USTRINGPARAM( "*.*" ) ) );
-        
+
     if( aDlg.Execute() == ERRCODE_NONE )
     {
         const INetURLObject aURL( aDlg.GetPath() );
         rURL = aURL.GetMainURL( INetURLObject::DECODE_UNAMBIGUOUS );
+
+        if( bInsertDialog )
+        {
+            // return the link checkbox in the dialog
+            uno::Reference< ui::dialogs::XFilePickerControlAccess > xController( aDlg.GetFilePicker(), uno::UNO_QUERY);
+            if ( xController.is() )
+            {
+                xController->getValue(ui::dialogs::ExtendedFilePickerElementIds::CHECKBOX_LINK, 0) >>= rLink;
+            }
+       }
     }
     else if( rURL.getLength() )
         rURL = ::rtl::OUString();
@@ -512,7 +584,7 @@ bool MediaWindow::isMediaURL( const ::rtl::OUString& rURL, bool bDeep, Size* pPr
             {
                 for( sal_Int32 nIndex = 0; nIndex >= 0 && !bRet; )
                 {
-                    if( aExt.equalsIgnoreAsciiCase( aFilters[ i ].second.getToken( 0, ';', nIndex ) ) )
+                    if( aExt.equalsIgnoreAsciiCase( aFilters[ i ].msExtensions.getToken( 0, ';', nIndex ) ) )
                         bRet = true;
                 }
             }
diff --git a/fpicker/source/aqua/ControlHelper.cxx b/fpicker/source/aqua/ControlHelper.cxx
index 84dc649..10ed75f 100644
--- a/fpicker/source/aqua/ControlHelper.cxx
+++ b/fpicker/source/aqua/ControlHelper.cxx
@@ -152,6 +152,9 @@ void ControlHelper::initialize( sal_Int16 nTemplateId )
         case FILESAVE_AUTOEXTENSION:
             m_bToggleVisibility[AUTOEXTENSION] = true;
             break;
+        case FILEOPEN_LINK:
+            m_bToggleVisibility[LINK] = true;
+            break;
     }
 
     createControls();
diff --git a/fpicker/source/aqua/SalAquaFilePicker.cxx b/fpicker/source/aqua/SalAquaFilePicker.cxx
index 31bfd1c..b8c32ce 100644
--- a/fpicker/source/aqua/SalAquaFilePicker.cxx
+++ b/fpicker/source/aqua/SalAquaFilePicker.cxx
@@ -552,6 +552,10 @@ throw( uno::Exception, uno::RuntimeException )
             m_nDialogType = NAVIGATIONSERVICES_OPEN;
             OSL_TRACE( "Template: FILEOPEN_LINK_PREVIEW_IMAGE_TEMPLATE" );
             break;
+        case FILEOPEN_LINK:
+            m_nDialogType = NAVIGATIONSERVICES_OPEN;
+            OSL_TRACE( "Template: FILEOPEN_LINK" );
+            break;
         case FILEOPEN_PLAY:
             m_nDialogType = NAVIGATIONSERVICES_OPEN;
             OSL_TRACE( "Template: FILEOPEN_PLAY" );
diff --git a/fpicker/source/office/OfficeFilePicker.cxx b/fpicker/source/office/OfficeFilePicker.cxx
index 984b21c..a412fb9 100644
--- a/fpicker/source/office/OfficeFilePicker.cxx
+++ b/fpicker/source/office/OfficeFilePicker.cxx
@@ -311,6 +311,11 @@ WinBits SvtFilePicker::getWinBits( WinBits& rExtraBits )
         nBits = WB_OPEN;
         rExtraBits = SFX_EXTRA_INSERTASLINK | SFX_EXTRA_SHOWPREVIEW | SFX_EXTRA_IMAGE_TEMPLATE;
     }
+    else if ( m_nServiceType == TemplateDescription::FILEOPEN_LINK )
+    {
+        nBits = WB_OPEN;
+        rExtraBits = SFX_EXTRA_INSERTASLINK;
+    }
     else if ( m_nServiceType == TemplateDescription::FILEOPEN_PLAY )
     {
         nBits = WB_OPEN;
diff --git a/fpicker/source/unx/gnome/SalGtkFilePicker.cxx b/fpicker/source/unx/gnome/SalGtkFilePicker.cxx
index e10081e..165d4ea 100644
--- a/fpicker/source/unx/gnome/SalGtkFilePicker.cxx
+++ b/fpicker/source/unx/gnome/SalGtkFilePicker.cxx
@@ -1708,6 +1708,12 @@ void SAL_CALL SalGtkFilePicker::initialize( const uno::Sequence<uno::Any>& aArgu
             mbListVisibility[IMAGE_TEMPLATE] = true;
             // TODO
                 break;
+        case FILEOPEN_LINK:
+            eAction = GTK_FILE_CHOOSER_ACTION_OPEN;
+            first_button_text = GTK_STOCK_OPEN;
+            mbToggleVisibility[LINK] = true;
+            // TODO
+                break;
         case FILEOPEN_PLAY:        
             eAction = GTK_FILE_CHOOSER_ACTION_OPEN;
             first_button_text = GTK_STOCK_OPEN;
diff --git a/fpicker/source/unx/kde4/KDE4FilePicker.cxx b/fpicker/source/unx/kde4/KDE4FilePicker.cxx
index afa125f..ff70e07 100644
--- a/fpicker/source/unx/kde4/KDE4FilePicker.cxx
+++ b/fpicker/source/unx/kde4/KDE4FilePicker.cxx
@@ -662,6 +662,10 @@ void SAL_CALL KDE4FilePicker::initialize( const uno::Sequence<uno::Any> &args )
             addCustomControl( ExtendedFilePickerElementIds::LISTBOX_IMAGE_TEMPLATE );
             break;
 
+        case FILEOPEN_LINK:
+            addCustomControl( ExtendedFilePickerElementIds::CHECKBOX_LINK );
+            break;
+
         case FILEOPEN_PLAY:        
             addCustomControl( ExtendedFilePickerElementIds::PUSHBUTTON_PLAY );
             break;
diff --git a/fpicker/source/win32/filepicker/FPServiceInfo.hxx b/fpicker/source/win32/filepicker/FPServiceInfo.hxx
index c6894ca..fb93bb4 100644
--- a/fpicker/source/win32/filepicker/FPServiceInfo.hxx
+++ b/fpicker/source/win32/filepicker/FPServiceInfo.hxx
@@ -63,6 +63,9 @@
 #define TMPL95_FILESAVE_AUTOEXT                       9000
 #define TMPL2000_FILESAVE_AUTOEXT                     9001
 
+#define TMPL95_FILEOPEN_LINK                         10000
+#define TMPL2000_FILEOPEN_LINK                       10001
+
 // the service names
 #define FILE_PICKER_SERVICE_NAME  "com.sun.star.ui.dialogs.SystemFilePicker"
 
diff --git a/fpicker/source/win32/filepicker/FilePicker.cxx b/fpicker/source/win32/filepicker/FilePicker.cxx
index 9e11cc7..43651b4 100644
--- a/fpicker/source/win32/filepicker/FilePicker.cxx
+++ b/fpicker/source/win32/filepicker/FilePicker.cxx
@@ -698,7 +698,14 @@ void SAL_CALL CFilePicker::initialize(const uno::Sequence<uno::Any>& aArguments)
             winResTemplateId = TMPL95_FILEOPEN_LINK_PREVIEW_BOX_ID;
         break;
 
-    case FILEOPEN_PLAY:        
+    case FILEOPEN_LINK:
+        if ( bIsWin2000 )
+            winResTemplateId = TMPL2000_FILEOPEN_LINK;
+        else
+            winResTemplateId = TMPL95_FILEOPEN_LINK;
+        break;
+
+   case FILEOPEN_PLAY:
         if ( bIsWin2000 )
             winResTemplateId = TMPL2000_PLAY_PUSHBUTTON;
         else
diff --git a/fpicker/source/win32/filepicker/Fps.rc b/fpicker/source/win32/filepicker/Fps.rc
index ad08ad0..bba5b88 100644
--- a/fpicker/source/win32/filepicker/Fps.rc
+++ b/fpicker/source/win32/filepicker/Fps.rc
@@ -250,6 +250,23 @@ BEGIN
     LTEXT           "",1119,0,0,277,38
 END
 
+10000 DIALOG DISCARDABLE  0, 0, 196, 29
+STYLE DS_3DLOOK | DS_FIXEDSYS | DS_CONTROL | WS_CHILD | WS_CLIPSIBLINGS
+FONT 8, "Andale Sans UI"
+BEGIN
+    CONTROL         "Als Link einfügen",104,"Button",BS_AUTOCHECKBOX |
+                    WS_TABSTOP,0,16,196,10
+    LTEXT           "",1119,0,0,196,16
+END
+
+10001 DIALOG DISCARDABLE  0, 0, 278, 54
+STYLE DS_3DLOOK | DS_CONTROL | WS_CHILD | WS_CLIPSIBLINGS
+FONT 8, "MS Shell Dlg"
+BEGIN
+    CONTROL         "Als Link einfügen",104,"Button",
+                    BS_AUTOCHECKBOX | WS_TABSTOP,130,38,144,14
+    LTEXT           "",1119,0,0,277,38
+END
 
 /////////////////////////////////////////////////////////////////////////////
 //
diff --git a/fpicker/source/win32/filepicker/VistaFilePicker.cxx b/fpicker/source/win32/filepicker/VistaFilePicker.cxx
index 1a1a7fb..30c8406 100644
--- a/fpicker/source/win32/filepicker/VistaFilePicker.cxx
+++ b/fpicker/source/win32/filepicker/VistaFilePicker.cxx
@@ -626,6 +626,13 @@ void SAL_CALL VistaFilePicker::initialize(const css::uno::Sequence< css::uno::An
             nFeatures        |= FEATURE_IMAGETEMPLATE;
         }
         break;
+
+        case css::ui::dialogs::TemplateDescription::FILEOPEN_LINK :
+        {
+            bFileOpenDialog  = sal_True;
+            nFeatures        |= FEATURE_LINK;
+        }
+        break;
     
         case css::ui::dialogs::TemplateDescription::FILEOPEN_PLAY :
         {
diff --git a/fpicker/source/win32/filepicker/VistaFilePickerImpl.cxx b/fpicker/source/win32/filepicker/VistaFilePickerImpl.cxx
index 67bd016..56a4593 100644
--- a/fpicker/source/win32/filepicker/VistaFilePickerImpl.cxx
+++ b/fpicker/source/win32/filepicker/VistaFilePickerImpl.cxx
@@ -504,6 +504,10 @@ void VistaFilePickerImpl::impl_sta_enableFeatures(::sal_Int32 nFeatures, ::sal_I
         case css::ui::dialogs::TemplateDescription::FILEOPEN_LINK_PREVIEW_IMAGE_TEMPLATE :
             aGUID = CLIENTID_FILEOPEN_LINK_TEMPLATE;
             break;
+
+        case css::ui::dialogs::TemplateDescription::FILEOPEN_LINK :
+            aGUID = CLIENTID_FILEOPEN_LINK;
+            break;
     
         case css::ui::dialogs::TemplateDescription::FILEOPEN_PLAY :
             aGUID = CLIENTID_FILEOPEN_PLAY;
diff --git a/offapi/com/sun/star/ui/dialogs/TemplateDescription.idl b/offapi/com/sun/star/ui/dialogs/TemplateDescription.idl
index ad02efc..c6c8ec1 100644
--- a/offapi/com/sun/star/ui/dialogs/TemplateDescription.idl
+++ b/offapi/com/sun/star/ui/dialogs/TemplateDescription.idl
@@ -134,6 +134,14 @@ published constants TemplateDescription
     */
     const short FILESAVE_AUTOEXTENSION			               = 10;
 
+    //---------------------------------------------------------------------
+    /** A FileOpen dialog with additional controls.
+        <ul>
+            <li>A checkbox "Insert as link"
+        </ul>
+    */
+    const short FILEOPEN_LINK                                  = 11;
+
 };	
 
 //=============================================================================
diff --git a/sc/source/ui/drawfunc/fuins1.cxx b/sc/source/ui/drawfunc/fuins1.cxx
index da7e89b..175039d 100644
--- a/sc/source/ui/drawfunc/fuins1.cxx
+++ b/sc/source/ui/drawfunc/fuins1.cxx
@@ -210,7 +210,7 @@ void lcl_InsertGraphic( const Graphic& rGraphic,
 
 void lcl_InsertMedia( const ::rtl::OUString& rMediaURL, bool bApi,
                       ScTabViewShell* pViewSh, Window* pWindow, SdrView* pView,
-                      const Size& rPrefSize )
+                      const Size& rPrefSize, bool bLinked )
 {
     SdrPageView* 	pPV  = pView->GetSdrPageView();
     SdrPage* 		pPage = pPV->GetPage();
@@ -237,6 +237,9 @@ void lcl_InsertMedia( const ::rtl::OUString& rMediaURL, bool bApi,
     
     pObj->setURL( rMediaURL ); 
     pView->InsertObjectAtView( pObj, *pPV, bApi ? SDRINSERT_DONTMARK : 0 );
+
+    if( !bLinked )
+        pObj->breakLink();
 }
 
 /*************************************************************************
@@ -386,6 +389,7 @@ FuInsertMedia::FuInsertMedia( ScTabViewShell*	pViewSh,
     FuPoor(pViewSh, pWin, pViewP, pDoc, rReq)
 {
     ::rtl::OUString 	aURL;
+    sal_Bool            bLinked = sal_True;
     const SfxItemSet*	pReqArgs = rReq.GetArgs();
     bool				bAPI = false;
 
@@ -398,9 +402,15 @@ FuInsertMedia::FuInsertMedia( ScTabViewShell*	pViewSh,
             aURL = pStringItem->GetValue();
             bAPI = aURL.getLength();
         }
+
+        const SfxBoolItem* pBoolItem = dynamic_cast< const SfxBoolItem* >( &pReqArgs->Get( FN_PARAM_1 ) );
+        if( pBoolItem )
+        {
+            bLinked = pBoolItem->GetValue() ? sal_True : sal_False;
+        }
     }
 
-    if( bAPI || ::avmedia::MediaWindow::executeMediaURLDialog( pWindow, aURL ) )
+    if( bAPI || ::avmedia::MediaWindow::executeInsertMediaURLDialog( pWindow, aURL, bLinked ) )
     {
         Size aPrefSize;
 
@@ -417,7 +427,7 @@ FuInsertMedia::FuInsertMedia( ScTabViewShell*	pViewSh,
         }
         else
         {
-            lcl_InsertMedia( aURL, bAPI, pViewSh, pWindow, pView, aPrefSize );
+            lcl_InsertMedia( aURL, bAPI, pViewSh, pWindow, pView, aPrefSize, bLinked );
         
             if( pWin )
                 pWin->LeaveWait();
diff --git a/sd/source/core/drawdoc.cxx b/sd/source/core/drawdoc.cxx
index 00fa5c8..45bb97c 100644
--- a/sd/source/core/drawdoc.cxx
+++ b/sd/source/core/drawdoc.cxx
@@ -78,6 +78,7 @@
 #endif
 #include <svtools/lingucfg.hxx>
 #include <svtools/linguprops.hxx>
+#include <svx/sdr/media/mediamanager.hxx>
 
 #include "eetext.hxx"
 #include "drawdoc.hxx"
@@ -192,6 +193,9 @@ SdDrawDocument::SdDrawDocument(DocumentType eType, SfxObjectShell* pDrDocSh)
     if (mpDocSh)
     {
         SetSwapGraphics(TRUE);
+
+        rtl::Reference< sdr::media::MediaManager > xMediaManager( new sdr::media::MediaManager( mpDocSh ) );
+        SetMediaManager( xMediaManager );
     }
 
     // Masseinheit (von App) und Massstab (von SdMod) setzen
diff --git a/sd/source/ui/func/fuinsert.cxx b/sd/source/ui/func/fuinsert.cxx
index 1460d14..7a4f0b3 100644
--- a/sd/source/ui/func/fuinsert.cxx
+++ b/sd/source/ui/func/fuinsert.cxx
@@ -706,6 +706,7 @@ FunctionReference FuInsertAVMedia::Create( ViewShell* pViewSh, ::sd::Window* pWi
 void FuInsertAVMedia::DoExecute( SfxRequest& rReq )
 {
     ::rtl::OUString 	aURL;
+    sal_Bool            bLinked = sal_True;
     const SfxItemSet*	pReqArgs = rReq.GetArgs();
     bool				bAPI = false;
 
@@ -718,9 +719,15 @@ void FuInsertAVMedia::DoExecute( SfxRequest& rReq )
             aURL = pStringItem->GetValue();
             bAPI = aURL.getLength();
         }
+
+        const SfxBoolItem* pBoolItem = dynamic_cast< const SfxBoolItem* >( &pReqArgs->Get( FN_PARAM_1 ) );
+        if( pBoolItem )
+        {
+            bLinked = pBoolItem->GetValue() ? sal_True : sal_False;
+        }
     }
 
-    if( bAPI || ::avmedia::MediaWindow::executeMediaURLDialog( mpWindow, aURL ) )
+    if( bAPI || ::avmedia::MediaWindow::executeInsertMediaURLDialog( mpWindow, aURL, bLinked ) )
     {
         Size aPrefSize;
 
@@ -739,7 +746,7 @@ void FuInsertAVMedia::DoExecute( SfxRequest& rReq )
         {
             Point	    aPos;
             Size	    aSize;
-            sal_Int8    nAction = DND_ACTION_COPY;
+            sal_Int8    nAction = bLinked ? DND_ACTION_LINK : DND_ACTION_COPY;
 
             if( aPrefSize.Width() && aPrefSize.Height() )
             {
diff --git a/sd/source/ui/view/sdview4.cxx b/sd/source/ui/view/sdview4.cxx
index f367fa3..6e810f5 100644
--- a/sd/source/ui/view/sdview4.cxx
+++ b/sd/source/ui/view/sdview4.cxx
@@ -46,6 +46,7 @@
 #ifndef _IMPGRF_HXX
 #include <svx/impgrf.hxx>
 #endif
+
 #include <sot/storage.hxx>
 #include <sfx2/app.hxx>
 #include <avmedia/mediawindow.hxx>
@@ -306,27 +307,37 @@ SdrMediaObj* View::InsertMediaURL( const rtl::OUString& rMediaURL, sal_Int8& rAc
             pPV = 0L;
     }
 
-    if( !pPickObj && pPV )
+    if( pPV )
     {
-        SdrPageView* pPageView = pPV;
-        PickObj(rPos, getHitTolLog(), pPickObj, pPageView);
-    }
 
-    if( mnAction == DND_ACTION_LINK && pPickObj && pPV && pPickObj->ISA( SdrMediaObj ) )
-    {
-        pNewMediaObj = static_cast< SdrMediaObj* >( pPickObj->Clone() );
-        pNewMediaObj->setURL( rMediaURL );
+        if( !pPickObj )
+        {
+            SdrPageView* pPageView = pPV;
+            PickObj(rPos, getHitTolLog(), pPickObj, pPageView);
+        }
 
-        BegUndo(String(SdResId(STR_UNDO_DRAGDROP)));
-        ReplaceObjectAtView(pPickObj, *pPV, pNewMediaObj);
-        EndUndo();
-    }
-    else if( pPV )
-    {
-        pNewMediaObj = new SdrMediaObj( Rectangle( rPos, rSize ) );
-                
-        if( pPV && InsertObjectAtView( pNewMediaObj, *pPV, SDRINSERT_SETDEFLAYER ) )
+        if( (mnAction == DND_ACTION_LINK) && pPickObj && pPickObj->ISA( SdrMediaObj ) )
+        {
+            pNewMediaObj = static_cast< SdrMediaObj* >( pPickObj->Clone() );
             pNewMediaObj->setURL( rMediaURL );
+
+            BegUndo(String(SdResId(STR_UNDO_DRAGDROP)));
+            ReplaceObjectAtView(pPickObj, *pPV, pNewMediaObj);
+            EndUndo();
+        }
+        else
+        {
+            pNewMediaObj = new SdrMediaObj( Rectangle( rPos, rSize ) );
+
+            if( InsertObjectAtView( pNewMediaObj, *pPV, SDRINSERT_SETDEFLAYER ) )
+                pNewMediaObj->setURL( rMediaURL );
+        }
+
+        if( pNewMediaObj && (mnAction != DND_ACTION_LINK) )
+        {
+            // embed av target
+            pNewMediaObj->breakLink();
+        }
     }
 
     rAction = mnAction;
diff --git a/sfx2/inc/sfx2/lnkbase.hxx b/sfx2/inc/sfx2/lnkbase.hxx
index 6a30854..30869c8 100644
--- a/sfx2/inc/sfx2/lnkbase.hxx
+++ b/sfx2/inc/sfx2/lnkbase.hxx
@@ -65,6 +65,7 @@ class FileDialogHelper;
 #define	OBJECT_CLIENT_FILE			0x90
 #define	OBJECT_CLIENT_GRF			0x91
 #define	OBJECT_CLIENT_OLE			0x92 // embedded link
+#define	OBJECT_CLIENT_AVMEDIA		0x93 // audio/video link
 
 enum sfxlink {
     // Ole2 compatibel und persistent
diff --git a/sfx2/sdi/sfx.sdi b/sfx2/sdi/sfx.sdi
index f7d0e38..b4d2cc1 100644
--- a/sfx2/sdi/sfx.sdi
+++ b/sfx2/sdi/sfx.sdi
@@ -8534,7 +8534,7 @@ SfxVoidItem AVMediaPlayer SID_AVMEDIA_PLAYER
 ]
 
 SfxStringItem InsertAVMedia SID_INSERT_AVMEDIA
-()
+(SfxStringItem URL SID_INSERT_AVMEDIA,SfxBoolItem AsLink FN_PARAM_1)
 [
     /* flags: */
     AutoUpdate = FALSE,
diff --git a/sfx2/source/dialog/filedlghelper.cxx b/sfx2/source/dialog/filedlghelper.cxx
index fdb2474..a3f7033 100644
--- a/sfx2/source/dialog/filedlghelper.cxx
+++ b/sfx2/source/dialog/filedlghelper.cxx
@@ -955,6 +955,8 @@ FileDialogHelper_Impl::FileDialogHelper_Impl(
     mbSelection				= sal_False;
     mbSelectionEnabled		= sal_True;
 
+    bool bAddGraphicFilter  = false;
+
     // default settings
     m_nDontFlags = SFX_FILTER_INTERNAL | SFX_FILTER_NOTINFILEDLG | SFX_FILTER_NOTINSTALLED;
     if( WB_OPEN == ( nFlags & WB_OPEN ) )
@@ -1041,6 +1043,7 @@ FileDialogHelper_Impl::FileDialogHelper_Impl(
                 nTemplateDescription = TemplateDescription::FILEOPEN_LINK_PREVIEW_IMAGE_TEMPLATE;
                 mbHasPreview = sal_True;
                 mbHasLink = sal_True;
+                bAddGraphicFilter = true;
 
                 // aPreviewTimer
                 maPreViewTimer.SetTimeout( 500 );
@@ -1060,6 +1063,7 @@ FileDialogHelper_Impl::FileDialogHelper_Impl(
                 nTemplateDescription = TemplateDescription::FILEOPEN_LINK_PREVIEW;
                 mbHasPreview = sal_True;
                 mbHasLink = sal_True;
+                bAddGraphicFilter = true;
                 // aPreviewTimer
                 maPreViewTimer.SetTimeout( 500 );
                 maPreViewTimer.SetTimeoutHdl( LINK( this, FileDialogHelper_Impl, TimeOutHdl_Impl ) );
@@ -1071,6 +1075,11 @@ FileDialogHelper_Impl::FileDialogHelper_Impl(
                 mbIsSaveDlg = sal_True;
                 break;
 
+            case FILEOPEN_LINK:
+                nTemplateDescription = TemplateDescription::FILEOPEN_LINK;
+                mbHasLink = sal_True;
+                break;
+
             default:
                 DBG_ERRORFILE( "FileDialogHelper::ctor with unknown type" );
                 break;
@@ -1134,7 +1143,7 @@ FileDialogHelper_Impl::FileDialogHelper_Impl(
     if ( nFlags & SFXWB_MULTISELECTION )
         mxFileDlg->setMultiSelectionMode( sal_True );
 
-    if ( mbHasLink )		// generate graphic filter only on demand
+    if ( bAddGraphicFilter )		// generate graphic filter only on demand
         addGraphicFilter();
 
     // Export dialog
diff --git a/sot/inc/sot/formats.hxx b/sot/inc/sot/formats.hxx
index 6fc6df8..14f0dcb 100644
--- a/sot/inc/sot/formats.hxx
+++ b/sot/inc/sot/formats.hxx
@@ -185,7 +185,8 @@
 #define SOT_FORMATSTR_ID_STARMATH_8_TEMPLATE    ((ULONG)138)
 #define SOT_FORMATSTR_ID_STARBASE_8             ((ULONG)139)
 #define SOT_FORMATSTR_ID_HC_GDIMETAFILE         ((ULONG)140)
-#define SOT_FORMATSTR_ID_USER_END               SOT_FORMATSTR_ID_HC_GDIMETAFILE
+#define SOT_FORMATSTR_ID_AVMEDIA		        ((ULONG)141)
+#define SOT_FORMATSTR_ID_USER_END               SOT_FORMATSTR_ID_AVMEDIA
 
 #endif // _SOT_FORMATS_HXX
 
diff --git a/sot/source/base/exchange.cxx b/sot/source/base/exchange.cxx
index 3c99fc7..b3971e5 100644
--- a/sot/source/base/exchange.cxx
+++ b/sot/source/base/exchange.cxx
@@ -211,6 +211,7 @@ namespace
             /*138 SOT_FORMATSTR_ID_STARMATH_8_TEMPLATE*/            { MIMETYPE_OASIS_OPENDOCUMENT_FORMULA_TEMPLATE_ASCII, "Math 8 Template", &::getCppuType( (const Sequence< sal_Int8 >*) 0 ) },
             /*139 SOT_FORMATSTR_ID_STARBASE_8*/            { MIMETYPE_OASIS_OPENDOCUMENT_DATABASE_ASCII, "StarBase 8", &::getCppuType( (const Sequence< sal_Int8 >*) 0 ) },
             /*140 SOT_FORMAT_GDIMETAFILE*/					{ "application/x-openoffice-highcontrast-gdimetafile;windows_formatname=\"GDIMetaFile\"", "High Contrast GDIMetaFile", &::getCppuType( (const Sequence< sal_Int8 >*) 0 ) },
+            /*141 SOT_FORMAT_AVMEDIA*/						{ "application/vnd.sun.star.media", "Audio/Video", &::getCppuType( (const Sequence< sal_Int8 >*) 0 ) }
             };
         return &aInstance[0];
         }
diff --git a/svx/inc/svx/dialogs.hrc b/svx/inc/svx/dialogs.hrc
index 9f7c814..9080abd 100644
--- a/svx/inc/svx/dialogs.hrc
+++ b/svx/inc/svx/dialogs.hrc
@@ -1387,9 +1387,12 @@
 #define RID_SVXSTR_EVENT_FIELDMERGE							(RID_SVX_START + 1187)
 #define RID_SVXSTR_EVENT_FIELDMERGE_FINISHED				(RID_SVX_START + 1188)
 #define RID_SVXSTR_EVENT_LAYOUT_FINISHED					(RID_SVX_START + 1189)
-    // if you add here, remember to adjust RID_SVXSTR_NEXTFREE
 
-#define RID_SVXSTR_NEXTFREE                                 (RID_SVX_START + 1190)
+#define RID_SVXSTR_AVMEDIALINK								(RID_SVX_START + 1190)
+
+// if you add here, remember to adjust RID_SVXSTR_NEXTFREE
+// DANGER: IF THERE IS A CONFLICT, PLEASER LOOK FOR DUPLICATE IDS AND RESOLVE THEM!
+#define RID_SVXSTR_NEXTFREE                                 (RID_SVX_START + 1191)
 
 // ----------------------------------------------------------------------------
 // if we have _a_lot_ time, we should group the resource ids by type, instead
diff --git a/svx/inc/svx/sdr/media/medialink.hxx b/svx/inc/svx/sdr/media/medialink.hxx
new file mode 100644
index 0000000..736de64
--- /dev/null
+++ b/svx/inc/svx/sdr/media/medialink.hxx
@@ -0,0 +1,81 @@
+/*************************************************************************
+ *
+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
+ *
+ * Copyright 2008 by Sun Microsystems, Inc.
+ *
+ * OpenOffice.org - a multi-platform office productivity suite
+ *
+ * $RCSfile: animationstate.hxx,v $
+ * $Revision: 1.5 $
+ *
+ * This file is part of OpenOffice.org.
+ *
+ * OpenOffice.org is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Lesser General Public License version 3
+ * only, as published by the Free Software Foundation.
+ *
+ * OpenOffice.org is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Lesser General Public License version 3 for more details
+ * (a copy is included in the LICENSE file that accompanied this code).
+ *
+ * You should have received a copy of the GNU Lesser General Public License
+ * version 3 along with OpenOffice.org.  If not, see
+ * <http://www.openoffice.org/license.html>
+ * for a copy of the LGPLv3 License.
+ *
+ ************************************************************************/
+
+#ifndef _SDR_MEDIA_MEDIALINK_HXX
+#define _SDR_MEDIA_MEDIALINK_HXX
+
+#include <sal/types.h>
+#include <rtl/ref.hxx>
+#include <comphelper/weak.hxx>
+#include "svx/svxdllapi.h"
+
+//////////////////////////////////////////////////////////////////////////////
+// predeclarations
+
+namespace sdr {	namespace media {
+
+class MediaManager;
+
+class SVX_DLLPUBLIC MediaLink : public ::cppu::OWeakObject
+{
+public:
+    MediaLink( const rtl::Reference< MediaManager >& xManager, const rtl::OUString& rURL, bool bLinked );
+    ~MediaLink();
+
+    rtl::OUString getMediaURL() const { return msURL; }
+    rtl::OUString getTempFileURL() const { return msTempFileURL; }
+    rtl::OUString getOrCreateTempFileURL();
+
+    rtl::OUString getMimeType() const { return msMimeType; }
+    rtl::OUString getFilterName() const { return msFilterName; }
+
+    bool isLinked() const { return mbLinked; }
+
+    MediaManager* getMediaManager() const { return mpManager; }
+
+private:
+    MediaManager* mpManager;
+    bool mbLinked;
+    rtl::OUString msURL;
+    rtl::OUString msTempFileURL;
+    rtl::OUString msMimeType;
+    rtl::OUString msFilterName;
+};
+
+typedef rtl::Reference< MediaLink > MediaLinkRef;
+
+} // end of namespace animation
+} // end of namespace sdr
+
+//////////////////////////////////////////////////////////////////////////////
+
+#endif //_SDR_MEDIA_MEDIALINK_HXX
+
+// eof
diff --git a/svx/inc/svx/sdr/media/mediamanager.hxx b/svx/inc/svx/sdr/media/mediamanager.hxx
new file mode 100644
index 0000000..4749803
--- /dev/null
+++ b/svx/inc/svx/sdr/media/mediamanager.hxx
@@ -0,0 +1,90 @@
+/*************************************************************************
+ *
+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
+ *
+ * Copyright 2008 by Sun Microsystems, Inc.
+ *
+ * OpenOffice.org - a multi-platform office productivity suite
+ *
+ * $RCSfile: animationstate.hxx,v $
+ * $Revision: 1.5 $
+ *
+ * This file is part of OpenOffice.org.
+ *
+ * OpenOffice.org is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Lesser General Public License version 3
+ * only, as published by the Free Software Foundation.
+ *
+ * OpenOffice.org is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Lesser General Public License version 3 for more details
+ * (a copy is included in the LICENSE file that accompanied this code).
+ *
+ * You should have received a copy of the GNU Lesser General Public License
+ * version 3 along with OpenOffice.org.  If not, see
+ * <http://www.openoffice.org/license.html>
+ * for a copy of the LGPLv3 License.
+ *
+ ************************************************************************/
+
+#ifndef _SDR_MEDIA_MEDIAMANAGER_HXX
+#define _SDR_MEDIA_MEDIAMANAGER_HXX
+
+#include <hash_map>
+#include <com/sun/star/embed/XStorage.hpp>
+#include <comphelper/weak.hxx>
+#include <svtools/lstner.hxx>
+#include <svx/sdr/media/medialink.hxx>
+
+class SfxObjectShell;
+
+//////////////////////////////////////////////////////////////////////////////
+// predeclarations
+
+namespace sdr {	namespace media	{
+
+typedef std::hash_map< ::rtl::OUString, MediaLinkRef, ::rtl::OUStringHash, ::std::equal_to< ::rtl::OUString > > MediaLinkMap;
+
+class SVX_DLLPUBLIC MediaManager : public ::cppu::OWeakObject, public SfxListener
+{
+    friend class MediaLink;
+public:
+    MediaManager( SfxObjectShell* pObjectShell );
+    virtual ~MediaManager();
+
+    void Dispose();
+
+    MediaLinkRef    insertMediaStream( const rtl::OUString& rURL );
+
+    MediaLinkRef    getMediaLink( const rtl::OUString& rURL );
+
+    virtual void Notify( SfxBroadcaster& rBC, const SfxHint& rHint );
+
+private:
+    void SwitchPersistance(const ::com::sun::star::uno::Reference< ::com::sun::star::embed::XStorage >& xStorage );
+
+    void freeMediaLink( const MediaLinkRef& xLink );
+
+    rtl::OUString createTemporaryCopy( const rtl::OUString& rURL );
+
+    const com::sun::star::uno::Reference < com::sun::star::embed::XStorage >& getDocumentStorage();
+    com::sun::star::uno::Reference < com::sun::star::embed::XStorage > getMediaStorage();
+private:
+    SfxObjectShell* mpObjectShell;
+    MediaLinkMap maMediaLinkMap;
+    const rtl::OUString msPackagePrefix;
+    const rtl::OUString msMedia;
+    const rtl::OUString msMediaType;
+    const rtl::OUString msStorageMediaType;
+    com::sun::star::uno::Reference < com::sun::star::embed::XStorage > mxDocumentStorage;
+};
+
+    } // end of namespace animation
+} // end of namespace sdr
+
+//////////////////////////////////////////////////////////////////////////////
+
+#endif //_SDR_MEDIA_MEDIAMANAGER_HXX
+
+// eof
diff --git a/svx/inc/svx/svdmodel.hxx b/svx/inc/svx/svdmodel.hxx
index 2001f69..9ada891 100644
--- a/svx/inc/svx/svdmodel.hxx
+++ b/svx/inc/svx/svdmodel.hxx
@@ -54,6 +54,7 @@ class OutputDevice;
 #include "svx/svxdllapi.h"
 
 #include <vos/ref.hxx>
+#include <rtl/ref.hxx>
 
 #if defined(UNX) || defined(WIN) || defined(WNT)
 #define DEGREE_CHAR ((sal_Unicode)176)   /* 0xB0 = Ansi */
@@ -104,6 +105,11 @@ class SdrUndoFactory;
 namespace comphelper{
     class IEmbeddedHelper;
 }
+
+namespace sdr { namespace media {
+    class MediaManager;
+} }
+
 ////////////////////////////////////////////////////////////////////////////////////////////////////
 
 #define SDR_SWAPGRAPHICSMODE_NONE		0x00000000
@@ -302,6 +308,8 @@ protected:
 
     virtual ::com::sun::star::uno::Reference< ::com::sun::star::uno::XInterface > createUnoModel();
 
+    void SetMediaManager( const rtl::Reference< sdr::media::MediaManager >& xManager );
+
 private:
     // Nicht implementiert:
     SVX_DLLPRIVATE SdrModel(const SdrModel& rSrcModel);
@@ -737,6 +745,7 @@ public:
         also during the runtime of the Undo() and Redo() methods. */
     bool IsUndoEnabled() const;
 
+    rtl::Reference< sdr::media::MediaManager > GetMediaManager();
 };
 
 typedef tools::WeakReference< SdrModel > SdrModelWeakRef;
diff --git a/svx/inc/svx/svdomedia.hxx b/svx/inc/svx/svdomedia.hxx
index 31de61b..defcc40 100644
--- a/svx/inc/svx/svdomedia.hxx
+++ b/svx/inc/svx/svdomedia.hxx
@@ -31,8 +31,10 @@
 #include <svx/svdorect.hxx>
 #include <avmedia/mediaitem.hxx>
 #include "svx/svxdllapi.h"
+#include "svx/sdr/media/medialink.hxx"
 
 class Graphic;
+class SdrMediaLink;
 
 namespace sdr { namespace contact { class ViewContactOfSdrMediaObj; } }
 
@@ -43,6 +45,7 @@ namespace sdr { namespace contact { class ViewContactOfSdrMediaObj; } }
 class SVX_DLLPUBLIC SdrMediaObj : public SdrRectObj
 {
     friend class ::sdr::contact::ViewContactOfSdrMediaObj;
+    friend class SdrMediaLink;
 
 public:
 
@@ -63,8 +66,13 @@ public:
 
         virtual void 				operator=(const SdrObject& rObj);
 
+        // embeds the av link
+        void						breakLink();
 public:
+        void                        setMediaLink( const ::rtl::Reference< sdr::media::MediaLink >& xMediaLink );
+        const ::rtl::Reference< sdr::media::MediaLink >& getMediaLink() const { return mxMediaLink; }
 
+        /* deprecated, use media link above */
         void						setURL( const ::rtl::OUString& rURL );
         const ::rtl::OUString&		getURL() const;
 
@@ -77,16 +85,26 @@ public:
         const Graphic&              getGraphic() const;
         void                        setGraphic( const Graphic* pGraphic = NULL );
 
+        virtual void				SetPage(SdrPage* pNewPage);
+        virtual void				SetModel(SdrModel* pNewModel);
+
 protected:
 
         virtual void				mediaPropertiesChanged( const ::avmedia::MediaItem& rNewState );
 
+        virtual void				connect();
+        virtual void				disconnect();
+
 private:
+        // used by SdrMediaLink if link is changed
+        void UpdateURL( const ::rtl::OUString& rURL );
 
         virtual ::sdr::contact::ViewContact* CreateObjectSpecificViewContact();
 
         ::avmedia::MediaItem		maMediaProperties;
         ::std::auto_ptr< Graphic >  mapGraphic;
+        ::rtl::Reference< sdr::media::MediaLink > mxMediaLink;
+        SdrMediaLink*				mpSdrMediaLink;
 };
 
 #endif //_SVDOMEDIA_HXX
diff --git a/svx/prj/build.lst b/svx/prj/build.lst
index 5698070..2ef6f73 100644
--- a/svx/prj/build.lst
+++ b/svx/prj/build.lst
@@ -27,6 +27,7 @@ sx	svx\source\sdr\properties				nmake	-	all	sx_properties sx_inc NULL
 sx	svx\source\sdr\contact					nmake	-	all	sx_contact sx_inc NULL
 sx	svx\source\sdr\event					nmake	-	all	sx_event sx_inc NULL
 sx	svx\source\sdr\animation				nmake	-	all	sx_animation sx_inc NULL
+sx	svx\source\sdr\media					nmake	-	all	sx_media sx_inc NULL
 sx	svx\source\sdr\overlay					nmake	-	all	sx_overlay sx_inc NULL
 sx	svx\source\smarttags					nmake	-	all	sx_smarttags sx_inc NULL
 sx	svx\source\stbctrls						nmake	-	all	sx_stbc sx_inc NULL
@@ -49,5 +50,5 @@ sx	svx\source\accessibility				nmake	-	all	sx_accessibility sx_inc NULL
 sx	svx\source\customshapes					nmake	-	all sx_customshapes sx_inc NULL
 sx	svx\source\toolbars						nmake	-	all sx_toolbars sx_inc NULL
 sx      svx\source\cui                                                  nmake   -       all     sx_cui sx_inc NULL
-sx      svx\util                                                                nmake   -       all     sx_util sx_cui sx_3deng sx_dlg sx_draw sx_attribute sx_properties sx_contact sx_event sx_animation sx_primitive2d sx_primitive3d sx_overlay sx_eeng sx_fmcmp sx_form sx_gall sx_items sx_link sx_mnuc sx_msfilt sx_opt sx_outl sx_rtf sx_sdi sx_stbc sx_tbxc sx_undrw sx_unedt sx_ungal sx_xml sx_xout sx_accessibility sx_intro sx_customshapes sx_toolbars sx_table sx_smarttags NULL
+sx      svx\util                                                                nmake   -       all     sx_util sx_cui sx_3deng sx_dlg sx_draw sx_attribute sx_properties sx_contact sx_event sx_animation sx_primitive2d sx_primitive3d sx_overlay sx_eeng sx_fmcmp sx_form sx_gall sx_items sx_link sx_mnuc sx_msfilt sx_opt sx_outl sx_rtf sx_sdi sx_stbc sx_tbxc sx_undrw sx_unedt sx_ungal sx_xml sx_xout sx_accessibility sx_intro sx_customshapes sx_toolbars sx_table sx_smarttags sx_media NULL
 sx	svx\source\gengal						nmake	-	all	sx_gengal sx_util NULL
diff --git a/svx/prj/d.lst b/svx/prj/d.lst
index 072749a..a34524b 100644
--- a/svx/prj/d.lst
+++ b/svx/prj/d.lst
@@ -623,6 +623,10 @@ mkdir: %_DEST%\inc%_EXT%\svx\sdr\animation
 mkdir: %_DEST%\inc%_EXT%\svx\sdr\table
 ..\inc\svx\sdr\table\tabledesign.hxx %_DEST%\inc%_EXT%\svx\sdr\table\tabledesign.hxx
 
+mkdir: %_DEST%\inc%_EXT%\svx\sdr\media
+..\inc\svx\sdr\media\medialink.hxx %_DEST%\inc%_EXT%\svx\sdr\media\medialink.hxx
+..\inc\svx\sdr\media\mediamanager.hxx %_DEST%\inc%_EXT%\svx\sdr\media\mediamanager.hxx
+
 ..\xml\SvxDrawPage.xml %_DEST%\xml%_EXT%\SvxDrawPage.xml
 ..\xml\SvxGraphicObject.xml %_DEST%\xml%_EXT%\SvxGraphicObject.xml
 ..\xml\SvxShape.xml %_DEST%\xml%_EXT%\SvxShape.xml
diff --git a/svx/source/cui/cuigaldlg.cxx b/svx/source/cui/cuigaldlg.cxx
index b3c57fc..b3f5d9d 100644
--- a/svx/source/cui/cuigaldlg.cxx
+++ b/svx/source/cui/cuigaldlg.cxx
@@ -925,8 +925,8 @@ void TPGalleryThemeProperties::FillFilterList()
             ::rtl::OUString aFilterWildcard( aWildcard );
 
             pFilterEntry = new FilterEntry;
-            pFilterEntry->aFilterName = aFilters[ l ].second.getToken( 0, ';', nIndex );
-            nFirstExtFilterPos = aCbbFileType.InsertEntry( addExtension( aFilters[ l ].first,
+            pFilterEntry->aFilterName = aFilters[ l ].msExtensions.getToken( 0, ';', nIndex );
+            nFirstExtFilterPos = aCbbFileType.InsertEntry( addExtension( aFilters[ l ].msFilterName,
                                                            aFilterWildcard += pFilterEntry->aFilterName ) );
             aFilterEntryList.Insert( pFilterEntry, nFirstExtFilterPos );
         }
@@ -962,7 +962,7 @@ void TPGalleryThemeProperties::FillFilterList()
         {
             if ( aExtensions.Len() )
                 aExtensions += sal_Unicode( ';' );
-            ( aExtensions += String( aWildcard ) ) += String( aFilters[ k ].second.getToken( 0, ';', nIndex ) );
+            ( aExtensions += String( aWildcard ) ) += String( aFilters[ k ].msExtensions.getToken( 0, ';', nIndex ) );
         }
      }
 
diff --git a/svx/source/cui/linkdlg.cxx b/svx/source/cui/linkdlg.cxx
index e7375aa..23ae7c5 100644
--- a/svx/source/cui/linkdlg.cxx
+++ b/svx/source/cui/linkdlg.cxx
@@ -205,8 +205,11 @@ IMPL_LINK( SvBaseLinksDlg, LinksSelectHdl, SvTabListBox *, pSvTabListBox )
             Automatic().Disable();
             Manual().Check();
             Manual().Disable();
-            if( OBJECT_CLIENT_GRF == pLink->GetObjType() )
-                pLinkNm = 0, pFilter = &sLink;
+            if( (OBJECT_CLIENT_GRF == pLink->GetObjType()) || (OBJECT_CLIENT_AVMEDIA == pLink->GetObjType()) )
+            {
+                pLinkNm = 0;
+                pFilter = &sLink;
+            }
         }
         else
         {
@@ -527,7 +530,7 @@ IMPL_LINK( SvBaseLinksDlg, EndEditHdl, sfx2::SvBaseLink*, _pLink )
     USHORT nPos;
     SvBaseLink* pLink = GetSelEntry( &nPos );
 
-    if ( pLink != _pLink && _pLink && _pLink->WasLastEditOK() )
+    if ( /*pLink != _pLink &&*/ _pLink && _pLink->WasLastEditOK() )
     {
         // JP 09.01.98:
         // StarImpress/Draw tauschen die LinkObjecte selbst aus!
@@ -639,7 +642,7 @@ void SvBaseLinksDlg::InsertEntry( const SvBaseLink& rLink, USHORT nPos, sal_Bool
     nWidthPixel -= SV_TAB_BORDER;
     XubString aTxt = Links().GetEllipsisString( sFileNm, nWidthPixel, TEXT_DRAW_PATHELLIPSIS );
     INetURLObject aPath( sFileNm, INET_PROT_FILE );
-    String aFileName = aPath.getName();
+    String aFileName = aPath.getName( INetURLObject::LAST_SEGMENT, true, INetURLObject::DECODE_WITH_CHARSET, RTL_TEXTENCODING_UTF8);
     if( aFileName.Len() > aTxt.Len() )
         aTxt = aFileName;
     else if( aTxt.Search( aFileName, aTxt.Len() - aFileName.Len() ) == STRING_NOTFOUND )
@@ -648,7 +651,7 @@ void SvBaseLinksDlg::InsertEntry( const SvBaseLink& rLink, USHORT nPos, sal_Bool
 
     aEntry = aTxt;
     aEntry += '\t';
-    if( OBJECT_CLIENT_GRF == rLink.GetObjType() )
+    if( (OBJECT_CLIENT_GRF == rLink.GetObjType()) || (OBJECT_CLIENT_AVMEDIA == rLink.GetObjType()) )
         aEntry += sFilter;
     else
         aEntry += sLinkNm;
diff --git a/svx/source/sdr/contact/viewcontactofsdrmediaobj.cxx b/svx/source/sdr/contact/viewcontactofsdrmediaobj.cxx
index d0a7c74..0f421ad 100644
--- a/svx/source/sdr/contact/viewcontactofsdrmediaobj.cxx
+++ b/svx/source/sdr/contact/viewcontactofsdrmediaobj.cxx
@@ -54,7 +54,14 @@ ViewContactOfSdrMediaObj::~ViewContactOfSdrMediaObj()
 
 ViewObjectContact& ViewContactOfSdrMediaObj::CreateObjectSpecificViewObjectContact(ObjectContact& rObjectContact)
 {
-    return *( new ViewObjectContactOfSdrMediaObj( rObjectContact, *this, static_cast< SdrMediaObj& >( GetSdrObject() ).getMediaProperties() ) );
+    SdrMediaObj& rObj = static_cast< SdrMediaObj& >( GetSdrObject() );
+
+    ::avmedia::MediaItem aMediaItem( rObj.getMediaProperties() );
+
+    if( rObj.getMediaLink().is() && !rObj.getMediaLink()->isLinked() )
+        aMediaItem.setURL( rObj.getMediaLink()->getOrCreateTempFileURL() );
+
+    return *( new ViewObjectContactOfSdrMediaObj( rObjectContact, *this, aMediaItem ) );
 }
 
 // ------------------------------------------------------------------------------
@@ -117,6 +124,10 @@ void ViewContactOfSdrMediaObj::updateMediaItem( ::avmedia::MediaItem& rItem ) co
             static_cast< ViewObjectContactOfSdrMediaObj* >(pCandidate)->updateMediaItem(rItem);
         }
     }
+
+    SdrMediaObj& rObj = static_cast< SdrMediaObj& >( GetSdrObject() );
+    if( rObj.getMediaLink().is() && !rObj.getMediaLink()->isLinked() )
+        rItem.setURL( rObj.getMediaLink()->getOrCreateTempFileURL() );
 }
 
 // ------------------------------------------------------------------------------
@@ -125,13 +136,18 @@ void ViewContactOfSdrMediaObj::executeMediaItem( const ::avmedia::MediaItem& rIt
 {
     const sal_uInt32 nCount(getViewObjectContactCount());
 
+    ::avmedia::MediaItem aItem( rItem );
+    SdrMediaObj& rObj = static_cast< SdrMediaObj& >( GetSdrObject() );
+    if( rObj.getMediaLink().is() && !rObj.getMediaLink()->isLinked() )
+        aItem.setURL( rObj.getMediaLink()->getOrCreateTempFileURL() );
+
     for(sal_uInt32 a(0); a < nCount; a++)
     {
         ViewObjectContact* pCandidate = getViewObjectContact(a);
 
         if(pCandidate)
         {
-            static_cast< ViewObjectContactOfSdrMediaObj* >(pCandidate)->executeMediaItem(rItem);
+            static_cast< ViewObjectContactOfSdrMediaObj* >(pCandidate)->executeMediaItem(aItem);
         }
     }
 }
diff --git a/svx/source/sdr/media/makefile.mk b/svx/source/sdr/media/makefile.mk
new file mode 100644
index 0000000..5991627
--- /dev/null
+++ b/svx/source/sdr/media/makefile.mk
@@ -0,0 +1,48 @@
+#*************************************************************************
+#
+# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
+#
+# Copyright 2008 by Sun Microsystems, Inc.
+#
+# OpenOffice.org - a multi-platform office productivity suite
+#
+# $RCSfile: makefile.mk,v $
+#
+# $Revision: 1.6 $
+#
+# This file is part of OpenOffice.org.
+#
+# OpenOffice.org is free software: you can redistribute it and/or modify
+# it under the terms of the GNU Lesser General Public License version 3
+# only, as published by the Free Software Foundation.
+#
+# OpenOffice.org is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU Lesser General Public License version 3 for more details
+# (a copy is included in the LICENSE file that accompanied this code).
+#
+# You should have received a copy of the GNU Lesser General Public License
+# version 3 along with OpenOffice.org.  If not, see
+# <http://www.openoffice.org/license.html>
+# for a copy of the LGPLv3 License.
+#
+#*************************************************************************
+
+PRJ=..$/..$/..
+
+PRJNAME=svx
+TARGET=media
+ENABLE_EXCEPTIONS=TRUE
+
+# --- Settings -----------------------------------------------------
+
+.INCLUDE :  settings.mk
+.INCLUDE :  $(PRJ)$/util$/makefile.pmk
+
+# --- Files --------------------------------------------------------
+
+SLOFILES=\
+        $(SLO)$/mediamanager.obj
+
+.INCLUDE :  target.mk
diff --git a/svx/source/sdr/media/mediamanager.cxx b/svx/source/sdr/media/mediamanager.cxx
new file mode 100644
index 0000000..fcdf8d4
--- /dev/null
+++ b/svx/source/sdr/media/mediamanager.cxx
@@ -0,0 +1,445 @@
+/*************************************************************************
+ *
+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
+ *
+ * Copyright 2008 by Sun Microsystems, Inc.
+ *
+ * OpenOffice.org - a multi-platform office productivity suite
+ *
+ * $RCSfile: eventhandler.cxx,v $
+ * $Revision: 1.6 $
+ *
+ * This file is part of OpenOffice.org.
+ *
+ * OpenOffice.org is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Lesser General Public License version 3
+ * only, as published by the Free Software Foundation.
+ *
+ * OpenOffice.org is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Lesser General Public License version 3 for more details
+ * (a copy is included in the LICENSE file that accompanied this code).
+ *
+ * You should have received a copy of the GNU Lesser General Public License
+ * version 3 along with OpenOffice.org.  If not, see
+ * <http://www.openoffice.org/license.html>
+ * for a copy of the LGPLv3 License.
+ *
+ ************************************************************************/
+
+// MARKER(update_precomp.py): autogen include statement, do not remove
+#include "precompiled_svx.hxx"
+
+#include <com/sun/star/lang/XMultiServiceFactory.hpp>
+#include <com/sun/star/ucb/XSimpleFileAccess.hpp>
+#include <com/sun/star/beans/XPropertySet.hpp>
+#include <com/sun/star/io/XOutputStream.hpp>
+#include <com/sun/star/container/NoSuchElementException.hpp>
+#include <com/sun/star/beans/XPropertySet.hpp>
+#include <com/sun/star/embed/XTransactedObject.hpp>
+
+#include <comphelper/storagehelper.hxx>
+#include <comphelper/processfactory.hxx>
+
+#include <avmedia/mediawindow.hxx>
+#include <unotools/ucbstreamhelper.hxx>
+
+#include <tools/debug.hxx>
+#include <tools/string.hxx>
+#include <tools/tempfile.hxx>
+#include <tools/stream.hxx>
+
+#include <sfx2/objsh.hxx>
+#include <sfx2/event.hxx>
+#include <sfx2/sfx.hrc>
+
+#include <svx/sdr/media/mediamanager.hxx>
+
+#include <memory>
+
+using ::rtl::OUString;
+using namespace com::sun::star::uno;
+using namespace com::sun::star::ucb;
+using namespace com::sun::star::lang;
+using namespace com::sun::star::embed;
+using namespace com::sun::star::container;
+using namespace com::sun::star::io;
+using namespace com::sun::star::beans;
+
+namespace sdr { namespace media	{
+
+static bool KillFile( const OUString& aURL, const Reference< XMultiServiceFactory >& xFactory )
+{
+    if ( !xFactory.is() )
+        return sal_False;
+
+    sal_Bool bRet = sal_False;
+
+    try
+    {
+        Reference< XSimpleFileAccess > xAccess( xFactory->createInstance ( OUString::createFromAscii( "com.sun.star.ucb.SimpleFileAccess" ) ), UNO_QUERY );
+        if( xAccess.is() )
+        {
+            xAccess->kill( aURL );
+            bRet = sal_True;
+        }
+    }
+    catch( Exception& e )
+    {
+        (void)e;
+         OSL_TRACE( "sdr::media::KillFile caught exception: %s",
+            rtl::OUStringToOString(e.Message, RTL_TEXTENCODING_UTF8).getStr());
+    }
+
+    return bRet;
+}
+
+static OUString CreateTempFile( const OUString& aStreamURL, SvStream& rStream, const Reference< XMultiServiceFactory >& xFactory )
+{
+    OUString aTempURL;
+
+    const String aLeadingChars;
+    String aExtension;
+    sal_Int32 nIndex = aStreamURL.lastIndexOf( '.' );
+    if( nIndex != -1 )
+        aExtension = aStreamURL.copy( nIndex );
+
+    TempFile aTmpFile( aLeadingChars, &aExtension );
+    if( aTmpFile.IsValid() )
+    {
+        aTempURL = aTmpFile.GetName();
+
+        SvFileStream aTempFile( aTempURL, STREAM_WRITE|STREAM_TRUNC );
+
+        aTempFile << rStream;
+
+        if( aTempFile.GetError() != ERRCODE_NONE )
+        {
+            OSL_TRACE( "sdr::media::CreateTempFile error creating file: %ld", aTempFile.GetError() );
+            KillFile( aTempURL, xFactory );
+            aTempURL = OUString();
+        }
+    }
+
+    return aTempURL;
+}
+
+// ------------------------------------------------------------------------------------------------
+
+MediaLink::MediaLink( const rtl::Reference< MediaManager >& xManager, const OUString& rURL, bool bLinked )
+: mpManager( xManager.get() )
+, mbLinked( bLinked )
+, msURL( rURL )
+{
+    if( mpManager )
+        mpManager->acquire();
+
+    avmedia::FilterInfo aFilterInfo;
+    avmedia::MediaWindow::getMediaFilterForURL( rURL, aFilterInfo );
+    msMimeType = aFilterInfo.msMimeType;
+    msFilterName = aFilterInfo.msFilterName;
+}
+
+MediaLink::~MediaLink()
+{
+    if( !msTempFileURL.getLength() == 0 )
+    {
+        Reference< XMultiServiceFactory > xFactory( comphelper::getProcessServiceFactory() );
+        KillFile( msTempFileURL, xFactory );
+    }
+
+    if( mpManager )
+        mpManager->release();
+}
+
+rtl::OUString MediaLink::getOrCreateTempFileURL()
+{
+    if( mbLinked || !mpManager )
+        return msURL;
+
+    if( msTempFileURL.getLength() == 0 )
+    {
+        msTempFileURL = mpManager->createTemporaryCopy( msURL );
+    }
+
+    return msTempFileURL;
+}
+
+// ------------------------------------------------------------------------------------------------
+
+
+MediaManager::MediaManager( SfxObjectShell* pObjectShell )
+: mpObjectShell( pObjectShell )
+, msPackagePrefix( RTL_CONSTASCII_USTRINGPARAM( "vnd.sun.star.Package:" ) )
+, msMedia( RTL_CONSTASCII_USTRINGPARAM( "media" ))
+, msMediaType( RTL_CONSTASCII_USTRINGPARAM( "MediaType" ))
+, msStorageMediaType( RTL_CONSTASCII_USTRINGPARAM( "application/vnd.sun.star.media" ))
+{
+    StartListening(*mpObjectShell,TRUE);
+}
+
+MediaManager::~MediaManager()
+{
+}
+
+void MediaManager::Notify( SfxBroadcaster& rBC, const SfxHint& rHint )
+{
+    if (rHint.IsA(TYPE(SfxEventHint)))
+    {
+        switch (static_cast<const SfxEventHint&>(rHint).GetEventId())
+        {
+        case SFX_EVENT_STORAGECHANGED:
+            SwitchPersistance( mpObjectShell->GetStorage() );
+            break;
+        }
+    }
+
+    // todo: catch die and null mp
+}
+
+void MediaManager::Dispose()
+{
+    mxDocumentStorage.clear();
+    if( mpObjectShell )
+    {
+        EndListening(*mpObjectShell);
+        mpObjectShell = 0;
+    }
+}
+
+void MediaManager::SwitchPersistance(const ::com::sun::star::uno::Reference< ::com::sun::star::embed::XStorage >& xStorage )
+{
+    mxDocumentStorage = xStorage;
+    // todo: update/move existing media links?
+}
+
+const Reference< com::sun::star::embed::XStorage >& MediaManager::getDocumentStorage()
+{
+    if( !mxDocumentStorage.is() && mpObjectShell )
+    {
+        mxDocumentStorage = mpObjectShell->GetStorage();
+    }
+    return mxDocumentStorage;
+}
+
+
+Reference< XStorage > MediaManager::getMediaStorage()
+{
+    Reference< XStorage > xStorage( getDocumentStorage() );
+    if( xStorage.is() )
+    {
+        Reference< XNameAccess > xNameAccess( xStorage, UNO_QUERY_THROW );
+        bool bExisted = xNameAccess->hasByName( msMedia );
+
+        xStorage = xStorage->openStorageElement( msMedia, ElementModes::WRITE );
+
+        if( !bExisted )
+        {
+            Reference< XPropertySet > xSet( xStorage, UNO_QUERY_THROW );
+            xSet->setPropertyValue( msMediaType, Any( msStorageMediaType ) );
+        }
+    }
+    return xStorage;
+}
+
+static void undup( OUString& rFileName )
+{
+    OUString sRet;
+
+    // first find pos of extension
+    sal_Int32 nExtensionPos = rFileName.lastIndexOf( '.' );
+    if( nExtensionPos == -1 )
+        nExtensionPos = rFileName.getLength();
+
+    // now check if there is already an 'name(index).ext' scheme
+    sal_Int32 nEndIndexPos = rFileName.lastIndexOf( ')', nExtensionPos );
+
+    if( nEndIndexPos == (nExtensionPos - 1) )
+    {
+        sal_Int32 nBegIndexPos = rFileName.lastIndexOf( '(', nEndIndexPos );
+        if( nBegIndexPos != -1 )
+        {
+            // we found a (..)
+            OUString sIndex = rFileName.copy( nBegIndexPos+1, nEndIndexPos - nBegIndexPos - 1 );
+            sal_Int32 nIndex = sIndex.toInt32();
+            if( nIndex > 0 )
+            {
+                nIndex++;
+                sRet = rFileName.copy( 0, nBegIndexPos+1 );
+                sRet += OUString::valueOf( nIndex );
+                sRet += rFileName.copy( nEndIndexPos );
+                rFileName = sRet;
+                return;
+            }
+        }
+    }
+
+    sRet = rFileName.copy( 0, nExtensionPos );
+    sRet += OUString( RTL_CONSTASCII_USTRINGPARAM( "(1)" ) );
+    sRet += rFileName.copy( nExtensionPos );
+
+    rFileName = sRet;
+}
+
+MediaLinkRef MediaManager::insertMediaStream( const rtl::OUString& rURL )
+{
+    OUString sURL( rURL );
+    try
+    {
+        Reference< com::sun::star::embed::XStorage > xStorage( getMediaStorage(), UNO_QUERY_THROW );
+
+        OUString sStreamName;
+
+        sal_Int32 nPos = rURL.lastIndexOf( '/' );
+        if( nPos == -1 )
+        {
+            sStreamName = rURL;
+        }
+        else
+        {
+            sStreamName = rURL.copy( nPos + 1 );
+        }
+
+        Reference< XNameAccess > xNameAccess( xStorage, UNO_QUERY_THROW );
+
+        bool bNeedsRename = false;
+        bool bAlreadyExists = false;
+        do
+        {
+            if( xNameAccess->hasByName( sStreamName ) )
+            {
+                // todo sub element exists, if it is a stream check if it is identical
+/*				if( xStorage->isStreamElement( sStreamName ) )
+                {
+                }
+*/
+                undup( sStreamName );
+                bNeedsRename = true;
+            }
+            else
+            {
+                bNeedsRename = false;
+            }
+        }
+        while( bNeedsRename && !bAlreadyExists );
+
+        Reference< XStream > xTargetStream( xStorage->openStreamElement( sStreamName, ElementModes::WRITE|ElementModes::TRUNCATE ), UNO_QUERY_THROW );
+
+        // todo: get mime type
+        Reference< XPropertySet >( xTargetStream, UNO_QUERY_THROW )->setPropertyValue( msMediaType, Any( msStorageMediaType ) );
+        {
+            std::auto_ptr< SvStream > pDstStream( ::utl::UcbStreamHelper::CreateStream( xTargetStream ) );
+            const String sSourceURL( rURL );
+            std::auto_ptr< SvStream > pSrcStream( ::utl::UcbStreamHelper::CreateStream( sSourceURL, STREAM_READ ) );
+
+            if( pDstStream.get() && pSrcStream.get() )
+            {
+                *pDstStream << *pSrcStream;
+            }
+        }
+
+        Reference< XTransactedObject > xTransaction( xStorage, UNO_QUERY );
+        if( xTransaction.is() )
+            xTransaction->commit();
+
+        sURL = msPackagePrefix;
+        sURL += msMedia;
+        sURL += OUString::createFromAscii( "/" );
+        sURL += sStreamName;
+    }
+    catch( Exception& e )
+    {
+        (void)e;
+        DBG_ERROR(
+            rtl::OString("sdr::media::MediaManager::createTemporaryCopy(), exception caught: ") +
+            rtl::OUStringToOString( e.Message, RTL_TEXTENCODING_UTF8 ) );
+
+    }
+
+    return getMediaLink( sURL );
+}
+
+MediaLinkRef MediaManager::getMediaLink( const OUString& rURL )
+{
+    MediaLinkRef xRet;
+
+    MediaLinkMap::iterator iter( maMediaLinkMap.find( rURL ) );
+    if( iter != maMediaLinkMap.end() )
+    {
+        xRet = (*iter).second;
+    }
+    else
+    {
+        const bool bLinked = !rURL.matchIgnoreAsciiCase( msPackagePrefix );
+        rtl::Reference< MediaManager > xThis( this );
+        xRet = MediaLinkRef( new MediaLink( xThis, rURL, bLinked ) );
+        maMediaLinkMap[ rURL ] = xRet;
+    }
+    return xRet;
+}
+
+void MediaManager::freeMediaLink( const MediaLinkRef& xLink )
+{
+    (void)xLink;
+}
+
+OUString MediaManager::createTemporaryCopy( const OUString& rURL )
+{
+    OUString aTempURL;
+    if( getDocumentStorage().is() )
+    {
+
+        //TODO/MBA: binary format removed, needs testing
+        if( rURL.match( msPackagePrefix ) )
+        {
+            sal_Int32 nPos = rURL.lastIndexOf( '/' ) ;
+
+            if( nPos != 1 ) try
+            {
+                const String aMediaStreamName( rURL.copy( nPos+1 ) );
+                const String aMediaStorageName( rURL.copy( msPackagePrefix.getLength(), nPos - msPackagePrefix.getLength() ) );
+
+                if( getDocumentStorage()->isStorageElement( aMediaStorageName ) )
+                {
+                    Reference< XStorage > xPictureStorage( getDocumentStorage()->openStorageElement( aMediaStorageName, ElementModes::READ ) );
+                    try
+                    {
+                        if( xPictureStorage.is() && xPictureStorage->isStreamElement( aMediaStreamName ) )
+                        {
+                            Reference< XStream > xStream = xPictureStorage->openStreamElement( aMediaStreamName, ElementModes::READ );
+                            if( xStream.is() )
+                            {
+                                SvStream* pStream = ::utl::UcbStreamHelper::CreateStream( xStream );
+                                if( pStream )
+                                {
+                                    Reference< XMultiServiceFactory > xFactory( comphelper::getProcessServiceFactory() );
+                                    aTempURL = CreateTempFile( rURL, *pStream, xFactory );
+                                    delete pStream;
+                                }
+                            }
+                        }
+                    }
+                    catch( NoSuchElementException& )
+                    {
+                    }
+                }
+            }
+            catch( Exception& e )
+            {
+                (void)e;
+                DBG_ERROR(
+                    rtl::OString("sdr::media::MediaManager::createTemporaryCopy(), exception caught: ") +
+                    rtl::OUStringToOString( e.Message, RTL_TEXTENCODING_UTF8 ) );
+            }
+        }
+    }
+
+    return aTempURL;
+}
+
+} // end of namespace mixer
+} // end of namespace sdr
+
+//////////////////////////////////////////////////////////////////////////////
+// eof
diff --git a/svx/source/svdraw/svdmodel.cxx b/svx/source/svdraw/svdmodel.cxx
index 84edc0c..dadca84 100644
--- a/svx/source/svdraw/svdmodel.cxx
+++ b/svx/source/svdraw/svdmodel.cxx
@@ -38,6 +38,8 @@
 #include <tools/urlobj.hxx>
 #include <unotools/ucbstreamhelper.hxx>
 
+#include <svx/sdr/media/mediamanager.hxx>
+
 #include <tools/string.hxx>
 #include <svtools/whiter.hxx>
 #include <svx/xit.hxx>
@@ -104,6 +106,7 @@ struct SdrModelImpl
     SfxUndoManager*	mpUndoManager;
     SdrUndoFactory* mpUndoFactory;
     bool mbAllowShapePropertyChangeListener;
+    rtl::Reference< sdr::media::MediaManager > mxMediaManager;
 };
 
 ////////////////////////////////////////////////////////////////////////////////////////////////////
@@ -294,6 +297,12 @@ SdrModel::~SdrModel()
 
     DBG_DTOR(SdrModel,NULL);
 
+    if( mpImpl && mpImpl->mxMediaManager.is() )
+    {
+        mpImpl->mxMediaManager->Dispose();
+        mpImpl->mxMediaManager.clear();
+    }
+
     mbInDestruction = true;
 
     Broadcast(SdrHint(HINT_MODELCLEARED));
@@ -2159,6 +2168,27 @@ const ::com::sun::star::uno::Sequence< sal_Int8 >& SdrModel::getUnoTunnelImpleme
     return *pSeq;
 }
 
+
+void SdrModel::SetMediaManager( const rtl::Reference< sdr::media::MediaManager >& xManager )
+{
+    if( mpImpl )
+    {
+        mpImpl->mxMediaManager = xManager;
+    }
+}
+
+rtl::Reference< sdr::media::MediaManager > SdrModel::GetMediaManager()
+{
+    if( mpImpl )
+    {
+        return mpImpl->mxMediaManager;
+    }
+    else
+    {
+        return rtl::Reference< sdr::media::MediaManager >();
+    }
+}
+
 ////////////////////////////////////////////////////////////////////////////////////////////////////
 
 TYPEINIT1(SdrHint,SfxHint);
diff --git a/svx/source/svdraw/svdomedia.cxx b/svx/source/svdraw/svdomedia.cxx
index 7a5cbc7..a25fc2d 100644
--- a/svx/source/svdraw/svdomedia.cxx
+++ b/svx/source/svdraw/svdomedia.cxx
@@ -28,11 +28,81 @@
 // MARKER(update_precomp.py): autogen include statement, do not remove
 #include "precompiled_svx.hxx"
 
-#include <svx/svdomedia.hxx>
+#include <sfx2/lnkbase.hxx>
+
+#include <avmedia/mediawindow.hxx>
+
+#include <sot/formats.hxx>
+
+#include "svx/sdr/contact/viewcontactofsdrmediaobj.hxx"
+#include "svx/sdr/media/mediamanager.hxx"
+#include "svx/svdmodel.hxx"
+#include "svx/svdomedia.hxx"
+#include "linkmgr.hxx"
+
 #include "svdglob.hxx"
 #include "svdstr.hrc"
-#include <svx/sdr/contact/viewcontactofsdrmediaobj.hxx>
-#include <avmedia/mediawindow.hxx>
+
+using ::rtl::OUString;
+
+// ----------------
+// - SdrMediaLink -
+// ----------------
+
+class SdrMediaLink : public sfx2::SvBaseLink
+{
+public:
+                        SdrMediaLink(SdrMediaObj* pObj, ULONG nContentType);
+    virtual				~SdrMediaLink();
+
+    virtual void		Closed();
+    virtual void		DataChanged( const String& rMimeType, const ::com::sun::star::uno::Any & rValue );
+
+    bool				Connect() { return 0 != GetRealObject(); }
+
+private:
+    SdrObjectWeakRef mxMediaObj;
+};
+
+SdrMediaLink::SdrMediaLink(SdrMediaObj* pObj, ULONG nContentType)
+: ::sfx2::SvBaseLink( ::sfx2::LINKUPDATE_ONCALL, nContentType )
+, mxMediaObj(pObj)
+{
+    SetSynchron( FALSE );
+}
+
+SdrMediaLink::~SdrMediaLink()
+{
+}
+
+void SdrMediaLink::Closed()
+{
+    if( mxMediaObj.is() )
+    {
+        SdrMediaObj* pMediaObj = static_cast< SdrMediaObj* >( mxMediaObj.get() );
+        pMediaObj->mpSdrMediaLink = 0;
+        pMediaObj->breakLink();
+    }
+    SvBaseLink::Closed();
+}
+
+void SdrMediaLink::DataChanged( const String& /*rMimeType*/, const ::com::sun::star::uno::Any & rValue )
+{
+    if( mxMediaObj.is() )
+    {
+        OUString sNewURL;
+        if( rValue >>= sNewURL )
+        {
+            SdrMediaObj* pMediaObj = static_cast< SdrMediaObj* >( mxMediaObj.get() );
+            if( pMediaObj->getURL() != sNewURL )
+                pMediaObj->UpdateURL( sNewURL );
+        }
+        else
+        {
+            DBG_ERROR("SdrMediaLink::DataChanged(), unknown value type!");
+        }
+    }
+}
 
 // ---------------
 // - SdrMediaObj -
@@ -43,13 +113,15 @@ TYPEINIT1( SdrMediaObj, SdrRectObj );
 // ------------------------------------------------------------------------------
 
 SdrMediaObj::SdrMediaObj()
+: mpSdrMediaLink( 0 )
 {
 }
 
 // ------------------------------------------------------------------------------
 
-SdrMediaObj::SdrMediaObj( const Rectangle& rRect ) :
-    SdrRectObj( rRect )
+SdrMediaObj::SdrMediaObj( const Rectangle& rRect )
+: SdrRectObj( rRect )
+, mpSdrMediaLink( 0 )
 {
 }
 
@@ -57,6 +129,7 @@ SdrMediaObj::SdrMediaObj( const Rectangle& rRect ) :
 
 SdrMediaObj::~SdrMediaObj()
 {
+    disconnect();
 }
 
 // ------------------------------------------------------------------------------
@@ -147,6 +220,21 @@ void SdrMediaObj::operator=(const SdrObject& rObj)
 
 // ------------------------------------------------------------------------------
 
+void SdrMediaObj::setMediaLink( const ::rtl::Reference< sdr::media::MediaLink >& xMediaLink )
+{
+    setGraphic();
+    disconnect();
+    mxMediaLink = xMediaLink;
+    rtl::OUString sURL;
+    if( mxMediaLink.is() )
+        sURL = mxMediaLink->getMediaURL();
+    maMediaProperties.setURL( sURL );
+    connect();
+    static_cast< ::sdr::contact::ViewContactOfSdrMediaObj& >( GetViewContact() ).executeMediaItem( getMediaProperties() );
+}
+
+// ------------------------------------------------------------------------------
+
 void SdrMediaObj::setURL( const ::rtl::OUString& rURL )
 {
     ::avmedia::MediaItem aURLItem;
@@ -156,6 +244,26 @@ void SdrMediaObj::setURL( const ::rtl::OUString& rURL )
 }
 
 // ------------------------------------------------------------------------------
+
+void SdrMediaObj::UpdateURL( const ::rtl::OUString& rURL )
+{
+    setGraphic();
+    maMediaProperties.setURL( rURL );
+
+    ::rtl::Reference< sdr::media::MediaManager > xMediaManager( GetModel()->GetMediaManager() );
+    if( xMediaManager.is() )
+    {
+        mxMediaLink = xMediaManager->getMediaLink( rURL );
+    }
+    else
+    {
+        mxMediaLink.set( new sdr::media::MediaLink( xMediaManager, rURL, !rURL.matchAsciiL( RTL_CONSTASCII_STRINGPARAM( "vnd.sun.star.Package:"  ) ) ) );
+    }
+    static_cast< ::sdr::contact::ViewContactOfSdrMediaObj& >( GetViewContact() ).executeMediaItem( getMediaProperties() );
+    ActionChanged();
+}
+
+// ------------------------------------------------------------------------------
     
 const ::rtl::OUString& SdrMediaObj::getURL() const
 {
@@ -167,6 +275,28 @@ const ::rtl::OUString& SdrMediaObj::getURL() const
 void SdrMediaObj::setMediaProperties( const ::avmedia::MediaItem& rState )
 {
     mediaPropertiesChanged( rState );
+
+    // use only a subset of MediaItem properties for own own properties
+    if( ( AVMEDIA_SETMASK_URL & rState.getMaskSet() ) && ( rState.getURL() != getURL() ) )
+    {
+        setGraphic();
+        disconnect();
+
+        const OUString sURL( rState.getURL() );
+        maMediaProperties.setURL( sURL );
+
+        ::rtl::Reference< sdr::media::MediaManager > xMediaManager( GetModel()->GetMediaManager() );
+        if( xMediaManager.is() )
+        {
+            mxMediaLink = xMediaManager->getMediaLink( sURL );
+        }
+        else
+        {
+            mxMediaLink.set( new sdr::media::MediaLink( xMediaManager, sURL, !sURL.matchAsciiL( RTL_CONSTASCII_STRINGPARAM( "vnd.sun.star.Package:"  ) ) ) );
+        }
+        connect();
+    }
+
     static_cast< ::sdr::contact::ViewContactOfSdrMediaObj& >( GetViewContact() ).executeMediaItem( getMediaProperties() );
 }
         
@@ -213,15 +343,25 @@ void SdrMediaObj::setGraphic( const Graphic* pGraphic )
 void SdrMediaObj::mediaPropertiesChanged( const ::avmedia::MediaItem& rNewProperties )
 {
     const sal_uInt32 nMaskSet = rNewProperties.getMaskSet();
-
+/*
     // use only a subset of MediaItem properties for own own properties
     if( ( AVMEDIA_SETMASK_URL & nMaskSet ) && 
         ( rNewProperties.getURL() != getURL() ) )
     {
         setGraphic();
         maMediaProperties.setURL( rNewProperties.getURL() );
+
+        ::rtl::Reference< sdr::media::MediaManager > mxMediaManager( GetModel()->GetMediaManager() );
+        if( mxMediaManager.is() )
+        {
+            mxMediaLink = mxMediaManager->getMediaLink( rNewProperties.getURL() );
+        }
+        else
+        {
+            mxMediaLink.clear();
+        }
     }
-    
+*/
     if( AVMEDIA_SETMASK_LOOP & nMaskSet )
         maMediaProperties.setLoop( rNewProperties.isLoop() );
     
@@ -234,3 +374,106 @@ void SdrMediaObj::mediaPropertiesChanged( const ::avmedia::MediaItem& rNewProper
     if( AVMEDIA_SETMASK_ZOOM & nMaskSet )
         maMediaProperties.setZoom( rNewProperties.getZoom() );
 }
+
+// -----------------------------------------------------------------------------
+
+void SdrMediaObj::SetPage( SdrPage* pNewPage )
+{
+    const bool bRemove = pNewPage == NULL && pPage != NULL;
+    const bool bInsert = pNewPage != NULL && pPage == NULL;
+
+    if( bRemove )
+        disconnect();
+    SdrRectObj::SetPage( pNewPage );
+    if( bInsert )
+        connect();
+}
+
+// -----------------------------------------------------------------------------
+
+void SdrMediaObj::SetModel( SdrModel* pNewModel )
+{
+    bool bChange = pNewModel != pModel;
+
+    if( bChange )
+        disconnect();
+
+    // Model umsetzen
+    SdrRectObj::SetModel(pNewModel);
+
+    if( bChange )
+        connect();
+}
+
+// -----------------------------------------------------------------------------
+
+// embeds the av link
+void SdrMediaObj::breakLink()
+{
+    if( !mxMediaLink.is() || !mxMediaLink->isLinked() )
+        return;
+
+    const OUString sURL( mxMediaLink->getMediaURL() );
+
+    sdr::media::MediaLinkRef xNewLink;
+
+    rtl::Reference< sdr::media::MediaManager > xMediaManager( mxMediaLink->getMediaManager() );
+    if( xMediaManager.is() )
+    {
+        xNewLink = xMediaManager->insertMediaStream( sURL );
+    }
+    else
+    {
+        // not yet connected to model, just remember link for now
+        xNewLink.set( new sdr::media::MediaLink( xMediaManager, sURL, false ) );
+    }
+
+    setMediaLink( xNewLink );
+}
+
+// -----------------------------------------------------------------------------
+
+void SdrMediaObj::connect()
+{
+    SvxLinkManager* pLinkManager = pModel != NULL ? pModel->GetLinkManager() : NULL;
+    if( pLinkManager )
+    {
+        if( mxMediaLink.is() && mxMediaLink->isLinked() && (mpSdrMediaLink == NULL) )
+        {
+            const String sFileName( mxMediaLink->getMediaURL() );
+            const String sFilterName( mxMediaLink->getFilterName() );
+            const String sMimeType( mxMediaLink->getMimeType() );
+            const ULONG nContentType = (sMimeType.Len() == 0) ?  SOT_FORMATSTR_ID_AVMEDIA : SotExchange::RegisterFormatMimeType( sMimeType );
+            mpSdrMediaLink = new SdrMediaLink( this, nContentType );
+            pLinkManager->InsertFileLink( *mpSdrMediaLink, OBJECT_CLIENT_AVMEDIA, sFileName, &sFilterName, NULL );
+            mpSdrMediaLink->Connect();
+        }
+    }
+/*
+    if( mxGraphicLink.is() )
+        {
+            mxGraphicLink->connect( pLinkManager );
+        }
+        else if( getURL().getLength() != 0 )
+        {
+            mxGraphicLink = new
+        }
+    }
+*/
+}
+
+void SdrMediaObj::disconnect()
+{
+    SvxLinkManager* pLinkManager = pModel != NULL ? pModel->GetLinkManager() : NULL;
+
+    if( pLinkManager != NULL && mpSdrMediaLink!=NULL)
+    {
+        // Bei Remove wird *pGraphicLink implizit deleted
+        pLinkManager->Remove( mpSdrMediaLink );
+        mpSdrMediaLink=NULL;
+    }
+/*
+    if( mxGraphicLink.is() )
+        mxGraphicLink->disconnect();
+*/
+}
diff --git a/svx/source/svxlink/fileobj.cxx b/svx/source/svxlink/fileobj.cxx
index 9bf3a81..9e579ee 100644
--- a/svx/source/svxlink/fileobj.cxx
+++ b/svx/source/svxlink/fileobj.cxx
@@ -27,6 +27,8 @@
 
 // MARKER(update_precomp.py): autogen include statement, do not remove
 #include "precompiled_svx.hxx"
+
+#include <avmedia/mediawindow.hxx>
 #include <vcl/wrkwin.hxx>
 #include <vcl/msgbox.hxx>
 #include <tools/urlobj.hxx>
@@ -265,6 +267,10 @@ BOOL SvFileObject::Connect( sfx2::SvBaseLink* pLink )
         nType = FILETYPE_TEXT;
         break;
 
+    case OBJECT_CLIENT_AVMEDIA:
+        nType = FILETYPE_OBJECT;
+        break;
+
     case OBJECT_CLIENT_OLE:
         nType = FILETYPE_OBJECT;
         // TODO/LATER: introduce own type to be used for exchanging
@@ -489,6 +495,23 @@ void SvFileObject::Edit( Window* pParent, sfx2::SvBaseLink* pLink, const Link& r
             }
             break;
 
+            case OBJECT_CLIENT_AVMEDIA:
+            {
+                nType = FILETYPE_OBJECT;
+
+                rtl::OUString aFileURL = sFile;
+                if( avmedia::MediaWindow::executeOpenMediaURLDialog( pParent, aFileURL ) )
+                {
+                    sFile = aFileURL;
+                    sFile += ::sfx2::cTokenSeperator;
+                    sFile += ::sfx2::cTokenSeperator;
+
+                    if( aEndEditLink.IsSet() )
+                        aEndEditLink.Call( &sFile );
+                }
+            }
+            break;
+
             case OBJECT_CLIENT_OLE:
             {
                 nType = FILETYPE_OBJECT; // if not set already
diff --git a/svx/source/svxlink/linkmgr.cxx b/svx/source/svxlink/linkmgr.cxx
index 3986acf..62a3961 100644
--- a/svx/source/svxlink/linkmgr.cxx
+++ b/svx/source/svxlink/linkmgr.cxx
@@ -77,6 +77,7 @@ sfx2::SvLinkSourceRef SvxLinkManager::CreateObj( sfx2::SvBaseLink * pLink )
     case OBJECT_CLIENT_FILE:
     case OBJECT_CLIENT_GRF:
     case OBJECT_CLIENT_OLE:
+    case OBJECT_CLIENT_AVMEDIA:
         return new SvFileObject;
 
     case OBJECT_INTERN:
@@ -129,6 +130,7 @@ BOOL SvxLinkManager::GetDisplayNames( const sfx2::SvBaseLink* pBaseLink,
         case OBJECT_CLIENT_FILE:
         case OBJECT_CLIENT_GRF:
         case OBJECT_CLIENT_OLE:
+        case OBJECT_CLIENT_AVMEDIA:
             {
                 USHORT nPos = 0;
                 String sFile( sLNm.GetToken( 0, ::sfx2::cTokenSeperator, nPos ) );
@@ -143,12 +145,15 @@ BOOL SvxLinkManager::GetDisplayNames( const sfx2::SvBaseLink* pBaseLink,
 
                 if( pType )
                 {
-                    sal_uInt16 nObjType = pBaseLink->GetObjType();
-                    *pType = String( ResId(
-                                ( OBJECT_CLIENT_FILE == nObjType || OBJECT_CLIENT_OLE == nObjType )
-                                        ? RID_SVXSTR_FILELINK
-                                        : RID_SVXSTR_GRAFIKLINK
-                                        , DIALOG_MGR() ));
+                    USHORT nId;
+                    switch( pBaseLink->GetObjType() )
+                    {
+                    case OBJECT_CLIENT_GRF:	nId = RID_SVXSTR_GRAFIKLINK; break;
+                    case OBJECT_CLIENT_AVMEDIA: nId = RID_SVXSTR_AVMEDIALINK; break;
+                    default: nId = RID_SVXSTR_FILELINK;
+                    }
+
+                    *pType = String( ResId(nId, DIALOG_MGR() ) );
                 }
                 bRet = TRUE;
             }
diff --git a/svx/source/svxlink/linkmgr.src b/svx/source/svxlink/linkmgr.src
index 98388c0..6937674 100644
--- a/svx/source/svxlink/linkmgr.src
+++ b/svx/source/svxlink/linkmgr.src
@@ -34,6 +34,11 @@ String RID_SVXSTR_GRAFIKLINK
 {
     Text [ en-US ] = "Graphic" ;
 };
+String RID_SVXSTR_AVMEDIALINK
+{
+    Text [ en-US ]= "Audio/Video";
+};
+
 String RID_SVXSTR_EDITGRFLINK
 {
     /* ### ACHTUNG: Neuer Text in Resource? Grafik Verknüpfen : Grafik Verkn³pfen */
diff --git a/svx/util/makefile.mk b/svx/util/makefile.mk
index ab964d3..b31a1f1 100644
--- a/svx/util/makefile.mk
+++ b/svx/util/makefile.mk
@@ -114,7 +114,8 @@ LIB6FILES=\
     $(SLB)$/unodraw-core.lib \
     $(SLB)$/unoedit-core.lib   \
     $(SLB)$/xml.lib \
-    $(SLB)$/xout.lib
+    $(SLB)$/xout.lib \
+    $(SLB)$/media.lib
 
 # Objects needed for the svxmsfilter library.
 LIB7TARGET= $(SLB)$/$(TARGET)_7.lib
diff --git a/sw/source/ui/shells/grfshex.cxx b/sw/source/ui/shells/grfshex.cxx
index dfd904a..63131f4 100644
--- a/sw/source/ui/shells/grfshex.cxx
+++ b/sw/source/ui/shells/grfshex.cxx
@@ -96,6 +96,7 @@ using ::rtl::OUString;
 bool SwTextShell::InsertMediaDlg( SfxRequest& rReq )
 {
     ::rtl::OUString 	aURL;
+    sal_Bool            bLinked = sal_True;
     const SfxItemSet*	pReqArgs = rReq.GetArgs();
     Window*				pWindow = &GetView().GetViewFrame()->GetWindow();
     bool				bAPI = false, bRet = false;
@@ -109,9 +110,15 @@ bool SwTextShell::InsertMediaDlg( SfxRequest& rReq )
             aURL = pStringItem->GetValue();
             bAPI = aURL.getLength();
         }
+
+        const SfxBoolItem* pBoolItem = dynamic_cast< const SfxBoolItem* >( &pReqArgs->Get( FN_PARAM_1 ) );
+        if( pBoolItem )
+        {
+            bLinked = pBoolItem->GetValue() ? sal_True : sal_False;
+        }
     }
 
-    if( bAPI || ::avmedia::MediaWindow::executeMediaURLDialog( pWindow, aURL ) )
+    if( bAPI || ::avmedia::MediaWindow::executeInsertMediaURLDialog( pWindow, aURL, bLinked ) )
     {
         Size aPrefSize;
 
@@ -159,6 +166,9 @@ bool SwTextShell::InsertMediaDlg( SfxRequest& rReq )
             pObj->setURL( aURL );
             rSh.EnterStdMode();
             rSh.SwFEShell::Insert( *pObj, 0, 0, &aPos );
+
+            if( !bLinked )
+                pObj->breakLink();
             bRet = true;
 
             if( pWindow )
diff --git a/unotools/source/ucbhelper/XTempFile.hxx b/unotools/source/ucbhelper/XTempFile.hxx
index 3e7f183..b121137 100644
--- a/unotools/source/ucbhelper/XTempFile.hxx
+++ b/unotools/source/ucbhelper/XTempFile.hxx
@@ -36,7 +36,8 @@
 #include <com/sun/star/lang/XSingleComponentFactory.hpp>
 #include <com/sun/star/lang/XMultiServiceFactory.hpp>
 #include <com/sun/star/lang/XServiceInfo.hpp>
-#include <cppuhelper/implbase5.hxx>
+#include <com/sun/star/lang/XInitialization.hpp>
+#include <cppuhelper/implbase6.hxx>
 #ifndef _CPPUHELPER_PROPERTYSETMIXIN_HXX_
 #include <cppuhelper/propertysetmixin.hxx>
 #endif
@@ -45,11 +46,12 @@
 class SvStream;
 namespace utl { class TempFile; }
 
-typedef	 ::cppu::WeakImplHelper5<	::com::sun::star::io::XTempFile
+typedef	 ::cppu::WeakImplHelper6<	::com::sun::star::io::XTempFile
                                     ,	::com::sun::star::io::XInputStream
                                                   ,	::com::sun::star::io::XOutputStream
                                                   ,	::com::sun::star::io::XTruncate
                                                   ,	::com::sun::star::lang::XServiceInfo
+                                                ,	::com::sun::star::lang::XInitialization
                                                   >
                                     OTempFileBase;
 
@@ -82,6 +84,10 @@ public:
         throw ();
     virtual void SAL_CALL release(  )
         throw ();
+
+    // XInitialization
+    virtual void SAL_CALL initialize( const ::com::sun::star::uno::Sequence< ::com::sun::star::uno::Any >& aArguments ) throw (::com::sun::star::uno::Exception, ::com::sun::star::uno::RuntimeException);
+
     //	XTypeProvider
     virtual ::com::sun::star::uno::Sequence< ::com::sun::star::uno::Type > SAL_CALL getTypes(  )
         throw (::com::sun::star::uno::RuntimeException);
diff --git a/unotools/source/ucbhelper/xtempfile.cxx b/unotools/source/ucbhelper/xtempfile.cxx
index d018e02..9ae65c9 100644
--- a/unotools/source/ucbhelper/xtempfile.cxx
+++ b/unotools/source/ucbhelper/xtempfile.cxx
@@ -28,12 +28,9 @@
 #include <XTempFile.hxx>
 #include <cppuhelper/factory.hxx>
 #include <cppuhelper/typeprovider.hxx>
-#ifndef _COM_SUN_STAR_REGISTRY_XREGISTRYKEY_HPP
 #include <com/sun/star/registry/XRegistryKey.hpp>
-#endif
-#ifndef _COM_SUN_STAR_BEANS_PROPERTYATTRIBUTE_HPP
 #include <com/sun/star/beans/PropertyAttribute.hpp>
-#endif
+#include <com/sun/star/beans/NamedValue.hpp>
 #include <unotools/tempfile.hxx>
 #include <osl/file.hxx>
 #include <unotools/configmgr.hxx>
@@ -91,6 +88,74 @@ throw ()
     OTempFileBase::release();
 }
 
+// XInitialization
+void SAL_CALL OTempFileService::initialize( const ::css::uno::Sequence< ::css::uno::Any >& aArguments ) throw (::css::uno::Exception, ::css::uno::RuntimeException)
+{
+    String aLeadingChars;
+    String aExtension;
+    String aParent;
+
+    sal_Bool bKillingFileEnabled = mpTempFile ? mpTempFile->IsKillingFileEnabled() : sal_False;
+    rtl::OUString sTmp;
+    bool recreate = false;
+
+    String* pExtension=NULL;
+    String* pParent=NULL;
+
+    sal_Int32 nIndex = aArguments.getLength();
+    while( nIndex )
+    {
+        ::css::beans::NamedValue aValue;
+        if( aArguments[--nIndex] >>= aValue )
+        {
+            if( aValue.Name.equalsAsciiL( RTL_CONSTASCII_STRINGPARAM( "LeadingChars" ) ) )
+            {
+                if( !(aValue.Value >>= sTmp) )
+                    throw ::css::lang::IllegalArgumentException();
+
+                aLeadingChars = sTmp;
+                recreate = true;
+            }
+            else if( aValue.Name.equalsAsciiL( RTL_CONSTASCII_STRINGPARAM( "Extension" ) ) )
+            {
+                if( !(aValue.Value >>= sTmp) )
+                    throw ::css::lang::IllegalArgumentException();
+
+                aExtension = sTmp;
+                pExtension = &aExtension;
+                recreate = true;
+            }
+            else if( aValue.Name.equalsAsciiL( RTL_CONSTASCII_STRINGPARAM( "Parent" ) ) )
+            {
+                if( !(aValue.Value >>= sTmp) )
+                    throw ::css::lang::IllegalArgumentException();
+
+                aParent = sTmp;
+                pParent = &aParent;
+                recreate = true;
+            }
+            else if( aValue.Name.equalsAsciiL( RTL_CONSTASCII_STRINGPARAM( "KillingFileEnabled" ) ) )
+            {
+                if( !(aValue.Value >>= bKillingFileEnabled) )
+                    throw ::css::lang::IllegalArgumentException();
+            }
+        }
+    }
+
+    if( recreate )
+    {
+        if( mpTempFile )
+        {
+            mpTempFile->EnableKillingFile();
+            delete mpTempFile;
+        }
+        mpTempFile = new utl::TempFile( aLeadingChars, pExtension, pParent, /* no directory */ sal_False );
+    }
+
+    if( mpTempFile && (mpTempFile->IsKillingFileEnabled() != bKillingFileEnabled) )
+        mpTempFile->EnableKillingFile(bKillingFileEnabled);
+}
+
 //	XTypeProvider
 
 ::css::uno::Sequence< ::css::uno::Type > SAL_CALL OTempFileService::getTypes(  )
diff --git a/xmloff/source/draw/ximpshap.cxx b/xmloff/source/draw/ximpshap.cxx
index 745b8b4..9566a64 100644
--- a/xmloff/source/draw/ximpshap.cxx
+++ b/xmloff/source/draw/ximpshap.cxx
@@ -2942,7 +2942,7 @@ void SdXMLPluginShapeContext::processAttribute( sal_uInt16 nPrefix, const ::rtl:
     case XML_NAMESPACE_XLINK:
         if( IsXMLToken( rLocalName, XML_HREF ) )
         {
-            maHref = GetImport().GetAbsoluteReference(rValue);
+            maHref = rValue;
             return;
         }
         break;
@@ -2989,14 +2989,29 @@ void SdXMLPluginShapeContext::EndElement()
 
             if( maHref.getLength() )
             {
-                aAny <<= maHref;
+                aAny <<= GetImport().GetAbsoluteReference(maHref);
                 xProps->setPropertyValue( OUString( RTL_CONSTASCII_USTRINGPARAM( "PluginURL" ) ), aAny );
             }
         }
         else
         {
             // in case we have a media object
-            xProps->setPropertyValue( OUString( RTL_CONSTASCII_USTRINGPARAM( "MediaURL" ) ), uno::makeAny( maHref ) );
+
+            OUString sTempRef;
+
+            // check for package URL
+            if( GetImport().IsPackageURL( maHref ) )
+            {
+                sTempRef = OUString( RTL_CONSTASCII_USTRINGPARAM( "vnd.sun.star.Package:" ) );
+            }
+            else
+            {
+                maHref = GetImport().GetAbsoluteReference(maHref);
+            }
+
+            sTempRef += maHref;
+
+            xProps->setPropertyValue( OUString( RTL_CONSTASCII_USTRINGPARAM( "MediaURL" ) ), uno::makeAny( sTempRef ) );
 
             for( sal_Int32 nParam = 0; nParam < maParams.getLength(); ++nParam )
             {
-- 
1.7.0.1

