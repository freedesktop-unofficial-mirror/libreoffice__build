From 8cf4e4131d3ec2f79dd2cdc68ff27db08e838fb4 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:05:51 +0200
Subject: [PATCH 691/878] xlsx-filter-as-a-separate-lib.diff

---
 sc/prj/build.lst                         |    3 +-
 sc/prj/d.lst                             |    1 +
 sc/source/filter/excel/excel.cxx         |   19 +-----
 sc/source/filter/ftools/filterplugin.cxx |   14 ++++
 sc/source/filter/ftools/ftools.cxx       |   13 ---
 sc/source/filter/ftools/makefile.mk      |    1 +
 sc/source/filter/xlsx/makefile.mk        |  124 ++++++++++++++++++++++++++++++
 sc/util/makefile.mk                      |   46 +++++++++++
 sc/util/xlsx.map                         |    9 ++
 9 files changed, 198 insertions(+), 32 deletions(-)
 create mode 100644 sc/source/filter/ftools/filterplugin.cxx
 create mode 100644 sc/source/filter/xlsx/makefile.mk
 create mode 100644 sc/util/xlsx.map

diff --git a/sc/prj/build.lst b/sc/prj/build.lst
index b6cb724..e7da6af 100644
--- a/sc/prj/build.lst
+++ b/sc/prj/build.lst
@@ -35,6 +35,7 @@ sc	sc\source\ui\unoobj					nmake	-	all	sc_unobj sc_sdi sc_inc NULL
 sc	sc\source\ui\vba					nmake	-	all	sc_vba sc_sdi sc_inc NULL
 sc	sc\source\ui\view					nmake	-	all	sc_view sc_sdi sc_inc NULL
 sc	sc\source\filter\excel					nmake	-	all	sc_excel sc_sdi sc_inc NULL
+sc	sc\source\filter\xlsx					nmake	-	all	sc_xlsx sc_sdi sc_inc NULL
 sc	sc\source\filter\ftools					nmake	-	all	sc_ftools sc_sdi sc_inc NULL
 sc	sc\source\filter\lotus					nmake	-	all	sc_lotus sc_sdi sc_inc NULL
 sc	sc\source\filter\qpro					nmake	-	all	sc_qpro sc_sdi sc_inc NULL
@@ -48,4 +49,4 @@ sc	sc\addin						nmake	-	all	sc_add sc_sdi sc_inc NULL
 sc	sc\addin\datefunc					nmake	-	all	sc_addfu sc_add sc_sdi sc_inc NULL
 sc	sc\addin\rot13						nmake	-	all	sc_adrot sc_add sc_sdi sc_inc NULL
 sc	sc\addin\util						nmake	-	all	sc_adutil sc_addfu sc_adrot sc_sdi sc_inc NULL
-sc	sc\util							nmake	-	all	sc_util sc_addfu sc_adrot sc_adutil sc_app sc_attr sc_cctrl sc_cosrc sc_data sc_dbgui sc_dif sc_docsh sc_drfnc sc_excel sc_form sc_html sc_lotus sc_qpro sc_misc sc_name sc_nvipi sc_opt sc_page sc_rtf sc_scalc sc_style sc_tool sc_uisrc sc_undo sc_unobj sc_view sc_xcl97 sc_xml sc_acc sc_ftools sc_inc sc_vba NULL
+sc	sc\util							nmake	-	all	sc_util sc_addfu sc_adrot sc_adutil sc_app sc_attr sc_cctrl sc_cosrc sc_data sc_dbgui sc_dif sc_docsh sc_drfnc sc_excel sc_xlsx sc_form sc_html sc_lotus sc_qpro sc_misc sc_name sc_nvipi sc_opt sc_page sc_rtf sc_scalc sc_style sc_tool sc_uisrc sc_undo sc_unobj sc_view sc_xcl97 sc_xml sc_acc sc_ftools sc_inc sc_vba NULL
diff --git a/sc/prj/d.lst b/sc/prj/d.lst
index b1e0dfd..056cd07 100644
--- a/sc/prj/d.lst
+++ b/sc/prj/d.lst
@@ -22,6 +22,7 @@ mkdir: %_DEST%\xml%_EXT%\uiconfig\modules\scalc\statusbar
 ..\%__SRC%\bin\scui?????.dll %_DEST%\bin%_EXT%\scui?????.dll
 ..\%__SRC%\bin\dfa?????.dll %_DEST%\bin%_EXT%\dfa?????.dll
 ..\%__SRC%\bin\rot?????.dll %_DEST%\bin%_EXT%\rot?????.dll
+..\%__SRC%\bin\xlsx*.dll %_DEST%\bin%_EXT%\xlsx*.dll
 ..\%__SRC%\bin\vba*.* %_DEST%\bin%_EXT%\vba*.*
 ..\%__SRC%\bin\addin.zip %_DEST%\bin%_EXT%\addin.zip
 ..\%__SRC%\misc\*.map %_DEST%\bin%_EXT%\*.map
diff --git a/sc/source/filter/excel/excel.cxx b/sc/source/filter/excel/excel.cxx
index 83a4df9..6ec6f75 100644
--- a/sc/source/filter/excel/excel.cxx
+++ b/sc/source/filter/excel/excel.cxx
@@ -261,25 +261,10 @@ static FltError lcl_ExportExcelBiff( SfxMedium& rMedium, ScDocument *pDocument,
     return eRet;
 }
 
-static FltError lcl_ExportExcel2007Xml( SfxMedium& rMedium, ScDocument *pDocument,
-        SvStream* pMedStrm, CharSet eNach )
-{
-    SotStorageRef xRootStrg = (SotStorage*) 0;
-
-    XclExpRootData aExpData( EXC_BIFF8, rMedium, xRootStrg, *pDocument, eNach );
-    aExpData.meOutput = EXC_OUTPUT_XML_2007;
-
-    ExportXml2007 aFilter( aExpData, *pMedStrm );
-
-    FltError eRet = aFilter.Write();
-
-    return eRet;
-}
-
 FltError ScFormatFilterPluginImpl::ScExportExcel5( SfxMedium& rMedium, ScDocument *pDocument,
     ExportFormatExcel eFormat, CharSet eNach )
 {
-    if( eFormat != ExpBiff5 && eFormat != ExpBiff8 && eFormat != Exp2007Xml )
+    if( eFormat != ExpBiff5 && eFormat != ExpBiff8 )
         return eERR_NI;
 
     // check the passed Calc document
@@ -294,8 +279,6 @@ FltError ScFormatFilterPluginImpl::ScExportExcel5( SfxMedium& rMedium, ScDocumen
     FltError eRet = eERR_UNKN_BIFF;
     if( eFormat == ExpBiff5 || eFormat == ExpBiff8 )
         eRet = lcl_ExportExcelBiff( rMedium, pDocument, pMedStrm, eFormat == ExpBiff8, eNach );
-    else if( eFormat == Exp2007Xml )
-        eRet = lcl_ExportExcel2007Xml( rMedium, pDocument, pMedStrm, eNach );
 
     return eRet;
 }
diff --git a/sc/source/filter/ftools/filterplugin.cxx b/sc/source/filter/ftools/filterplugin.cxx
new file mode 100644
index 0000000..515b3ac
--- /dev/null
+++ b/sc/source/filter/ftools/filterplugin.cxx
@@ -0,0 +1,14 @@
+#include "ftools.hxx"
+
+// ============================================================================
+
+ScFormatFilterPluginImpl::ScFormatFilterPluginImpl()
+{
+}
+
+ScFormatFilterPlugin * SAL_CALL ScFilterCreate(void)
+{
+    return new ScFormatFilterPluginImpl();
+}
+
+// implementation class inside the filters
diff --git a/sc/source/filter/ftools/ftools.cxx b/sc/source/filter/ftools/ftools.cxx
index 9816ccd..0528035 100644
--- a/sc/source/filter/ftools/ftools.cxx
+++ b/sc/source/filter/ftools/ftools.cxx
@@ -391,16 +391,3 @@ bool ScfTools::GetHTMLNameFromName( const String& rSource, String& rName )
     return rName.Len() > 0;
 }
 
-// ============================================================================
-
-ScFormatFilterPluginImpl::ScFormatFilterPluginImpl()
-{
-}
-
-ScFormatFilterPlugin * SAL_CALL ScFilterCreate(void)
-{
-    return new ScFormatFilterPluginImpl();
-}
-
-// implementation class inside the filters
-
diff --git a/sc/source/filter/ftools/makefile.mk b/sc/source/filter/ftools/makefile.mk
index 78f360e..3685d96 100644
--- a/sc/source/filter/ftools/makefile.mk
+++ b/sc/source/filter/ftools/makefile.mk
@@ -47,6 +47,7 @@ PROJECTPCHSOURCE=..\pch\filt_pch
 SLOFILES =	\
         $(SLO)$/fapihelper.obj				\
         $(SLO)$/fprogressbar.obj			\
+        $(SLO)$/filterplugin.obj			\
         $(SLO)$/ftools.obj
 
 EXCEPTIONSFILES = \
diff --git a/sc/source/filter/xlsx/makefile.mk b/sc/source/filter/xlsx/makefile.mk
new file mode 100644
index 0000000..c59deea
--- /dev/null
+++ b/sc/source/filter/xlsx/makefile.mk
@@ -0,0 +1,124 @@
+#*************************************************************************
+#
+# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
+#
+# Copyright 2008 by Sun Microsystems, Inc.
+#
+# OpenOffice.org - a multi-platform office productivity suite
+#
+# $RCSfile: makefile.mk,v $
+#
+# $Revision: 1.42.90.3 $
+#
+# This file is part of OpenOffice.org.
+#
+# OpenOffice.org is free software: you can redistribute it and/or modify
+# it under the terms of the GNU Lesser General Public License version 3
+# only, as published by the Free Software Foundation.
+#
+# OpenOffice.org is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU Lesser General Public License version 3 for more details
+# (a copy is included in the LICENSE file that accompanied this code).
+#
+# You should have received a copy of the GNU Lesser General Public License
+# version 3 along with OpenOffice.org.  If not, see
+# <http://www.openoffice.org/license.html>
+# for a copy of the LGPLv3 License.
+#
+#*************************************************************************
+
+PRJ=..$/..$/..
+
+PRJNAME=sc
+TARGET=xlsx
+
+AUTOSEG=true
+
+PROJECTPCH4DLL=TRUE
+PROJECTPCH=filt_pch
+PROJECTPCHSOURCE=..\pch\filt_pch
+
+# --- Settings -----------------------------------------------------
+
+.INCLUDE :  scpre.mk
+.INCLUDE :  settings.mk
+.INCLUDE :  sc.mk
+
+# --- Files --------------------------------------------------------
+
+SLOFILES =	\
+        $(SLO)$/xlsx-excdoc.obj					\
+        $(SLO)$/xlsx-excrecds.obj				\
+        $(SLO)$/xlsx-exctools.obj				\
+        $(SLO)$/xlsx-expop2.obj					\
+        $(SLO)$/xlsx-fontbuff.obj				\
+        $(SLO)$/xlsx-frmbase.obj					\
+        $(SLO)$/xlsx-namebuff.obj				\
+        $(SLO)$/xlsx-tokstack.obj				\
+        $(SLO)$/xlsx-xechart.obj					\
+        $(SLO)$/xlsx-xecontent.obj				\
+        $(SLO)$/xlsx-xeescher.obj				\
+        $(SLO)$/xlsx-xeformula.obj				\
+        $(SLO)$/xlsx-xehelper.obj				\
+        $(SLO)$/xlsx-xelink.obj					\
+        $(SLO)$/xlsx-xename.obj					\
+        $(SLO)$/xlsx-xepage.obj					\
+        $(SLO)$/xlsx-xepivot.obj					\
+        $(SLO)$/xlsx-xerecord.obj				\
+        $(SLO)$/xlsx-xeroot.obj					\
+        $(SLO)$/xlsx-xestream.obj				\
+        $(SLO)$/xlsx-xestring.obj				\
+        $(SLO)$/xlsx-xestyle.obj					\
+        $(SLO)$/xlsx-xetable.obj					\
+        $(SLO)$/xlsx-xeview.obj					\
+        $(SLO)$/xlsx-xladdress.obj				\
+        $(SLO)$/xlsx-xlchart.obj					\
+        $(SLO)$/xlsx-xlescher.obj				\
+        $(SLO)$/xlsx-xlformula.obj				\
+        $(SLO)$/xlsx-xlpage.obj					\
+        $(SLO)$/xlsx-xlpivot.obj					\
+        $(SLO)$/xlsx-xlroot.obj					\
+        $(SLO)$/xlsx-xlstyle.obj					\
+        $(SLO)$/xlsx-xltools.obj					\
+        $(SLO)$/xlsx-xltoolbar.obj					\
+        $(SLO)$/xlsx-xltracer.obj				\
+        $(SLO)$/xlsx-XclExpChangeTrack.obj				\
+        $(SLO)$/xlsx-xcl97esc.obj				\
+        $(SLO)$/xlsx-xcl97rec.obj				\
+        $(SLO)$/xlsx-xlview.obj
+
+EXCEPTIONSFILES = \
+        $(SLO)$/xlsx-excdoc.obj					\
+        $(SLO)$/xlsx-excrecds.obj				\
+        $(SLO)$/xlsx-expop2.obj					\
+        $(SLO)$/xlsx-namebuff.obj				\
+        $(SLO)$/xlsx-tokstack.obj				\
+        $(SLO)$/xlsx-xecontent.obj				\
+        $(SLO)$/xlsx-xeescher.obj				\
+        $(SLO)$/xlsx-xeformula.obj				\
+        $(SLO)$/xlsx-xehelper.obj				\
+        $(SLO)$/xlsx-xelink.obj					\
+        $(SLO)$/xlsx-xename.obj					\
+        $(SLO)$/xlsx-xepage.obj					\
+        $(SLO)$/xlsx-xepivot.obj					\
+        $(SLO)$/xlsx-xechart.obj					\
+        $(SLO)$/xlsx-xestream.obj				\
+        $(SLO)$/xlsx-xestring.obj				\
+        $(SLO)$/xlsx-xestyle.obj					\
+        $(SLO)$/xlsx-xetable.obj					\
+        $(SLO)$/xlsx-xeview.obj					\
+        $(SLO)$/xlsx-xladdress.obj				\
+        $(SLO)$/xlsx-xlchart.obj					\
+        $(SLO)$/xlsx-xlformula.obj				\
+        $(SLO)$/xlsx-xlpivot.obj					\
+        $(SLO)$/xlsx-xlstyle.obj					\
+        $(SLO)$/xlsx-xltoolbar.obj					\
+        $(SLO)$/xlsx-xcl97esc.obj				\
+        $(SLO)$/xlsx-xcl97rec.obj				\
+        $(SLO)$/xlsx-xlview.obj
+
+# --- Targets -------------------------------------------------------
+
+.INCLUDE :  target.mk
diff --git a/sc/util/makefile.mk b/sc/util/makefile.mk
index d013442..be38b29 100644
--- a/sc/util/makefile.mk
+++ b/sc/util/makefile.mk
@@ -205,6 +205,52 @@ SHL6STDLIBS= \
     $(SAXLIB) \
     $(FORLIB)
 
+# xlsx filter
+LIB7TARGET = $(SLB)$/xlsx2.lib
+LIB7OBJFILES = \
+        $(SLO)$/fapihelper.obj				\
+        $(SLO)$/fprogressbar.obj			\
+        $(SLO)$/ftools.obj
+
+SHL7TARGET= xlsx$(DLLPOSTFIX)
+SHL7IMPLIB= xlsximp
+SHL7LIBS= \
+    $(LIB7TARGET) \
+    $(SLB)$/xlsx.lib
+SHL7VERSIONMAP= xlsx.map
+SHL7DEF=$(MISC)$/$(SHL7TARGET).def
+DEF7NAME= $(SHL7TARGET)
+SHL7DEPN=$(SHL1TARGETN) $(LIB7TARGETN)
+SHL7STDLIBS= \
+    $(ISCLIB) \
+    $(BASICLIB)	\
+    $(SFXLIB)		\
+    $(SVTOOLLIB)	\
+    $(SVLLIB)		\
+    $(SVXCORELIB)		\
+    $(SVXMSFILTERLIB)		\
+    $(SVXLIB)		\
+    $(GOODIESLIB)	\
+    $(BASEGFXLIB) \
+    $(VCLLIB)		\
+    $(CPPULIB)		\
+    $(CPPUHELPERLIB)	\
+    $(COMPHELPERLIB)	\
+    $(UCBHELPERLIB)	\
+    $(TKLIB)		\
+    $(VOSLIB)		\
+    $(SALLIB)		\
+    $(TOOLSLIB)	\
+    $(I18NISOLANGLIB) \
+    $(UNOTOOLSLIB) \
+    $(SOTLIB)		\
+    $(XMLOFFLIB)	\
+    $(DBTOOLSLIB)	\
+    $(AVMEDIALIB)   \
+    $(OOXLIB)       \
+    $(SAXLIB) \
+    $(FORLIB)
+
 # add for scui
 SHL8TARGET= scui$(DLLPOSTFIX)
 SHL8IMPLIB= scuiimp
diff --git a/sc/util/xlsx.map b/sc/util/xlsx.map
new file mode 100644
index 0000000..daf6bd2
--- /dev/null
+++ b/sc/util/xlsx.map
@@ -0,0 +1,9 @@
+XLSX_1_0 {
+        global:
+                component_getImplementationEnvironment;
+                component_writeInfo;
+                component_getFactory;
+
+        local:
+                *;
+};
-- 
1.7.0.1

