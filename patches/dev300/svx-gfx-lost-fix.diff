Fix gfx reduction to preview size on save

From: Thorsten Behrens <thb@openoffice.org>


---

 svx/inc/svx/svdograf.hxx        |    1 +
 svx/source/svdraw/svdograf.cxx  |   12 ++++++++++++
 svx/source/unodraw/unoshap2.cxx |    4 ++--
 3 files changed, 15 insertions(+), 2 deletions(-)


diff --git svx/inc/svx/svdograf.hxx svx/inc/svx/svdograf.hxx
index f542818..ea6a996 100644
--- svx/inc/svx/svdograf.hxx
+++ svx/inc/svx/svdograf.hxx
@@ -143,6 +143,7 @@ public:
 
     void					SetGraphicObject( const GraphicObject& rGrfObj );
     const GraphicObject&	GetGraphicObject( bool bForceSwapIn = false) const;
+    ByteString				GetUniqueID() const;
 
     void					SetGraphic(const Graphic& rGrf);
     const Graphic&			GetGraphic() const;
diff --git svx/source/svdraw/svdograf.cxx svx/source/svdraw/svdograf.cxx
index 1bf8ceb..b47f48b 100644
--- svx/source/svdraw/svdograf.cxx
+++ svx/source/svdraw/svdograf.cxx
@@ -303,6 +303,18 @@ const GraphicObject& SdrGrafObj::GetGraphicObject(bool bForceSwapIn) const
 
 // -----------------------------------------------------------------------------
 
+ByteString SdrGrafObj::GetUniqueID() const
+{
+    // #i104146# attempting to retrieve the gfx ID from a preview
+    // graphic might *change* the file on export
+    if( mbIsPreview )
+        ForceSwapIn();
+
+    return pGraphic->GetUniqueID();
+}
+
+// -----------------------------------------------------------------------------
+
 void SdrGrafObj::SetGraphic( const Graphic& rGrf )
 {
     pGraphic->SetGraphic( rGrf );
diff --git svx/source/unodraw/unoshap2.cxx svx/source/unodraw/unoshap2.cxx
index 5994304..3e405dd 100644
--- svx/source/unodraw/unoshap2.cxx
+++ svx/source/unodraw/unoshap2.cxx
@@ -1834,9 +1834,9 @@ bool SvxGraphicObject::getPropertyValueImpl( const SfxItemPropertyMap* pProperty
         }
         else
         {
-            const GraphicObject& rGrafObj = static_cast< SdrGrafObj*>( mpObj.get() )->GetGraphicObject();
             OUString aURL( RTL_CONSTASCII_USTRINGPARAM(UNO_NAME_GRAPHOBJ_URLPREFIX));
-            aURL += OUString::createFromAscii( rGrafObj.GetUniqueID().GetBuffer() );
+            aURL += OUString::createFromAscii( 
+                static_cast< SdrGrafObj*>( mpObj.get() )->GetUniqueID().GetBuffer() );
             rValue <<= aURL;
         }
         break;
