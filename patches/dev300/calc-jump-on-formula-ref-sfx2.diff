From 7809a89040d46efba8d81b5d41232f37c48374b3 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:56:06 +0200
Subject: [PATCH 191/878] calc-jump-on-formula-ref-sfx2.diff

---
 sfx2/source/appl/appopen.cxx |   25 ++++++++++++++++++++++++-
 sfx2/source/view/topfrm.cxx  |   40 ++++++++++++++++++++--------------------
 2 files changed, 44 insertions(+), 21 deletions(-)

diff --git a/sfx2/source/appl/appopen.cxx b/sfx2/source/appl/appopen.cxx
index d1be977..490a5a5 100644
--- a/sfx2/source/appl/appopen.cxx
+++ b/sfx2/source/appl/appopen.cxx
@@ -838,6 +838,29 @@ void SfxApplication::NewDocExec_Impl( SfxRequest& rReq )
 
 //---------------------------------------------------------------------------
 
+namespace {
+
+/**
+ * Check if a given filter type should open the hyperlinked document
+ * natively.
+ *
+ * @param rFilter filter object
+ */
+bool lcl_isFilterNativelySupported(const SfxFilter& rFilter)
+{
+    if (rFilter.IsOwnFormat())
+        return true;
+
+    ::rtl::OUString aName = rFilter.GetFilterName();
+    if (aName.indexOf(::rtl::OUString::createFromAscii("MS Excel")) == 0)
+        // We can handle all Excel variants natively.
+        return true;
+
+    return false;
+}
+
+}
+
 void SfxApplication::OpenDocExec_Impl( SfxRequest& rReq )
 {
     DBG_MEMTEST();
@@ -1147,7 +1170,7 @@ void SfxApplication::OpenDocExec_Impl( SfxRequest& rReq )
             aTypeName = xTypeDetection->queryTypeByURL( aURL.Main );
             SfxFilterMatcher& rMatcher = SFX_APP()->GetFilterMatcher();
             const SfxFilter* pFilter = rMatcher.GetFilter4EA( aTypeName );
-            if ( !pFilter || !( pFilter->IsOwnFormat() ))
+            if (!pFilter || !lcl_isFilterNativelySupported(*pFilter))
             {
                 // hyperlink does not link to own type => special handling (http, ftp) browser and (other external protocols) OS
                 Reference< XSystemShellExecute > xSystemShellExecute( ::comphelper::getProcessServiceFactory()->createInstance(
diff --git a/sfx2/source/view/topfrm.cxx b/sfx2/source/view/topfrm.cxx
index a7b2bd2..2d63f81 100644
--- a/sfx2/source/view/topfrm.cxx
+++ b/sfx2/source/view/topfrm.cxx
@@ -916,26 +916,6 @@ sal_Bool SfxTopFrame::InsertDocument( SfxObjectShell* pDoc )
     if ( pMarkItem )
         aMark = pMarkItem->GetValue();
 
-    if ( pDoc->Get_Impl()->nLoadedFlags & SFX_LOADED_MAINDOCUMENT )
-    {
-        if ( pViewDataItem )
-            pFrame->GetViewShell()->ReadUserData( pViewDataItem->GetValue(), sal_True );
-        else if( aMark.Len() )
-            GetCurrentViewFrame()->GetViewShell()->JumpToMark( aMark );
-    }
-    else
-    {
-        // Daten setzen, die in FinishedLoading ausgewertet werden
-        MarkData_Impl*& rpMark = pDoc->Get_Impl()->pMarkData;
-        if (!rpMark)
-            rpMark = new MarkData_Impl;
-        rpMark->pFrame = GetCurrentViewFrame();
-        if ( pViewDataItem )
-            rpMark->aUserData = pViewDataItem->GetValue();
-        else
-            rpMark->aMark = aMark;
-    }
-
     // Position und Groesse setzen
     //sal_uInt16 nWinMode = pModeItem ? pModeItem->GetValue() : 1;
     if ( pAreaItem && !pOld )
@@ -1003,6 +983,26 @@ sal_Bool SfxTopFrame::InsertDocument( SfxObjectShell* pDoc )
         GetWindow().Show();
     }
 
+    if ( pDoc->Get_Impl()->nLoadedFlags & SFX_LOADED_MAINDOCUMENT )
+    {
+        if ( pViewDataItem )
+            pFrame->GetViewShell()->ReadUserData( pViewDataItem->GetValue(), sal_True );
+        else if( aMark.Len() )
+            GetCurrentViewFrame()->GetViewShell()->JumpToMark( aMark );
+    }
+    else
+    {
+        // Daten setzen, die in FinishedLoading ausgewertet werden
+        MarkData_Impl*& rpMark = pDoc->Get_Impl()->pMarkData;
+        if (!rpMark)
+            rpMark = new MarkData_Impl;
+        rpMark->pFrame = GetCurrentViewFrame();
+        if ( pViewDataItem )
+            rpMark->aUserData = pViewDataItem->GetValue();
+        else
+            rpMark->aMark = aMark;
+    }
+
     // Jetzt UpdateTitle, hidden TopFrames haben sonst keinen Namen!
     pFrame->UpdateTitle();
 
-- 
1.7.0.1

