---
 sal/osl/unx/file_url.cxx |   30 ++++++++++++++++++++++++++++--
 solenv/bin/linkoo        |    1 +
 2 files changed, 29 insertions(+), 2 deletions(-)

diff --git sal/osl/unx/file_url.cxx sal/osl/unx/file_url.cxx
index 2253e8a..53f27b3 100644
--- sal/osl/unx/file_url.cxx
+++ sal/osl/unx/file_url.cxx
@@ -692,6 +692,7 @@ oslFileError osl_getAbsoluteFileURL(rtl_uString*  ustrBaseDirURL, rtl_uString* u
 {
     FileBase::RC  rc;
     rtl::OUString unresolved_path;    
+    static char *allow_symlinks = getenv( "SAL_ALLOW_LINKOO_SYMLINKS" );
     
     rc = FileBase::getSystemPathFromFileURL(rtl::OUString(ustrRelativeURL), unresolved_path);
     
@@ -712,8 +713,33 @@ oslFileError osl_getAbsoluteFileURL(rtl_uString*  ustrBaseDirURL, rtl_uString* u
         unresolved_path = abs_path;        
     }
 
-    rtl::OUString resolved_path;	  
-    rc = (FileBase::RC) osl_getAbsoluteFileURL_impl_(unresolved_path, resolved_path);
+    rtl::OUString resolved_path;
+
+    if (!allow_symlinks)
+    {
+        rc = (FileBase::RC) osl_getAbsoluteFileURL_impl_(unresolved_path, resolved_path);
+    }
+    else
+    {
+        // SAL_ALLOW_LINKOO_SYMLINKS environment variable:
+        // for linkoo to work, we need to let the symlinks to the libraries untouched
+        rtl::OUString base;
+        sal_Int32 last_slash = unresolved_path.lastIndexOf( UNICHAR_SLASH );
+
+        if (last_slash >= 0 && last_slash + 1 < unresolved_path.getLength())
+        {
+            base = unresolved_path.copy(last_slash+1);
+            unresolved_path = unresolved_path.copy(0, last_slash);
+        }
+
+        rc = (FileBase::RC) osl_getAbsoluteFileURL_impl_(unresolved_path, resolved_path);
+
+        if (base.getLength() > 0)
+        {
+            resolved_path += rtl::OUString( UNICHAR_SLASH );
+            resolved_path += base;
+        }
+    }
         
     if (FileBase::E_None == rc)
     {
diff --git solenv/bin/linkoo solenv/bin/linkoo
index ee9d745..3284522 100755
--- solenv/bin/linkoo
+++ solenv/bin/linkoo
@@ -48,6 +48,7 @@ export STAR_RESOURCEPATH=`pwd`/resource
 export OOO_FORCE_SYSALLOC=1
 export MALLOC_CHECK_=2
 export OOO_DISABLE_RECOVERY=1
+export SAL_ALLOW_LINKOO_SYMLINKS=1
 ';
 
 $program_dir = 'program';
-- 
1.7.0.1

