From 0a6998b316f5788ed9f5e8cc6a62e83faac5cc88 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:02:26 +0200
Subject: [PATCH 516/878] layout-generate-localize-sdf.diff

---
 sc/uiconfig/layout/makefile.mk  |   35 +++++++++++++++++++++++++++--------
 svx/uiconfig/layout/layout.mk   |   28 ++++++++++++----------------
 svx/uiconfig/layout/makefile.mk |   27 +++++++++++++++++++++------
 3 files changed, 60 insertions(+), 30 deletions(-)

diff --git a/sc/uiconfig/layout/makefile.mk b/sc/uiconfig/layout/makefile.mk
index e340ae6..f383a75 100644
--- a/sc/uiconfig/layout/makefile.mk
+++ b/sc/uiconfig/layout/makefile.mk
@@ -51,15 +51,34 @@ all .PHONY:
 
 .INCLUDE :  target.mk
 
-localize.sdf: $(PRJ)/source/ui/miscdlgs/localize.sdf $(PRJ)/source/ui/src/localize.sdf
-    grep instbdlg.src $(PRJ)/source/ui/miscdlgs/localize.sdf | awk -F'\t' '{{printf "%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\n", "layout", "sc\\uiconfig\\layout\\insert-sheet.xml", $$3, "layout", $$5 $$6 "_label", "", "", $$8, "0", $$10, $$11, $$12, "", $$14, $$15}}' | sed -e 's/\(\(FL\|STR\)_[^\t]*\)_label/\1_text/' -e 's/\tRID_SCDLG_INSERT_TABLE/\t/' -e 's/\t_label/\tRID_SCDLG_INSERT_TABLE_title/' > insert-sheet-$@
-    grep -E 'miscdlgs.src.*(FT_DEST|FT_INSERT|STR_NEWDOC|RID_SCDLG_MOVETAB|BTN_COPY)' $(PRJ)/source/ui/src/localize.sdf | awk -F'\t' '{{printf "%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\n", "layout", "sc\\uiconfig\\layout\\move-copy-sheet.xml", $$3, "layout", $$5 $$6 "_label", "", "", $$8, "0", $$10, $$11, $$12, "", $$14, $$15}}' | sed -e 's/\(\(FL\|STR\)_[^\t]*\)_label/\1_text/' -e 's/\tRID_SCDLG_MOVETAB/\t/' -e 's/\t_label/\tRID_SCDLG_MOVETAB_title/'> move-copy-sheet-$@
-    grep sortdlg.src $(PRJ)/source/ui/src/localize.sdf | awk -F'\t' '{{printf "%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\n", "layout", "sc\\uiconfig\\layout\\sort-options.xml", $$3, "layout", $$5 $$6 "_label", "", "", $$8, "0", $$10, $$11, $$12, "", $$14, $$15}}' | sed -e 's/\(\(FL\|STR\)_[^\t]*\)_label/\1_text/' -e 's/\tRID_SCDLG_SORT/\t/' -e 's/\t_label/\tRID_SCDLG_SORT_title/' -e 's/\tRID_SCPAGE_SORT_OPTIONS/\t/' -e 's/\tRID_SCPAGE_SORT_FIELDS/\t/' > sort-options-$@
+localize.sdf: $(COMMONMISC)$/$(PRJNAME)$/source$/ui$/miscdlgs$/localize.sdf $(COMMONMISC)$/$(PRJNAME)$/source$/ui$/src$/localize.sdf
+    grep instbdlg.src $(COMMONMISC)$/$(PRJNAME)$/source$/ui$/miscdlgs$/localize.sdf | awk -F'\t' '{{printf "%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\n", "layout", "sc\\uiconfig\\layout\\insert-sheet.xml", $$3, "layout", $$5 $$6 "_label", "", "", $$8, "0", $$10, $$11, $$12, "", $$14, $$15}}' | sed -e 's/\(\(FL\|STR\)_[^\t]*\)_label/\1_text/' -e 's/\tRID_SCDLG_INSERT_TABLE/\t/' -e 's/\t_label/\tRID_SCDLG_INSERT_TABLE_title/' > insert-sheet-$@
+    grep -E 'miscdlgs.src.*(FT_DEST|FT_INSERT|STR_NEWDOC|RID_SCDLG_MOVETAB|BTN_COPY)' $(COMMONMISC)$/$(PRJNAME)$/source$/ui$/src$/localize.sdf | awk -F'\t' '{{printf "%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\n", "layout", "sc\\uiconfig\\layout\\move-copy-sheet.xml", $$3, "layout", $$5 $$6 "_label", "", "", $$8, "0", $$10, $$11, $$12, "", $$14, $$15}}' | sed -e 's/\(\(FL\|STR\)_[^\t]*\)_label/\1_text/' -e 's/\tRID_SCDLG_MOVETAB/\t/' -e 's/\t_label/\tRID_SCDLG_MOVETAB_title/'> move-copy-sheet-$@
+    grep sortdlg.src $(COMMONMISC)$/$(PRJNAME)$/source$/ui$/src$/localize.sdf | awk -F'\t' '{{printf "%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\n", "layout", "sc\\uiconfig\\layout\\sort-options.xml", $$3, "layout", $$5 $$6 "_label", "", "", $$8, "0", $$10, $$11, $$12, "", $$14, $$15}}' | sed -e 's/\(\(FL\|STR\)_[^\t]*\)_label/\1_text/' -e 's/\tRID_SCDLG_SORT/\t/' -e 's/\t_label/\tRID_SCDLG_SORT_title/' -e 's/\tRID_SCPAGE_SORT_OPTIONS/\t/' -e 's/\tRID_SCPAGE_SORT_FIELDS/\t/' > sort-options-$@
     echo '#empty' | cat - insert-sheet-$@ move-copy-sheet-$@ sort-options-$@ > $@
     rm -f *-$@
 
-$(PRJ)/source/ui/miscdlgs/localize.sdf:
-    touch $@
+.IF "$(WITH_LANG)"!=""
 
-$(PRJ)/source/ui/src/localize.sdf:
-    touch $@
+# FIXME: do not duplicate the code from target.mk
+$(COMMONMISC)$/$(PRJNAME)$/source$/ui$/miscdlgs$/localize.sdf : $(SOLARCOMMONSDFDIR)$/$(PRJNAME).zip
+    @@-$(MKDIRHIER) $(@:d)
+    -unzip -o -d $(COMMONMISC)$/$(PRJNAME) $(SOLARCOMMONSDFDIR)$/$(PRJNAME).zip $(subst,$(COMMONMISC)$/$(PRJNAME)$/, $@)
+    $(TOUCH) $@
+
+$(COMMONMISC)$/$(PRJNAME)$/source$/ui$/src$/localize.sdf : $(SOLARCOMMONSDFDIR)$/$(PRJNAME).zip
+    @@-$(MKDIRHIER) $(@:d)
+    -unzip -o -d $(COMMONMISC)$/$(PRJNAME) $(SOLARCOMMONSDFDIR)$/$(PRJNAME).zip $(subst,$(COMMONMISC)$/$(PRJNAME)$/, $@)
+    $(TOUCH) $@
+
+.ELSE
+
+$(COMMONMISC)$/$(PRJNAME)$/source$/ui$/src$/localize.sdf :
+    @@-$(MKDIRHIER) $(@:d)
+    $(TOUCH) $@
+
+$(COMMONMISC)$/$(PRJNAME)$/source$/ui$/miscdlgs$/localize.sdf :
+    @@-$(MKDIRHIER) $(@:d)
+    $(TOUCH) $@
+
+.ENDIF # "$(WITH_LANG)"!=""
diff --git a/svx/uiconfig/layout/layout.mk b/svx/uiconfig/layout/layout.mk
index a79ae67..227da15 100644
--- a/svx/uiconfig/layout/layout.mk
+++ b/svx/uiconfig/layout/layout.mk
@@ -1,33 +1,29 @@
-# TODO: move to solenv/inc
-# copies: sw/uiconfig/layout svx/uiconfig/layout
-
-TRALAY=$(AUGMENT_LIBRARY_PATH) $(SOLARBINDIR)/tralay
+TRALAY=$(AUGMENT_LIBRARY_PATH) $(SOLARBINDIR)$/tralay
 XML_DEST=$(DLLDEST)
 XML_LANGS=$(alllangiso)
 
-ALL_XMLS=$(foreach,i,$(XML_FILES) $(XML_DEST)/$i) $(foreach,i,$(XML_LANGS) $(foreach,j,$(XML_FILES) $(XML_DEST)/$i/$j))
+ALL_XMLS=$(foreach,i,$(XML_FILES) $(XML_DEST)$/$i) $(foreach,i,$(XML_LANGS) $(foreach,j,$(XML_FILES) $(XML_DEST)$/$i$/$j))
+XML_DEPS=$(foreach,i,$(XML_FILES) $(MISC)$/$i.dep)
 
 # Must remove the -j (no duplicate base file names) flag
 ZIPUPDATE=-u
 XML_ZIP = $(PRJNAME)-layout
 
-ALLTAR: $(XML_ZIP)
+ALLTAR .SEQUENTIAL: localize.sdf ALL_XML_DEPS
 
-$(XML_ZIP): $(ALL_XMLS)
+ALL_XML_DEPS: $(XML_DEPS)
 
 ZIP1DIR=$(XML_DEST)
 ZIP1TARGET=$(XML_ZIP)
 ZIP1LIST=$(ALL_XMLS:s@$(XML_DEST)/@@)
+ZIP1DEPS=localize.sdf $(XML_DEPS)
 
-$(foreach,i,$(XML_LANGS) $(XML_DEST)/$i/%.xml): %.xml
-    -$(MKDIR) $(@:d)
-    @echo $(foreach,i,$(XML_LANGS) $(XML_DEST)/$i/%.xml): %.xml
-    $(TRALAY) -m localize.sdf -o $(XML_DEST) -l $(XML_LANGS:f:t" -l ") $<
-
-$(XML_DEST)/%.xml: %.xml
-    -$(MKDIR) $(@:d)
-    $(COPY) $< $@
+$(MISC)$/%.xml.dep: %.xml
+    -$(MKDIR) "$(XML_DEST)"
+    cp "$<" "$(XML_DEST)"
+    $(TRALAY) -m localize.sdf -o "$(XML_DEST)" -l $(XML_LANGS:f:t" -l ") "$<"
+    $(TOUCH) "$@"
 
 # Don't want to overwrite filled localize.sdf with empty template
 template.sdf:
-    $(foreach,i,$(XML_FILES) $(TRALAY) -l en-US $i) > $@
+    $(foreach,i,$(XML_FILES) $(TRALAY) -l en-US "$i") > $@
diff --git a/svx/uiconfig/layout/makefile.mk b/svx/uiconfig/layout/makefile.mk
index c778413..7e7f2db 100644
--- a/svx/uiconfig/layout/makefile.mk
+++ b/svx/uiconfig/layout/makefile.mk
@@ -36,9 +36,8 @@ TARGET=layout
 all: ALLTAR
 
 XML_FILES=\
- "find-and-replace.xml"\
- zoom.xml\
-#
+ find-and-replace.xml\
+ zoom.xml
 
 .INCLUDE : layout.mk
 
@@ -48,8 +47,24 @@ all .PHONY:
 
 .INCLUDE :  target.mk
 
-localize.sdf: $(PRJ)/source/dialog/localize.sdf
-    grep srchdlg.src $(PRJ)/source/dialog/localize.sdf | awk -F'\t' '{{printf "%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\n", "layout", "svx\\uiconfig\\layout\\find-and-replace.xml", $$3, "layout", $$5 $$6 "_label", "", "", $$8, "0", $$10, $$11, $$12, "", $$14, $$15}}' | sed -e 's/\(\(FL\|STR\)_[^\t]*\)_label/\1_text/' -e 's/\tRID_SVXDLG_SEARCH/\t/' -e 's/\t_label/\tRID_SVXDLG_SEARCH_title/' > find-and-replace-$@
-    grep zoom.src $(PRJ)/source/dialog/localize.sdf | awk -F'\t' '{{printf "%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\n", "layout", "svx\\uiconfig\\layout\\zoom.xml", $$3, "layout", $$5 $$6 "_label", "", "", $$8, "0", $$10, $$11, $$12, "", $$14, $$15}}' | sed -e 's/\(\(FL\|STR\)_[^\t]*\)_label/\1_text/' -e 's/\tRID_SVXDLG_ZOOM/\t/' -e 's/\t_label/\tRID_SVXDLG_ZOOM_title/' > zoom-$@
+localize.sdf: $(COMMONMISC)$/$(PRJNAME)$/source$/dialog$/localize.sdf
+    grep srchdlg.src $(COMMONMISC)$/$(PRJNAME)$/source$/dialog$/localize.sdf | awk -F'\t' '{{printf "%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\n", "layout", "svx\\uiconfig\\layout\\find-and-replace.xml", $$3, "layout", $$5 $$6 "_label", "", "", $$8, "0", $$10, $$11, $$12, "", $$14, $$15}}' | sed -e 's/\(\(FL\|STR\)_[^\t]*\)_label/\1_text/' -e 's/\tRID_SVXDLG_SEARCH/\t/' -e 's/\t_label/\tRID_SVXDLG_SEARCH_title/' > find-and-replace-$@
+    grep zoom.src $(COMMONMISC)$/$(PRJNAME)$/source$/dialog$/localize.sdf | awk -F'\t' '{{printf "%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\n", "layout", "svx\\uiconfig\\layout\\zoom.xml", $$3, "layout", $$5 $$6 "_label", "", "", $$8, "0", $$10, $$11, $$12, "", $$14, $$15}}' | sed -e 's/\(\(FL\|STR\)_[^\t]*\)_label/\1_text/' -e 's/\tRID_SVXDLG_ZOOM/\t/' -e 's/\t_label/\tRID_SVXDLG_ZOOM_title/' > zoom-$@
     echo '#empty' | cat - find-and-replace-$@ zoom-$@ > $@
     rm -f *-$@
+
+.IF "$(WITH_LANG)"!=""
+
+# FIXME: do not duplicate the code from target.mk
+$(COMMONMISC)$/$(PRJNAME)$/source$/dialog$/localize.sdf : $(SOLARCOMMONSDFDIR)$/$(PRJNAME).zip
+    @@-$(MKDIRHIER) $(@:d)
+    -unzip -o -d $(COMMONMISC)$/$(PRJNAME) $(SOLARCOMMONSDFDIR)$/$(PRJNAME).zip $(subst,$(COMMONMISC)$/$(PRJNAME)$/, $@)
+    $(TOUCH) $@
+
+.ELSE
+
+$(COMMONMISC)$/$(PRJNAME)$/source$/dialog$/localize.sdf :
+    @@-$(MKDIRHIER) $(@:d)
+    $(TOUCH) $@
+
+.ENDIF # "$(WITH_LANG)"!=""
-- 
1.7.0.1

