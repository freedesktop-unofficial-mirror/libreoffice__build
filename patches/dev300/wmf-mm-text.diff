From 3e5f420b68482e36f58413750e3dc5bfb5e65804 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:06:19 +0200
Subject: [PATCH 622/768] wmf-mm-text.diff

---
 svtools/source/filter.vcl/wmf/winmtf.cxx |   21 +++++++++++++++++++++
 svtools/source/filter.vcl/wmf/winmtf.hxx |    3 +++
 svtools/source/filter.vcl/wmf/winwmf.cxx |    1 +
 3 files changed, 25 insertions(+), 0 deletions(-)

diff --git svtools/source/filter.vcl/wmf/winmtf.cxx svtools/source/filter.vcl/wmf/winmtf.cxx
index ba8efff..c7a35ff 100644
--- svtools/source/filter.vcl/wmf/winmtf.cxx
+++ svtools/source/filter.vcl/wmf/winmtf.cxx
@@ -416,6 +416,14 @@ Point WinMtfOutput::ImplMap( const Point& rPt )
         {
             switch( mnMapMode )
             {
+                case MM_TEXT:
+                    fX2 -= mnWinOrgX;
+                    fY2 -= mnWinOrgY;
+                    fX2 *= 2540.0/mnUnitsPerInch;
+                    fY2 *= 2540.0/mnUnitsPerInch;
+                    fX2 += mnDevOrgX;
+                    fY2 += mnDevOrgY;
+                    break;
                 case MM_LOENGLISH :
                 {
                     fX2 -= mnWinOrgX;
@@ -491,6 +499,10 @@ Size WinMtfOutput::ImplMap( const Size& rSz )
         {
             switch( mnMapMode )
             {
+                case MM_TEXT:
+                    fWidth *= 2540.0/mnUnitsPerInch;
+                    fHeight*= 2540.0/mnUnitsPerInch;
+                break;
                 case MM_LOENGLISH :
                 {
                     fWidth *= 25.40;
@@ -927,6 +939,7 @@ WinMtfOutput::WinMtfOutput( GDIMetaFile& rGDIMetaFile ) :
     mbFillStyleSelected	( sal_False ),
     mnGfxMode			( GM_COMPATIBLE ),
     mnMapMode           ( MM_TEXT ),
+    mnUnitsPerInch ( 96 ),
     mnDevOrgX			( 0 ),
     mnDevOrgY			( 0 ),
     mnDevWidth			( 1 ),
@@ -2053,6 +2066,14 @@ void WinMtfOutput::SetMapMode( sal_uInt32 nMapMode )
 
 //-----------------------------------------------------------------------------------
 
+void WinMtfOutput::SetUnitsPerInch( UINT16 nUnitsPerInch )
+{
+    if( nUnitsPerInch != 0 )
+    mnUnitsPerInch = nUnitsPerInch;
+}
+
+//-----------------------------------------------------------------------------------
+
 void WinMtfOutput::SetWorldTransform( const XForm& rXForm )
 {
     maXForm.eM11 = rXForm.eM11;
diff --git svtools/source/filter.vcl/wmf/winmtf.hxx svtools/source/filter.vcl/wmf/winmtf.hxx
index b0eb364..e283b7f 100644
--- svtools/source/filter.vcl/wmf/winmtf.hxx
+++ svtools/source/filter.vcl/wmf/winmtf.hxx
@@ -587,6 +587,8 @@ class WinMtfOutput
 
         sal_uInt32			mnGfxMode;
         sal_uInt32          mnMapMode;
+    UINT16			mnUnitsPerInch;
+
         XForm				maXForm;
         sal_Int32			mnDevOrgX, mnDevOrgY;
         sal_Int32			mnDevWidth, mnDevHeight;
@@ -633,6 +635,7 @@ class WinMtfOutput
 
         sal_uInt32			GetMapMode() const { return mnMapMode; };
         void                SetMapMode( sal_uInt32 mnMapMode );
+    void SetUnitsPerInch( UINT16 nUnitsPerInch );
         void				SetWorldTransform( const XForm& rXForm );
         void				ModifyWorldTransform( const XForm& rXForm, UINT32 nMode );
 
diff --git svtools/source/filter.vcl/wmf/winwmf.cxx svtools/source/filter.vcl/wmf/winwmf.cxx
index 1a70555..9f86995 100644
--- svtools/source/filter.vcl/wmf/winwmf.cxx
+++ svtools/source/filter.vcl/wmf/winwmf.cxx
@@ -1043,6 +1043,7 @@ BOOL WMFReader::ReadHeader(WMF_APMFILEHEADER *pAPMHeader)
       }
     }
 
+    pOut->SetUnitsPerInch( nUnitsPerInch );
     pOut->SetWinOrg( aPlaceableBound.TopLeft() );
     aWMFSize = Size( labs( aPlaceableBound.GetWidth() ), labs( aPlaceableBound.GetHeight() ) );
     pOut->SetWinExt( aWMFSize );
-- 
1.7.0.1

