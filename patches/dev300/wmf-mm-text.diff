From 50df775ce36b78f61f97d2930c68f14b747cd30d Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:06:19 +0200
Subject: [PATCH 706/878] wmf-mm-text.diff

---
 svtools/source/filter.vcl/wmf/winmtf.cxx |   21 +++++++++++++++++++++
 svtools/source/filter.vcl/wmf/winmtf.hxx |    3 +++
 svtools/source/filter.vcl/wmf/winwmf.cxx |    1 +
 3 files changed, 25 insertions(+), 0 deletions(-)

diff --git a/svtools/source/filter.vcl/wmf/winmtf.cxx b/svtools/source/filter.vcl/wmf/winmtf.cxx
index c89b108..94c0def 100644
--- a/svtools/source/filter.vcl/wmf/winmtf.cxx
+++ b/svtools/source/filter.vcl/wmf/winmtf.cxx
@@ -420,6 +420,14 @@ Point WinMtfOutput::ImplMap( const Point& rPt )
         {
             switch( mnMapMode )
             {
+                case MM_TEXT:
+                    fX2 -= mnWinOrgX;
+                    fY2 -= mnWinOrgY;
+                    fX2 *= 2540.0/mnUnitsPerInch;
+                    fY2 *= 2540.0/mnUnitsPerInch;
+                    fX2 += mnDevOrgX;
+                    fY2 += mnDevOrgY;
+                    break;
                 case MM_LOENGLISH :
                 {
                     fX2 -= mnWinOrgX;
@@ -495,6 +503,10 @@ Size WinMtfOutput::ImplMap( const Size& rSz )
         {
             switch( mnMapMode )
             {
+                case MM_TEXT:
+                    fWidth *= 2540.0/mnUnitsPerInch;
+                    fHeight*= 2540.0/mnUnitsPerInch;
+                break;
                 case MM_LOENGLISH :
                 {
                     fWidth *= 25.40;
@@ -931,6 +943,7 @@ WinMtfOutput::WinMtfOutput( GDIMetaFile& rGDIMetaFile ) :
     mbFillStyleSelected	( sal_False ),
     mnGfxMode			( GM_COMPATIBLE ),
     mnMapMode           ( MM_TEXT ),
+    mnUnitsPerInch ( 96 ),
     mnDevOrgX			( 0 ),
     mnDevOrgY			( 0 ),
     mnDevWidth			( 1 ),
@@ -2057,6 +2070,14 @@ void WinMtfOutput::SetMapMode( sal_uInt32 nMapMode )
 
 //-----------------------------------------------------------------------------------
 
+void WinMtfOutput::SetUnitsPerInch( UINT16 nUnitsPerInch )
+{
+    if( nUnitsPerInch != 0 )
+    mnUnitsPerInch = nUnitsPerInch;
+}
+
+//-----------------------------------------------------------------------------------
+
 void WinMtfOutput::SetWorldTransform( const XForm& rXForm )
 {
     maXForm.eM11 = rXForm.eM11;
diff --git a/svtools/source/filter.vcl/wmf/winmtf.hxx b/svtools/source/filter.vcl/wmf/winmtf.hxx
index ef4fc6f..07acbcc 100644
--- a/svtools/source/filter.vcl/wmf/winmtf.hxx
+++ b/svtools/source/filter.vcl/wmf/winmtf.hxx
@@ -588,6 +588,8 @@ class WinMtfOutput
 
         sal_uInt32			mnGfxMode;
         sal_uInt32          mnMapMode;
+    UINT16			mnUnitsPerInch;
+
         XForm				maXForm;
         sal_Int32			mnDevOrgX, mnDevOrgY;
         sal_Int32			mnDevWidth, mnDevHeight;
@@ -634,6 +636,7 @@ class WinMtfOutput
 
         sal_uInt32			GetMapMode() const { return mnMapMode; };
         void                SetMapMode( sal_uInt32 mnMapMode );
+    void SetUnitsPerInch( UINT16 nUnitsPerInch );
         void				SetWorldTransform( const XForm& rXForm );
         void				ModifyWorldTransform( const XForm& rXForm, UINT32 nMode );
 
diff --git a/svtools/source/filter.vcl/wmf/winwmf.cxx b/svtools/source/filter.vcl/wmf/winwmf.cxx
index 4e5e50f..72baa9f 100644
--- a/svtools/source/filter.vcl/wmf/winwmf.cxx
+++ b/svtools/source/filter.vcl/wmf/winwmf.cxx
@@ -987,6 +987,7 @@ BOOL WMFReader::ReadHeader(WMF_APMFILEHEADER *pAPMHeader)
       }
     }
 
+    pOut->SetUnitsPerInch( nUnitsPerInch );
     pOut->SetWinOrg( aPlaceableBound.TopLeft() );
     aWMFSize = Size( labs( aPlaceableBound.GetWidth() ), labs( aPlaceableBound.GetHeight() ) );
     pOut->SetWinExt( aWMFSize );
-- 
1.7.0.1

