From adb55e35310445f90ce391da96ddddc6e07214e5 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:04:31 +0200
Subject: [PATCH 625/878] sw-import-html-controls.diff

---
 svx/inc/svx/msocximex.hxx         |   34 ++++++++++++
 svx/source/msfilter/msocximex.cxx |  102 ++++++++++++++++++++++++++++++++++++-
 sw/source/filter/ww8/ww8par.hxx   |    2 +
 sw/source/filter/ww8/ww8par3.cxx  |    8 +++
 sw/source/filter/ww8/ww8par5.cxx  |    2 +-
 5 files changed, 146 insertions(+), 2 deletions(-)

diff --git a/svx/inc/svx/msocximex.hxx b/svx/inc/svx/msocximex.hxx
index 8efd6f6..26b61b7 100644
--- a/svx/inc/svx/msocximex.hxx
+++ b/svx/inc/svx/msocximex.hxx
@@ -1167,4 +1167,38 @@ public:
                                 const com::sun::star::awt::Size& rSize );
 };
 
+
+class HTML_TextBox : public OCX_ModernControl
+{
+public:
+    HTML_TextBox() : OCX_ModernControl(rtl::OUString::createFromAscii("TextBox")) {
+        msFormType = rtl::OUString::createFromAscii("com.sun.star.form.component.TextField");
+        msDialogType = rtl::OUString::createFromAscii("com.sun.star.awt.UnoControlEditModel");
+        mnBackColor = 0x80000005L;
+        mnForeColor = 0x80000008L;
+        nBorderColor = 0x80000006L;
+        aFontData.SetHasAlign(TRUE);
+    }
+
+    using OCX_ModernControl::Import; // to not hide the other two import methods
+    virtual sal_Bool Import(com::sun::star::uno::Reference<
+        com::sun::star::beans::XPropertySet> &rPropSet);
+  /*
+    sal_Bool Export(SotStorageRef &rObj,
+        const com::sun::star::uno::Reference<
+        com::sun::star::beans::XPropertySet> &rPropSet,
+        const com::sun::star::awt::Size& rSize);
+    sal_Bool WriteContents(SotStorageStreamRef &rObj,
+        const com::sun::star::uno::Reference<
+        com::sun::star::beans::XPropertySet> &rPropSet,
+        const com::sun::star::awt::Size& rSize);
+  */
+    static OCX_Control *Create() { return new HTML_TextBox;}
+
+        virtual sal_Bool Read(SotStorageStream *pS);
+        virtual sal_Bool ReadFontData(SotStorageStream *pS);
+};
+
+
+
 #endif
diff --git a/svx/source/msfilter/msocximex.cxx b/svx/source/msfilter/msocximex.cxx
index d132dc0..5e93ddf 100644
--- a/svx/source/msfilter/msocximex.cxx
+++ b/svx/source/msfilter/msocximex.cxx
@@ -4125,7 +4125,8 @@ OCX_map aOCXTab[] =
     {&OCX_GroupBox::Create,"",
         form::FormComponentType::GROUPBOX,""},
     {&OCX_ProgressBar::Create,"",
-        form::FormComponentType::CONTROL,""}
+        form::FormComponentType::CONTROL,""},
+    {&HTML_TextBox::Create,"5512D124-5CC6-11CF-8d67-00aa00bdce1d", form::FormComponentType::TEXTFIELD,"TextBox"},
 };
 
 const int NO_OCX = sizeof( aOCXTab ) / sizeof( *aOCXTab );
@@ -5620,6 +5621,105 @@ sal_Bool OCX_SpinButton::WriteData( SvStream& rStrm ) const
 
 // ============================================================================
 
+
+
+
+sal_Bool HTML_TextBox::Import(com::sun::star::uno::Reference<
+    com::sun::star::beans::XPropertySet> &rPropSet)
+{
+    uno::Any aTmp(&sName,getCppuType((OUString *)0));
+    rPropSet->setPropertyValue( WW8_ASCII2STR("Name"), aTmp );
+
+    aTmp = bool2any( fEnabled != 0 );
+    rPropSet->setPropertyValue( WW8_ASCII2STR("Enabled"), aTmp);
+
+    aTmp = bool2any( fLocked != 0 );
+    rPropSet->setPropertyValue( WW8_ASCII2STR("ReadOnly"), aTmp);
+
+    aTmp = bool2any( fHideSelection != 0 );
+    rPropSet->setPropertyValue( WW8_ASCII2STR( "HideInactiveSelection" ), aTmp);
+
+    aTmp <<= ImportColor(mnForeColor);
+    rPropSet->setPropertyValue( WW8_ASCII2STR("TextColor"), aTmp);
+
+    aTmp <<= ImportColor(mnBackColor);
+    rPropSet->setPropertyValue( WW8_ASCII2STR("BackgroundColor"), aTmp);
+
+    aTmp <<= ImportBorder(nSpecialEffect,nBorderStyle);
+    rPropSet->setPropertyValue( WW8_ASCII2STR("Border"), aTmp);
+
+    aTmp <<= ImportColor( nBorderColor );
+    rPropSet->setPropertyValue( WW8_ASCII2STR("BorderColor"), aTmp);
+
+    aTmp = bool2any( fMultiLine != 0 );
+    rPropSet->setPropertyValue( WW8_ASCII2STR("MultiLine"), aTmp);
+
+    sal_uInt16 nTmp = static_cast<sal_uInt16>(nMaxLength);
+    aTmp <<= nTmp;
+    rPropSet->setPropertyValue( WW8_ASCII2STR("MaxTextLen"), aTmp);
+
+
+    sal_Bool bTemp1,bTemp2;
+    uno::Any aBarsH,aBarsV;
+    switch(nScrollBars)
+    {
+        case 1:
+            bTemp1 = sal_True;
+            bTemp2 = sal_False;
+            break;
+        case 2:
+            bTemp1 = sal_False;
+            bTemp2 = sal_True;
+            break;
+        case 3:
+            bTemp1 = sal_True;
+            bTemp2 = sal_True;
+            break;
+        case 0:
+        default:
+            bTemp1 = sal_False;
+            bTemp2 = sal_False;
+            break;
+    }
+
+    aBarsH = bool2any(bTemp1);
+    aBarsV = bool2any(bTemp2);
+    rPropSet->setPropertyValue( WW8_ASCII2STR("HScroll"), aBarsH);
+    rPropSet->setPropertyValue( WW8_ASCII2STR("VScroll"), aBarsV);
+
+    nTmp = nPasswordChar;
+    aTmp <<= nTmp;
+    rPropSet->setPropertyValue( WW8_ASCII2STR("EchoChar"), aTmp);
+
+    if (pValue)
+    {
+        aTmp <<= lclCreateOUString( pValue, nValueLen );
+        // DefaultText seems to no longer be in UnoEditControlModel
+        if ( bSetInDialog )
+        {
+            rPropSet->setPropertyValue( WW8_ASCII2STR("Text"), aTmp);
+        }
+        else
+        {
+            rPropSet->setPropertyValue( WW8_ASCII2STR("DefaultText"), aTmp);
+        }
+    }
+
+    //	aFontData.Import(rPropSet);
+    return sal_True;
+}
+
+sal_Bool HTML_TextBox::Read(SotStorageStream *pS)
+{
+  return sal_True;
+}
+
+sal_Bool HTML_TextBox::ReadFontData(SotStorageStream *pS)
+{
+  return sal_True;
+}
+
+
 OCX_ScrollBar::OCX_ScrollBar()
 {
     sName = OUString( RTL_CONSTASCII_USTRINGPARAM( "ScrollBar" ) );
diff --git a/sw/source/filter/ww8/ww8par.hxx b/sw/source/filter/ww8/ww8par.hxx
index be299cf..a1458c7 100644
--- a/sw/source/filter/ww8/ww8par.hxx
+++ b/sw/source/filter/ww8/ww8par.hxx
@@ -1580,6 +1580,8 @@ public:     // eigentlich private, geht aber leider nur public
     eF_ResT Read_F_OCX(WW8FieldDesc*, String&);
     eF_ResT Read_F_Hyperlink(WW8FieldDesc*, String& rStr);
         eF_ResT Read_F_Shape(WW8FieldDesc* pF, String& rStr);
+    eF_ResT Read_F_HTMLControl( WW8FieldDesc* pF, String& rStr);
+
 
     void DeleteFormImpl();
 
diff --git a/sw/source/filter/ww8/ww8par3.cxx b/sw/source/filter/ww8/ww8par3.cxx
index 991b47f..0cd7bd3 100644
--- a/sw/source/filter/ww8/ww8par3.cxx
+++ b/sw/source/filter/ww8/ww8par3.cxx
@@ -325,6 +325,14 @@ eF_ResT SwWW8ImplReader::Read_F_FormListBox( WW8FieldDesc* pF, String& rStr)
     }
 }
 
+eF_ResT SwWW8ImplReader::Read_F_HTMLControl( WW8FieldDesc* pF, String& rStr)
+{
+    if( bObj && nPicLocFc )
+        nObjLocFc = nPicLocFc;
+    bEmbeddObj = true;
+    return FLD_TEXT;
+}
+
 void SwWW8ImplReader::DeleteFormImpl()
 {
     delete pFormImpl, pFormImpl = 0;
diff --git a/sw/source/filter/ww8/ww8par5.cxx b/sw/source/filter/ww8/ww8par5.cxx
index 6382073..cb1d559 100644
--- a/sw/source/filter/ww8/ww8par5.cxx
+++ b/sw/source/filter/ww8/ww8par5.cxx
@@ -916,7 +916,7 @@ long SwWW8ImplReader::Read_Field(WW8PLCFManResult* pRes)
         &SwWW8ImplReader::Read_F_Hyperlink,         // 88
         0,                                          // 89
         0,                                          // 90
-        0,                                          // 91
+        &SwWW8ImplReader::Read_F_HTMLControl,       // 91
         0,                                          // 92
         0,                                          // 93
         0,                                          // 94
-- 
1.7.0.1

