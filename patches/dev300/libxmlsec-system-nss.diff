--- /dev/null	2007-04-20 17:59:41.000000000 +0200
+++ libxmlsec/xmlsec1-1.2.12-broken-system-nss.patch	2009-10-29 13:35:21.000000000 +0100
@@ -0,0 +1,26 @@
+--- misc/xmlsec1-1.2.12/configure.in.old	2009-10-29 13:33:02.000000000 +0100
++++ misc/build/xmlsec1-1.2.12/configure.in	2009-10-29 13:33:32.000000000 +0100
+@@ -539,6 +539,11 @@ elif test "z$with_nss" = "z" -a "z$with_
+     dnl We are going to try all options
+     dnl
+     if test "z$NSS_FOUND" = "zno" ; then
++        PKG_CHECK_MODULES(NSS, nspr >= $MOZILLA_MIN_VERSION nss >= $MOZILLA_MIN_VERSION,
++    	    [NSS_FOUND=yes NSPR_PACKAGE=nspr NSS_PACKAGE=nss],
++	    [NSS_FOUND=no])
++    fi
++    if test "z$NSS_FOUND" = "zno" ; then
+         PKG_CHECK_MODULES(NSS, $MOZ_FLAVOUR-nspr >= $MOZILLA_MIN_VERSION $MOZ_FLAVOUR >= $MOZILLA_MIN_VERSION,
+     	    [NSS_FOUND=yes NSPR_PACKAGE=$MOZ_FLAVOUR-nspr NSS_PACKAGE=$MOZ_FLAVOUR-nss],
+ 	    [NSS_FOUND=no])
+@@ -553,11 +558,6 @@ elif test "z$with_nss" = "z" -a "z$with_
+     	    [NSS_FOUND=yes NSPR_PACKAGE=xulrunner-nspr NSS_PACKAGE=xulrunner-nss],
+ 	    [NSS_FOUND=no])
+     fi
+-    if test "z$NSS_FOUND" = "zno" ; then
+-        PKG_CHECK_MODULES(NSS, nspr >= $MOZILLA_MIN_VERSION nss >= $MOZILLA_MIN_VERSION,
+-    	    [NSS_FOUND=yes NSPR_PACKAGE=nspr NSS_PACKAGE=nss],
+-	    [NSS_FOUND=no])
+-    fi
+ fi
+ 
+ if test "z$NSS_FOUND" = "zno" ; then 
--- libxmlsec/makefile.mk.old	2009-10-15 14:52:41.000000000 +0200
+++ libxmlsec/makefile.mk	2009-10-28 22:09:40.000000000 +0100
@@ -65,7 +65,8 @@ PATCH_FILES=\
    xmlsec1-nssmangleciphers.patch \
    xmlsec1-noverify.patch \
    xmlsec1-mingw32.patch \
-   xmlsec1-mingw-keymgr-mscrypto.patch
+   xmlsec1-mingw-keymgr-mscrypto.patch \
+   xmlsec1-1.2.12-broken-system-nss.patch
 
 
 ADDITIONAL_FILES= \
@@ -153,7 +154,7 @@ LDFLAGS:=$(xmlsec_LDFLAGS)
 
 .ENDIF
 CONFIGURE_DIR=
-CONFIGURE_ACTION=.$/configure ADDCFLAGS="$(xmlsec_CFLAGS)" CPPFLAGS="$(xmlsec_CPPFLAGS)"
+CONFIGURE_ACTION=autoconf && .$/configure ADDCFLAGS="$(xmlsec_CFLAGS)" CPPFLAGS="$(xmlsec_CPPFLAGS)"
 CONFIGURE_FLAGS=--with-pic --disable-shared --disable-crypto-dl --with-libxslt=no --with-openssl=no --with-gnutls=no LIBXML2LIB="$(LIBXML2LIB)"
 # system-mozilla needs pkgconfig to get the information about nss
 # FIXME: This also will enable pkg-config usage for libxml2. It *seems*
