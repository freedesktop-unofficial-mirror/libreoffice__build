From abb233e01ab4ba0c13b084819432d4c45a2f3981 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:00:50 +0200
Subject: [PATCH 427/878] oox-pptx-import-fix-transition-auto-advance.diff

---
 oox/inc/oox/ppt/slidetransition.hxx       |    3 +++
 oox/source/ppt/slidetransition.cxx        |    8 ++++++--
 oox/source/ppt/slidetransitioncontext.cxx |    7 ++-----
 oox/source/token/properties.txt           |    2 ++
 4 files changed, 13 insertions(+), 7 deletions(-)

diff --git a/oox/inc/oox/ppt/slidetransition.hxx b/oox/inc/oox/ppt/slidetransition.hxx
index df2eed4..4a833d7 100644
--- a/oox/inc/oox/ppt/slidetransition.hxx
+++ b/oox/inc/oox/ppt/slidetransition.hxx
@@ -51,6 +51,8 @@ namespace oox { namespace ppt {
             { mnFadeColor = nColor; }
         void setMode( sal_Bool bMode )
             { mbMode = bMode; }
+            void setOoxAdvanceTime( sal_Int32 nAdvanceTime )
+                { mnAdvanceTime = nAdvanceTime; }
 
     static sal_Int16 ooxToOdpDirection( ::sal_Int32 nOoxType );
     static sal_Int16 ooxToOdpEightDirections( ::sal_Int32 nOoxType );
@@ -68,6 +70,7 @@ namespace oox { namespace ppt {
         ::sal_Int16 mnAnimationSpeed;
         ::sal_Int32 mnFadeColor;
         ::sal_Bool  mbMode; /**< http://api.openoffice.org/docs/common/ref/com/sun/star/animations/XTransitionFilter.html Mode property */
+        ::sal_Int32 mnAdvanceTime;
     };
 
 } }
diff --git a/oox/source/ppt/slidetransition.cxx b/oox/source/ppt/slidetransition.cxx
index ee889e1..b72f659 100644
--- a/oox/source/ppt/slidetransition.cxx
+++ b/oox/source/ppt/slidetransition.cxx
@@ -56,6 +56,7 @@ namespace oox { namespace ppt {
         , mnAnimationSpeed( AnimationSpeed_FAST )
         , mnFadeColor( 0 )
         , mbMode( true )
+        , mnAdvanceTime( -1 )
     {
 
     }
@@ -68,6 +69,7 @@ namespace oox { namespace ppt {
         , mnAnimationSpeed( AnimationSpeed_FAST )
         , mnFadeColor( 0 )
         , mbMode( true )
+        , mnAdvanceTime( -1 )
     {
         const transition *p = transition::find( sFilterName );
         if( p )
@@ -88,6 +90,10 @@ namespace oox { namespace ppt {
             aProps[ PROP_TransitionDirection ] <<= mbTransitionDirectionNormal;
             aProps[ PROP_Speed ] <<= mnAnimationSpeed;
             aProps[ PROP_TransitionFadeColor ] <<= mnFadeColor;
+        if( mnAdvanceTime != -1 ) {
+        aProps[ PROP_Duration ] <<= mnAdvanceTime/1000;
+        aProps[ PROP_Change ] <<= static_cast<sal_Int32>(1);
+        }
         }
         catch( Exception& )
         {
@@ -138,8 +144,6 @@ namespace oox { namespace ppt {
         }
     }
 
-
-
     sal_Int16 SlideTransition::ooxToOdpEightDirections( ::sal_Int32 nOoxType )
     {
     sal_Int16 nOdpDirection;
diff --git a/oox/source/ppt/slidetransitioncontext.cxx b/oox/source/ppt/slidetransitioncontext.cxx
index 102e13c..87cbb49 100644
--- a/oox/source/ppt/slidetransitioncontext.cxx
+++ b/oox/source/ppt/slidetransitioncontext.cxx
@@ -67,12 +67,9 @@ SlideTransitionContext::SlideTransitionContext( ContextHandler& rParent, const R
     attribs.getBool( XML_advClick, true );
 
     // careful. if missing, no auto advance... 0 looks like a valid value
-  // for auto advance
+    // for auto advance
     if(attribs.hasAttribute( XML_advTm ))
-    {
-        // TODO
-        xAttribs->getOptionalValue( XML_advTm );
-    }
+        maTransition.setOoxAdvanceTime( attribs.getInteger( XML_advTm, -1 ) );
 }
 
 SlideTransitionContext::~SlideTransitionContext() throw()
diff --git a/oox/source/token/properties.txt b/oox/source/token/properties.txt
index 159820f..f9966bf 100644
--- a/oox/source/token/properties.txt
+++ b/oox/source/token/properties.txt
@@ -37,6 +37,7 @@ CellProtection
 CellStyle
 CenterHorizontally
 CenterVertically
+Change
 CharCaseMap
 CharColor
 CharContoured
@@ -107,6 +108,7 @@ DiagonalTLBR
 DisplayLabels
 DrillDownOnDoubleClick
 Dropdown
+Duration
 EchoChar
 EdgeKind
 Enabled
-- 
1.7.0.1

