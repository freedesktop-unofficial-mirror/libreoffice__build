From 065a3accab21285e96b27b2e7b537ff2317cca2c Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:56:57 +0200
Subject: [PATCH 236/878] calc-perf-rowheight-no-progress-bar.diff

---
 sc/source/core/data/table1.cxx |   19 ++++++++++++++-----
 1 files changed, 14 insertions(+), 5 deletions(-)

diff --git a/sc/source/core/data/table1.cxx b/sc/source/core/data/table1.cxx
index 81c8353..8b0c801 100644
--- a/sc/source/core/data/table1.cxx
+++ b/sc/source/core/data/table1.cxx
@@ -341,12 +341,21 @@ BOOL ScTable::SetOptimalHeight( SCROW nStartRow, SCROW nEndRow, USHORT nExtra,
     BOOL    bChanged = FALSE;
     SCSIZE  nCount = static_cast<SCSIZE>(nEndRow-nStartRow+1);
 
+    ULONG nTotalCount = GetWeightedCount();
     ScProgress* pProgress = NULL;
-    if ( pOuterProgress )
-        pProgress = pOuterProgress;
-    else if ( nCount > 1 )
-        pProgress = new ScProgress( pDocument->GetDocumentShell(),
-                            ScGlobal::GetRscString(STR_PROGRESS_HEIGHTING), GetWeightedCount() );
+    if (nTotalCount >= 1000)
+    {
+        // if the total number of rows is less than 1000, don't even bother
+        // with the progress bar because drawing progress bar can be very
+        // expensive especially in GTK.
+
+        if ( pOuterProgress )
+            pProgress = pOuterProgress;
+        else if ( nCount > 1 )
+            pProgress = new ScProgress(
+                pDocument->GetDocumentShell(),
+                ScGlobal::GetRscString(STR_PROGRESS_HEIGHTING), nTotalCount );
+    }
 
     USHORT* pHeight = new USHORT[nCount];                   // Twips !
     memset( pHeight, 0, sizeof(USHORT) * nCount );
-- 
1.7.0.1

