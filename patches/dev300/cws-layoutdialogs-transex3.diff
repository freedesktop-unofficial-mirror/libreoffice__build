Index: transex3/layout/layoutparse.cxx
===================================================================
RCS file: /cvs/l10n/transex3/layout/layoutparse.cxx,v
retrieving revision 1.2
retrieving revision 1.2.2.4
diff -p -u -u -p -b -w -B -r1.2 -r1.2.2.4
--- transex3/layout/layoutparse.cxx	6 Mar 2008 12:35:12 -0000	1.2
+++ transex3/layout/layoutparse.cxx	30 Jul 2008 11:29:33 -0000	1.2.2.4
@@ -1,3 +1,34 @@
+/*************************************************************************
+ *
+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
+ * 
+ * Copyright 2008 by Sun Microsystems, Inc.
+ *
+ * OpenOffice.org - a multi-platform office productivity suite
+ *
+ * $RCSfile$
+ *
+ * $Revision$
+ *
+ * This file is part of OpenOffice.org.
+ *
+ * OpenOffice.org is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Lesser General Public License version 3
+ * only, as published by the Free Software Foundation.
+ *
+ * OpenOffice.org is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Lesser General Public License version 3 for more details
+ * (a copy is included in the LICENSE file that accompanied this code).
+ *
+ * You should have received a copy of the GNU Lesser General Public License
+ * version 3 along with OpenOffice.org.  If not, see
+ * <http://www.openoffice.org/license.html>
+ * for a copy of the LGPLv3 License.
+ *
+ ************************************************************************/
+
 #include "layoutparse.hxx"
 
 #define STRING( str ) String( str, RTL_TEXTENCODING_UTF8 )
@@ -20,6 +51,8 @@ LayoutXMLFile::SearchL10NElements( XMLPa
         for ( ULONG i = 0; i < lst->Count(); i++ )
             if ( lst->GetObject( i )->GetNodeType() == XML_NODE_TYPE_ELEMENT )
                 HandleElement( ( XMLElement* )lst->GetObject( i ) );
+            else if ( lst->GetObject( i )->GetNodeType() == XML_NODE_TYPE_COMMENT )
+                lst->Remove( i-- );
 }
 
 std::vector<XMLAttribute*>
@@ -42,13 +75,14 @@ LayoutXMLFile::HandleElement( XMLElement
     
     if ( interesting.size() )
     {
-        ByteString id = BSTRING( interesting[0]->GetValue() );
+        std::vector<XMLAttribute*>::iterator i = interesting.begin();
+
+        ByteString id = BSTRING( (*i++)->GetValue() );
 
         if ( mMergeMode )
             InsertL10NElement( id, element );
         else
-            for ( std::vector<XMLAttribute*>::iterator i = ++interesting.begin();
-                  i != interesting.end(); ++i )
+            for ( ; i != interesting.end(); ++i )
             {
                 ByteString attributeId = id;
                 ByteString value = BSTRING( ( *i )->GetValue() );
Index: transex3/layout/layoutparse.hxx
===================================================================
RCS file: /cvs/l10n/transex3/layout/layoutparse.hxx,v
retrieving revision 1.2
retrieving revision 1.2.2.3
diff -p -u -u -p -b -w -B -r1.2 -r1.2.2.3
--- transex3/layout/layoutparse.hxx	6 Mar 2008 12:35:24 -0000	1.2
+++ transex3/layout/layoutparse.hxx	30 Jul 2008 11:29:33 -0000	1.2.2.3
@@ -1,3 +1,34 @@
+/*************************************************************************
+ *
+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
+ * 
+ * Copyright 2008 by Sun Microsystems, Inc.
+ *
+ * OpenOffice.org - a multi-platform office productivity suite
+ *
+ * $RCSfile$
+ *
+ * $Revision$
+ *
+ * This file is part of OpenOffice.org.
+ *
+ * OpenOffice.org is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Lesser General Public License version 3
+ * only, as published by the Free Software Foundation.
+ *
+ * OpenOffice.org is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Lesser General Public License version 3 for more details
+ * (a copy is included in the LICENSE file that accompanied this code).
+ *
+ * You should have received a copy of the GNU Lesser General Public License
+ * version 3 along with OpenOffice.org.  If not, see
+ * <http://www.openoffice.org/license.html>
+ * for a copy of the LGPLv3 License.
+ *
+ ************************************************************************/
+
 #ifndef LAYOUTPARSE_HXX
 #define LAYOUTPARSE_HXX
 
@@ -14,6 +45,9 @@ public:
     BOOL Write( ByteString &aFilename );
     void HandleElement( XMLElement* element );
     void InsertL10NElement( ByteString const& id, XMLElement* element );
+
+    using XMLFile::InsertL10NElement;
+    using XMLFile::Write;
 };
 
 std::vector<XMLAttribute*> interestingAttributes( XMLAttributeList* lst );
Index: transex3/layout/makefile.mk
===================================================================
RCS file: /cvs/l10n/transex3/layout/makefile.mk,v
retrieving revision 1.2
retrieving revision 1.2.2.5
diff -p -u -u -p -b -w -B -r1.2 -r1.2.2.5
--- transex3/layout/makefile.mk	6 Mar 2008 12:36:23 -0000	1.2
+++ transex3/layout/makefile.mk	30 Jul 2008 11:29:33 -0000	1.2.2.5
@@ -1,3 +1,34 @@
+#*************************************************************************
+#
+# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
+# 
+# Copyright 2008 by Sun Microsystems, Inc.
+#
+# OpenOffice.org - a multi-platform office productivity suite
+#
+# $RCSfile$
+#
+# $Revision$
+#
+# This file is part of OpenOffice.org.
+#
+# OpenOffice.org is free software: you can redistribute it and/or modify
+# it under the terms of the GNU Lesser General Public License version 3
+# only, as published by the Free Software Foundation.
+#
+# OpenOffice.org is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU Lesser General Public License version 3 for more details
+# (a copy is included in the LICENSE file that accompanied this code).
+#
+# You should have received a copy of the GNU Lesser General Public License
+# version 3 along with OpenOffice.org.  If not, see
+# <http://www.openoffice.org/license.html>
+# for a copy of the LGPLv3 License.
+#
+#*************************************************************************
+
 PRJ=..
 
 INCPRE=$(MISC)
@@ -20,14 +51,8 @@ CFLAGS+=-DSYSTEM_EXPAT
 
 # --- Files --------------------------------------------------------
 
-CXXFILES=\
-	layoutparse.cxx\
-	tralay.cxx
-
 APP1TARGET=$(TARGET)
 
-.IF "$(ENABLE_LAYOUT)" == "TRUE"
-
 OBJFILES =\
 	$(OBJ)/export2.obj\
 	$(OBJ)/helpmerge.obj\
@@ -39,29 +64,18 @@ OBJFILES =\
 APP1OBJS = $(OBJFILES)
 
 APP1STDLIBS =\
-	$(EXPATASCII3RDLIB)\
 	$(TOOLSLIB)\
-	$(VOSLIB)
+	$(EXPATASCII3RDLIB)\
+	$(VOSLIB)\
+	$(CPPULIB) \
+	$(SALLIB)	
 
 # --- Targets ------------------------------------------------------
 
 .INCLUDE :  target.mk
 
 test .PHONY:
-	../$(INPATH)/bin/tralay -l en-US zoom.xml > out.sdf
+	../$(INPATH)/bin/tralay -l en-US -o out.sdf zoom.xml
 	cat out.sdf > trans.sdf
 	sed 's/en-US\t/de\tde:/' out.sdf >> trans.sdf 
-	../$(INPATH)/bin/tralay -m trans.sdf -l de zoom.xml #> zoom-DE.xml
-
-.ELSE # ENABLE_LAYOUT != TRUE
-
-$(BIN)$/$(APP1TARGET)$(EXECPOST):
-	touch $@
-
-ALLTAR:
-all:
-check:
-clean:
-
-.ENDIF # ENABLE_LAYOUT != TRUE
-
+	../$(INPATH)/bin/tralay -m trans.sdf -l de -o zoom-DE.xml zoom.xml
Index: transex3/layout/tralay.cxx
===================================================================
RCS file: /cvs/l10n/transex3/layout/tralay.cxx,v
retrieving revision 1.2
retrieving revision 1.2.2.8
diff -p -u -u -p -b -w -B -r1.2 -r1.2.2.8
--- transex3/layout/tralay.cxx	6 Mar 2008 12:36:58 -0000	1.2
+++ transex3/layout/tralay.cxx	30 Jul 2008 11:29:33 -0000	1.2.2.8
@@ -1,6 +1,39 @@
+/*************************************************************************
+ *
+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
+ * 
+ * Copyright 2008 by Sun Microsystems, Inc.
+ *
+ * OpenOffice.org - a multi-platform office productivity suite
+ *
+ * $RCSfile$
+ *
+ * $Revision$
+ *
+ * This file is part of OpenOffice.org.
+ *
+ * OpenOffice.org is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Lesser General Public License version 3
+ * only, as published by the Free Software Foundation.
+ *
+ * OpenOffice.org is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Lesser General Public License version 3 for more details
+ * (a copy is included in the LICENSE file that accompanied this code).
+ *
+ * You should have received a copy of the GNU Lesser General Public License
+ * version 3 along with OpenOffice.org.  If not, see
+ * <http://www.openoffice.org/license.html>
+ * for a copy of the LGPLv3 License.
+ *
+ ************************************************************************/
+
 #include <com/sun/star/xml/sax/SAXException.hpp>
 #include <transex3/vosapp.hxx>
 
+#include <osl/file.hxx>
+
 #include "export.hxx"
 #include "layoutparse.hxx"
 #include "helpmerge.hxx"
@@ -12,7 +45,9 @@
 #define STRING( str ) String( str, RTL_TEXTENCODING_UTF8 )
 #define BSTRING( str ) ByteString( str, RTL_TEXTENCODING_UTF8 )
 
-using namespace ::rtl;
+using ::rtl::OUString;
+
+using namespace ::osl;
 using namespace ::com::sun::star;
 using namespace ::com::sun::star::uno;
 
@@ -31,7 +66,7 @@ class TranslateLayout : public Applicati
 
 public:
     TranslateLayout();
-    ~TranslateLayout();
+    virtual ~TranslateLayout();
     ByteString GetCommandLineParam( int i );
     ByteString GetOptionArgument( int const i );
     void ExceptionalMain();
@@ -40,6 +75,8 @@ public:
     void MergeLanguage( ByteString const& language );
     void ParseCommandLine();
     void CreateSDF();
+
+    using Application::GetCommandLineParam;
 };
 
 static void usage()
@@ -55,9 +92,29 @@ static void usage()
     exit( 2 );
 }
 
+static ByteString ConvertSystemPath( const ByteString& rPath )
+{
+    if( rPath.CompareTo( ".", 1 ) == 0 )
+    {
+        OUString sPath( rPath.GetBuffer(), rPath.Len(), RTL_TEXTENCODING_UTF8 );
+
+        ::rtl::OUString curDirPth, sURL;
+        osl_getProcessWorkingDir( &curDirPth.pData );
+
+        ::osl::FileBase::getAbsoluteFileURL( curDirPth, sPath, sURL );
+        ::osl::FileBase::getSystemPathFromFileURL( sURL, sPath );
+
+        return ByteString( rtl::OUStringToOString( sPath, RTL_TEXTENCODING_UTF8 ) );
+    }
+    else
+    {
+        return rPath;
+    }
+}
+
 ByteString TranslateLayout::GetCommandLineParam( int i )
 {
-    return ByteString( OUSTRING_CSTR( Application::GetCommandLineParam( i ) ) );
+    return ByteString( OUSTRING_CSTR( Application::GetCommandLineParam( sal::static_int_cast< USHORT >( i ) ) ) );
 }
 
 ByteString TranslateLayout::GetOptionArgument( int const i )
@@ -90,14 +147,14 @@ void TranslateLayout::ParseCommandLine()
             mLocalize = GetOptionArgument( ++i );
         }
         else if ( aParam.Equals( "-o" ) || aParam.Equals( "--output" ) )
-            mOutput = GetOptionArgument( ++i );
+            mOutput = ConvertSystemPath( GetOptionArgument( ++i ) );
         else if ( !aParam.CompareTo( "-", 1 ) )
         {
             fprintf( stderr, "error: No such option: %s\n", aParam.GetBuffer() );
             usage();
         }
         else
-            mFiles.push_back( aParam );
+            mFiles.push_back( ConvertSystemPath( aParam ) );
     }
     if ( !mFiles.size() )
     {
@@ -129,10 +186,14 @@ translateElement( XMLElement* element, B
                   ResData* resData, MergeDataFile& mergeData )
 {
     XMLAttributeList* attributes = element->GetAttributeList();
-    std::vector<XMLAttribute*> interesting = interestingAttributes( attributes );
-    ByteString id = BSTRING( interesting[0]->GetValue() );
-    for ( std::vector<XMLAttribute*>::iterator i = ++interesting.begin();
-          i != interesting.end(); ++i )
+    std::vector<XMLAttribute*> interesting( interestingAttributes( attributes ) );
+
+
+    if( !interesting.empty() )
+    {
+        std::vector<XMLAttribute*>::iterator i( interesting.begin() );
+        ByteString id = BSTRING( (*i++)->GetValue() );
+        for ( ; i != interesting.end(); ++i )
     {
         ByteString attributeId = id;
         attributeId += BSTRING ( **i );
@@ -154,24 +215,47 @@ translateElement( XMLElement* element, B
         }
     }
 }
+}
 
 static bool is_dir( ByteString const& name )
 {
-    if (DIR* dir = opendir( name.GetBuffer() ) )
+    DirectoryItem aItem;
+    OUString sFileURL( name.GetBuffer(), name.Len(), RTL_TEXTENCODING_UTF8 );
+    FileBase::getFileURLFromSystemPath( sFileURL, sFileURL );
+    if( DirectoryItem::get( sFileURL, aItem ) == FileBase::E_None )
+    {
+        FileStatus aStatus(FileStatusMask_Type);
+        if( aItem.getFileStatus( aStatus ) == FileBase::E_None )
     {
-        closedir( dir );
+            if( aStatus.getFileType() == FileStatus::Directory )
         return true;
     }
+    }
     return false;
 }
 
 static void make_directory( ByteString const& name )
 {
-#ifdef WNT
-    _mkdir( name.GetBuffer() );
-#else
-    mkdir( name.GetBuffer() , S_IRWXU | S_IRWXG | S_IROTH | S_IXOTH );
-#endif
+    OUString sFileURL( name.GetBuffer(), name.Len(), RTL_TEXTENCODING_UTF8 );
+    FileBase::getFileURLFromSystemPath( sFileURL, sFileURL );
+    Directory::create( sFileURL );
+}
+
+static void insertMarker( XMLParentNode *p, ByteString const& file )
+{
+    if ( XMLChildNodeList* lst = p->GetChildList() )
+        if ( lst->Count() )
+        {
+            ULONG i = 1;
+            // Skip newline, if possible.
+            if ( lst->Count() > 1
+                 && lst->GetObject( 2 )->GetNodeType() == XML_NODE_TYPE_DEFAULT )
+                i++;
+            OUString marker = OUString::createFromAscii( "\n    NOTE: This file has been generated automagically by transex3/layout/tralay,\n          from source template: " )
+                + STRING( file )
+                + OUString::createFromAscii( ".\n          Do not edit, changes will be lost.\n" );
+            lst->Insert( new XMLComment( marker, 0 ), i );
+        }
 }
 
 void TranslateLayout::MergeLanguage( ByteString const& language )
@@ -190,6 +274,7 @@ void TranslateLayout::MergeLanguage( Byt
     }
     
     layoutXml->Extract();
+    insertMarker( layoutXml, xmlFile );
 
     ResData	resData( "", "", "" );
     resData.sResTyp = mProject; /* mGid1 ?? */
@@ -204,7 +289,11 @@ void TranslateLayout::MergeLanguage( Byt
                 translateElement( element, language, &resData, mergeData );
     }
     
+#ifndef WNT
     ByteString outFile = "/dev/stdout";
+#else
+    ByteString outFile = "\\\\.\\CON";
+#endif
     if ( mOutput.Len() )
     {
         outFile = mOutput;
@@ -235,7 +324,11 @@ void TranslateLayout::Merge()
 void TranslateLayout::CreateSDF()
 {
     ByteString xmlFile = mFiles.front();
+#ifndef WNT
     ByteString sdf = "/dev/stdout";
+#else
+    ByteString sdf = "\\\\.\\CON";
+#endif
     if ( mOutput.Len() )
         sdf = mOutput;
     Export::SetLanguages( mLanguages );
@@ -289,7 +382,7 @@ TranslateLayout::TranslateLayout()
     , mLocalize( "localize.sdf" )
     , mOutput()
     , mProject( "layout" )
-    , mRoot( "/root" )
+    , mRoot()
     , mMergeMode( false )
     , mLanguages()
     , mFiles()
Index: transex3/layout/zoom.xml
===================================================================
RCS file: /cvs/l10n/transex3/layout/zoom.xml,v
retrieving revision 1.2
retrieving revision 1.2.2.1
diff -p -u -u -p -b -w -B -r1.2 -r1.2.2.1
--- transex3/layout/zoom.xml	6 Mar 2008 12:37:10 -0000	1.2
+++ transex3/layout/zoom.xml	4 Apr 2008 09:11:45 -0000	1.2.2.1
@@ -1,4 +1,7 @@
 <?xml version="1.0" encoding="UTF-8"?>
+<!-- This is a template.  i18n translation is not performed in-place;
+     i18n translated xml files are generated from this template by
+     transex3/layout/tralay.  !-->
 
 <modaldialog xmlns="http://openoffice.org/2007/layout"
              xmlns:cnt="http://openoffice.org/2007/layout/container"
