From cb197aad7f8580daab3efcd8aac3b9a372bb28e8 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:05:39 +0200
Subject: [PATCH 682/878] mail-document-subject.diff

---
 sfx2/source/dialog/mailmodel.cxx          |    8 +++++++-
 shell/source/win32/simplemail/senddoc.cxx |   17 ++++++++++++++---
 2 files changed, 21 insertions(+), 4 deletions(-)

diff --git a/sfx2/source/dialog/mailmodel.cxx b/sfx2/source/dialog/mailmodel.cxx
index e3f3db8..3a20264 100644
--- a/sfx2/source/dialog/mailmodel.cxx
+++ b/sfx2/source/dialog/mailmodel.cxx
@@ -848,7 +848,13 @@ SfxMailModel::SendMailResult SfxMailModel::Send( const css::uno::Reference< css:
 
                     Sequence< OUString > aAttachmentSeq(&(maAttachedDocuments[0]),maAttachedDocuments.size());
  
-                    xSimpleMailMessage->setSubject( maSubject );
+                    if ( xSimpleMailMessage->getSubject().getLength() == 0 ) {
+                        OUString baseName( maAttachedDocuments[0].copy( maAttachedDocuments[0].lastIndexOf( '/' ) + 1 ) );
+                        OUString subject( baseName );
+                        if ( maAttachedDocuments.size() > 1 )
+                            subject += OUString::createFromAscii( ", ..." );
+                        xSimpleMailMessage->setSubject( subject );
+                    }
                     xSimpleMailMessage->setAttachement( aAttachmentSeq );
 
                     sal_Bool bSend( sal_False );
diff --git a/shell/source/win32/simplemail/senddoc.cxx b/shell/source/win32/simplemail/senddoc.cxx
index 15f22a6..788bf96 100644
--- a/shell/source/win32/simplemail/senddoc.cxx
+++ b/shell/source/win32/simplemail/senddoc.cxx
@@ -29,9 +29,10 @@
 #include "precompiled_shell.hxx"
 #include <osl/diagnose.h>
 
-#ifndef _RTL_STRING_HXX_
 #include <rtl/string.hxx>
-#endif
+#include <rtl/ustring.hxx>
+#include <rtl/uri.hxx>
+#include <osl/thread.hxx>
 #include "simplemapi.hxx"
 
 #define WIN32_LEAN_AND_MEAN
@@ -167,7 +168,17 @@ void initMapiMessage(
 {
     ZeroMemory(pMapiMessage, sizeof(MapiMessage));
              
-    pMapiMessage->lpszSubject = const_cast<char*>(gSubject.c_str());   
+    try {
+         rtl_uString *subject = NULL;
+         rtl_uString_newFromAscii(&subject, const_cast<char*>(gSubject.c_str()));
+         rtl_uString *decoded_subject = NULL;
+         rtl_uriDecode(subject, rtl_UriDecodeWithCharset, RTL_TEXTENCODING_UTF8, &decoded_subject);
+         rtl::OUString ou_subject(decoded_subject);
+         pMapiMessage->lpszSubject = strdup(OUStringToOString(ou_subject, osl_getThreadTextEncoding(), RTL_UNICODETOTEXT_FLAGS_UNDEFINED_QUESTIONMARK).getStr());
+    }
+    catch (...) {
+    pMapiMessage->lpszSubject = const_cast<char*>(gSubject.c_str());
+    }
     pMapiMessage->lpszNoteText = (gBody.length() ? const_cast<char*>(gBody.c_str()) : NULL);
     pMapiMessage->lpOriginator = aMapiOriginator;       
     pMapiMessage->lpRecips = &aMapiRecipientList[0];
-- 
1.7.0.1

