From 60f77a6e386d6f6334c06947e7a10df9f190215f Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:09:25 +0200
Subject: [PATCH 758/768] toolbar-decorations-vcl.diff

---
 tools/inc/tools/wintypes.hxx             |    4 ++-
 vcl/inc/vcl/brdwin.hxx                   |    3 +-
 vcl/inc/vcl/floatwin.hxx                 |    3 +-
 vcl/source/app/settings.cxx              |    2 +-
 vcl/source/window/brdwin.cxx             |   40 +++++++++++++++++++++++++----
 vcl/source/window/floatwin.cxx           |    8 ++++-
 vcl/unx/gtk/gdi/salnativewidgets-gtk.cxx |    6 +++-
 vcl/unx/kde/salnativewidgets-kde.cxx     |    9 ++++--
 vcl/unx/kde4/KDESalFrame.cxx             |   15 ++++++-----
 9 files changed, 66 insertions(+), 24 deletions(-)

diff --git tools/inc/tools/wintypes.hxx tools/inc/tools/wintypes.hxx
index 391e34a..80d9bb1 100644
--- tools/inc/tools/wintypes.hxx
+++ tools/inc/tools/wintypes.hxx
@@ -190,6 +190,7 @@ typedef sal_Int64 WinBits;
 #define WB_OWNERDRAWDECORATION  ((WinBits)SAL_CONST_INT64(0x2000000000))
 #define WB_DEFAULTWIN           ((WinBits)SAL_CONST_INT64(0x4000000000))
 #define WB_NEEDSFOCUS           ((WinBits)SAL_CONST_INT64(0x1000000000))
+#define WB_POPUP                ((WinBits)SAL_CONST_INT64(0x20000000))
 
 #define WB_HSCROLL				WB_HORZ
 #define WB_VSCROLL				WB_VERT
@@ -271,6 +272,7 @@ typedef sal_Int64 WinBits;
 #define WB_STDMODAL 			(WB_STDDIALOG)
 #define WB_STDTABDIALOG 		(WB_STDDIALOG)
 #define WB_STDTABCONTROL		0
+#define WB_STDPOPUP				(WB_BORDER | WB_POPUP | WB_SYSTEMWINDOW | WB_3DLOOK | WB_DIALOGCONTROL)
 
 // For TreeListBox
 #define WB_HASBUTTONS			((WinBits)0x00800000)
diff --git vcl/inc/vcl/brdwin.hxx vcl/inc/vcl/brdwin.hxx
index d5ea7f8..1202f9a 100644
--- vcl/inc/vcl/brdwin.hxx
+++ vcl/inc/vcl/brdwin.hxx
@@ -84,7 +84,8 @@ class ImplBorderWindowView;
 #define BORDERWINDOW_TITLE_NORMAL			((USHORT)0x0001)
 #define BORDERWINDOW_TITLE_SMALL			((USHORT)0x0002)
 #define BORDERWINDOW_TITLE_TEAROFF			((USHORT)0x0004)
-#define BORDERWINDOW_TITLE_NONE 			((USHORT)0x0008)
+#define BORDERWINDOW_TITLE_POPUP			((USHORT)0x0008)
+#define BORDERWINDOW_TITLE_NONE 			((USHORT)0x0010)
 
 // --------------------
 // - ImplBorderWindow -
diff --git vcl/inc/vcl/floatwin.hxx vcl/inc/vcl/floatwin.hxx
index c0cfd57..51f1953 100644
--- vcl/inc/vcl/floatwin.hxx
+++ vcl/inc/vcl/floatwin.hxx
@@ -65,7 +65,8 @@ class PopupModeEvent;
 
 #define FLOATWIN_TITLE_NORMAL					((USHORT)0x0001)
 #define FLOATWIN_TITLE_TEAROFF					((USHORT)0x0002)
-#define FLOATWIN_TITLE_NONE 					((USHORT)0x0004)
+#define FLOATWIN_TITLE_POPUP					((USHORT)0x0004)
+#define FLOATWIN_TITLE_NONE 					((USHORT)0x0008)
 
 // ------------------
 // - FloatingWindow -
diff --git vcl/source/app/settings.cxx vcl/source/app/settings.cxx
index 467fdd1..ae995e0 100644
--- vcl/source/app/settings.cxx
+++ vcl/source/app/settings.cxx
@@ -562,8 +562,8 @@ void ImplStyleData::SetStandardStyles()
     maPushButtonFont            = aStdFont;
     maFieldFont                 = aStdFont;
     maIconFont                  = aStdFont;
-    maFloatTitleFont            = aStdFont;
     aStdFont.SetWeight( WEIGHT_BOLD );
+    maFloatTitleFont            = aStdFont;
     maTitleFont                 = aStdFont;
 
     maFaceColor                 = Color( COL_LIGHTGRAY );
diff --git vcl/source/window/brdwin.cxx vcl/source/window/brdwin.cxx
index dacf4ea..eed5cea 100644
--- vcl/source/window/brdwin.cxx
+++ vcl/source/window/brdwin.cxx
@@ -211,7 +211,7 @@ void ImplBorderWindowView::ImplInitTitle( ImplBorderFrameData* pData )
 {
     ImplBorderWindow* pBorderWindow = pData->mpBorderWindow;
 
-    if ( !(pBorderWindow->GetStyle() & WB_MOVEABLE) ||
+    if ( !(pBorderWindow->GetStyle() & (WB_MOVEABLE | WB_POPUP)) ||
           (pData->mnTitleType == BORDERWINDOW_TITLE_NONE) )
     {
         pData->mnTitleType	 = BORDERWINDOW_TITLE_NONE;
@@ -276,7 +276,7 @@ USHORT ImplBorderWindowView::ImplHitTest
 
         // no corner resize for floating toolbars, which would lead to jumps while formatting
         // setting nSizeWidth = 0 will only return pure left,top,right,bottom
-        if( pBorderWindow->GetStyle() & WB_OWNERDRAWDECORATION )
+        if( pBorderWindow->GetStyle() & (WB_OWNERDRAWDECORATION | WB_POPUP) )
             nSizeWidth = 0;
 
         if ( rPos.X() < pData->mnLeftBorder )
@@ -1495,7 +1495,7 @@ void ImplStdBorderWindowView::Init( OutputDevice* pDev, long nWidth, long nHeigh
     pData->mnTitleType		= pBorderWindow->mnTitleType;
     pData->mbFloatWindow	= pBorderWindow->mbFloatWindow;
 
-    if ( !(pBorderWindow->GetStyle() & WB_MOVEABLE) || (pData->mnTitleType == BORDERWINDOW_TITLE_NONE) )
+    if ( !(pBorderWindow->GetStyle() & (WB_MOVEABLE | WB_POPUP)) || (pData->mnTitleType == BORDERWINDOW_TITLE_NONE) )
         pData->mnBorderSize = 0;
     else if ( pData->mnTitleType == BORDERWINDOW_TITLE_TEAROFF )
         pData->mnBorderSize = 0;
@@ -1520,7 +1520,7 @@ void ImplStdBorderWindowView::Init( OutputDevice* pDev, long nWidth, long nHeigh
 
         // set a proper background for drawing
         // highlighted buttons in the title
-        pBorderWindow->SetBackground( rStyleSettings.GetWindowColor() );
+        pBorderWindow->SetBackground( rStyleSettings.GetFaceColor() );
 
         pData->maTitleRect.Left()	 = pData->mnLeftBorder;
         pData->maTitleRect.Right()	 = nWidth-pData->mnRightBorder-1;
@@ -1663,19 +1663,43 @@ void ImplStdBorderWindowView::DrawWindow( USHORT nDrawFlags, OutputDevice* pOutD
     Rectangle				aInRect( aTmpPoint, Size( pData->mnWidth, pData->mnHeight ) );
     const StyleSettings&	rStyleSettings = pData->mpOutDev->GetSettings().GetStyleSettings();
     DecorationView			aDecoView( pDev );
-    Color                   aFrameColor( rStyleSettings.GetFaceColor() );
+    Color                   aFaceColor( rStyleSettings.GetFaceColor() );
+    Color                   aFrameColor( aFaceColor );
 
     aFrameColor.DecreaseContrast( (UINT8) (0.50 * 255));
 
     // Draw Frame
     if ( nDrawFlags & BORDERWINDOW_DRAW_FRAME )
     {
+        Region oldClipRgn( pDev->GetClipRegion( ) );
+
+        // for popups, don't draw part of the frame
+        if ( pData->mnTitleType == BORDERWINDOW_TITLE_POPUP )
+        {
+            FloatingWindow *pWin = dynamic_cast< FloatingWindow* >( pData->mpBorderWindow->GetWindow( WINDOW_CLIENT ) );
+            if ( pWin )
+            {
+                Region aClipRgn( aInRect );
+                Rectangle aItemClipRect( pWin->ImplGetItemEdgeClipRect() );
+                if( !aItemClipRect.IsEmpty() )
+                {
+                    aItemClipRect.SetPos( pData->mpBorderWindow->AbsoluteScreenToOutputPixel( aItemClipRect.TopLeft() ) );
+                    aClipRgn.Exclude( aItemClipRect );
+                    pDev->SetClipRegion( aClipRgn );
+                }
+            }
+        }
+
         // single line frame
         pDev->SetLineColor( aFrameColor );
         pDev->SetFillColor();
         pDev->DrawRect( aInRect );
         aInRect.nLeft++; aInRect.nRight--;
         aInRect.nTop++; aInRect.nBottom--;
+
+        // restore
+        if ( pData->mnTitleType == BORDERWINDOW_TITLE_POPUP )
+            pDev->SetClipRegion( oldClipRgn );
     }
     else
         aInRect = aDecoView.DrawFrame( aInRect, FRAME_DRAW_DOUBLEOUT | FRAME_DRAW_NODRAW);
@@ -1702,7 +1726,11 @@ void ImplStdBorderWindowView::DrawWindow( USHORT nDrawFlags, OutputDevice* pOutD
         aInRect = pData->maTitleRect;
 
         // use no gradient anymore, just a static titlecolor
-        pDev->SetFillColor( aFrameColor );
+        if ( pData->mnTitleType != BORDERWINDOW_TITLE_POPUP )
+            pDev->SetFillColor( aFrameColor );
+        else
+            pDev->SetFillColor( aFaceColor );
+
         pDev->SetTextColor( rStyleSettings.GetButtonTextColor() );
         Rectangle aTitleRect( pData->maTitleRect );
         if( pOffset )
@@ -1837,7 +1865,7 @@ void ImplBorderWindow::ImplInit( Window* pParent,
 {
     // Alle WindowBits entfernen, die wir nicht haben wollen
     WinBits nOrgStyle = nStyle;
-    WinBits nTestStyle = (WB_MOVEABLE | WB_SIZEABLE | WB_ROLLABLE | WB_PINABLE | WB_CLOSEABLE | WB_STANDALONE | WB_DIALOGCONTROL | WB_NODIALOGCONTROL | WB_SYSTEMFLOATWIN | WB_INTROWIN | WB_DEFAULTWIN | WB_TOOLTIPWIN | WB_NOSHADOW | WB_OWNERDRAWDECORATION | WB_SYSTEMCHILDWINDOW  | WB_NEEDSFOCUS);
+    WinBits nTestStyle = (WB_MOVEABLE | WB_SIZEABLE | WB_ROLLABLE | WB_PINABLE | WB_CLOSEABLE | WB_STANDALONE | WB_DIALOGCONTROL | WB_NODIALOGCONTROL | WB_SYSTEMFLOATWIN | WB_INTROWIN | WB_DEFAULTWIN | WB_TOOLTIPWIN | WB_NOSHADOW | WB_OWNERDRAWDECORATION | WB_SYSTEMCHILDWINDOW  | WB_NEEDSFOCUS | WB_POPUP);
     if ( nTypeStyle & BORDERWINDOW_STYLE_APP )
         nTestStyle |= WB_APP;
     nStyle &= nTestStyle;
@@ -1880,7 +1880,7 @@ void ImplBorderWindow::ImplInit( Window*
             mpWindowImpl->mbFrame       = TRUE;
             mbFrameBorder               = FALSE;
         }
-        else if( (nStyle & WB_OWNERDRAWDECORATION) )
+        else if( (nStyle & (WB_OWNERDRAWDECORATION | WB_POPUP)) )
         {
             mpWindowImpl->mbOverlapWin	= TRUE;
             mpWindowImpl->mbFrame 		= TRUE;
@@ -2132,7 +2132,7 @@ void ImplBorderWindow::DataChanged( cons
          ((rDCEvt.GetType() == DATACHANGED_SETTINGS) &&
           (rDCEvt.GetFlags() & SETTINGS_STYLE)) )
     {
-        if ( !mpWindowImpl->mbFrame || (GetStyle() & WB_OWNERDRAWDECORATION) )
+        if ( !mpWindowImpl->mbFrame || (GetStyle() & (WB_OWNERDRAWDECORATION | WB_POPUP)) )
             UpdateView( TRUE, ImplGetWindow()->GetOutputSizePixel() );
     }
 
diff --git vcl/source/window/floatwin.cxx vcl/source/window/floatwin.cxx
index 00785a6..394deb5 100644
--- vcl/source/window/floatwin.cxx
+++ vcl/source/window/floatwin.cxx
@@ -138,7 +138,7 @@ void FloatingWindow::ImplInit( Window* pParent, WinBits nStyle )
     mpNextFloat             = NULL;
     mpFirstPopupModeWin     = NULL;
     mnPostId                = 0;
-    mnTitle                 = (nStyle & WB_MOVEABLE) ? FLOATWIN_TITLE_NORMAL : FLOATWIN_TITLE_NONE;
+    mnTitle                 = (nStyle & (WB_MOVEABLE | WB_POPUP)) ? FLOATWIN_TITLE_NORMAL : FLOATWIN_TITLE_NONE;
     mnOldTitle              = mnTitle;
     mnPopupModeFlags        = 0;
     mbInPopupMode           = FALSE;
@@ -652,6 +652,8 @@ void FloatingWindow::SetTitleType( USHORT nTitle )
             nTitleStyle = BORDERWINDOW_TITLE_SMALL;
         else if ( nTitle == FLOATWIN_TITLE_TEAROFF )
             nTitleStyle = BORDERWINDOW_TITLE_TEAROFF;
+        else if ( nTitle == FLOATWIN_TITLE_POPUP )
+            nTitleStyle = BORDERWINDOW_TITLE_POPUP;
         else // nTitle == FLOATWIN_TITLE_NONE
             nTitleStyle = BORDERWINDOW_TITLE_NONE;
         ((ImplBorderWindow*)mpWindowImpl->mpBorderWindow)->SetTitleType( nTitleStyle, aOutSize );
@@ -672,7 +674,9 @@ void FloatingWindow::StartPopupMode( const Rectangle& rRect, ULONG nFlags )
 
     // remove title 
     mnOldTitle = mnTitle;
-    if ( nFlags & FLOATWIN_POPUPMODE_ALLOWTEAROFF )
+    if ( ( mpWindowImpl->mnStyle & WB_POPUP ) && GetText().Len() )
+        SetTitleType( FLOATWIN_TITLE_POPUP );
+    else if ( nFlags & FLOATWIN_POPUPMODE_ALLOWTEAROFF )
         SetTitleType( FLOATWIN_TITLE_TEAROFF );
     else
         SetTitleType( FLOATWIN_TITLE_NONE );
diff --git vcl/unx/gtk/gdi/salnativewidgets-gtk.cxx vcl/unx/gtk/gdi/salnativewidgets-gtk.cxx
index 95e85d7..8ce1f2a 100644
--- vcl/unx/gtk/gdi/salnativewidgets-gtk.cxx
+++ vcl/unx/gtk/gdi/salnativewidgets-gtk.cxx
@@ -3587,8 +3587,6 @@ void GtkSalGraphics::updateSettings( AllSettings& rSettings )
 
     aStyleSet.SetAppFont( aFont );
     aStyleSet.SetHelpFont( aFont );
-    aStyleSet.SetTitleFont( aFont );
-    aStyleSet.SetFloatTitleFont( aFont );
     aStyleSet.SetMenuFont( aFont );
     aStyleSet.SetToolFont( aFont );
     aStyleSet.SetLabelFont( aFont );
@@ -3599,6 +3597,10 @@ void GtkSalGraphics::updateSettings( AllSettings& rSettings )
     aStyleSet.SetIconFont( aFont );
     aStyleSet.SetGroupFont( aFont );
 
+    aFont.SetWeight( WEIGHT_BOLD );
+    aStyleSet.SetTitleFont( aFont );
+    aStyleSet.SetFloatTitleFont( aFont );
+
     // get cursor blink time
     GtkSettings *pSettings = gtk_widget_get_settings( gWidgetData[m_nScreen].gEditBoxWidget );
     gboolean blink = false;
diff --git vcl/unx/kde/salnativewidgets-kde.cxx vcl/unx/kde/salnativewidgets-kde.cxx
index 131fe72..0478939 100644
--- vcl/unx/kde/salnativewidgets-kde.cxx
+++ vcl/unx/kde/salnativewidgets-kde.cxx
@@ -1954,9 +1954,6 @@ void KDESalFrame::UpdateSettings( AllSettings& rSettings )
 
     aStyleSettings.SetAppFont( aFont );
     aStyleSettings.SetHelpFont( aFont );
-    if( !bSetTitleFont )
-        aStyleSettings.SetTitleFont( aFont );
-    aStyleSettings.SetFloatTitleFont( aFont );
     aStyleSettings.SetMenuFont( aFont ); // will be changed according to pMenuBar
     aStyleSettings.SetToolFont( aFont ); // will be changed according to pToolBar
     aStyleSettings.SetLabelFont( aFont );
@@ -1966,6 +1963,12 @@ void KDESalFrame::UpdateSettings( AllSettings& rSettings )
     aStyleSettings.SetFieldFont( aFont );
     aStyleSettings.SetIconFont( aFont );
     aStyleSettings.SetGroupFont( aFont );
+
+    aFont.SetWeight( WEIGHT_BOLD );
+    if( !bSetTitleFont )
+        aStyleSettings.SetTitleFont( aFont );
+    aStyleSettings.SetFloatTitleFont( aFont );
+
     int flash_time = QApplication::cursorFlashTime();
     aStyleSettings.SetCursorBlinkTime( flash_time != 0 ? flash_time/2 : STYLE_CURSOR_NOBLINKTIME );
 
diff --git vcl/unx/kde4/KDESalFrame.cxx vcl/unx/kde4/KDESalFrame.cxx
index 9e86bb4..b348ac2 100644
--- vcl/unx/kde4/KDESalFrame.cxx
+++ vcl/unx/kde4/KDESalFrame.cxx
@@ -288,12 +288,6 @@ void KDESalFrame::UpdateSettings( AllSettings& rSettings )
     style.SetAppFont( aFont );
     style.SetHelpFont( aFont );
     
-    if( !bSetTitleFont )
-    {
-        style.SetTitleFont( aFont );
-    }
-    
-    style.SetFloatTitleFont( aFont );
     style.SetMenuFont( aFont ); // will be changed according to pMenuBar
     //style.SetToolFont( aFont ); //already set above
     style.SetLabelFont( aFont );
@@ -303,6 +297,13 @@ void KDESalFrame::UpdateSettings( AllSettings& rSettings )
     style.SetFieldFont( aFont );
     style.SetIconFont( aFont );
     style.SetGroupFont( aFont );
+
+    aFont.SetWeight( WEIGHT_BOLD );
+    if( !bSetTitleFont )
+    {
+        style.SetTitleFont( aFont );
+    }
+    style.SetFloatTitleFont( aFont );
     
     int flash_time = QApplication::cursorFlashTime();
     style.SetCursorBlinkTime( flash_time != 0 ? flash_time/2 : STYLE_CURSOR_NOBLINKTIME );
@@ -402,4 +403,4 @@ SalGraphics* KDESalFrame::GetGraphics()
     }
     
     return NULL;
-}
\ No newline at end of file
+}
-- 
1.7.0.1

