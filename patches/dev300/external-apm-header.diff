From 45872c504ead26c381aca7f52989f9f1d21873b7 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:06:18 +0200
Subject: [PATCH 705/878] external-apm-header.diff

---
 svtools/inc/svtools/filter.hxx              |    7 +++++--
 svtools/inc/svtools/wmf.hxx                 |   25 ++++++++++++++++++++++++-
 svtools/source/filter.vcl/filter/filter.cxx |   10 +++++-----
 svtools/source/filter.vcl/wmf/winmtf.hxx    |    5 +++--
 svtools/source/filter.vcl/wmf/winwmf.cxx    |   22 +++++++++++++++-------
 svtools/source/filter.vcl/wmf/wmf.cxx       |    4 ++--
 svx/source/svrtf/rtfgrf.cxx                 |   11 +++++++++--
 7 files changed, 63 insertions(+), 21 deletions(-)

diff --git a/svtools/inc/svtools/filter.hxx b/svtools/inc/svtools/filter.hxx
index b01d0c0..253a50e 100644
--- a/svtools/inc/svtools/filter.hxx
+++ b/svtools/inc/svtools/filter.hxx
@@ -38,6 +38,7 @@
 #include <com/sun/star/uno/Sequence.h>
 #include <com/sun/star/beans/PropertyValue.hpp>
 
+struct WMF_APMFILEHEADER;
 // -----------------------
 // - GraphicFilter-Types -
 // -----------------------
@@ -389,13 +390,15 @@ public:
     USHORT          ImportGraphic( Graphic& rGraphic, const String& rPath,
                                    SvStream& rStream,
                                    USHORT nFormat = GRFILTER_FORMAT_DONTKNOW,
-                                   USHORT * pDeterminedFormat = NULL, sal_uInt32 nImportFlags = 0 );
+                                   USHORT * pDeterminedFormat = NULL, sal_uInt32 nImportFlags = 0
+                       , WMF_APMFILEHEADER *pAPMHeader = NULL);
 
     USHORT          ImportGraphic( Graphic& rGraphic, const String& rPath,
                                    SvStream& rStream,
                                    USHORT nFormat,
                                    USHORT * pDeterminedFormat, sal_uInt32 nImportFlags,
-                                   com::sun::star::uno::Sequence< com::sun::star::beans::PropertyValue >* pFilterData );
+                                   com::sun::star::uno::Sequence< com::sun::star::beans::PropertyValue >* pFilterData
+                       , WMF_APMFILEHEADER *pAPMHeader = NULL);
 
     BOOL            Setup( USHORT nFormat );
 
diff --git a/svtools/inc/svtools/wmf.hxx b/svtools/inc/svtools/wmf.hxx
index a41b618..94d6a82 100644
--- a/svtools/inc/svtools/wmf.hxx
+++ b/svtools/inc/svtools/wmf.hxx
@@ -31,7 +31,30 @@
 #include "svtools/svtdllapi.h"
 #include <svtools/fltcall.hxx>
 
-BOOL ConvertWMFToGDIMetaFile( SvStream & rStreamWMF, GDIMetaFile & rGDIMetaFile, FilterConfigItem* pConfigItem = NULL );
+struct WMF_APMFILEHEADER {
+  sal_uInt32 key;
+  sal_uInt16 hmf;
+  sal_uInt16 left;
+  sal_uInt16 top;
+  sal_uInt16 right;
+  sal_uInt16 bottom;
+  sal_uInt16 inch;
+  sal_uInt32 reserved;
+  sal_uInt16 checksum;
+
+  WMF_APMFILEHEADER() : key(0x9ac6cdd7L),
+            hmf(0),
+            left(0),
+            top(0),
+            right(0),
+            bottom(0),
+            inch(96),
+            reserved(0),
+            checksum(0) {
+  }
+};
+
+BOOL ConvertWMFToGDIMetaFile( SvStream & rStreamWMF, GDIMetaFile & rGDIMetaFile, FilterConfigItem* pConfigItem = NULL, WMF_APMFILEHEADER *pAPMHeader = NULL );
 
 SVT_DLLPUBLIC BOOL ReadWindowMetafile( SvStream& rStream, GDIMetaFile& rMTF, FilterConfigItem* pConfigItem );
 
diff --git a/svtools/source/filter.vcl/filter/filter.cxx b/svtools/source/filter.vcl/filter/filter.cxx
index 5dbe6e3..edd0a5a 100644
--- a/svtools/source/filter.vcl/filter/filter.cxx
+++ b/svtools/source/filter.vcl/filter/filter.cxx
@@ -1278,17 +1278,17 @@ USHORT GraphicFilter::ImportGraphic( Graphic& rGraphic, const INetURLObject& rPa
     return nRetValue;
 }
 
-USHORT GraphicFilter::ImportGraphic( Graphic& rGraphic, const String& rPath, SvStream& rIStream,
-                                     USHORT nFormat, USHORT* pDeterminedFormat, sal_uInt32 nImportFlags )
+USHORT GraphicFilter::ImportGraphic( Graphic& rGraphic, const String& rPath, SvStream& rIStream, USHORT nFormat, USHORT* pDeterminedFormat, sal_uInt32 nImportFlags, WMF_APMFILEHEADER *pAPMHeader )
 {
-    return ImportGraphic( rGraphic, rPath, rIStream, nFormat, pDeterminedFormat, nImportFlags, NULL );
+  return ImportGraphic( rGraphic, rPath, rIStream, nFormat, pDeterminedFormat, nImportFlags, NULL, pAPMHeader );
 }
 
 //-------------------------------------------------------------------------
 
 USHORT GraphicFilter::ImportGraphic( Graphic& rGraphic, const String& rPath, SvStream& rIStream,
                                      USHORT nFormat, USHORT* pDeterminedFormat, sal_uInt32 nImportFlags,
-                                     com::sun::star::uno::Sequence< com::sun::star::beans::PropertyValue >* pFilterData )
+                                     com::sun::star::uno::Sequence< com::sun::star::beans::PropertyValue >* pFilterData
+                     , WMF_APMFILEHEADER *pAPMHeader)
 {
     String					aFilterName;
     ULONG					nStmBegin;
@@ -1485,7 +1485,7 @@ USHORT GraphicFilter::ImportGraphic( Graphic& rGraphic, const String& rPath, SvS
                 aFilterName.EqualsIgnoreCaseAscii( IMP_EMF ) )
         {
             GDIMetaFile aMtf;
-            if( !ConvertWMFToGDIMetaFile( rIStream, aMtf, NULL ) )
+            if( !ConvertWMFToGDIMetaFile( rIStream, aMtf, NULL, pAPMHeader ) )
                 nStatus = GRFILTER_FORMATERROR;
             else
             {
diff --git a/svtools/source/filter.vcl/wmf/winmtf.hxx b/svtools/source/filter.vcl/wmf/winmtf.hxx
index fd1faa9..ef4fc6f 100644
--- a/svtools/source/filter.vcl/wmf/winmtf.hxx
+++ b/svtools/source/filter.vcl/wmf/winmtf.hxx
@@ -159,6 +159,7 @@ struct LOGFONTW
     BYTE		lfPitchAndFamily;
     String		alfFaceName;
 };
+struct WMF_APMFILEHEADER;
 
 #define TA_NOUPDATECP			0x0000
 #define TA_UPDATECP				0x0001
@@ -760,7 +761,7 @@ private:
     sal_uInt32		nUnicodeEscapeAction;
 
     // Liesst den Kopf der WMF-Datei
-    BOOL			ReadHeader();
+    BOOL			ReadHeader(WMF_APMFILEHEADER *pAPMHeader);
 
     // Liesst die Parameter des Rocords mit der Funktionsnummer nFunction.
     void			ReadRecordParams( USHORT nFunction );
@@ -777,7 +778,7 @@ public:
                         : WinMtf( new WinMtfOutput( rGDIMetaFile ), rStreamWMF, pConfigItem ) {};
 
     // Liesst aus dem Stream eine WMF-Datei und fuellt das GDIMetaFile
-    void			ReadWMF();
+    void			ReadWMF(WMF_APMFILEHEADER *pAPMHeader=NULL);
 };
 
 #endif
diff --git a/svtools/source/filter.vcl/wmf/winwmf.cxx b/svtools/source/filter.vcl/wmf/winwmf.cxx
index 7ca95e2..4e5e50f 100644
--- a/svtools/source/filter.vcl/wmf/winwmf.cxx
+++ b/svtools/source/filter.vcl/wmf/winwmf.cxx
@@ -29,6 +29,7 @@
 #include "precompiled_svtools.hxx"
 
 #include "winmtf.hxx"
+#include <svtools/wmf.hxx>
 #include <rtl/crc.h>
 #include <rtl/tencinfo.h>
 #include <osl/endian.h>
@@ -940,7 +941,7 @@ void WMFReader::ReadRecordParams( USHORT nFunc )
 
 // ------------------------------------------------------------------------
 
-BOOL WMFReader::ReadHeader()
+BOOL WMFReader::ReadHeader(WMF_APMFILEHEADER *pAPMHeader)
 {
     Rectangle	aPlaceableBound;
     sal_uInt32  nl, nStrmPos = pWMF->Tell();
@@ -973,10 +974,17 @@ BOOL WMFReader::ReadHeader()
     }
     else
     {
-        nUnitsPerInch = 96;       
-        pWMF->Seek( nStrmPos + 18 );    // set the streampos to the start of the the metaactions
-        GetPlaceableBound( aPlaceableBound, pWMF );
-        pWMF->Seek( nStrmPos );
+      nUnitsPerInch = (pAPMHeader!=NULL?pAPMHeader->inch:96);
+      pWMF->Seek( nStrmPos + 18 );    // set the streampos to the start of the the metaactions
+      GetPlaceableBound( aPlaceableBound, pWMF );
+      pWMF->Seek( nStrmPos );
+      if (pAPMHeader!=NULL) {
+        // #n417818#: If we have an external header then overwrite the bounds!
+        aPlaceableBound=Rectangle(pAPMHeader->left*567*nUnitsPerInch/1440/1000,
+                      pAPMHeader->top*567*nUnitsPerInch/1440/1000,
+                      pAPMHeader->right*567*nUnitsPerInch/1440/1000,
+                      pAPMHeader->bottom*567*nUnitsPerInch/1440/1000);
+      }
     }
 
     pOut->SetWinOrg( aPlaceableBound.TopLeft() );
@@ -1011,7 +1019,7 @@ BOOL WMFReader::ReadHeader()
     return TRUE;
 }
 
-void WMFReader::ReadWMF()
+void WMFReader::ReadWMF(WMF_APMFILEHEADER *pAPMHeader)
 {
     USHORT	nFunction;
     ULONG	nPos, nPercent, nLastPercent;
@@ -1029,7 +1037,7 @@ void WMFReader::ReadWMF()
     pWMF->Seek( nStartPos );
     Callback( (USHORT) ( nLastPercent = 0 ) );
 
-    if ( ReadHeader() )
+    if ( ReadHeader( pAPMHeader ) )
     {
 
         nPos = pWMF->Tell();
diff --git a/svtools/source/filter.vcl/wmf/wmf.cxx b/svtools/source/filter.vcl/wmf/wmf.cxx
index 25ca9f7..93ef881 100644
--- a/svtools/source/filter.vcl/wmf/wmf.cxx
+++ b/svtools/source/filter.vcl/wmf/wmf.cxx
@@ -35,7 +35,7 @@
 
 // -----------------------------------------------------------------------------
 
-BOOL ConvertWMFToGDIMetaFile( SvStream & rStreamWMF, GDIMetaFile & rGDIMetaFile, FilterConfigItem* pConfigItem )
+BOOL ConvertWMFToGDIMetaFile( SvStream & rStreamWMF, GDIMetaFile & rGDIMetaFile, FilterConfigItem* pConfigItem, WMF_APMFILEHEADER *pAPMHeader )
 {
     UINT32 nMetaType;
     UINT32 nOrgPos = rStreamWMF.Tell();
@@ -51,7 +51,7 @@ BOOL ConvertWMFToGDIMetaFile( SvStream & rStreamWMF, GDIMetaFile & rGDIMetaFile,
     }
     else
     {
-        WMFReader( rStreamWMF, rGDIMetaFile, pConfigItem ).ReadWMF();
+        WMFReader( rStreamWMF, rGDIMetaFile, pConfigItem ).ReadWMF( pAPMHeader );
     }
     rStreamWMF.SetNumberFormatInt( nOrigNumberFormat );
     return !rStreamWMF.GetError();
diff --git a/svx/source/svrtf/rtfgrf.cxx b/svx/source/svrtf/rtfgrf.cxx
index 12306ff..2d301fb 100644
--- a/svx/source/svrtf/rtfgrf.cxx
+++ b/svx/source/svrtf/rtfgrf.cxx
@@ -36,6 +36,7 @@
 #include <svtools/rtfkeywd.hxx>
 #include <svtools/rtftoken.h>
 #include <svtools/filter.hxx>
+#include <svtools/wmf.hxx>
 
 #include "impgrf.hxx"
 #include "svxrtf.hxx"
@@ -505,9 +506,15 @@ BOOL SvxRTFParser::ReadBmpData( Graphic& rGrf, SvxRTFPictureType& rPicType )
             }
 
             String sTmpStr;
+            WMF_APMFILEHEADER aAPMHeader;
+            aAPMHeader.left=0;
+            aAPMHeader.top=0;
+            aAPMHeader.right=rPicType.nWidth;
+            aAPMHeader.bottom=rPicType.nHeight;
+
+            WMF_APMFILEHEADER *pAPMHeader=(aAPMHeader.right>0 && aAPMHeader.bottom>0?&aAPMHeader:NULL);
             pTmpFile->Seek( STREAM_SEEK_TO_BEGIN );
-            bValidBmp = 0 == pGF->ImportGraphic( rGrf, sTmpStr, *pTmpFile,
-                                                nImportFilter );
+            bValidBmp = 0 == pGF->ImportGraphic( rGrf, sTmpStr, *pTmpFile, nImportFilter, NULL, 0, pAPMHeader );
         }
         delete pTmpFile;
     }
-- 
1.7.0.1

