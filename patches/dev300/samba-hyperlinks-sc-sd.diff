From 71eb706b1c8b56276e6e9f59bb4ae3ddb30be68e Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:54:34 +0200
Subject: [PATCH 112/878] samba-hyperlinks-sc-sd.diff

---
 sc/source/filter/excel/xecontent.cxx |   10 +++++++++-
 sd/source/filter/eppt/epptso.cxx     |   11 ++++++++++-
 sd/source/filter/ppt/pptin.cxx       |    5 +++++
 3 files changed, 24 insertions(+), 2 deletions(-)

diff --git a/sc/source/filter/excel/xecontent.cxx b/sc/source/filter/excel/xecontent.cxx
index f49c3d0..c2074df 100644
--- a/sc/source/filter/excel/xecontent.cxx
+++ b/sc/source/filter/excel/xecontent.cxx
@@ -409,12 +409,20 @@ XclExpHyperlink::XclExpHyperlink( const XclExpRoot& rRoot, const SvxURLField& rU
     }
 
     // file link or URL
-    if( eProtocol == INET_PROT_FILE )
+    if( eProtocol == INET_PROT_FILE || eProtocol == INET_PROT_SMB )
     {
         sal_uInt16 nLevel;
         bool bRel;
         String aFileName( BuildFileName( nLevel, bRel, rUrl, rRoot ) );
 
+        if( eProtocol == INET_PROT_SMB )
+        {
+            // #n382718# (and #n261623#) Convert smb notation to '\\'
+            aFileName = aUrlObj.GetMainURL( INetURLObject::NO_DECODE );
+            aFileName = String( aFileName.GetBuffer() + 4 ); // skip the 'smb:' part
+            aFileName.SearchAndReplaceAll( '/', '\\' );
+        }
+
         if( !bRel )
             mnFlags |= EXC_HLINK_ABS;
         mnFlags |= EXC_HLINK_BODY;
diff --git a/sd/source/filter/eppt/epptso.cxx b/sd/source/filter/eppt/epptso.cxx
index 7d426d8..7652245 100644
--- a/sd/source/filter/eppt/epptso.cxx
+++ b/sd/source/filter/eppt/epptso.cxx
@@ -3204,9 +3204,18 @@ void PPTWriter::ImplWriteTextStyleAtom( SvStream& rOut, int nTextInstance, sal_u
                             String aPageUrl;
                             String aEmpty;
                             String aFile( pFieldEntry->aFieldUrl );
+                            String aTarget( pFieldEntry->aFieldUrl );
                             INetURLObject aUrl( pFieldEntry->aFieldUrl );
                             if ( INET_PROT_FILE == aUrl.GetProtocol() )
                                 aFile = aUrl.PathToFileName();
+                            else if ( INET_PROT_SMB == aUrl.GetProtocol() )
+                            {
+                                // #n382718# (and #n261623#) Convert smb notation to '\\'
+                                aFile = aUrl.GetMainURL( INetURLObject::NO_DECODE );
+                                aFile = String( aFile.GetBuffer() + 4 ); // skip the 'smb:' part
+                                aFile.SearchAndReplaceAll( '/', '\\' );
+                                aTarget = aFile;
+                            }
                             else if ( pFieldEntry->aFieldUrl.GetChar( 0 ) == '#' )
                             {
                                 String aPage( INetURLObject::decode( pFieldEntry->aFieldUrl, '%', INetURLObject::DECODE_WITH_CHARSET ) );
@@ -3227,7 +3236,7 @@ void PPTWriter::ImplWriteTextStyleAtom( SvStream& rOut, int nTextInstance, sal_u
                             if ( aPageUrl.Len() )
                                 nHyperId = ImplInsertBookmarkURL( aPageUrl, 1 | ( nPageIndex << 8 ) | ( 1 << 31 ), pFieldEntry->aRepresentation, aEmpty, aEmpty, aPageUrl );
                             else
-                                nHyperId = ImplInsertBookmarkURL( pFieldEntry->aFieldUrl, 2 | ( nHyperId << 8 ), aFile, pFieldEntry->aFieldUrl, aEmpty, aEmpty );
+                                nHyperId = ImplInsertBookmarkURL( pFieldEntry->aFieldUrl, 2 | ( nHyperId << 8 ), aFile, aTarget, aEmpty, aEmpty );
 
                             rOut << (sal_uInt32)( ( EPP_InteractiveInfo << 16 ) | 0xf ) << (sal_uInt32)24
                                  << (sal_uInt32)( EPP_InteractiveInfoAtom << 16 ) << (sal_uInt32)16
diff --git a/sd/source/filter/ppt/pptin.cxx b/sd/source/filter/ppt/pptin.cxx
index 6034c79..4306c89 100644
--- a/sd/source/filter/ppt/pptin.cxx
+++ b/sd/source/filter/ppt/pptin.cxx
@@ -429,6 +429,11 @@ sal_Bool ImplSdPPTImport::Import()
                                         aPropItem >> pHyperlink->nInfo;
                                         if ( !aPropItem.Read( pHyperlink->aTarget, VT_EMPTY ) )
                                             break;
+
+                                        // #n382718# (and #n261623#) Convert '\\' notation to 'smb://'
+                                        INetURLObject aUrl( pHyperlink->aTarget, INET_PROT_FILE );
+                                        pHyperlink->aTarget = aUrl.GetMainURL( INetURLObject::NO_DECODE );
+
                                         if ( !aPropItem.Read( pHyperlink->aSubAdress, VT_EMPTY ) )
                                             break;
                                         pHyperlink->nStartPos = pHyperlink->nEndPos = -1;
-- 
1.7.0.1

