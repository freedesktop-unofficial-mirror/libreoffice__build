From c6798a78c919d47196792d189e5d3daafa072988 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:55:59 +0200
Subject: [PATCH 162/768] calc-filter-dbf-precision.diff

---
 sc/source/core/data/column3.cxx  |   14 ++++++--
 sc/source/ui/docshell/docsh8.cxx |   60 +++++++++++++++++++++++++++++++++++++-
 2 files changed, 69 insertions(+), 5 deletions(-)

diff --git sc/source/core/data/column3.cxx sc/source/core/data/column3.cxx
index 769b830..1481732 100644
--- sc/source/core/data/column3.cxx
+++ sc/source/core/data/column3.cxx
@@ -1946,10 +1946,20 @@ xub_StrLen ScColumn::GetMaxNumberStringLen( USHORT& nPrecision,
                 if ( nLen )
                 {
                     if ( nFormat )
-                    {	// more decimals than standard?
-                        sal_uInt16 nPrec = pNumFmt->GetFormatPrecision( nFormat );
-                        if ( nPrec != SvNumberFormatter::UNLIMITED_PRECISION && nPrec > nPrecision )
-                            nPrecision = nPrec;
+                    {
+                        const SvNumberformat* pEntry = pNumFmt->GetEntry( nFormat );
+                        sal_uInt16 nPrec;
+                        if (pEntry)
+                        {
+                            BOOL bThousand, bNegRed;
+                            USHORT nLeading;
+                            pEntry->GetFormatSpecialInfo(bThousand, bNegRed, nPrec, nLeading);
+                        }
+                        else
+                            nPrec = pNumFmt->GetFormatPrecision( nFormat );
+
+                        if ( nPrec != SvNumberFormatter::UNLIMITED_PRECISION && nPrec > nPrecision )
+                            nPrecision = nPrec;
                     }
                     if ( nPrecision )
                     {	// less than nPrecision in string => widen it
diff --git sc/source/ui/docshell/docsh8.cxx sc/source/ui/docshell/docsh8.cxx
index 1c30f8d..88145cf 100644
--- sc/source/ui/docshell/docsh8.cxx
+++ sc/source/ui/docshell/docsh8.cxx
@@ -78,8 +78,16 @@
 #include "dbdocutl.hxx"
 #include "dociter.hxx"
 #include "globstr.hrc"
+#include "svtools/zformat.hxx"
+#include "svtools/intitem.hxx"
+#include "patattr.hxx"
+#include "scitems.hxx"
+#include "docpool.hxx"
+
+#include <vector>
 
 using namespace com::sun::star;
+using ::std::vector;
 
 // -----------------------------------------------------------------------
 
@@ -246,6 +254,53 @@ BOOL ScDocShell::IsDocument( const INetURLObject& rURL )
 
 // -----------------------------------------------------------------------
 
+static void lcl_setScalesToColumns(ScDocument& rDoc, const vector<long>& rScales)
+{
+    SvNumberFormatter* pFormatter = rDoc.GetFormatTable();
+    if (!pFormatter)
+        return;
+
+    SCCOL nColCount = static_cast<SCCOL>(rScales.size());
+    for (SCCOL i = 0; i < nColCount; ++i)
+    {
+        if (rScales[i] < 0)
+            continue;
+
+        sal_uInt32 nOldFormat;
+        rDoc.GetNumberFormat(static_cast<SCCOL>(i), 0, 0, nOldFormat);
+        const SvNumberformat* pOldEntry = pFormatter->GetEntry(nOldFormat);
+        if (!pOldEntry)
+            continue;
+
+        LanguageType eLang = pOldEntry->GetLanguage();
+        BOOL bThousand, bNegRed;
+        USHORT nPrecision, nLeading;
+        pOldEntry->GetFormatSpecialInfo(bThousand, bNegRed, nPrecision, nLeading);
+
+        nPrecision = static_cast<USHORT>(rScales[i]);
+        String aNewPicture;
+        pFormatter->GenerateFormat(aNewPicture, nOldFormat, eLang,
+                                   bThousand, bNegRed, nPrecision, nLeading);
+
+        sal_uInt32 nNewFormat = pFormatter->GetEntryKey(aNewPicture, eLang);
+        if (nNewFormat == NUMBERFORMAT_ENTRY_NOT_FOUND)
+        {
+            xub_StrLen nErrPos = 0;
+            short nNewType = 0;
+            bool bOk = pFormatter->PutEntry(
+                aNewPicture, nErrPos, nNewType, nNewFormat, eLang);
+
+            if (!bOk)
+                continue;
+        }
+
+        ScPatternAttr aNewAttrs( rDoc.GetPool() );
+        SfxItemSet& rSet = aNewAttrs.GetItemSet();
+        rSet.Put( SfxUInt32Item(ATTR_VALUE_FORMAT, nNewFormat) );
+        rDoc.ApplyPatternAreaTab(static_cast<SCCOL>(i), 0, static_cast<SCCOL>(i), MAXROW, 0, aNewAttrs);
+    }
+}
+
 ULONG ScDocShell::DBaseImport( const String& rFullFileName, CharSet eCharSet,
                                 BOOL bSimpleColWidth[MAXCOLCOUNT] )
 {
@@ -327,6 +382,7 @@ ULONG ScDocShell::DBaseImport( const String& rFullFileName, CharSet eCharSet,
         //	read column names
         //!	add type descriptions
 
+        vector<long> aScales(nColCount, -1);
         for (i=0; i<nColCount; i++)
         {
             String aHeader = xMeta->getColumnLabel( i+1 );
@@ -356,6 +412,7 @@ ULONG ScDocShell::DBaseImport( const String& rFullFileName, CharSet eCharSet,
                                         nPrec, nScale ) );
                         aHeader += ',';
                         aHeader += String::CreateFromInt32( nScale );
+                        aScales[i] = nScale;
                     }
                     break;
             }
@@ -363,6 +420,8 @@ ULONG ScDocShell::DBaseImport( const String& rFullFileName, CharSet eCharSet,
             aDocument.SetString( static_cast<SCCOL>(i), 0, 0, aHeader );
         }
 
+        lcl_setScalesToColumns(aDocument, aScales);
+
         SCROW nRow = 1;		// 0 is column titles
         BOOL bEnd = FALSE;
         while ( !bEnd && xRowSet->next() )
@@ -486,7 +545,6 @@ void lcl_GetColumnTypes( ScDocShell& rDocShell,
                         break;
                     case 'N' :
                         nDbType = sdbc::DataType::DECIMAL;
-                        bTypeDefined = TRUE;
                         break;
                 }
                 if ( bTypeDefined && !nFieldLen && nToken > 2 )
-- 
1.7.0.1

