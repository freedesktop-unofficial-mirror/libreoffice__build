From 7b5732e09847d775b9ccf9f5735f4d2b6d2442fa Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:07:19 +0200
Subject: [PATCH 757/878] sw-changes-format-fix.diff

---
 sw/source/core/doc/docredln.cxx |   21 +++++++++++++++++++++
 1 files changed, 21 insertions(+), 0 deletions(-)

diff --git a/sw/source/core/doc/docredln.cxx b/sw/source/core/doc/docredln.cxx
index 8e463a4..94892ef 100644
--- a/sw/source/core/doc/docredln.cxx
+++ b/sw/source/core/doc/docredln.cxx
@@ -1567,6 +1567,27 @@ const SwRedline* SwDoc::GetRedline( const SwPosition& rPos,
                     --nM;
                     pRedl = (*pRedlineTbl)[ nM ];
                 }
+                // if there are format and insert changes in the same position
+                // show insert change first.
+                // since the redlines are sorted by position, only check the redline
+                // before and after the current redline
+                if( nsRedlineType_t::REDLINE_FORMAT == pRedl->GetType() )
+                {
+                    if( nM && rPos >= *(*pRedlineTbl)[ nM - 1 ]->Start() &&
+                        rPos <= *(*pRedlineTbl)[ nM - 1 ]->End() &&
+                        ( nsRedlineType_t::REDLINE_INSERT == (*pRedlineTbl)[ nM - 1 ]->GetType() ) )
+                    {
+                        --nM;
+                        pRedl = (*pRedlineTbl)[ nM ];
+                    }
+                    else if( ( nM + 1 ) <= nO && rPos >= *(*pRedlineTbl)[ nM + 1 ]->Start() &&
+                        rPos <= *(*pRedlineTbl)[ nM + 1 ]->End() &&
+                        ( nsRedlineType_t::REDLINE_INSERT == (*pRedlineTbl)[ nM + 1 ]->GetType() ) )
+                    {
+                        ++nM;
+                        pRedl = (*pRedlineTbl)[ nM ];
+                    }
+                }
 
                 if( pFndPos )
                     *pFndPos = nM;
-- 
1.7.0.1

