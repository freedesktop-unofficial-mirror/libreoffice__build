From a1020110e0afe0c1e9cf67b549ef7ad34ccc0bc7 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:06:28 +0200
Subject: [PATCH 713/878] normalize-template-paths-fix.diff

---
 .../officeinstallationdirectories.cxx              |   12 +++---
 sfx2/source/doc/doctemplates.cxx                   |   35 ++++++++++++++++++++
 2 files changed, 41 insertions(+), 6 deletions(-)

diff --git a/comphelper/source/officeinstdir/officeinstallationdirectories.cxx b/comphelper/source/officeinstdir/officeinstallationdirectories.cxx
index 3ce0d4d..95491a5 100644
--- a/comphelper/source/officeinstdir/officeinstallationdirectories.cxx
+++ b/comphelper/source/officeinstdir/officeinstallationdirectories.cxx
@@ -159,9 +159,9 @@ OfficeInstallationDirectories::makeRelocatableURL( const rtl::OUString& URL )
         if ( nIndex  != -1 )
         {
             return rtl::OUString(
-                URL.replaceAt( nIndex,
-                               m_pOfficeDir->getLength(),
-                               m_aOfficeDirMacro ) );
+                aCanonicalURL.replaceAt( nIndex,
+                                         m_pOfficeDir->getLength(),
+                                         m_aOfficeDirMacro ) );
         }
         else
         {
@@ -169,9 +169,9 @@ OfficeInstallationDirectories::makeRelocatableURL( const rtl::OUString& URL )
             if ( nIndex  != -1 )
             {
                 return rtl::OUString(
-                    URL.replaceAt( nIndex,
-                                   m_pUserDir->getLength(),
-                                   m_aUserDirMacro ) );
+                    aCanonicalURL.replaceAt( nIndex,
+                                             m_pUserDir->getLength(),
+                                             m_aUserDirMacro ) );
             }
         }
     }
diff --git a/sfx2/source/doc/doctemplates.cxx b/sfx2/source/doc/doctemplates.cxx
index 71e465d..26b4735 100644
--- a/sfx2/source/doc/doctemplates.cxx
+++ b/sfx2/source/doc/doctemplates.cxx
@@ -48,6 +48,7 @@
 #include <com/sun/star/beans/XPropertySetInfo.hpp>
 #include <com/sun/star/beans/XPropertyContainer.hpp>
 #include <com/sun/star/beans/StringPair.hpp>
+#include <com/sun/star/util/XMacroExpander.hpp>
 #include <com/sun/star/container/XContainerQuery.hpp>
 #include <com/sun/star/document/XTypeDetection.hpp>
 #include <com/sun/star/document/XStandaloneDocumentInfo.hpp>
@@ -599,11 +600,45 @@ void SfxDocTplService_Impl::getDirList()
 
     maTemplateDirs = Sequence< OUString >( nCount );
 
+    uno::Reference< XComponentContext > xCtx;
+    uno::Reference< util::XMacroExpander > xExpander;
+    uno::Reference< XPropertySet > xPropSet( mxFactory, UNO_QUERY );
+    const rtl::OUString aPrefix(
+        RTL_CONSTASCII_USTRINGPARAM( "vnd.sun.star.expand:" ) );
+
+    if ( xPropSet.is() )
+    {
+        xPropSet->getPropertyValue(
+            rtl::OUString(
+                RTL_CONSTASCII_USTRINGPARAM( "DefaultContext" ) ) )
+            >>= xCtx;
+    }
+
+    if ( xCtx.is() )
+    {
+        xCtx->getValueByName(
+            rtl::OUString( RTL_CONSTASCII_USTRINGPARAM(
+                               "/singletons/com.sun.star.util.theMacroExpander" ) ) )
+            >>= xExpander;
+
+        OSL_ENSURE( xExpander.is(),
+                    "Unable to obtain macro expander singleton!" );
+    }
+
     for ( USHORT i=0; i<nCount; i++ )
     {
         aURL.SetSmartProtocol( INET_PROT_FILE );
         aURL.SetURL( aDirs.GetToken( i, C_DELIM ) );
         maTemplateDirs[i] = aURL.GetMainURL( INetURLObject::NO_DECODE );
+
+        sal_Int32 nIndex = maTemplateDirs[i].indexOf( aPrefix );
+        if ( nIndex != -1 && xExpander.is() )
+        {
+            maTemplateDirs[i] = maTemplateDirs[i].replaceAt(nIndex,
+                                                            aPrefix.getLength(),
+                                                            rtl::OUString());
+            maTemplateDirs[i] = xExpander->expandMacros( maTemplateDirs[i] );
+        }
     }
 
     aValue <<= maTemplateDirs;
-- 
1.7.0.1

