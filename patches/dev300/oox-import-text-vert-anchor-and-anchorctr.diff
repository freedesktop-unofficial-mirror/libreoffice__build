From 98c9fd7f3403d2fa887abfe2c352e51ccb6ab132 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:00:46 +0200
Subject: [PATCH 424/878] oox-import-text-vert-anchor-and-anchorctr.diff

---
 oox/inc/oox/drawingml/drawingmltypes.hxx           |    3 +++
 oox/source/drawingml/drawingmltypes.cxx            |   19 ++++++++++++++++++-
 oox/source/drawingml/textbodypropertiescontext.cxx |   20 ++++++++++++++++++--
 oox/source/token/properties.txt                    |    1 +
 4 files changed, 40 insertions(+), 3 deletions(-)

diff --git a/oox/inc/oox/drawingml/drawingmltypes.hxx b/oox/inc/oox/drawingml/drawingmltypes.hxx
index 4889dd7..56f7e65 100644
--- a/oox/inc/oox/drawingml/drawingmltypes.hxx
+++ b/oox/inc/oox/drawingml/drawingmltypes.hxx
@@ -30,6 +30,7 @@
 
 #include <boost/shared_ptr.hpp>
 #include <com/sun/star/style/TabAlign.hpp>
+#include <com/sun/star/drawing/TextVerticalAdjust.hpp>
 #include <com/sun/star/geometry/IntegerRectangle2D.hpp>
 #include <com/sun/star/awt/Point.hpp>
 #include <com/sun/star/awt/Size.hpp>
@@ -120,6 +121,8 @@ float GetTextSize( const ::rtl::OUString& rValue );
 sal_Int32 GetTextSpacingPoint(  const ::rtl::OUString& sValue );
 sal_Int32 GetTextSpacingPoint(  const sal_Int32 nValue );
 
+::com::sun::star::drawing::TextVerticalAdjust GetTextVerticalAdjust( sal_Int32 nToken );
+
 /** */
 ::com::sun::star::style::TabAlign GetTabAlign( ::sal_Int32 aToken );
 
diff --git a/oox/source/drawingml/drawingmltypes.cxx b/oox/source/drawingml/drawingmltypes.cxx
index 00b4a98..e5aef82 100644
--- a/oox/source/drawingml/drawingmltypes.cxx
+++ b/oox/source/drawingml/drawingmltypes.cxx
@@ -37,8 +37,9 @@ using ::rtl::OUString;
 using ::com::sun::star::uno::Reference;
 using ::com::sun::star::xml::sax::XFastAttributeList;
 using namespace ::com::sun::star::awt;
-using namespace ::com::sun::star::style;
+using namespace ::com::sun::star::drawing;
 using namespace ::com::sun::star::geometry;
+using namespace ::com::sun::star::style;
 
 namespace oox {
 namespace drawingml {
@@ -134,6 +135,22 @@ sal_Int32 GetTextSpacingPoint( const sal_Int32 nValue )
     return ( nValue * 254 + 360 ) / 720;
 }
 
+TextVerticalAdjust GetTextVerticalAdjust( sal_Int32 nToken )
+{
+    TextVerticalAdjust rVal = TextVerticalAdjust_TOP;
+
+    switch( nToken ) {
+    case XML_b:
+        rVal = TextVerticalAdjust_BOTTOM;
+        break;
+    case XML_ctr:
+        rVal = TextVerticalAdjust_CENTER;
+        break;
+    }
+
+    return rVal;
+}
+
 float GetFontHeight( sal_Int32 nHeight )
 {
     // convert 1/100 points to points
diff --git a/oox/source/drawingml/textbodypropertiescontext.cxx b/oox/source/drawingml/textbodypropertiescontext.cxx
index d7c1a30..67a68e9 100644
--- a/oox/source/drawingml/textbodypropertiescontext.cxx
+++ b/oox/source/drawingml/textbodypropertiescontext.cxx
@@ -28,6 +28,7 @@
 #include "oox/drawingml/textbodypropertiescontext.hxx"
 
 #include <com/sun/star/text/ControlCharacter.hpp>
+#include <com/sun/star/text/WritingMode.hpp>
 #include <com/sun/star/drawing/TextVerticalAdjust.hpp>
 #include <com/sun/star/drawing/TextHorizontalAdjust.hpp>
 #include "oox/drawingml/textbodyproperties.hxx"
@@ -42,6 +43,7 @@ using ::rtl::OUString;
 using namespace ::oox::core;
 using namespace ::com::sun::star;
 using namespace ::com::sun::star::uno;
+using namespace ::com::sun::star::drawing;
 using namespace ::com::sun::star::text;
 using namespace ::com::sun::star::xml::sax;
 
@@ -81,6 +83,13 @@ TextBodyPropertiesContext::TextBodyPropertiesContext( ContextHandler& rParent,
 
 
     // ST_TextAnchoringType
+    mrTextBodyProp.maPropertyMap[ PROP_TextVerticalAdjust ] <<= GetTextVerticalAdjust( xAttributes->getOptionalValueToken( XML_anchor, XML_t ) );
+
+    bool bAnchorCenter = aAttribs.getBool( XML_anchorCtr, false );
+    if( bAnchorCenter )
+        mrTextBodyProp.maPropertyMap[ PROP_TextHorizontalAdjust ] <<=
+        TextHorizontalAdjust_CENTER;
+
     drawing::TextVerticalAdjust	eVA( drawing::TextVerticalAdjust_TOP );
     switch( xAttributes->getOptionalValueToken( XML_anchor, XML_t ) )
     {
@@ -93,8 +102,6 @@ TextBodyPropertiesContext::TextBodyPropertiesContext( ContextHandler& rParent,
     }
     mrTextBodyProp.maPropertyMap[ PROP_TextVerticalAdjust ] <<= eVA;
 
-//   bool bAnchorCenter = aAttribs.getBool( XML_anchorCtr, false );
-
 //   bool bCompatLineSpacing = aAttribs.getBool( XML_compatLnSpc, false );
 //   bool bForceAA = aAttribs.getBool( XML_forceAA, false );
 //   bool bFromWordArt = aAttribs.getBool( XML_fromWordArt, false );
@@ -118,6 +125,15 @@ TextBodyPropertiesContext::TextBodyPropertiesContext( ContextHandler& rParent,
 
     // ST_TextVerticalType
     mrTextBodyProp.moVert = aAttribs.getToken( XML_vert );
+    bool bRtl = aAttribs.getBool( XML_rtl, false );
+    if( mrTextBodyProp.moVert.get( XML_horz ) == XML_vert ) {
+    mrTextBodyProp.maPropertyMap[ PROP_TextWritingMode ]
+        <<= ( bRtl ? WritingMode_RL_TB : WritingMode_LR_TB );
+    // workaround for TB_LR as using WritingMode2 doesn't work
+    if( !bAnchorCenter )
+        mrTextBodyProp.maPropertyMap[ PROP_TextHorizontalAdjust ] <<=
+        TextHorizontalAdjust_LEFT;
+    }
 }
 
 // --------------------------------------------------------------------
diff --git a/oox/source/token/properties.txt b/oox/source/token/properties.txt
index 88efd3f..159820f 100644
--- a/oox/source/token/properties.txt
+++ b/oox/source/token/properties.txt
@@ -366,6 +366,7 @@ TargetFrame
 TextAutoGrowHeight
 TextBreak
 TextColor
+TextHorizontalAdjust
 TextLeftDistance
 TextLowerDistance
 TextOverlap
-- 
1.7.0.1

