From 4d4a5c38f5c5e246a729f60c953245ea0718882e Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:56:37 +0200
Subject: [PATCH 219/878] calc-formula-range-separator-fix.diff

---
 sc/inc/rangelst.hxx              |    4 ++--
 sc/source/core/tool/rangelst.cxx |   31 +++++++------------------------
 sc/source/ui/drawfunc/fuins2.cxx |    3 ++-
 3 files changed, 11 insertions(+), 27 deletions(-)

diff --git a/sc/inc/rangelst.hxx b/sc/inc/rangelst.hxx
index 52c889a..5ebf7e1 100644
--- a/sc/inc/rangelst.hxx
+++ b/sc/inc/rangelst.hxx
@@ -55,10 +55,10 @@ public:
     USHORT			Parse( const String&, ScDocument* = NULL,
                            USHORT nMask = SCA_VALID,
                            formula::FormulaGrammar::AddressConvention eConv = formula::FormulaGrammar::CONV_OOO,
-                           char cDelimiter = 0 );
+                           sal_Unicode cDelimiter = 0 );
     void 			Format( String&, USHORT nFlags = 0, ScDocument* = NULL,
                             formula::FormulaGrammar::AddressConvention eConv = formula::FormulaGrammar::CONV_OOO,
-                            char cDelimiter = 0 ) const;
+                            sal_Unicode cDelimiter = 0 ) const;
     void			Join( const ScRange&, BOOL bIsInList = FALSE );
     BOOL 			UpdateReference( UpdateRefMode, ScDocument*,
                                     const ScRange& rWhere,
diff --git a/sc/source/core/tool/rangelst.cxx b/sc/source/core/tool/rangelst.cxx
index 7b59cf4..41f44d5 100644
--- a/sc/source/core/tool/rangelst.cxx
+++ b/sc/source/core/tool/rangelst.cxx
@@ -41,7 +41,7 @@
 #include "document.hxx"
 #include "refupdat.hxx"
 #include "rechead.hxx"
-
+#include "compiler.hxx"
 
 // === ScRangeList ====================================================
 
@@ -58,32 +58,14 @@ void ScRangeList::RemoveAll()
     Clear();
 }
 
-static void defaultDelimiter( char& cDelimiter, formula::FormulaGrammar::AddressConvention eConv)
-{
-    if( cDelimiter == 0)
-    {
-        switch( eConv )
-        {
-        default :
-        case formula::FormulaGrammar::CONV_OOO :
-            cDelimiter = ';';
-            break;
-
-        case formula::FormulaGrammar::CONV_XL_A1 :
-        case formula::FormulaGrammar::CONV_XL_R1C1 :
-            cDelimiter = ',';
-            break;
-        }
-    }
-}
-
 USHORT ScRangeList::Parse( const String& rStr, ScDocument* pDoc, USHORT nMask,
                            formula::FormulaGrammar::AddressConvention eConv,
-                           char cDelimiter )
+                           sal_Unicode cDelimiter )
 {
     if ( rStr.Len() )
     {
-        defaultDelimiter( cDelimiter, eConv);
+        if (!cDelimiter)
+            cDelimiter = ScCompiler::GetNativeSymbol(ocSep).GetChar(0);
 
         nMask |= SCA_VALID;				// falls das jemand vergessen sollte
         USHORT nResult = (USHORT)~0;	// alle Bits setzen
@@ -123,11 +105,12 @@ USHORT ScRangeList::Parse( const String& rStr, ScDocument* pDoc, USHORT nMask,
 
 void ScRangeList::Format( String& rStr, USHORT nFlags, ScDocument* pDoc,
                           formula::FormulaGrammar::AddressConvention eConv,
-                          char cDelimiter ) const
+                          sal_Unicode cDelimiter ) const
 {
     rStr.Erase();
 
-    defaultDelimiter( cDelimiter, eConv);
+    if (!cDelimiter)
+        cDelimiter = ScCompiler::GetNativeSymbol(ocSep).GetChar(0);
 
     ULONG nCnt = Count();
     for ( ULONG nIdx = 0; nIdx < nCnt; nIdx++ )
diff --git a/sc/source/ui/drawfunc/fuins2.cxx b/sc/source/ui/drawfunc/fuins2.cxx
index 8f4d3a7..3d72855 100644
--- a/sc/source/ui/drawfunc/fuins2.cxx
+++ b/sc/source/ui/drawfunc/fuins2.cxx
@@ -526,7 +526,8 @@ FuInsertChart::FuInsertChart(ScTabViewShell* pViewSh, Window* pWin, ScDrawView*
             ScRangeList aRanges;
             aMultiMark.FillRangeListWithMarks( &aRanges, FALSE );
             String aStr;
-            aRanges.Format( aStr, SCR_ABS_3D, pViewSh->GetViewData()->GetDocument() );
+            ScDocument* pDocument = pViewSh->GetViewData()->GetDocument();
+            aRanges.Format( aStr, SCR_ABS_3D, pDocument, pDocument->GetAddressConvention() );
             aRangeString = aStr;
 
             // get "total" range for positioning
-- 
1.7.0.1

