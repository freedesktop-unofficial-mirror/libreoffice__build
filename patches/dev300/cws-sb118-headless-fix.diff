From a97fa2b9aa029b42975365b086670884232e4b36 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:08:40 +0200
Subject: [PATCH 828/878] cws-sb118-headless-fix.diff

---
 vcl/unx/headless/svpinst.cxx |   26 +++++++++++++++++++++-----
 vcl/unx/headless/svpinst.hxx |    3 +++
 2 files changed, 24 insertions(+), 5 deletions(-)

diff --git a/vcl/unx/headless/svpinst.cxx b/vcl/unx/headless/svpinst.cxx
index 35700fb..7112bad 100644
--- a/vcl/unx/headless/svpinst.cxx
+++ b/vcl/unx/headless/svpinst.cxx
@@ -55,6 +55,19 @@ extern "C"
     }
 }
 
+bool SvpSalInstance::isFrameAlive( const SalFrame* pFrame ) const
+{
+    for( std::list< SalFrame* >::const_iterator it = m_aFrames.begin();
+         it != m_aFrames.end(); ++it )
+    {
+        if( *it == pFrame )
+        {
+            return true;
+        }
+    }
+    return false;
+}
+
 SvpSalInstance* SvpSalInstance::s_pDefaultInstance = NULL;
 
 SvpSalInstance::SvpSalInstance()
@@ -346,12 +359,15 @@ void SvpSalInstance::Yield( bool bWait, bool bHandleAllCurrentEvents )
     {
         for( std::list<SalUserEvent>::const_iterator it = aEvents.begin(); it != aEvents.end(); ++it )
         {
-            it->m_pFrame->CallCallback( it->m_nEvent, it->m_pData );
-            if( it->m_nEvent == SALEVENT_RESIZE )
+            if ( isFrameAlive( it->m_pFrame ) )
             {
-                // this would be a good time to post a paint
-                const SvpSalFrame* pSvpFrame = static_cast<const SvpSalFrame*>(it->m_pFrame);
-                pSvpFrame->PostPaint();
+                it->m_pFrame->CallCallback( it->m_nEvent, it->m_pData );
+                if( it->m_nEvent == SALEVENT_RESIZE )
+                {
+                    // this would be a good time to post a paint
+                    const SvpSalFrame* pSvpFrame = static_cast<const SvpSalFrame*>(it->m_pFrame);
+                    pSvpFrame->PostPaint();
+                }
             }
         }
     }
diff --git a/vcl/unx/headless/svpinst.hxx b/vcl/unx/headless/svpinst.hxx
index 4f0e474..dbd5b14 100644
--- a/vcl/unx/headless/svpinst.hxx
+++ b/vcl/unx/headless/svpinst.hxx
@@ -108,6 +108,9 @@ class SvpSalInstance : public SalInstance
     std::list< SalUserEvent > m_aUserEvents;
     
     std::list< SalFrame* > m_aFrames;
+
+    bool isFrameAlive( const SalFrame* pFrame ) const;
+
 public:
     static SvpSalInstance* s_pDefaultInstance;
 
-- 
1.7.0.1

