From f4156660c64ec972558db5f06cb654e95b5489c7 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:02:02 +0200
Subject: [PATCH 493/878] svg-import-convlength-fix.diff

---
 filter/source/svg/units.cxx |   27 ++++++++++++++++++++++-----
 1 files changed, 22 insertions(+), 5 deletions(-)

diff --git a/filter/source/svg/units.cxx b/filter/source/svg/units.cxx
index 1e2ac89..db94634 100644
--- a/filter/source/svg/units.cxx
+++ b/filter/source/svg/units.cxx
@@ -35,10 +35,6 @@ namespace svgi
 
 double convLength( double value, SvgUnit unit, const State& rState, char dir )
 {
-    const double fBoxLen( dir=='h' ? rState.maViewBox.getWidth() :
-                          (dir=='v' ? rState.maViewBox.getHeight() :
-                           rState.maViewBox.getRange().getLength()));
-
     // convert svg unit to internal coordinates ("pixel"). Since the
     // OOo drawing layer is still largely integer-based, the initial
     // viewport transformation includes a certain scale factor
@@ -55,7 +51,28 @@ double convLength( double value, SvgUnit unit, const State& rState, char dir )
         case SVG_LENGTH_UNIT_PT: break;
         case SVG_LENGTH_UNIT_EM: fRet *= rState.mnFontSize; break;
         case SVG_LENGTH_UNIT_EX: fRet *= rState.mnFontSize / 2.0; break;
-        case SVG_LENGTH_UNIT_PERCENTAGE: fRet *= fBoxLen; break;
+        case SVG_LENGTH_UNIT_PERCENTAGE:
+        {
+            double fBoxLen;
+            if (rState.maViewBox.isEmpty())
+            {
+                basegfx::B2DRange aDefaultBox(0, 0,
+                  convLength(210, SVG_LENGTH_UNIT_MM, rState, 'h'),
+                  convLength(297, SVG_LENGTH_UNIT_MM, rState, 'v'));
+                fBoxLen = (dir=='h' ? aDefaultBox.getWidth() :
+                          (dir=='v' ? aDefaultBox.getHeight() :
+                           aDefaultBox.getRange().getLength()));
+            }
+            else
+            {
+                fBoxLen = (dir=='h' ? rState.maViewBox.getWidth() :
+                          (dir=='v' ? rState.maViewBox.getHeight() :
+                           rState.maViewBox.getRange().getLength()));
+            }
+
+            fRet *= fBoxLen/100.0;
+        }
+        break;
         default: OSL_TRACE( "Unknown length type" ); break;
     }
 
-- 
1.7.0.1

