---
 sc/inc/column.hxx                  |    4 +-
 sc/inc/document.hxx                |    3 +-
 sc/inc/stringutil.hxx              |   35 +++++++++++++++++++++++++
 sc/inc/table.hxx                   |    4 +-
 sc/source/core/data/column3.cxx    |   49 ++++++++++++++++++++---------------
 sc/source/core/data/document.cxx   |    4 +-
 sc/source/core/data/table2.cxx     |    4 +-
 sc/source/core/tool/stringutil.cxx |    9 ++++++
 sc/source/filter/rtf/eeimpars.cxx  |   13 ++++++++-
 sc/source/ui/docshell/impex.cxx    |   23 ++++++++++++++++-
 10 files changed, 115 insertions(+), 33 deletions(-)

diff --git sc/inc/column.hxx sc/inc/column.hxx
index 6a9ef60..1968815 100644
--- sc/inc/column.hxx
+++ sc/inc/column.hxx
@@ -66,6 +66,7 @@ struct ScFunctionData;
 struct ScLineFlags;
 struct ScMergePatternState;
 class ScFlatBoolRowSegments;
+struct ScSetStringParam;
 
 #define COLUMN_DELTA	4
 
@@ -236,8 +237,7 @@ public:
                 //	TRUE = Zahlformat gesetzt
     BOOL		SetString( SCROW nRow, SCTAB nTab, const String& rString,
                            formula::FormulaGrammar::AddressConvention conv = formula::FormulaGrammar::CONV_OOO,
-                           SvNumberFormatter* pFormatter = NULL,
-                           bool bDetectNumberFormat = true );
+                           ScSetStringParam* pParam = NULL );
     void		SetValue( SCROW nRow, const double& rVal);
     void		SetError( SCROW nRow, const USHORT nError);
 
diff --git sc/inc/document.hxx sc/inc/document.hxx
index a90abcb..21944f2 100644
--- sc/inc/document.hxx
+++ sc/inc/document.hxx
@@ -146,6 +146,7 @@ class ScFormulaParserPool;
 struct ScClipParam;        
 struct ScClipRangeNameData;
 class ScRowBreakIterator;
+struct ScSetStringParam;
 
 namespace com { namespace sun { namespace star {
     namespace lang {
@@ -758,7 +759,7 @@ public:
                     //	return TRUE = Zahlformat gesetzt
     SC_DLLPUBLIC BOOL           SetString(
         SCCOL nCol, SCROW nRow, SCTAB nTab, const String& rString, 
-        SvNumberFormatter* pFormatter = NULL, bool bDetectNumberFormat = true );
+        ScSetStringParam* pParam = NULL );
     SC_DLLPUBLIC void           SetValue( SCCOL nCol, SCROW nRow, SCTAB nTab, const double& rVal );
     void 			SetError( SCCOL nCol, SCROW nRow, SCTAB nTab, const USHORT nError);
 
diff --git sc/inc/stringutil.hxx sc/inc/stringutil.hxx
index 4ca8629..3468640 100644
--- sc/inc/stringutil.hxx
+++ sc/inc/stringutil.hxx
@@ -32,6 +32,41 @@
 #define SC_STRINGUTIL_HXX
 
 #include "rtl/ustring.hxx"
+#include "scdllapi.h"
+
+class SvNumberFormatter;
+
+/**
+ * Store parameters used in the ScDocument::SetString() method.  Various
+ * options for string-setting operation are specified herein.
+ */
+struct SC_DLLPUBLIC ScSetStringParam
+{
+    /**
+     * Stores the pointer to the number formatter instance to be used during
+     * number format detection.  The caller must manage the life cycle of the
+     * instance.
+     */
+    SvNumberFormatter* mpNumFormatter;
+
+    /**
+     * When true, we try to detect special number format (dates etc) from the
+     * input string, when false, we only try to detect a basic decimal number
+     * format.
+     */
+    bool mbDetectNumberFormat;
+
+    /**
+     * When true, set the format of the cell to Text when a string cell is
+     * requested for a number input.  We may want to do this during text file
+     * import (csv, html etc).
+     */
+    bool mbSetTextCellFormat;
+
+    ScSetStringParam();
+};
+
+// ============================================================================
 
 class ScStringUtil
 {
diff --git sc/inc/table.hxx sc/inc/table.hxx
index 114f71e..87320cf 100644
--- sc/inc/table.hxx
+++ sc/inc/table.hxx
@@ -84,7 +84,7 @@ class CollatorWrapper;
 class ScFlatUInt16RowSegments;
 class ScFlatBoolRowSegments;
 class ScFlatBoolColSegments;
-
+struct ScSetStringParam;
 
 class ScTable
 {
@@ -291,7 +291,7 @@ public:
     void		PutCell(SCCOL nCol, SCROW nRow, ULONG nFormatIndex, ScBaseCell* pCell);
                 //	TRUE = Zahlformat gesetzt
     BOOL		SetString( SCCOL nCol, SCROW nRow, SCTAB nTab, const String& rString, 
-                           SvNumberFormatter* pFormatter = NULL, bool bDetectNumberFormat = true );
+                           ScSetStringParam* pParam = NULL );
     void		SetValue( SCCOL nCol, SCROW nRow, const double& rVal );
     void 		SetError( SCCOL nCol, SCROW nRow, USHORT nError);
 
diff --git sc/source/core/data/column3.cxx sc/source/core/data/column3.cxx
index 4c062a6..ee7a8d7 100644
--- sc/source/core/data/column3.cxx
+++ sc/source/core/data/column3.cxx
@@ -52,6 +52,7 @@
 #include "detfunc.hxx"			// fuer Notizen bei DeleteRange
 #include "postit.hxx"
 #include "stringutil.hxx"
+#include "docpool.hxx"
 
 #include <com/sun/star/i18n/LocaleDataItem.hpp>
 
@@ -1249,7 +1250,7 @@ void ScColumn::StartListeningInArea( SCROW nRow1, SCROW nRow2 )
 //	TRUE = Zahlformat gesetzt
 BOOL ScColumn::SetString( SCROW nRow, SCTAB nTabP, const String& rString,
                           formula::FormulaGrammar::AddressConvention eConv,
-                          SvNumberFormatter* pLangFormatter, bool bDetectNumberFormat )
+                          ScSetStringParam* pParam )
 {
     BOOL bNumFmtSet = FALSE;
     if (VALIDROW(nRow))
@@ -1258,14 +1259,15 @@ BOOL ScColumn::SetString( SCROW nRow, SCTAB nTabP, const String& rString,
         BOOL bIsLoading = FALSE;
         if (rString.Len() > 0)
         {
+            ScSetStringParam aParam;
+            if (pParam)
+                aParam = *pParam;
+
             double nVal;
             sal_uInt32 nIndex, nOldIndex = 0;
             sal_Unicode cFirstChar;
-            // #i110979# If a different NumberFormatter is passed in (pLangFormatter),
-            // its formats aren't valid in the document.
-            // Only use the language / LocaleDataWrapper from pLangFormatter,
-            // always the document's number formatter for IsNumberFormat.
-            SvNumberFormatter* pFormatter = pDocument->GetFormatTable();
+            if (!aParam.mpNumFormatter)
+                aParam.mpNumFormatter = pDocument->GetFormatTable();
             SfxObjectShell* pDocSh = pDocument->GetDocumentShell();
             if ( pDocSh )
                 bIsLoading = pDocSh->IsLoading();
@@ -1274,7 +1276,7 @@ BOOL ScColumn::SetString( SCROW nRow, SCTAB nTabP, const String& rString,
             {
                 nIndex = nOldIndex = GetNumberFormat( nRow );
                 if ( rString.Len() > 1
-                        && pFormatter->GetType(nIndex) != NUMBERFORMAT_TEXT )
+                        && aParam.mpNumFormatter->GetType(nIndex) != NUMBERFORMAT_TEXT )
                     cFirstChar = rString.GetChar(0);
                 else
                     cFirstChar = 0;								// Text
@@ -1330,7 +1332,7 @@ BOOL ScColumn::SetString( SCROW nRow, SCTAB nTabP, const String& rString,
                     }
                     // nIndex fuer IsNumberFormat vorbelegen
                     if ( !bIsText )
-                        nIndex = nOldIndex = pFormatter->GetStandardIndex();
+                        nIndex = nOldIndex = aParam.mpNumFormatter->GetStandardIndex();
                 }
 
                 do
@@ -1338,15 +1340,9 @@ BOOL ScColumn::SetString( SCROW nRow, SCTAB nTabP, const String& rString,
                     if (bIsText)
                         break;
 
-                    if (bDetectNumberFormat)
+                    if (aParam.mbDetectNumberFormat)
                     {
-                        if ( pLangFormatter )
-                        {
-                            // for number detection: valid format index for selected language
-                            nIndex = pFormatter->GetStandardIndex( pLangFormatter->GetLanguage() );
-                        }
-
-                        if (!pFormatter->IsNumberFormat(rString, nIndex, nVal))
+                        if (!aParam.mpNumFormatter->IsNumberFormat(rString, nIndex, nVal))
                             break;
 
                         if ( pLangFormatter )
@@ -1365,21 +1361,21 @@ BOOL ScColumn::SetString( SCROW nRow, SCTAB nTabP, const String& rString,
                             // Exception: If the new format is boolean, always apply it.
 
                             BOOL bOverwrite = FALSE;
-                            const SvNumberformat* pOldFormat = pFormatter->GetEntry( nOldIndex );
+                            const SvNumberformat* pOldFormat = aParam.mpNumFormatter->GetEntry( nOldIndex );
                             if ( pOldFormat )
                             {
                                 short nOldType = pOldFormat->GetType() & ~NUMBERFORMAT_DEFINED;
                                 if ( nOldType == NUMBERFORMAT_NUMBER || nOldType == NUMBERFORMAT_DATE ||
                                      nOldType == NUMBERFORMAT_TIME || nOldType == NUMBERFORMAT_LOGICAL )
                                 {
-                                    if ( nOldIndex == pFormatter->GetStandardFormat(
+                                    if ( nOldIndex == aParam.mpNumFormatter->GetStandardFormat(
                                                         nOldType, pOldFormat->GetLanguage() ) )
                                     {
                                         bOverwrite = TRUE;      // default of these types can be overwritten
                                     }
                                 }
                             }
-                            if ( !bOverwrite && pFormatter->GetType( nIndex ) == NUMBERFORMAT_LOGICAL )
+                            if ( !bOverwrite && aParam.mpNumFormatter->GetType( nIndex ) == NUMBERFORMAT_LOGICAL )
                             {
                                 bOverwrite = TRUE;              // overwrite anything if boolean was detected
                             }
@@ -1395,8 +1391,7 @@ BOOL ScColumn::SetString( SCROW nRow, SCTAB nTabP, const String& rString,
                     else
                     {
                         // Only check if the string is a regular number.
-                        SvNumberFormatter* pLocaleSource = pLangFormatter ? pLangFormatter : pFormatter;
-                        const LocaleDataWrapper* pLocale = pLocaleSource->GetLocaleData();
+                        const LocaleDataWrapper* pLocale = aParam.mpNumFormatter->GetLocaleData();
                         if (!pLocale)
                             break;
                         
@@ -1418,7 +1413,19 @@ BOOL ScColumn::SetString( SCROW nRow, SCTAB nTabP, const String& rString,
                 while (false);
 
                 if (!pNewCell)
+                {
+                    if (aParam.mbSetTextCellFormat && aParam.mpNumFormatter->IsNumberFormat(rString, nIndex, nVal))
+                    {
+                        // Set the cell format type to Text.
+                        sal_uInt32 nFormat = aParam.mpNumFormatter->GetStandardFormat(NUMBERFORMAT_TEXT);
+                        ScPatternAttr aNewAttrs(pDocument->GetPool());
+                        SfxItemSet& rSet = aNewAttrs.GetItemSet();
+                        rSet.Put( SfxUInt32Item(ATTR_VALUE_FORMAT, nFormat) );
+                        ApplyPattern(nRow, aNewAttrs);
+                    }
+
                     pNewCell = new ScStringCell(rString);
+                }
             }
         }
 
diff --git sc/source/core/data/document.cxx sc/source/core/data/document.cxx
index 3a76585..40acf12 100644
--- sc/source/core/data/document.cxx
+++ sc/source/core/data/document.cxx
@@ -2658,10 +2658,10 @@ void ScDocument::PutCell( const ScAddress& rPos, ScBaseCell* pCell, BOOL bForceT
 
 
 BOOL ScDocument::SetString( SCCOL nCol, SCROW nRow, SCTAB nTab, const String& rString, 
-                            SvNumberFormatter* pFormatter, bool bDetectNumberFormat )
+                            ScSetStringParam* pParam )
 {
     if ( ValidTab(nTab) && pTab[nTab] )
-        return pTab[nTab]->SetString( nCol, nRow, nTab, rString, pFormatter, bDetectNumberFormat );
+        return pTab[nTab]->SetString( nCol, nRow, nTab, rString, pParam );
     else
         return FALSE;
 }
diff --git sc/source/core/data/table2.cxx sc/source/core/data/table2.cxx
index 50b86f6..1ae6cb0 100644
--- sc/source/core/data/table2.cxx
+++ sc/source/core/data/table2.cxx
@@ -927,11 +927,11 @@ void ScTable::PutCell( const ScAddress& rPos, ScBaseCell* pCell )
 
 
 BOOL ScTable::SetString( SCCOL nCol, SCROW nRow, SCTAB nTabP, const String& rString, 
-                         SvNumberFormatter* pFormatter, bool bDetectNumberFormat )
+                         ScSetStringParam* pParam )
 {
     if (ValidColRow(nCol,nRow))
         return aCol[nCol].SetString( 
-            nRow, nTabP, rString, pDocument->GetAddressConvention(), pFormatter, bDetectNumberFormat );
+            nRow, nTabP, rString, pDocument->GetAddressConvention(), pParam );
     else
         return FALSE;
 }
diff --git sc/source/core/tool/stringutil.cxx sc/source/core/tool/stringutil.cxx
index ae6247f..d5e09a6 100644
--- sc/source/core/tool/stringutil.cxx
+++ sc/source/core/tool/stringutil.cxx
@@ -40,6 +40,15 @@
 using ::rtl::OUString;
 using ::rtl::OUStringBuffer;
 
+ScSetStringParam::ScSetStringParam() :
+    mpNumFormatter(NULL),
+    mbDetectNumberFormat(true),
+    mbSetTextCellFormat(false)
+{
+}
+
+// ============================================================================-
+
 bool ScStringUtil::parseSimpleNumber(
     const OUString& rStr, sal_Unicode dsep, sal_Unicode gsep, double& rVal)
 {
diff --git sc/source/filter/rtf/eeimpars.cxx sc/source/filter/rtf/eeimpars.cxx
index 0bc43ca..fadb53e 100644
--- sc/source/filter/rtf/eeimpars.cxx
+++ sc/source/filter/rtf/eeimpars.cxx
@@ -66,6 +66,7 @@
 #include "drwlayer.hxx"
 #include "rangenam.hxx"
 #include "progress.hxx"
+#include "stringutil.hxx"
 
 #include "globstr.hrc"
 
@@ -329,12 +330,17 @@ void ScEEImport::WriteToDocument( BOOL bSizeColsRows, double nOutputFactor, SvNu
             // Daten eintragen
             if (bSimple)
             {
+                ScSetStringParam aParam;
+                aParam.mpNumFormatter = pFormatter;
+                aParam.mbDetectNumberFormat = true;
+                aParam.mbSetTextCellFormat = true;
+
                 if ( aValStr.Len() )
                     mpDoc->SetValue( nCol, nRow, nTab, fVal );
                 else if ( !pE->aSel.HasRange() )
                 {
                     // maybe ALT text of IMG or similar
-                    mpDoc->SetString( nCol, nRow, nTab, pE->aAltText, pFormatter );
+                    mpDoc->SetString( nCol, nRow, nTab, pE->aAltText, &aParam );
                     // wenn SelRange komplett leer kann nachfolgender Text im gleichen Absatz liegen!
                 }
                 else
@@ -379,7 +385,10 @@ void ScEEImport::WriteToDocument( BOOL bSizeColsRows, double nOutputFactor, SvNu
                     if (bNumbersEnglishUS && !bEnUsRecognized)
                         mpDoc->PutCell( nCol, nRow, nTab, new ScStringCell( aStr));
                     else
-                        mpDoc->SetString( nCol, nRow, nTab, aStr, pFormatter, bConvertDate );
+                    {
+                        aParam.mbDetectNumberFormat = bConvertDate;
+                        mpDoc->SetString( nCol, nRow, nTab, aStr, &aParam );
+                    }
                 }
             }
             else
diff --git sc/source/ui/docshell/impex.cxx sc/source/ui/docshell/impex.cxx
index 5bf49e8..9c839f5 100644
--- sc/source/ui/docshell/impex.cxx
+++ sc/source/ui/docshell/impex.cxx
@@ -82,6 +82,9 @@ class StarBASIC;
 
 // ause
 #include "editutil.hxx"
+#include "patattr.hxx"
+#include "docpool.hxx"
+#include "stringutil.hxx"
 
 #include "globstr.hrc"
 #include <vcl/msgbox.hxx>
@@ -914,6 +917,18 @@ static bool lcl_PutString(
 
     if ( nColFormat == SC_COL_TEXT )
     {
+        double fDummy;
+        sal_uInt32 nIndex;
+        if (pFormatter->IsNumberFormat(rStr, nIndex, fDummy))
+        {
+            // Set the format of this cell to Text.
+            sal_uInt32 nFormat = pFormatter->GetStandardFormat(NUMBERFORMAT_TEXT);
+            ScPatternAttr aNewAttrs(pDoc->GetPool());
+            SfxItemSet& rSet = aNewAttrs.GetItemSet();
+            rSet.Put( SfxUInt32Item(ATTR_VALUE_FORMAT, nFormat) );
+            pDoc->ApplyPattern(nCol, nRow, nTab, aNewAttrs);
+
+        }
         pDoc->PutCell( nCol, nRow, nTab, ScBaseCell::CreateTextCell( rStr, pDoc ) );
         return bMultiLine;
     }
@@ -1126,7 +1141,13 @@ static bool lcl_PutString(
 
     // Standard or date not determined -> SetString / EditCell
     if( rStr.Search( _LF ) == STRING_NOTFOUND )
-        pDoc->SetString( nCol, nRow, nTab, rStr, pFormatter, bDetectNumFormat );
+    {
+        ScSetStringParam aParam;
+        aParam.mpNumFormatter = pFormatter;
+        aParam.mbDetectNumberFormat = bDetectNumFormat;
+        aParam.mbSetTextCellFormat = true;
+        pDoc->SetString( nCol, nRow, nTab, rStr, &aParam );
+    }
     else 
     {
         bMultiLine = true;
-- 
1.7.0.1

