--- oox/source/core/filterdetect.cxx.old	2009-04-02 11:05:42.000000000 +0000
+++ oox/source/core/filterdetect.cxx	2009-04-06 16:42:02.000000000 +0000
@@ -36,11 +36,19 @@
 #include <com/sun/star/xml/sax/XFastDocumentHandler.hpp>
 #include <com/sun/star/xml/sax/XFastContextHandler.hpp>
 #include <com/sun/star/xml/sax/XFastParser.hpp>
+#include <com/sun/star/deployment/thePackageManagerFactory.hpp>
+
+#include <ucbhelper/commandenvironment.hxx>
 
 #include <comphelper/mediadescriptor.hxx>
 #include <cppuhelper/implbase1.hxx>
 #include <cppuhelper/implbase2.hxx>
 
+#include <unotools/bootstrap.hxx>
+#include <osl/file.hxx>
+
+#include <rtl/ustring.hxx>
+
 #include "oox/helper/attributelist.hxx"
 #include "oox/helper/zipstorage.hxx"
 #include "oox/core/fasttokenhandler.hxx"
@@ -283,6 +291,7 @@ public:
 
 private:
     Reference< XMultiServiceFactory > mxFactory;
+	sal_Bool checkAgainstOdfConverterPackage( void );
 };
 
 // ----------------------------------------------------------------------------
@@ -321,6 +330,22 @@ FilterDetect::~FilterDetect()
 
 OUString SAL_CALL FilterDetect::detect( Sequence< PropertyValue >& lDescriptor ) throw( RuntimeException )
 {
+    // hack for odf-converter - we ignore the built-in oox import filter if
+    // OdfConverter is present
+    rtl::OUString aPath;
+    ::utl::Bootstrap::PathStatus aBaseLocateResult = ::utl::Bootstrap::locateBaseInstallation( aPath );
+    if ( aBaseLocateResult == ::utl::Bootstrap::PATH_EXISTS )
+    {
+        aPath += rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( "/program/OdfConverter" ) );
+
+        osl::DirectoryItem aDirItem;
+        if ( osl::DirectoryItem::get( aPath, aDirItem ) == osl::FileBase::E_None )
+            return rtl::OUString();
+    }
+
+	if ( checkAgainstOdfConverterPackage() )
+		return rtl::OUString();
+
     OUString aFilter;
 
     if( mxFactory.is() ) try
@@ -378,6 +403,47 @@ Sequence< OUString > SAL_CALL FilterDete
     return FilterDetect_getSupportedServiceNames();
 }
 
+sal_Bool FilterDetect::checkAgainstOdfConverterPackage( void)
+{
+	Reference< XPropertySet > xProps(mxFactory, UNO_QUERY);
+	Reference< XComponentContext > xContext(xProps->getPropertyValue(rtl::OUString::createFromAscii("DefaultContext")), UNO_QUERY);
+
+	Reference< ::com::sun::star::deployment::XPackageManager > xUserContext(
+		::com::sun::star::deployment::thePackageManagerFactory::get (xContext)->getPackageManager( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("user") ) ) );
+	Reference< ::com::sun::star::deployment::XPackageManager > xSharedContext(
+		::com::sun::star::deployment::thePackageManagerFactory::get (xContext)->getPackageManager( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("shared") ) ) );
+
+    Reference< ::com::sun::star::task::XInteractionHandler > xInteractionHandler = Reference< ::com::sun::star::task::XInteractionHandler > (
+            mxFactory->createInstance( rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.uui.InteractionHandler") ) ), UNO_QUERY );
+    ::ucbhelper::CommandEnvironment* pCommandEnv = new ::ucbhelper::CommandEnvironment( xInteractionHandler, Reference< ::com::sun::star::ucb::XProgressHandler >() );
+
+    Reference< ::com::sun::star::ucb::XCommandEnvironment > xCmdEnv( static_cast< ::com::sun::star::ucb::XCommandEnvironment* >( pCommandEnv ), UNO_QUERY );
+
+	const Sequence< Reference< ::com::sun::star::deployment::XPackage > > userPackages(
+        xUserContext->getDeployedPackages( NULL, xCmdEnv ) );
+	const Sequence< Reference< ::com::sun::star::deployment::XPackage > > sharedPackages(
+        xSharedContext->getDeployedPackages( NULL, xCmdEnv ) );
+
+	const Sequence< Reference< ::com::sun::star::deployment::XPackage > > pkgsArray[2] = {
+		userPackages,
+		sharedPackages
+	};
+
+	for ( int i = 0; i < 2; i++ ) {
+		const Sequence< Reference< ::com::sun::star::deployment::XPackage > > pkgs = pkgsArray[i];
+
+		for ( int j = 0; j < pkgs.getLength(); j++ ) {
+			OUString fname = pkgs[j]->getName();
+			if ( fname.matchIgnoreAsciiCase( rtl::OUString::createFromAscii( "odf-converter-" ) ) ) {
+				printf( "Found match for odf-converter!\n");
+				fflush( stdout );
+				return sal_True;
+			}
+		}
+	}
+	return sal_False;
+}
+
 // ============================================================================
 
 } // namespace core
--- oox/util/makefile.mk.old	2009-04-02 11:05:44.000000000 +0000
+++ oox/util/makefile.mk	2009-04-06 16:42:02.000000000 +0000
@@ -73,6 +73,8 @@ SHL1STDLIBS= \
 		$(RTLLIB)		\
 		$(SALLIB)		\
 		$(BASEGFXLIB)	\
+		$(UNOTOOLSLIB)	\
+		$(UCBHELPERLIB) \
 		$(SAXLIB)
 
 SHL1DEF=    $(MISC)$/$(SHL1TARGET).def
--- writerfilter/source/filter/WriterFilterDetection.cxx.old	2009-04-02 10:57:42.000000000 +0000
+++ writerfilter/source/filter/WriterFilterDetection.cxx	2009-04-06 16:42:02.000000000 +0000
@@ -38,6 +38,17 @@
 //#endif
 #include <unotools/ucbstreamhelper.hxx>
 
+#include <com/sun/star/beans/XPropertySet.hpp>
+#include <com/sun/star/lang/XMultiServiceFactory.hpp>
+#include <com/sun/star/deployment/thePackageManagerFactory.hpp>
+#include <com/sun/star/uno/Sequence.hxx>
+
+#include <comphelper/processfactory.hxx>
+#include <ucbhelper/commandenvironment.hxx>
+#include <unotools/bootstrap.hxx>
+
+#include <osl/file.hxx>
+
 using namespace ::rtl;
 using namespace ::cppu;
 using namespace ::com::sun::star;
@@ -71,6 +82,57 @@ OUString WriterFilterDetection_getImplem
 OUString WriterFilterDetection::detect( uno::Sequence< beans::PropertyValue >& rDescriptor )
    throw( uno::RuntimeException )
 {
+    // hack for odf-converter - we ignore the built-in oox import filter if
+    // OdfConverter is present
+    rtl::OUString aPath;
+    ::utl::Bootstrap::PathStatus aBaseLocateResult = ::utl::Bootstrap::locateBaseInstallation( aPath );
+    if ( aBaseLocateResult == ::utl::Bootstrap::PATH_EXISTS )
+    {
+        aPath += rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( "/program/OdfConverter" ) );
+
+        osl::DirectoryItem aDirItem;
+        if ( osl::DirectoryItem::get( aPath, aDirItem ) == osl::FileBase::E_None )
+            return rtl::OUString();
+    }
+
+	uno::Reference< ::com::sun::star::lang::XMultiServiceFactory> xMS(::comphelper::getProcessServiceFactory(), uno::UNO_QUERY);
+	uno::Reference< beans::XPropertySet > xProps(xMS, uno::UNO_QUERY);
+	uno::Reference< uno::XComponentContext > xContext(xProps->getPropertyValue(rtl::OUString::createFromAscii("DefaultContext")), uno::UNO_QUERY);
+
+	uno::Reference< deployment::XPackageManager > xUserContext(
+		deployment::thePackageManagerFactory::get (xContext)->getPackageManager( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("user") ) ) );
+	uno::Reference< ::com::sun::star::deployment::XPackageManager > xSharedContext(
+		deployment::thePackageManagerFactory::get (xContext)->getPackageManager( ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("shared") ) ) );
+
+    uno::Reference< ::com::sun::star::task::XInteractionHandler > xInteractionHandler = uno::Reference< task::XInteractionHandler > (
+            xMS->createInstance( rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("com.sun.star.uui.InteractionHandler") ) ), uno::UNO_QUERY );
+    ::ucbhelper::CommandEnvironment* pCommandEnv = new ::ucbhelper::CommandEnvironment( xInteractionHandler, uno::Reference< ucb::XProgressHandler >() );
+
+    uno::Reference< ucb::XCommandEnvironment > xCmdEnv( static_cast< ::com::sun::star::ucb::XCommandEnvironment* >( pCommandEnv ), uno::UNO_QUERY );
+
+	const uno::Sequence< uno::Reference< deployment::XPackage > > userPackages(
+        xUserContext->getDeployedPackages( NULL, xCmdEnv ) );
+	const uno::Sequence< uno::Reference< deployment::XPackage > > sharedPackages(
+        xSharedContext->getDeployedPackages( NULL, xCmdEnv ) );
+
+	const uno::Sequence< uno::Reference< deployment::XPackage > > pkgsArray[2] = {
+		userPackages,
+		sharedPackages
+	};
+
+	for ( int i = 0; i < 2; i++ ) {
+		const uno::Sequence< uno::Reference< deployment::XPackage > > pkgs = pkgsArray[i];
+
+		for ( int j = 0; j < pkgs.getLength(); j++ ) {
+			OUString fname = pkgs[j]->getName();
+			if ( fname.matchIgnoreAsciiCase( rtl::OUString::createFromAscii( "odf-converter-" ) ) ) {
+				printf( "Found match for odf-converter!\n");
+				fflush( stdout );
+				return rtl::OUString();
+			}
+		}
+	}
+
     OUString sTypeName;
     bool bWord = false;
     sal_Int32 nPropertyCount = rDescriptor.getLength();
