From 54bcd6ba3841e574661ac33930a23447cf0fb4b1 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:08:06 +0200
Subject: [PATCH 701/768] calc-distributed-cell-text-sc-fix2.diff

---
 sc/source/ui/view/output2.cxx |   16 +++++++++++++---
 1 files changed, 13 insertions(+), 3 deletions(-)

diff --git sc/source/ui/view/output2.cxx sc/source/ui/view/output2.cxx
index 193414e..65c0449 100644
--- sc/source/ui/view/output2.cxx
+++ sc/source/ui/view/output2.cxx
@@ -2137,7 +2137,7 @@ public:
      */
     bool isVerticallyOriented() const;
 
-    void setAlignmentItems(ScFieldEditEngine* pEngine);
+    void setAlignmentItems(ScFieldEditEngine* pEngine, ScBaseCell* pCell);
     bool adjustHorAlignment(ScFieldEditEngine* pEngine);
 
 private:
@@ -2239,7 +2239,7 @@ bool EditAlignmentParam::isVerticallyOriented() const
     return (meOrient == SVX_ORIENTATION_TOPBOTTOM || meOrient == SVX_ORIENTATION_BOTTOMTOP);
 }
 
-void EditAlignmentParam::setAlignmentItems(ScFieldEditEngine* pEngine)
+void EditAlignmentParam::setAlignmentItems(ScFieldEditEngine* pEngine, ScBaseCell* pCell)
 {
     if (isVerticallyOriented() || mbAsianVertical)
     {
@@ -2336,6 +2336,16 @@ void EditAlignmentParam::setAlignmentItems(ScFieldEditEngine* pEngine)
     }
 
     pEngine->SetVertical(mbAsianVertical);
+    if (pCell && pCell->GetCellType() == CELLTYPE_EDIT)
+    {
+        // We need to synchronize the vertical mode in the EditTextObject
+        // instance too.  No idea why we keep this state in two separate
+        // instances.
+        ScEditCell* pEditCell = static_cast<ScEditCell*>(pCell);
+        const EditTextObject* pData = pEditCell->GetData();
+        if (pData)
+            const_cast<EditTextObject*>(pData)->SetVertical(mbAsianVertical);
+    }
 }
 
 bool EditAlignmentParam::adjustHorAlignment(ScFieldEditEngine* pEngine)
@@ -2636,7 +2646,7 @@ void ScOutputData::DrawEdit(BOOL bPixelToLogic)
                                 pEngine->SetBackgroundColor( aBackCol );
                             }
 
-                            aAlignParam.setAlignmentItems(pEngine);
+                            aAlignParam.setAlignmentItems(pEngine, pCell);
 
                             //	Read content from cell
 
-- 
1.7.0.1

