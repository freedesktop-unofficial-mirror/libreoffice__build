From 2677baea2442cd0ce0b1c829bc5c5b43f87b4067 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:07:57 +0200
Subject: [PATCH 694/768] calc-formula-variable-sep-config-check-sc.diff

---
 sc/inc/docoptio.hxx               |    3 +-
 sc/inc/globstr.hrc                |    4 +-
 sc/source/core/tool/docoptio.cxx  |  101 ++++++++++++++++++-------------------
 sc/source/ui/docshell/docsh6.cxx  |   71 ++++++++++++++++++++++++++
 sc/source/ui/docshell/makefile.mk |    1 +
 sc/source/ui/inc/docsh.hxx        |    2 +
 sc/source/ui/src/globstr.src      |    4 ++
 sc/source/ui/view/gridwin.cxx     |    1 +
 8 files changed, 134 insertions(+), 53 deletions(-)

diff --git sc/inc/docoptio.hxx sc/inc/docoptio.hxx
index 8db36bd..458c68a 100644
--- sc/inc/docoptio.hxx
+++ sc/inc/docoptio.hxx
@@ -117,7 +117,8 @@ public:
     void SetFormulaSepArrayCol(const ::rtl::OUString& rSep) { aFormulaSepArrayCol = rSep; }
     ::rtl::OUString GetFormulaSepArrayCol() const { return aFormulaSepArrayCol; }
 
-    const LocaleDataWrapper& GetLocaleDataWrapper() const;
+    void ResetFormulaSeparators();
+    static const LocaleDataWrapper& GetLocaleDataWrapper();
 };
 
 
diff --git sc/inc/globstr.hrc sc/inc/globstr.hrc
index c87c9e6..339eed3 100644
--- sc/inc/globstr.hrc
+++ sc/inc/globstr.hrc
@@ -577,7 +577,9 @@
 #define STR_UNDO_SET_TAB_BG_COLOR       438
 #define STR_UNDO_SET_MULTI_TAB_BG_COLOR 439
 
-#define STR_COUNT                   440
+#define STR_OPTIONS_WARN_SEPARATORS 440
+
+#define STR_COUNT                   441
 
 #endif
 
diff --git sc/source/core/tool/docoptio.cxx sc/source/core/tool/docoptio.cxx
index efbb11f..d3952ee 100644
--- sc/source/core/tool/docoptio.cxx
+++ sc/source/core/tool/docoptio.cxx
@@ -137,63 +137,62 @@ void ScDocOptions::ResetDocOptions()
     bFormulaRegexEnabled= TRUE;
     eFormulaGrammar     = ::formula::FormulaGrammar::GRAM_NATIVE;
 
-    do
-    {
-        const Locale& rLocale = *ScGlobal::GetLocale();
-        const OUString& rLang = rLocale.Language;
-        if (rLang.equalsAscii("ru"))
-            // Don't do automatic guess for these languages, and fall back to
-            // the old separator set.
-            break;
-
-        const LocaleDataWrapper& rLocaleData = GetLocaleDataWrapper();
-        const OUString& rDecSep  = rLocaleData.getNumDecimalSep();
-        const OUString& rListSep = rLocaleData.getListSep();
-
-        if (!rDecSep.getLength() || !rListSep.getLength())
-            // Something is wrong.  Stick with the default separators.
-            break;
-
-        sal_Unicode cDecSep  = rDecSep.getStr()[0];
-        sal_Unicode cListSep = rListSep.getStr()[0];
-
-        // Excel by default uses system's list separator as the parameter
-        // separator, which in English locales is a comma.  However, OOo's list
-        // separator value is set to ';' for all English locales.  Because of this
-        // discrepancy, we will hardcode the separator value here, for now.
-        if (cDecSep == sal_Unicode('.'))
-            cListSep = sal_Unicode(',');
-
-        // Special case for de_CH locale.
-        if (rLocale.Language.equalsAsciiL("de", 2) && rLocale.Country.equalsAsciiL("CH", 2))
-            cListSep = sal_Unicode(';');
+    ResetFormulaSeparators();
+}
 
-        // by default, the parameter separator equals the locale-specific
-        // list separator.
-        aFormulaSepArg = OUString(cListSep);
+void ScDocOptions::ResetFormulaSeparators()
+{
+    // Defaults to the old separator values.
+    aFormulaSepArg = OUString::createFromAscii(";");
+    aFormulaSepArrayCol = OUString::createFromAscii(";");
+    aFormulaSepArrayRow = OUString::createFromAscii("|");
 
-        if (cDecSep == cListSep && cDecSep != sal_Unicode(';'))
-            // if the decimal and list separators are equal, set the
-            // parameter separator to be ';', unless they are both
-            // semicolon in which case don't change the decimal separator.
-            aFormulaSepArg = OUString::createFromAscii(";");
+    const Locale& rLocale = *ScGlobal::GetLocale();
+    const OUString& rLang = rLocale.Language;
+    if (rLang.equalsAscii("ru"))
+        // Don't do automatic guess for these languages, and fall back to
+        // the old separator set.
+        return;
 
-        aFormulaSepArrayCol = OUString::createFromAscii(",");
-        if (cDecSep == sal_Unicode(','))
-            aFormulaSepArrayCol = OUString::createFromAscii(".");
-        aFormulaSepArrayRow = OUString::createFromAscii(";");
+    const LocaleDataWrapper& rLocaleData = GetLocaleDataWrapper();
+    const OUString& rDecSep  = rLocaleData.getNumDecimalSep();
+    const OUString& rListSep = rLocaleData.getListSep();
 
+    if (!rDecSep.getLength() || !rListSep.getLength())
+        // Something is wrong.  Stick with the default separators.
         return;
-    }
-    while (false);
 
-    // Defaults to the old separator values.
-    aFormulaSepArg      = OUString::createFromAscii(";");
-    aFormulaSepArrayCol = OUString::createFromAscii(";");
-    aFormulaSepArrayRow = OUString::createFromAscii("|");
+    sal_Unicode cDecSep  = rDecSep.getStr()[0];
+    sal_Unicode cListSep = rListSep.getStr()[0];
+
+    // Excel by default uses system's list separator as the parameter
+    // separator, which in English locales is a comma.  However, OOo's list
+    // separator value is set to ';' for all English locales.  Because of this
+    // discrepancy, we will hardcode the separator value here, for now.
+    if (cDecSep == sal_Unicode('.'))
+        cListSep = sal_Unicode(',');
+
+    // Special case for de_CH locale.
+    if (rLocale.Language.equalsAsciiL("de", 2) && rLocale.Country.equalsAsciiL("CH", 2))
+        cListSep = sal_Unicode(';');
+
+    // by default, the parameter separator equals the locale-specific
+    // list separator.
+    aFormulaSepArg = OUString(cListSep);
+
+    if (cDecSep == cListSep && cDecSep != sal_Unicode(';'))
+        // if the decimal and list separators are equal, set the
+        // parameter separator to be ';', unless they are both
+        // semicolon in which case don't change the decimal separator.
+        aFormulaSepArg = OUString::createFromAscii(";");
+
+    aFormulaSepArrayCol = OUString::createFromAscii(",");
+    if (cDecSep == sal_Unicode(','))
+        aFormulaSepArrayCol = OUString::createFromAscii(".");
+    aFormulaSepArrayRow = OUString::createFromAscii(";");
 }
 
-const LocaleDataWrapper& ScDocOptions::GetLocaleDataWrapper() const
+const LocaleDataWrapper& ScDocOptions::GetLocaleDataWrapper()
 {
     return *ScGlobal::pLocaleData;
 }
diff --git sc/source/ui/docshell/docsh6.cxx sc/source/ui/docshell/docsh6.cxx
index 5c6a411..bb7b82f 100644
--- sc/source/ui/docshell/docsh6.cxx
+++ sc/source/ui/docshell/docsh6.cxx
@@ -53,6 +53,31 @@
 #include "tabvwsh.hxx"
 #include "tablink.hxx"
 #include "collect.hxx"
+#include "docoptio.hxx"
+#include "globstr.hrc"
+#include "scmod.hxx"
+
+#include "formula/FormulaCompiler.hxx"
+#include "comphelper/processfactory.hxx"
+#include "vcl/msgbox.hxx"
+
+#include <com/sun/star/beans/XPropertySet.hpp>
+#include <com/sun/star/container/XNameAccess.hpp>
+#include <com/sun/star/lang/XMultiServiceFactory.hpp>
+#include <com/sun/star/util/XChangesBatch.hpp>
+
+using ::com::sun::star::beans::XPropertySet;
+using ::com::sun::star::lang::XMultiServiceFactory;
+using ::com::sun::star::container::XNameAccess;
+using ::com::sun::star::util::XChangesBatch;
+using ::com::sun::star::uno::Any;
+using ::com::sun::star::uno::Exception;
+using ::com::sun::star::uno::Reference;
+using ::com::sun::star::uno::Sequence;
+using ::com::sun::star::uno::UNO_QUERY_THROW;
+using ::rtl::OUString;
+
+namespace {
 
 struct ScStylePair
 {
@@ -60,6 +85,12 @@ struct ScStylePair
     SfxStyleSheetBase *pDest;
 };
 
+inline OUString C2U(const char* s)
+{
+    return OUString::createFromAscii(s);
+}
+
+}
 
 // STATIC DATA -----------------------------------------------------------
 
@@ -466,4 +497,44 @@ BOOL ScDocShell::ReloadTabLinks()
     return TRUE;		//! Fehler erkennen
 }
 
+void ScDocShell::CheckConfigOptions()
+{
+    if (IsConfigOptionsChecked())
+        // no need to check repeatedly.
+        return;
+
+    OUString aDecSep = ScGlobal::GetpLocaleData()->getNumDecimalSep();
+
+    ScModule* pScMod = SC_MOD();
+    const ScDocOptions& rOpt = pScMod->GetDocOptions();
+    OUString aSepArg = rOpt.GetFormulaSepArg();
+    OUString aSepArrRow = rOpt.GetFormulaSepArrayRow();
+    OUString aSepArrCol = rOpt.GetFormulaSepArrayCol();
+
+    if (aDecSep == aSepArg || aDecSep == aSepArrRow || aDecSep == aSepArrCol)
+    {
+        // One of arg separators conflicts with the current decimal
+        // separator.  Reset them to default.
+        ScDocOptions aNew = rOpt;
+        aNew.ResetFormulaSeparators();
+        aDocument.SetDocOptions(aNew);
+        pScMod->SetDocOptions(aNew);
+
+        // Launch a nice warning dialog to let the users know of this change.
+        ScTabViewShell* pViewShell = GetBestViewShell();
+        if (pViewShell)
+        {
+            Window* pParent = pViewShell->GetFrameWin();
+            InfoBox aBox(pParent, ScGlobal::GetRscString(STR_OPTIONS_WARN_SEPARATORS));
+            aBox.Execute();
+        }
+
+        // For now, this is the only option setting that could launch info
+        // dialog.  But in the future we may want to implement a nicer
+        // dialog to display a list of warnings in case we have several
+        // pieces of information to display.
+    }
+
+    SetConfigOptionsChecked(true);
+}
 
diff --git sc/source/ui/docshell/makefile.mk sc/source/ui/docshell/makefile.mk
index 99a7495..dcfd042 100644
--- sc/source/ui/docshell/makefile.mk
+++ sc/source/ui/docshell/makefile.mk
@@ -98,6 +98,7 @@ EXCEPTIONSFILES= \
         $(SLO)$/docsh.obj \
         $(SLO)$/docsh3.obj	\
         $(SLO)$/docsh4.obj \
+        $(SLO)$/docsh6.obj \
         $(SLO)$/docsh8.obj \
         $(SLO)$/externalrefmgr.obj \
         $(SLO)$/dbdocimp.obj \
diff --git sc/source/ui/inc/docsh.hxx sc/source/ui/inc/docsh.hxx
index f2bc127..8517a77 100644
--- sc/source/ui/inc/docsh.hxx
+++ sc/source/ui/inc/docsh.hxx
@@ -326,6 +326,8 @@ public:
     void			UpdateLinks();			// Link-Eintraege aktuallisieren
     BOOL			ReloadTabLinks();		// Links ausfuehren (Inhalt aktualisieren)
 
+    virtual void    CheckConfigOptions();
+
     void            PostEditView( ScEditEngineDefaulter* pEditEngine, const ScAddress& rCursorPos );
 
     void            PostPaint( SCCOL nStartCol, SCROW nStartRow, SCTAB nStartTab,
diff --git sc/source/ui/src/globstr.src sc/source/ui/src/globstr.src
index b63d0ab..8fdad4f 100644
--- sc/source/ui/src/globstr.src
+++ sc/source/ui/src/globstr.src
@@ -1742,5 +1742,9 @@ Resource RID_GLOBSTR
     {
         Text [ en-US ] = "DataPilot table needs at least two rows of data to create or refresh." ;
     };
+    String STR_OPTIONS_WARN_SEPARATORS
+    {
+        Text [ en-US ] = "Because the current formula separator settings conflict with the locale, the formula separators have been reset to their default values.";
+    };
 };
 
diff --git sc/source/ui/view/gridwin.cxx sc/source/ui/view/gridwin.cxx
index 9ff4a24..132be18 100644
--- sc/source/ui/view/gridwin.cxx
+++ sc/source/ui/view/gridwin.cxx
@@ -4521,6 +4521,7 @@ void __EXPORT ScGridWindow::GetFocus()
                             //		  auf dem Mac
     }
 
+    pViewData->GetDocShell()->CheckConfigOptions();
     Window::GetFocus();
 }
 
-- 
1.7.0.1

