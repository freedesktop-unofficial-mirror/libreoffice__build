From 7bff922cfb8be92dd38949b356349e896a11fa03 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:07:11 +0200
Subject: [PATCH 659/768] sd-ppt-fix-document-summary-reading.diff

---
 sd/source/filter/ppt/propread.cxx |   11 ++++++++---
 1 files changed, 8 insertions(+), 3 deletions(-)

diff --git sd/source/filter/ppt/propread.cxx sd/source/filter/ppt/propread.cxx
index ae64ac4..7b9f508 100644
--- sd/source/filter/ppt/propread.cxx
+++ sd/source/filter/ppt/propread.cxx
@@ -468,11 +468,13 @@ void Section::Read( SvStorageStream *pStrm )
                         nPropSize += ( nTemp + 4 );
                     break;
 
-                    case VT_LPWSTR :
+                    case VT_LPWSTR : {
                         *pStrm >> nTemp;
-                        nPropSize += ( nTemp << 1 ) + 4;
+                        // looks like these are aligned to 4 bytes
+                        sal_uInt32 nLength = nPropOfs + nSecOfs + nPropSize + ( nTemp << 1 ) + 4;
+                        nPropSize += ( nTemp << 1 ) + 4 + (nLength % 4);
                     break;
-
+                    }
                     case VT_BLOB_OBJECT :
                     case VT_BLOB :
                     case VT_CF :
@@ -501,6 +503,9 @@ void Section::Read( SvStorageStream *pStrm )
             if ( nPropSize )
             {
                 pStrm->Seek( nPropOfs + nSecOfs );
+                // make sure we don't overflow the section size
+                if( nPropSize > nSecSize - nSecOfs )
+                    nPropSize = nSecSize - nSecOfs;
                 sal_uInt8* pBuf = new sal_uInt8[ nPropSize ];
                 pStrm->Read( pBuf, nPropSize );
                 AddProperty( nPropId, pBuf, nPropSize );
-- 
1.7.0.1

