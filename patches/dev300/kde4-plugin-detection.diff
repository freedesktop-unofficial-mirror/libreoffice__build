diff --git vcl/unx/source/plugadapt/salplug.cxx vcl/unx/source/plugadapt/salplug.cxx
index a104ce3..3c71b47 100644
--- vcl/unx/source/plugadapt/salplug.cxx
+++ vcl/unx/source/plugadapt/salplug.cxx
@@ -55,13 +55,16 @@ typedef SalInstance*(*salFactoryProc)( oslModule pModule);
 
 static oslModule pCloseModule = NULL;
 
-#define DESKTOP_NONE 0
-#define DESKTOP_UNKNOWN 1
-#define DESKTOP_GNOME 2
-#define DESKTOP_KDE 3
-#define DESKTOP_CDE 4
+enum {
+    DESKTOP_NONE = 0,
+    DESKTOP_UNKNOWN,
+    DESKTOP_GNOME,
+    DESKTOP_KDE,
+    DESKTOP_KDE4,
+    DESKTOP_CDE
+};
 
-static const char * desktop_strings[5] = { "none", "unknown", "GNOME", "KDE", "CDE" };
+static const char * desktop_strings[] = { "none", "unknown", "GNOME", "KDE", "KDE4", "CDE" };
 
 static SalInstance* tryInstance( const OUString& rModuleBase )
 {
@@ -302,15 +305,36 @@ static OUString getNetWMName( Display* pDisplay )
     return aRet;
 }
 
-static bool is_kde_desktop( Display* pDisplay )
+static bool is_kde_desktop(Display*)
 {
     if ( NULL != getenv( "KDE_FULL_SESSION" ) )
-        return true;
+    {
+        const char *pVer = getenv( "KDE_SESSION_VERSION" );
+        if ( !pVer || pVer[0] == '0' )
+		{
+            return true; // does not exist => KDE3
+		}
+
+        rtl::OUString aVer( RTL_CONSTASCII_USTRINGPARAM( "3" ) );
+        if ( aVer.equalsIgnoreAsciiCaseAscii( pVer ) )
+		{
+            return true;
+		}
+    }
     
-    // check for kwin
-    rtl::OUString aWM = getNetWMName( pDisplay );
-    if( aWM.equalsIgnoreAsciiCaseAscii( "KWin" ) )
-        return true;
+    return false;
+}
+
+static bool is_kde4_desktop(Display*)
+{
+    if ( NULL != getenv( "KDE_FULL_SESSION" ) )
+    {
+        rtl::OUString aVer( RTL_CONSTASCII_USTRINGPARAM( "4" ) );
+
+        const char *pVer = getenv( "KDE_SESSION_VERSION" );
+        if ( pVer && aVer.equalsIgnoreAsciiCaseAscii( pVer ) )
+            return true;
+    }
     
     return false;
 }
@@ -344,6 +368,8 @@ static const char * get_desktop_environment()
             pRet = desktop_strings[DESKTOP_CDE];
         if ( aOver.equalsIgnoreAsciiCase( "kde" ) )
             pRet = desktop_strings[DESKTOP_KDE];
+        if ( aOver.equalsIgnoreAsciiCase( "kde4" ) )
+            pRet = desktop_strings[DESKTOP_KDE4];
         if ( aOver.equalsIgnoreAsciiCase( "gnome" ) )
             pRet = desktop_strings[DESKTOP_GNOME];
         if ( aOver.equalsIgnoreAsciiCase( "none" ) )
@@ -384,7 +410,9 @@ static const char * get_desktop_environment()
             {
                 XErrorHandler pOldHdl = XSetErrorHandler( autodect_error_handler );
             
-                if ( is_kde_desktop( pDisplay ) )
+                if ( is_kde4_desktop( pDisplay ) )
+                    pRet = desktop_strings[DESKTOP_KDE4];
+                else if ( is_kde_desktop( pDisplay ) )
                     pRet = desktop_strings[DESKTOP_KDE];
                 else if ( is_gnome_desktop( pDisplay ) )
                     pRet = desktop_strings[DESKTOP_GNOME];
@@ -417,6 +445,8 @@ static const char* autodetect_plugin()
         pRet = "gtk";
     else if( desktop == desktop_strings[DESKTOP_KDE] )
         pRet = "kde";
+    else if( desktop == desktop_strings[DESKTOP_KDE4] )
+        pRet = "kde4";
     else
     {
         // #i95296# use the much nicer looking gtk plugin
diff --git vcl/util/makefile.mk vcl/util/makefile.mk
index 317ffba..217ce3e 100644
--- vcl/util/makefile.mk
+++ vcl/util/makefile.mk
@@ -387,7 +387,7 @@ SHL5IMPLIB=ikde_plug_
 SHL5LIBS=$(LIB5TARGET)
 SHL5DEPN=$(SHL2TARGETN)
 # libs for KDE plugin
-SHL5STDLIBS=$(KDE_LIBS)
+SHL5LINKFLAGS+=$(KDE_LIBS)
 SHL5STDLIBS+=-l$(SHL2TARGET)
 SHL5STDLIBS+=\
         $(VCLLIB)       \
@@ -404,6 +404,35 @@ SHL5STDLIBS+= $(XRANDR_LIBS)
 
 .ENDIF # "$(ENABLE_KDE)" != ""
 
+# KDE4 plugin
+.IF "$(ENABLE_KDE4)" != ""
+.IF "$(KDE4_ROOT)"!=""
+EXTRALIBPATHS+=-L$(KDE4_ROOT)$/lib
+.ENDIF
+LIB6TARGET=$(SLB)$/ikde4_plug_
+LIB6FILES=$(SLB)$/kde4plug.lib
+SHL6TARGET=vclplug_kde4$(DLLPOSTFIX)
+SHL6IMPLIB=ikde4_plug_
+SHL6LIBS=$(LIB6TARGET)
+SHL6DEPN=$(SHL2TARGETN)
+# libs for KDE4 plugin
+SHL6LINKFLAGS+=$(KDE4_LIBS)
+SHL6STDLIBS+=-l$(SHL2TARGET)
+SHL6STDLIBS+=\
+        $(VCLLIB)       \
+        $(PSPLIB)	\
+        $(TOOLSLIB)     \
+        $(VOSLIB)       \
+        $(SALLIB)
+
+.IF "$(ENABLE_RANDR)" != ""
+.IF "$(XRANDR_DLOPEN)" == "FALSE"
+SHL6STDLIBS+= $(XRANDR_LIBS)
+.ENDIF
+.ENDIF
+
+.ENDIF # "$(ENABLE_KDE4)" != ""
+
 .ENDIF # UNX
 
 # --- Allgemein ----------------------------------------------------------
