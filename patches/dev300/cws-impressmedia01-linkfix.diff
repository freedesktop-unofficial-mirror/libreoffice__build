Replace Package uri with relative path, for embedded media

From: Thorsten Behrens <tbehrens@novell.com>


---

 xmloff/source/draw/shapeexport2.cxx       |   14 +++++++++++++-
 1 files changed, 34 insertions(+), 2 deletions(-)


diff --git xmloff/source/draw/shapeexport2.cxx xmloff/source/draw/shapeexport2.cxx
index 2a10dc2..1137372 100644
--- xmloff/source/draw/shapeexport2.cxx
+++ xmloff/source/draw/shapeexport2.cxx
@@ -1966,7 +1966,19 @@ void XMLShapeExport::ImpExportMediaShape(
         // export media url
         OUString aMediaURL;
         xPropSet->getPropertyValue( OUString( RTL_CONSTASCII_USTRINGPARAM( "MediaURL" ) ) ) >>= aMediaURL;
-        mrExport.AddAttribute ( XML_NAMESPACE_XLINK, XML_HREF, GetExport().GetRelativeReference( aMediaURL ) );
+
+        const rtl::OUString sPackageURL( RTL_CONSTASCII_USTRINGPARAM("vnd.sun.star.Package:") );
+        if( aMediaURL.match( sPackageURL, 0 ) )
+        {
+            // embedded media, strip package prefix
+            aMediaURL = aMediaURL.copy( sPackageURL.getLength(), 
+                                        aMediaURL.getLength() - sPackageURL.getLength() );
+        }
+        else
+        {
+            aMediaURL = GetExport().GetRelativeReference( aMediaURL );
+        }
+        mrExport.AddAttribute ( XML_NAMESPACE_XLINK, XML_HREF, aMediaURL );
         mrExport.AddAttribute ( XML_NAMESPACE_XLINK, XML_TYPE, XML_SIMPLE );
         mrExport.AddAttribute ( XML_NAMESPACE_XLINK, XML_SHOW, XML_EMBED );
         mrExport.AddAttribute ( XML_NAMESPACE_XLINK, XML_ACTUATE, XML_ONLOAD );
