From a0118c59408573f903e00c0605bd7e5f28d25778 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:08:27 +0200
Subject: [PATCH 816/878] calc-autodecimal-ods-fix.diff

---
 sc/source/core/tool/docoptio.cxx |    2 +-
 sc/source/ui/unoobj/defltuno.cxx |    9 ++++++++-
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/sc/source/core/tool/docoptio.cxx b/sc/source/core/tool/docoptio.cxx
index d2870fe..865e5b1 100644
--- a/sc/source/core/tool/docoptio.cxx
+++ b/sc/source/core/tool/docoptio.cxx
@@ -125,7 +125,7 @@ void ScDocOptions::ResetDocOptions()
     bIsIter				= FALSE;
     nIterCount			= 100;
     fIterEps			= 1.0E-3;
-    nPrecStandardFormat	= 2;
+    nPrecStandardFormat = SvNumberFormatter::UNLIMITED_PRECISION;
     nDay				= 30;
     nMonth				= 12;
     nYear				= 1899;
diff --git a/sc/source/ui/unoobj/defltuno.cxx b/sc/source/ui/unoobj/defltuno.cxx
index 93a538f..ea423a8 100644
--- a/sc/source/ui/unoobj/defltuno.cxx
+++ b/sc/source/ui/unoobj/defltuno.cxx
@@ -46,6 +46,8 @@
 #include "unonames.hxx"
 #include "docoptio.hxx"
 
+#include <limits>
+
 using namespace ::com::sun::star;
 
 //------------------------------------------------------------------------
@@ -250,7 +252,12 @@ uno::Any SAL_CALL ScDocDefaultsObj::getPropertyValue( const rtl::OUString& aProp
             if (pDoc)
             {
                 const ScDocOptions& aDocOpt = pDoc->GetDocOptions();
-                aRet <<= static_cast<sal_Int16> (aDocOpt.GetStdPrecision());
+                sal_uInt16 nPrec = aDocOpt.GetStdPrecision();
+                // the max value of unsigned 16-bit integer is used as the flag
+                // value for unlimited precision, c.f.
+                // SvNumberFormatter::UNLIMITED_PRECISION.
+                if (nPrec <= ::std::numeric_limits<sal_Int16>::max())
+                    aRet <<= static_cast<sal_Int16> (nPrec);
             }
             else
                 throw uno::RuntimeException();
-- 
1.7.0.1

