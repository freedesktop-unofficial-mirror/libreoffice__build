From f33d24071860474b591ada411e303dc46c6176d7 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:06:01 +0200
Subject: [PATCH 696/878] xlsx-export-simple-autofilter.diff

---
 sc/source/filter/xlsx/excrecds.hxx      |    1 +
 sc/source/filter/xlsx/xlsx-excrecds.cxx |    9 +++++++--
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/sc/source/filter/xlsx/excrecds.hxx b/sc/source/filter/xlsx/excrecds.hxx
index c7e9231..358c925 100644
--- a/sc/source/filter/xlsx/excrecds.hxx
+++ b/sc/source/filter/xlsx/excrecds.hxx
@@ -474,6 +474,7 @@ private:
     XclExpFiltermode*   pFilterMode;
     XclExpAutofilterinfo* pFilterInfo;
     ScRange                 maRef;
+    bool mbAutoFilter;
 };
 
 // ----------------------------------------------------------------------------
diff --git a/sc/source/filter/xlsx/xlsx-excrecds.cxx b/sc/source/filter/xlsx/xlsx-excrecds.cxx
index b651315..8d9adc6 100644
--- a/sc/source/filter/xlsx/xlsx-excrecds.cxx
+++ b/sc/source/filter/xlsx/xlsx-excrecds.cxx
@@ -840,6 +840,7 @@ ExcAutoFilterRecs::ExcAutoFilterRecs( const XclExpRoot& rRoot, SCTAB nTab ) :
     XclExpRoot( rRoot ),
     pFilterMode( NULL ),
     pFilterInfo( NULL )
+    , mbAutoFilter (false)
 {
     ScDBCollection& rDBColl = GetDatabaseRanges();
     XclExpNameManager& rNameMgr = GetNameManager();
@@ -940,6 +941,9 @@ ExcAutoFilterRecs::ExcAutoFilterRecs( const XclExpRoot& rRoot, SCTAB nTab ) :
             if( !maFilterList.IsEmpty() )
                 pFilterMode = new XclExpFiltermode;
             pFilterInfo = new XclExpAutofilterinfo( aRange.aStart, nColCnt );
+
+            if (maFilterList.IsEmpty () && !bConflict)
+                mbAutoFilter = true;
         }
     }
 }
@@ -997,7 +1001,7 @@ void ExcAutoFilterRecs::Save( XclExpStream& rStrm )
 
 void ExcAutoFilterRecs::SaveXml( XclExpXmlStream& rStrm )
 {
-    if( maFilterList.IsEmpty() )
+    if( maFilterList.IsEmpty() && !mbAutoFilter )
         return;
 
     sax_fastparser::FSHelperPtr& rWorksheet = rStrm.GetCurrentStream();
@@ -1005,7 +1009,8 @@ void ExcAutoFilterRecs::SaveXml( XclExpXmlStream& rStrm )
             XML_ref,    XclXmlUtils::ToOString( maRef ).getStr(),
             FSEND );
     // OOXTODO: XML_extLst, XML_sortState
-    maFilterList.SaveXml( rStrm );
+    if( !maFilterList.IsEmpty() )
+        maFilterList.SaveXml( rStrm );
     rWorksheet->endElement( XML_autoFilter );
 }
 
-- 
1.7.0.1

