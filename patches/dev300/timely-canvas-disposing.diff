From c856c3b1e070fbb279d01ca5b28b1353ddeae66f Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:05:06 +0200
Subject: [PATCH 575/768] timely-canvas-disposing.diff

---
 sd/source/ui/slideshow/slideshow.cxx |    9 +++++++--
 vcl/source/window/wrkwin.cxx         |   14 ++++++++++++++
 2 files changed, 21 insertions(+), 2 deletions(-)

diff --git sd/source/ui/slideshow/slideshow.cxx sd/source/ui/slideshow/slideshow.cxx
index 1f47c38..b7a0eb2 100644
--- sd/source/ui/slideshow/slideshow.cxx
+++ sd/source/ui/slideshow/slideshow.cxx
@@ -699,6 +699,13 @@ void SAL_CALL SlideShow::end() throw(RuntimeException)
         ViewShellBase* pFullScreenViewShellBase = mpFullScreenViewShellBase;
         mpFullScreenViewShellBase = 0;
 
+        // dispose before fullscreen window changes screens
+        // (potentially). If this needs to be moved behind
+        // pWorkWindow->StartPresentationMode() again, read issue
+        // pWorkWindow->i94007 & implement the solution outlined
+        // there.
+        xController->dispose();
+
         if( pFullScreenViewShellBase )
         {
             PresentationViewShell* pShell = dynamic_cast<PresentationViewShell*>(pFullScreenViewShellBase->GetMainViewShell().get());
@@ -713,8 +720,6 @@ void SAL_CALL SlideShow::end() throw(RuntimeException)
             }
         }
 
-        xController->dispose();
-
         if( pFullScreenViewShellBase )
         {
             PresentationViewShell* pShell = NULL;
diff --git vcl/source/window/wrkwin.cxx vcl/source/window/wrkwin.cxx
index 916dc8e..71cf334 100644
--- vcl/source/window/wrkwin.cxx
+++ vcl/source/window/wrkwin.cxx
@@ -43,6 +43,8 @@
 #include <vcl/window.h>
 #include <vcl/wrkwin.hxx>
 #include <vcl/sysdata.hxx>
+#include <com/sun/star/lang/XComponent.hpp>
+#include <com/sun/star/rendering/XCanvas.hpp>
 
 // =======================================================================
 
@@ -192,6 +194,18 @@ void WorkWindow::ShowFullScreenMode( BOOL bFullScreenMode, sal_Int32 nDisplay )
     mbFullScreenMode = bFullScreenMode != 0;
     if ( !mbSysChild )
     {
+        // Dispose of the canvas implementation, which might rely on
+        // screen-specific system data.
+        com::sun::star::uno::Reference< com::sun::star::rendering::XCanvas > xCanvas( mpWindowImpl->mxCanvas );
+        if( xCanvas.is() )
+        {
+            com::sun::star::uno::Reference< com::sun::star::lang::XComponent >
+                xCanvasComponent( xCanvas,
+                                  com::sun::star::uno::UNO_QUERY );
+            if( xCanvasComponent.is() )
+                xCanvasComponent->dispose();
+        }
+
         mpWindowImpl->mpFrameWindow->mpWindowImpl->mbWaitSystemResize = TRUE;
         ImplGetFrame()->ShowFullScreen( bFullScreenMode, nDisplay );
     }
-- 
1.7.0.1

