From ba0aa89f1a6dfc5b15f2f614d3f94ce00c86685a Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 16:54:37 +0200
Subject: [PATCH 115/878] sfx-check-real-help-path.diff

---
 sfx2/source/appl/sfxhelp.cxx          |   19 +++++++++----------
 svtools/source/config/pathoptions.cxx |    6 +++++-
 2 files changed, 14 insertions(+), 11 deletions(-)

diff --git a/sfx2/source/appl/sfxhelp.cxx b/sfx2/source/appl/sfxhelp.cxx
index 1ce2ebd..62c10d6 100644
--- a/sfx2/source/appl/sfxhelp.cxx
+++ b/sfx2/source/appl/sfxhelp.cxx
@@ -52,10 +52,10 @@
 #include <com/sun/star/frame/XModuleManager.hpp>
 #include <unotools/configmgr.hxx>
 #include <unotools/configitem.hxx>
+#include <unotools/localfilehelper.hxx>
 #include <svtools/helpopt.hxx>
 #include <svtools/moduleoptions.hxx>
 #include <tools/urlobj.hxx>
-#include <unotools/configmgr.hxx>
 #include <ucbhelper/content.hxx>
 
 #include <svtools/pathoptions.hxx>
@@ -132,13 +132,13 @@ rtl::OUString HelpLocaleString()
         bool bOk = (aLocale >>= aLocaleStr);
         if ( bOk )
         {
-            rtl::OUString aBaseInstallPath;
-            // utl::Bootstrap::PathStatus aBaseLocateResult =
-            utl::Bootstrap::locateBaseInstallation(aBaseInstallPath);
-            static const char *szHelpPath = "/help/";
+            String sBaseHelpPathString;
+            ::utl::LocalFileHelper::ConvertPhysicalNameToURL( SvtPathOptions().GetHelpPath(), sBaseHelpPathString );
+
+            rtl::OUString sBaseHelpPath( sBaseHelpPathString );
+            sBaseHelpPath += rtl::OUString::createFromAscii("/");
 
-            rtl::OUString sHelpPath = aBaseInstallPath +
-                rtl::OUString::createFromAscii(szHelpPath) + aLocaleStr;
+            rtl::OUString sHelpPath = sBaseHelpPath + aLocaleStr;
             osl::DirectoryItem aDirItem;
 
             if (!osl::DirectoryItem::get(sHelpPath, aDirItem) == osl::FileBase::E_None)
@@ -149,9 +149,8 @@ rtl::OUString HelpLocaleString()
                 if (nSepPos != STRING_NOTFOUND)
                 {
                     bOk = true;
-                    sLang = sLang.Copy( 0, nSepPos );
-                    sHelpPath = aBaseInstallPath +
-                        rtl::OUString::createFromAscii(szHelpPath) + sLang;
+                        sLang = sLang.Copy( 0, nSepPos );
+                    sHelpPath = sBaseHelpPath + sLang;
                     if (!osl::DirectoryItem::get(sHelpPath, aDirItem) == osl::FileBase::E_None)
                         bOk = false;
                 }
diff --git a/svtools/source/config/pathoptions.cxx b/svtools/source/config/pathoptions.cxx
index 9d8628a..ae5a073 100644
--- a/svtools/source/config/pathoptions.cxx
+++ b/svtools/source/config/pathoptions.cxx
@@ -299,7 +299,11 @@ const String& SvtPathOptions_Impl::GetPath( SvtPathOptions::Pathes ePath )
         {
             // These office paths have to be converted to system pathes
             utl::LocalFileHelper::ConvertURLToPhysicalName( aPathValue, aResult );
-            aPathValue = aResult;
+            // FIXME: The initial value (not modified by SetPath) is just a path, so the URL-conversion fails.
+            //        The best solution is to fix the module xmlhelp to accept the URL. Then we could remove
+            //        all these ugly conversions.
+            if ( aResult.Len() != 0 )
+                aPathValue = aResult;
         }
 
         m_aPathArray[ ePath ] = aPathValue;
-- 
1.7.0.1

