From df21e6febddff9f6be9c4096acd217a948af311c Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:00:43 +0200
Subject: [PATCH 421/878] oox-xlsx-import-fix-connector-shape.diff

---
 oox/source/drawingml/shape.cxx     |   12 ++++++++++++
 oox/source/token/properties.txt    |    1 +
 oox/source/xls/drawingfragment.cxx |   22 +++++++++++++++++++---
 3 files changed, 32 insertions(+), 3 deletions(-)

diff --git a/oox/source/drawingml/shape.cxx b/oox/source/drawingml/shape.cxx
index e6e373a..dbf9da8 100644
--- a/oox/source/drawingml/shape.cxx
+++ b/oox/source/drawingml/shape.cxx
@@ -43,6 +43,7 @@
 #include <com/sun/star/beans/XMultiPropertySet.hpp>
 #include <com/sun/star/lang/XMultiServiceFactory.hpp>
 #include <com/sun/star/drawing/HomogenMatrix3.hpp>
+#include <com/sun/star/drawing/ConnectorType.hpp>
 #include <com/sun/star/text/XText.hpp>
 #include <basegfx/point/b2dpoint.hxx>
 #include <basegfx/polygon/b2dpolygon.hxx>
@@ -331,6 +332,17 @@ Reference< XShape > Shape::createAndInsert(
 
         maShapeProperties[ PROP_StartPosition ] <<= aAWTStartPosition;
         maShapeProperties[ PROP_EndPosition ] <<= aAWTEndPosition;
+
+        // set the connector type
+        rtl::OUString sConnectorType = mpCustomShapePropertiesPtr->getShapePresetType();
+        // FIXME: handle other connector type, should be use XEnhancedCustomShapeDefaulter?
+        ConnectorType eConnectorType = ConnectorType_STANDARD;
+        if( sConnectorType.equalsAscii("mso-spt32") )
+            eConnectorType = ConnectorType_LINE;
+        else if( sConnectorType.equalsAscii("mso-spt38") )
+            eConnectorType = ConnectorType_CURVE;
+
+        maShapeProperties[ PROP_EdgeKind ] <<= eConnectorType;
     }
     else
     {
diff --git a/oox/source/token/properties.txt b/oox/source/token/properties.txt
index 4569d8c..3100d8e 100644
--- a/oox/source/token/properties.txt
+++ b/oox/source/token/properties.txt
@@ -107,6 +107,7 @@ DisplayLabels
 DrillDownOnDoubleClick
 Dropdown
 EchoChar
+EdgeKind
 Enabled
 EndPosition
 ErrorAlertStyle
diff --git a/oox/source/xls/drawingfragment.cxx b/oox/source/xls/drawingfragment.cxx
index 56e1c88..f91bcb7 100644
--- a/oox/source/xls/drawingfragment.cxx
+++ b/oox/source/xls/drawingfragment.cxx
@@ -522,10 +522,26 @@ void OoxDrawingFragment::onEndElement( const OUString& rChars )
         case XDR_TOKEN( absoluteAnchor ):
         case XDR_TOKEN( oneCellAnchor ):
         case XDR_TOKEN( twoCellAnchor ):
-            if( mxDrawPage.is() && mxShape.get() && mxAnchor.get() && mxAnchor->isValidAnchor() )
+            if( mxDrawPage.is() && mxShape.get() )
             {
-                Rectangle aLoc = mxAnchor->calcEmuLocation( maEmuSheetSize );
-                if( (aLoc.X >= 0) && (aLoc.Y >= 0) && (aLoc.Width >= 0) && (aLoc.Height >= 0) )
+                // It seems the position and size are incorrect to use cellAnchor to create the shape
+                // so if the size and position are defined, use them to set the shape postion and size.
+                Rectangle aLoc( -1, -1, -1, -1 );;
+                Size aSize = mxShape->getSize();
+                if( aSize.Width > 0 || aSize.Height > 0 )
+                {
+                    Point aPoint = mxShape->getPosition();
+                    aLoc.X = aPoint.X;
+                    aLoc.Y = aPoint.Y;
+                    aLoc.Width = aSize.Width;
+                    aLoc.Height = aSize.Height;
+                }
+                else if( mxAnchor.get() && mxAnchor->isValidAnchor() )
+                {
+                    aLoc = mxAnchor->calcEmuLocation( maEmuSheetSize );
+                }
+
+                if( (aLoc.Width >= 0) && (aLoc.Height >= 0) )
                     mxShape->addShape( getOoxFilter(), getThemeRef(), mxDrawPage, &aLoc );
             }
             mxShape.reset();
-- 
1.7.0.1

