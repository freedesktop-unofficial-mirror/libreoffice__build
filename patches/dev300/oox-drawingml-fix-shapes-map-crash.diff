---
 oox/inc/oox/export/shapes.hxx            |   32 +++++++++++++++++------------
 oox/source/export/shapes.cxx             |   16 +++++++++-----
 sd/source/filter/pptx/epptooxml.hxx      |    4 ++-
 sd/source/filter/pptx/pptx-epptooxml.cxx |   15 ++++++++-----
 4 files changed, 41 insertions(+), 26 deletions(-)

diff --git oox/inc/oox/export/shapes.hxx oox/inc/oox/export/shapes.hxx
index 0814281..74d9a54 100644
--- oox/inc/oox/export/shapes.hxx
+++ oox/inc/oox/export/shapes.hxx
@@ -49,16 +49,7 @@ namespace oox { namespace drawingml {
 
 class OOX_DLLPUBLIC ShapeExport : public DrawingML {
 
-protected:
-    sal_Int32           mnShapeIdMax, mnPictureIdMax;
-
 private:
-    sal_Int32           mnXmlNamespace;
-    Fraction            maFraction;
-    MapMode             maMapModeSrc, maMapModeDest;
-
-    ::com::sun::star::awt::Size MapSize( const ::com::sun::star::awt::Size& ) const;
-
     struct ShapeCheck
     {
         bool operator()( const ::com::sun::star::uno::Reference< ::com::sun::star::drawing::XShape> s1, const ::com::sun::star::uno::Reference< ::com::sun::star::drawing::XShape> s2 ) const
@@ -74,11 +65,25 @@ private:
         size_t operator()( const ::com::sun::star::uno::Reference < ::com::sun::star::drawing::XShape > ) const;
     };
 
+public:
     typedef std::hash_map< const ::com::sun::star::uno::Reference< ::com::sun::star::drawing::XShape>, sal_Int32, ShapeHash, ShapeCheck> ShapeHashMap;
-    static ShapeHashMap saShapeMap;
+
+protected:
+    sal_Int32           mnShapeIdMax, mnPictureIdMax;
+
+private:
+    sal_Int32           mnXmlNamespace;
+    Fraction            maFraction;
+    MapMode             maMapModeSrc, maMapModeDest;
+
+    ::com::sun::star::awt::Size MapSize( const ::com::sun::star::awt::Size& ) const;
+
+    ShapeHashMap maShapeMap;
+    ShapeHashMap* mpShapeMap;
 
 public:
-    ShapeExport( sal_Int32 nXmlNamespace, ::sax_fastparser::FSHelperPtr pFS, ::oox::core::XmlFilterBase* pFB = NULL, DocumentType eDocumentType = DOCUMENT_PPTX );
+
+    ShapeExport( sal_Int32 nXmlNamespace, ::sax_fastparser::FSHelperPtr pFS, ShapeHashMap* pShapeMap = NULL, ::oox::core::XmlFilterBase* pFB = NULL, DocumentType eDocumentType = DOCUMENT_PPTX );
     virtual ~ShapeExport() {}
 
     sal_Int32           GetXmlNamespace() const;
@@ -157,8 +162,9 @@ public:
                         WriteUnknownShape( ::com::sun::star::uno::Reference< ::com::sun::star::drawing::XShape > xShape );
 
     sal_Int32 GetNewShapeID( const ::com::sun::star::uno::Reference< ::com::sun::star::drawing::XShape > rShape );
-    static sal_Int32 GetNewShapeID( const ::com::sun::star::uno::Reference< ::com::sun::star::drawing::XShape > rShape, ::oox::core::XmlFilterBase* pFB );
-    static sal_Int32 GetShapeID( const ::com::sun::star::uno::Reference< ::com::sun::star::drawing::XShape > rShape );
+    sal_Int32 GetNewShapeID( const ::com::sun::star::uno::Reference< ::com::sun::star::drawing::XShape > rShape, ::oox::core::XmlFilterBase* pFB );
+    sal_Int32 GetShapeID( const ::com::sun::star::uno::Reference< ::com::sun::star::drawing::XShape > rShape );
+    static sal_Int32 GetShapeID( const ::com::sun::star::uno::Reference< ::com::sun::star::drawing::XShape > rShape, ShapeHashMap* pShapeMap );
 };
 
 }}
diff --git oox/source/export/shapes.cxx oox/source/export/shapes.cxx
index 3306967..a8d62c7 100644
--- oox/source/export/shapes.cxx
+++ oox/source/export/shapes.cxx
@@ -358,7 +358,7 @@ namespace oox { namespace drawingml {
     if ( GETA(propName) ) \
         mAny >>= variable;
 
-ShapeExport::ShapeExport( sal_Int32 nXmlNamespace, FSHelperPtr pFS, XmlFilterBase* pFB, DocumentType eDocumentType )
+ShapeExport::ShapeExport( sal_Int32 nXmlNamespace, FSHelperPtr pFS, ShapeHashMap* pShapeMap, XmlFilterBase* pFB, DocumentType eDocumentType )
     : DrawingML( pFS, pFB, eDocumentType )
     , mnShapeIdMax( 1 )
     , mnPictureIdMax( 1 )
@@ -366,6 +366,7 @@ ShapeExport::ShapeExport( sal_Int32 nXmlNamespace, FSHelperPtr pFS, XmlFilterBas
     , maFraction( 1, 576 )
     , maMapModeSrc( MAP_100TH_MM )
     , maMapModeDest( MAP_INCH, Point(), maFraction, maFraction )
+    , mpShapeMap( pShapeMap ? pShapeMap : &maShapeMap )
 {
 }
 
@@ -986,24 +987,27 @@ sal_Int32 ShapeExport::GetNewShapeID( const Reference< XShape > rXShape, XmlFilt
 
     sal_Int32 nID = pFB->GetUniqueId();
 
-    saShapeMap[ rXShape ] = nID;
+    (*mpShapeMap)[ rXShape ] = nID;
 
     return nID;
 }
 
 sal_Int32 ShapeExport::GetShapeID( const Reference< XShape > rXShape )
 {
+    return GetShapeID( rXShape, mpShapeMap );
+}
+
+sal_Int32 ShapeExport::GetShapeID( const Reference< XShape > rXShape, ShapeHashMap* pShapeMap )
+{
     if( !rXShape.is() )
         return -1;
 
-    ShapeHashMap::const_iterator aIter = saShapeMap.find( rXShape );
+    ShapeHashMap::const_iterator aIter = pShapeMap->find( rXShape );
 
-    if( aIter == saShapeMap.end() )
+    if( aIter == pShapeMap->end() )
         return -1;
 
     return aIter->second;
 }
 
-ShapeExport::ShapeHashMap ShapeExport::saShapeMap;
-
 } }
diff --git sd/source/filter/pptx/epptooxml.hxx sd/source/filter/pptx/epptooxml.hxx
index 2c850bd..02d3930 100644
--- sd/source/filter/pptx/epptooxml.hxx
+++ sd/source/filter/pptx/epptooxml.hxx
@@ -3,7 +3,7 @@
 
 #include <oox/core/xmlfilterbase.hxx>
 #include <oox/helper/zipstorage.hxx>
-
+#include <oox/export/shapes.hxx>
 #include "epptbase.hxx"
 
 namespace com { namespace sun { namespace star {
@@ -125,6 +125,8 @@ private:
     sal_Bool mbCreateNotes;
 
     static sal_Int32 nStyleLevelToken[5];
+
+    ::oox::drawingml::ShapeExport::ShapeHashMap maShapeMap;
 };
 
 }
diff --git sd/source/filter/pptx/pptx-epptooxml.cxx sd/source/filter/pptx/pptx-epptooxml.cxx
index b0aeabf..c71c57f 100644
--- sd/source/filter/pptx/pptx-epptooxml.cxx
+++ sd/source/filter/pptx/pptx-epptooxml.cxx
@@ -79,7 +79,7 @@ class PowerPointShapeExport : public ShapeExport
     PageType            mePageType;
     sal_Bool            mbMaster;
 public:
-                        PowerPointShapeExport( FSHelperPtr pFS, PowerPointExport* pFB );
+    PowerPointShapeExport( FSHelperPtr pFS, ShapeHashMap* pShapeMap, PowerPointExport* pFB );
     void                SetMaster( sal_Bool bMaster );
     void                SetPageType( PageType ePageType );
     ShapeExport&        WriteNonVisualProperties( Reference< XShape > xShape );
@@ -92,8 +92,8 @@ public:
     sal_Bool WritePlaceholder( Reference< XShape > xShape, PlaceholderType ePlaceholder, sal_Bool bMaster );
 };
 
-PowerPointShapeExport::PowerPointShapeExport( FSHelperPtr pFS, PowerPointExport* pFB )
-    : ShapeExport( XML_p, pFS, pFB )
+    PowerPointShapeExport::PowerPointShapeExport( FSHelperPtr pFS, ShapeHashMap* pShapeMap, PowerPointExport* pFB )
+        : ShapeExport( XML_p, pFS, pShapeMap, pFB )
     , mrExport( *pFB )
 {
 }
@@ -218,6 +218,7 @@ bool PowerPointExport::importDocument() throw()
 bool PowerPointExport::exportDocument() throw()
 {
     DrawingML::ResetCounters();
+    maShapeMap.clear ();
 
     addRelation( US( "http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" ), S( "ppt/presentation.xml" ) );
 
@@ -250,6 +251,8 @@ bool PowerPointExport::exportDocument() throw()
 
     commit();
 
+    maShapeMap.clear ();
+
     return true;
 }
 
@@ -274,7 +277,7 @@ void PowerPointExport::ImplWriteBackground( FSHelperPtr pFS, Reference< XPropert
     pFS->startElementNS( XML_p, XML_bg, FSEND );
     pFS->startElementNS( XML_p, XML_bgPr, FSEND );
 
-    PowerPointShapeExport( pFS, this ).WriteFill( rXPropSet );
+    PowerPointShapeExport( pFS, &maShapeMap, this ).WriteFill( rXPropSet );
 
     pFS->endElementNS( XML_p, XML_bgPr );
     pFS->endElementNS( XML_p, XML_bg );
@@ -631,7 +634,7 @@ void PowerPointExport::WriteAnimationTarget( FSHelperPtr pFS, Any aTarget )
     if( rXShape.is() ) {
     pFS->startElementNS( XML_p, XML_tgtEl, FSEND );
     pFS->singleElementNS( XML_p, XML_spTgt,
-                  XML_spid, I32S( ShapeExport::GetShapeID( rXShape ) ),
+                  XML_spid, I32S( ShapeExport::GetShapeID( rXShape, &maShapeMap ) ),
                   FSEND );
     pFS->endElementNS( XML_p, XML_tgtEl );
     }
@@ -1440,7 +1443,7 @@ void PowerPointExport::ImplWriteLayout( sal_Int32 nOffset, sal_uInt32 nMasterNum
 
 void PowerPointExport::WriteShapeTree( FSHelperPtr pFS, PageType ePageType, sal_Bool bMaster )
 {
-    PowerPointShapeExport aDML( pFS, this );
+    PowerPointShapeExport aDML( pFS, &maShapeMap, this );
     aDML.SetMaster( bMaster );
     aDML.SetPageType( ePageType );
     sal_uInt32 nShapes;
-- 
1.7.0.1

