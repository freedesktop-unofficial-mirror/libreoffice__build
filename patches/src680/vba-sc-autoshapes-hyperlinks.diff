Only in /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/sdi/: docsh.sdi.orig
diff -rup /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/sdi/drawsh.sdi sc/sdi/drawsh.sdi
--- /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/sdi/drawsh.sdi	2006-06-22 10:50:40.000000000 +0100
+++ sc/sdi/drawsh.sdi	2006-06-21 11:46:46.000000000 +0100
@@ -225,6 +225,11 @@ interface TableDraw
 	SID_FONTWORK_CHARACTER_SPACING			[ ExecMethod = ExecDrawFunc ; StateMethod = GetDrawFuncState ; ]
 	SID_FONTWORK_KERN_CHARACTER_PAIRS		[ ExecMethod = ExecDrawFunc ; StateMethod = GetDrawFuncState ; ]
     SID_FONTWORK_CHARACTER_SPACING_DIALOG	[ ExecMethod = ExecDrawFunc ; StateMethod = GetDrawFuncState ; ]
+
+	
+	SID_EDITLNK_ATTR_DLG	[ ExecMethod = ExecDrawAttr; StateMethod = NoState; Export = FALSE; ]
+	SID_DELLNK	[ ExecMethod = ExecDrawAttr; StateMethod = GetDrawFuncState; Export = FALSE; ]
+	SID_OPENLNK	[ ExecMethod = ExecDrawAttr; StateMethod = GetDrawFuncState; Export = FALSE; ]
 }
 
 
diff -rup /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/sdi/scalc.sdi sc/sdi/scalc.sdi
--- /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/sdi/scalc.sdi	2006-06-22 10:50:44.000000000 +0100
+++ sc/sdi/scalc.sdi	2006-06-21 11:46:11.000000000 +0100
@@ -6822,6 +6822,81 @@ SfxVoidItem TableSelectAll FID_TAB_SELEC
 ]
 
 //--------------------------------------------------------------------------
+SfxVoidItem EditHyper SID_EDITLNK_ATTR_DLG
+()
+[
+	/* flags: */
+	AutoUpdate = FALSE,
+	Cachable = Cachable,
+	FastCall = TRUE,
+	HasCoreId = FALSE,
+	HasDialog = TRUE,
+	ReadOnlyDoc = TRUE,
+	Toggle = FALSE,
+	Container = FALSE,
+	RecordAbsolute = FALSE,
+	RecordPerSet;
+	Synchron;
+
+	/* config: */
+	AccelConfig = TRUE,
+	MenuConfig = FALSE,
+	StatusBarConfig = FALSE,
+	ToolBoxConfig = FALSE,
+	GroupId = GID_DRAWING;
+]
+
+//--------------------------------------------------------------------------
+SfxVoidItem DelHlink SID_DELLNK
+()
+[
+	/* flags: */
+	AutoUpdate = TRUE,
+	Cachable = Cachable,
+	FastCall = TRUE,
+	HasCoreId = FALSE,
+	HasDialog = FALSE,
+	ReadOnlyDoc = TRUE,
+	Toggle = FALSE,
+	Container = FALSE,
+	RecordAbsolute = FALSE,
+	RecordPerSet;
+	Synchron;
+	
+	/* config: */
+	AccelConfig = TRUE,
+	MenuConfig = FALSE,
+	StatusBarConfig = FALSE,
+	ToolBoxConfig = FALSE,
+	GroupId = GID_DRAWING;
+]
+
+//--------------------------------------------------------------------------
+SfxVoidItem OpenHlink SID_OPENLNK
+()
+[
+	/* flags: */
+	AutoUpdate = TRUE,
+	Cachable = Cachable,
+	FastCall = TRUE,
+	HasCoreId = FALSE,
+	HasDialog = FALSE,
+	ReadOnlyDoc = TRUE,
+	Toggle = FALSE,
+	Container = FALSE,
+	RecordAbsolute = FALSE,
+	RecordPerSet;
+	Synchron;
+	
+	/* config: */
+	AccelConfig = TRUE,
+	MenuConfig = FALSE,
+	StatusBarConfig = FALSE,
+	ToolBoxConfig = FALSE,
+	GroupId = GID_DRAWING;
+]
+
+//--------------------------------------------------------------------------
 SfxVoidItem TextAttributes SID_DRAWTEXT_ATTR_DLG
 ()
 [
diff -rup /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/drawfunc/drawsh2.cxx sc/source/ui/drawfunc/drawsh2.cxx
--- /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/drawfunc/drawsh2.cxx	2006-06-22 10:50:40.000000000 +0100
+++ sc/source/ui/drawfunc/drawsh2.cxx	2006-06-21 12:42:03.000000000 +0100
@@ -68,6 +68,8 @@
 #include "viewdata.hxx"
 #include "sc.hrc"
 #include "tabvwsh.hxx"
+#include "drwlayer.hxx"
+#include "userdat.hxx"
 
 
 #ifndef _SVDOOLE2_HXX
@@ -212,6 +214,13 @@ void ScDrawShell::GetDrawFuncState( SfxI
 	if ( nMarkCount == 1 )
 	{
         SdrObject* pObj = rMarkList.GetMark( 0 )->GetObj();
+	ScMacroInfo* pInfo = ScDrawLayer::GetMacroInfo( pObj );
+	if ( !pInfo || ( pInfo &&  pInfo->GetHlink().getLength() == 0 ) )
+	{
+		rSet.DisableItem( SID_DELLNK );
+		rSet.DisableItem( SID_OPENLNK );
+	}
+		
         SdrLayerID nLayerID = pObj->GetLayer();
         if ( nLayerID != SC_LAYER_INTERN )
             bCanRename = TRUE;                          // #i51351# anything except internal objects can be renamed
diff -rup /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/drawfunc/drawsh5.cxx sc/source/ui/drawfunc/drawsh5.cxx
--- /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/drawfunc/drawsh5.cxx	2006-06-22 10:50:40.000000000 +0100
+++ sc/source/ui/drawfunc/drawsh5.cxx	2006-06-20 18:17:46.000000000 +0100
@@ -158,6 +158,15 @@ void ScDrawShell::GetHLinkState( SfxItem
                 }
             }
         }
+        else
+        {
+             ScMacroInfo* pInfo = ScDrawLayer::GetMacroInfo( pObj );
+             if ( pInfo && pInfo->GetHlink().getLength() )
+             {
+                 aHLinkItem.SetURL( pInfo->GetHlink() );
+                 aHLinkItem.SetInsertMode(HLINK_FIELD);
+             }
+        }
     }
 
     rSet.Put(aHLinkItem);
@@ -183,13 +192,14 @@ void ScDrawShell::ExecuteHLink( SfxReque
                     SvxLinkInsertMode eMode = pHyper->GetInsertMode();
 
                     BOOL bDone = FALSE;
-                    if ( eMode == HLINK_DEFAULT || eMode == HLINK_BUTTON )
+                    if ( eMode == HLINK_FIELD || eMode == HLINK_BUTTON )
                     {
                         ScDrawView* pView = pViewData->GetScDrawView();
                         const SdrMarkList& rMarkList = pView->GetMarkedObjectList();
                         if ( rMarkList.GetMarkCount() == 1 )
                         {
-                            SdrUnoObj* pUnoCtrl = PTR_CAST(SdrUnoObj, rMarkList.GetMark(0)->GetObj());
+                            SdrObject* pObj = rMarkList.GetMark(0)->GetObj();
+                            SdrUnoObj* pUnoCtrl = PTR_CAST(SdrUnoObj, pObj );
                             if (pUnoCtrl && FmFormInventor == pUnoCtrl->GetObjInventor())
                             {
                                 uno::Reference<awt::XControlModel> xControlModel =
@@ -239,6 +249,11 @@ void ScDrawShell::ExecuteHLink( SfxReque
                                     bDone = TRUE;
                                 }
                             }
+                            else
+                            {
+                                SetHlinkForObject( pObj, rURL );
+                                bDone = TRUE;
+                            }
                         }
                     }
 
diff -rup /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/drawfunc/drawsh.cxx sc/source/ui/drawfunc/drawsh.cxx
--- /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/drawfunc/drawsh.cxx	2006-06-22 10:50:40.000000000 +0100
+++ sc/source/ui/drawfunc/drawsh.cxx	2006-06-21 12:36:06.000000000 +0100
@@ -305,7 +305,9 @@
 #include "docpool.hxx"
 #include "drawview.hxx"
 #include "scresid.hxx"
-
+#include "userdat.hxx"
+#include <sfx2/objsh.hxx>
+#include <com/sun/star/util/XModifiable.hpp>
 #ifndef _SVDOBJ_HXX //autogen
 #include <svx/svdobj.hxx>
 #endif
@@ -316,6 +318,7 @@
 #define ScDrawShell
 #include "scslots.hxx"
 
+#include <sfx2/dispatch.hxx>
 //------------------------------------------------------------------
 
 TYPEINIT1( ScDrawShell, SfxShell );
@@ -352,6 +355,8 @@ void ScDrawShell::ExecDrawAttr( SfxReque
 //	SfxViewFrame*		pViewFrame	= SfxViewShell::Current()->GetViewFrame(); //!!! koennte knallen
 	ScDrawView* 		pView		= pViewData->GetScDrawView();
 	SdrModel*			pDoc		= pViewData->GetDocument()->GetDrawLayer();
+	const SdrMarkList& rMarkList = pView->GetMarkedObjectList();
+	ULONG nMarkCount = rMarkList.GetMarkCount();
 
 	switch ( nSlot )
 	{
@@ -438,7 +443,6 @@ void ScDrawShell::ExecDrawAttr( SfxReque
 
 					if( !pArgs )
 					{
-						const SdrMarkList& rMarkList = pView->GetMarkedObjectList();
 						if( rMarkList.GetMark(0) != 0 )
 						{
 							SdrObject* pObj = rMarkList.GetMark(0)->GetObj();
@@ -501,6 +505,39 @@ void ScDrawShell::ExecDrawAttr( SfxReque
 			}
 			break;
 
+		case SID_EDITLNK_ATTR_DLG:
+			{
+				if ( nMarkCount == 1 )
+					pViewData->GetDispatcher().Execute( SID_HYPERLINK_DIALOG );
+				break;
+			}
+		case SID_DELLNK:
+			{
+				if ( nMarkCount == 1 )
+				{
+					SdrObject* pObj = rMarkList.GetMark( 0 )->GetObj();
+					SetHlinkForObject( pObj, rtl::OUString() );
+				}
+				break;
+			}
+		case SID_OPENLNK:
+			{
+				if ( nMarkCount == 1 )
+				{
+					SdrObject* pObj = rMarkList.GetMark( 0 )->GetObj();
+					ScMacroInfo* pInfo = ScDrawLayer::GetMacroInfo( pObj );
+					if ( pInfo && pInfo->GetHlink().getLength() )
+					{
+						rtl::OUString sURL = pInfo->GetHlink();
+						rtl::OUString  sTarget = sURL;
+						ScGlobal::OpenURL( sURL, sTarget );
+					}
+	
+				}
+				
+			}
+
+
 		default:
 			break;
 	}
@@ -625,3 +662,18 @@ void ScDrawShell::ExecuteTextAttrDlg( Sf
 }
 
 
+void ScDrawShell::SetHlinkForObject( SdrObject* pObj, const rtl::OUString& rHlnk )
+{
+	if ( !pObj )
+		return;
+	ScMacroInfo* pInfo = ScDrawLayer::GetMacroInfo( pObj, TRUE );
+	pInfo->SetHlink( rHlnk );
+	SfxObjectShell*  pShell =  GetObjectShell();
+						
+	if ( pShell )
+	{
+		com::sun::star::uno::Reference< com::sun::star::util::XModifiable > xModif( pShell->GetModel(), com::sun::star::uno::UNO_QUERY );
+		if ( xModif.is() )
+			xModif->setModified( sal_True );
+	}
+}
diff -rup /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/drawfunc/fudraw.cxx sc/source/ui/drawfunc/fudraw.cxx
--- /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/drawfunc/fudraw.cxx	2006-06-22 10:50:44.000000000 +0100
+++ sc/source/ui/drawfunc/fudraw.cxx	2006-06-19 13:00:31.000000000 +0100
@@ -894,7 +894,8 @@ void FuDraw::ForcePointer(const MouseEve
 			SdrObjMacroHitRec aHitRec;	//! muss da noch irgendwas gesetzt werden ????
 			pViewShell->SetActivePointer( pObj->GetMacroPointer(aHitRec) );
 		}
-		else  if ( !bAlt && pInfo && pInfo->GetMacro().getLength() )
+		else  if ( !bAlt && pInfo && ( pInfo->GetMacro().getLength() |
+		            pInfo->GetHlink().getLength()  ) )
 		{
 			pWindow->SetPointer( Pointer( POINTER_REFHAND ) );
 		}	
diff -rup /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/drawfunc/fusel.cxx sc/source/ui/drawfunc/fusel.cxx
--- /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/drawfunc/fusel.cxx	2006-06-22 10:50:44.000000000 +0100
+++ sc/source/ui/drawfunc/fusel.cxx	2006-06-19 13:00:31.000000000 +0100
@@ -190,13 +190,22 @@ BOOL __EXPORT FuSelection::MouseButtonDo
 			}
 			else
 			{
+				String sURL;
+				String sTarget;
 
 				if ( !bAlt && pView->PickObj(aMDPos, pObj, pPV, SDRSEARCH_ALSOONMASTER))
 				{
 					ScMacroInfo* pInfo = ScDrawLayer::GetMacroInfo( pObj );
 					if ( pInfo )
 					{
-						if ( pInfo->GetMacro().getLength() )
+						// For interoperability favour links over 
+						// macros if both are defined
+						if ( pInfo->GetHlink().getLength() )
+						{
+							sURL = pInfo->GetHlink();
+							sTarget = sURL;
+						}
+						else if ( pInfo->GetMacro().getLength() )
 						{
 							SfxObjectShell* pObjSh = SfxObjectShell::Current();
 							if ( pObjSh && SfxApplication::IsXScriptURL( pInfo->GetMacro() ) )
@@ -230,16 +239,21 @@ BOOL __EXPORT FuSelection::MouseButtonDo
 								ScDrawLayer::GetHitIMapObject( aVEvt.pObj, aMDPos, *pWindow );
 						if ( pIMapObj && pIMapObj->GetURL().Len() )
 						{
-							ScGlobal::OpenURL( pIMapObj->GetURL(), pIMapObj->GetTarget() );
+							sURL = pIMapObj->GetURL();
+							sTarget =  pIMapObj->GetTarget();
 
-							pViewShell->FakeButtonUp( pViewShell->GetViewData()->GetActivePart() );
-							return TRUE;		// kein CaptureMouse etc.
 						}
 					}
 					if ( aVEvt.eEvent == SDREVENT_EXECUTEURL && aVEvt.pURLField )	// URL
 					{
-						ScGlobal::OpenURL( aVEvt.pURLField->GetURL(),
-											aVEvt.pURLField->GetTargetFrame() );
+						sURL = aVEvt.pURLField->GetURL();
+						sTarget = aVEvt.pURLField->GetTargetFrame();
+
+					}
+
+					if ( sURL.Len() )
+					{
+						ScGlobal::OpenURL( sURL, sTarget );
 
 						pViewShell->FakeButtonUp( pViewShell->GetViewData()->GetActivePart() );
 						return TRUE;		// kein CaptureMouse etc.
diff -rup /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/drawfunc/objdraw.src sc/source/ui/drawfunc/objdraw.src
--- /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/drawfunc/objdraw.src	2006-06-22 10:50:40.000000000 +0100
+++ sc/source/ui/drawfunc/objdraw.src	2006-06-21 18:31:11.000000000 +0100
@@ -211,6 +211,35 @@
 		Text [ x-comment ] = " ";\
 	};
 
+#define MN_EDITLNK \
+    MenuItem\
+    {\
+        Identifier = SID_EDITLNK_ATTR_DLG ; \
+        HelpID = SID_EDITLNK_ATTR_DLG ; \
+        Text [ de ] = "Edit H~yperlink..." ; \
+        Text [ en-US ] = "Edit H~yperlink..." ; \
+		Text [ x-comment ] = " ";\
+	};
+
+#define MN_DELLNK \
+    MenuItem\
+    {\
+        Identifier = SID_DELLNK ; \
+        HelpID = SID_DELLNK ; \
+        Text [ de ] = "~Remove Hyperlink" ; \
+        Text [ en-US ] = "~Remove Hyperlink" ; \
+		Text [ x-comment ] = " ";\
+	};
+
+#define MN_OPENLNK \
+    MenuItem\
+    {\
+        Identifier = SID_OPENLNK ; \
+        HelpID = SID_OPENLNK ; \
+        Text [ de ] = "~Open Hyperlink" ; \
+        Text [ en-US ] = "~Open Hyperlink" ; \
+		Text [ x-comment ] = " ";\
+	};
 #define MN_ORIGINALSIZE \
     MenuItem\
     {\
@@ -1283,6 +1312,12 @@ Menu RID_POPUP_DRAW
 		MenuItem { Separator = TRUE ; };
 		 //------------------------------
 		ITEM_GROUP_MENU
+		 //------------------------------
+		MenuItem { Separator = TRUE ; };
+		 //------------------------------
+		MN_EDITLNK // Edit H~yperlink...
+		MN_DELLNK  // ~Remove Hyperlink
+		MN_OPENLNK  // ~Open Hyperlink
 	};
 };
 
@@ -1335,6 +1370,12 @@ Menu RID_POPUP_GRAPHIC
 		MenuItem { Separator = TRUE ; };
 		 //------------------------------
 		ITEM_GROUP_MENU
+		 //------------------------------
+		MenuItem { Separator = TRUE ; };
+		 //------------------------------
+		MN_EDITLNK // Edit H~yperlink...
+		MN_DELLNK  // ~Remove Hyperlink
+		MN_OPENLNK  // ~Open Hyperlink
 	   };
 };
 
diff -rup /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/unoobj/shapeuno.cxx sc/source/ui/unoobj/shapeuno.cxx
--- /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/unoobj/shapeuno.cxx	2006-06-22 10:50:44.000000000 +0100
+++ sc/source/ui/unoobj/shapeuno.cxx	2006-06-19 13:00:31.000000000 +0100
@@ -1342,16 +1342,20 @@ SdrObject* ScShapeObj::GetSdrObject() co
 
 typedef ::cppu::WeakImplHelper1< container::XNameReplace > ShapeUnoEventAcess_BASE;
 const rtl::OUString sOnClick = rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("OnClick") );
+const rtl::OUString sOnAction = rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("OnAction") );
+const rtl::OUString sURL = rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("URL") );
+const rtl::OUString sAction = rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("Action") );
 const rtl::OUString sStrScript = rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("Script") );
 const rtl::OUString sEventType = rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("EventType") );
 
+const rtl::OUString sEventNames[] = { sOnClick, sOnAction };
 class ShapeUnoEventAccessImpl : public ShapeUnoEventAcess_BASE
 {
 
 	ScShapeObj* mpShape;	
 	bool isValidName( const rtl::OUString& aName )
 	{
-		return ( aName == sOnClick );
+		return ( aName == sOnClick | aName == sOnAction );
 	}
 	
 	ScMacroInfo* getInfo( BOOL bCreate = false )
@@ -1390,7 +1394,7 @@ public:
 				isEventType = true;
 				continue;
 			}
-			if ( isEventType &&  pProperties->Name == sStrScript )
+			if ( isEventType && ( pProperties->Name == sStrScript | pProperties->Name == sURL) )
 			{
 				rtl::OUString sValue;
 				if ( ! ( pProperties->Value >>= sValue ) )
@@ -1400,7 +1404,10 @@ public:
 				
 				if ( !pInfo )
 					break;	
-				pInfo->SetMacro( sValue );	
+				if ( pProperties->Name == sStrScript )
+					pInfo->SetMacro( sValue );	
+				else
+					pInfo->SetHlink( sValue );
 			}	
 
 		}
@@ -1415,21 +1422,34 @@ public:
 		ScMacroInfo* pInfo = getInfo();
 		uno::Sequence< beans::PropertyValue > aProperties;
 		if ( pInfo )
-		{
-			if ( pInfo->GetMacro().getLength() )
+			if ( aName == sOnClick )
 			{
-				aProperties.realloc(2);
-				aProperties[ 0 ].Name = sEventType;
-				aProperties[ 0 ].Value <<= sStrScript;
-				aProperties[ 1 ].Name = sStrScript;
-				aProperties[ 1 ].Value <<= pInfo->GetMacro();	
+				if ( pInfo->GetMacro().getLength() )
+				{
+					aProperties.realloc(2);
+					aProperties[ 0 ].Name = sEventType;
+					aProperties[ 0 ].Value <<= sStrScript;
+					aProperties[ 1 ].Name = sStrScript;
+					aProperties[ 1 ].Value <<= pInfo->GetMacro();	
+				}
 			}
+			else
+			{
+				if ( pInfo->GetHlink().getLength() )	
+				{
+					aProperties.realloc(2);
+					aProperties[ 0 ].Name = sEventType;
+					aProperties[ 0 ].Value <<= sAction;
+					aProperties[ 1 ].Name = sURL;
+					aProperties[ 1 ].Value <<= pInfo->GetHlink();	
+				}
+				
 		}
 		return uno::makeAny( aProperties );
 	}
 	virtual uno::Sequence< rtl::OUString > SAL_CALL getElementNames(  ) throw(uno::RuntimeException)
 	{
-		uno::Sequence< rtl::OUString > aStr( &sOnClick, 1 );
+		uno::Sequence< rtl::OUString > aStr( sEventNames, 2 );
 		return aStr;
 	}
 
diff -rup /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/view/gridwin5.cxx sc/source/ui/view/gridwin5.cxx
--- /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/view/gridwin5.cxx	2006-06-22 10:50:40.000000000 +0100
+++ sc/source/ui/view/gridwin5.cxx	2006-06-19 13:00:31.000000000 +0100
@@ -84,6 +84,7 @@
 #include "chgviset.hxx"
 #include "dbfunc.hxx"
 #include "tabvwsh.hxx"
+#include "userdat.hxx"
 
 
 // -----------------------------------------------------------------------
@@ -340,6 +341,21 @@ void __EXPORT ScGridWindow::RequestHelp(
 						aPixRect = LogicToPixel(aVEvt.pObj->GetLogicRect());
 					}
 				}
+				SdrObject* pObj = NULL;
+				SdrPageView* pPV = NULL;
+				Point aMDPos = PixelToLogic( aPosPixel );
+				if ( pDrView->PickObj(aMDPos, pObj, pPV, SDRSEARCH_ALSOONMASTER) )
+				{
+					ScMacroInfo* pInfo = ScDrawLayer::GetMacroInfo( pObj );	
+					if ( pInfo && pInfo->GetHlink().getLength() )
+					{
+						aPixRect = LogicToPixel(aVEvt.pObj->GetLogicRect());
+						aHelpText = pInfo->GetHlink();
+						
+					}	
+						
+
+				}
 				// URL in Textobjekt
 				if ( !aHelpText.Len() && aVEvt.eEvent == SDREVENT_EXECUTEURL )
 				{
diff -rup /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/inc/drawsh.hxx sc/source/ui/inc/drawsh.hxx
--- /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/ui/inc/drawsh.hxx	2006-06-22 10:50:40.000000000 +0100
+++ sc/source/ui/inc/drawsh.hxx	2006-06-20 17:09:29.000000000 +0100
@@ -61,6 +61,7 @@ class ScDrawShell : public SfxShell
 	ScViewData*	pViewData;
 
     DECL_LINK( NameObjectHdl, AbstractSvxNameDialog* );
+	void SetHlinkForObject( SdrObject* pObj, const rtl::OUString& rHlnk );
 
 protected:
 	ScViewData*	GetViewData()	{ return pViewData; }
diff -rup /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/filter/excel/xicontent.cxx sc/source/filter/excel/xicontent.cxx
--- /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/filter/excel/xicontent.cxx	2006-06-22 10:50:40.000000000 +0100
+++ sc/source/filter/excel/xicontent.cxx	2006-06-19 13:00:31.000000000 +0100
@@ -281,16 +281,25 @@ void lclInsertUrl( const XclImpRoot& rRo
 void XclImpHyperlink::ReadHlink( XclImpStream& rStrm )
 {
     const XclImpRoot& rRoot = rStrm.GetRoot();
+    XclRange aXclRange( ScAddress::UNINITIALIZED );
+    rStrm >> aXclRange; 
+    String aString =  ReadHlinkRecord( rStrm );
+
+    if ( aString.Len() )
+        rRoot.GetXFRangeBuffer().SetHyperlink( aXclRange, aString );
+}
+
+String XclImpHyperlink::ReadHlinkRecord( XclImpStream& rStrm )
+{
     DBG_ASSERT_BIFF( rRoot.GetBiff() == EXC_BIFF8 );
 
+    const XclImpRoot& rRoot = rStrm.GetRoot();
     ScDocument& rDoc = rRoot.GetDoc();
     SfxObjectShell* pDocShell = rRoot.GetDocShell();
 
-    XclRange aXclRange( ScAddress::UNINITIALIZED );
     sal_uInt32 nFlags;
     XclGuid aGuid;
-
-    rStrm >> aXclRange >> aGuid;
+    rStrm >> aGuid;
     rStrm.Ignore( 4 );
     rStrm >> nFlags;
 
@@ -384,8 +393,8 @@ void XclImpHyperlink::ReadHlink( XclImpS
             xLongName->Append( '#' );
             xLongName->Append( *xTextMark );
         }
-        rRoot.GetXFRangeBuffer().SetHyperlink( aXclRange, *xLongName );
     }
+    return *xLongName;
 }
 
 void XclImpHyperlink::InsertUrl( const XclImpRoot& rRoot, const XclRange& rXclRange, const String& rUrl )
diff -rup /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/filter/excel/xiescher.cxx sc/source/filter/excel/xiescher.cxx
--- /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/filter/excel/xiescher.cxx	2006-06-22 10:50:44.000000000 +0100
+++ sc/source/filter/excel/xiescher.cxx	2006-06-21 18:29:58.000000000 +0100
@@ -1387,30 +1387,34 @@ SdrObject* XclImpDffManager::ProcessObj(
     /*  Connect textbox data (string, alignment, text orientation) to object.
         #98132# don't ask for a text-ID, Escher export doesn't set one. */
     XclImpDrawingObj* pDrawingObj = dynamic_cast< XclImpDrawingObj* >( xDrawObj.get() );
+
     if( pDrawingObj )
         pDrawingObj->SetTxoData( mrObjManager.FindTxoData( rObjData.rSpHd ) );
 
+    // Generic shape bits hyper & macro
+    if ( xSdrObj.get() )
+    {
+        String sHlinkURL = ReadHlinkProperty( rEscherStrm );
+        if ( sHlinkURL.Len() )
+        {
+            ScMacroInfo* pInfo = ScDrawLayer::GetMacroInfo( xSdrObj.get(), TRUE );
+            if ( pInfo )
+                pInfo->SetHlink( sHlinkURL );
+        }
+        if ( xDrawObj->GetMacroName().Len() )
+        {
+            ScMacroInfo* pInfo = ScDrawLayer::GetMacroInfo( xSdrObj.get(), TRUE );
+            if ( pInfo )
+                pInfo->SetMacro( XclTbxControlHelper::GetScMacroName( xDrawObj->GetMacroName() ) );
+        }
+    }
     // #118052# import internal name of a control
     if( XclImpOleObj* pOleObj = dynamic_cast< XclImpOleObj* >( xDrawObj.get() ) )
     {
         String aName( ReadStringProperty( rEscherStrm, DFF_Prop_wzName ) );
         if( aName.Len() )
             pOleObj->SetControlName( aName );
-    }
-    else
-    {
-        // its a drawing object or form control
-        if ( pDrawingObj && xSdrObj.get() )
-        {
-            if ( pDrawingObj->GetMacroName().Len() ) // has associated macro
-            {
-                ScMacroInfo* pInfo = ScDrawLayer::GetMacroInfo( xSdrObj.get(), TRUE );
-		DBG_ASSERT( pInfo, "shape macro info could not be created!" );
-
-                if ( pInfo )
-                    pInfo->SetMacro( XclTbxControlHelper::GetScMacroName(pDrawingObj->GetMacroName() ) );
-            }
-        }
+	
     }
 
     // try to create a custom SdrObject that overwrites the passed object
@@ -1479,6 +1481,32 @@ FASTBOOL XclImpDffManager::GetColorFromP
 }
 
 // private --------------------------------------------------------------------
+String XclImpDffManager::ReadHlinkProperty( SvStream& rEscherStrm ) const
+{
+    String aString;
+    sal_uInt32 nPropId = DFF_Prop_pihlShape;
+    sal_uInt32 nBufferSize = GetPropertyValue( nPropId );
+    if( (nBufferSize > 0) && SeekToContent( nPropId, rEscherStrm ) )
+    {
+        const static sal_uInt16 nDummyId = 9999;
+	sal_uInt16 nRecSize = nBufferSize;
+        SvMemoryStream memStream;
+        
+        memStream << nDummyId;
+        memStream << nRecSize; 	
+        for ( sal_Int32 nByteCount = 0; nByteCount < nRecSize; ++nByteCount )
+        {
+            sal_uInt8 aByte = 0;
+            rEscherStrm >> aByte;
+            memStream << aByte;
+        }
+        XclImpStream aLinkStream( memStream, GetRoot() );
+        aLinkStream.StartNextRecord();
+        XclImpHyperlink aHlink;
+        aString = aHlink.ReadHlinkRecord( aLinkStream );
+    }
+    return aString;
+}
 
 String XclImpDffManager::ReadStringProperty( SvStream& rEscherStrm, sal_uInt32 nPropId ) const
 {
--- /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/inc/sc.hrc	2006-06-22 10:50:45.000000000 +0100
+++ sc/inc/sc.hrc	2006-06-21 11:51:13.000000000 +0100
@@ -574,6 +574,10 @@
 // additional IDs for list/range validity
 #define FID_VALID_LISTTYPE              (SC_VIEW_START + 93)
 
+#define SID_EDITLNK_ATTR_DLG	(SC_VIEW_START + 94)
+#define SID_DELLNK	(SC_VIEW_START + 95)
+#define SID_OPENLNK	(SC_VIEW_START + 96)
+
 // Nachrichten -------------------------------------------------------------
 
 #define FID_INPUTLINE_STATUS	(SC_MESSAGE_START)
--- /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/inc/userdat.hxx	2006-06-22 10:50:44.000000000 +0100
+++ sc/inc/userdat.hxx	2006-06-19 13:00:31.000000000 +0100
@@ -108,6 +108,7 @@ public:
 class ScMacroInfo : public SdrObjUserData
 {
 	rtl::OUString sMacro;
+	rtl::OUString sHlink;
 public:
 					ScMacroInfo();
 	virtual			~ScMacroInfo();
@@ -115,7 +116,9 @@ public:
 	virtual	SdrObjUserData* Clone( SdrObject* pObj ) const;
 
 	void 	SetMacro( const rtl::OUString& rMacro )	{ sMacro = rMacro; }
+	void 	SetHlink( const rtl::OUString& rHlink )	{ sHlink = rHlink; }
 	const rtl::OUString&	GetMacro() const				{ return sMacro; }
+	const rtl::OUString&	GetHlink() const				{ return sHlink; }
 };
 
 #endif
--- /data4/sles/ooo-buildNow/ooo-build/build/ooc680-m5/sc/source/filter/inc/xicontent.hxx	2006-06-22 10:50:40.000000000 +0100
+++ sc/source/filter/inc/xicontent.hxx	2006-06-19 13:00:31.000000000 +0100
@@ -98,6 +98,7 @@ public:
     /** Reads a HLINK record and inserts it into the document.
         @descr  Import stream must be located at start of a HLINK record. */
     static void         ReadHlink( XclImpStream& rStrm );
+    static String       ReadHlinkRecord( XclImpStream& rStrm );
 
     /** Inserts the URL into a range of cells. Does not modify value or formula cells. */
     static void         InsertUrl( const XclImpRoot& rRoot, const XclRange& rXclRange, const String& rUrl );
