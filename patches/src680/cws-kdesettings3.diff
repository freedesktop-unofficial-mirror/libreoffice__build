Index: shell/prj/build.lst
===================================================================
RCS file: /cvs/gsl/shell/prj/build.lst,v
retrieving revision 1.27
retrieving revision 1.27.24.1
diff -u -p -u -p -r1.27 -r1.27.24.1
--- shell/prj/build.lst	2 Jun 2006 12:23:05 -0000	1.27
+++ shell/prj/build.lst	21 Jul 2006 12:53:47 -0000	1.27.24.1
@@ -22,5 +22,6 @@ sh    shell\source\backends\localebe    
 sh    shell\source\backends\wininetbe              nmake   -   w   sh_backends_wininetbe NULL
 sh    shell\source\backends\gconfbe                nmake   -   u   sh_backends_gconfbe NULL
 sh    shell\source\backends\kdebe                  nmake   -   u   sh_backends_kdebe NULL
+sh    shell\source\backends\desktopbe              nmake   -   u   sh_backends_desktopbe NULL
 sh    shell\source\win32\shlxthandler\ooofilt      nmake   -   w   sh_win32_shlxthandler_ooofilt sh_all_zipfile.w sh_all_ooofilereader.w sh_win32_shlxthandler_util.w sh_all NULL
 sh    shell\source\win32\shlxthandler\ooofilt\proxy nmake   -   w   sh_win32_ooofiltproxy NULL 
Index: shell/prj/d.lst
===================================================================
RCS file: /cvs/gsl/shell/prj/d.lst,v
retrieving revision 1.15
retrieving revision 1.15.24.1
diff -u -p -u -p -r1.15 -r1.15.24.1
--- shell/prj/d.lst	2 Jun 2006 12:23:23 -0000	1.15
+++ shell/prj/d.lst	21 Jul 2006 12:53:48 -0000	1.15.24.1
@@ -25,5 +25,4 @@ mkdir: %_DEST%\inc%_EXT%\shell
 ..\source\proxysettings\proxyset.xml %_DEST%\xml%_EXT%\proxyset.xml
 ..\source\cmdmail\cmdmail.xml %_DEST%\xml%_EXT%\cmdmail.xml
 
-..\%__SRC%\misc\gconfbe1-ucd.txt  %_DEST%\bin%_EXT%\gconfbe1-ucd.txt
-..\%__SRC%\misc\kdebe1-ucd.txt  %_DEST%\bin%_EXT%\kdebe1-ucd.txt
+..\%__SRC%\misc\*-ucd.txt  %_DEST%\bin%_EXT%\*-ucd.txt
Index: shell/source/backends/desktopbe/desktopbe.xml
===================================================================
RCS file: shell/source/backends/desktopbe/desktopbe.xml
diff -N shell/source/backends/desktopbe/desktopbe.xml
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ shell/source/backends/desktopbe/desktopbe.xml	21 Jul 2006 12:53:48 -0000	1.1.2.1
@@ -0,0 +1,37 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!DOCTYPE module-description PUBLIC "-//StarOffice//DTD ComponentDescription 1.0//EN" "module-description.dtd">
+<module-description xmlns:xlink="http://www.w3.org/1999/xlink">
+    <module-name>desktopbe</module-name>
+    <component-description>
+        <author> Jan Holesovsky </author>
+        <name>com.sun.star.comp.configuration.backend.DesktopBackend</name>
+        <description> The shared gconf/KDE backend; will load GconfBackend or
+        KDEBackend depending on the desktop environment.</description>
+        <loader-name>com.sun.star.loader.SharedLibrary</loader-name>
+        <language>c++</language>
+        <status value="beta"/>        
+        <supported-service>com.sun.star.comp.configuration.backend.DesktopBackend</supported-service>		
+        <supported-service>com.sun.star.comp.configuration.backend.PlatformBackend</supported-service>		
+        <service-dependency>...</service-dependency>
+        <type>com.sun.star.configuration.backend.XBackendChangesListener</type>
+        <type>com.sun.star.configuration.backend.XBackendChangesNotifier</type>
+        <type>com.sun.star.configuration.backend.XLayerHandler</type>
+        <type>com.sun.star.configuration.backend.XSingleLayerStratum</type>
+        <type>com.sun.star.lang.XMultiComponentFactory</type>
+        <type>com.sun.star.lang.XServiceInfo</type>
+        <type>com.sun.star.lang.XSingleComponentFactory</type>
+        <type>com.sun.star.lang.XTypeProvider</type>
+        <type>com.sun.star.uno.TypeClass</type>
+        <type>com.sun.star.uno.XAggregation</type>
+        <type>com.sun.star.uno.XComponentContext</type>
+        <type>com.sun.star.uno.XCurrentContext</type>
+        <type>com.sun.star.uno.XWeak</type>
+        <type>com.sun.star.registry.XRegistryKey</type>
+    </component-description>
+    <project-build-dependency>cppuhelper</project-build-dependency>
+    <project-build-dependency>cppu</project-build-dependency>
+    <project-build-dependency>sal</project-build-dependency>
+    <runtime-module-dependency>cppuhelper3$(COM)</runtime-module-dependency>
+    <runtime-module-dependency>cppu3</runtime-module-dependency>
+    <runtime-module-dependency>sal3</runtime-module-dependency>
+</module-description>
Index: shell/source/backends/desktopbe/desktopbe1-ucd.txt
===================================================================
RCS file: shell/source/backends/desktopbe/desktopbe1-ucd.txt
diff -N shell/source/backends/desktopbe/desktopbe1-ucd.txt
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ shell/source/backends/desktopbe/desktopbe1-ucd.txt	21 Jul 2006 12:53:48 -0000	1.1.2.1
@@ -0,0 +1,9 @@
+[ComponentDescriptor]
+ImplementationName=com.sun.star.comp.configuration.backend.DesktopBackend
+ComponentName=desktopbe1.uno.so
+LoaderName=com.sun.star.loader.SharedLibrary
+[Data]
+SupportedComponents=org.openoffice.VCL;org.openoffice.Inet;org.openoffice.Office.Common;org.openoffice.Office.Paths;org.openoffice.UserProfile;org.openoffice.Office.Recovery;org.openoffice.Setup
+[SupportedServices]
+com.sun.star.configuration.backend.DesktopBackend
+com.sun.star.configuration.backend.PlatformBackend
Index: shell/source/backends/desktopbe/desktopbecdef.cxx
===================================================================
RCS file: shell/source/backends/desktopbe/desktopbecdef.cxx
diff -N shell/source/backends/desktopbe/desktopbecdef.cxx
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ shell/source/backends/desktopbe/desktopbecdef.cxx	21 Jul 2006 12:53:49 -0000	1.1.2.1
@@ -0,0 +1,213 @@
+/*************************************************************************
+ *
+ *  OpenOffice.org - a multi-platform office productivity suite
+ *
+ *  $RCSfile$
+ *
+ *  $Revision$
+ *
+ *  last change: $Author$ $Date$
+ *
+ *  The Contents of this file are made available subject to
+ *  the terms of GNU Lesser General Public License Version 2.1.
+ *
+ *
+ *    GNU Lesser General Public License Version 2.1
+ *    =============================================
+ *    Copyright 2005 by Sun Microsystems, Inc.
+ *    901 San Antonio Road, Palo Alto, CA 94303, USA
+ *
+ *    This library is free software; you can redistribute it and/or
+ *    modify it under the terms of the GNU Lesser General Public
+ *    License version 2.1, as published by the Free Software Foundation.
+ *
+ *    This library is distributed in the hope that it will be useful,
+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ *    Lesser General Public License for more details.
+ *
+ *    You should have received a copy of the GNU Lesser General Public
+ *    License along with this library; if not, write to the Free Software
+ *    Foundation, Inc., 59 Temple Place, Suite 330, Boston,
+ *    MA  02111-1307  USA
+ *
+ ************************************************************************/
+
+#ifndef _COM_SUN_STAR_CONFIGURATION_BACKEND_XSCHEMASUPPLIER_HPP_
+#include <com/sun/star/configuration/backend/XSingleLayerStratum.hpp>
+#endif
+
+#ifndef _COM_SUN_STAR_REGISTRY_XREGISTRYKEY_HPP_
+#include <com/sun/star/registry/XRegistryKey.hpp>
+#endif
+
+#ifndef _CPPUHELPER_IMPLEMENTATIONENTRY_HXX_
+#include <cppuhelper/implementationentry.hxx>
+#endif
+
+#ifndef _COM_SUN_STAR_UNO_XCOMPONENTCONTEXT_HPP_
+#include <com/sun/star/uno/XComponentContext.hpp>
+#endif
+
+#include "uno/current_context.hxx"
+
+namespace css = com::sun::star ;
+namespace uno = css::uno ;
+namespace lang = css::lang ;
+namespace backend = css::configuration::backend ;
+
+//==============================================================================
+
+static uno::Reference<uno::XInterface> SAL_CALL createDesktopBackend(const uno::Reference<uno::XComponentContext>& xContext)
+{
+    try {
+        uno::Reference< uno::XCurrentContext > xCurrentContext(uno::getCurrentContext());
+        
+        if (xCurrentContext.is())
+        {
+            uno::Any aValue = xCurrentContext->getValueByName(
+                rtl::OUString::createFromAscii( "system.desktop-environment" ) );
+        
+            rtl::OUString aDesktopEnvironment;
+            if ( aValue >>= aDesktopEnvironment )
+            {
+                rtl::OUString aDesktopService;
+                if ( aDesktopEnvironment.equalsIgnoreAsciiCaseAscii( "gnome" ) )
+                    aDesktopService = rtl::OUString::createFromAscii( "com.sun.star.configuration.backend.GconfBackend" );
+                else if ( aDesktopEnvironment.equalsIgnoreAsciiCaseAscii( "kde" ) )
+                    aDesktopService = rtl::OUString::createFromAscii( "com.sun.star.configuration.backend.KDEBackend" );
+                else
+                    return uno::Reference<uno::XInterface>(); 
+
+                uno::Reference< lang::XMultiComponentFactory > xServiceManager = xContext->getServiceManager();
+                if( xServiceManager.is() )
+                {
+                    return uno::Reference< backend::XSingleLayerStratum >::query(
+                            xServiceManager->createInstanceWithContext( aDesktopService, xContext) );
+                }
+            }
+        }
+    } catch (uno::RuntimeException e) {
+    }    
+
+    return uno::Reference<uno::XInterface>(); 
+}
+
+static rtl::OUString SAL_CALL getBackendName(void) {
+    return rtl::OUString( 
+        RTL_CONSTASCII_USTRINGPARAM("com.sun.star.comp.configuration.backend.DesktopBackend") );
+}
+
+static uno::Sequence<rtl::OUString> SAL_CALL getBackendServiceNames(void) 
+{
+    uno::Sequence<rtl::OUString> aServices(2) ;
+    aServices[0] = rtl::OUString( 
+        RTL_CONSTASCII_USTRINGPARAM("com.sun.star.configuration.backend.DesktopBackend")) ;
+    aServices[1] = rtl::OUString( 
+        RTL_CONSTASCII_USTRINGPARAM("com.sun.star.configuration.backend.PlatformBackend")) ;
+
+    return aServices ;
+}
+
+static uno::Sequence<rtl::OUString> SAL_CALL getSupportedComponents(void)
+{
+    const sal_Int32 nComponents = 7;
+
+    uno::Sequence<rtl::OUString> aSupportedComponentsList(nComponents) ;
+
+    aSupportedComponentsList[0] = rtl::OUString( 
+        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.VCL")) ;
+    aSupportedComponentsList[1] = rtl::OUString( 
+        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.Inet")) ;
+    aSupportedComponentsList[2] = rtl::OUString( 
+        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.Office.Common")) ;
+    aSupportedComponentsList[3] = rtl::OUString( 
+        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.Office.Paths")) ;
+
+    aSupportedComponentsList[4] = rtl::OUString( 
+        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.UserProfile")) ;
+    aSupportedComponentsList[5] = rtl::OUString( 
+        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.Office.Recovery")) ;
+    aSupportedComponentsList[6] = rtl::OUString( 
+        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.Setup")) ;
+
+    return aSupportedComponentsList ;
+}
+//==============================================================================
+
+static const cppu::ImplementationEntry kImplementations_entries[] = 
+{
+    {
+        createDesktopBackend,
+        getBackendName,
+        getBackendServiceNames,
+        cppu::createSingleComponentFactory,
+        NULL,
+        0
+    },
+    { NULL }
+} ;
+//------------------------------------------------------------------------------
+
+extern "C" void SAL_CALL component_getImplementationEnvironment(
+                                            const sal_Char **aEnvTypeName,
+                                            uno_Environment **aEnvironment)
+{
+    *aEnvTypeName = CPPU_CURRENT_LANGUAGE_BINDING_NAME ;
+}
+
+//------------------------------------------------------------------------------
+
+extern "C" sal_Bool SAL_CALL component_writeInfo(void *pServiceManager,
+                                                 void *pRegistryKey)
+{
+    using namespace ::com::sun::star::registry;
+    if (pRegistryKey)
+    {
+        try
+        {
+            uno::Reference< XRegistryKey > xImplKey = static_cast< XRegistryKey* >( pRegistryKey )->createKey(
+                rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("/") ) + getBackendName()
+            );
+            
+            // Register associated service names
+            uno::Reference< XRegistryKey > xServicesKey = xImplKey->createKey( 
+                rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("/UNO/SERVICES") )
+            );
+            
+            uno::Sequence<rtl::OUString> sServiceNames = getBackendServiceNames();
+            for (sal_Int32 i = 0 ; i < sServiceNames.getLength() ; ++ i)
+                xServicesKey->createKey(sServiceNames[i]);
+
+            // Register supported components            
+            uno::Reference<XRegistryKey> xComponentKey = xImplKey->createKey(
+                rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("/DATA/SupportedComponents") )
+            );
+        
+            xComponentKey->setAsciiListValue( getSupportedComponents() );
+
+            return sal_True;
+        }
+        
+        catch( InvalidRegistryException& )
+        {                       
+            OSL_ENSURE(sal_False, "InvalidRegistryException caught");           
+        }
+    }
+    
+    return sal_False;
+}
+
+//------------------------------------------------------------------------------
+
+extern "C" void *component_getFactory(const sal_Char *aImplementationName,
+                                      void *aServiceManager,
+                                      void *aRegistryKey)
+{
+    return cppu::component_getFactoryHelper(
+        aImplementationName,
+        aServiceManager,
+        aRegistryKey,
+        kImplementations_entries) ;
+}
+//------------------------------------------------------------------------------
Index: shell/source/backends/desktopbe/exports.map
===================================================================
RCS file: shell/source/backends/desktopbe/exports.map
diff -N shell/source/backends/desktopbe/exports.map
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ shell/source/backends/desktopbe/exports.map	21 Jul 2006 12:53:49 -0000	1.1.2.1
@@ -0,0 +1,11 @@
+UDK_3_0_0 {
+	global:
+		GetVersionInfo;
+		component_getDescriptionFunc;
+		component_getImplementationEnvironment;
+		component_getFactory;
+		component_writeInfo;
+
+	local:
+		*;
+};
Index: shell/source/backends/desktopbe/makefile.mk
===================================================================
RCS file: shell/source/backends/desktopbe/makefile.mk
diff -N shell/source/backends/desktopbe/makefile.mk
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ shell/source/backends/desktopbe/makefile.mk	21 Jul 2006 12:53:49 -0000	1.1.2.1
@@ -0,0 +1,79 @@
+#*************************************************************************
+#
+#   OpenOffice.org - a multi-platform office productivity suite
+#
+#   $RCSfile$
+#
+#   $Revision$
+#
+#   last change: $Author$ $Date$
+#
+#   The Contents of this file are made available subject to
+#   the terms of GNU Lesser General Public License Version 2.1.
+#
+#
+#     GNU Lesser General Public License Version 2.1
+#     =============================================
+#     Copyright 2005 by Sun Microsystems, Inc.
+#     901 San Antonio Road, Palo Alto, CA 94303, USA
+#
+#     This library is free software; you can redistribute it and/or
+#     modify it under the terms of the GNU Lesser General Public
+#     License version 2.1, as published by the Free Software Foundation.
+#
+#     This library is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+#     Lesser General Public License for more details.
+#
+#     You should have received a copy of the GNU Lesser General Public
+#     License along with this library; if not, write to the Free Software
+#     Foundation, Inc., 59 Temple Place, Suite 330, Boston,
+#     MA  02111-1307  USA
+#
+#*************************************************************************
+PRJ=..$/..$/..
+
+PRJNAME=shell
+TARGET=desktopbe
+
+LIBTARGET=NO
+ENABLE_EXCEPTIONS=TRUE
+
+COMP1TYPELIST=$(TARGET)
+COMPRDB=$(SOLARBINDIR)$/types.rdb
+UNOUCROUT=$(OUT)$/inc$/$(TARGET)
+INCPRE=$(UNOUCROUT)
+
+# --- Settings ---
+
+.INCLUDE : settings.mk
+
+UNIXTEXT=$(MISC)/$(TARGET)1-ucd.txt
+
+# no "lib" prefix
+DLLPRE =
+
+# --- Files ---
+
+SLOFILES=\
+	$(SLO)$/desktopbecdef.obj
+
+SHL1NOCHECK=TRUE
+SHL1TARGET=$(TARGET)1.uno   
+SHL1OBJS=$(SLOFILES)
+SHL1DEF=$(MISC)$/$(SHL1TARGET).def
+
+SHL1IMPLIB=i$(SHL1TARGET)
+SHL1STDLIBS=    \
+        $(CPPUHELPERLIB) \
+        $(CPPULIB) \
+        $(SALLIB)
+        
+SHL1VERSIONMAP=exports.map
+SHL1DEF=$(MISC)$/$(SHL1TARGET).def
+DEF1NAME=$(SHL1TARGET)
+
+# --- Targets ---
+
+.INCLUDE : target.mk
Index: shell/source/backends/gconfbe/gconfbackend.cxx
===================================================================
RCS file: /cvs/gsl/shell/source/backends/gconfbe/gconfbackend.cxx,v
retrieving revision 1.9
retrieving revision 1.9.2.1
diff -u -p -u -p -r1.9 -r1.9.2.1
--- shell/source/backends/gconfbe/gconfbackend.cxx	13 Jul 2006 12:30:25 -0000	1.9
+++ shell/source/backends/gconfbe/gconfbackend.cxx	21 Jul 2006 12:53:49 -0000	1.9.2.1
@@ -947,46 +947,11 @@ rtl::OUString SAL_CALL GconfBackend::get
 
 uno::Sequence<rtl::OUString> SAL_CALL GconfBackend::getBackendServiceNames(void) 
 {
-    uno::Sequence<rtl::OUString> aServices(2) ;
+    uno::Sequence<rtl::OUString> aServices(1) ;
     aServices[0] = rtl::OUString( 
         RTL_CONSTASCII_USTRINGPARAM("com.sun.star.configuration.backend.GconfBackend")) ;
-    aServices[1] = rtl::OUString( 
-        RTL_CONSTASCII_USTRINGPARAM("com.sun.star.configuration.backend.PlatformBackend")) ;
-            
-    return aServices ;
-}
-
-//------------------------------------------------------------------------------
-
-uno::Sequence<rtl::OUString> SAL_CALL GconfBackend::getSupportedComponents(void)
-{
-#ifdef ENABLE_LOCKDOWN
-    const sal_Int32 nComponents = 7;
-#else
-    const sal_Int32 nComponents = 4;
-#endif // ENABLE_LOCKDOWN
 
-    uno::Sequence<rtl::OUString> aSupportedComponentsList(nComponents) ;
-
-    aSupportedComponentsList[0] = rtl::OUString( 
-        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.VCL")) ;
-    aSupportedComponentsList[1] = rtl::OUString( 
-        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.Inet")) ;
-    aSupportedComponentsList[2] = rtl::OUString( 
-        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.Office.Common")) ;
-    aSupportedComponentsList[3] = rtl::OUString( 
-        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.Office.Paths")) ;
-
-#ifdef ENABLE_LOCKDOWN
-    aSupportedComponentsList[4] = rtl::OUString( 
-        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.UserProfile")) ;
-    aSupportedComponentsList[5] = rtl::OUString( 
-        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.Office.Recovery")) ;
-    aSupportedComponentsList[6] = rtl::OUString( 
-        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.Setup")) ;
-#endif // ENABLE_LOCKDOWN
-            
-    return aSupportedComponentsList ;
+    return aServices ;
 }
 
 //------------------------------------------------------------------------------
Index: shell/source/backends/gconfbe/gconfbackend.hxx
===================================================================
RCS file: /cvs/gsl/shell/source/backends/gconfbe/gconfbackend.hxx,v
retrieving revision 1.6
retrieving revision 1.6.46.1
diff -u -p -u -p -r1.6 -r1.6.46.1
--- shell/source/backends/gconfbe/gconfbackend.hxx	22 Mar 2006 09:34:06 -0000	1.6
+++ shell/source/backends/gconfbe/gconfbackend.hxx	21 Jul 2006 12:53:49 -0000	1.6.46.1
@@ -174,13 +174,6 @@ class GconfBackend : public BackendBase 
           */
         static uno::Sequence<rtl::OUString> SAL_CALL getBackendServiceNames(void) ;
 
-        /**
-          Provides the supported component nodes
-
-          @return supported component nodes
-        */
-        static uno::Sequence<rtl::OUString> SAL_CALL getSupportedComponents(void) ;
-        
         /* returns a GconfClient */
         static GConfClient* getGconfClient();
         
Index: shell/source/backends/gconfbe/gconfbe.xml
===================================================================
RCS file: /cvs/gsl/shell/source/backends/gconfbe/gconfbe.xml,v
retrieving revision 1.2
retrieving revision 1.2.170.1
diff -u -p -u -p -r1.2 -r1.2.170.1
--- shell/source/backends/gconfbe/gconfbe.xml	17 Sep 2004 13:00:51 -0000	1.2
+++ shell/source/backends/gconfbe/gconfbe.xml	21 Jul 2006 12:53:50 -0000	1.2.170.1
@@ -10,7 +10,6 @@
         <language>c++</language>
         <status value="beta"/>        
         <supported-service>com.sun.star.comp.configuration.backend.GconfBackend</supported-service>		
-        <supported-service>com.sun.star.comp.configuration.backend.PlatformBackend</supported-service>		
         <service-dependency>...</service-dependency>
         <type>com.sun.star.configuration.backend.XBackendChangesListener</type>
         <type>com.sun.star.configuration.backend.XBackendChangesNotifier</type>
Index: shell/source/backends/gconfbe/gconfbe1-ucd.lockdown
===================================================================
RCS file: shell/source/backends/gconfbe/gconfbe1-ucd.lockdown
diff -N shell/source/backends/gconfbe/gconfbe1-ucd.lockdown
--- shell/source/backends/gconfbe/gconfbe1-ucd.lockdown	13 Jul 2006 12:30:37 -0000	1.3
+++ /dev/null	1 Jan 1970 00:00:00 -0000
@@ -1,9 +0,0 @@
-[ComponentDescriptor]
-ImplementationName=com.sun.star.comp.configuration.backend.GconfBackend
-ComponentName=gconfbe1.uno.so
-LoaderName=com.sun.star.loader.SharedLibrary
-[Data]
-SupportedComponents=org.openoffice.VCL;org.openoffice.Inet;org.openoffice.Office.Common;org.openoffice.Office.Paths;org.openoffice.UserProfile;org.openoffice.Office.Recovery;org.openoffice.Setup
-[SupportedServices]
-com.sun.star.configuration.backend.GconfBackend
-com.sun.star.configuration.backend.PlatformBackend
Index: shell/source/backends/gconfbe/gconfbe1-ucd.txt
===================================================================
RCS file: /cvs/gsl/shell/source/backends/gconfbe/gconfbe1-ucd.txt,v
retrieving revision 1.4
retrieving revision 1.4.2.1
diff -u -p -u -p -r1.4 -r1.4.2.1
--- shell/source/backends/gconfbe/gconfbe1-ucd.txt	13 Jul 2006 12:30:48 -0000	1.4
+++ shell/source/backends/gconfbe/gconfbe1-ucd.txt	21 Jul 2006 12:53:50 -0000	1.4.2.1
@@ -2,8 +2,5 @@
 ImplementationName=com.sun.star.comp.configuration.backend.GconfBackend
 ComponentName=gconfbe1.uno.so
 LoaderName=com.sun.star.loader.SharedLibrary
-[Data]
-SupportedComponents=org.openoffice.VCL;org.openoffice.Inet;org.openoffice.Office.Common;org.openoffice.Office.Paths
 [SupportedServices]
 com.sun.star.configuration.backend.GconfBackend
-com.sun.star.configuration.backend.PlatformBackend
Index: shell/source/backends/gconfbe/gconfbecdef.cxx
===================================================================
RCS file: /cvs/gsl/shell/source/backends/gconfbe/gconfbecdef.cxx,v
retrieving revision 1.7
retrieving revision 1.7.18.1
diff -u -p -u -p -r1.7 -r1.7.18.1
--- shell/source/backends/gconfbe/gconfbecdef.cxx	19 Jun 2006 14:16:03 -0000	1.7
+++ shell/source/backends/gconfbe/gconfbecdef.cxx	21 Jul 2006 12:53:50 -0000	1.7.18.1
@@ -138,13 +138,6 @@ extern "C" sal_Bool SAL_CALL component_w
             for (sal_Int32 i = 0 ; i < sServiceNames.getLength() ; ++ i)
                 xServicesKey->createKey(sServiceNames[i]);
 
-            // Register supported components            
-            uno::Reference<XRegistryKey> xComponentKey = xImplKey->createKey(
-                rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("/DATA/SupportedComponents") )
-            );
-        
-            xComponentKey->setAsciiListValue( GconfBackend::getSupportedComponents() );
-
             return sal_True;
         }
         
Index: shell/source/backends/gconfbe/makefile.mk
===================================================================
RCS file: /cvs/gsl/shell/source/backends/gconfbe/makefile.mk,v
retrieving revision 1.14
retrieving revision 1.14.24.1
diff -u -p -u -p -r1.14 -r1.14.24.1
--- shell/source/backends/gconfbe/makefile.mk	24 May 2006 14:03:56 -0000	1.14
+++ shell/source/backends/gconfbe/makefile.mk	21 Jul 2006 12:53:50 -0000	1.14.24.1
@@ -52,7 +52,6 @@ UCDSRCEXT = txt
 
 .IF "$(ENABLE_LOCKDOWN)" == "YES"
 CFLAGS+=-DENABLE_LOCKDOWN
-UCDSRCEXT != lockdown
 .ENDIF
 
 .IF "$(ENABLE_GNOMEVFS)"!=""
Index: shell/source/backends/kdebe/kdebackend.cxx
===================================================================
RCS file: /cvs/gsl/shell/source/backends/kdebe/kdebackend.cxx,v
retrieving revision 1.4
retrieving revision 1.4.2.1
diff -u -p -u -p -r1.4 -r1.4.2.1
--- shell/source/backends/kdebe/kdebackend.cxx	13 Jul 2006 12:31:31 -0000	1.4
+++ shell/source/backends/kdebe/kdebackend.cxx	21 Jul 2006 12:53:50 -0000	1.4.2.1
@@ -136,30 +136,11 @@ rtl::OUString SAL_CALL KDEBackend::getIm
 
 uno::Sequence<rtl::OUString> SAL_CALL KDEBackend::getBackendServiceNames(void) 
 {
-    uno::Sequence<rtl::OUString> aServices(2) ;
+    uno::Sequence<rtl::OUString> aServices(1) ;
     aServices[0] = rtl::OUString( 
         RTL_CONSTASCII_USTRINGPARAM("com.sun.star.configuration.backend.KDEBackend")) ;
-    aServices[1] = rtl::OUString( 
-        RTL_CONSTASCII_USTRINGPARAM("com.sun.star.configuration.backend.PlatformBackend")) ;
-            
-    return aServices ;
-}
-
-//------------------------------------------------------------------------------
 
-uno::Sequence<rtl::OUString> SAL_CALL KDEBackend::getSupportedComponents(void)
-{
-    uno::Sequence<rtl::OUString> aSupportedComponentsList(4) ;
-    aSupportedComponentsList[0] = rtl::OUString( 
-        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.VCL")) ;
-    aSupportedComponentsList[1] = rtl::OUString( 
-        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.Inet")) ;
-    aSupportedComponentsList[2] = rtl::OUString( 
-        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.Office.Common")) ;
-    aSupportedComponentsList[3] = rtl::OUString( 
-        RTL_CONSTASCII_USTRINGPARAM("org.openoffice.Office.Paths")) ;
-            
-    return aSupportedComponentsList ;
+    return aServices ;
 }
 
 //------------------------------------------------------------------------------
Index: shell/source/backends/kdebe/kdebackend.hxx
===================================================================
RCS file: /cvs/gsl/shell/source/backends/kdebe/kdebackend.hxx,v
retrieving revision 1.2
retrieving revision 1.2.24.1
diff -u -p -u -p -r1.2 -r1.2.24.1
--- shell/source/backends/kdebe/kdebackend.hxx	2 Jun 2006 12:24:22 -0000	1.2
+++ shell/source/backends/kdebe/kdebackend.hxx	21 Jul 2006 12:53:50 -0000	1.2.24.1
@@ -108,13 +108,6 @@ class KDEBackend : public BackendBase {
           */
         static uno::Sequence<rtl::OUString> SAL_CALL getBackendServiceNames(void) ;
 
-        /**
-          Provides the supported component nodes
-
-          @return supported component nodes
-        */
-        static uno::Sequence<rtl::OUString> SAL_CALL getSupportedComponents(void) ;
-        
         //XSingleLayerStratum
         virtual uno::Reference<backend::XLayer> SAL_CALL 
             getLayer( const rtl::OUString& aLayerId, const rtl::OUString& aTimestamp )
Index: shell/source/backends/kdebe/kdebe.xml
===================================================================
RCS file: /cvs/gsl/shell/source/backends/kdebe/kdebe.xml,v
retrieving revision 1.2
retrieving revision 1.2.24.1
diff -u -p -u -p -r1.2 -r1.2.24.1
--- shell/source/backends/kdebe/kdebe.xml	2 Jun 2006 12:24:36 -0000	1.2
+++ shell/source/backends/kdebe/kdebe.xml	21 Jul 2006 12:53:51 -0000	1.2.24.1
@@ -10,7 +10,6 @@
         <language>c++</language>
         <status value="beta"/>        
         <supported-service>com.sun.star.comp.configuration.backend.KDEBackend</supported-service>		
-        <supported-service>com.sun.star.comp.configuration.backend.PlatformBackend</supported-service>		
         <service-dependency>...</service-dependency>
         <type>com.sun.star.configuration.backend.XBackendChangesListener</type>
         <type>com.sun.star.configuration.backend.XBackendChangesNotifier</type>
Index: shell/source/backends/kdebe/kdebe1-ucd.txt
===================================================================
RCS file: /cvs/gsl/shell/source/backends/kdebe/kdebe1-ucd.txt,v
retrieving revision 1.3
retrieving revision 1.3.2.1
diff -u -p -u -p -r1.3 -r1.3.2.1
--- shell/source/backends/kdebe/kdebe1-ucd.txt	13 Jul 2006 12:31:42 -0000	1.3
+++ shell/source/backends/kdebe/kdebe1-ucd.txt	21 Jul 2006 12:53:51 -0000	1.3.2.1
@@ -2,8 +2,5 @@
 ImplementationName=com.sun.star.comp.configuration.backend.KDEBackend
 ComponentName=kdebe1.uno.so
 LoaderName=com.sun.star.loader.SharedLibrary
-[Data]
-SupportedComponents=org.openoffice.VCL;org.openoffice.Inet;org.openoffice.Office.Common;org.openoffice.Office.Paths
 [SupportedServices]
 com.sun.star.configuration.backend.KDEBackend
-com.sun.star.configuration.backend.PlatformBackend
Index: shell/source/backends/kdebe/kdebecdef.cxx
===================================================================
RCS file: /cvs/gsl/shell/source/backends/kdebe/kdebecdef.cxx,v
retrieving revision 1.4
retrieving revision 1.4.12.1
diff -u -p -u -p -r1.4 -r1.4.12.1
--- shell/source/backends/kdebe/kdebecdef.cxx	27 Jun 2006 11:51:58 -0000	1.4
+++ shell/source/backends/kdebe/kdebecdef.cxx	21 Jul 2006 12:53:51 -0000	1.4.12.1
@@ -128,13 +128,6 @@ extern "C" sal_Bool SAL_CALL component_w
             for (sal_Int32 i = 0 ; i < sServiceNames.getLength() ; ++ i)
                 xServicesKey->createKey(sServiceNames[i]);
 
-            // Register supported components            
-            uno::Reference<XRegistryKey> xComponentKey = xImplKey->createKey(
-                rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("/DATA/SupportedComponents") )
-            );
-        
-            xComponentKey->setAsciiListValue( KDEBackend::getSupportedComponents() );
-
             return sal_True;
         }
         
Index: vcl/source/app/svmain.cxx
===================================================================
RCS file: /cvs/gsl/vcl/source/app/svmain.cxx,v
retrieving revision 1.62
retrieving revision 1.62.20.1
diff -u -p -u -p -r1.62 -r1.62.20.1
--- vcl/source/app/svmain.cxx	10 Jul 2006 16:34:23 -0000	1.62
+++ vcl/source/app/svmain.cxx	21 Jul 2006 12:53:51 -0000	1.62.20.1
@@ -158,6 +158,12 @@ using namespace ::com::sun::star::lang;
 #include <fontcfg.hxx>
 #include <configsettings.hxx>
 
+#ifndef _CPPUHELPER_IMPLBASE1_HXX_
+#include <cppuhelper/implbase1.hxx>
+#endif
+#ifndef _UNO_CURRENT_CONTEXT_HXX_
+#include <uno/current_context.hxx>
+#endif
 
 
 // =======================================================================
@@ -290,6 +296,36 @@ public:
     void                Main(){};
 };
 
+class DesktopEnvironmentContext: public cppu::WeakImplHelper1< com::sun::star::uno::XCurrentContext >
+{
+public:
+    DesktopEnvironmentContext( const com::sun::star::uno::Reference< com::sun::star::uno::XCurrentContext > & ctx)
+        : m_xNextContext( ctx ) {}
+
+    // XCurrentContext
+    virtual com::sun::star::uno::Any SAL_CALL getValueByName( const rtl::OUString& Name )
+            throw (com::sun::star::uno::RuntimeException);
+
+private:
+    com::sun::star::uno::Reference< com::sun::star::uno::XCurrentContext > m_xNextContext;
+};
+
+Any SAL_CALL DesktopEnvironmentContext::getValueByName( const rtl::OUString& Name) throw (RuntimeException)
+{
+    Any retVal;
+
+    if ( 0 == Name.compareToAscii( "system.desktop-environment" ) )
+    {
+        retVal = makeAny( Application::GetDesktopEnvironment() );
+    }
+    else if( m_xNextContext.is() )
+    {
+        // Call next context in chain if found
+        retVal = m_xNextContext->getValueByName( Name );
+    }
+    return retVal;
+}
+
 BOOL InitVCL( const ::com::sun::star::uno::Reference< ::com::sun::star::lang::XMultiServiceFactory > & rSMgr )
 {
     RTL_LOGFILE_CONTEXT( aLog, "vcl (ss112471) ::InitVCL" );
@@ -330,6 +366,10 @@ BOOL InitVCL( const ::com::sun::star::un
     if ( !pSVData->mpDefInst )
         return FALSE;
     RTL_LOGFILE_CONTEXT_TRACE( aLog, "} ::CreateSalInstance" );
+
+    // Desktop Environment context (to be able to get value of "system.desktop-environment" as soon as possible)
+    com::sun::star::uno::setCurrentContext(
+        new DesktopEnvironmentContext( com::sun::star::uno::getCurrentContext() ) );
 
 	// Initialize application instance (should be done after initialization of VCL SAL part)
     if( pSVData->mpApp )
Index: scp2/source/ooo/file_library_ooo.scp
===================================================================
RCS file: /cvs/installation/scp2/source/ooo/file_library_ooo.scp,v
retrieving revision 1.206
retrieving revision 1.206.8.1
diff -u -p -u -p -r1.206 -r1.206.8.1
--- scp2/source/ooo/file_library_ooo.scp	13 Jul 2006 10:26:22 -0000	1.206
+++ scp2/source/ooo/file_library_ooo.scp	21 Jul 2006 12:53:51 -0000	1.206.8.1
@@ -790,6 +790,16 @@ End
 #endif
 
 #ifdef UNX
+
+File gid_File_Lib_Desktopbe
+    TXT_FILE_BODY;
+    Styles = (PACKED);
+    Dir = gid_Dir_Program;
+    Name = STRING(CONCAT2(desktopbe1.uno,UNXSUFFIX));
+    RegistryID = gid_Starregistry_Services_Rdb;
+    Regmergefile = "desktopbe1-ucd.txt";
+End
+
 #ifdef ENABLE_GTK
 #ifdef GTK_TWO_FOUR
 File gid_File_Lib_Fps_Gnome
Index: desktop/source/app/desktopcontext.cxx
===================================================================
RCS file: /cvs/framework/desktop/source/app/desktopcontext.cxx,v
retrieving revision 1.4
retrieving revision 1.4.206.1
diff -u -p -u -p -r1.4 -r1.4.206.1
--- desktop/source/app/desktopcontext.cxx	8 Sep 2005 17:07:10 -0000	1.4
+++ desktop/source/app/desktopcontext.cxx	21 Jul 2006 12:53:52 -0000	1.4.206.1
@@ -56,11 +56,7 @@ Any SAL_CALL DesktopContext::getValueByN
 {
     Any retVal;
 
-    if ( 0 == Name.compareToAscii( DESKTOP_ENVIRONMENT_NAME ) )
-    {
-        retVal = makeAny( Application::GetDesktopEnvironment() );
-    }
-    else if ( 0 == Name.compareToAscii( JAVA_INTERACTION_HANDLER_NAME ))
+    if ( 0 == Name.compareToAscii( JAVA_INTERACTION_HANDLER_NAME ))
     {
         retVal = makeAny( Reference< XInteractionHandler >( new svt::JavaInteractionHandler()) );
     }
Index: desktop/source/app/desktopcontext.hxx
===================================================================
RCS file: /cvs/framework/desktop/source/app/desktopcontext.hxx,v
retrieving revision 1.3
retrieving revision 1.3.206.1
diff -u -p -u -p -r1.3 -r1.3.206.1
--- desktop/source/app/desktopcontext.hxx	8 Sep 2005 17:07:26 -0000	1.3
+++ desktop/source/app/desktopcontext.hxx	21 Jul 2006 12:53:52 -0000	1.3.206.1
@@ -44,8 +44,6 @@
 #include <uno/current_context.hxx>
 #endif
 
-#define DESKTOP_ENVIRONMENT_NAME "system.desktop-environment"
-
 namespace desktop
 {
     class DesktopContext: public cppu::WeakImplHelper1< com::sun::star::uno::XCurrentContext >
