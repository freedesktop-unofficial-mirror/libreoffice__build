Index: connectivity/source/drivers/dbase/DTable.cxx
===================================================================
RCS file: /cvs/dba/connectivity/source/drivers/dbase/DTable.cxx,v
retrieving revision 1.91
diff -u -p -u -r1.91 DTable.cxx
--- connectivity/source/drivers/dbase/DTable.cxx	16 Jan 2006 15:03:59 -0000	1.91
+++ connectivity/source/drivers/dbase/DTable.cxx	22 May 2006 11:17:42 -0000
@@ -1650,8 +1650,8 @@ BOOL ODbaseTable::UpdateBuffer(OValueRef
 
                     // convert the string, using the connection's encoding
                     ::rtl::OString sEncoded;
-                    DBTypeConversion::convertUnicodeString( sStringToWrite, sEncoded, getConnection()->getTextEncoding() );
-                    memcpy( pData, sEncoded.getStr(), ::std::min( nLen, sEncoded.getLength() ) );
+                    DBTypeConversion::convertUnicodeStringToLength( sStringToWrite, sEncoded, nLen, getConnection()->getTextEncoding() );
+                    memcpy( pData, sEncoded.getStr(), sEncoded.getLength() );
 
 				}
                 break;
Index: connectivity/source/commontools/dbtools2.cxx
===================================================================
RCS file: /cvs/dba/connectivity/source/commontools/dbtools2.cxx,v
retrieving revision 1.14
diff -u -p -u -r1.14 dbtools2.cxx
--- connectivity/source/commontools/dbtools2.cxx	8 Sep 2005 05:15:04 -0000	1.14
+++ connectivity/source/commontools/dbtools2.cxx	22 May 2006 11:17:42 -0000
@@ -877,6 +877,32 @@ sal_Int32 DBTypeConversion::convertUnico
 
         return _rDest.getLength();
     }
+
+#include <stdio.h>
+
+sal_Int32 DBTypeConversion::convertUnicodeStringToLength(
+	const ::rtl::OUString& _rSource,
+	::rtl::OString&  _rDest,
+	sal_Int32 _nToLength,
+	rtl_TextEncoding _eEncoding
+)
+{
+	/* this could clearly be optimized several ways */
+	sal_Int32 nLen = 0, nSize;
+	for (nSize = _rSource.getLength(); nSize > 0; nSize--) {
+		if ((nLen = convertUnicodeString (_rSource.copy(0, nSize),
+										  _rDest, _eEncoding)) > _nToLength)
+			_rDest = rtl::OString();
+		else
+			break;
+	}
+	if (nSize != _rSource.getLength())
+		fprintf (stderr, "Truncated string '%s' to '%s' %d %d\n",
+				 rtl::OUStringToOString(_rSource, RTL_TEXTENCODING_UTF8).getStr(),
+				 _rDest.getStr(), nLen, _nToLength);
+
+	return ::std::min (nLen, _nToLength);
+}
 //.........................................................................
 }	// namespace dbtools
 //.........................................................................
Index: dbaccess/source/ui/dlg/detailpages.cxx
===================================================================
RCS file: /cvs/dba/dbaccess/source/ui/dlg/detailpages.cxx,v
retrieving revision 1.38
diff -u -p -u -r1.38 detailpages.cxx
--- dbaccess/source/ui/dlg/detailpages.cxx	23 Sep 2005 12:29:50 -0000	1.38
+++ dbaccess/source/ui/dlg/detailpages.cxx	22 May 2006 11:31:08 -0000
@@ -359,8 +359,7 @@ DBG_NAME(OCommonBehaviourTabPage)
 			if (pTypeCollection && pConnectUrl && pConnectUrl->GetValue().Len())
 				eDSType = pTypeCollection->getType(pConnectUrl->GetValue());
 
-			// the only type we're interested in is DBASE
-			if ( DST_DBASE == eDSType )
+			if ( 0 )
 			{
 				// for these types, we need to exclude all encodings which do not have a fixed character
 				// length (such as UTF-8)

Index: connectivity/inc/connectivity/dbconversion.hxx
===================================================================
RCS file: /cvs/dba/connectivity/inc/connectivity/dbconversion.hxx,v
retrieving revision 1.13
diff -u -p -u -r1.13 dbconversion.hxx
--- connectivity/inc/connectivity/dbconversion.hxx	8 Sep 2005 05:00:55 -0000	1.13
+++ connectivity/inc/connectivity/dbconversion.hxx	22 May 2006 18:47:39 -0000
@@ -197,6 +197,14 @@ namespace dbtools
             rtl_TextEncoding _eEncoding
         )
             SAL_THROW((::com::sun::star::sdbc::SQLException));
+
+        static sal_Int32 convertUnicodeStringToLength(
+            const ::rtl::OUString& _rSource,
+            ::rtl::OString&  _rDest,
+			sal_Int32 _nToLength,
+            rtl_TextEncoding _eEncoding
+		)
+            SAL_THROW((::com::sun::star::sdbc::SQLException));
 	};
 
 //.........................................................................
--- connectivity/source/drivers/file/FConnection.cxx	2006-07-25 18:29:56.000000000 +0800
+++ connectivity/source/drivers/file/FConnection.cxx	2006-07-25 18:33:46.000000000 +0800
@@ -202,7 +202,9 @@ void OConnection::construct(const ::rtl:
 	if ( m_nTextEncoding == RTL_TEXTENCODING_DONTKNOW )
 	{
 		//m_nTextEncoding = osl_getTextEncodingFromLocale(NULL);
-		m_nTextEncoding = osl_getThreadTextEncoding();
+		//m_nTextEncoding = osl_getThreadTextEncoding();
+        //The default encoding set as UTF8.
+		m_nTextEncoding = RTL_TEXTENCODING_UTF8;
 	}
 
 	if ( aExt.getLength() )
