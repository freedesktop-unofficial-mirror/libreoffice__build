--- configmgr/source/platformbe/systemintegrationmanager.cxx	2006-06-05 15:32:02.000000000 +0000
+++ configmgr/source/platformbe/systemintegrationmanager.cxx	2006-06-05 17:28:34.000000000 +0000
@@ -50,6 +50,10 @@
 #include <com/sun/star/registry/XRegistryKey.hpp>
 #endif
 
+#ifndef _UNO_CURRENT_CONTEXT_HXX_
+#include <uno/current_context.hxx>
+#endif
+
 namespace configmgr { namespace backend { 
 
 
@@ -102,7 +106,23 @@ void SAL_CALL SystemIntegrationManager::
 		   lang::IllegalArgumentException,
            backenduno::BackendSetupException) 
 {
-	buildLookupTable();
+    buildLookupTable( rtl::OUString::createFromAscii( "com.sun.star.configuration.backend.PlatformBackend" ) );
+
+    uno::Reference< uno::XCurrentContext > xCurrentContext( uno::getCurrentContext() );
+    if ( xCurrentContext.is() )
+    {
+        uno::Any aValue = xCurrentContext->getValueByName(
+                rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( "system.desktop-environment" ) ) );
+
+        rtl::OUString aDesktopEnvironment;
+        if ( aValue >>= aDesktopEnvironment )
+        {
+            if ( aDesktopEnvironment.equalsIgnoreAsciiCaseAscii( "gnome" ) )
+                buildLookupTable( rtl::OUString::createFromAscii( "com.sun.star.configuration.backend.GconfBackend" ) );
+            else if ( aDesktopEnvironment.equalsIgnoreAsciiCaseAscii( "kde" ) )
+                buildLookupTable( rtl::OUString::createFromAscii( "com.sun.star.configuration.backend.KDEBackend" ) );
+        }
+    }
 }
 //------------------------------------------------------------------------------
 static const rtl::OUString getAllComponentsName()
@@ -113,17 +133,14 @@ static const rtl::OUString getAllCompone
 
 //------------------------------------------------------------------------------
 
-void SystemIntegrationManager::buildLookupTable()
+void SystemIntegrationManager::buildLookupTable(const rtl::OUString &rPlatformServiceName)
 {
-    static const rtl::OUString kPlatformServiceName(
-            RTL_CONSTASCII_USTRINGPARAM("com.sun.star.configuration.backend.PlatformBackend")) ;
-
     //Build platform backend map componentName -> servicefactory
     uno::Reference<css::container::XContentEnumerationAccess> xEnumAccess 
 		(mContext->getServiceManager(),uno::UNO_QUERY_THROW);
     
 	uno::Reference<css::container::XEnumeration> xEnum = 
-		xEnumAccess->createContentEnumeration(kPlatformServiceName); 
+		xEnumAccess->createContentEnumeration(rPlatformServiceName); 
 	if (xEnum.is())
 	{
         osl::MutexGuard lock(mMutex);
--- configmgr/source/platformbe/systemintegrationmanager.hxx	2006-06-05 15:32:05.000000000 +0000
+++ configmgr/source/platformbe/systemintegrationmanager.hxx	2006-06-05 15:32:38.000000000 +0000
@@ -183,7 +183,7 @@ private :
 
     /** build lookup up table
     */
-    void buildLookupTable();
+    void buildLookupTable(const rtl::OUString &rPlatformServiceName);
 
     /** get list of supported components
     */
--- desktop/source/app/desktopcontext.cxx	2005-09-08 17:07:10.000000000 +0000
+++ desktop/source/app/desktopcontext.cxx	2006-06-05 17:20:10.000000000 +0000
@@ -56,11 +56,7 @@ Any SAL_CALL DesktopContext::getValueByN
 {
     Any retVal;
 
-    if ( 0 == Name.compareToAscii( DESKTOP_ENVIRONMENT_NAME ) )
-    {
-        retVal = makeAny( Application::GetDesktopEnvironment() );
-    }
-    else if ( 0 == Name.compareToAscii( JAVA_INTERACTION_HANDLER_NAME ))
+    if ( 0 == Name.compareToAscii( JAVA_INTERACTION_HANDLER_NAME ))
     {
         retVal = makeAny( Reference< XInteractionHandler >( new svt::JavaInteractionHandler()) );
     }
--- desktop/source/app/desktopcontext.hxx	2006-06-05 16:56:33.000000000 +0000
+++ desktop/source/app/desktopcontext.hxx	2006-06-05 16:56:48.000000000 +0000
@@ -44,8 +44,6 @@
 #include <uno/current_context.hxx>
 #endif
 
-#define DESKTOP_ENVIRONMENT_NAME "system.desktop-environment"
-
 namespace desktop
 {
     class DesktopContext: public cppu::WeakImplHelper1< com::sun::star::uno::XCurrentContext >
--- shell/source/backends/gconfbe/gconfbackend.cxx	2006-03-22 09:33:42.000000000 +0000
+++ shell/source/backends/gconfbe/gconfbackend.cxx	2006-06-05 15:42:20.000000000 +0000
@@ -933,12 +933,10 @@ rtl::OUString SAL_CALL GconfBackend::get
 
 uno::Sequence<rtl::OUString> SAL_CALL GconfBackend::getBackendServiceNames(void) 
 {
-    uno::Sequence<rtl::OUString> aServices(2) ;
+    uno::Sequence<rtl::OUString> aServices(1) ;
     aServices[0] = rtl::OUString( 
         RTL_CONSTASCII_USTRINGPARAM("com.sun.star.configuration.backend.GconfBackend")) ;
-    aServices[1] = rtl::OUString( 
-        RTL_CONSTASCII_USTRINGPARAM("com.sun.star.configuration.backend.PlatformBackend")) ;
-            
+
     return aServices ;
 }
 
--- shell/source/backends/gconfbe/gconfbe.xml	2004-09-17 13:00:51.000000000 +0000
+++ shell/source/backends/gconfbe/gconfbe.xml	2006-06-05 15:42:23.000000000 +0000
@@ -10,7 +10,6 @@
         <language>c++</language>
         <status value="beta"/>        
         <supported-service>com.sun.star.comp.configuration.backend.GconfBackend</supported-service>		
-        <supported-service>com.sun.star.comp.configuration.backend.PlatformBackend</supported-service>		
         <service-dependency>...</service-dependency>
         <type>com.sun.star.configuration.backend.XBackendChangesListener</type>
         <type>com.sun.star.configuration.backend.XBackendChangesNotifier</type>
--- shell/source/backends/gconfbe/gconfbe1-ucd.lockdown	2006-06-07 12:59:08.000000000 +0000
+++ shell/source/backends/gconfbe/gconfbe1-ucd.lockdown	2006-06-07 12:59:32.000000000 +0000
@@ -6,4 +6,3 @@ LoaderName=com.sun.star.loader.SharedLib
 SupportedComponents=org.openoffice.VCL;org.openoffice.Inet;org.openoffice.Office.Common;org.openoffice.UserProfile;org.openoffice.Office.Recovery;org.openoffice.Setup
 [SupportedServices]
 com.sun.star.configuration.backend.GconfBackend
-com.sun.star.configuration.backend.PlatformBackend
--- shell/source/backends/gconfbe/gconfbe1-ucd.txt	2005-01-31 13:13:04.000000000 +0000
+++ shell/source/backends/gconfbe/gconfbe1-ucd.txt	2006-06-05 17:46:45.000000000 +0000
@@ -6,4 +6,3 @@ LoaderName=com.sun.star.loader.SharedLib
 SupportedComponents=org.openoffice.VCL;org.openoffice.Inet;org.openoffice.Office.Common
 [SupportedServices]
 com.sun.star.configuration.backend.GconfBackend
-com.sun.star.configuration.backend.PlatformBackend
--- shell/source/backends/kdebe/kdebackend.cxx	2006-06-02 09:21:33.000000000 +0000
+++ shell/source/backends/kdebe/kdebackend.cxx	2006-06-05 15:43:05.000000000 +0000
@@ -129,12 +129,10 @@ rtl::OUString SAL_CALL KDEBackend::getIm
 
 uno::Sequence<rtl::OUString> SAL_CALL KDEBackend::getBackendServiceNames(void) 
 {
-    uno::Sequence<rtl::OUString> aServices(2) ;
+    uno::Sequence<rtl::OUString> aServices(1) ;
     aServices[0] = rtl::OUString( 
         RTL_CONSTASCII_USTRINGPARAM("com.sun.star.configuration.backend.KDEBackend")) ;
-    aServices[1] = rtl::OUString( 
-        RTL_CONSTASCII_USTRINGPARAM("com.sun.star.configuration.backend.PlatformBackend")) ;
-            
+
     return aServices ;
 }
 
--- shell/source/backends/kdebe/kdebe.xml	2006-06-02 09:21:33.000000000 +0000
+++ shell/source/backends/kdebe/kdebe.xml	2006-06-05 15:42:55.000000000 +0000
@@ -10,7 +10,6 @@
         <language>c++</language>
         <status value="beta"/>        
         <supported-service>com.sun.star.comp.configuration.backend.KDEBackend</supported-service>		
-        <supported-service>com.sun.star.comp.configuration.backend.PlatformBackend</supported-service>		
         <service-dependency>...</service-dependency>
         <type>com.sun.star.configuration.backend.XBackendChangesListener</type>
         <type>com.sun.star.configuration.backend.XBackendChangesNotifier</type>
--- shell/source/backends/kdebe/kdebe1-ucd.txt	2006-06-02 09:21:33.000000000 +0000
+++ shell/source/backends/kdebe/kdebe1-ucd.txt	2006-06-05 17:46:48.000000000 +0000
@@ -6,4 +6,3 @@ LoaderName=com.sun.star.loader.SharedLib
 SupportedComponents=org.openoffice.VCL;org.openoffice.Inet;org.openoffice.Office.Common
 [SupportedServices]
 com.sun.star.configuration.backend.KDEBackend
-com.sun.star.configuration.backend.PlatformBackend
--- vcl/source/app/svmain.cxx	2006-05-18 06:41:04.000000000 +0000
+++ vcl/source/app/svmain.cxx	2006-06-05 17:11:21.000000000 +0000
@@ -155,6 +155,12 @@ using namespace ::com::sun::star::lang;
 #include <fontcfg.hxx>
 #include <configsettings.hxx>
 
+#ifndef _CPPUHELPER_IMPLBASE1_HXX_
+#include <cppuhelper/implbase1.hxx>
+#endif
+#ifndef _UNO_CURRENT_CONTEXT_HXX_
+#include <uno/current_context.hxx>
+#endif
 
 
 // =======================================================================
@@ -284,6 +291,36 @@ public:
     void                Main(){};
 };
 
+class DesktopEnvironmentContext: public cppu::WeakImplHelper1< com::sun::star::uno::XCurrentContext >
+{
+public:
+    DesktopEnvironmentContext( const com::sun::star::uno::Reference< com::sun::star::uno::XCurrentContext > & ctx)
+        : m_xNextContext( ctx ) {}
+
+    // XCurrentContext
+    virtual com::sun::star::uno::Any SAL_CALL getValueByName( const rtl::OUString& Name )
+            throw (com::sun::star::uno::RuntimeException);
+
+private:
+    com::sun::star::uno::Reference< com::sun::star::uno::XCurrentContext > m_xNextContext;
+};
+
+Any SAL_CALL DesktopEnvironmentContext::getValueByName( const rtl::OUString& Name) throw (RuntimeException)
+{
+    Any retVal;
+
+    if ( 0 == Name.compareToAscii( "system.desktop-environment" ) )
+    {
+        retVal = makeAny( Application::GetDesktopEnvironment() );
+    }
+    else if( m_xNextContext.is() )
+    {
+        // Call next context in chain if found
+        retVal = m_xNextContext->getValueByName( Name );
+    }
+    return retVal;
+}
+
 BOOL InitVCL( const ::com::sun::star::uno::Reference< ::com::sun::star::lang::XMultiServiceFactory > & rSMgr )
 {
     RTL_LOGFILE_CONTEXT( aLog, "vcl (ss112471) ::InitVCL" );
@@ -325,6 +362,10 @@ BOOL InitVCL( const ::com::sun::star::un
         return FALSE;
     RTL_LOGFILE_CONTEXT_TRACE( aLog, "} ::CreateSalInstance" );
 
+    // Desktop Environment context (to be able to get value of "system.desktop-environment" as soon as possible)
+    com::sun::star::uno::setCurrentContext(
+        new DesktopEnvironmentContext( com::sun::star::uno::getCurrentContext() ) );
+
 	// Initialize application instance (should be done after initialization of VCL SAL part)
     if( pSVData->mpApp )
         // call init to initialize application class
