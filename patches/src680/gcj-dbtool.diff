Index: configure.in
===================================================================
RCS file: /cvs/tools/config_office/configure.in,v
retrieving revision 1.106
diff -u -p -r1.106 configure.in
--- config_office/configure.in	8 Mar 2005 16:31:52 -0000	1.106
+++ config_office/configure.in	18 Mar 2005 08:22:43 -0000
@@ -1843,6 +1852,26 @@ AC_SUBST(JAVAINTERPRETER)
 AC_SUBST(JAVACOMPILER)
 AC_SUBST(JAVADOC)
 
+dnl ===================================================================
+dnl Check for optional gcj-dbtool
+dnl ===================================================================
+if test "$JDK" == "gcj"; then 
+    javacache=`echo $WITH_JAVA | $SED -e "s/gij/gcj-dbtool/g"`
+    if test -z "$with_jdk_home"; then
+        AC_PATH_PROG(JAVACACHE, $javacache)
+    else
+        _javac_path="$with_jdk_home/bin/$javacache"
+        dnl Check if there is a gcj-dbtool at all.
+        if test -x "$_javac_path"; then
+            JAVACACHE=$_javac_path
+        fi
+    fi
+    if test -z "$JAVACACHE"; then
+      AC_MSG_WARN([$javacache not found set with_jdk_home])
+    fi
+fi
+AC_SUBST(JAVACACHE)
+
 if test "$NEEDXSLTPROC" = "no"; then
    XSLTPROC=NO_XSLTPROC
 else
Index: set_soenv.in
===================================================================
RCS file: /cvs/tools/config_office/set_soenv.in,v
retrieving revision 1.52
diff -u -p -r1.52 set_soenv.in
--- config_office/set_soenv.in	8 Mar 2005 16:35:34 -0000	1.52
+++ config_office/set_soenv.in	18 Mar 2005 08:22:44 -0000
@@ -78,7 +78,7 @@ my ( $oldPATH, $SRC_ROOT, $SO_HOME, $JAV
      $UPD, $SOLARUPD, $WORK_STAMP, $TF_ONE51, $TF_UCB, 
      $URD_ONLY, $SOLARROOT, $SOLARSRC, $DEVROOT, $SOLARVER, $SOLARVERSION, $SOLARENV, 
      $STAR_INIROOT, $STAR_INIROOTOLD, $STAR_STANDLST, $STAR_SSCOMMON, $STAR_SSOLARINI, 
-     $STAR_REGISTRY, $STAR_RESOURCEPATH, $DMAKEROOT, $CLASSPATH, $XCLASSPATH, $COMPATH, 
+     $STAR_REGISTRY, $STAR_RESOURCEPATH, $DMAKEROOT, $CLASSPATH, $XCLASSPATH, $COMPATH, $GCJ_DATABASE,
      $MSPDB_PATH, $MIDL_PATH, $CSC_PATH, $NMAKE_PATH, 
      $LD_LIBRARY_PATH, $PATH, $SOLARDEF, $SOLAREXTRAINC, $SOLAREXTRALIB, $SOLARLIB, 
      $SOLARINC, $LOCALINI, $PATHEXTRA, $FRAMEWORKSHOME, $COMEX, $MULTITHREAD_OBJ, $PERL, 
@@ -848,6 +849,8 @@ $CLASSPATH            = '$JAVA_HOME'.$ds
 # Location of the JDK supported standard classes.zip file.
 # see above for why the change
 $XCLASSPATH           = '$JAVA_HOME'.$ds.'jre'.$LIB.$ds."rt.jar".$ps.'.';
+# Localtion of gcj cache
+$GCJ_DATABASE = '$SOLARVER'.$ds.'$UPD'.$ds.'$INPATH'.$LIB.$ds."openoffice.org.gcjdb";
 
 # Paths to run time shared libraries.
 if ($platform =~ m/solaris/) 
@@ -1585,6 +1594,10 @@ if ( $JDK ne "gcj" ) {
    ToFile( "CLASSPATH",         $CLASSPATH,         "e" );
    ToFile( "XCLASSPATH",        $XCLASSPATH,        "e" );
 }
+else {
+   ToFile( "GCJ_DATABASE",     $GCJ_DATABASE,       "e" );
+   ToFile( "JAVACACHE",        '@JAVACACHE@',       "e" );
+}
 if ( $platform =~ m/darwin/ )
 {  ToFile( "DYLD_LIBRARY_PATH", $LD_LIBRARY_PATH,   "e" );
 }
Index: inc/settings.mk
===================================================================
RCS file: /cvs/tools/solenv/inc/settings.mk,v
retrieving revision 1.166
diff -u -p -r1.166 settings.mk
--- solenv/inc/settings.mk	1 Mar 2005 16:14:15 -0000	1.166
+++ solenv/inc/settings.mk	18 Mar 2005 08:07:43 -0000
@@ -209,7 +209,7 @@ JAVADOC=javadoc -J-Xmx120m
 .IF "$(JDK)" == "gcj"
 #JAVAC=$(JAVACOMPILER) -g -fno-assert -Wno-deprecated -C
 JAVAC=$(JAVACOMPILER) --encoding=ISO-8859-15 -g -fno-assert -Wno-deprecated -C
-JAVAI=$(JAVAINTERPRETER) -Dgnu.gcj.runtime.VMClassLoader.library_control=never
+JAVAI=$(JAVAINTERPRETER) -Dgnu.gcj.precompiled.db.path=$(GCJ_DATABASE)
 .ELSE
 JAVAC=$(JAVACOMPILER)
 JAVAI=$(JAVAINTERPRETER)
Index: bin/deliver.pl
===================================================================
RCS file: /cvs/tools/solenv/bin/deliver.pl,v
retrieving revision 1.78
diff -u -p -r1.78 deliver.pl
--- solenv/bin/deliver.pl	14 Jan 2005 11:33:44 -0000	1.78
+++ solenv/bin/deliver.pl	18 Mar 2005 10:08:25 -0000
@@ -702,6 +702,15 @@ sub is_unstripped {
     return '';
 }
 
+sub is_jar {
+    my $file_name = shift;
+
+    if (-f $file_name && (( `file $file_name` ) =~ /Zip archive/o)) {
+        return '1' if ($file_name =~ /\.jar\.*/o);
+    };
+    return '';
+}
+
 sub execute_system {
     my $command = shift;
     if (system($command)) {
@@ -718,6 +727,16 @@ sub strip_target {
     return $rc;
 };
 
+sub cachejar {
+    my $file = shift;
+    my $to = $file.".so";
+    print "CACHEJAR: $file -> $to with $ENV{GCJ_DATABASE}\n";
+    print "Caching 1/2: $ENV{JAVACOMPILER} -shared -findirect-dispatch -fjni -o $to $file\n";
+    system("$ENV{JAVACOMPILER} -shared -findirect-dispatch -fjni -o $to $file");
+    print "Caching 2/2: $ENV{JAVACACHE} -a $ENV{GCJ_DATABASE} $file $to\n";
+    system("$ENV{JAVACACHE} -a $ENV{GCJ_DATABASE} $file $to");
+};
+
 sub copy_if_newer 
 {
     # return 0 if file is unchanged ( for whatever reason )
@@ -754,6 +773,9 @@
         # hard link if possible
         if( link($from, $to) ){
             print "LINK: $from -> $to\n";
+            if ($ENV{JDK} eq 'gcj' && is_jar($from)) {
+                cachejar($to);
+            }
             return 1;
         }
     }
@@ -776,6 +795,9 @@ sub copy_if_newer 
         fix_file_permissions($$from_stat_ref[2], $temp_file);
         $rc = rename($temp_file, $to);
         if ( $rc ) {
+            if ($ENV{JDK} eq 'gcj' && is_jar($from)) {
+                cachejar($to);
+            }
             # handle special packaging of *.dylib files for Mac OS X
             if ( $^O eq 'darwin' )
             {
