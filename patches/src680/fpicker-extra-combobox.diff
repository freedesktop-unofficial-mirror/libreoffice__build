--- fpicker/source/unx/gnome/SalGtkFilePicker.cxx	2005-02-14 10:39:19.877802587 +0530
+++ fpicker/source/unx/gnome/SalGtkFilePicker.cxx	2005-02-14 10:42:21.217193172 +0530
@@ -169,6 +169,7 @@ SalGtkFilePicker::SalGtkFilePicker( cons
 		lang::XServiceInfo>( m_rbHelperMtx ),
 	m_xServiceMgr( xServiceMgr ),
 	m_aAsyncEventNotifier( rBHelper ),
+	m_pFilterComboBox( NULL ),
 	m_pVBox ( NULL ),
 	m_pFilterList( NULL ),
     bVersionWidthUnset( false ),
@@ -618,12 +619,32 @@ rtl::OUString SAL_CALL SalGtkFilePicker:
 
 	OSL_TRACE( "GetCURRENTfilter\n" );
 
-	// Update the filtername from the users selection if they have had a chance to do so.
-	if( GtkFileFilter *filter = gtk_file_chooser_get_filter( GTK_FILE_CHOOSER( m_pDialog ) ) )
+	if( m_pFilterComboBox )
 	{
-		const gchar* filtername = gtk_file_filter_get_name( filter );
-		m_aCurrentFilter = rtl::OUString( filtername, strlen( filtername ), 
+		gint nFilterChoice = gtk_combo_box_get_active( GTK_COMBO_BOX( m_pFilterComboBox ) );
+                                                                                                                                     
+		gint nFilterPos = 0;
+		for     (       FilterList::iterator aListIter = m_pFilterList->begin();
+				aListIter != m_pFilterList->end();
+				++aListIter, ++nFilterPos
+			)
+		{
+			if ( nFilterPos == nFilterChoice )
+			{
+				m_aCurrentFilter = OUString( aListIter->getTitle() );
+				break;
+			}
+		}
+	}
+	else
+	{
+		// Update the filtername from the users selection if they have had a chance to do so.
+		if( GtkFileFilter *filter = gtk_file_chooser_get_filter( GTK_FILE_CHOOSER( m_pDialog ) ) )
+		{
+			const gchar* filtername = gtk_file_filter_get_name( filter );
+			m_aCurrentFilter = rtl::OUString( filtername, strlen( filtername ), 
 							RTL_TEXTENCODING_UTF8 );
+		}
 	}
 
 	OSL_TRACE( "Returning current filter of %s\n", 
@@ -746,18 +767,22 @@ uno::Sequence<rtl::OUString> SAL_CALL Sa
 
 		if( GTK_FILE_CHOOSER_ACTION_SAVE == eAction )
 		{
-			const gchar* filtername = 
-				gtk_file_filter_get_name( gtk_file_chooser_get_filter( GTK_FILE_CHOOSER( m_pDialog ) ) );
-
-			OSL_TRACE( "2: current filter is %s\n", filtername );
+			OUString aFilter;
 
+			gint nFilterChoice = gtk_combo_box_get_active( GTK_COMBO_BOX( m_pFilterComboBox ) );
 
-			FilterList::iterator aListIter = ::std::find_if( 
-			       			m_pFilterList->begin(), m_pFilterList->end(), 
-						FilterTitleMatch( OUString( filtername,
-							strlen( filtername ), RTL_TEXTENCODING_UTF8 ) ) );
-
-			OUString aFilter = aListIter->getFilter();
+               		gint nFilterPos = 0;
+		        for     (       FilterList::iterator aListIter = m_pFilterList->begin();
+					aListIter != m_pFilterList->end();
+					++aListIter, ++nFilterPos
+				)
+			{
+				if ( nFilterPos == nFilterChoice )
+				{
+					aFilter = OUString( aListIter->getFilter() );
+					break;
+				}
+			}
 
 			OSL_TRACE( "turned into %s\n", 
 				OUStringToOString( aFilter, RTL_TEXTENCODING_UTF8 ).getStr() );
@@ -1593,6 +1618,13 @@ void SAL_CALL SalGtkFilePicker::initiali
         gtk_box_pack_end( GTK_BOX( m_pVBox ), m_pHBoxs[i], FALSE, FALSE, 0 );
 	}
 
+	if( GTK_FILE_CHOOSER_ACTION_SAVE == eAction )
+	{
+		m_pFilterComboBox = gtk_combo_box_new_text();
+		gtk_box_pack_end( GTK_BOX( m_pVBox ), m_pFilterComboBox, FALSE, TRUE, 7 );
+		gtk_widget_show( m_pFilterComboBox );
+	}
+
 	gtk_file_chooser_set_extra_widget( GTK_FILE_CHOOSER( m_pDialog ), m_pVBox );
 
 	// Setup special flags
@@ -1685,34 +1717,44 @@ uno::Sequence<rtl::OUString> SAL_CALL Sa
 //-------------------------------------------------
 void SalGtkFilePicker::SetCurFilter( const OUString& rFilter )
 {
-	// Get all the filters already added
-	GSList *filters = gtk_file_chooser_list_filters ( GTK_FILE_CHOOSER( m_pDialog ) );
-	bool bFound = false;
-
-	while( ( !bFound ) && ( NULL != filters ) )
-	{
-		GtkFileFilter* pFilter = reinterpret_cast<GtkFileFilter *>( filters->data );
-		G_CONST_RETURN gchar * filtername = gtk_file_filter_get_name( pFilter );
-		OUString sFilterName( filtername, strlen( filtername ), RTL_TEXTENCODING_UTF8 );
+	OUString aShrunkName = shrinkFilterName( rFilter );
 
-		OUString aShrunkName = shrinkFilterName( rFilter );
-		if( aShrunkName.equals( sFilterName) )
+	if( m_pFilterComboBox )
+	{
+		gint nFilterPos = 0;
+		for     (       FilterList::iterator aListIter = m_pFilterList->begin();
+				aListIter != m_pFilterList->end();
+				++aListIter, ++nFilterPos
+			)
 		{
-			OSL_TRACE( "actually setting %s\n", filtername );
-			gtk_file_chooser_set_filter( GTK_FILE_CHOOSER( m_pDialog ), pFilter );
-			bFound = true;
+			if ( aShrunkName.equals( aListIter->getTitle() ) )
+			{
+				gtk_combo_box_set_active( GTK_COMBO_BOX( m_pFilterComboBox ), nFilterPos );
+				break;
+			}
 		}
+	}
+	else
+	{
+		// Get all the filters already added
+		GSList *filters = gtk_file_chooser_list_filters ( GTK_FILE_CHOOSER( m_pDialog ) );
+		bool bFound = false;
 
-		// Free the node
-		g_object_ref( pFilter ); 
-		gtk_object_sink( GTK_OBJECT( pFilter ) );
-		g_object_unref( pFilter );
+		for( GSList *iter = filters; !bFound && iter; iter = iter->next )
+		{
+			GtkFileFilter* pFilter = reinterpret_cast<GtkFileFilter *>( iter->data );
+			G_CONST_RETURN gchar * filtername = gtk_file_filter_get_name( pFilter );
+			OUString sFilterName( filtername, strlen( filtername ), RTL_TEXTENCODING_UTF8 );
 
-		//    g_free(filters->data); 
-		filters = g_slist_next( filters );
+			if( aShrunkName.equals( sFilterName) )
+			{
+				OSL_TRACE( "actually setting %s\n", filtername );
+				gtk_file_chooser_set_filter( GTK_FILE_CHOOSER( m_pDialog ), pFilter );
+				bFound = true;
+			}
+		}
+		g_slist_free( filters );
 	}
-
-	g_slist_free( filters );
 }
 
 void SalGtkFilePicker::implAddFilter( const OUString& rFilter, const OUString& rType )
@@ -1741,7 +1783,10 @@ void SalGtkFilePicker::implAddFilter( co
 		while( nIndex >= 0 );
 	}
 
-	gtk_file_chooser_add_filter( GTK_FILE_CHOOSER( m_pDialog ), filter );
+	if( m_pFilterComboBox )
+		gtk_combo_box_append_text( GTK_COMBO_BOX( m_pFilterComboBox ), aFilterName );
+	else
+		gtk_file_chooser_add_filter( GTK_FILE_CHOOSER( m_pDialog ), filter );
 }
 
 void SalGtkFilePicker::implAddFilterGroup( const OUString& _rFilter, const Sequence< StringPair >& _rFilters )
@@ -1782,6 +1827,8 @@ void SalGtkFilePicker::SetFilters()
 		}
 	}
 
+	if( m_pFilterComboBox )
+		gtk_combo_box_set_active( GTK_COMBO_BOX( m_pFilterComboBox ), 0 );
 
 	// set the default filter
 	if( m_aCurrentFilter && (m_aCurrentFilter.getLength() > 0) )
@@ -1814,6 +1861,9 @@ SalGtkFilePicker::~SalGtkFilePicker()
 
 	delete m_pFilterList;
 
+	if( m_pFilterComboBox )
+		gtk_widget_destroy( m_pFilterComboBox );
+
 	gtk_widget_destroy( m_pVBox );
 }
 
--- fpicker/source/unx/gnome/SalGtkFilePicker.hxx	2005-02-14 10:39:22.700342320 +0530
+++ fpicker/source/unx/gnome/SalGtkFilePicker.hxx	2005-02-14 10:42:21.217193172 +0530
@@ -324,6 +324,7 @@ class SalGtkFilePicker : 
 		SalGtkAsyncEventNotifier m_aAsyncEventNotifier;
 		FilterList *m_pFilterList;
 		GtkWidget  *m_pVBox;
+		GtkWidget  *m_pFilterComboBox;
 
 		enum { 
 			AUTOEXTENSION,
