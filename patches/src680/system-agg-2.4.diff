Index: config_office/configure.in
===================================================================
RCS file: /cvs/tools/config_office/configure.in,v
retrieving revision 1.166.2.12
diff -u -u -r1.166.2.12 configure.in
--- config_office/configure.in	10 Jul 2006 14:08:17 -0000	1.166.2.12
+++ config_office/configure.in	10 Jul 2006 22:38:51 -0000
@@ -3648,14 +3648,18 @@
    test "$with_system_agg" != "no"; then
          AC_MSG_RESULT([external])
          PKG_CHECK_MODULES(AGG, libagg >= 2.3)
-         PKG_CHECK_MODULES(AGG, libagg < 2.4, , AC_MSG_ERROR([you need agg 2.3 for system-agg]))
+         AC_MSG_CHECKING([agg version])
+         AC_EGREP_HEADER(Version 2.4, platform/agg_platform_support.h,
+            [AC_MSG_RESULT([2.4]); AGG_VERSION=2400], [AC_MSG_RESULT([2.3]); AGG_VERSION=2300])
          SYSTEM_AGG=YES
 else
          AC_MSG_RESULT([internal])
          SYSTEM_AGG=NO
+         AGG_VERSION=2300
          BUILD_TYPE="$BUILD_TYPE AGG"
 fi
 AC_SUBST(SYSTEM_AGG)
+AC_SUBST(AGG_VERSION)
 
 dnl ===================================================================
 dnl Check for system myspell
Index: config_office/set_soenv.in
===================================================================
RCS file: /cvs/tools/config_office/set_soenv.in,v
retrieving revision 1.105.2.5
diff -u -u -r1.105.2.5 set_soenv.in
--- config_office/set_soenv.in	10 Jul 2006 14:08:23 -0000	1.105.2.5
+++ config_office/set_soenv.in	10 Jul 2006 22:38:52 -0000
@@ -1775,6 +1775,7 @@
 ToFile( "NEON_CFLAGS",       "@NEON_CFLAGS@",      "e" );
 ToFile( "DISABLE_NEON",      "@DISABLE_NEON@",     "e" );
 ToFile( "SYSTEM_AGG",	     "@SYSTEM_AGG@",       "e" );
+ToFile( "AGG_VERSION",	     "@AGG_VERSION@",      "e" );
 ToFile( "BUILD_DMAKE",       "@BUILD_DMAKE@",      "e" );
 ToFile( "USE_XINERAMA",      "@USE_XINERAMA@",     "e" );
 ToFile( "XINERAMA_LINK",     "@XINERAMA_LINK@",    "e" );
Index: canvas/source/tools/image.cxx
===================================================================
RCS file: /cvs/gsl/canvas/source/tools/image.cxx,v
retrieving revision 1.5
diff -u -u -r1.5 image.cxx
--- canvas/source/tools/image.cxx	20 Jun 2006 02:17:33 -0000	1.5
+++ canvas/source/tools/image.cxx	10 Jul 2006 22:38:52 -0000
@@ -1107,7 +1107,11 @@
 // cachedPrimitiveFTPP [cachedPrimitive for [F]ill[T]extured[P]oly[P]olygon]
 //////////////////////////////////////////////////////////////////////////////////
 
+#if AGG_VERSION >= 2400
+template<class pixel_format_dst,class span_gen_type>
+#else
 template<class pixel_format,class span_gen_type>
+#endif
 class cachedPrimitiveFTPP : public ImageCachedPrimitive
 {
 	public:
@@ -1119,10 +1123,19 @@
 			aTransform(rTransform),
 			inter(tm),
 			filter(filter_kernel),
+#if AGG_VERSION >= 2400
+                        pixs(const_cast<agg::rendering_buffer&>(src)),
+                        source(pixs),
+                        sg(source,inter,filter),
+                        pixd(dst),
+                        rb(pixd),
+                        ren(rb,sa,sg)
+#else
 			sg(sa,src,inter,filter),
 			pixf(dst),
 			rb(pixf),
 			ren(rb,sg)
+#endif
 		{
 			::basegfx::B2DHomMatrix aFinalTransform(aTransform);
 			aFinalTransform *= rViewTransform;
@@ -1153,17 +1166,35 @@
 
 	private:
 
+#if AGG_VERSION >= 2400
+                typedef agg::renderer_base<pixel_format_dst> renderer_base;
+                typedef agg::span_allocator< typename span_gen_type::color_type > span_alloc_type;
+                typedef agg::renderer_scanline_aa<renderer_base, span_alloc_type, span_gen_type> renderer_type;
+                typedef typename span_gen_type::source_type source_type;
+                typedef typename span_gen_type::source_type::pixfmt_type pixel_format_src;
+#else
 		typedef agg::span_interpolator_linear<> interpolator_type;
 		typedef agg::renderer_base<pixel_format> renderer_base;
 		typedef agg::renderer_scanline_aa<renderer_base, span_gen_type> renderer_type;
+#endif
 
 		::basegfx::B2DHomMatrix aTransform;
 		interpolator_type inter;
 		agg::image_filter_bilinear filter_kernel;
 		agg::image_filter_lut filter;
+#if AGG_VERSION >= 2400
+                span_alloc_type sa;
+                pixel_format_src pixs;
+                source_type source;
+#else
 		agg::span_allocator< typename span_gen_type::color_type > sa;
+#endif
 		span_gen_type sg;
+#if AGG_VERSION >= 2400
+		pixel_format_dst pixd;
+#else
 		pixel_format pixf;
+#endif
 		renderer_base rb;
 		mutable renderer_type ren;
 		mutable agg::scanline_p8 sl;
@@ -1376,7 +1407,14 @@
 	typedef agg::wrap_mode_repeat wrap_y_type;
 	typedef agg::pixfmt_rgb24 pixfmt_rgb24;
 	typedef agg::pixfmt_rgba32 pixfmt_rgba32;
-	typedef agg::span_pattern_resample_rgba_affine<	pixfmt_rgba32::color_type,
+#if AGG_VERSION >= 2400
+        typedef agg::image_accessor_wrap< pixfmt_rgba32, wrap_x_type, wrap_y_type > img_source_type_rgba;
+        typedef agg::image_accessor_wrap< pixfmt_rgb24, wrap_x_type, wrap_y_type > img_source_type_rgb;
+ 
+        typedef agg::span_image_resample_rgba_affine< img_source_type_rgba > span_gen_type_rgba;
+        typedef agg::span_image_resample_rgb_affine< img_source_type_rgb > span_gen_type_rgb;
+#else
+	typedef agg::span_pattern_resample_rgba_affine<	pixfmt_rgba32::color_typ
 													pixfmt_rgba32::order_type,
 													wrap_x_type,
 													wrap_y_type> span_gen_type_rgba;
@@ -1384,6 +1422,7 @@
 													pixfmt_rgb24::order_type,
 													wrap_x_type,
 													wrap_y_type> span_gen_type_rgb;
+#endif
 
 	const Format nDest = maDesc.eFormat;
 	const Format nSource = rTexture.maDesc.eFormat;
@@ -1533,13 +1572,20 @@
 	typedef agg::span_gradient<color_type,
 							interpolator_type,
 							gradient_polymorphic_wrapper_base,
-							color_generator_type > gradient_span_gen;
+#if AGG_VERSION >= 2400
+	gradient_span_gen span_gen(inter,
+                               *gf[rValues.meType],
+                               colors,
+                               0,
+                               dwNumSteps);
+#else							color_generator_type > gradient_span_gen;
 	gradient_span_gen span_gen(span_alloc,
                                inter,
                                *gf[rValues.meType],
                                colors,
                                0,
                                dwNumSteps);
+#endif
 
 	// To draw Anti-Aliased primitives one shoud *rasterize* them first.
 	// The primary rasterization technique in AGG is scanline based.
@@ -1555,8 +1601,13 @@
 	// [in contrast to solid renderers, that is]
 	// the instance of this particular renderer combines the
 	// renderbuffer [i.e. destination] and the spanline generator [i.e. source]
+#if AGG_VERSION >= 2400
+        typedef agg::renderer_scanline_aa<renderer_base, gradient_span_alloc, gradient_span_gen> renderer_gradient;
+        renderer_gradient r1(rb, span_alloc, span_gen);
+#else
 	typedef agg::renderer_scanline_aa<renderer_base, gradient_span_gen> renderer_gradient;
 	renderer_gradient r1(rb, span_gen);
+#endif
 
 	// instantiate the rasterizer and feed the incoming polypolygon.
 	agg::rasterizer_scanline_aa<> ras;
Index: canvas/source/tools/image_sysprereq.h
===================================================================
RCS file: /cvs/gsl/canvas/source/tools/image_sysprereq.h,v
retrieving revision 1.2
diff -u -u -r1.2 image_sysprereq.h
--- canvas/source/tools/image_sysprereq.h	20 Jun 2006 02:17:54 -0000	1.2
+++ canvas/source/tools/image_sysprereq.h	10 Jul 2006 22:38:52 -0000
@@ -62,15 +62,30 @@
 #include <agg2/agg_renderer_outline_aa.h>
 #include <agg2/agg_renderer_primitives.h>
 #include <agg2/agg_path_storage.h>
+#if AGG_VERSION == 2300
 #include <agg2/agg_span_pattern.h>
+#endif
 #include <agg2/agg_span_pattern_rgba.h>
+#if AGG_VERSION >= 2400
+#include <agg2/agg_span_image_filter_rgb.h>
+#include <agg2/agg_span_image_filter_rgba.h>
+#else
 #include <agg2/agg_span_pattern_resample_rgb.h>
 #include <agg2/agg_span_pattern_resample_rgba.h>
+#endif
 #include <agg2/agg_span_interpolator_linear.h>
 #include <agg2/agg_span_gradient.h>
+#if AGG_VERSION == 2300
 #include <agg2/agg_span_image_resample_rgb.h>
 #include <agg2/agg_span_image_resample_rgba.h>
+#endif
+#if AGG_VERSION >= 2400
+#include <agg2/agg_span_allocator.h>
+#endif
 #include <agg2/agg_image_filters.h>
+#if AGG_VERSION >= 2400
+#include <agg2/agg_image_accessors.h>
+#endif
 #include <agg2/agg_dda_line.h>
 #include <agg2/agg_scanline_storage_aa.h>
 #include <agg2/agg_scanline_storage_bin.h>
Index: canvas/source/tools/makefile.mk
===================================================================
RCS file: /cvs/gsl/canvas/source/tools/makefile.mk,v
retrieving revision 1.7
diff -u -u -r1.7 makefile.mk
--- canvas/source/tools/makefile.mk	3 Nov 2005 17:26:37 -0000	1.7
+++ canvas/source/tools/makefile.mk	10 Jul 2006 22:38:52 -0000
@@ -52,6 +52,8 @@
 CDEFS+= -DPROFILER
 .ENDIF
 
+CDEFS+=-DAGG_VERSION=$(AGG_VERSION)
+
 #CFLAGS +:= /Ox /Ot					# THIS IS IMPORTANT
 
 
