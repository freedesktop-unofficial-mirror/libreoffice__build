Index: instsetoo_native/inc_openoffice/unix/shellscripts_extensions.txt
===================================================================
RCS file: /cvs/installation/instsetoo_native/inc_openoffice/unix/shellscripts_extensions.txt,v
retrieving revision 1.2
retrieving revision 1.2.94.6
diff -u -u -p -r1.2 -r1.2.94.6
--- instsetoo_native/inc_openoffice/unix/shellscripts_extensions.txt	27 Oct 2006 12:09:12 -0000	1.2
+++ instsetoo_native/inc_openoffice/unix/shellscripts_extensions.txt	3 Aug 2007 11:13:37 -0000	1.2.94.6
@@ -12,11 +12,36 @@ if [ "$$platform" = "Linux" ]; then
   then
     ISUPDATE=1
   fi
-
+  
   # remove only, if this is an update  
   if [ "$$ISUPDATE" = "1" ]; then
+    #Find the temp dir, in which we will create a temporary directory
+    if [ -n "$$TMPDIR" ]; then
+      UNOPKGTMP="$$TMPDIR"
+    elif [ -n "$$TMP" ]; then
+      UNOPKGTMP="$$TMP"
+    elif [ -d "/tmp" ]; then
+      UNOPKGTMP="/tmp"
+    else
+      echo "No tmp directory found!"
+      exit 1
+    fi
+
+    #Create a temporary directory which will be used as UserInstallation for unopkg
+    if [ -x "/bin/mktemp" ]; then
+      INSTDIR=`"/bin/mktemp" -d "$${UNOPKGTMP}/userinstall.XXXXXX"`
+    else
+      INSTDIR="$${UNOPKGTMP}/userinstall.$$$$"
+      mkdir "$$INSTDIR"
+    fi
+
     PRODUCTINSTALLLOCATION="$$RPM_INSTALL_PREFIX"
-    $$PRODUCTINSTALLLOCATION/PRODUCTDIRECTORYNAME/program/unopkg remove --shared ${OXTFILENAME}
+    if [ -x "$$PRODUCTINSTALLLOCATION/PRODUCTDIRECTORYNAME/program/unopkg" ]; then
+      $$PRODUCTINSTALLLOCATION/PRODUCTDIRECTORYNAME/program/unopkg remove --shared "${OXTFILENAME}" "-env:UserInstallation=file://////$$INSTDIR" "-env:UNO_JAVA_JFW_INSTALL_DATA=\$$ORIGIN/../share/config/javasettingsunopkginstall.xml"
+      if [ -n "$$INSTDIR" ]; then
+        rm -rf "$$INSTDIR"
+      fi
+    fi
   fi
 fi
 
@@ -30,8 +55,35 @@ END
 platform=`uname -s`
 
 if [ "$$platform" = "Linux" ]; then
+  #Find the temp dir, in which we will create a temporary directory
+  if [ -n "$$TMPDIR" ]; then
+    UNOPKGTMP="$$TMPDIR"
+  elif [ -n "$$TMP" ]; then
+    UNOPKGTMP="$$TMP"
+  elif [ -d "/tmp" ]; then
+    UNOPKGTMP="/tmp"
+  else
+    echo "No tmp directory found!"
+    exit 1
+  fi
+
+  #Create a temporary directory which will be used as UserInstallation for unopkg
+  if [ -x "/bin/mktemp" ]; then
+    INSTDIR=`"/bin/mktemp" -d "$${UNOPKGTMP}/userinstall.XXXXXX"`
+  else
+    INSTDIR="$${UNOPKGTMP}/userinstall.$$$$"
+    mkdir "$$INSTDIR"
+  fi
+
   PRODUCTINSTALLLOCATION="$$RPM_INSTALL_PREFIX"
-  $$PRODUCTINSTALLLOCATION/PRODUCTDIRECTORYNAME/program/unopkg add --shared $$PRODUCTINSTALLLOCATION/PRODUCTDIRECTORYNAME/share/extension/install/${OXTFILENAME}
+  if [ -x "$$PRODUCTINSTALLLOCATION/PRODUCTDIRECTORYNAME/program/unopkg" ]; then
+    $$PRODUCTINSTALLLOCATION/PRODUCTDIRECTORYNAME/program/unopkg add --shared "$$PRODUCTINSTALLLOCATION/PRODUCTDIRECTORYNAME/share/extension/install/${OXTFILENAME}" "-env:UserInstallation=file://////$$INSTDIR" "-env:UNO_JAVA_JFW_INSTALL_DATA=\$$ORIGIN/../share/config/javasettingsunopkginstall.xml"
+
+    if [ -n "$$INSTDIR" ]; then
+      rm -rf "$$INSTDIR"
+    fi
+
+  fi
 fi
 
 if [ "$$platform" = "SunOS" ]; then
@@ -58,8 +110,35 @@ if [ "$$platform" = "Linux" ]; then
   
   # remove only, if this is no update
   if [ "$$ISUPDATE" = "0" ]; then 
+    #Find the temp dir, in which we will create a temporary directory
+    if [ -n "$$TMPDIR" ]; then
+      UNOPKGTMP="$$TMPDIR"
+    elif [ -n "$$TMP" ]; then
+      UNOPKGTMP="$$TMP"
+    elif [ -d "/tmp" ]; then
+      UNOPKGTMP="/tmp"
+    else
+      echo "No tmp directory found!"
+      exit 1
+    fi
+
+    #Create a temporary directory which will be used as UserInstallation for unopkg
+    if [ -x "/bin/mktemp" ]; then
+      INSTDIR=`"/bin/mktemp" -d "$${UNOPKGTMP}/userinstall.XXXXXX"`
+    else
+      INSTDIR="$${UNOPKGTMP}/userinstall.$$$$"
+      mkdir "$$INSTDIR"
+    fi
+
     PRODUCTINSTALLLOCATION="$$RPM_INSTALL_PREFIX"
-    $$PRODUCTINSTALLLOCATION/PRODUCTDIRECTORYNAME/program/unopkg remove --shared ${OXTFILENAME}
+    if [ -x "$$PRODUCTINSTALLLOCATION/PRODUCTDIRECTORYNAME/program/unopkg" ]; then
+      $$PRODUCTINSTALLLOCATION/PRODUCTDIRECTORYNAME/program/unopkg remove --shared "${OXTFILENAME}" "-env:UserInstallation=file://////$$INSTDIR" "-env:UNO_JAVA_JFW_INSTALL_DATA=\$$ORIGIN/../share/config/javasettingsunopkginstall.xml"
+
+      if [ -n "$$INSTDIR" ]; then
+        rm -rf "$$INSTDIR"
+      fi 
+
+    fi
   fi
 fi
 
Index: setup_native/scripts/install_solaris.sh
===================================================================
RCS file: /cvs/installation/setup_native/scripts/install_solaris.sh,v
retrieving revision 1.18
retrieving revision 1.18.2.1
diff -u -u -p -r1.18 -r1.18.2.1
--- setup_native/scripts/install_solaris.sh	19 Jul 2007 07:17:38 -0000	1.18
+++ setup_native/scripts/install_solaris.sh	26 Jul 2007 07:40:16 -0000	1.18.2.1
@@ -232,7 +232,7 @@ export UserInstallation
 
 if [ -x /usr/bin/mktemp ]
 then
-  CMD=`/usr/bin/mktemp /tmp/userinstall.XXXXXX`
+  CMD=\`/usr/bin/mktemp /tmp/userinstall.XXXXXX\`
 else
   CMD=/tmp/userinstall.\$\$; echo "" > \$CMD
 fi
Index: setup_native/source/win32/customactions/patch/makefile.mk
===================================================================
RCS file: /cvs/installation/setup_native/source/win32/customactions/patch/makefile.mk,v
retrieving revision 1.13
retrieving revision 1.13.2.1
diff -u -u -p -r1.13 -r1.13.2.1
--- setup_native/source/win32/customactions/patch/makefile.mk	17 Jul 2007 07:25:46 -0000	1.13
+++ setup_native/source/win32/customactions/patch/makefile.mk	23 Jul 2007 13:50:17 -0000	1.13.2.1
@@ -63,7 +63,8 @@ SLOFILES = \
 STDSHL += \
 	$(ADVAPI32LIB)\
 	$(MSILIB)\
-	$(LIBSTLPORTST)								
+	$(LIBSTLPORTST) \
+        $(SHELL32LIB)								
 
 .IF "$(COM)"=="GCC"
 STDSHL+=	\
Index: setup_native/source/win32/customactions/shellextensions/makefile.mk
===================================================================
RCS file: /cvs/installation/setup_native/source/win32/customactions/shellextensions/makefile.mk,v
retrieving revision 1.12
retrieving revision 1.12.4.1
diff -u -u -p -r1.12 -r1.12.4.1
--- setup_native/source/win32/customactions/shellextensions/makefile.mk	6 Jul 2007 12:17:34 -0000	1.12
+++ setup_native/source/win32/customactions/shellextensions/makefile.mk	20 Jul 2007 15:38:59 -0000	1.12.4.1
@@ -71,7 +71,8 @@ SLOFILES = \
 STDSHL += \
 	$(ADVAPI32LIB)\
 	$(MSILIB)\
-	$(LIBSTLPORTST)								
+	$(LIBSTLPORTST)\
+        $(SHELL32LIB)								
 
 .IF "$(COM)"=="GCC"
 STDSHL+=	\
Index: setup_native/source/win32/customactions/shellextensions/registerextensions.cxx
===================================================================
RCS file: /cvs/installation/setup_native/source/win32/customactions/shellextensions/registerextensions.cxx,v
retrieving revision 1.5
retrieving revision 1.5.4.2
diff -u -u -p -r1.5 -r1.5.4.2
--- setup_native/source/win32/customactions/shellextensions/registerextensions.cxx	6 Jul 2007 12:17:47 -0000	1.5
+++ setup_native/source/win32/customactions/shellextensions/registerextensions.cxx	20 Jul 2007 15:39:00 -0000	1.5.4.2
@@ -42,6 +42,7 @@
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
 #include <msiquery.h>
+#include <shellapi.h>
 #pragma warning(pop)
 
 #include <malloc.h>
@@ -57,6 +58,119 @@
 #include <tchar.h>
 #include <string>
 
+/** creates a temporary folder with a unique name.
+
+    The returned string is a file URL.
+*/
+static std::_tstring createTempFolder()
+{
+    BOOL bExist = FALSE;
+    TCHAR szTempName[MAX_PATH]; 
+    do
+    {
+        bExist = FALSE;
+        // Get the temp path.
+        TCHAR lpPathBuffer[MAX_PATH];
+        DWORD dwRetVal = GetTempPath(MAX_PATH, lpPathBuffer);
+        if (dwRetVal > MAX_PATH || (dwRetVal == 0))
+        {
+            //fprintf (stderr, "GetTempPath failed with error %d.\n", GetLastError());
+            return TEXT("");
+        }          
+        // Create a temporary file.
+        UINT uRetVal = GetTempFileName(lpPathBuffer, // directory for tmp files
+                                       "upg",        // temp file name prefix 
+                                       0,            // create unique name 
+                                       szTempName);  // buffer for name 
+        if (uRetVal == 0)
+        {
+            //fprintf (stderr, "GetTempFileName failed with error %d.\n", GetLastError());
+            return TEXT("");
+        }
+        //Delete the file
+        BOOL bDel = DeleteFile(szTempName);    
+        if (FALSE == bDel)
+        {
+            //fprintf(stderr, "Could not delete temp file. Error %d.\n", GetLastError());
+            return TEXT("");
+        }
+        // Create the directory
+        BOOL bDir = CreateDirectory(szTempName, NULL);
+        if (FALSE == bDir)
+        {
+            DWORD error =GetLastError();
+            if (ERROR_ALREADY_EXISTS == error)
+            {
+                bExist = TRUE;
+            }
+            else
+            {
+                //fprintf(stderr, "CreateDirectory failed with error %d.\n", error);
+                return TEXT("");
+            }
+        }
+    } while(bExist);
+    
+    std::_tstring cur(szTempName);
+    //make a file URL from the path
+    std::_tstring ret(TEXT("file:///"));
+    for (std::_tstring::iterator i = cur.begin(); i != cur.end(); i++)
+    {
+        if (*i == '\\')
+            ret.append(TEXT("/"));
+        else
+            ret.push_back(*i);
+    }
+//    MessageBox(NULL, ret.c_str(), "createTempFolder", MB_OK);
+    return ret.c_str();
+}
+
+/** deletes the temporary folder.
+    The argument must be a file URL.
+*/
+static void deleteTempFolder(const std::_tstring& sTempFolder)
+{
+    if (sTempFolder.size() == 0)
+        return;
+    //convert the file URL to a path
+    const std::_tstring path(sTempFolder.substr(8));
+    std::_tstring path2;
+//    MessageBox(NULL, path.c_str(), "del1", MB_OK);        
+    for (std::_tstring::const_iterator i = path.begin(); i != path.end(); i++)
+    {
+        if (*i == '/')
+            path2.append(TEXT("\\"));
+        else
+            path2.push_back(*i);
+    }
+
+    //We need a null terminated string with two nulls in the end
+    //for the SHFILEOPSTRUCT
+    const TCHAR * szTemp = path2.c_str();
+    size_t size = path2.size();
+    TCHAR * szTemp2 = new TCHAR[size + 2];
+    ZeroMemory(szTemp2, (size + 2) * sizeof(TCHAR));
+    memcpy(szTemp2, szTemp, size * sizeof(TCHAR));   
+    
+//    MessageBox(NULL, szTemp2, "del3", MB_OK);
+    SHFILEOPSTRUCT operation = 
+        {
+            NULL,
+            FO_DELETE,
+            szTemp2, 
+            NULL,
+            FOF_SILENT | FOF_NOCONFIRMATION | FOF_NOERRORUI | FOF_NOCONFIRMMKDIR,
+            FALSE,
+            NULL,
+            NULL
+        };
+
+    SHFileOperation( &operation);
+    delete [] szTemp2;
+}
+
+
+
 static std::_tstring GetMsiProperty( MSIHANDLE handle, const std::_tstring& sProperty )
 {
     std::_tstring result;
@@ -225,13 +339,18 @@ extern "C" UINT __stdcall RegisterExtens
 
             do
             {
+                const std::_tstring sTempFolder(createTempFolder());
                 std::_tstring sOxtFile = sShareInstallDir + aFindFileData.cFileName;
-                std::_tstring sCommand = sUnoPkgFile + " add --shared " + "\"" + sOxtFile + "\"";
+                std::_tstring sCommand = sUnoPkgFile + " add --shared " + "\"" + sOxtFile + "\"" + 
+                    TEXT(" -env:UNO_JAVA_JFW_INSTALL_DATA=$ORIGIN/../share/config/javasettingsunopkginstall.xml") +
+                    TEXT(" -env:UserInstallation=") + sTempFolder;
 
+                
                 mystr = "Command: " + sCommand;
-                // MessageBox(NULL, mystr.c_str(), "Command", MB_OK);
+                //MessageBox(NULL, mystr.c_str(), "Command", MB_OK);
 
                 bool fSuccess = ExecuteCommand( sCommand.c_str(), TRUE );
+                deleteTempFolder(sTempFolder);
                 
                 if ( fSuccess )
                 {
@@ -324,16 +443,20 @@ extern "C" UINT __stdcall DeregisterExte
 
             do
             {
+                const std::_tstring sTempFolder(createTempFolder());
                 // When removing extensions, only the oxt file name is required, without path
                 // Therefore no quoting is required
                 // std::_tstring sOxtFile = sShareInstallDir + aFindFileData.cFileName;
                 std::_tstring sOxtFile = aFindFileData.cFileName;
-                std::_tstring sCommand = sUnoPkgFile + " remove --shared " + "\"" + sOxtFile + "\"";
+                std::_tstring sCommand = sUnoPkgFile + " remove --shared " + "\"" + sOxtFile + "\"" + 
+                    TEXT(" -env:UNO_JAVA_JFW_INSTALL_DATA=$ORIGIN/../share/config/javasettingsunopkginstall.xml") +
+                    TEXT(" -env:UserInstallation=") + sTempFolder;
 
                 mystr = "Command: " + sCommand;
-                // MessageBox(NULL, mystr.c_str(), "Command", MB_OK);
+                //MessageBox(NULL, mystr.c_str(), "Command", MB_OK);
 
                 bool fSuccess = ExecuteCommand( sCommand.c_str(), TRUE );
+                deleteTempFolder(sTempFolder);
                 
                 if ( fSuccess )
                 {
Index: jvmfwk/prj/d.lst
===================================================================
RCS file: /cvs/udk/jvmfwk/prj/d.lst,v
retrieving revision 1.17
retrieving revision 1.17.92.1
diff -u -u -p -r1.17 -r1.17.92.1
--- jvmfwk/prj/d.lst	17 Jun 2005 10:12:01 -0000	1.17
+++ jvmfwk/prj/d.lst	17 Jul 2007 11:41:18 -0000	1.17.92.1
@@ -12,6 +12,7 @@ mkdir: %_DEST%\bin%_EXT%\ure
 ..\%__SRC%\class\JREProperties.class  %_DEST%\lib%_EXT%\JREProperties.class
 ..\%__SRC%\bin\javaldx %_DEST%\bin%_EXT%\javaldx
 ..\source\javasettings.xml %_DEST%\bin%_EXT%\javasettings.xml
+..\source\javasettingsunopkginstall.xml %_DEST%\bin%_EXT%\javasettingsunopkginstall.xml
 ..\%__SRC%\bin\javavendors_so.xml %_DEST%\bin%_EXT%\so\javavendors.xml
 ..\%__SRC%\bin\javavendors_ooo.xml %_DEST%\bin%_EXT%\javavendors.xml
 ..\%__SRC%\bin\javavendors_ooo.xml %_DEST%\lib%_EXT%\javavendors.xml
cvs diff: Diffing jvmfwk/source
Index: jvmfwk/source/javasettingsunopkginstall.xml
===================================================================
RCS file: jvmfwk/source/javasettingsunopkginstall.xml
diff -N jvmfwk/source/javasettingsunopkginstall.xml
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ jvmfwk/source/javasettingsunopkginstall.xml	16 Jul 2007 14:10:48 -0000	1.1.2.1
@@ -0,0 +1,3 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<java xmlns="http://openoffice.org/2004/java/framework/1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
+</java>
Index: jvmfwk/source/readme.txt
===================================================================
RCS file: /cvs/udk/jvmfwk/source/readme.txt,v
retrieving revision 1.2
retrieving revision 1.2.122.1
diff -u -u -p -r1.2 -r1.2.122.1
--- jvmfwk/source/readme.txt	9 Nov 2004 14:02:18 -0000	1.2
+++ jvmfwk/source/readme.txt	16 Jul 2007 14:11:21 -0000	1.2.122.1
@@ -1,4 +1,9 @@
 The file jvfwk3rc is intended for providing bootstrap parameter for the java 
 framework within the build environment. It is not part of a product. Tools 
 which are started in the environment, such as regcomp.exe and uno.exe, use
-this rc file when Java is needed. 
\ No newline at end of file
+this rc file when Java is needed. 
+
+The file javasettingsunopkginstall.xml only contains the root element of 
+a settings file (<java ...>). It is a dummy which will be installed into
+office/share/config/. Bundled extensions will used this file to store its
+java settings. See framework.h bootstrap variable UNO_JAVA_JFW_INSTALL_DATA
Index: sal/osl/unx/module.c
===================================================================
RCS file: /cvs/porting/sal/osl/unx/module.c,v
retrieving revision 1.35
retrieving revision 1.35.14.1
diff -u -u -p -r1.35 -r1.35.14.1
--- sal/osl/unx/module.c	3 Jul 2007 12:48:42 -0000	1.35
+++ sal/osl/unx/module.c	3 Aug 2007 11:34:09 -0000	1.35.14.1
@@ -278,22 +278,28 @@ sal_Bool SAL_CALL osl_getModuleURLFromAd
 	{
 		rtl_uString * workDir = NULL;
 		osl_getProcessWorkingDir(&workDir);
-
+        if (workDir)
+        {
 #if OSL_DEBUG_LEVEL > 1
-		OSL_TRACE("module.c::osl_getModuleURLFromAddress - %s\n", dl_info.dli_fname);
+            OSL_TRACE("module.c::osl_getModuleURLFromAddress - %s\n", dl_info.dli_fname);
 #endif
-		rtl_string2UString(ppLibraryUrl, 
-						   dl_info.dli_fname, 
-						   strlen(dl_info.dli_fname), 
-						   osl_getThreadTextEncoding(), 
-						   OSTRING_TO_OUSTRING_CVTFLAGS);
-		
-        OSL_ASSERT(*ppLibraryUrl != NULL);
-		osl_getFileURLFromSystemPath(*ppLibraryUrl, ppLibraryUrl); 
-		osl_getAbsoluteFileURL(workDir, *ppLibraryUrl, ppLibraryUrl); 
-
-		rtl_uString_release(workDir);
-		result = sal_True;
+            rtl_string2UString(ppLibraryUrl, 
+                               dl_info.dli_fname, 
+                               strlen(dl_info.dli_fname), 
+                               osl_getThreadTextEncoding(), 
+                               OSTRING_TO_OUSTRING_CVTFLAGS);
+            
+            OSL_ASSERT(*ppLibraryUrl != NULL);
+            osl_getFileURLFromSystemPath(*ppLibraryUrl, ppLibraryUrl); 
+            osl_getAbsoluteFileURL(workDir, *ppLibraryUrl, ppLibraryUrl); 
+            
+            rtl_uString_release(workDir);
+            result = sal_True;
+        }
+        else
+        {
+            result = sal_False;
+        }
 	}
 	return result;
 }
Index: scp2/source/ooo/file_ooo.scp
===================================================================
RCS file: /cvs/installation/scp2/source/ooo/file_ooo.scp,v
retrieving revision 1.210
retrieving revision 1.205.20.3
diff -u -u -p -r1.210 -r1.205.20.3
--- scp2/source/ooo/file_ooo.scp	18 Jul 2007 07:18:13 -0000	1.210
+++ scp2/source/ooo/file_ooo.scp	23 Jul 2007 09:11:55 -0000	1.205.20.3
@@ -3325,3 +3325,10 @@ File gid_File_Bin_Fondu
     Styles = (PACKED);
 End
 #endif
+
+File gid_File_Config_Javasettingsunopkginstall
+    USER_FILE_BODY;
+    Dir = gid_Dir_Config;
+    Name = "javasettingsunopkginstall.xml";
+    Styles = (PACKED,PATCH);
+End
Index: scp2/source/ooo/module_hidden_ooo.scp
===================================================================
RCS file: /cvs/installation/scp2/source/ooo/module_hidden_ooo.scp,v
retrieving revision 1.70
retrieving revision 1.69.20.2
diff -u -u -p -r1.70 -r1.69.20.2
--- scp2/source/ooo/module_hidden_ooo.scp	19 Jul 2007 07:18:09 -0000	1.70
+++ scp2/source/ooo/module_hidden_ooo.scp	23 Jul 2007 09:12:12 -0000	1.69.20.2
@@ -106,7 +106,8 @@ Module gid_Module_Root_Files_2
 	gid_File_License_License_Html,
 	gid_File_Readme_Readme,
 	gid_File_Readme_Readme_Html,
-	gid_File_Html_Thirdpartylicensereadme);
+	gid_File_Html_Thirdpartylicensereadme,
+        gid_File_Config_Javasettingsunopkginstall);
 End
 
 Module gid_Module_Root_Files_3
Index: desktop/source/deployment/gui/dp_gui.h
===================================================================
RCS file: /cvs/framework/desktop/source/deployment/gui/dp_gui.h,v
retrieving revision 1.17
retrieving revision 1.17.8.1
diff -u -u -p -r1.17 -r1.17.8.1
--- desktop/source/deployment/gui/dp_gui.h	9 Jul 2007 09:39:33 -0000	1.17
+++ desktop/source/deployment/gui/dp_gui.h	13 Jul 2007 12:49:49 -0000	1.17.8.1
@@ -96,13 +96,19 @@ struct DialogImpl :
 
     struct SelectionBoxControl : public Control
     {
-        SelectionBoxControl( DialogImpl * dialog )
-            : Control( dialog, WB_BORDER | WB_TABSTOP ),
-              m_dialog(dialog)
-            {}
-        long Notify( NotifyEvent & rEvt );
+    public:    
 
-    private:
+        SelectionBoxControl( DialogImpl * dialog );
+
+        long Notify( NotifyEvent & rEvt );
+        
+        /* Signals that the dialog (DialogImpl) is about to be destroyed. 
+            In this case we must prevent to access members of the dialog,
+            which is the case in Notify. Notify may be called when the dialog
+            is being destructed.
+        */
+        bool m_bShutDown;
+    private:    
         DialogImpl * m_dialog;
     };
 
Index: desktop/source/deployment/gui/dp_gui_treelb.cxx
===================================================================
RCS file: /cvs/framework/desktop/source/deployment/gui/dp_gui_treelb.cxx,v
retrieving revision 1.19
retrieving revision 1.19.8.1
diff -u -u -p -r1.19 -r1.19.8.1
--- desktop/source/deployment/gui/dp_gui_treelb.cxx	6 Jul 2007 12:35:10 -0000	1.19
+++ desktop/source/deployment/gui/dp_gui_treelb.cxx	13 Jul 2007 12:49:49 -0000	1.19.8.1
@@ -371,12 +371,20 @@ DialogImpl::TreeListBoxImpl::~TreeListBo
 }
 
 //______________________________________________________________________________
+DialogImpl::SelectionBoxControl::SelectionBoxControl( DialogImpl * dialog )
+    : Control( dialog, WB_BORDER | WB_TABSTOP ),
+    m_bShutDown(false),
+    m_dialog(dialog)
+{
+}
+
 long DialogImpl::SelectionBoxControl::Notify( NotifyEvent & rEvt )
 {
     const long nRet = Control::Notify( rEvt );
     if (IsReallyVisible() &&
         rEvt.GetType() == EVENT_GETFOCUS &&
-		rEvt.GetWindow() != static_cast<Window *>(m_dialog->m_treelb.get()))
+		rEvt.GetWindow() != static_cast<Window *>(m_dialog->m_treelb.get())
+        && ! m_bShutDown)
     {
         m_dialog->m_treelb->GrabFocus();
     }
@@ -950,7 +958,10 @@ void DialogImpl::disposing( lang::EventO
             }
             
             if (shutDown)
+            {
+                m_selectionBox->m_bShutDown = true;
                 s_dialog.clear();
+            }
         }
         
         if (m_xTdocRoot.is()) {
@@ -975,6 +986,9 @@ void DialogImpl::queryTermination( lang:
 void DialogImpl::notifyTermination( lang::EventObject const & evt )
     throw (RuntimeException)
 {
+   if (m_updatability.get() != NULL)
+        m_updatability->stop();
+
     disposing( evt );
 }
 
Index: desktop/source/deployment/registry/component/dp_component.cxx
===================================================================
RCS file: /cvs/framework/desktop/source/deployment/registry/component/dp_component.cxx,v
retrieving revision 1.18
retrieving revision 1.18.42.1
diff -u -u -p -r1.18 -r1.18.42.1
--- desktop/source/deployment/registry/component/dp_component.cxx	13 Jun 2007 07:59:29 -0000	1.18
+++ desktop/source/deployment/registry/component/dp_component.cxx	16 Jul 2007 12:27:20 -0000	1.18.42.1
@@ -81,6 +81,23 @@ namespace {
 typedef ::std::list<OUString> t_stringlist;
 typedef ::std::vector< ::std::pair<OUString, OUString> > t_stringpairvec;
 
+/** return a vector of bootstrap variables which have been provided
+    as command arguments.
+*/
+::std::vector<OUString> getCmdBootstrapVariables()
+{
+    ::std::vector<OUString> ret;
+    sal_uInt32 count = osl_getCommandArgCount();
+    for (sal_uInt32 i = 0; i < count; i++)
+    {
+        OUString arg;
+        osl_getCommandArg(i, &arg.pData);
+        if (arg.matchAsciiL("-env:", 5))
+            ret.push_back(arg);
+    }
+    return ret; 
+}
+
 bool jarManifestHeaderPresent(
     OUString const & url, OUString const & name,
     Reference<XCommandEnvironment> const & xCmdEnv )
@@ -885,6 +902,10 @@ Reference<XComponentContext> raise_uno_p
     args.push_back( buf.makeStringAndClear() );
     // don't inherit from unorc:
     args.push_back( OUSTR("-env:INIFILENAME=") );
+
+    //now add the bootstrap variables which were supplied on the command line
+    ::std::vector<OUString> bootvars = getCmdBootstrapVariables();
+    args.insert(args.end(), bootvars.begin(), bootvars.end());
     
     oslProcess hProcess = raiseProcess(
         ProgramDir::get() + OUSTR("/uno"),
Index: desktop/source/pkgchk/unopkg/unopkg_app.cxx
===================================================================
RCS file: /cvs/framework/desktop/source/pkgchk/unopkg/unopkg_app.cxx,v
retrieving revision 1.6
retrieving revision 1.6.70.4
diff -u -u -p -r1.6 -r1.6.70.4
--- desktop/source/pkgchk/unopkg/unopkg_app.cxx	17 Apr 2007 10:32:57 -0000	1.6
+++ desktop/source/pkgchk/unopkg/unopkg_app.cxx	3 Aug 2007 15:40:59 -0000	1.6.70.4
@@ -51,9 +51,10 @@
 #include "com/sun/star/deployment/thePackageManagerFactory.hpp"
 #include "com/sun/star/deployment/ui/PackageManagerDialog.hpp"
 #include "com/sun/star/ui/dialogs/XExecutableDialog.hpp"
+#include "com/sun/star/lang/DisposedException.hpp"
 #include "boost/scoped_array.hpp"
 #include "com/sun/star/ui/dialogs/XDialogClosedListener.hpp"
-
+#include "com/sun/star/bridge/XBridgeFactory.hpp"
 #include <stdio.h>
 #include <vector>
 
@@ -64,7 +65,7 @@ using namespace ::com::sun::star;
 using namespace ::com::sun::star::uno;
 using namespace ::unopkg;
 using ::rtl::OUString;
-
+namespace css = ::com::sun::star;
 namespace {
 
 //------------------------------------------------------------------------------
@@ -170,6 +171,38 @@ Reference<deployment::XPackage> findPack
 
 } // anon namespace
 
+
+//workaround for some reason the bridge threads which communicate with the uno.exe
+//process are not releases on time
+void disposeBridges(Reference<css::uno::XComponentContext> ctx)
+{
+    if (!ctx.is())
+        return;
+
+    Reference<css::bridge::XBridgeFactory> bridgeFac(
+        ctx->getServiceManager()->createInstanceWithContext(
+            OUSTR("com.sun.star.bridge.BridgeFactory"), ctx),
+        UNO_QUERY);
+
+    if (bridgeFac.is())
+    {
+        const Sequence< Reference<css::bridge::XBridge> >seqBridges = bridgeFac->getExistingBridges();
+        for (sal_Int32 i = 0; i < seqBridges.getLength(); i++)
+        {        
+            Reference<css::lang::XComponent> comp(seqBridges[i], UNO_QUERY);
+            if (comp.is())
+            {
+                try {
+                    comp->dispose();
+                }
+                catch (css::lang::DisposedException& )
+                {
+                }
+            }
+        }
+    }
+}
+
 //##############################################################################
 SAL_IMPLEMENT_MAIN()
 {
@@ -201,6 +234,8 @@ SAL_IMPLEMENT_MAIN()
         s_option_infos, OUSTR("help") );
     OptionInfo const * info_version = getOptionInfo(
         s_option_infos, OUSTR("version") );
+
+    Reference<XComponentContext> xComponentContext;
     
     try {
         sal_uInt32 nPos = 0;
@@ -235,7 +270,8 @@ SAL_IMPLEMENT_MAIN()
             else if (!readOption( &option_verbose, info_verbose, &nPos ) &&
                      !readOption( &option_shared, info_shared, &nPos ) &&
                      !readOption( &option_force, info_force, &nPos ) &&
-                     !readArgument( &deploymentContext, info_context, &nPos ))
+                     !readArgument( &deploymentContext, info_context, &nPos ) &&
+                     !isBootstrapVariable(&nPos))
             {
                 oslProcessError rc = osl_getCommandArg( nPos, &cmdArg.pData );
                 if (rc != osl_Process_E_None )
@@ -269,8 +305,7 @@ SAL_IMPLEMENT_MAIN()
             }
         }
         
-        Reference<XComponentContext> xComponentContext(
-            getUNO( disposeGuard, option_verbose, subcmd_gui ) );
+        xComponentContext = getUNO( disposeGuard, option_verbose, subcmd_gui );
         
         if (deploymentContext.getLength() == 0) {
             deploymentContext = option_shared ? OUSTR("shared") : OUSTR("user");
@@ -407,6 +442,8 @@ SAL_IMPLEMENT_MAIN()
         
         if (option_verbose)
             printf( "\n%s done.\n", APP_NAME );
+        //Force to release all bridges which connect us to the child processes
+        disposeBridges(xComponentContext);
         return 0;
     }
     catch (ucb::CommandFailedException &) {
@@ -436,6 +473,8 @@ SAL_IMPLEMENT_MAIN()
             ::comphelper::anyToString(exc) : e.Message, textenc).getStr() );
     }
     fprintf( stderr, "\n%s failed.\n", APP_NAME );
+    disposeBridges(xComponentContext);
     return 1;
 }
 
+
Index: desktop/source/pkgchk/unopkg/unopkg_misc.cxx
===================================================================
RCS file: /cvs/framework/desktop/source/pkgchk/unopkg/unopkg_misc.cxx,v
retrieving revision 1.6
retrieving revision 1.6.50.3
diff -u -u -p -r1.6 -r1.6.50.3
--- desktop/source/pkgchk/unopkg/unopkg_misc.cxx	5 Jun 2007 15:08:06 -0000	1.6
+++ desktop/source/pkgchk/unopkg/unopkg_misc.cxx	1 Aug 2007 09:23:59 -0000	1.6.50.3
@@ -146,6 +146,21 @@ bool isOption( OptionInfo const * option
     }
     return false;
 }
+//==============================================================================
+
+bool isBootstrapVariable(sal_uInt32 * pIndex)
+{
+    OSL_ASSERT(osl_getCommandArgCount() >=  *pIndex);
+
+    OUString arg;
+    osl_getCommandArg(*pIndex, &arg.pData);
+    if (arg.matchAsciiL("-env:", 5))
+    {
+        ++(*pIndex);
+        return true;
+    }
+    return false;
+}
 
 //==============================================================================
 bool readArgument(
@@ -352,14 +367,15 @@ Reference<XComponentContext> bootstrapSt
     // bootstrap standalone UNO using types.rdb and services.rdb
     // directly avoiding any rc entries
     Reference<beans::XPropertySet> xProps(
-        ::cppu::createRegistryServiceFactory(
-            getExecutableDir() + OUSTR("/types.rdb"),
-            getExecutableDir() + OUSTR("/services.rdb"),
-            true /* read-only */ ),
-        UNO_QUERY_THROW );
+       ::cppu::createRegistryServiceFactory(
+           getExecutableDir() + OUSTR("/types.rdb"),
+           getExecutableDir() + OUSTR("/services.rdb"),
+           true /* read-only */ ),
+       UNO_QUERY_THROW );
     Reference<XComponentContext> xContext(
-        xProps->getPropertyValue( OUSTR("DefaultContext") ),
-        UNO_QUERY_THROW );
+       xProps->getPropertyValue( OUSTR("DefaultContext") ),
+       UNO_QUERY_THROW );
+
     // assure disposing of local component context:
     disposeGuard.reset(
         Reference<lang::XComponent>( xContext, UNO_QUERY ) );
Index: desktop/source/pkgchk/unopkg/unopkg_shared.h
===================================================================
RCS file: /cvs/framework/desktop/source/pkgchk/unopkg/unopkg_shared.h,v
retrieving revision 1.2
retrieving revision 1.2.116.1
diff -u -u -p -r1.2 -r1.2.116.1
--- desktop/source/pkgchk/unopkg/unopkg_shared.h	18 Jan 2007 14:58:10 -0000	1.2
+++ desktop/source/pkgchk/unopkg/unopkg_shared.h	16 Jul 2007 12:28:23 -0000	1.2.116.1
@@ -97,7 +97,12 @@ inline bool readOption(
     }
     return false;
 }
+//==============================================================================
 
+/** checks if an argument is a bootstrap variable. These start with -env:. For example
+    -env:UNO_JAVA_JFW_USER_DATA=file:///d:/user
+*/
+bool isBootstrapVariable(sal_uInt32 * pIndex);
 //==============================================================================
 ::rtl::OUString const & getExecutableDir();
 
