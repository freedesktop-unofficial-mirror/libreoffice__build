cvs diff: Diffing transex3
cvs diff: Diffing transex3/inc
Index: transex3/inc/helpmerge.hxx
===================================================================
RCS file: /cvs/l10n/transex3/inc/helpmerge.hxx,v
retrieving revision 1.8
retrieving revision 1.8.68.1
diff -p -u -u -p -b -w -B -r1.8 -r1.8.68.1
--- transex3/inc/helpmerge.hxx	22 Nov 2006 10:43:33 -0000	1.8
+++ transex3/inc/helpmerge.hxx	11 Feb 2008 15:33:48 -0000	1.8.68.1
@@ -53,7 +53,7 @@ private:
     
 /// Copy fallback language String (ENUS,DE) into position of the numeric language iso code 
 /// @PRECOND 0 < langIdx_in < MAX_IDX
-    void FillInFallbacks( LangHashMap& rElem_out, ByteString sLangIdx_in );
+    static void FillInFallbacks( LangHashMap& rElem_out, ByteString sLangIdx_in );
 
 /// Debugmethod, prints the content of the map to stdout
     static  void Dump(  LangHashMap* rElem_in , const ByteString sKey_in );
@@ -69,7 +69,8 @@ public:
 
 /// Method creates/append a SDF file with the content of a parsed XML file
 /// @PRECOND rHelpFile is valid
-    bool CreateSDF( const ByteString &rSDFFile_in, const ByteString &rPrj_in, const ByteString &rRoot_in );
+    static bool CreateSDF( const ByteString &rSDFFile_in, const ByteString &rPrj_in, const ByteString &rRoot_in,
+                           const ByteString &sHelpFile, XMLFile *pXmlFile, const ByteString &rGsi1 );
 	
 	static  void parse_languages( std::vector<ByteString>& aLanguages , MergeDataFile& aMergeDataFile );
 
Index: transex3/inc/xmlparse.hxx
===================================================================
RCS file: /cvs/l10n/transex3/inc/xmlparse.hxx,v
retrieving revision 1.12
retrieving revision 1.12.92.1
diff -p -u -u -p -b -w -B -r1.12 -r1.12.92.1
--- transex3/inc/xmlparse.hxx	14 Aug 2006 17:08:54 -0000	1.12
+++ transex3/inc/xmlparse.hxx	11 Feb 2008 15:33:48 -0000	1.12.92.1
@@ -191,6 +191,7 @@ public:
     virtual int GetPosition( ByteString id );
     int RemoveChild( XMLElement *pRefElement );
 	void RemoveAndDeleteAllChilds();
+    void RemoveAndDeleteChildList();
 
 	/// returns a child element which matches the given one
 	XMLElement *GetChildElement(
@@ -250,16 +251,17 @@ public:
 
 	/// returns file name
 	const String &GetName() { return sFileName; }
+    void          SetName( const String &rFilename ) { sFileName = rFilename; }
     const std::vector<ByteString> getOrder(){ return order; }
 	
-private:
+protected:
 	// writes a string as UTF8 with dos line ends to a given stream
     void        WriteString( ofstream &rStream, const String &sString );
 	
     // quotes the given text for writing to a file
 	void 		QuotHTML( String &rString );
 
-	void		InsertL10NElement( XMLElement* pElement);
+	virtual void InsertL10NElement( XMLElement* pElement);
 
 	// DATA
 	String 		sFileName;
@@ -542,7 +544,8 @@ public:
 
 	/// parse a file, returns NULL on criticall errors
 	XMLFile *Execute( 
-		const String &rFileName	// the file name
+		const String &rFileName,	// the file name
+        XMLFile *pXMLFileIn
 	);
 
 	/// parse a memory stream, returns NULL on criticall errors
cvs diff: Diffing transex3/inc/pch
cvs diff: Diffing transex3/inc/transex3
Index: transex3/inc/transex3/vosapp.hxx
===================================================================
RCS file: transex3/inc/transex3/vosapp.hxx
diff -N transex3/inc/transex3/vosapp.hxx
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ transex3/inc/transex3/vosapp.hxx	12 Feb 2008 09:58:28 -0000	1.1.2.1
@@ -0,0 +1,33 @@
+#ifndef VOSAPP_HXX
+#define VOSAPP_HXX
+
+#include <sal/main.h>
+#include <tools/solar.h>
+#include <tools/string.hxx>
+#include <vos/process.hxx>
+
+// Mininmal vcl/svapp compatibility without vcl dependence
+class Application
+{
+public:
+    USHORT GetCommandLineParamCount();
+    XubString GetCommandLineParam( USHORT nParam );
+    virtual void Main() = 0;
+};
+
+// Urg: Cut & Paste from svapp.cxx: we don't want to depend on vcl
+USHORT Application::GetCommandLineParamCount()
+{
+    vos::OStartupInfo aStartInfo;
+    return (USHORT)aStartInfo.getCommandArgCount();
+}
+
+XubString Application::GetCommandLineParam( USHORT nParam )
+{
+    vos::OStartupInfo aStartInfo;
+    rtl::OUString aParam;
+    aStartInfo.getCommandArg( nParam, aParam );
+    return XubString( aParam );
+}
+
+#endif /* VOSAPP_HXX */
cvs diff: Diffing transex3/java
cvs diff: Diffing transex3/java/l10nconv
cvs diff: Diffing transex3/java/l10nconv/documentation
cvs diff: Diffing transex3/java/l10nconv/java
cvs diff: Diffing transex3/java/l10nconv/java/com
cvs diff: Diffing transex3/java/l10nconv/java/com/sun
cvs diff: Diffing transex3/java/l10nconv/java/com/sun/star
cvs diff: Diffing transex3/java/l10nconv/java/com/sun/star/tooling
cvs diff: Diffing transex3/java/l10nconv/java/com/sun/star/tooling/DirtyTags
cvs diff: Diffing transex3/java/l10nconv/java/com/sun/star/tooling/converter
cvs diff: Diffing transex3/java/l10nconv/java/com/sun/star/tooling/converter/dtd
cvs diff: Diffing transex3/java/l10nconv/java/com/sun/star/tooling/languageResolver
cvs diff: Diffing transex3/java/receditor
cvs diff: Diffing transex3/java/receditor/java
cvs diff: Diffing transex3/java/receditor/java/transex3
cvs diff: Diffing transex3/java/receditor/java/transex3/controller
cvs diff: Diffing transex3/java/receditor/java/transex3/model
cvs diff: Diffing transex3/java/receditor/java/transex3/view
cvs diff: Diffing transex3/layout
Index: transex3/layout/README
===================================================================
RCS file: transex3/layout/README
diff -N transex3/layout/README
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ transex3/layout/README	11 Feb 2008 15:33:49 -0000	1.1.2.1
@@ -0,0 +1,15 @@
+Tralay - Extract and translate strings in Layout xml files.
+
+ * Extract: generate out.sdf
+      ../unxlngx6.pro/bin/tralay -l en-US zoom.xml > out.sdf
+
+ * Translate: do:
+      cat out.sdf > trans.sdf
+      sed 's/en-US\t/de\tde:/' out.sdf >> trans.sdf 
+
+ * Merge: translate
+     ../unxlngx6.pro/bin/tralay -m trans.sdf -l de zoom.xml > zoom-DE.xml
+
+TODO:
+   * handle multiple _attributes per element
+     + create new node for each attribute, append attribute name to node name
Index: transex3/layout/layoutparse.cxx
===================================================================
RCS file: transex3/layout/layoutparse.cxx
diff -N transex3/layout/layoutparse.cxx
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ transex3/layout/layoutparse.cxx	11 Feb 2008 15:33:49 -0000	1.1.2.1
@@ -0,0 +1,112 @@
+#include "layoutparse.hxx"
+
+LayoutXMLFile::LayoutXMLFile( bool mergeMode )
+    : XMLFile()
+    , mMergeMode( mergeMode )
+{
+    /* FIXME: Override SearchL10NElements too and just search all ? */
+	nodes_localize.insert( TagMap::value_type(ByteString(String::CreateFromAscii("dialog"),RTL_TEXTENCODING_ASCII_US) , TRUE) );
+	nodes_localize.insert( TagMap::value_type(ByteString(String::CreateFromAscii("fixedline"),RTL_TEXTENCODING_ASCII_US) , TRUE) );
+	nodes_localize.insert( TagMap::value_type(ByteString(String::CreateFromAscii("fixedtext"),RTL_TEXTENCODING_ASCII_US) , TRUE) );
+	nodes_localize.insert( TagMap::value_type(ByteString(String::CreateFromAscii("modaldialog"),RTL_TEXTENCODING_ASCII_US) , TRUE) );
+    nodes_localize.insert( TagMap::value_type(ByteString(String::CreateFromAscii("pushbutton"),RTL_TEXTENCODING_ASCII_US) , TRUE) );
+    nodes_localize.insert( TagMap::value_type(ByteString(String::CreateFromAscii("radiobutton"),RTL_TEXTENCODING_ASCII_US) , TRUE) );
+}
+    
+#define STRING( str ) String( str, RTL_TEXTENCODING_UTF8 )
+
+/* Cut and paste from XMLFile::InsertL10NElement */
+void LayoutXMLFile::InsertL10NElement( XMLElement* pElement )
+{
+	ByteString tmpStr,id,oldref,language("");
+	ByteString label(""),text(""),title("");
+	LangHashMap* elem;
+
+    static ByteString const LABEL("_label"),TEXT("_text"),TITLE("_title");
+    
+    if( pElement->GetAttributeList() != NULL ){
+        for ( ULONG j = 0; j < pElement->GetAttributeList()->Count(); j++ ){
+		    tmpStr=ByteString( *pElement->GetAttributeList()->GetObject( j ),RTL_TEXTENCODING_UTF8 );
+		    if( tmpStr.CompareTo(ID)==COMPARE_EQUAL  ){	// Get the "id" Attribute
+			    id = ByteString( pElement->GetAttributeList()->GetObject( j )->GetValue(),RTL_TEXTENCODING_UTF8 );
+		    }
+		    if( tmpStr.CompareTo( XML_LANG ) == COMPARE_EQUAL ){	// Get the "xml-lang" Attribute
+			    language = ByteString( pElement->GetAttributeList()->GetObject( j )->GetValue(),RTL_TEXTENCODING_UTF8 );
+		    }
+
+            /* Tralay hack */
+		    if( tmpStr.CompareTo(LABEL)==COMPARE_EQUAL  ){
+			    label = ByteString( pElement->GetAttributeList()->GetObject( j )->GetValue(),RTL_TEXTENCODING_UTF8 );
+		    }
+		    if( tmpStr.CompareTo(TEXT)==COMPARE_EQUAL  ){
+			    text = ByteString( pElement->GetAttributeList()->GetObject( j )->GetValue(),RTL_TEXTENCODING_UTF8 );
+		    }
+		    if( tmpStr.CompareTo(TITLE)==COMPARE_EQUAL  )
+			    title = ByteString( pElement->GetAttributeList()->GetObject( j )->GetValue(),RTL_TEXTENCODING_UTF8 );
+	    }
+    }else{ 
+        fprintf(stderr,"XMLFile::InsertL10NElement: No AttributeList found");
+        fprintf(stderr,"++++++++++++++++++++++++++++++++++++++++++++++++++");
+        Print( pElement , 0 );
+        fprintf(stderr,"++++++++++++++++++++++++++++++++++++++++++++++++++");
+    }
+
+    /* Tralay: assume language always en-US */
+    language = "en-US";
+
+    XMLElement *e = pElement;
+    /* Tralay: copy translatable text to CONTENT.
+       FIXME: what about multiple translatable attributes?  */
+    if ( label.Len() )
+		new XMLData( STRING( label ), pElement, true );
+    else if ( text.Len() )
+		new XMLData( STRING( text ), pElement, true );
+    else if ( title.Len() )
+    {
+        if ( !mMergeMode )
+        {
+            e = new XMLElement( *pElement );
+            e->RemoveAndDeleteAllChilds();
+        }
+		new XMLData( STRING( title ), e, true );
+    }
+    
+	XMLHashMap::iterator pos = XMLStrings->find( id );
+	if( pos == XMLStrings->end() ){				// No instanze , create new one
+        elem = new LangHashMap();
+        (*elem)[ language ]=e;
+		XMLStrings->insert( XMLHashMap::value_type( id , elem ) );
+        order.push_back( id );
+	}else{									// Already there 
+        elem=pos->second;
+        if ( (*elem)[ language ] )
+        {
+            fprintf(stderr,"Error: Entry for language double. ID = %s  LANG = %s in File %s\n", id.GetBuffer(), language.GetBuffer(), ByteString( sFileName,RTL_TEXTENCODING_ASCII_US ).GetBuffer() );
+            exit( -1 );
+        }
+        (*elem)[ language ]=e;
+	}
+
+    /* Recurse int children, SearchL10NElements does not do that for us.  */
+    if ( XMLChildNodeList* lst = pElement->GetChildList() )
+        for ( ULONG i = 0; i < lst->Count(); i++ )
+            SearchL10NElements( (XMLParentNode*) lst->GetObject( i ), i);
+}
+
+BOOL LayoutXMLFile::Write( ByteString &aFilename )
+{
+
+    if ( aFilename.Len() )
+    {
+        ofstream aFStream( aFilename.GetBuffer() , ios::out | ios::trunc ); 
+        if ( !aFStream )
+            fprintf( stderr, "ERROR: cannot open file:%s\n", aFilename.GetBuffer() );
+        else
+        {
+            XMLFile::Write( aFStream );
+            aFStream.close();
+            return true;
+        }
+    }
+    return false;
+}
Index: transex3/layout/layoutparse.hxx
===================================================================
RCS file: transex3/layout/layoutparse.hxx
diff -N transex3/layout/layoutparse.hxx
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ transex3/layout/layoutparse.hxx	11 Feb 2008 15:33:49 -0000	1.1.2.1
@@ -0,0 +1,16 @@
+#ifndef LAYOUTPARSE_HXX
+#define LAYOUTPARSE_HXX
+
+#include "xmlparse.hxx"
+
+class LayoutXMLFile : public XMLFile
+{
+    bool mMergeMode;
+
+public:
+    LayoutXMLFile( bool mergeMode );
+    void InsertL10NElement( XMLElement* pElement );
+    BOOL Write( ByteString &aFilename );
+};
+
+#endif /* LAYOUTPARSE_HXX */
Index: transex3/layout/loc.sdf
===================================================================
RCS file: transex3/layout/loc.sdf
diff -N transex3/layout/loc.sdf
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ transex3/layout/loc.sdf	11 Feb 2008 15:33:49 -0000	1.1.2.1
@@ -0,0 +1,24 @@
+transex3	layout\workben\zoom-1.xml	0	help	FL_ZOOM				0	en-US	Zoom factor				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_WHOLE_PAGE				0	en-US	Whole Page				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_PAGE_WIDTH				0	en-US	Page Width				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_OPTIMAL				0	en-US	Optimal				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_200				0	en-US	200 %				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_150				0	en-US	15~0 %				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_100				0	en-US	100 %				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_75				0	en-US	75 %				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_50				0	en-US	50 %				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_USER				0	en-US	Variable				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	FL_ZOOM				0	de	deZoom factor				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_WHOLE_PAGE				0	de	deWhole Page				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_PAGE_WIDTH				0	de	dePage Width				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_OPTIMAL				0	de	deOptimal				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_200				0	de	de200 %				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_150				0	de	de15~0 %				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_100				0	de	de100 %				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_75				0	de	de75 %				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_50				0	de	de50 %				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_USER				0	de	deVariable				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	FL_ZOOM				0	en-US	Zoom factor				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_WHOLE_PAGE				0	en-US	Whole Page				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	FL_ZOOM				0	de	de3:Zoom factor				20080204 13:51:01
+transex3	layout\workben\zoom-1.xml	0	help	BTN_WHOLE_PAGE				0	de	de3:Whole Page				20080204 13:51:01
Index: transex3/layout/localize.sdf
===================================================================
RCS file: transex3/layout/localize.sdf
diff -N transex3/layout/localize.sdf
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ transex3/layout/localize.sdf	11 Feb 2008 15:33:49 -0000	1.1.2.1
@@ -0,0 +1,10 @@
+layout	janneke\vc\ooo-m3\build\current\transex3\layout\zoom.xml	0	layout	FL_ZOOM				0	en-US	Zoom factor				20080206 16:06:07
+layout	janneke\vc\ooo-m3\build\current\transex3\layout\zoom.xml	0	layout	BTN_WHOLE_PAGE				0	en-US	Whole Page				20080206 16:06:07
+layout	janneke\vc\ooo-m3\build\current\transex3\layout\zoom.xml	0	layout	BTN_PAGE_WIDTH				0	en-US	Page Width				20080206 16:06:07
+layout	janneke\vc\ooo-m3\build\current\transex3\layout\zoom.xml	0	layout	BTN_OPTIMAL				0	en-US	Optimal				20080206 16:06:07
+layout	janneke\vc\ooo-m3\build\current\transex3\layout\zoom.xml	0	layout	BTN_200				0	en-US	200 %				20080206 16:06:07
+layout	janneke\vc\ooo-m3\build\current\transex3\layout\zoom.xml	0	layout	BTN_150				0	en-US	15~0 %				20080206 16:06:07
+layout	janneke\vc\ooo-m3\build\current\transex3\layout\zoom.xml	0	layout	BTN_100				0	en-US	100 %				20080206 16:06:07
+layout	janneke\vc\ooo-m3\build\current\transex3\layout\zoom.xml	0	layout	BTN_75				0	en-US	75 %				20080206 16:06:07
+layout	janneke\vc\ooo-m3\build\current\transex3\layout\zoom.xml	0	layout	BTN_50				0	en-US	50 %				20080206 16:06:07
+layout	janneke\vc\ooo-m3\build\current\transex3\layout\zoom.xml	0	layout	BTN_USER				0	en-US	Variable				20080206 16:06:07
Index: transex3/layout/makefile.mk
===================================================================
RCS file: transex3/layout/makefile.mk
diff -N transex3/layout/makefile.mk
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ transex3/layout/makefile.mk	11 Feb 2008 15:33:49 -0000	1.1.2.1
@@ -0,0 +1,61 @@
+PRJ=..
+
+INCPRE=$(MISC)
+
+PRJNAME=transex3
+TARGET=tralay
+#TARGETTYPE=GUI
+TARGETTYPE=CUI
+LIBTARGET=no
+
+# --- Settings -----------------------------------------------------
+
+ENABLE_EXCEPTIONS=TRUE
+
+.INCLUDE :  settings.mk
+
+.IF "$(SYSTEM_EXPAT)" == "YES"
+CFLAGS+=-DSYSTEM_EXPAT
+.ENDIF
+
+# --- Files --------------------------------------------------------
+
+CXXFILES=\
+	layoutparse.cxx\
+	tralay.cxx
+
+APP1TARGET=$(TARGET)
+
+.IF "$(ENABLE_LAYOUT)" == "TRUE"
+
+OBJFILES =\
+	$(OBJ)/export2.obj\
+	$(OBJ)/helpmerge.obj\
+	$(OBJ)/layoutparse.obj\
+	$(OBJ)/merge.obj\
+	$(OBJ)/tralay.obj\
+	$(OBJ)/xmlparse.obj
+
+APP1OBJS = $(OBJFILES)
+
+APP1STDLIBS =\
+	$(EXPATASCII3RDLIB)\
+	$(TOOLSLIB)\
+	$(VOSLIB)
+
+# --- Targets ------------------------------------------------------
+
+.INCLUDE :  target.mk
+
+.ELSE # ENABLE_LAYOUT != TRUE
+
+$(BIN)$/$(APP1TARGET)$(EXECPOST):
+	touch $@
+
+ALLTAR:
+all:
+check:
+clean:
+
+.ENDIF # ENABLE_LAYOUT != TRUE
+
Index: transex3/layout/tralay.cxx
===================================================================
RCS file: transex3/layout/tralay.cxx
diff -N transex3/layout/tralay.cxx
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ transex3/layout/tralay.cxx	12 Feb 2008 09:58:28 -0000	1.1.2.2
@@ -0,0 +1,318 @@
+#include <com/sun/star/xml/sax/SAXException.hpp>
+#include <transex3/vosapp.hxx>
+
+#include "export.hxx"
+#include "layoutparse.hxx"
+#include "helpmerge.hxx"
+
+// Convert a rtl::OUString to a byte string.
+#define OUSTRING_CSTR( str ) \
+    rtl::OUStringToOString( str, RTL_TEXTENCODING_UTF8 ).getStr()
+
+#define STRING( str ) String( str, RTL_TEXTENCODING_UTF8 )
+#define BSTRING( str ) ByteString( str, RTL_TEXTENCODING_UTF8 )
+
+using namespace ::rtl;
+using namespace ::com::sun::star;
+using namespace ::com::sun::star::uno;
+
+
+class TranslateLayout : public Application
+{
+    ByteString mGid1;
+    ByteString mLanguage;
+    ByteString mLocalize; 
+    ByteString mOutput;
+    ByteString mProject;
+    ByteString mRoot;
+    bool mMergeMode;
+    std::vector< ByteString > mLanguages;
+    std::list< ByteString > mFiles;
+
+public:
+    TranslateLayout();
+    ~TranslateLayout();
+    ByteString GetCommandLineParam( int i );
+    ByteString GetOptionArgument( int const i );
+    void ExceptionalMain();
+    void Main();
+    void Merge();
+    void MergeLanguage( ByteString const& language );
+    void ParseCommandLine();
+    void CreateSDF();
+};
+
+static void usage()
+{
+    fprintf( stderr, "Usage: tralay [OPTION]... XML-FILE\n" );
+    fprintf( stderr, "\nOptions:\n" );
+    fprintf( stderr, "  -h,--help                  show this help\n" );
+    fprintf( stderr, "  -l,--language=LANG         process this language\n" );
+    fprintf( stderr, "  -m,--merge=DATABASE.SDF    translation database\n" );
+    fprintf( stderr, "\nExamples:\n" );
+    fprintf( stderr, "  tralay -l en-US -o localize.sdf zoom.xml   # Extract\n" );
+    fprintf( stderr, "  tralay -m localize.sdf -l de -l nl -o out zoom.xml  # Merge/translate\n" );
+    exit( 2 );
+}
+
+ByteString TranslateLayout::GetCommandLineParam( int i )
+{
+    return ByteString( OUSTRING_CSTR( Application::GetCommandLineParam( i ) ) );
+}
+
+ByteString TranslateLayout::GetOptionArgument( int const i )
+{
+    if ( i >= GetCommandLineParamCount() )
+        usage();
+    ByteString arg = GetCommandLineParam( i );
+    if ( !arg.CompareTo( "-", 1 ) )
+    {
+        fprintf( stderr, "Option needs an argument: %s, found: %s\n",
+                 GetCommandLineParam( i - 1 ).GetBuffer(),
+                 arg.GetBuffer() );
+        usage();
+    }
+    return arg;
+ }
+
+void TranslateLayout::ParseCommandLine()
+{
+    for ( int i = 0; i < GetCommandLineParamCount(); i++ )
+    {
+        ByteString aParam = GetCommandLineParam( i );
+        if ( aParam.Equals( "-h" ) || aParam.Equals( "--help" ) )
+            usage();
+        else if ( aParam.Equals( "-l" ) || aParam.Equals( "--language" ) )
+            mLanguages.push_back ( GetOptionArgument( ++i ) );
+        else if ( aParam.Equals( "-m" ) || aParam.Equals( "--merge" ) )
+        {
+            mMergeMode = true;
+            mLocalize = GetOptionArgument( ++i );
+        }
+        else if ( aParam.Equals( "-o" ) || aParam.Equals( "--output" ) )
+            mOutput = GetOptionArgument( ++i );
+        else if ( !aParam.CompareTo( "-", 1 ) )
+        {
+            fprintf( stderr, "error: No such option: %s\n", aParam.GetBuffer() );
+            usage();
+        }
+        else
+            mFiles.push_back( aParam );
+    }
+    if ( !mFiles.size() )
+    {
+        fprintf( stderr, "error: No XML-FILE found\n" );
+        usage();
+    }
+}
+
+static XMLAttribute*
+findAttribute( XMLAttributeList* lst, String const& name )
+{
+    for ( ULONG i = 0; i < lst->Count(); i++ )
+        if ( lst->GetObject( i )->Equals( name ) )
+            return lst->GetObject( i );
+    return 0;
+}
+
+static XMLAttribute*
+translateAttribute( XMLAttributeList* lst,
+                    String const& name, String const& translation )
+{
+    if ( XMLAttribute* a = findAttribute( lst, STRING( "_" ).Append( name ) ) )
+        return lst->Replace ( new XMLAttribute( name, translation ), a );
+    return 0;
+}
+
+static ByteString
+removeContent( XMLElement* element )
+{
+    if ( XMLChildNodeList* lst = element->GetChildList() )
+        for ( ULONG i = 0; i < lst->Count(); i++ )
+        {
+            if ( XMLChildNode* e = lst->GetObject( i ) )
+                if ( e->GetNodeType() ==  XML_NODE_TYPE_DATA
+                     && ( ( XMLData* )e )->isNew() )
+                {
+                    XMLData* data = ( XMLData* )e;
+                    ByteString content = BSTRING( data->GetData() );
+                    lst->Remove( i-- );
+                    if ( !lst->Count() )
+                        element->RemoveAndDeleteChildList();
+                    return content;
+                }
+        }
+    return ByteString();
+}
+
+static void
+translateElement( XMLElement* element, ByteString const& lang,
+                  ResData* resData, MergeDataFile& mergeData )
+{
+    if ( XMLAttributeList* attributes = element->GetAttributeList() )
+        if ( PFormEntrys* entry = mergeData.GetPFormEntrys( resData ) )
+        {
+            ByteString translation;
+            entry->GetText( translation, STRING_TYP_TEXT, lang, true );
+            ByteString original = removeContent( element );
+            if ( !translation.Len() )
+                translation = original;
+            delete translateAttribute( attributes, STRING( "label" ),
+                                       STRING( translation ) );
+            delete translateAttribute( attributes, STRING( "text" ),
+                                       STRING( translation ) );
+            delete translateAttribute( attributes, STRING( "title" ),
+                                       STRING( translation ) );
+        }
+}
+
+static bool is_dir( ByteString const& name )
+{
+    if (DIR* dir = opendir( name.GetBuffer() ) )
+    {
+        closedir( dir );
+        return true;
+    }
+    return false;
+}
+
+static void make_directory( ByteString const& name )
+{
+#ifdef WNT
+        _mkdir( name.GetBuffer() );
+#else
+        mkdir( name.GetBuffer() , S_IRWXU | S_IRWXG | S_IROTH | S_IXOTH );
+#endif
+}
+
+void TranslateLayout::MergeLanguage( ByteString const& language )
+{
+    ByteString xmlFile = mFiles.front();
+
+    MergeDataFile mergeData( mLocalize, xmlFile,
+                             FALSE, RTL_TEXTENCODING_MS_1252 );
+
+    SimpleXMLParser aParser;
+    LayoutXMLFile* layoutXml = new LayoutXMLFile( mMergeMode );
+    if ( !aParser.Execute( STRING( xmlFile ), layoutXml ) )
+    {
+        fprintf(stderr, "error: parsing: %s\n", xmlFile.GetBuffer() );
+        return;
+    }
+    
+    layoutXml->Extract();
+
+    ResData	resData( "", "", "" );
+    resData.sResTyp = mProject; /* mGid1 ?? */
+    resData.sFilename = xmlFile;
+
+    XMLHashMap* xmlStrings = layoutXml->GetStrings();
+    for ( XMLHashMap::iterator i = xmlStrings->begin(); i != xmlStrings->end();
+          ++i )
+        if ( LangHashMap* languageMap = i->second )
+            if ( XMLElement* element = ( *languageMap )[ "en-US" ] )
+            {
+                resData.sGId = i->first;
+                resData.sId = element->GetOldref();
+                translateElement( element, language, &resData, mergeData );
+            }
+    
+    ByteString outFile = "/dev/stdout";
+    if ( mOutput.Len() )
+    {
+        outFile = mOutput;
+        if ( is_dir( outFile ) )
+        {
+            ByteString outDir = mOutput;
+            outDir.Append( "/" ).Append( language );
+            if ( !is_dir( outDir ) )
+                make_directory( outDir );
+            outFile = outDir;
+            outFile.Append( "/" ).Append( xmlFile );
+        }
+    }
+    layoutXml->Write( outFile );
+    delete layoutXml;
+}
+
+void TranslateLayout::Merge()
+{
+    if ( mLanguages.size() )
+        for ( std::vector<ByteString>::iterator i = mLanguages.begin();
+              i != mLanguages.end(); ++i)
+            MergeLanguage( *i );
+    else
+        MergeLanguage( mLanguage );
+}
+
+void TranslateLayout::CreateSDF()
+{
+    ByteString xmlFile = mFiles.front();
+    ByteString sdf = "/dev/stdout";
+    if ( mOutput.Len() )
+        sdf = mOutput;
+    Export::SetLanguages( mLanguages );
+    HelpParser::CreateSDF( sdf, mProject, mRoot, xmlFile,
+                           new LayoutXMLFile( mMergeMode ), mGid1 );
+}
+
+void TranslateLayout::ExceptionalMain()
+{
+    ParseCommandLine();
+    if ( mLanguages.size() )
+        mLanguage = mLanguages.front();
+    if ( mMergeMode )
+        Merge();
+    else
+        CreateSDF();
+}
+
+void TranslateLayout::Main()
+{
+    try
+    {
+        ExceptionalMain();
+    }
+    catch ( xml::sax::SAXException& rExc )
+    {
+        OString aStr( OUStringToOString( rExc.Message,
+                                         RTL_TEXTENCODING_ASCII_US ) );
+        uno::Exception exc;
+        if (rExc.WrappedException >>= exc)
+        {
+            aStr += OString( " >>> " );
+            aStr += OUStringToOString( exc.Message, RTL_TEXTENCODING_ASCII_US );
+        }
+        fprintf( stderr, "error: parsing: '%s'\n", aStr.getStr() );
+        OSL_ENSURE( 0, aStr.getStr() );
+    }
+    catch ( uno::Exception& rExc )
+    {
+        OString aStr( OUStringToOString( rExc.Message,
+                                         RTL_TEXTENCODING_ASCII_US ) );
+        fprintf( stderr, "error: UNO: '%s'\n", aStr.getStr() );
+        OSL_ENSURE( 0, aStr.getStr() );
+    }
+}
+
+TranslateLayout::TranslateLayout()
+    : Application()
+    , mGid1( "layout" )
+    , mLanguage( "en-US" )
+    , mLocalize( "localize.sdf" )
+    , mOutput()
+    , mProject( "layout" )
+    , mRoot( "/root" )
+{
+}
+
+TranslateLayout::~TranslateLayout()
+{
+}
+
+SAL_IMPLEMENT_MAIN()
+{
+    TranslateLayout t;
+    t.Main();
+    return 0;
+}
Index: transex3/layout/zoom.xml
===================================================================
RCS file: transex3/layout/zoom.xml
diff -N transex3/layout/zoom.xml
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ transex3/layout/zoom.xml	11 Feb 2008 15:33:49 -0000	1.1.2.1
@@ -0,0 +1,37 @@
+<?xml version="1.0" encoding="UTF-8"?>
+
+<modaldialog xmlns="http://openoffice.org/2007/layout"
+             xmlns:cnt="http://openoffice.org/2007/layout/container"
+             id="dialog" _title="Set Zoom" optimumsize="true"
+	     help-id="SID_ATTR_ZOOM"
+             has_border="true" sizeable="true" moveable="true">
+    <vbox spacing="5" border="5">
+	<fixedline id="FL_ZOOM" _text="Zoom factor" cnt:expand="true"/>
+	<radiobutton radiogroup="zoom" id="BTN_WHOLE_PAGE" _label="Whole Page"/>
+	<radiobutton radiogroup="zoom" id="BTN_PAGE_WIDTH" _label="Page Width"/>
+	<radiobutton radiogroup="zoom" id="BTN_OPTIMAL"   _label="Optimal"/>
+	<radiobutton radiogroup="zoom" id="BTN_200"   _label="200 %"/>
+	<radiobutton radiogroup="zoom" id="BTN_150"   _label="15~0 %"/>
+	<radiobutton radiogroup="zoom" id="BTN_100"   _label="100 %"/>
+	<radiobutton radiogroup="zoom" id="BTN_75"    _label="75 %"/>
+	<radiobutton radiogroup="zoom" id="BTN_50"    _label="50 %"/>
+	<hbox cnt:expand="false" cnt:fill="true">
+	    <align cnt:expand="false" cnt:fill="true">
+		<radiobutton cnt:v-align="0.5" cnt:v-fill="0" radiogroup="zoom" id="BTN_USER" _label="Variable"/>
+	    </align>
+	    <flow cnt:padding="10" cnt:expand="false"/>
+	    <metricfield id="ED_USER" value-step="1"
+			 repeat="true" has_border="true" spin="true"
+			 text="100%" unit="13" custom-unit-text="%"
+			 right="true"
+			 cnt:expand="false"/>
+	</hbox>
+        <fixedline cnt:padding="1" id="FL_BOTTOM"/>
+	<dialogbuttonhbox border="5" spacing="5">
+	    <flow/>
+	    <okbutton     id="BTN_ZOOM_OK"/>
+	    <cancelbutton id="BTN_ZOOM_CANCEL"/>
+	    <helpbutton   id="BTN_ZOOM_HELP"/>
+	</dialogbuttonhbox>
+    </vbox>
+</modaldialog>
cvs diff: Diffing transex3/prj
Index: transex3/prj/build.lst
===================================================================
RCS file: /cvs/l10n/transex3/prj/build.lst,v
retrieving revision 1.5
retrieving revision 1.5.36.1
diff -p -u -u -p -b -w -B -r1.5 -r1.5.36.1
--- transex3/prj/build.lst	10 Jul 2007 15:44:22 -0000	1.5
+++ transex3/prj/build.lst	11 Feb 2008 15:33:49 -0000	1.5.36.1
@@ -2,5 +2,6 @@ tr	transex3	:	tools NULL
 tr	transex3						usr1	-	all	tr_mkout NULL
 tr	transex3\inc					nmake	-	all	tr_inc NULL
 tr	transex3\source					nmake	-	all	tr_src tr_inc NULL
+tr	transex3\layout					nmake	-	all	rt_layout tr_src tr_inc NULL
 tr	transex3\java\l10nconv			nmake	-	all	tr_conv NULL
 tr	transex3\java\receditor			nmake	-	all	tr_rece NULL
Index: transex3/prj/d.lst
===================================================================
RCS file: /cvs/l10n/transex3/prj/d.lst,v
retrieving revision 1.27
retrieving revision 1.27.20.2
diff -p -u -u -p -b -w -B -r1.27 -r1.27.20.2
--- transex3/prj/d.lst	1 Nov 2007 18:41:01 -0000	1.27
+++ transex3/prj/d.lst	12 Feb 2008 09:58:28 -0000	1.27.20.2
@@ -18,6 +18,8 @@ mkdir: %_DEST%\inc%_EXT%\transex3
 ..\%__SRC%\bin\ulfex %_DEST%\bin%_EXT%\ulfex
 ..\%__SRC%\bin\txtconv.exe %_DEST%\bin%_EXT%\txtconv.exe
 ..\%__SRC%\bin\txtconv %_DEST%\bin%_EXT%\txtconv
+..\%__SRC%\bin\tralay.exe %_DEST%\bin%_EXT%\tralay.exe
+..\%__SRC%\bin\tralay %_DEST%\bin%_EXT%\tralay
 
 ..\%__SRC%\class\converter\converter.jar %_DEST%\bin%_EXT%\converter.jar
 ..\%__SRC%\doc\converter_javadoc.zip %_DEST%\bin%_EXT%\converter_javadoc.zip
@@ -30,6 +32,7 @@ mkdir: %_DEST%\inc%_EXT%\transex3
 ..\inc\export.hxx %_DEST%\inc%_EXT%\transex3\export.hxx
 ..\inc\transex3\directory.hxx %_DEST%\inc%_EXT%\transex3\directory.hxx
 ..\inc\transex3\file.hxx %_DEST%\inc%_EXT%\transex3\file.hxx
+..\inc\transex3\vosapp.hxx %_DEST%\inc%_EXT%\transex3\vosapp.hxx
 
 ..\inc\utf8conv.hxx %_DEST%\inc%_EXT%\transex3\utf8conv.hxx
 ..\%__SRC%\lib\transex.lib %_DEST%\lib%_EXT%\transex.lib
cvs diff: Diffing transex3/scripts
cvs diff: Diffing transex3/source
Index: transex3/source/helpex.cxx
===================================================================
RCS file: /cvs/l10n/transex3/source/helpex.cxx,v
retrieving revision 1.11
retrieving revision 1.11.36.1
diff -p -u -u -p -b -w -B -r1.11 -r1.11.36.1
--- transex3/source/helpex.cxx	27 Jun 2007 17:53:46 -0000	1.11
+++ transex3/source/helpex.cxx	11 Feb 2008 15:33:50 -0000	1.11.36.1
@@ -247,7 +247,7 @@ int _cdecl main( int argc, char *argv[] 
 			hasNoError = aParser.Merge( sSDFFile, sOutputFile , Export::sLanguages , aMergeDataFile );
 		}
 		else
-			hasNoError = aParser.CreateSDF( sOutputFile, sPrj, sPrjRoot );
+			hasNoError = aParser.CreateSDF( sOutputFile, sPrj, sPrjRoot, sInputFile, new XMLFile( '0' ), "help" );
 	}else if ( sOutputFileX.Len() && sOutputFileY.Len() && hasInputList ) {  // Merge multiple files ?
 		if ( bMergeMode ){
             
Index: transex3/source/helpmerge.cxx
===================================================================
RCS file: /cvs/l10n/transex3/source/helpmerge.cxx,v
retrieving revision 1.18
retrieving revision 1.18.12.1
diff -p -u -u -p -b -w -B -r1.18 -r1.18.12.1
--- transex3/source/helpmerge.cxx	17 Dec 2007 15:01:05 -0000	1.18
+++ transex3/source/helpmerge.cxx	11 Feb 2008 15:33:50 -0000	1.18.12.1
@@ -124,9 +124,10 @@ HelpParser::HelpParser( const ByteString
 /*****************************************************************************/
 bool HelpParser::CreateSDF(
 /*****************************************************************************/
-	const ByteString &rSDFFile_in, const ByteString &rPrj_in,const ByteString &rRoot_in ){
+	const ByteString &rSDFFile_in, const ByteString &rPrj_in,const ByteString &rRoot_in,
+    const ByteString &sHelpFile, XMLFile *pXmlFile, const ByteString &rGsi1){
     // GSI File constants
-    static const String GSI_SEQUENCE1( String::CreateFromAscii("\t0\thelp\t")	);
+    static const String GSI_SEQUENCE1( String::CreateFromAscii("\t0\t")	);
     static const String GSI_SEQUENCE2( String::CreateFromAscii("\t\t\t0\t")		);
     static const String GSI_TAB      ( String::CreateFromAscii("\t")			);
     static const String GSI_SEQUENCE4( String::CreateFromAscii("\t\t\t\t")		);
@@ -153,7 +154,7 @@ bool HelpParser::CreateSDF(
     }
 
 
-    std::auto_ptr <XMLFile> file ( aParser.Execute( sXmlFile ) );
+    std::auto_ptr <XMLFile> file ( aParser.Execute( sXmlFile, pXmlFile ) );
 
 	if(file.get() == NULL){
 		printf("%s\n",ByteString(aParser.GetError().sMessage,RTL_TEXTENCODING_ASCII_US).GetBuffer());
@@ -195,6 +196,7 @@ bool HelpParser::CreateSDF(
     OUStringBuffer sBuffer;
     const OUString sOUPrj( rPrj_in.GetBuffer() , rPrj_in.Len() , RTL_TEXTENCODING_ASCII_US );
     const OUString sOUActFileName(sActFileName.GetBuffer() , sActFileName.Len() , RTL_TEXTENCODING_ASCII_US );
+    const OUString sOUGsi1( rGsi1.GetBuffer() , rGsi1.Len() , RTL_TEXTENCODING_ASCII_US );
 
     Export::InitLanguages( false );
     std::vector<ByteString> aLanguages = Export::GetLanguages();
@@ -230,7 +232,9 @@ bool HelpParser::CreateSDF(
                 sBuffer.append( GSI_TAB );				//"\t";
                 if ( rRoot_in.Len())
 					sBuffer.append( sOUActFileName );
-   				sBuffer.append( GSI_SEQUENCE1 );		//"\t0\thelp\t";
+   				sBuffer.append( GSI_SEQUENCE1 );		//"\t0\t";
+   				sBuffer.append( sOUGsi1 );		        //"help";
+   				sBuffer.append( GSI_TAB );              //"\t";
                 ByteString sID = posm->first;			// ID
                 sBuffer.append( OUString( sID.GetBuffer() , sID.Len() , RTL_TEXTENCODING_UTF8 ) );
                 sBuffer.append( GSI_TAB ); //"\t";
@@ -289,7 +293,7 @@ bool HelpParser::Merge( const ByteString
 
     OUString sOUHelpFile( sXmlFile );
 	
-	XMLFile* xmlfile = ( aParser.Execute( sOUHelpFile ) );
+	XMLFile* xmlfile = ( aParser.Execute( sOUHelpFile, new XMLFile( '0' ) ) );
 	printf("Dest file %s\n",rDestinationFile.GetBuffer());
 	hasNoError = MergeSingleFile( xmlfile , aMergeDataFile , sLanguage , rDestinationFile );
 	delete xmlfile;
@@ -371,7 +375,7 @@ bool HelpParser::Merge(
 
 	
 	OUString sOUHelpFile( sXmlFile );
-	XMLFile* xmlfile = ( aParser.Execute( sOUHelpFile ) );
+	XMLFile* xmlfile = ( aParser.Execute( sOUHelpFile, new XMLFile( '0' ) ) );
 	xmlfile->Extract();
 
 	if( xmlfile == NULL)
Index: transex3/source/xmlparse.cxx
===================================================================
RCS file: /cvs/l10n/transex3/source/xmlparse.cxx,v
retrieving revision 1.19
retrieving revision 1.19.28.1
diff -p -u -u -p -b -w -B -r1.19 -r1.19.28.1
--- transex3/source/xmlparse.cxx	20 Sep 2007 15:03:16 -0000	1.19
+++ transex3/source/xmlparse.cxx	11 Feb 2008 15:33:50 -0000	1.19.28.1
@@ -230,6 +230,14 @@ void XMLParentNode::RemoveAndDeleteAllCh
 }
 
 /*****************************************************************************/
+void XMLParentNode::RemoveAndDeleteChildList(){	
+/*****************************************************************************/
+	RemoveAndDeleteAllChilds();
+    delete pChildList;
+    pChildList = NULL;
+}
+
+/*****************************************************************************/
 XMLElement *XMLParentNode::GetChildElement( XMLElement *pRefElement )
 /*****************************************************************************/
 {
@@ -1203,7 +1211,7 @@ void SimpleXMLParser::Default( 
 }
 
 /*****************************************************************************/
-XMLFile *SimpleXMLParser::Execute( const String &rFileName )
+XMLFile *SimpleXMLParser::Execute( const String &rFileName, XMLFile* pXMLFileIn )
 /*****************************************************************************/
 {
 //	printf("DBG: SimpleXMLParser::Execute( %s )", ByteString( rFileName , RTL_TEXTENCODING_ASCII_US ).GetBuffer() );
@@ -1224,7 +1232,8 @@ XMLFile *SimpleXMLParser::Execute( const
 
 	aStream.Close();
 
-	pXMLFile = new XMLFile( rFileName );
+    pXMLFile = pXMLFileIn;
+    pXMLFile->SetName( rFileName );
 
 	return Execute( &aMemStream );
 }
@@ -1295,6 +1304,9 @@ XMLFile *SimpleXMLParser::Execute( SvMem
   			case XML_ERROR_EXTERNAL_ENTITY_HANDLING: aErrorInformation.sMessage += String::CreateFromAscii( "External entity handling" ); break;
   			case XML_ERROR_NOT_STANDALONE: aErrorInformation.sMessage += String::CreateFromAscii( "Not standalone" ); break;
             case XML_ERROR_NONE: break;
+            default:
+                break;
+
 		}
 		delete pXMLFile;
 		pXMLFile = NULL;
cvs diff: Diffing transex3/workbench
