--- vcl/unx/gtk/app/gtkdata.cxx	2005-04-12 13:56:50.484872000 +0200
+++ vcl/unx/gtk/app/gtkdata.cxx	2005-04-14 13:43:18.707721950 +0200
@@ -117,7 +117,7 @@ GtkSalDisplay::GtkSalDisplay( GdkDisplay
 {
 	for(int i = 0; i < POINTER_COUNT; i++)
 		m_aCursors[ i ] = NULL;
-	Init ( aCol, pVis );
+	Init ( aCol, pVis, false );
 }
 
 GtkSalDisplay::~GtkSalDisplay()
--- vcl/unx/gtk/app/makefile.mk	2005-01-13 19:09:09.000000000 +0100
+++ vcl/unx/gtk/app/makefile.mk	2005-04-14 16:05:38.468618018 +0200
@@ -93,11 +93,6 @@ SLOFILES=\
 			$(SLO)$/gtkinst.obj	\
 			$(SLO)$/gtksys.obj
 
-.IF "$(WITH_LIBSN)"=="YES"
-CDEFS+=-DHAVE_LIBSN
-CFLAGS+=$(LIBSN_CFLAGS)
-.ENDIF
-
 .ELSE # "$(ENABLE_GTK)" != ""
 
 dummy:
--- vcl/unx/inc/plugins/kde/kdedata.hxx	2004-09-08 17:36:57.000000000 +0200
+++ vcl/unx/inc/plugins/kde/kdedata.hxx	2005-04-14 14:06:06.744602944 +0200
@@ -78,6 +78,13 @@ public:
     virtual void deInitNWF();
 };
 
+class SalKDEDisplay : public SalX11Display
+{
+public:
+    SalKDEDisplay( Display* pDisp, Visual* pVisual = NULL, Colormap aColMap = None );
+    virtual ~SalKDEDisplay();
+};
+
 class KDESalFrame : public X11SalFrame
 {
     static const int nMaxGraphics = 2;
@@ -95,9 +102,9 @@ class KDESalFrame : public X11SalFrame
     GraphicsHolder m_aGraphics[ nMaxGraphics ];
 
 public:
-	KDESalFrame( SalFrame* pParent, ULONG nStyle ) :
-			X11SalFrame( pParent, nStyle ) {}
+	KDESalFrame( SalFrame* pParent, ULONG nStyle );
 	virtual ~KDESalFrame();
+
     virtual SalGraphics* GetGraphics();
 	virtual void ReleaseGraphics( SalGraphics *pGraphics );
     virtual void UpdateSettings( AllSettings& rSettings );
@@ -112,4 +119,12 @@ public:
     virtual SalFrame* CreateFrame( SalFrame* pParent, ULONG nStyle );
 };
 
+class KDEXLib : public SalXLib
+{
+public:
+	KDEXLib() : SalXLib() {}
+	virtual ~KDEXLib() {}
+    virtual void Init();
+};
+
 #endif // _VCL_KDEDATA_HXX
--- vcl/unx/inc/saldisp.hxx	2005-03-18 18:53:56.000000000 +0100
+++ vcl/unx/inc/saldisp.hxx	2005-04-14 13:24:04.992821266 +0200
@@ -419,7 +419,7 @@ public:
     void					setHaveSystemChildFrame() const 
     { pXLib_->setHaveSystemChildFrame(); }
 
-    void			Init( Colormap hXColmap, Visual *pVisual );
+    void			Init( Colormap hXColmap, Visual *pVisual, bool bHandleStartupNotification = true );
     
     void			SendInternalEvent( SalFrame* pFrame, void* pData, USHORT nEvent = SALEVENT_USEREVENT );
     bool			DispatchInternalEvent();
@@ -529,7 +529,8 @@ class VCL_DLLPUBLIC SalX11Display : publ
 public:
 		     SalX11Display( Display* pDisp,
 						 Visual* pVisual = NULL,
-						 Colormap aColMap = None );
+						 Colormap aColMap = None,
+						 bool bHandleStartupNotification = true );
     virtual ~SalX11Display();
 
     virtual long		Dispatch( XEvent *pEvent );
--- vcl/unx/kde/kdedata.cxx	2005-04-12 13:57:06.153210000 +0200
+++ vcl/unx/kde/kdedata.cxx	2005-04-14 15:33:49.018469869 +0200
@@ -112,16 +112,22 @@
 #endif
 
 /***************************************************************************
- * class KDEXLib                                                           *
+ * class SalKDEDisplay                                                     *
  ***************************************************************************/
 
-class KDEXLib : public SalXLib
+SalKDEDisplay::SalKDEDisplay( Display* pDisp, Visual* pVisual, Colormap aColMap )
+    : SalX11Display( pDisp, pVisual, aColMap, false )
+{
+}
+
+SalKDEDisplay::~SalKDEDisplay()
 {
-public:
-	KDEXLib() : SalXLib() {}
-	virtual ~KDEXLib() {}
-    virtual void Init();
-};
+    KStartupInfo::appStarted();
+}
+
+/***************************************************************************
+ * class KDEXLib                                                           *
+ ***************************************************************************/
 
 void KDEXLib::Init()
 {
@@ -174,41 +180,16 @@ void KDEXLib::Init()
 
 	KCmdLineArgs::init( nFakeArgc, pFakeArgv, kAboutData );
 
-	// Do not let KApplication eat the DESKTOP_STARTUP_ID
-	char *pDesktopStartupId = NULL;
-	char *pEnv = getenv( "DESKTOP_STARTUP_ID" );
-	if ( pEnv )
-	{
-		pDesktopStartupId = strdup( pEnv );
-		unsetenv( "DESKTOP_STARTUP_ID" );
-	}
-
 	KApplication::disableAutoDcopRegistration();
-	KStartupInfo::disableAutoAppStartedSending();
 	new KApplication();
 	
-	// Now set DESKTOP_STARTUP_ID for the VCL initialization
-	if ( pDesktopStartupId )
-	{
-		setenv( "DESKTOP_STARTUP_ID", pDesktopStartupId, 1 );
-		free( pDesktopStartupId );
-	}
-
-    Display* pDisp = QPaintDevice::x11AppDisplay();
-	XVisualInfo aVI;
-	Colormap	aColMap;
-	int 		nScreen = DefaultScreen( pDisp );
-	if( SalDisplay::BestVisual( pDisp, nScreen, aVI ) ) // DefaultVisual
-		aColMap = DefaultColormap( pDisp, nScreen );
-	else
-		aColMap = XCreateColormap( pDisp,
-								   RootWindow( pDisp, nScreen ),
-								   aVI.visual,
-								   AllocNone );
+	Display* pDisp = QPaintDevice::x11AppDisplay();
 
-	SalDisplay *pSalDisplay = new SalX11Display( pDisp, aVI.visual, aColMap );
+	SalDisplay *pSalDisplay = new SalKDEDisplay( pDisp,
+			static_cast< Visual * >( QPaintDevice::x11AppVisual() ),
+			QPaintDevice::x11AppColormap() );
 
-    pInputMethod->CreateMethod( pDisp );
+	pInputMethod->CreateMethod( pDisp );
 	pInputMethod->AddConnectionWatch( pDisp, (void*)this );
 	pSalDisplay->SetInputMethod( pInputMethod );
 
--- vcl/unx/kde/salnativewidgets-kde.cxx	2005-04-12 13:57:06.109218000 +0200
+++ vcl/unx/kde/salnativewidgets-kde.cxx	2005-04-14 15:34:06.012524206 +0200
@@ -94,6 +94,7 @@
 #include <kglobal.h>
 #include <kmainwindow.h>
 #include <kmenubar.h>
+#include <kstartupinfo.h>
 #include <kstyle.h>
 
 #undef Region
@@ -1711,6 +1712,13 @@ BOOL KDESalGraphics::getNativeControlReg
 // KDESalFrame implementation
 // -----------------------------------------------------------------------
 
+KDESalFrame::KDESalFrame( SalFrame* pParent, ULONG nStyle ) :
+    X11SalFrame( pParent, nStyle )
+{
+    if ( !pParent )
+        KStartupInfo::appStarted();
+}
+
 /** Helper function to convert colors.
 */
 static Color toColor( const QColor &rColor )
--- vcl/unx/source/app/saldisp.cxx	2005-03-29 15:00:57.000000000 +0200
+++ vcl/unx/source/app/saldisp.cxx	2005-04-14 13:41:54.653227709 +0200
@@ -611,7 +611,9 @@ SalDisplay::SalDisplay( Display *display
 		mpFallbackFactory ( NULL ),
 		pDisp_( display ),
         hRefWindow_( None ),
-        m_pWMAdaptor( NULL )
+        m_pWMAdaptor( NULL ),
+        m_pSnDisplay( NULL ),
+        m_pSnLauncheeContext( NULL )
 {
 #if OSL_DEBUG_LEVEL > 1
     fprintf( stderr, "SalDisplay::SalDisplay()\n" );
@@ -664,7 +666,8 @@ void SalDisplay::doDestruct()
         sn_launchee_context_complete( m_pSnLauncheeContext );
         sn_launchee_context_unref( m_pSnLauncheeContext );
 	}
-    sn_display_unref( m_pSnDisplay );
+    if ( m_pSnDisplay )
+        sn_display_unref( m_pSnDisplay );
 #endif /* HAVE_LIBSN */
 
     if( IsDisplay() )
@@ -751,10 +754,10 @@ static int DisplayYield( int fd, SalX11D
   return TRUE;
 }
 
-SalX11Display::SalX11Display( Display *display, Visual *pVisual, Colormap aColMap )
+SalX11Display::SalX11Display( Display *display, Visual *pVisual, Colormap aColMap, bool bHandleStartupNotification )
 		: SalDisplay( display, aColMap )
 {
-    Init( aColMap, pVisual );
+    Init( aColMap, pVisual, bHandleStartupNotification );
 
 	pXLib_->Insert( ConnectionNumber( pDisp_ ),
 					this,
@@ -777,7 +780,7 @@ SalX11Display::~SalX11Display()
 }
 
 // -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
-void SalDisplay::Init( Colormap hXColmap, Visual *pVisual )
+void SalDisplay::Init( Colormap hXColmap, Visual *pVisual, bool bHandleStartupNotification )
 {
     XVisualInfo aXVI;
 
@@ -1173,13 +1176,16 @@ void SalDisplay::Init( Colormap hXColmap
     pIntegrator->Acquire();
 
 #ifdef HAVE_LIBSN
-    m_pSnDisplay = sn_display_new( pDisp_, SnErrorTrapPush, SnErrorTrapPop );
-    m_pSnLauncheeContext = sn_launchee_context_new_from_environment( m_pSnDisplay, nScreen_ );
+    if ( bHandleStartupNotification )
+    {
+        m_pSnDisplay = sn_display_new( pDisp_, SnErrorTrapPush, SnErrorTrapPop );
+        m_pSnLauncheeContext = sn_launchee_context_new_from_environment( m_pSnDisplay, nScreen_ );
 #  ifdef DBG_UTIL
-    if( !m_pSnLauncheeContext )
-         fprintf( stderr, "Failed to get launch feedback info from "
-		  "DESKTOP_LAUNCH_ID/DESKTOP_LAUNCH_WINDOW\n" );
+        if( !m_pSnLauncheeContext )
+            fprintf( stderr, "Failed to get launch feedback info from "
+                    "DESKTOP_LAUNCH_ID/DESKTOP_LAUNCH_WINDOW\n" );
 #  endif /* DBG_UTIL */
+    }
 #endif /* HAVE_LIBSN */
 
 #ifdef DBG_UTIL
@@ -2456,7 +2462,7 @@ void SalX11Display::Yield( BOOL bWait )
         m_pSnLauncheeContext = NULL;
     }
 
-    if( sn_display_process_event( m_pSnDisplay, &aEvent ) )
+    if( m_pSnDisplay && sn_display_process_event( m_pSnDisplay, &aEvent ) )
         return;
 #endif /* HAVE_LIBSN */
 
