--- svx/source/gallery2/galobj.cxx.old	2004-12-13 13:18:55.000000000 +0100
+++ svx/source/gallery2/galobj.cxx	2005-04-11 19:27:29.000000000 +0200
@@ -163,7 +163,7 @@
 
 // ------------------------------------------------------------------------
 
-void SgaObject::WriteData( SvStream& rOut ) const
+void SgaObject::WriteData( SvStream& rOut, const String& rDestDir ) const
 {
 	static const UINT32 nInventor = COMPAT_FORMAT( 'S', 'G', 'A', '3' );
 
@@ -186,7 +186,9 @@
 	else
 		rOut << aThumbMtf;
 
-	rOut << ByteString( String(aURL.GetMainURL( INetURLObject::NO_DECODE )), RTL_TEXTENCODING_UTF8 );
+	String aURLWithoutDestDir = String(aURL.GetMainURL( INetURLObject::NO_DECODE ));
+	aURLWithoutDestDir.SearchAndReplace(rDestDir, String());
+	rOut << ByteString( aURLWithoutDestDir, RTL_TEXTENCODING_UTF8 );
 }
 
 // ------------------------------------------------------------------------
@@ -253,7 +255,7 @@
 
 SvStream& operator<<( SvStream& rOut, const SgaObject& rObj )
 {
-	rObj.WriteData( rOut );
+	rObj.WriteData( rOut, String() );
 	return rOut;
 }
 
@@ -306,13 +308,13 @@
 
 // ------------------------------------------------------------------------
 
-void SgaObjectBmp::WriteData( SvStream& rOut ) const
+void SgaObjectBmp::WriteData( SvStream& rOut, const String& rDestDir ) const
 {
 	String	aDummyStr;
 	char	aDummy[ 10 ];
 
 	// Version setzen
-	SgaObject::WriteData( rOut );
+	SgaObject::WriteData( rOut, rDestDir );
 	rOut.Write( aDummy, 10 );
 	rOut << ByteString( aDummyStr, RTL_TEXTENCODING_UTF8 ) << ByteString( aTitle, RTL_TEXTENCODING_UTF8 );
 }
@@ -393,9 +395,9 @@
 
 // ------------------------------------------------------------------------
 
-void SgaObjectSound::WriteData( SvStream& rOut ) const
+void SgaObjectSound::WriteData( SvStream& rOut, const String& rDestDir ) const
 {
-	SgaObject::WriteData( rOut );
+	SgaObject::WriteData( rOut, rDestDir );
 	rOut << (UINT16) eSoundType << ByteString( aTitle, RTL_TEXTENCODING_UTF8 );
 }
 
@@ -567,9 +569,9 @@
 
 // ------------------------------------------------------------------------
 
-void SgaObjectSvDraw::WriteData( SvStream& rOut ) const
+void SgaObjectSvDraw::WriteData( SvStream& rOut, const String& rDestDir ) const
 {
-	SgaObject::WriteData( rOut );
+	SgaObject::WriteData( rOut, rDestDir );
 	rOut << ByteString( aTitle, RTL_TEXTENCODING_UTF8 );
 }
 
--- svx/inc/galobj.hxx.old	2004-02-03 18:25:18.000000000 +0100
+++ svx/inc/galobj.hxx	2005-04-11 18:33:02.000000000 +0200
@@ -134,7 +134,7 @@
 	BOOL					bIsValid;
 	BOOL					bIsThumbBmp;
 
-	virtual void 			WriteData( SvStream& rOut ) const;
+	virtual void 			WriteData( SvStream& rOut, const String& rDestDir ) const;
 	virtual void 			ReadData( SvStream& rIn, UINT16& rReadVersion );
 
 	BOOL					CreateThumb( const Graphic& rGraphic );
@@ -170,7 +170,7 @@
 
 	GalSoundType		eSoundType;
 
-	virtual void 		WriteData( SvStream& rOut ) const;
+	virtual void		WriteData( SvStream& rOut, const String& rDestDir ) const;
 	virtual void 		ReadData( SvStream& rIn, UINT16& rReadVersion );
 
 	virtual UINT16		GetVersion() const { return 6; }
@@ -198,7 +198,7 @@
 
 	BOOL				CreateThumb( const FmFormModel& rModel );
 
-	virtual void 		WriteData( SvStream& rOut ) const;
+	virtual void		WriteData( SvStream& rOut, const String& rDestDir ) const;
 	virtual void 		ReadData( SvStream& rIn, UINT16& rReadVersion );
 
 	virtual UINT16		GetVersion() const { return 5; }
@@ -227,7 +227,7 @@
 
 	void				Init( const Graphic& rGraphic, const INetURLObject& rURL );
 
-	virtual void   		WriteData( SvStream& rOut ) const;
+	virtual void		WriteData( SvStream& rOut, const String& rDestDir ) const;
 	virtual void   		ReadData( SvStream& rIn, UINT16& rReadVersion );
 
 	virtual UINT16		GetVersion() const { return 5; }
--- svx/source/gallery2/galtheme.cxx.old	2005-01-11 14:00:56.000000000 +0100
+++ svx/source/gallery2/galtheme.cxx	2005-04-11 19:54:30.000000000 +0200
@@ -159,7 +159,7 @@
 	{
 		const sal_uInt32 nOffset = pOStm->Seek( STREAM_SEEK_TO_END );
 
-		*pOStm << rObj;
+		rObj.WriteData( *pOStm, m_aDestDir );
 
 		if( !pOStm->GetError() )
 		{
@@ -1423,7 +1423,8 @@
 					aPath = pObj->aURL.GetMainURL( INetURLObject::NO_DECODE );
 			}
 		}
-
+		
+		aPath.SearchAndReplace(m_aDestDir, String());
 		rOStm << bRel << ByteString( aPath, RTL_TEXTENCODING_UTF8 ) << pObj->nOffset << (sal_uInt16) pObj->eObjKind;
 	}
 
--- svx/inc/galtheme.hxx.old	2005-01-21 15:42:45.000000000 +0100
+++ svx/inc/galtheme.hxx	2005-04-11 17:08:40.000000000 +0200
@@ -129,6 +129,7 @@
 
 	GalleryObjectList			aObjectList;
 	String						aImportName;
+	String						m_aDestDir;
 	SotStorageRef				aSvDrawStorageRef;
 	Gallery*					pParent;
 	GalleryThemeEntry*			pThm;
@@ -172,6 +173,9 @@
 	const String&				GetImportName() const { return aImportName; }
 	void						SetImportName(const String& rImportName) { aImportName = rImportName; }
 
+	const String&				GetDestDir() const { return m_aDestDir; }
+	void					SetDestDir(const String& rDestDir) { m_aDestDir = rDestDir; }
+
 	const INetURLObject&		GetThmURL() const { return pThm->GetThmURL(); }
 	const INetURLObject&		GetSdgURL() const { return pThm->GetSdgURL(); }
 	const INetURLObject&		GetSdvURL() const { return pThm->GetSdvURL(); }
--- svx/source/gengal/gengal.cxx.old	2005-04-12 12:17:34.000000000 +0200
+++ svx/source/gengal/gengal.cxx	2005-04-12 12:30:07.000000000 +0200
@@ -72,6 +72,7 @@
 
 static void createTheme( rtl::OUString aThemeName,
 						 rtl::OUString aGalleryURL,
+						 rtl::OUString aDestDir,
 						 FileNameList &rFiles )
 {
 	Gallery* pGallery;
@@ -107,6 +108,10 @@
 			exit( 1 );
 	}
 
+	fprintf( stderr, "Using DestDir: %s\n",
+			 (const sal_Char *) rtl::OUStringToOString( aDestDir, RTL_TEXTENCODING_UTF8 ) );
+	pGalTheme->SetDestDir(String(aDestDir));
+
 	FileNameList::const_iterator aIter;
 	
 	for( aIter = rFiles.begin(); aIter != rFiles.end(); aIter++ )
@@ -164,12 +169,16 @@
 {
 	fprintf( stdout, "Utility to generate OO.o gallery files\n\n" );
 	
-	fprintf( stdout, "using: gengal.bin --name <name> --path <dir> [ files ... ]\n\n");
+	fprintf( stdout, "using: gengal.bin --name <name> --path <dir> [--destdir <path>]\n");
+	fprintf( stdout, "                  [ files ... ]\n\n" );
 	
 	fprintf( stdout, "options:\n");
 	fprintf( stdout, " --name <theme>\t\tdefines a name of the created or updated theme.\n");
 	fprintf( stdout, " --path <dir>\t\tdefines directory where the gallery files are created\n");
 	fprintf( stdout, "\t\t\tor updated.\n");
+	fprintf( stdout, " --destdir <dir>\tdefines a path prefix to be removed from the paths\n");
+	fprintf( stdout, "\t\t\tstored in the gallery files. It is useful to create\n");
+	fprintf( stdout, "\t\t\tRPM packages using the BuildRoot feature.\n");
 	fprintf( stdout, " files\t\t\tlists files to be added to the gallery. Absolute paths\n");
 	fprintf( stdout, "\t\t\tare required.\n");
 }
@@ -238,7 +247,7 @@
 
 
 	bool bHelp = false;
-	rtl::OUString aPath;
+	rtl::OUString aPath, aDestDir;
 	rtl::OUString aName = rtl::OUString::createFromAscii( "Default name" );
 	FileNameList aFiles;
 
@@ -256,6 +265,9 @@
 		else if ( aParam.equalsAscii( "--path" ) )
 			aPath = Smartify( GetCommandLineParam( ++i ) );
 
+		else if ( aParam.equalsAscii( "--destdir" ) )
+			aDestDir = GetCommandLineParam( ++i );
+
 		else
 			aFiles.push_back( Smartify( aParam ) );
 	}
@@ -266,7 +278,7 @@
 		return;
 	}
 
-	createTheme( aName, aPath, aFiles );
+	createTheme( aName, aPath, aDestDir, aFiles );
 }
 
 GalApp aGalApp;
--- svx/source/gengal/gengal.sh	2005-04-08 17:30:28.000000000 +0200
+++ svx/source/gengal/gengalsh.new	2005-04-11 17:47:21.000000000 +0200
@@ -25,6 +25,7 @@
 # default setting
 GAL_NAME=
 GAL_PATH=
+GAL_DESTDIR=
 GAL_NUM=1
 GAL_FORCE=false
 
@@ -73,6 +74,10 @@
 		    exit 1;
 		fi
 		;;
+	"--destdir")
+		shift;
+		GAL_DESTDIR="$1"
+		;;
 	"--num")
 		shift;
 		GAL_NUM="$1"
@@ -129,7 +134,7 @@
 fi
 
 # create/update gallery
-"$0.bin" --name "$GAL_NAME" --path $GAL_TMP "$@" || clean_and_exit;
+"$0.bin" --name "$GAL_NAME" --path $GAL_TMP --destdir "$GAL_DESTDIR" "$@" || clean_and_exit;
 
 # if $GAL_TMP/sd2.sdg exists, it means that the older gallery cannot be updated
 # (used another name), so a new one was created instead
