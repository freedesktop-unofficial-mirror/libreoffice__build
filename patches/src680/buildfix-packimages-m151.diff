--- solenv/bin/packimages.pl	2006-01-09 16:13:34.000000000 +0100
+++ solenv/bin/packimages.pl	2006-01-09 16:42:14.000000000 +0100
@@ -103,19 +103,20 @@ sub parse_options
 {
     my $opt_help;
     my $p = Getopt::Long::Parser->new();
+    my @custom_path_list;
     my $success =$p->getoptions(
                              '-h' => \$opt_help, 
                              '-o=s' => \$out_file,
                              '-g=s' => \$global_path,
                              '-m=s' => \$module_path,
-                             '-c=s' => \@custom_path,
+                             '-c=s' => \@custom_path_list,
                              '-l=s' => \@imagelist_path,
                              '-v'   => \$verbose,
                              '-vv'  => \$extra_verbose
                             );
 
     if ( $opt_help || !$success || !$out_file || !$global_path 
-        || !$module_path || !@custom_path || !@imagelist_path ) 
+        || !$module_path || !@custom_path_list || !@imagelist_path ) 
     {
         usage();
         exit(1);
@@ -127,15 +128,27 @@ sub parse_options
 
     # Check if out_file can be written.
     my $out_dir = dirname($out_file);
-    print_error("no such directory: '$out_dir'", 2) if ! -d $out_dir;
-    print_error("can't search directory: '$out_dir'", 2) if ! -x $out_dir;
-    print_error("directory is not writable: '$out_dir'", 2) if ! -w $out_dir;
 
     # Check paths.
-    foreach ($global_path, $module_path, @custom_path, @imagelist_path) {
+    foreach ($out_dir, $global_path, $module_path, @imagelist_path) {
         print_error("no such directory: '$_'", 2) if ! -d $_;
         print_error("can't search directory: '$_'", 2) if ! -x $_;
     }
+    print_error("directory is not writable: '$out_dir'", 2) if ! -w $out_dir;
+
+    # Use just the working paths
+    @custom_path = ();
+    foreach (@custom_path_list) {
+        if ( ! -d $_ ) {
+            print_warning("skipping non-existing directory: '$_'", 2);
+        }
+        elsif ( ! -x $_ ) {
+            print_error("can't search directory: '$_'", 2);
+        }
+        else {
+            push @custom_path, $_;
+        }
+    }
 }
 
 sub get_image_lists
--- instsetoo_native/packimages/makefile.mk	2006-01-09 15:00:55.000000000 +0100
+++ instsetoo_native/packimages/makefile.mk	2006-01-09 16:29:48.000000000 +0100
@@ -47,7 +47,7 @@ IMAGES := $(COMMONBIN)$/images.zip
 CUSTOM_PREFERRED_FALLBACK=$(SOLARSRC)$/ooo_custom_images$/industrial
 CUSTOM_IMAGES=$(foreach,i,$(CUSTOM_IMAGE_SETS) images_$i)
 
-ALLTAR : $(IMAGES) $(SOLARSRC)$/ooo_custom_images$/hicontrast $(CUSTOM_IMAGES)
+ALLTAR : $(IMAGES) $(CUSTOM_IMAGES)
 
 $(RES)$/img$/commandimagelist.ilst .PHONY :
     +-$(MKDIR) $(RES)$/img
@@ -63,7 +63,11 @@ $(COMMONBIN)$/images.zip .PHONY: $(RES)$
     +$(PERL) $(SOLARENV)$/bin$/packimages.pl -g $(SOLARSRC)$/$(RSCDEFIMG) -m $(SOLARSRC)$/$(RSCDEFIMG) -c $(RSCCUSTOMIMG) -l $(SOLARCOMMONRESDIR)$/img -l $(RES)$/img -o $@
 
 images_% : $(RES)$/img$/commandimagelist.ilst
-    +$(PERL) $(SOLARENV)$/bin$/packimages.pl -g $(SOLARSRC)$/$(RSCDEFIMG) -m $(SOLARSRC)$/$(RSCDEFIMG) -c $(RSCCUSTOMIMG) -c $(SOLARSRC)$/ooo_custom_images/$(@:s/images_//) -c $(CUSTOM_PREFERRED_FALLBACK) -l $(SOLARCOMMONRESDIR)$/img -l $(RES)$/img -o $(COMMONBIN)$/$@.zip
+    +$(PERL) $(SOLARENV)$/bin$/packimages.pl -g $(SOLARSRC)$/$(RSCDEFIMG) -m $(SOLARSRC)$/$(RSCDEFIMG) -c $(RSCCUSTOMIMG) -c $(SOLARSRC)$/ooo_custom_images$/$(@:s/images_//) -c $(MISC)$/$(@:s/images_//) -c $(CUSTOM_PREFERRED_FALLBACK) -l $(SOLARCOMMONRESDIR)$/img -l $(RES)$/img -o $(COMMONBIN)$/$@.zip
 
-$(SOLARSRC)$/ooo_custom_images$/hicontrast : $(RES)$/img$/commandimagelist.ilst
-    +$(PERL) $(SOLARENV)$/bin$/hicontrast-to-theme.pl $(SOLARSRC)$/default_images $@
+# generate the hicontrast icon set
+$(MISC)$/hicontrast.flag : $(RES)$/img$/commandimagelist.ilst
+    +$(PERL) $(SOLARENV)$/bin$/hicontrast-to-theme.pl $(SOLARSRC)$/default_images $(MISC)$/hicontrast && touch $@
+
+# dependency
+images_hicontrast : $(MISC)$/hicontrast.flag
