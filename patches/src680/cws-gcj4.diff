Index: config_office/configure.in
===================================================================
RCS file: /cvs/tools/config_office/configure.in,v
retrieving revision 1.111
retrieving revision 1.111.4.1
diff -u -u -r1.111 -r1.111.4.1
--- config_office/configure.in	23 Mar 2005 08:46:00 -0000	1.111
+++ config_office/configure.in	1 Apr 2005 08:51:03 -0000	1.111.4.1
@@ -1850,6 +1850,26 @@
 AC_SUBST(JAVACOMPILER)
 AC_SUBST(JAVADOC)
 
+dnl ===================================================================
+dnl Check for optional gcj-dbtool
+dnl ===================================================================
+if test "$JDK" == "gcj"; then 
+    javacache=`echo $WITH_JAVA | $SED -e "s/gij/gcj-dbtool/g"`
+    if test -z "$with_jdk_home"; then
+        AC_PATH_PROG(JAVACACHE, $javacache)
+    else
+        _javac_path="$with_jdk_home/bin/$javacache"
+        dnl Check if there is a gcj-dbtool at all.
+        if test -x "$_javac_path"; then
+            JAVACACHE=$_javac_path
+        fi
+    fi
+    if test -z "$JAVACACHE"; then
+      AC_MSG_WARN([$javacache not found set with_jdk_home])
+    fi
+fi
+AC_SUBST(JAVACACHE)
+
 if test "$NEEDXSLTPROC" = "no"; then
    XSLTPROC=NO_XSLTPROC
 else
Index: config_office/set_soenv.in
===================================================================
RCS file: /cvs/tools/config_office/set_soenv.in,v
retrieving revision 1.54
retrieving revision 1.54.8.1
diff -u -u -r1.54 -r1.54.8.1
--- config_office/set_soenv.in	15 Mar 2005 09:46:44 -0000	1.54
+++ config_office/set_soenv.in	1 Apr 2005 08:51:03 -0000	1.54.8.1
@@ -78,7 +78,7 @@
      $UPD, $SOLARUPD, $WORK_STAMP, $TF_ONE51, $TF_UCB, 
      $URD_ONLY, $SOLARROOT, $SOLARSRC, $DEVROOT, $SOLARVER, $SOLARVERSION, $SOLARENV, 
      $STAR_INIROOT, $STAR_INIROOTOLD, $STAR_STANDLST, $STAR_SSCOMMON, $STAR_SSOLARINI, 
-     $STAR_REGISTRY, $STAR_RESOURCEPATH, $DMAKEROOT, $CLASSPATH, $XCLASSPATH, $COMPATH, 
+     $STAR_REGISTRY, $STAR_RESOURCEPATH, $DMAKEROOT, $CLASSPATH, $XCLASSPATH, $COMPATH, $GCJ_DATABASE,
      $MSPDB_PATH, $MIDL_PATH, $CSC_PATH, $NMAKE_PATH, 
      $LD_LIBRARY_PATH, $PATH, $SOLARDEF, $SOLAREXTRAINC, $SOLAREXTRALIB, $SOLARLIB, 
      $SOLARINC, $LOCALINI, $PATHEXTRA, $FRAMEWORKSHOME, $COMEX, $MULTITHREAD_OBJ, $PERL, 
@@ -848,6 +848,8 @@
 # Location of the JDK supported standard classes.zip file.
 # see above for why the change
 $XCLASSPATH           = '$JAVA_HOME'.$ds.'jre'.$LIB.$ds."rt.jar".$ps.'.';
+# Localtion of gcj cache
+$GCJ_DATABASE = '$SOLARVER'.$ds.'$UPD'.$ds.'$INPATH'.$LIB.$ds."openoffice.org.gcjdb";
 
 # Paths to run time shared libraries.
 if ($platform =~ m/solaris/) 
@@ -1585,6 +1587,10 @@
 if ( $JDK ne "gcj" ) {
    ToFile( "CLASSPATH",         $CLASSPATH,         "e" );
    ToFile( "XCLASSPATH",        $XCLASSPATH,        "e" );
+}
+else {
+   ToFile( "GCJ_DATABASE",     $GCJ_DATABASE,       "e" );
+   ToFile( "JAVACACHE",        '@JAVACACHE@',       "e" );
 }
 if ( $platform =~ m/darwin/ )
 {  ToFile( "DYLD_LIBRARY_PATH", $LD_LIBRARY_PATH,   "e" );
Index: rhino/makefile.mk
===================================================================
RCS file: /cvs/external/rhino/makefile.mk,v
retrieving revision 1.4
retrieving revision 1.4.6.1
diff -u -u -r1.4 -r1.4.6.1
--- rhino/makefile.mk	1 Mar 2005 13:11:19 -0000	1.4
+++ rhino/makefile.mk	4 Apr 2005 08:06:12 -0000	1.4.6.1
@@ -66,11 +66,6 @@
 TARGET=ooo_rhino
 
 .IF "$(SOLAR_JAVA)"!=""
-.IF "$(JDK)" == "gcj"
-all:
-        @echo This dir cannot be build with gcj because of javax.swing.JTextArea.replaceRange
-.ELSE
-
 # --- Settings -----------------------------------------------------
 
 .INCLUDE :	settings.mk
@@ -89,7 +84,6 @@
 .INCLUDE : target.mk
 .INCLUDE : tg_ext.mk
 
-.ENDIF
 .ELSE
 all:
         @echo java disabled
Index: scp2/source/ooo/file_ooo.scp
===================================================================
RCS file: /cvs/installation/scp2/source/ooo/file_ooo.scp,v
retrieving revision 1.77
retrieving revision 1.77.2.1
diff -u -u -r1.77 -r1.77.2.1
--- scp2/source/ooo/file_ooo.scp	23 Mar 2005 11:07:04 -0000	1.77
+++ scp2/source/ooo/file_ooo.scp	4 Apr 2005 08:20:10 -0000	1.77.2.1
@@ -666,10 +666,8 @@
 #endif
 
 #ifdef SOLAR_JAVA
-#ifndef GCJ
 STD_JAR_FILE( gid_File_Jar_Js, js )
 #endif
-#endif
 
 #ifdef SOLAR_JAVA
 
@@ -768,27 +766,10 @@
 #endif
 
 #ifdef SOLAR_JAVA
-#ifndef GCJ
 UNO_JAR_FILE( gid_File_Jar_Scriptframework, ScriptFramework )
-#endif
-#endif
-
-#ifdef SOLAR_JAVA
-#ifndef GCJ
 UNO_JAR_FILE( gid_File_Jar_Scriptproviderforbeanshell, ScriptProviderForBeanShell )
-#endif
-#endif
-
-#ifdef SOLAR_JAVA
-#ifndef GCJ
 UNO_JAR_FILE( gid_File_Jar_Scriptproviderforjava, ScriptProviderForJava )
-#endif
-#endif
-
-#ifdef SOLAR_JAVA
-#ifndef GCJ
 UNO_JAR_FILE( gid_File_Jar_Scriptproviderforjavascript, ScriptProviderForJavaScript )
-#endif
 #endif
 
 #ifdef SOLAR_JAVA
Index: scp2/source/ooo/makefile.mk
===================================================================
RCS file: /cvs/installation/scp2/source/ooo/makefile.mk,v
retrieving revision 1.27
retrieving revision 1.27.2.1
diff -u -u -r1.27 -r1.27.2.1
--- scp2/source/ooo/makefile.mk	18 Mar 2005 10:32:46 -0000	1.27
+++ scp2/source/ooo/makefile.mk	4 Apr 2005 08:20:10 -0000	1.27.2.1
@@ -146,10 +146,6 @@
 SCPDEFS+=-DSYSTEM_PORTAUDIO
 .ENDIF
 
-.IF "$(JDK)" == "gcj"
-SCPDEFS+=-DGCJ
-.ENDIF
-
 SCPDEFS+=\
     -DICU_MAJOR=$(ICU_MAJOR) \
     -DICU_MINOR=$(ICU_MINOR) \
Index: scripting/java/makefile.mk
===================================================================
RCS file: /cvs/framework/scripting/java/makefile.mk,v
retrieving revision 1.4
retrieving revision 1.4.12.1
diff -u -u -r1.4 -r1.4.12.1
--- scripting/java/makefile.mk	25 Jan 2005 15:09:31 -0000	1.4
+++ scripting/java/makefile.mk	4 Apr 2005 08:10:29 -0000	1.4.12.1
@@ -67,10 +67,5 @@
 .INCLUDE : ant.mk
 
 .IF "$(SOLAR_JAVA)"!=""
-.IF "$(JDK)"=="gcj"
-all:
-	@echo This dir cannot be build with gcj because of org.mozilla.javascript.EcmaError
-.ELSE
 ALLTAR : ANTBUILD
-.ENDIF
 .ENDIF
Index: solenv/bin/deliver.pl
===================================================================
RCS file: /cvs/tools/solenv/bin/deliver.pl,v
retrieving revision 1.79
retrieving revision 1.79.4.2
diff -u -u -r1.79 -r1.79.4.2
--- solenv/bin/deliver.pl	23 Mar 2005 15:58:37 -0000	1.79
+++ solenv/bin/deliver.pl	1 Apr 2005 14:32:21 -0000	1.79.4.2
@@ -712,6 +712,15 @@
     return '';
 }
 
+sub is_jar {
+    my $file_name = shift;
+
+    if (-f $file_name && (( `file $file_name` ) =~ /Zip archive/o)) {
+        return '1' if ($file_name =~ /\.jar\.*/o);
+    };
+    return '';
+}
+
 sub execute_system {
     my $command = shift;
     if (system($command)) {
@@ -728,6 +737,16 @@
     return $rc;
 };
 
+sub cachejar {
+    my $file = shift;
+    my $to = $file.".so";
+    print "CACHEJAR: $file -> $to with $ENV{GCJ_DATABASE}\n";
+    print "Caching 1/2: $ENV{JAVACOMPILER} -shared -fPIC -Wl,-Bsymbolic -O2 -findirect-dispatch -fjni -o $to $file\n";
+    system("$ENV{JAVACOMPILER} -shared -fPIC -Wl,-Bsymbolic -O2 -findirect-dispatch -fjni -o $to $file");
+    print "Caching 2/2: $ENV{JAVACACHE} -a $ENV{GCJ_DATABASE} $file $to\n";
+    system("$ENV{JAVACACHE} -a $ENV{GCJ_DATABASE} $file $to");
+};
+
 sub copy_if_newer 
 {
     # return 0 if file is unchanged ( for whatever reason )
@@ -754,6 +773,9 @@
         # hard link if possible
         if( link($from, $to) ){
             print "LINK: $from -> $to\n";
+            if ($ENV{JDK} eq 'gcj' && is_jar($from)) {
+                cachejar($to);
+            }
             return 1;
         }
     }
@@ -787,6 +809,9 @@
         fix_file_permissions($$from_stat_ref[2], $temp_file);
         $rc = rename($temp_file, $to);
         if ( $rc ) {
+            if ($ENV{JDK} eq 'gcj' && is_jar($from)) {
+                cachejar($to);
+            }
             # handle special packaging of *.dylib files for Mac OS X
             if ( $^O eq 'darwin' )
             {
Index: solenv/inc/settings.mk
===================================================================
RCS file: /cvs/tools/solenv/inc/settings.mk,v
retrieving revision 1.168
retrieving revision 1.168.10.1
diff -u -u -r1.168 -r1.168.10.1
--- solenv/inc/settings.mk	18 Mar 2005 10:13:26 -0000	1.168
+++ solenv/inc/settings.mk	1 Apr 2005 08:51:51 -0000	1.168.10.1
@@ -207,9 +207,8 @@
 
 #required arguments
 .IF "$(JDK)" == "gcj"
-#JAVAC=$(JAVACOMPILER) -g -fno-assert -Wno-deprecated -C
-JAVAC=$(JAVACOMPILER) --encoding=ISO-8859-15 -g -fno-assert -Wno-deprecated -C
-JAVAI=$(JAVAINTERPRETER) -Dgnu.gcj.runtime.VMClassLoader.library_control=never
+JAVAC=$(JAVACOMPILER) --encoding=ISO-8859-15 -O2 -fno-assert -Wno-deprecated -C
+JAVAI=$(JAVAINTERPRETER) -Dgnu.gcj.precompiled.db.path=$(GCJ_DATABASE)
 .ELSE
 JAVAC=$(JAVACOMPILER)
 JAVAI=$(JAVAINTERPRETER)
