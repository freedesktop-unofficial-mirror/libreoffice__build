Index: configure.in
===================================================================
RCS file: /cvs/tools/config_office/configure.in,v
retrieving revision 1.69
diff -u -p -r1.69 configure.in
--- config_office/configure.in	9 Sep 2004 11:22:06 -0000	1.69
+++ config_office/configure.in	29 Sep 2004 12:05:33 -0000
@@ -180,7 +171,10 @@ AC_ARG_WITH(system-curl,
 ],,)
 AC_ARG_WITH(system-neon,
 [  --with-system-neon     Use neon already on system
 ],,)
+AC_ARG_WITH(system-mozilla,
+[  --with-system-mozilla   Use mozilla already on system. Note that some components cannot be built against a contemporary mozilla
+],,)
 AC_ARG_WITH(stlport4,
 [  --with-stlport4         The location that STLport4 is installed in. The STL
                           header files are assumed to be in stlport4-home/stlport
@@ -2015,23 +2009,34 @@ AC_MSG_CHECKING([which mozilla to use])
 if test -n "$with_system_mozilla"; then
     AC_MSG_RESULT([external])
     SYSTEM_MOZILLA=YES
-    PKG_CHECK_MODULES( MOZILLA, mozilla-xpcom )
-    PKG_CHECK_MODULES( MOZILLABASE, mozilla-nspr )
-    MOZILLA_ADDRBOOK_CFLAGS=`echo $MOZILLABASE_CFLAGS | $SED -e "s/nspr/addrbook/g"`
-    MOZILLA_RDF_CFLAGS=`echo $MOZILLABASE_CFLAGS | $SED -e "s/nspr/rdf/g"`
-    MOZILLA_MSGBASE_CFLAGS=`echo $MOZILLABASE_CFLAGS | $SED -e "s/nspr/msgbase/g"`
-    MOZILLA_XPCOM_OBSOLETE_CFLAGS=`echo $MOZILLABASE_CFLAGS | $SED -e "s/nspr/xpcom_obsolete/g"`
-    MOZILLA_PREF_CFLAGS=`echo $MOZILLABASE_CFLAGS | $SED -e "s/nspr/pref/g"`
-    MOZILLA_MIME_CFLAGS=`echo $MOZILLABASE_CFLAGS | $SED -e "s/nspr/mime/g"`
-    MOZILLA_CFLAGS="$MOZILLA_CFLAGS $MOZILLA_ADDRBOOK_CFLAGS $MOZILLA_RDF_CFLAGS $MOZILLA_MSGBASE_CFLAGS $MOZILLA_XPCOM_OBSOLETE_CFLAGS $MOZILLA_PREF_CFLAGS $MOZILLA_MIME_CFLAGS"
+    PKG_CHECK_MODULES( MOZILLAXPCOM, mozilla-xpcom )
+    PKG_CHECK_MODULES( MOZ_NSS, mozilla-nss )
+    MOZ_NSS_CFLAGS=`$PKG_CONFIG --cflags mozilla-nss`
+    MOZ_INC=`$PKG_CONFIG --variable=includedir mozilla-xpcom`
+    MOZ_LIB=`$PKG_CONFIG --variable=libdir mozilla-xpcom`
+    MOZ_LIB_XPCOM=$MOZILLAXPCOM_LIBS
+    MOZ_NSS_HACK=NO
+    save_CPPFLAGS="$CPPFLAGS"
+    save_LDFLAGS="$LDFLAGS"
+    save_LIBS="$LIBS"
+    CPPFLAGS="$CPPFLAGS $MOZ_NSS_CFLAGS"
+    LDFLAGS="$LDFLAGS $MOZ_NSS_LIBS"
+    AC_CHECK_LIB(nss3, PK11_GetCertFromPrivateKey, [],
+      [MOZ_NSS_HACK=YES], [])
+    LIBS="$save_LIBS"
+    LDFLAGS="$save_LDFLAGS"
+    CPPFLAGS="$save_CPPFLAGS"
 else
     AC_MSG_RESULT([internal])
     SYSTEM_MOZILLA=NO
     BUILD_TYPE="$BUILD_TYPE MOZ"
 fi
 AC_SUBST(SYSTEM_MOZILLA)
-AC_SUBST(MOZILLA_CFLAGS)
-AC_SUBST(MOZILLA_LIBS)
+AC_SUBST(MOZ_INC)
+AC_SUBST(MOZ_LIB)
+AC_SUBST(MOZ_LIB_XPCOM)
+AC_SUBST(MOZ_NSS_CFLAGS)
+AC_SUBST(MOZ_NSS_HACK)
 
 
 dnl ===================================================================
Index: set_soenv.in
===================================================================
RCS file: /cvs/tools/config_office/set_soenv.in,v
retrieving revision 1.22
diff -u -p -r1.22 set_soenv.in
--- config_office/set_soenv.in	9 Sep 2004 11:22:23 -0000	1.22
+++ config_office/set_soenv.in	29 Sep 2004 12:06:45 -0000
@@ -87,7 +87,7 @@ my ( $oldPATH, $SRC_ROOT, $SO_HOME, $JAV
      $ATL_LIB, $ATL_INCLUDE, $NO_HIDS, $TEMP, $COMMON_BUILD_TOOLS, $WIN_GREP, $WIN_FIND, $WIN_LS,
      $WIN_GNUCOPY, $WIN_TOUCH, $STLPORT4, $ENABLE_DEBUG,
 	 $PROEXT,
-     $SYSTEM_PYTHON, $PYTHONPATH, $PYTHONHOME );
+     $SYSTEM_PYTHON, $PYTHONPATH, $PYTHONHOME, $SYSTEM_MOZILLA );
 #
 #-------------------------------------------
 # IId. Declaring the aliases.
@@ -128,6 +128,7 @@ $warnfile       = "warn";           # lo
 $Warning        = "";               # container for warning messages
 $STLPORT4       = '@STLPORT4@';     # Location of STLport4
 $SYSTEM_PYTHON	= '@SYSTEM_PYTHON@';
+$SYSTEM_MOZILLA = '@SYSTEM_MOZILLA@';
 $JDK 		= '@JDK@';
 $MINGW          = '@WITH_MINGWIN@'; # use MinGW for Windows build
 $CC             = '@CC@';           # C compiler
@@ -1182,6 +1183,12 @@ elsif ($platform eq "$Macosx") 
     }
 
 }
+
+if ($SYSTEM_MOZILLA eq "YES")
+{
+	$SOLARLIB .= $L."@MOZ_LIB@"
+}
+
 # Location of the compiler include search directory paths.
 $SOLARINC             = $I.$cur_dir.
                         $I.'$SOLARVER'.$ds.'$UPD'.$ds.'$INPATH'.$INC.$ds."stl".
@@ -1750,8 +1756,11 @@ ToFile( "SYSTEM_NEON",       "@SYSTEM_NE
 ToFile( "NEON_LIBS",         "@NEON_LIBS@",        "e" );
 ToFile( "NEON_CFLAGS",       "@NEON_CFLAGS@",      "e" );
 ToFile( "SYSTEM_MOZILLA",    "@SYSTEM_MOZILLA@",   "e" );
-ToFile( "MOZILLA_CFLAGS",    "@MOZILLA_CFLAGS@",   "e" );
-ToFile( "MOZILLA_LIBS",      "@MOZILLA_LIBS@",     "e" );
+ToFile( "MOZ_INC",           "@MOZ_INC@",          "e" );
+ToFile( "MOZ_LIB",           "@MOZ_LIB@",          "e" );
+ToFile( "MOZ_LIB_XPCOM",     "@MOZ_LIB_XPCOM@",    "e" );
+ToFile( "MOZ_NSS_CFLAGS",    "@MOZ_NSS_CFLAGS@",   "e" );
+ToFile( "MOZ_NSS_HACK",      "@MOZ_NSS_HACK@",     "e" );
 ToFile( "BUILD_DMAKE",       "@BUILD_DMAKE@",      "e" );
 ToFile( "USE_XINERAMA",      "@USE_XINERAMA@",     "e" );
 ToFile( "XINERAMA_LINK",     "@XINERAMA_LINK@",    "e" );
