Index: configure.in
===================================================================
RCS file: /cvs/tools/config_office/configure.in,v
retrieving revision 1.101
diff -u -r1.101 configure.in
--- config_office/configure.in	1 Mar 2005 09:38:16 -0000	1.101
+++ config_office/configure.in	8 Mar 2005 15:40:32 -0000
@@ -1678,7 +1678,7 @@
         AC_MSG_RESULT([checked (gcj)]) 
         AC_MSG_WARN([EXPERIMENTAL: gij/gcj is not a full JDK replacement - some projects will fail to compile])
         echo "EXPERIMENTAL: gij/gcj is not a full JDK replacement - some projects will fail to compile" >>warn
-        JAVA_HOME=`echo $JAVAINTERPRETER | $SED -n "s,//*bin//*gij,,p"`
+        JAVA_HOME=`echo $JAVAINTERPRETER | $SED -n "s,//*bin//*$WITH_JAVA,,p"`
       else
         dnl SUN JDK specific tests
         _jdk=`$JAVAINTERPRETER -version 2>&1 | $AWK -F'"' '{ print \$2 }' | $SED s/[[-A-Za-z]]*//`
@@ -1703,7 +1703,7 @@
 dnl ===================================================================
 if test "$SOLAR_JAVA" != ""; then
     if test "$JDK" = "gcj"; then 
-        javacompiler="gcj"
+        javacompiler=`echo $WITH_JAVA | $SED -e "s/gij/gcj/g" | $SED -e "s/java/javac/g"`
     else
         javacompiler="javac"
     fi
@@ -1746,12 +1746,12 @@
       # check if JAVA_HOME was (maybe incorrectly?) set automatically to /usr
       if test "$JAVA_HOME" = "/usr" -a "x$with_jdk_home" = "x"; then
 
-         if basename $(readlink $(readlink $JAVAC)) >/dev/null 2>/dev/null; then
+         if basename $(readlink $(readlink $JAVACOMPILER)) >/dev/null 2>/dev/null; then
           # try to recover first by looking whether we have a alternatives 
           # system as in Debian or newer SuSEs where following /usr/bin/javac
           # over /etc/alternatives/javac leads to the right bindir where we
           # just need to strip a bit away to get a valid JAVA_HOME
-          JAVA_HOME=$(readlink $(readlink $JAVAC) | $SED -e s,/bin/javac$,,)
+          JAVA_HOME=$(readlink $(readlink $JAVACOMPILER) | $SED -e s,/bin/javac$,,)
          else
           # else warn
           AC_MSG_WARN([JAVA_HOME is set to /usr - this is very likely to be incorrect])
@@ -1786,35 +1786,6 @@
       AC_MSG_ERROR([xsltproc is required])
    fi
 fi
-# check if JAVA_HOME was (maybe incorrectly?) set automatically to /usr
-if test "$JAVA_HOME" = "/usr" -a "x$with_jdk_home" = "x"; then
-
-   if basename $(readlink $(readlink $JAVAC)) >/dev/null 2>/dev/null; then
-	# try to recover first by looking whether we have a alternatives 
-	# system as in Debian or newer SuSEs where following /usr/bin/javac
-	# over /etc/alternatives/javac leads to the right bindir where we
-	# just need to strip a bit away to get a valid JAVA_HOME
-	JAVA_HOME=$(readlink $(readlink $JAVAC) | $SED -e s,/bin/javac$,,)
-   else
-	# else warn
-   	AC_MSG_WARN([JAVA_HOME is set to /usr - this is very likely to be incorrect])
-   	AC_MSG_WARN([if this is the case, please inform the correct JAVA_HOME with --with-jdk-home])
-   	echo "JAVA_HOME is set to /usr - this is very likely to be incorrect" >> warn
-   	echo "if this is the case, please inform the correct JAVA_HOME with --with-jdk-home" >> warn
-    fi
-fi
-# now check if $JAVA_HOME is really valid
-if test ! -d "$JAVA_HOME/jre" -a "x$with_jdk_home" = "x" && \
-	test "$XSLTPROC" = "NO_XSLTPROC"; then
-   AC_MSG_WARN([JAVA_HOME was not explicitly informed with --with-jdk-home. the configure script])
-   AC_MSG_WARN([attempted to find JAVA_HOME automatically, but apparently it failed])
-   AC_MSG_WARN([in case JAVA_HOME is incorrectly set, some projects with not be built correctly])
-   echo "JAVA_HOME was not explicitly informed with --with-jdk-home. the configure script" >> warn
-   echo "attempted to find JAVA_HOME automatically, but apparently it failed" >> warn
-   echo "in case JAVA_HOME is incorrectly set, some projects with not be built correctly" >> warn
-fi
-AC_SUBST(JAVA_HOME)
-AC_SUBST(JDK)
 AC_SUBST(XSLTPROC)
 
 dnl ===================================================================
Index: scp2/source/ooo/makefile.mk
===================================================================
RCS file: /cvs/installation/scp2/source/ooo/makefile.mk,v
retrieving revision 1.20
retrieving revision 1.20.8.1
diff -u -r1.20 -r1.20.8.1
--- scp2/source/ooo/makefile.mk	25 Jan 2005 15:21:05 -0000	1.20
+++ scp2/source/ooo/makefile.mk	2 Feb 2005 10:48:02 -0000	1.20.8.1
@@ -79,7 +79,9 @@
 .ENDIF
 
 .IF "$(JAVANUMVER)" >= "000100040000"
+.IF "$(JDK)" != "gcj"
 SCPDEFS+=-DINCLUDE_JAVA_ACCESSBRIDGE
+.ENDIF
 .ENDIF
 
 .IF "$(GUI)"=="UNX"
Index: solenv/inc/settings.mk
===================================================================
RCS file: /cvs/tools/solenv/inc/settings.mk,v
retrieving revision 1.161
retrieving revision 1.161.2.1
diff -u -r1.161 -r1.161.2.1
--- solenv/inc/settings.mk	25 Jan 2005 15:15:29 -0000	1.161
+++ solenv/inc/settings.mk	17 Feb 2005 13:23:39 -0000	1.161.2.1
@@ -1185,10 +1185,10 @@
 .ENDIF
 
 RDBMAKER*=rdbmaker
-.IF "$(JDK)"=="gcj"
-JAVA*=gij
-.ELSE
+.IF "$(JAVAINTERPRETER)" == ""
 JAVA*=java
+.ELSE
+JAVA*=$(JAVAINTERPRETER)
 .ENDIF
 SCPCOMP*=scpcomp
 #SCPLINK*=scplink
Index: xmlhelp/source/com/sun/star/help/FileURLStreamHandlerWithNotify.java
===================================================================
RCS file: /cvs/util/xmlhelp/source/com/sun/star/help/FileURLStreamHandlerWithNotify.java,v
retrieving revision 1.4
retrieving revision 1.4.4.1
diff -u -r1.4 -r1.4.4.1
--- xmlhelp/source/com/sun/star/help/FileURLStreamHandlerWithNotify.java	27 Jan 2005 10:06:35 -0000	1.4
+++ xmlhelp/source/com/sun/star/help/FileURLStreamHandlerWithNotify.java	2 Feb 2005 10:54:07 -0000	1.4.4.1
@@ -26,7 +26,6 @@
 public class FileURLStreamHandlerWithNotify
 	extends sun.net.www.protocol.file.Handler {
 
-	public static int locCount = 0, totCount = 0;
 	private static HashMap hashMap = new HashMap();
 
 	private HelpURLStreamHandlerFactory.Notify interest;
@@ -45,9 +44,9 @@
 		String useFileName = externalForm;
 
 		if (useFileName.endsWith(".xhp")) {
-			totCount += 1;
+			HelpLinker.totCount += 1;
 			if (hashMap.containsKey(externalForm)) {
-				locCount += 1;
+				HelpLinker.locCount += 1;
 				useFileName = (String) hashMap.get(externalForm);
 			} else {
 				FileInputStream fileInputStream = null;
Index: xmlhelp/source/com/sun/star/help/GCJFileURLStreamHandlerWithNotify.java
===================================================================
RCS file: /cvs/util/xmlhelp/source/com/sun/star/help/GCJFileURLStreamHandlerWithNotify.java,v
retrieving revision 1.2
retrieving revision 1.2.4.1
diff -u -r1.2 -r1.2.4.1
--- xmlhelp/source/com/sun/star/help/GCJFileURLStreamHandlerWithNotify.java	25 Jan 2005 15:28:12 -0000	1.2
+++ xmlhelp/source/com/sun/star/help/GCJFileURLStreamHandlerWithNotify.java	2 Feb 2005 10:54:07 -0000	1.2.4.1
@@ -6,9 +6,16 @@
  */
 package com.sun.star.help;
 
+import java.io.File;
+import java.io.FileInputStream;
+import java.io.FileNotFoundException;
+import java.io.FileOutputStream;
 import java.io.IOException;
+import java.net.URI;
+import java.net.URISyntaxException;
 import java.net.URL;
 import java.net.URLConnection;
+import java.util.HashMap;
 
 /**
  * @author ab106281
@@ -19,16 +26,56 @@
 public class GCJFileURLStreamHandlerWithNotify
 	extends gnu.java.net.protocol.file.Handler {
 
+	private static HashMap hashMap = new HashMap();
+
 	private HelpURLStreamHandlerFactory.Notify interest;
 
+	GCJFileURLStreamHandlerWithNotify() {
+		this.interest = null;
+	}
+
 	GCJFileURLStreamHandlerWithNotify(
 		HelpURLStreamHandlerFactory.Notify interest) {
 		this.interest = interest;
 	}
 
 	public URLConnection openConnection(URL arg0) throws IOException {
+		String externalForm = arg0.toExternalForm();
+		String useFileName = externalForm;
+
+		if (useFileName.endsWith(".xhp")) {
+			HelpLinker.totCount += 1;
+			if (hashMap.containsKey(externalForm)) {
+				HelpLinker.locCount += 1;
+				useFileName = (String) hashMap.get(externalForm);
+			} else {
+				FileInputStream fileInputStream = null;
+				try {
+					fileInputStream =
+						new FileInputStream(new File(new URI(externalForm)));
+				} catch (Exception e) {
+					System.err.println(e.getMessage());
+					System.exit(1);
+				}
+
+				File tmpFile = File.createTempFile("xhp", ".xhp_");
+				tmpFile.createNewFile();
+				tmpFile.deleteOnExit();
+				FileOutputStream fileOutputStream =
+					new FileOutputStream(tmpFile);
+				int n = 0;
+				byte[] b = new byte[256*1024];
+				while ((n = fileInputStream.read(b)) != -1)
+					fileOutputStream.write(b, 0, n);
+				fileOutputStream.close();
+				fileInputStream.close();
+				useFileName = tmpFile.toURL().toExternalForm();
+				hashMap.put(externalForm, useFileName);
+			}
+		}
 		if (interest != null)
 			interest.notify(arg0);
+		arg0 = new URL(useFileName);
 		return super.openConnection(arg0);
 	}
 }
Index: xmlhelp/source/com/sun/star/help/HelpLinker.java
===================================================================
RCS file: /cvs/util/xmlhelp/source/com/sun/star/help/HelpLinker.java,v
retrieving revision 1.6
retrieving revision 1.6.4.1
diff -u -r1.6 -r1.6.4.1
--- xmlhelp/source/com/sun/star/help/HelpLinker.java	27 Jan 2005 10:07:27 -0000	1.6
+++ xmlhelp/source/com/sun/star/help/HelpLinker.java	2 Feb 2005 10:54:08 -0000	1.6.4.1
@@ -97,6 +97,8 @@
 
 class HelpLinker {
 
+	public static int locCount = 0, totCount = 0;
+
 	public static void main(String[] args) {
 		HelpCompiler.initURLHandler();
 
@@ -256,10 +258,10 @@
 				.link();
 			System.out.println(
 				"number of local fetches: "
-					+ FileURLStreamHandlerWithNotify.locCount);
+					+ locCount);
 			System.out.println(
 				"total number of fetches: "
-					+ FileURLStreamHandlerWithNotify.totCount);
+					+ totCount);
 		} catch (Exception e) {
 			e.printStackTrace();
 			System.exit(1);
Index: accessibility/bridge/org/openoffice/accessibility/makefile.mk
===================================================================
RCS file: /cvs/gsl/accessibility/bridge/org/openoffice/accessibility/makefile.mk,v
retrieving revision 1.5
retrieving revision 1.5.10.1
diff -u -r1.5 -r1.5.10.1
--- accessibility/bridge/org/openoffice/accessibility/makefile.mk	23 Jul 2004 14:29:38 -0000	1.5
+++ accessibility/bridge/org/openoffice/accessibility/makefile.mk	2 Feb 2005 10:41:44 -0000	1.5.10.1
@@ -68,7 +68,10 @@
 .INCLUDE :  settings.mk
 
 .IF "$(JAVANUMVER:s/.//)" >= "000100040000" 
-
+.IF "$(JDK)" == "gcj"
+all:
+        @echo This dir cannot be build with gcj because of org.openoffice.java.accessibility.AccessibleKeyBinding
+.ELSE
 JARFILES = jurt.jar unoil.jar ridl.jar 
 JAVAFILES = \
 	AccessBridge.java \
@@ -82,7 +85,7 @@
 JARCOMPRESS             = TRUE
 JARCLASSDIRS            = $(PACKAGE) org/openoffice/java/accessibility 
 CUSTOMMANIFESTFILE      = manifest
-
+.ENDIF
 .ENDIF			# "$(JAVANUMVER:s/.//)" >= "000100040000" 
 
 # --- Targets ------------------------------------------------------
Index: accessibility/bridge/org/openoffice/java/accessibility/makefile.mk
===================================================================
RCS file: /cvs/gsl/accessibility/bridge/org/openoffice/java/accessibility/makefile.mk,v
retrieving revision 1.15
retrieving revision 1.15.4.1
diff -u -r1.15 -r1.15.4.1
--- accessibility/bridge/org/openoffice/java/accessibility/makefile.mk	2 Nov 2004 14:34:59 -0000	1.15
+++ accessibility/bridge/org/openoffice/java/accessibility/makefile.mk	2 Feb 2005 10:41:44 -0000	1.15.4.1
@@ -72,7 +72,10 @@
 .INCLUDE :  settings.mk
 
 .IF "$(JAVANUMVER:s/.//)" >= "000100040000" 
-
+.IF "$(JDK)" == "gcj"
+all:
+        @echo This dir cannot be build with gcj because of java.awt.Window.AccessibleAWTWindow
+.ELSE
 JAVADIR = $(OUT)$/misc$/java
 JARFILES = sandbox.jar jurt.jar unoil.jar ridl.jar
 JAVAFILES = \
@@ -126,6 +129,7 @@
 JARCOMPRESS             = TRUE
 JARCLASSDIRS            = $(PACKAGE)
 
+.ENDIF
 .ENDIF			# "$(JAVANUMVER:s/.//)" >= "000100040000" 
 
 # --- Targets ------------------------------------------------------
