Index: sc/source/core/tool/interpr1.cxx
===================================================================
RCS file: /cvs/sc/sc/source/core/tool/interpr1.cxx,v
retrieving revision 1.53
diff -u -r1.53 interpr1.cxx
--- sc/source/core/tool/interpr1.cxx	1 Nov 2007 16:23:17 -0000	1.53
+++ sc/source/core/tool/interpr1.cxx	7 Jan 2008 18:39:18 -0000
@@ -4165,31 +4165,34 @@
         SCCOL nCol3 = 0;
         SCROW nRow3 = 0;
         SCTAB nTab3 = 0;
-        SCCOL nCol4 = 0;
-        SCROW nRow4 = 0;
-        SCTAB nTab4;
+
 		if (nParamCount == 3)
 		{
+            // Save only the upperleft cell in case of cell range.  The geometry
+            // of the 3rd parameter is taken from the 1st parameter.
+
 			switch ( GetStackType() )
 			{
 				case svDoubleRef :
-					PopDoubleRef( nCol3, nRow3, nTab3, nCol4, nRow4, nTab4 );
+                {
+                    SCCOL nColJunk = 0;
+                    SCROW nRowJunk = 0;
+                    SCTAB nTabJunk = 0;
+                    PopDoubleRef( nCol3, nRow3, nTab3, nColJunk, nRowJunk, nTabJunk );
+                    if ( nTabJunk != nTab3 )
+                    {
+                        SetIllegalParameter();
+                        return;
+                    }
+                }
 				break;
 				case svSingleRef :
 					PopSingleRef( nCol3, nRow3, nTab3 );
-					nCol4 = nCol3;
-					nRow4 = nRow3;
-					nTab4 = nTab3;
 				break;
 				default:
 					SetIllegalParameter();
 					return ;
 			}
-			if ( nTab3 != nTab4 )
-			{
-				SetIllegalParameter();
-				return;
-			}
 		}
 		String rString;
         double fVal = 0.0;
@@ -4273,21 +4276,33 @@
 			SetIllegalParameter();
 			return;
 		}
-		if (nParamCount != 3)
+
+        if (nParamCount == 3)
+        {
+            // Make sure the calculated cell ranges will not fall outside the
+            // allowed ranges (to prevent crash).
+
+            SCCOL nColDelta = nCol2 - nCol1;
+            SCROW nRowDelta = nRow2 - nRow1;
+            if (nCol3 + nColDelta >= MAXCOLCOUNT)
+            {
+                SCCOL nNewDelta = MAXCOLCOUNT - 1 - nCol3;
+                nCol2 = nCol1 + nNewDelta;
+            }
+
+            if (nRow3 + nRowDelta >= MAXROWCOUNT)
+            {
+                SCROW nNewDelta = MAXROWCOUNT - 1 - nRow3;
+                nRow2 = nRow1 + nNewDelta;
+            }
+        }
+        else
 		{
 			nCol3 = nCol1;
 			nRow3 = nRow1;
 			nTab3 = nTab1;
-			nCol4 = nCol2;
-			nRow4 = nRow2;
-			nTab4 = nTab2;
-		}
-		else if (nCol4 - nCol3 != nCol2 - nCol1 ||
-				 nRow4 - nRow3 != nRow2 - nRow1 || nCol1 > nCol2)
-		{
-			SetIllegalParameter();
-			return;
 		}
+
 		if (nGlobalError == 0)
 		{
 			ScQueryParam rParam;
