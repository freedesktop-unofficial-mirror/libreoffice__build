From 928eb89449400ae0dd69a253131e1363a1bf75d6 Mon Sep 17 00:00:00 2001
From: Jan Holesovsky <kendy@suse.cz>
Date: Fri, 14 May 2010 17:01:50 +0200
Subject: [PATCH 482/878] gstreamer-avmedia-loopingetc.diff

---
 avmedia/source/gstreamer/gstplayer.cxx |   15 +++++++++++++--
 avmedia/source/gstreamer/gstplayer.hxx |    1 +
 2 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/avmedia/source/gstreamer/gstplayer.cxx b/avmedia/source/gstreamer/gstplayer.cxx
index 66bbf7a..1d6a04d 100644
--- a/avmedia/source/gstreamer/gstplayer.cxx
+++ b/avmedia/source/gstreamer/gstplayer.cxx
@@ -67,6 +67,7 @@ Player::Player( const uno::Reference< lang::XMultiServiceFactory >& rxMgr ) :
     mpPlaybin( NULL ),
     mbFakeVideo (sal_False ),
     mnUnmutedVolume( 0 ),
+    mbPlayPending ( false ),
     mbMuted( false ),
     mbLooping( false ),
     mbInitialized( false ),
@@ -140,6 +141,9 @@ void Player::processMessage( GstMessage *message )
     case GST_MESSAGE_EOS:
         //DBG( "EOS, reset state to NULL" );
         gst_element_set_state( mpPlaybin, GST_STATE_READY );
+        mbPlayPending = false;
+        if (mbLooping)
+            start();
         break;
     case GST_MESSAGE_STATE_CHANGED:
         if( message->src == GST_OBJECT( mpPlaybin ) ) {
@@ -151,6 +155,9 @@ void Player::processMessage( GstMessage *message )
                 pendingstate == GST_STATE_VOID_PENDING &&
                 mpXOverlay )
                 gst_x_overlay_expose( mpXOverlay );
+
+        if (mbPlayPending)
+            mbPlayPending = ((newstate == GST_STATE_READY) || (newstate == GST_STATE_PAUSED));
         }
     default:
         break;
@@ -250,6 +257,7 @@ void Player::preparePlaybin( const ::rtl::OUString& rURL, bool bFakeVideo )
 
         if( mpPlaybin != NULL ) {
             gst_element_set_state( mpPlaybin, GST_STATE_NULL );
+            mbPlayPending = false;
             g_object_unref( mpPlaybin );
         }
 
@@ -281,6 +289,7 @@ bool Player::create( const ::rtl::OUString& rURL )
         preparePlaybin( rURL, true );
 
         gst_element_set_state( mpPlaybin, GST_STATE_PAUSED );
+        mbPlayPending = false;
 
         bRet = true;
     }
@@ -305,6 +314,7 @@ void SAL_CALL Player::start(  )
     if( mbInitialized && NULL != mpPlaybin )
     {
         gst_element_set_state( mpPlaybin, GST_STATE_PLAYING );
+        mbPlayPending = true;
     }
 }
 
@@ -317,6 +327,7 @@ void SAL_CALL Player::stop(  )
     if( mpPlaybin )
         gst_element_set_state( mpPlaybin, GST_STATE_PAUSED );
 
+    mbPlayPending = false;
     DBG( "stop %p", mpPlaybin );
 }
 
@@ -325,10 +336,10 @@ void SAL_CALL Player::stop(  )
 sal_Bool SAL_CALL Player::isPlaying()
     throw (uno::RuntimeException)
 {
-    bool            bRet = false;
+    bool            bRet = mbPlayPending;
 
     // return whether the pipeline is in PLAYING STATE or not
-    if( mbInitialized && mpPlaybin )
+    if( !mbPlayPending && mbInitialized && mpPlaybin )
     {
         bRet = GST_STATE_PLAYING == GST_STATE( mpPlaybin );
     }
diff --git a/avmedia/source/gstreamer/gstplayer.hxx b/avmedia/source/gstreamer/gstplayer.hxx
index 4296576..064eb16 100644
--- a/avmedia/source/gstreamer/gstplayer.hxx
+++ b/avmedia/source/gstreamer/gstplayer.hxx
@@ -101,6 +101,7 @@ private:
     sal_Bool                mbFakeVideo;
 
     gdouble                 mnUnmutedVolume;
+    sal_Bool                mbPlayPending;
     sal_Bool                mbMuted;
     sal_Bool                mbLooping;
     sal_Bool                mbInitialized;
-- 
1.7.0.1

