#!/bin/sh

if test "z$1" = "z--help" || test "z$1" = "z-h"; then
    echo "place [<destination-dir>]"
    echo "   installs scratch source into the build tree";
    exit 0;
fi

if test "z$1" != "z"; then
    OOBUILDDIR=$1
else
    OOBUILDDIR='@OOBUILDDIR@'
fi

SUBDIRS="canvas-cairo offapi-vba sc-vba"
SCRATCHDIR="@TOOLSDIR@/scratch"

BACKUPDIR_SUFFIX="bak"

for subdir in $SUBDIRS; do
	echo "Processing $subdir directory"

	if [ ! -f "$SCRATCHDIR/$subdir/POSITION" ]; then
		echo " - missing $subdir/POSITION file"
		continue
	fi

	POSITION=`cat "$SCRATCHDIR/$subdir/POSITION"`
	TARGETDIR="$OOBUILDDIR/$POSITION"
	
	if [ ! -d "$TARGETDIR" ]; then
		echo " - oops, $TARGETDIR doesn't exists"
		continue
	fi
	
	if [ -l "$SCRATCHDIR/$subdir" ]; then
		echo "Your scratch directory already contains a symlink - removing it"
		rm -f $SCRATCHDIR/$subdir;
	fi

	echo " - renaming original directory (adding .$BACKUPDIR_SUFFIX)"
	mv "$TARGETDIR" "$TARGETDIR.$BACKUPDIR_SUFFIX"

	echo " - moving $subdir"
	mv "$SCRATCHDIR/$subdir" "$TARGETDIR"

	echo " - linking back"
	ln -s "$TARGETDIR" "$SCRATCHDIR/$subdir"
done

