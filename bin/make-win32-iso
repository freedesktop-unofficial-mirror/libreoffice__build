#!/bin/bash

# Create two ISOs for Win32:
#	-multilingual installer and additional language pack installers
#	-source code

# Requires mkisofs, from cdrtools. Compiling that from source is a
# pain, thanks to the author's insistence that his configuration and
# make system is better than everybody's elses. One cdrtools
# distribution of binaries for Cygwin known to work is at
# http://www.sbox.tugraz.at/home/t/tplank/cdrtools-2.01-win32-bin.zip
# and tucked away for safety also in go-oo.org:~ooo .

# NOTE: very much a work in progress...

set -o errexit

. ./setup

MULTILANGS=''
RESTLANGS=''

for i in $OOO_LANGS; do
    case $i in
    ar|cs|da|de|el|es|fi|fr|he|hu|it|nb|nl|pl|pt-BR|pt|ru|sv|tr)
	MULTILANGS="$MULTILANGS,$i";;
    en-US)
	;;
    *)
	RESTLANGS="$RESTLANGS $i";;
    esac
done

case "$MULTILANGS" in
*,*,*,*)
    ;;
*)
    echo "This doesn't seem like a multilingual build. To make ISOs"
    echo "you should have configured a real production build, that is"
    echo "with lots of languages. For the Novell Edition,"
    echo "use --with-distro=NovellWin32ISO"
    exit 1;;
esac

cd $OOBUILDDIR

. ./winenv.set.sh

cd instsetoo_native

ZIPNAMEPREFIX=OOo-$OOO_PACKAGEVERSION-`date +%Y%m%d`

# Edit the relevant target line in instsetoo_native/util/makefile.mk
# to build the multilingual installer for those languages for which
# there exists XP localisations, and language pack installers for the
# rest.
gawk '/^ALLTAR :/ { n++;
                    if (n==3) {
                      printf "ALLTAR : openoffice_en-US openoffice_en-US'"$MULTILANGS"'";
                      split ("'"$RESTLANGS"'", restlangs);
                      for (i in restlangs) {
                        printf " ooolanguagepack_%s", restlangs[i];
                      }
                      printf "\n";
		      next;
                    }
                  }
      { print; }
' <util/makefile.mk >util/makefile.mk.new

echo Edited instsetoo_native/util/makefile.mk:
diff -u0 util/makefile.mk util/makefile.mk.new || true
mv util/makefile.mk.new util/makefile.mk

# Build the installers. For some reason one cannot use the "build"
# alias in this script.
perl $SOLARENV/bin/build.pl

# Construct the installer CD contents

CD=`mktemp -d`

cp -pR wntmsci10.pro/OpenOffice/msi/install/en-US`echo $MULTILANGS | sed -e ´s/,/_/g'` $CD

mkdir $CD/langpacks
for i in $RESTLANGS; do
    (
    cd wntmsci10.pro/OpenOffice_languagepack/msi/install/$i
    zip -r $CD/langpacks/$ZIPNAMEPREFIX-$i.zip .
    )
done

cd $CD
unzip $ISOTEMPLATE

# Build the installer ISO

mkisofs bla bla

# Construct the source code CD contents

# Build the source code ISO

