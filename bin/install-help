#!/bin/sh

HELPDIR=$OOINSTDIR/help

if (! test -d $HELPDIR); then
    echo "Cannot find $HELPDIR; make sure you installed OOo first"
    exit 1;
fi

# the tested localizations
LANGNUMS=`./openoffice-xlate-lang -p all`

for LANGNUM in $LANGNUMS ; do
  LANGCODE=`$TOOLSDIR/bin/openoffice-xlate-lang -i $LANGNUM`
  install -m 755 -d $HELPDIR/$LANGCODE || exit 1;
  if test -f $SRCDIR/helpcontent_${LANGNUM}_unix.tar.bz2 -o -f $SRCDIR/helpcontent_${LANGNUM}_unix.tgz ; then
    echo "Unpacking $LANGCODE help content..."
    if test -f $SRCDIR/helpcontent_${LANGNUM}_unix.tar.bz2 ; then
      tar -xjf $SRCDIR/helpcontent_${LANGNUM}_unix.tar.bz2 -C $HELPDIR/$LANGCODE || exit 1;
    else
      tar -xzf $SRCDIR/helpcontent_${LANGNUM}_unix.tgz -C $HELPDIR/$LANGCODE || exit 1;
    fi
    cd $HELPDIR/$LANGCODE
    for arch in *.zip ; do
      if test "z$arch" != "zhelpxsl.zip" ; then
        unzip -o $arch
      fi
      rm $arch
    done
    # remove potential CVS directories (used for example in helpcontent_50_unix)
    find . -name CVS -type d -exec rm -rf {} \;
    cd -

    # fix or add highcontrast*.css
    for config in custom.css default.css \
	    highcontrastblack.css highcontrastwhite.css \
    	    highcontrast1.css highcontrast2.css ; do
      if test -f $HELPDIR/$LANGCODE/$config ; then
        $TOOLSDIR/bin/help-font-munge $HELPDIR/$LANGCODE/$config || exit 1;
	rm $HELPDIR/$LANGCODE/$config.bak
      else
        cp -a $HELPDIR/en/$config $HELPDIR/$LANGCODE/$config || exit 1;
      fi
    done

    # fix permissions and create list of files and directories
    echo "%defattr(644,root,root,755)" >$BUILDDIR/help_${LANGCODE}_list.txt || exit 1;
    find $HELPDIR/$LANGCODE -type d -exec chmod 755 {} \; -exec echo %dir {}/ \; >>$BUILDDIR/help_${LANGCODE}_list.txt || exit 1;
    find $HELPDIR/$LANGCODE -type f -exec chmod 644 {} \; -print >>$BUILDDIR/help_${LANGCODE}_list.txt || exit 1;
  else
    echo "Warning: $LANGCODE help content is not available..."
    rm -f $BUILDDIR/help_${LANGCODE}_list.txt
  fi
done
