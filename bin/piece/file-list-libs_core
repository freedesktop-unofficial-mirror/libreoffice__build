#!/bin/bash

piece=$1
ooo_build_tag=$2

source $OO_TOOLSDIR/piece/sys-setup

# gnome subpackage
$OO_TOOLSDIR/piece/merge-file-lists "files-gnome.txt" $DESTDIR/gid_Module_Optional_Gnome

#kde subpackage
$OO_TOOLSDIR/piece/merge-file-lists "files-kde.txt" $DESTDIR/gid_Module_Optional_Kde

# generate the common file list
$OO_TOOLSDIR/piece/merge-file-lists "files-$piece.txt" $DESTDIR/gid_*
$OO_TOOLSDIR/piece/desktop-support-app "$piece" "$ooo_build_tag" "unopkg"

# fix up kde subpackage
mv_file_between_flists files-kde.txt files-$piece.txt $OO_INSTDIR/basis3.0/program/kdefilepicker
mv_file_between_flists files-kde.txt files-$piece.txt $OO_INSTDIR/basis3.0/program/fps_kde.uno.so
mv_file_between_flists files-kde.txt files-$piece.txt $OO_INSTDIR/basis3.0/program/libvclplug_kde[0-9]*l..so
mv_file_between_flists files-kde.txt files-$piece.txt $OO_INSTDIR/basis3.0/program/libkabdrv1.so
add_used_directories files-kde.txt files-$piece.txt
	
# fix up gnome subpackage
mv_file_between_flists files-gnome.txt files-$piece.txt $OO_INSTDIR/basis3.0/program/libevoab2.so
mv_file_between_flists files-gnome.txt files-$piece.txt $OO_INSTDIR/basis3.0/program/fps_gnome.uno.so
mv_file_between_flists files-gnome.txt files-$piece.txt $OO_INSTDIR/basis3.0/program/libvclplug_gtk[0-9]*l..so
mv_file_between_flists files-$piece.txt files-gnome.txt $OO_INSTDIR/basis3.0/program/ucpgvfs1.uno.so
add_used_directories files-gnome.txt files-$piece.txt

# mailmerge subpackage
mv $DESTDIR$OO_SOLVERDIR/lib/pyuno/mailmerge.py $DESTDIR$OO_INSTDIR/basis3.0/program/mailmerge.py || exit 1
chmod 755 $DESTDIR$OO_INSTDIR/basis3.0/program/mailmerge.py
echo "%dir $OO_INSTDIR" >files-mailmerge.txt
echo "%dir $OO_INSTDIR/basis3.0" >>files-mailmerge.txt
echo "%dir $OO_INSTDIR/basis3.0/program" >>files-mailmerge.txt
echo "$OO_INSTDIR/basis3.0/program/mailmerge.py" >>files-mailmerge.txt

# mess
remove_file "files-$piece.txt" "$OO_INSTDIR/basis-link"
remove_file "files-$piece.txt" "$OO_INSTDIR/basis3.0/program/services.rdb"
remove_dir  "files-$piece.txt" "$OO_INSTDIR/ure"

exit 0
