#!/bin/bash

# Based on docs/setup.txt

#
# See setup for user tweakables.
#
. ./setup

export LANG='';

if !(test -f $OOBUILDDIR/$STAMP); then
	echo "Source build failed, no stamp";
	exit 1;
fi

AUTORESPONSE=$OOBUILDDIR/autoresponse.conf

echo "Create auto-response file"
echo "[ENVIRONMENT]
INSTALLATIONMODE=INSTALL_NETWORK
INSTALLATIONTYPE=STANDARD
DESTINATIONPATH=$OOINSTDIR
OUTERPATH=
LOGFILE=
LANGUAGELIST=<LANGUAGE>

[JAVA]
JavaSupport=preinstalled_or_none" > $AUTORESPONSE

if (test -f $OOINSTDIR/$STAMP) && (!(test "z$2" = "z--clean") || !(test "z$WITH_SRC" = "z")); then
	echo "Skipping unpack";
else
        echo "Cleaning $OOINSTDIR";
	rm -Rf $OOINSTDIR;

	INSTALLER_PATH="`tcsh -c "cd $OOBUILDDIR; source $OOBUILDDIR/*.Set; echo \"$OOBUILDDIR/instsetoo/\\$INPATH/01/normal\""`";
	export DISPLAY=''; # clobber;
	echo "Execute from $INSTALLER_PATH to $OOINSTDIR [$LANG]";
	cd $INSTALLER_PATH || exit 1;

	./setup -net -v -r:$AUTORESPONSE -nogui || exit 1;
	echo "Done";
	
	echo "Stripping binaries";
	strip $OOINSTDIR/program/*.so
	touch $OOINSTDIR/$STAMP || exit 1;
	echo "Done...";
fi

echo "Building $OOINSTDIR/ooo-wrapper$BINSUFFIX";
sed -e "s|@OOINSTBASE@|$OOINSTBASE|g
	s|@SYSCONFDIR@|$SYSCONFDIR|g
	s|@BINSUFFIX@|$BINSUFFIX|g
	s|@VERSION@|$VERSION|g" $TOOLSDIR/bin/ooo-wrapper.in >| "$OOBUILDDIR/ooo-wrapper$BINSUFFIX" || exit 1;
mkdir -p $PREFIX/bin
cp -f $OOBUILDDIR/ooo-wrapper$BINSUFFIX $PREFIX/bin
chmod +x $PREFIX/bin/ooo-wrapper$BINSUFFIX

echo "Building $OOINSTDIR/install-dict";
sed -e "s|@OOINSTBASE@|$OOINSTBASE|g" $TOOLSDIR/bin/install-dict.in >| "$OOBUILDDIR/install-dict" || exit 1;
mkdir -p $OOINSTDIR
cp -f $OOBUILDDIR/install-dict $OOINSTDIR
chmod +x $OOINSTDIR/install-dict

mkdir -p $SYSCONFDIR/openoffice
cp -f $TOOLSDIR/etc/autoresponse$BINSUFFIX.conf $SYSCONFDIR/openoffice

echo "Installing system files ...";
mkdir -p $PREFIX/share/gnome/ximian/applications
cp $TOOLSDIR/desktop/*$BINSUFFIX.desktop $PREFIX/share/gnome/ximian/applications

mkdir -p $PREFIX/share/pixmaps
cp $TOOLSDIR/desktop/ximian-openoffice-*.png $PREFIX/share/pixmaps

echo "Building lang-packs ...";

cd $TOOLSDIR/bin || exit 1;
./package-lang || exit 1;

echo "Packaging succeeded";
exit 0;

