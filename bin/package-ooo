#!/bin/bash

# Based on docs/setup.txt

#
# See setup for user tweakables.
#
. ./setup

if !(test "z$BUILD_VERSION" = "z"); then
    SUDO=
else
    SUDO=sudo
    if test "z$1" = 'z--help'; then
	    echo 'package-ooo <BRANCH> [--clean|--help]';
	    echo ' --clean: remove, and re-setup the OO auto-install';
	    exit 0;
    fi
fi

export LANG='';

if !(test -f $OOBUILDDIR/$STAMP); then
	echo "Source build failed, no stamp";
	exit 1;
fi

AUTORESPONSE=$OOBUILDDIR/autoresponse.conf

echo "Create auto-response file"
echo "[ENVIRONMENT]
INSTALLATIONMODE=INSTALL_NETWORK
INSTALLATIONTYPE=STANDARD
DESTINATIONPATH=$OOINSTDIR
OUTERPATH=
LOGFILE=
LANGUAGELIST=<LANGUAGE>

[JAVA]
JavaSupport=preinstalled_or_none" > $AUTORESPONSE

if (test -f $OOINSTDIR/$STAMP) && (!(test "z$2" = "z--clean") || !(test "z$BUILD_VERSION" = "z")); then
	echo "Skipping unpack";
else
        echo "Cleaning $OOINSTDIR";
	$SUDO rm -Rf $OOINSTDIR;

	INSTALLER_PATH="`tcsh -c "cd $OOBUILDDIR; source $OOBUILDDIR/*.Set; echo \"$OOBUILDDIR/instsetoo/\\$INPATH/01/normal\""`";
	export DISPLAY=''; # clobber;
	echo "Execute from $INSTALLER_PATH to $OOINSTDIR [$LANG]";
	cd $INSTALLER_PATH || exit 1;

	$SUDO ./setup -net -v -r:$AUTORESPONSE -nogui || exit 1;
	echo "Done";
	
	echo "Stripping binaries";
	$SUDO strip $OOINSTDIR/program/*.so
	$SUDO touch $OOINSTDIR/$STAMP || exit 1;
	echo "Done...";
fi

echo "Building $OOINSTDIR/ooo-wrapper$BINSUFFIX";
sed -e "s|@OOINSTBASE@|$OOINSTBASE|g
	s|@BINSUFFIX@|$BINSUFFIX|g
	s|@VERSION@|$VERSION|g" $TOOLSDIR/bin/ooo-wrapper.in >| "$OOBUILDDIR/ooo-wrapper$BINSUFFIX" || exit 1;
$SUDO mkdir -p $PREFIX/bin
$SUDO cp -f $OOBUILDDIR/ooo-wrapper$BINSUFFIX $PREFIX/bin
$SUDO chmod +x $PREFIX/bin/ooo-wrapper$BINSUFFIX

echo "Building $OOINSTDIR/install-dict";
sed -e "s|@OOINSTBASE@|$OOINSTBASE|g" $TOOLSDIR/bin/install-dict.in >| "$OOBUILDDIR/install-dict" || exit 1;
$SUDO mkdir -p $OOINSTDIR
$SUDO cp -f $OOBUILDDIR/install-dict $OOINSTDIR
$SUDO chmod +x $OOINSTDIR/install-dict

$SUDO mkdir -p $SYSCONFDIR/openoffice
$SUDO cp -f $TOOLSDIR/etc/autoresponse$BINSUFFIX.conf $SYSCONFDIR/openoffice
for app in calc draw impress math writer ffice; do
  $SUDO ln -sf ooo-wrapper$BINSUFFIX $PREFIX/bin/oo$app$BINSUFFIX
done

echo "Installing system files ...";
$SUDO mkdir -p $PREFIX/share/gnome/ximian/applications
$SUDO cp $TOOLSDIR/desktop/*$BINSUFFIX.desktop $PREFIX/share/gnome/ximian/applications

$SUDO mkdir -p $PREFIX/share/pixmaps
$SUDO cp $TOOLSDIR/artwork/ximian-openoffice-*.png $PREFIX/share/pixmaps

if (test "z$BUILD_VERSION" = "z"); then

    sed -e "s|@OOINSTDIR@|$OOINSTDIR|g
	    s|@TOOLSDIR@|$TOOLSDIR|g
	    s|@VERSION@|$VERSION|g
	    s|@RPM_RELEASE@|$RPM_RELEASE|g" $TOOLSDIR/bin/ooo$BINSUFFIX.spec.in > $OOBUILDDIR/ooo.spec

    echo "Building RPM ...";
    $SUDO rpmbuild -bb $OOBUILDDIR/ooo.spec || exit 1;
    $SUDO rm -f $OOBUILDDIR/ooo-l10n-*.spec;
fi

echo "Building lang-packs ...";

cd $TOOLSDIR/bin || exit 1;
$SUDO ./package-lang || exit 1;

echo "Packaging succeeded";
exit 0;

