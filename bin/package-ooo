#!/bin/bash

# Based on docs/setup.txt

#
# See setup for user tweakables.
#
. ./setup

export LANG='';

if !(test -f $OOBUILDDIR/$STAMP); then
	echo "Source build failed, no stamp";
	exit 1;
fi

AUTORESPONSE=$OOBUILDDIR/autoresponse.conf

echo "Create auto-response file"
echo "[ENVIRONMENT]
INSTALLATIONMODE=INSTALL_NETWORK
INSTALLATIONTYPE=STANDARD
DESTINATIONPATH=$OOINSTDIR
OUTERPATH=
LOGFILE=
LANGUAGELIST=<LANGUAGE>

[JAVA]
JavaSupport=preinstalled_or_none" > $AUTORESPONSE

echo "Building $OOINSTDIR/ooo-wrapper$BINSUFFIX";
sed -e "s|@OOINSTBASE@|$OOINSTBASE|g
	s|@SYSCONFDIR@|$SYSCONFDIR|g
	s|@BINSUFFIX@|$BINSUFFIX|g
	s|@VERSION@|$VERSION|g" $TOOLSDIR/bin/ooo-wrapper.in \
		>| "$OOBUILDDIR/ooo-wrapper$BINSUFFIX" || exit 1;
mkdir -p $PREFIX/bin
mkdir -p $PREFIX/man/man1
cp -f $OOBUILDDIR/ooo-wrapper$BINSUFFIX $PREFIX/bin
chmod +x $PREFIX/bin/ooo-wrapper$BINSUFFIX
for app in calc draw impress html math writer ffice; do
  ln -sf ooo-wrapper${BINSUFFIX} $PREFIX/bin/oo${app}${BINSUFFIX}
  if test "z$DISTRO" != "zDebian"; then
      echo ".so man1/openoffice$BINSUFFIX.1" >| $PREFIX/man/man1/oo${app}$BINSUFFIX.1;
  fi
done

if test "z$DISTRO" != "zDebian"; then
	echo "Generating man page ...";
	sed -e "s|@BINSUFFIX@|$BINSUFFIX|g" $TOOLSDIR/man/openoffice.1.in \
		>| "$OOBUILDDIR/openoffice$BINSUFFIX.1" || exit 1;
	cp -f $OOBUILDDIR/openoffice$BINSUFFIX.1 $PREFIX/man/man1
fi

echo "Building $OOINSTDIR/install-dict";
sed -e "s|@OOINSTBASE@|$OOINSTBASE|g" $TOOLSDIR/bin/install-dict.in >| "$OOBUILDDIR/install-dict" || exit 1;
mkdir -p $OOINSTDIR
cp -f $OOBUILDDIR/install-dict $OOINSTDIR
chmod +x $OOINSTDIR/install-dict

mkdir -p $SYSCONFDIR/openoffice
cp -f $TOOLSDIR/etc/autoresponse$BINSUFFIX.conf $SYSCONFDIR/openoffice

echo "Installing system files ...";
mkdir -p $PREFIX/share/gnome/ximian/applications
cp $TOOLSDIR/desktop/*$BINSUFFIX.desktop $PREFIX/share/gnome/ximian/applications

mkdir -p $PREFIX/share/pixmaps
cp $TOOLSDIR/desktop/ximian-openoffice-*.png $PREFIX/share/pixmaps

# Disable odk stuff for now
if test "0" = "1"; then
    echo "Installing the ODK";
    ODK_SRC=$OOBUILDDIR/odk$BUILD_MAGIC;
    ODK_INCLUDE=$OOINSTDIR/include
    echo " unzip"; 
    rm -Rf $ODK_SRC
    tar -C $OOBUILDDIR -xzf $OOBUILDDIR/solver/$BUILD_MAGIC/$ARCHITECTURE/bin/odk$BUILD_MAGIC.tar.gz;
    echo " setup $OOINSTDIR"; 
    mkdir -p $ODK_INCLUDE
    mkdir -p $OOINSTDIR
    mkdir -p $OOINSTDIR/utils
    mkdir -p $OOINSTDIR/program
    mkdir -p $OOINSTDIR/idl
    mkdir -p $OOINSTDIR/xml
    mkdir -p $OOINSTDIR/share/doc/openoffice$BINSUFFIX
    mkdir -p $PREFIX/lib/pkgconfig
    echo " re-arrange files";
    cp -a $ODK_SRC/include/* $ODK_INCLUDE
    cp -a $ODK_SRC/linux/lib/* $OOINSTDIR/program
    cp -a $ODK_SRC/linux/bin/* $OOINSTDIR/utils
    cp -a $ODK_SRC/idl/* $OOINSTDIR/idl
    cp -a $ODK_SRC/docs/* $OOINSTDIR/share/doc/openoffice$BINSUFFIX
    cp -a $ODK_SRC/examples $OOINSTDIR/share/doc/openoffice$BINSUFFIX
    cp -a $ODK_SRC/xml/* $OOINSTDIR/xml
    echo " create pkgconfig file"; 
    echo "
libdir=$OOINSTBASE/program
includedir=$OOINSTBASE/include
idlinclude=$OOINSTBASE/idl
xmlinclude=$OOINSTBASE/xml
toolsdir=$OOINSTBASE/utils

Name: openoffice$BINSUFFIX
Description: The OpenOffice.org infrastructure
Version: $VERSION
Libs: -L\${libdir} -lprot_uno_uno
Cflags: -I\${includeddir}" > $PREFIX/lib/pkgconfig/openoffice$BINSUFFIX.pc
fi

if (test -f $OOINSTDIR/$STAMP) && (!(test "z$2" = "z--clean") || !(test "z$WITH_SRC" = "z")); then
	echo "Skipping unpack";
else
        echo "Cleaning $OOINSTDIR";
	rm -Rf $OOINSTDIR;

	INSTALLER_PATH="`tcsh -c "cd $OOBUILDDIR; source $OOBUILDDIR/*.Set; echo \"$OOBUILDDIR/instsetoo/\\$INPATH/01/normal\""`";
	export DISPLAY=''; # clobber;
	echo "Execute from $INSTALLER_PATH to $OOINSTDIR [$LANG]";
	cd $INSTALLER_PATH || exit 1;

	./setup -net -v -r:$AUTORESPONSE -nogui || exit 1;
	echo "Done";
	
	echo "Stripping binaries";
	strip $OOINSTDIR/program/*.so
	touch $OOINSTDIR/$STAMP || exit 1;
	echo "Done...";
fi

echo "Building lang-packs ...";

cd $TOOLSDIR/bin || exit 1;
./package-lang || exit 1;

echo "Packaging succeeded";
exit 0;

