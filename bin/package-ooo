#!/bin/bash

# Based on docs/setup.txt

#
# See setup for user tweakables.
#
. ./setup

export LANG='';

if !(test -f $OOBUILDDIR/$STAMP); then
	echo "Source build failed, no stamp";
	exit 1;
fi

AUTORESPONSE=$OOBUILDDIR/autoresponse.conf

echo "Create auto-response file"
echo "[ENVIRONMENT]
INSTALLATIONMODE=INSTALL_NETWORK
INSTALLATIONTYPE=STANDARD
DESTINATIONPATH=$OOINSTDIR
OUTERPATH=
LOGFILE=
LANGUAGELIST=<LANGUAGE>

[JAVA]
JavaSupport=preinstalled_or_none" > $AUTORESPONSE

echo "Building $OOINSTDIR/ooo-wrapper$BINSUFFIX";
sed -e "s|@OOINSTBASE@|$OOINSTBASE|g
	s|@SYSCONFDIR@|$SYSCONFDIR|g
	s|@BINSUFFIX@|$BINSUFFIX|g
	s|@VERSION@|$VERSION|g" $TOOLSDIR/bin/ooo-wrapper.in \
		>| "$OOBUILDDIR/ooo-wrapper$BINSUFFIX" || exit 1;
mkdir -p $PREFIX/bin
mkdir -p $PREFIX/man/man1
cp -f $OOBUILDDIR/ooo-wrapper$BINSUFFIX $PREFIX/bin
chmod +x $PREFIX/bin/ooo-wrapper$BINSUFFIX
for app in calc draw impress html math writer ffice; do
  ln -sf ooo-wrapper${BINSUFFIX} $PREFIX/bin/oo${app}${BINSUFFIX}
  if test "z$VENDORNAME" = "zXimian"; then
      echo ".so man1/openoffice$BINSUFFIX.1" >| $PREFIX/man/man1/oo${app}$BINSUFFIX.1;
  fi
done

# Skip the versioning and linking dance of the wrapper script for Red Hat
if test "z$VENDORNAME" = "zRedHat"; then
	mv $PREFIX/bin/ooo-wrapper$BINSUFFIX $PREFIX/bin/ooffice
fi

if test "z$VENDORNAME" = "zXimian"; then
	echo "Generating man page ...";
	sed -e "s|@BINSUFFIX@|$BINSUFFIX|g" $TOOLSDIR/man/openoffice.1.in \
		>| "$OOBUILDDIR/openoffice$BINSUFFIX.1" || exit 1;
	cp -f $OOBUILDDIR/openoffice$BINSUFFIX.1 $PREFIX/man/man1
fi

echo "Building $OOINSTDIR/install-dict";
sed -e "s|@OOINSTBASE@|$OOINSTBASE|g" $TOOLSDIR/bin/install-dict.in >| "$OOBUILDDIR/install-dict" || exit 1;
mkdir -p $OOINSTDIR
cp -f $OOBUILDDIR/install-dict $OOINSTDIR
chmod +x $OOINSTDIR/install-dict

mkdir -p $SYSCONFDIR/openoffice

if test "z$VENDORNAME" = "zRedHat"; then
	cp -f $TOOLSDIR/etc/redhat-autoresponse$BINSUFFIX.conf $SYSCONFDIR/openoffice/autoresponse.conf
elif test "z$VENDORNAME" = "zXimian"; then
	cp -f $TOOLSDIR/etc/autoresponse$BINSUFFIX.conf $SYSCONFDIR/openoffice
fi

echo "Installing system files ...";
if test "z$VENDORNAME" = "zXimian" ; then
	mkdir -p $PREFIX/share/gnome/ximian/applications
	cp $TOOLSDIR/desktop/*$BINSUFFIX.desktop $PREFIX/share/gnome/ximian/applications

	mkdir -p $PREFIX/share/pixmaps
	cp $TOOLSDIR/desktop/ximian-openoffice-*.png $PREFIX/share/pixmaps
elif test "z$VENDORNAME" = "zRedHat" ; then
	# Install .desktop files for Red Hat distributions
	mkdir -p $PREFIX/share/applications
	for i in openoffice-printeradmin openoffice-setup redhat-drawing \
			redhat-math redhat-presentations redhat-word-processor redhat-spreadsheet; do
		cp -f /usr/share/desktop-menu-patches/$i.desktop $PREFIX/share/applications/$i.desktop
		echo "StartupNotify=true" >> $PREFIX/share/applications/$i.desktop
	done

	# Icons are copied into the local install directory from the specfile...
	mkdir -p $PREFIX/share/pixmaps
	cp $TOOLSDIR/desktop/redhat*.png $PREFIX/share/pixmaps
fi

# Disable odk stuff for now
if test "disable" = "this"; then
    echo "Installing the ODK";
    ODK_SRC=$OOBUILDDIR/odk$BUILD_MAGIC;
    ODK_INCLUDE=$OOINSTDIR/include
    echo " unzip"; 
    rm -Rf $ODK_SRC
    tar -C $OOBUILDDIR -xzf $OOBUILDDIR/solver/$BUILD_MAGIC/$ARCHITECTURE/bin/odk$BUILD_MAGIC.tar.gz;
    echo " setup $OOINSTDIR"; 
    mkdir -p $ODK_INCLUDE
    mkdir -p $OOINSTDIR
    mkdir -p $OOINSTDIR/utils
    mkdir -p $OOINSTDIR/program
    mkdir -p $OOINSTDIR/idl
    mkdir -p $OOINSTDIR/xml
    mkdir -p $OOINSTDIR/share/doc/openoffice$BINSUFFIX
    mkdir -p $PREFIX/lib/pkgconfig
    echo " re-arrange files";
    cp -a $ODK_SRC/include/* $ODK_INCLUDE
    cp -a $ODK_SRC/linux/lib/* $OOINSTDIR/program
    cp -a $ODK_SRC/linux/bin/* $OOINSTDIR/utils
    cp -a $ODK_SRC/idl/* $OOINSTDIR/idl
    cp -a $ODK_SRC/docs/* $OOINSTDIR/share/doc/openoffice$BINSUFFIX
    cp -a $ODK_SRC/examples $OOINSTDIR/share/doc/openoffice$BINSUFFIX
    cp -a $ODK_SRC/xml/* $OOINSTDIR/xml
    echo " create pkgconfig file"; 
    echo "
libdir=$OOINSTBASE/program
includedir=$OOINSTBASE/include
idlinclude=$OOINSTBASE/idl
xmlinclude=$OOINSTBASE/xml
toolsdir=$OOINSTBASE/utils

Name: openoffice$BINSUFFIX
Description: The OpenOffice.org infrastructure
Version: $VERSION
Libs: -L\${libdir} -lprot_uno_uno
Cflags: -I\${includeddir}" > $PREFIX/lib/pkgconfig/openoffice$BINSUFFIX.pc
fi

if (test -f $OOINSTDIR/$STAMP) && (!(test "z$2" = "z--clean") || !(test "z$WITH_SRC" = "z")); then
	echo "Skipping unpack";
else
     echo "Cleaning $OOINSTDIR";
	rm -Rf $OOINSTDIR;

	INSTALLER_PATH="`tcsh -c "cd $OOBUILDDIR; source $OOBUILDDIR/*.Set; echo \"$OOBUILDDIR/instsetoo/\\$INPATH/01/normal\""`";
	export DISPLAY=''; # clobber;
	echo "Execute from $INSTALLER_PATH to $OOINSTDIR [$LANG]";
	cd $INSTALLER_PATH || exit 1;

	./setup -net -v -r:$AUTORESPONSE -nogui || exit 1;
	echo "Done";
	
	if test "z$VENDORNAME" != "zRedHat" ; then
		echo "Stripping binaries";
		strip $OOINSTDIR/program/*.so
	fi
	touch $OOINSTDIR/$STAMP || exit 1;
	echo "Done...";
fi

echo "Building lang-packs ...";

cd $TOOLSDIR/bin || exit 1;
./package-lang || exit 1;

# Red Hat Post-install cleanup
if test "z$VENDORNAME" = "zRedHat" ; then
	# Fix openoffice/share/kde/net/applnk paths
	perl -pi -e "/^Module gid_Module_Optional_Kde/ .. /^End/ and s|YES|NO|g" $PREFIX/lib/$OOOINSTALLDIRNAME/program/instdb.ins
	perl -pi -e "/^Installation gid_Installation/ .. /^End/ and s|$PREFIX||g" $PREFIX/lib/$OOOINSTALLDIRNAME/program/instdb.ins
	perl -pi -e "/^Directory gid_Dir_Home_Gnome_Apps_Product/ .. /^End/ and s|OpenOffice\.org\ 1\.1\.0|OpenOffice\.org|g" $PREFIX/lib/$OOOINSTALLDIRNAME/program/instdb.ins
	perl -pi -e "/^Directory gid_Dir_Share_Kde_Net_Applnk_Product/ .. /^End/ and s|OpenOffice\.org\ 1\.1\.0|OpenOffice\.org|g" $PREFIX/lib/$OOOINSTALLDIRNAME/program/instdb.ins
	perl -pi -e "/^Directory gid_Dir_Kde_Share_Applnk_Product/ .. /^End/ and s|OpenOffice\.org\ 1\.1\.0|OpenOffice\.org|g" $PREFIX/lib/$OOOINSTALLDIRNAME/program/instdb.ins
	perl -pi -e "/^Procedure gid_Procedure_Kde_Inst/ .. /^End/ and s|OpenOffice\.org\ 1\.1\.0|OpenOffice\.org|g" $PREFIX/lib/$OOOINSTALLDIRNAME/program/instdb.ins
	perl -pi -e "/^Procedure gid_Procedure_Gnome_Install/ .. /^End/ and s|OpenOffice\.org\ 1\.1\.0|OpenOffice\.org|g" $PREFIX/lib/$OOOINSTALLDIRNAME/program/instdb.ins
	perl -pi -e "/^Procedure gid_Procedure_Gnome_Deinstall/ .. /^End/ and s|1\.1\.0||g" $PREFIX/lib/$OOOINSTALLDIRNAME/program/instdb.ins

	# KDE parts
	mkdir -p $PREFIX/share/icons
	cp -alf $PREFIX/lib/$OOOINSTALLDIRNAME/share/kde/net/share/icons/* \
	        $PREFIX/share/icons/

	# MIME-types
	# KDE
	mkdir -p $PREFIX/share/mimelnk
	# copy to global location
	cp -af  $PREFIX/lib/$OOOINSTALLDIRNAME/share/kde/net/share/mimelnk/* \
	        $PREFIX/share/mimelnk/

	## Fix instdb.ins, to *not* install local copies of these
	for entry in Kdeapplnk Kdemimetext Kdeicons Gnome_Apps Gnome_Icons Gnome2_Apps; do
		perl -pi -e "/^File gid_File_Extra_$entry/ .. /^End/ and (\
			s|^\tSize\s+\= .*|\tSize\t\t = 0;\r| or \
			s|^\tArchiveFiles\s+\= .*|\tArchiveFiles\t = 0;\r| or \
			s|^\tArchiveSize\s+\= .*|\tArchiveSize\t = 0;\r| or \
			s|^\tContains\s+\= .*|\tContains\t = ();\r| or \
			s|\t\t\t\t\t\".*|\r|g)" \
			$PREFIX/lib/$OOOINSTALLDIRNAME/program/instdb.ins
	done
fi

echo "Packaging succeeded";
exit 0;

