#!/bin/bash

#
# See setup for user tweakables.
#
. ./setup

if test "z$1" = 'z--help'; then
	echo "build-ooo <BRANCH> [--checkout[--clean]|--help]";
	echo " --checkout: updates CVS tree";
	echo " --clean:    cleans OO build tree";
	echo " --nopatch:  doesn't re-patch the tree";
	exit 0;
fi

# Ensure dirs
echo "Creating environment"
mkdir -p $BUILDDIR

# misc install brokenness
mkdir -p $BUILDDIR/bin
mkdir -p $BUILDDIR/share
mkdir -p $BUILDDIR/share/aclocal
mkdir -p $BUILDDIR/share/autoconf
mkdir -p $BUILDDIR/lib
mkdir -p $BUILDDIR/man
mkdir -p $BUILDDIR/man/man1
mkdir -p $OOBUILDDIR

# Versions
GCC_VER=gcc-3.2.2
GCC_TARBALL=gcc-3.2.2.tar.bz2
GCC_UNTAR_OPTIONS=jxf

BINUTILS_VER=binutils-2.13.2.1
BINUTILS_TARBALL=binutils-2.13.2.1.tar.bz2
BINUTILS_UNTAR_OPTIONS=jxf

if test ${CVSTAG:0:3} == 'OOO'; then
    JDK_VER=j2sdk1.3.1
    JDK_TARBALL=j2sdk-1.3.1-FCS-linux-i386.tar.bz2
    JDK_UNTAR_OPTIONS=jxf

    OOO_ICONS_VER=ooo-icons-OOO_1_0_3-1
else
    JDK_VER=j2sdk1.4.1
    JDK_TARBALL=j2sdk-1.4.1-01-linux-i586-gcc3.2.tar.bz2
    JDK_UNTAR_OPTIONS=jxf

    OOO_ICONS_VER=ooo-icons-RC3-1
fi

OOO_ICONS_TARBALL=$OOO_ICONS_VER.tar.gz
OOO_ICONS_UNTAR_OPTIONS=xzf

OOO_TARBALL="$CVSTAG.tar.bz2"
OOO_UNTAR_OPTIONS=jxf

check-tarball ()
{
    echo -n "Looking for $1 ... ";
    if test ! -f $1; then
	echo "missing the $1 archive; run './download'"
	exit 1;
    else
	echo "ok"
    fi
}

if test "z$WITH_SRC" = "z"; then
    mkdir -p $SRCDIR
    cd $SRCDIR

    echo "Checking for source packages in $SRCDIR";
    check-tarball $GCC_TARBALL
    check-tarball $BINUTILS_TARBALL
    check-tarball $JDK_TARBALL
    check-tarball $OOO_TARBALL
    check-tarball $OOO_ICONS_TARBALL

    if test ! -f $GCC_TARBALL; then
	echo "You need to put the relevant source packages into $SRCDIR before commencing the build";
	exit 1
    fi
else
    if test ! -d "$BUILDDIR/$JDK_VER" ||
       test ! -d "$BUILDDIR/$GCC_VER" ||
       test ! -d "$BUILDDIR/$OOO_ICONS_VER" ||
       test ! -d "$BUILDDIR/$BINUTILS_VER"; then
       echo "Missing some of the helper source";
       exit 1;
    fi
fi

cd $BUILDDIR

# unpack the Jdk
PKG_VER=$JDK_VER

if test -f $BUILDDIR/$PKG_VER/$STAMP; then
	echo "Skipping $PKG_VER";
	ln -sfn $PKG_VER $BUILDDIR/jdk
else
	echo "Unpacking $PKG_VER";
	cd $BUILDDIR
	if test "z$WITH_SRC" = "z"; then
	    tar $JDK_UNTAR_OPTIONS $SRCDIR/$JDK_TARBALL || exit 1;
	fi
# Link it into where we expect it in the path
	ln -sfn $PKG_VER $BUILDDIR/jdk
	touch $BUILDDIR/$PKG_VER/$STAMP || exit 1;
fi

# build binutils
PKG_VER=$BINUTILS_VER

# -- evil cut --
if test -f $BUILDDIR/$PKG_VER/$STAMP; then
	echo "Skipping $PKG_VER";
else
	echo "Building $PKG_VER";
	cd $BUILDDIR
	if test "z$WITH_SRC" = "z"; then
	    tar $BINUTILS_UNTAR_OPTIONS $SRCDIR/$BINUTILS_TARBALL || exit 1;
	fi
	cd $PKG_VER
	./configure --prefix=$BUILDDIR || exit 1;
	make && make install || exit 1;
	touch $BUILDDIR/$PKG_VER/$STAMP || exit 1;
fi
# -- cut --

PKG_VER=$OOO_ICONS_VER

# -- evil cut --
if test -f $BUILDDIR/$PKG_VER/$STAMP; then
	echo "Skipping $PKG_VER";
else
	echo "Building $PKG_VER";
	cd $BUILDDIR
	if test "z$WITH_SRC" = "z"; then
	    tar $OOO_ICONS_UNTAR_OPTIONS $SRCDIR/$OOO_ICONS_TARBALL || exit 1;
	fi
	touch $BUILDDIR/$PKG_VER/$STAMP || exit 1;
fi
# -- cut --

# build gcc
PKG_VER=$GCC_VER

# -- evil cut --
if test -f $BUILDDIR/$PKG_VER/$STAMP; then
	echo "Skipping $PKG_VER";
else
	echo "Building $PKG_VER";
	cd $BUILDDIR
	if test "z$WITH_SRC" = "z"; then
	    tar $GCC_UNTAR_OPTIONS $SRCDIR/$GCC_TARBALL || exit 1;
	fi
	cd $PKG_VER
	./configure --prefix=$BUILDDIR || exit 1;
	make && make install || exit 1;
	touch $BUILDDIR/$PKG_VER/$STAMP
fi
# -- cut --

# Checkout / Update source:
if (test "z$2" = "z--checkout") || !(test -f $OOBUILDDIR/$STAMP); then
	if test "z$WITH_SRC" = "z"; then
		if test ! -d $OOBUILDDIR/solenv; then
			echo "OOo build tree not found; unpacking it... [go make some tea]"
			cd $OOBUILDDIR
			cd ..
			tar $OOO_UNTAR_OPTIONS $SRCDIR/$OOO_TARBALL || exit 1
		else
			echo "Reverting patches ..."
			$TOOLSDIR/patches/apply.pl $TOOLSDIR/patches/$CVSTAG $OOBUILDDIR -R
		fi

		echo "Removing custom icons";
		$TOOLSDIR/bin/scale-icons $OOBUILDDIR --remove || exit 1;

		echo "Poking resource builds";
		find $OOBUILDDIR -name '*.dpr' -exec rm {} \;
		find $OOBUILDDIR -name '*.don' -exec rm {} \;
		find $OOBUILDDIR -name '*.srs' -exec rm {} \;

		echo "Updating source ..."
		cd $OOBUILDDIR

		if test -f $SRCDIR/$CVSTAG.tar.bz2; then
			cd ..
			tar xjf $SRCDIR/$CVSTAG.tar.bz2;
		else
			echo "Unreliably broken CVS branch...";
			if test "z`hostname`" = "zchampignon.ximian.com"; then
				cvs -d /cvsroot update -dP
			else
				cvs -z3 -q -d ':pserver:anoncvs@ftp.stardiv.de:/cvs' checkout -r $CVSTAG OpenOffice || exit 1;
#				cvs -z3 -q -d ':pserver:mmeeks@localhost:/cvs' checkout -r $CVSTAG OpenOffice || echo "Some error updating [?]";
			fi
		fi
	else
		# We expect a pristine copy to be there already ...

		if test ! -d "$BUILDDIR/$CVSTAG"; then
			echo "Missing the main OO.o source tree";
		fi
	fi

	cd $OOBUILDDIR

	# (re)apply patches
	if test "z$2" = "z--nopatch"; then
		echo "Skipping patching";
	else
		echo "Re-applying patches"
		$TOOLSDIR/patches/apply.pl $TOOLSDIR/patches/$CVSTAG $OOBUILDDIR -f || exit 1;
	fi

	echo "Installing / scaling icons";
	$TOOLSDIR/bin/scale-icons $OOBUILDDIR || echo "Error: scaling failed";
	echo "done icon scaling";

	cp -avf $BUILDDIR/$OOO_ICONS_VER/* $OOBUILDDIR || echo "Icon copy failed";
	echo "Copied new artwork into the tree";
	
	find $OOBUILDDIR -name '*.src' -exec touch {} \;;

	touch $OOBUILDDIR/$STAMP;
else
	echo "Skipping checkout, use --checkout to update";
fi

if test "z$3" = "z--clean"; then
	cd $OOBUILDDIR
	echo "Cleaning ..."
	find -name 'unxlngi4.pro' -exec rm -Rf {} \;
	exit 0;
fi

# configure
cd $OOBUILDDIR/config_office
rm -f config.cache
echo "configuring ...";
autoconf || exit 1;

./configure $CONFIGURE_OPTIONS || exit 1;

echo "Starting tsch source builds"
cat > $OOBUILDDIR/build-ooo-tcsh <<"EOF"
#!/bin/tcsh
# Warning - do not edit, this is a temporary file, see build-ooo
# Many Java files have 8bit char-set comments, javac barfs on them in utf8 locales
setenv LANG "C";
# Many Java's can't cope with the NPTL on Linux.
setenv LD_ASSUME_KERNEL "2.2.5";
# Embedded python dies without Home set
setenv HOME "";
cd $OOBUILDDIR
source $OOBUILDDIR/*.Set || exit 1;
echo "Copying libraries to $SOLARVER/$UPD/$INPATH/lib";
mkdir -p $SOLARVER/$UPD/$INPATH/lib || exit 1;
cp -avf $BUILDDIR/lib/libgcc* $BUILDDIR/lib/libstdc* $SOLARVER/$UPD/$INPATH/lib || exit 1;
# cp -vf $BUILDDIR/lib/libstdc++.so.3 $SOLARVER/$UPD/$INPATH/lib/libstdc++.so.3.0.1 || exit 1;
cp -vf $BUILDDIR/lib/libstdc++* $SOLARVER/$UPD/$INPATH/lib/ || exit 1;
echo 'Verifying environment'
echo "Path:  '\$PATH'";
echo "Shell: '\$SHELL'"
echo "Gcc: "
gcc -dumpversion
echo 'Bootstrapping'
./bootstrap || ./bootstrap || ./bootstrap || exit 1;
echo 'Commencing main build'
$SOLARENV/$OUTPATH/bin/dmake || $SOLARENV/$OUTPATH/bin/dmake || $SOLARENV/$OUTPATH/bin/dmake || exit 1;
EOF

chmod 755 $OOBUILDDIR/build-ooo-tcsh
# tcsh sucks great rocks, and refuses to re-direct it's output otherwise
export TERM=
$OOBUILDDIR/build-ooo-tcsh || exit 1;

touch $OOBUILDDIR/$STAMP || exit 1;

echo "Build succeeded ...!"
exit 0;
