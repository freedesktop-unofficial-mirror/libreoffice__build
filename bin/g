#!/bin/bash
#
# Wrapper for git to handle more subdirs at the same time
#

# no params, no action
if [ "$#" -eq "0" ] ; then
    git
    exit $?
fi

CLONEDIR=`readlink -e $0 | sed 's/\/bin\/g$/\/clone/'`
RAWBUILDDIR=`readlink -e $0 | sed 's/\/bin\/g$/\/rawbuild/'`

# extra params for some commands, like log
EXTRA=
COMMAND="$1"
PAGER=
RELATIVIZE=1

case "$COMMAND" in
    apply)
        EXTRA="-p0 --stat --apply --index --ignore-space-change --whitespace=error"
        RELATIVIZE=0
        ;;
    log)
        EXTRA='-1'
        PAGER='--no-pager'
        ;;
esac

# absolutize the parameters first
unset FILES
FILESNUM=0
while shift ; do
    PARAM="$1"
    if [ -z "$PARAM" ] ; then
        #ignore
        :
    elif [ "${PARAM:0:1}" = "-" ] ; then
        FILES[$FILESNUM]="$1"
        FILESNUM=$(($FILESNUM+1))
    else
        if [ "$COMMAND" = "apply" ] ; then
            grep -qs $'^+ *\t' "$1" && {
                echo "Patch '$1' introduces tabs in indentation, aborting."
                echo
                echo "Please fix the patch (something like s/^\(+ *\)\t/\1    /) and try again."
                echo
                exit 1
            }
        fi
        FILES[$FILESNUM]=`readlink -n -e "$1"`
        if [ -z "${FILES[$FILESNUM]}" ] ; then
            echo "'$1' not found in `pwd`."
            exit 1
        fi
        FILESNUM=$(($FILESNUM+1))
    fi
done

# do it!
cd "$CLONEDIR"
for DIR in * ; do
    if [ -d "$DIR" -a -d "$DIR"/.git ] ; then
        (
            # executed in a subshell
            cd $DIR

            # relativize the absolutized params again if we want to operate
            # only on the files belonging to this exact repo
            if [ "$RELATIVIZE" = "1" -a -n "$FILES" ] ; then
                FILESNUM=0
                INSERTNUM=0
                PWD=`pwd`
                PWDLEN=`pwd | wc -c`
                for I in "${FILES[@]}" ; do
                    unset FILES[$FILESNUM]
                    FILESNUM=$(($FILESNUM+1))
                    # set only those who belong to this repo
                    if [ "${I:0:$PWDLEN}" = "$PWD/" ] ; then
                        FILES[$INSERTNUM]="${I:$PWDLEN}"
                        INSERTNUM=$(($INSERTNUM+1))
                    fi
                done
                [ "$INSERTNUM" = "0" ] && exit 0
            fi

            # some extra params
            case "$COMMAND" in
                apply)
                    for I in * ; do
                        if [ -d "$I" ] ; then
                            EXTRA="$EXTRA --include=$I/*"
                        else
                            EXTRA="$EXTRA --include=$I"
                        fi
                    done
                    ;;
                commit)
                    git status | grep -qs '^nothing to commit' && exit 0
                    ;;
            esac

            echo "===== $DIR ====="
            git $PAGER "$COMMAND" $EXTRA "${FILES[@]}"
            RETURN=$?

            # git status returns error in some versions; we want to continue
            [ "$COMMAND" = "status" ] && RETURN=0

            exit $RETURN
        ) || exit $?
    fi
done

# warn
if [ "$COMMAND" = "apply" ] ; then
    echo
    echo "Don't forget to check the status & commit now ;-)"
    echo
fi

# vi:set expandtab:
