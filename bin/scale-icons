#!/usr/bin/perl -w

# Newer ImageMagick's don't like some of the
# broken icons OO.o contains.
$lc_good = 'res/lc00000.bmp';
$sc_good = 'res/sc00000.bmp';

# beautiful hard-coding action.
@scale_dirs = (
	'res',
	'sc/res/imglst/apptbx',
	'sc/res/imglst/navipi',
	'sd/res/imagelst',
	'sd/res/imagelst/korean',
	'sw/win/imglst', 
	'sw/win/imglst/korean',
	'sch/res',
	'offmgr/res',
	'res/enus',
	'dbaccess/res',
	'sc/res',
	'sd/res',
	'sw/win/res',
	'starmath/res',
	'res/arab',
	'res/catalan',
	'res/chinsim',
	'res/chintrad',
	'res/czech',
	'res/dtch',
	'res/fren',
	'res/hung',
	'res/ital',
	'res/japn',
	'res/korean',
	'res/pol',
	'res/poln',
	'res/port',
	'res/portbr',
	'res/russ',
	'res/slovak',
	'res/slovenian',
	'res/span',
	'res/turk'
	       );

%scale_exceptions = (
	'sw/win/imglst' => '[sn][cr][0-9]*\.bmp',
	'sc/res/imglst/navipi' => 'na0.*\.bmp',
	'res' => '[si][cm][0-9]*\.bmp'
);

sub usage {
    printf "Usage: scale-icons </path/to/ooo_checkout> [--quiet] [--backupdir=</path/for/original_bmps>\n";
}

if (@ARGV < 1) {
    usage ();
    exit (1);
}

$OOO_PATH = shift (@ARGV);

if ($OOO_PATH =~ m/--.*/) {
    usage ();
    exit (1);
}

$lc_good = "$OOO_PATH/$lc_good";
$sc_good = "$OOO_PATH/$sc_good";

$quiet = 0;
$remove = 0;
$backupdir = "";

foreach $a (@ARGV) {
    if ($a eq '--quiet') {
	$quiet = 1;
    } elsif ($a eq '--remove') {
	$remove = 1;
    } elsif ($a =~ m/--backupdir=(.*)/) {
	$backupdir = $1;
    }
}

sub handle_scaled {
    my $relinstdir = shift;
    my $small_regex = shift;
    my $large_regex = shift;
    my ($dirhandle, $file);
    my $instdir = "$OOO_PATH/$relinstdir";
    my $printed_dir = 0;

    if (! -d $instdir) {
	print "skipping $instdir\n";
	next;
    }
    
    opendir ($dirhandle, $instdir) || die "can't opendir $instdir: $!";
    
    while ($file = readdir ($dirhandle)) {
	if ($file =~ m/^$small_regex$|^$large_regex$/) {
	    my $src = "$instdir/$file";
	    my $dest = "$src.cnvt";

	    if ($remove) {
		$quiet || print "Remove '$src'\n";
		unlink ($src);
		next;
	    }

	    -f $src || die "Internal error";

	    if (!$printed_dir) {
		$printed_dir++;
		print "Dir: $instdir\n";
	    }

	    if ($src =~ /$small_regex/) {
		print "$src\n";
	    } elsif ($src =~ /$large_regex/) {
		print "$src\n";
	    }
	}
    }
   
    closedir ($dirhandle);
}

for $a (@scale_dirs) {
    my $small_regex;
    if (defined ($scale_exceptions{$a})) {
	$small_regex = $scale_exceptions{$a};
    } else {
	$small_regex = 'sc[0-9]*\.bmp';
    }
    if ($backupdir) {
	if (system ("mkdir -p $backupdir/$a\n") != 0) {
	    print "*** Warning: could not create $backupdir/$a\n" ;
	    $backupdir = "";
	}
    }
    handle_scaled ("$a", $small_regex, 'lc[0-9]*\.bmp');
}

exit (0);
