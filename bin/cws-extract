#!/usr/bin/perl -w

# parameters
my $cws = shift @ARGV;
my $outfile = shift @ARGV;
if (!defined $outfile) {
    $outfile = "cws-$cws.diff";
}

$ENV{SRC_ROOT} || die "Havn't sourced the environment";
-f "sal/CVS/Root" || die "Doesn't look like a live OO.o cvs checkout to me";

my $modules;

$modules = `CWS_WORK_STAMP=$cws cwsquery modules`;
$modules =~ s/\r\n//g;
$modules =~ s/\n/ /g;
$modules =~ s/  / /g;

my @mod_list = split (/ /, $modules);
print STDERR "Modules: '" . join (",", @mod_list) . "'\n";

for my $module (@mod_list) {
    my $tag = "cws_src680_$cws";
    my $anchor = uc ("$tag" . "_ANCHOR");
    print STDERR "Diffing $module\n";
    `cvs diff -kk -upN -r$anchor -r$tag >> $outfile 2>&1`;
}
