#!/bin/sh

# this script is useful to generate galleries for OOo from openclipart
# source tarball that it available at
# http://www.openclipart.org/downloads/index.php

# It requires the gengal binary that is actually available in OOo only when
# built with ooo-build
GAL_BIN=/usr/lib/ooo-2.0/program/gengal

# version of openclipart source tarball
OCA_VER=0.12
# where to install the generated bitmaps
GAL_SRC_DIR=/usr/share/openclipart
#GAL_SRC_DIR=/tmp/gallery.bitmaps
# where to install the OOo-related files (thumbnails & points at the files, ...)
GAL_DIR=/usr/lib/ooo-2.0/share/gallery
#GAL_DIR=/tmp/gallery.ooo
OODESTDIR=/var/tmp
# start number for the OOo-related files
GAL_NUMBER_FROM=70

echo "Unpacking openclipart sources..."

rm -rf openclipart-$OCA_VER
tar -xjf openclipart-$OCA_VER.tar.bz2

echo "Generating .png files..."

rm -rf $OODESTDIR$GAL_SRC_DIR
for pict_svg in `find openclipart-$OCA_VER -name "*.svg" -type f ` ; do
    pict_dir=${pict_svg#openclipart-$OCA_VER/}
    pict_dir=${pict_dir%/*}
    pict_png=${pict_svg##*/}
    pict_png=${pict_png%.svg}.png
    mkdir -p $OODESTDIR$GAL_SRC_DIR/$pict_dir
    inkscape -f $pict_svg -e $OODESTDIR$GAL_SRC_DIR/$pict_dir/$pict_png
done

echo "Removing some blacklisted files..."

for path in signs_and_symbols/flags \
	    unsorted ; do
    echo "  remove $path"
    rm -rf $OODESTDIR$GAL_SRC_DIR/$path
done

echo "done"

rm -rf "$OODESTDIR$GAL_DIR"
mkdir -p "$OODESTDIR$GAL_DIR"
for dir in `find $OODESTDIR$GAL_SRC_DIR -mindepth 1 -maxdepth 1 -type d | LC_CTYPE=C sort` ; do
    # get the gallery name from the directory name
    # and make the first character uppercase
    gal_name=${dir##*/}
    gal_name=`echo $gal_name | tr "_-" "  "`
    gal_name_rest=${gal_name#?}
    gal_name_first_char=${gal_name%$gal_name_rest}
    gal_name_first_char=`echo $gal_name_first_char | tr "a-z" "A-Z"`
    gal_name=$gal_name_first_char$gal_name_rest

    echo "Doing gallery $gal_name..."
    $GAL_BIN --name "$gal_name" --path "$OODESTDIR$GAL_DIR" --destdir "$OODESTDIR" --number-from "$GAL_NUMBER_FROM" `find $dir -name "*.png"`
done
